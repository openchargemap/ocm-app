import{$ as Gb,A as it,Aa as Nc,Ab as lw,B as rn,Bb as cw,C as Oo,Ca as _m,D as Fo,Da as z0,Db as ym,E as wr,Ea as ma,Eb as Q_,F as In,Fa as Vc,Fb as hw,G as Wt,Ga as L0,H as Fb,Ha as k0,I as Bb,Ia as Xb,J as Nb,Ja as Kb,K as i_,Ka as Yb,L as R0,La as W_,M as At,Ma as yd,N as Qn,Na as Jb,O as qn,Oa as Qb,P as Vb,Pa as ew,Q as Ub,Qa as xd,R as jb,Ra as H_,S as er,Sa as vd,T as Yn,Ta as _a,U as tr,Ua as tu,V as n_,Va as Za,Wa as Jl,X as na,Xa as Uc,Y as Sl,Ya as tw,Z as r_,_ as mm,a as fm,aa as Hl,ab as X_,b as M0,ba as Ga,bb as iw,c as Db,ca as Zb,cb as nw,d as ev,da as o_,db as rw,e as Rb,ea as qb,eb as K_,fb as O0,gb as Y_,h as rs,ha as $b,hb as J_,i as P0,ia as Xl,ib as of,j as zb,ja as Wb,jb as sf,k as ur,kb as F0,l as Yi,la as Il,m as Ji,ma as Kl,mb as ow,n as Lb,na as Yl,o as A0,oa as Hb,ob as bd,p as t_,q as ot,qa as j_,qb as jc,r as Mn,s as $s,t as D0,ta as G_,u as kb,ua as Z_,ub as sw,v as _n,va as q_,vb as B0,w as gc,wb as N0,x as Ob,xb as aw,y as ai,ya as $_,yb as gm,z as $e,za as eu,zb as iu}from"./chunk-EBSCITWR.js";import{a as Eb,b as Mb,d as Qx,e as Pb,f as Ab,g as On}from"./chunk-2R6CW7ES.js";var gw=Pb((ov,sv)=>{(function(oe,Ht){typeof ov=="object"&&typeof sv<"u"?sv.exports=Ht():typeof define=="function"&&define.amd?define(Ht):(oe=typeof globalThis<"u"?globalThis:oe||self,oe.maplibregl=Ht())})(ov,function(){"use strict";var oe={},Ht={};function P(O,t,at){if(Ht[O]=at,O==="index"){var yi="var sharedModule = {}; ("+Ht.shared+")(sharedModule); ("+Ht.worker+")(sharedModule);",Cn={};return Ht.shared(Cn),Ht.index(oe,Cn),typeof window<"u"&&oe.setWorkerUrl(window.URL.createObjectURL(new Blob([yi],{type:"text/javascript"}))),oe}}P("shared",["exports"],function(O){"use strict";function t(d,s,u,y){return new(u||(u=Promise))(function(T,D){function R(K){try{G(y.next(K))}catch(Q){D(Q)}}function B(K){try{G(y.throw(K))}catch(Q){D(Q)}}function G(K){var Q;K.done?T(K.value):(Q=K.value,Q instanceof u?Q:new u(function(ce){ce(Q)})).then(R,B)}G((y=y.apply(d,s||[])).next())})}function at(d){return d&&d.__esModule&&Object.prototype.hasOwnProperty.call(d,"default")?d.default:d}var yi,Cn;function _r(){if(Cn)return yi;function d(s,u){this.x=s,this.y=u}return Cn=1,yi=d,d.prototype={clone:function(){return new d(this.x,this.y)},add:function(s){return this.clone()._add(s)},sub:function(s){return this.clone()._sub(s)},multByPoint:function(s){return this.clone()._multByPoint(s)},divByPoint:function(s){return this.clone()._divByPoint(s)},mult:function(s){return this.clone()._mult(s)},div:function(s){return this.clone()._div(s)},rotate:function(s){return this.clone()._rotate(s)},rotateAround:function(s,u){return this.clone()._rotateAround(s,u)},matMult:function(s){return this.clone()._matMult(s)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(s){return this.x===s.x&&this.y===s.y},dist:function(s){return Math.sqrt(this.distSqr(s))},distSqr:function(s){var u=s.x-this.x,y=s.y-this.y;return u*u+y*y},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(s){return Math.atan2(this.y-s.y,this.x-s.x)},angleWith:function(s){return this.angleWithSep(s.x,s.y)},angleWithSep:function(s,u){return Math.atan2(this.x*u-this.y*s,this.x*s+this.y*u)},_matMult:function(s){var u=s[2]*this.x+s[3]*this.y;return this.x=s[0]*this.x+s[1]*this.y,this.y=u,this},_add:function(s){return this.x+=s.x,this.y+=s.y,this},_sub:function(s){return this.x-=s.x,this.y-=s.y,this},_mult:function(s){return this.x*=s,this.y*=s,this},_div:function(s){return this.x/=s,this.y/=s,this},_multByPoint:function(s){return this.x*=s.x,this.y*=s.y,this},_divByPoint:function(s){return this.x/=s.x,this.y/=s.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var s=this.y;return this.y=this.x,this.x=-s,this},_rotate:function(s){var u=Math.cos(s),y=Math.sin(s),T=y*this.x+u*this.y;return this.x=u*this.x-y*this.y,this.y=T,this},_rotateAround:function(s,u){var y=Math.cos(s),T=Math.sin(s),D=u.y+T*(this.x-u.x)+y*(this.y-u.y);return this.x=u.x+y*(this.x-u.x)-T*(this.y-u.y),this.y=D,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},d.convert=function(s){return s instanceof d?s:Array.isArray(s)?new d(s[0],s[1]):s},yi}typeof SuppressedError=="function"&&SuppressedError;var an,Dt,Wi=at(_r()),on=function(){if(Dt)return an;function d(s,u,y,T){this.cx=3*s,this.bx=3*(y-s)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*u,this.by=3*(T-u)-this.cy,this.ay=1-this.cy-this.by,this.p1x=s,this.p1y=u,this.p2x=y,this.p2y=T}return Dt=1,an=d,d.prototype={sampleCurveX:function(s){return((this.ax*s+this.bx)*s+this.cx)*s},sampleCurveY:function(s){return((this.ay*s+this.by)*s+this.cy)*s},sampleCurveDerivativeX:function(s){return(3*this.ax*s+2*this.bx)*s+this.cx},solveCurveX:function(s,u){if(u===void 0&&(u=1e-6),s<0)return 0;if(s>1)return 1;for(var y=s,T=0;T<8;T++){var D=this.sampleCurveX(y)-s;if(Math.abs(D)<u)return y;var R=this.sampleCurveDerivativeX(y);if(Math.abs(R)<1e-6)break;y-=D/R}var B=0,G=1;for(y=s,T=0;T<20&&(D=this.sampleCurveX(y),!(Math.abs(D-s)<u));T++)s>D?B=y:G=y,y=.5*(G-B)+B;return y},solve:function(s,u){return this.sampleCurveY(this.solveCurveX(s,u))}},an}(),vn=at(on);let gn,vr;function Bo(){return gn==null&&(gn=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),gn}function qo(){if(vr==null&&(vr=!1,Bo())){let s=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(s){for(let y=0;y<5*5;y++){let T=4*y;s.fillStyle=`rgb(${T},${T+1},${T+2})`,s.fillRect(y%5,Math.floor(y/5),1,1)}let u=s.getImageData(0,0,5,5).data;for(let y=0;y<5*5*4;y++)if(y%4!=3&&u[y]!==y){vr=!0;break}}}return vr||!1}var to=1e-6,Br=typeof Float32Array<"u"?Float32Array:Array;function os(){var d=new Br(9);return Br!=Float32Array&&(d[1]=0,d[2]=0,d[3]=0,d[5]=0,d[6]=0,d[7]=0),d[0]=1,d[4]=1,d[8]=1,d}function ga(d){return d[0]=1,d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=1,d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[10]=1,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,d}function Aa(){var d=new Br(3);return Br!=Float32Array&&(d[0]=0,d[1]=0,d[2]=0),d}function Ql(d){return Math.hypot(d[0],d[1],d[2])}function Io(d,s,u){var y=new Br(3);return y[0]=d,y[1]=s,y[2]=u,y}function qa(d,s,u){return d[0]=s[0]+u[0],d[1]=s[1]+u[1],d[2]=s[2]+u[2],d}function No(d,s,u){return d[0]=s[0]*u,d[1]=s[1]*u,d[2]=s[2]*u,d}function Ur(d,s,u){var y=s[0],T=s[1],D=s[2],R=u[0],B=u[1],G=u[2];return d[0]=T*G-D*B,d[1]=D*R-y*G,d[2]=y*B-T*R,d}Math.hypot||(Math.hypot=function(){for(var d=0,s=arguments.length;s--;)d+=arguments[s]*arguments[s];return Math.sqrt(d)});var ho,ss=Ql;function ya(d,s,u){var y=s[0],T=s[1],D=s[2],R=s[3];return d[0]=u[0]*y+u[4]*T+u[8]*D+u[12]*R,d[1]=u[1]*y+u[5]*T+u[9]*D+u[13]*R,d[2]=u[2]*y+u[6]*T+u[10]*D+u[14]*R,d[3]=u[3]*y+u[7]*T+u[11]*D+u[15]*R,d}function dl(){var d=new Br(4);return Br!=Float32Array&&(d[0]=0,d[1]=0,d[2]=0),d[3]=1,d}function $a(d,s,u,y){var T=.5*Math.PI/180;s*=T,u*=T,y*=T;var D=Math.sin(s),R=Math.cos(s),B=Math.sin(u),G=Math.cos(u),K=Math.sin(y),Q=Math.cos(y);return d[0]=D*G*Q-R*B*K,d[1]=R*B*Q+D*G*K,d[2]=R*G*K-D*B*Q,d[3]=R*G*Q+D*B*K,d}function Mr(){var d=new Br(2);return Br!=Float32Array&&(d[0]=0,d[1]=0),d}function as(d,s){var u=new Br(2);return u[0]=d,u[1]=s,u}Aa(),ho=new Br(4),Br!=Float32Array&&(ho[0]=0,ho[1]=0,ho[2]=0,ho[3]=0),Aa(),Io(1,0,0),Io(0,1,0),dl(),dl(),os(),Mr();let Hr=8192;function Da(d,s,u){return s*(Hr/(d.tileSize*Math.pow(2,u-d.tileID.overscaledZ)))}function xa(d,s){return(d%s+s)%s}function Lr(d,s,u){return d*(1-u)+s*u}function jr(d){if(d<=0)return 0;if(d>=1)return 1;let s=d*d,u=s*d;return 4*(d<.5?u:3*(d-s)+u-.75)}function Co(d,s,u,y){let T=new vn(d,s,u,y);return D=>T.solve(D)}let $c=Co(.25,.1,.25,1);function gr(d,s,u){return Math.min(u,Math.max(s,d))}function yc(d,s,u){let y=u-s,T=((d-s)%y+y)%y+s;return T===s?u:T}function Os(d,...s){for(let u of s)for(let y in u)d[y]=u[y];return d}let va=1;function hr(d,s,u){let y={};for(let T in d)y[T]=s.call(this,d[T],T,d);return y}function Cl(d,s,u){let y={};for(let T in d)s.call(this,d[T],T,d)&&(y[T]=d[T]);return y}function ra(d){return Array.isArray(d)?d.map(ra):typeof d=="object"&&d?hr(d,ra):d}let Cs={};function Jo(d){Cs[d]||(typeof console<"u"&&console.warn(d),Cs[d]=!0)}function Fs(d,s,u){return(u.y-d.y)*(s.x-d.x)>(s.y-d.y)*(u.x-d.x)}function Vo(d){return typeof WorkerGlobalScope<"u"&&d!==void 0&&d instanceof WorkerGlobalScope}let ba=null;function Wa(d){return typeof ImageBitmap<"u"&&d instanceof ImageBitmap}let pl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function fl(d,s,u,y,T){return t(this,void 0,void 0,function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");let D=new VideoFrame(d,{timestamp:0});try{let R=D?.format;if(!R||!R.startsWith("BGR")&&!R.startsWith("RGB"))throw new Error(`Unrecognized format ${R}`);let B=R.startsWith("BGR"),G=new Uint8ClampedArray(y*T*4);if(yield D.copyTo(G,function(K,Q,ce,_e,ve){let Te=4*Math.max(1,0),De=(Math.max(0,ce)-ce)*_e*4+Te,Ye=4*_e,lt=Math.max(0,Q),Mt=Math.max(0,ce);return{rect:{x:lt,y:Mt,width:Math.min(K.width,Q+_e)-lt,height:Math.min(K.height,ce+ve)-Mt},layout:[{offset:De,stride:Ye}]}}(d,s,u,y,T)),B)for(let K=0;K<G.length;K+=4){let Q=G[K];G[K]=G[K+2],G[K+2]=Q}return G}finally{D.close()}})}let fs,Ws;function ml(d,s,u,y){return d.addEventListener(s,u,y),{unsubscribe:()=>{d.removeEventListener(s,u,y)}}}function Hs(d){return d*Math.PI/180}function Ha(d){return d/Math.PI*180}let sl={touchstart:!0,touchmove:!0,touchmoveWindow:!0,touchend:!0,touchcancel:!0},El={dblclick:!0,click:!0,mouseover:!0,mouseout:!0,mousedown:!0,mousemove:!0,mousemoveWindow:!0,mouseup:!0,mouseupWindow:!0,contextmenu:!0,wheel:!0},ms="AbortError";function Vt(){return new Error(ms)}let Le={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function Fe(d){return Le.REGISTERED_PROTOCOLS[d.substring(0,d.indexOf("://"))]}let He="global-dispatcher";class mt extends Error{constructor(s,u,y,T){super(`AJAXError: ${u} (${s}): ${y}`),this.status=s,this.statusText=u,this.url=y,this.body=T}}let St=()=>Vo(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,Tt=function(d,s){if(/:\/\//.test(d.url)&&!/^https?:|^file:/.test(d.url)){let y=Fe(d.url);if(y)return y(d,s);if(Vo(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:d,targetMapId:He},s)}if(!(/^file:/.test(u=d.url)||/^file:/.test(St())&&!/^\w+:/.test(u))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return function(y,T){return t(this,void 0,void 0,function*(){let D=new Request(y.url,{method:y.method||"GET",body:y.body,credentials:y.credentials,headers:y.headers,cache:y.cache,referrer:St(),signal:T.signal}),R,B;y.type!=="json"||D.headers.has("Accept")||D.headers.set("Accept","application/json");try{R=yield fetch(D)}catch(K){throw new mt(0,K.message,y.url,new Blob)}if(!R.ok){let K=yield R.blob();throw new mt(R.status,R.statusText,y.url,K)}B=y.type==="arrayBuffer"||y.type==="image"?R.arrayBuffer():y.type==="json"?R.json():R.text();let G=yield B;if(T.signal.aborted)throw Vt();return{data:G,cacheControl:R.headers.get("Cache-Control"),expires:R.headers.get("Expires")}})}(d,s);if(Vo(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:d,mustQueue:!0,targetMapId:He},s)}var u;return function(y,T){return new Promise((D,R)=>{var B;let G=new XMLHttpRequest;G.open(y.method||"GET",y.url,!0),y.type!=="arrayBuffer"&&y.type!=="image"||(G.responseType="arraybuffer");for(let K in y.headers)G.setRequestHeader(K,y.headers[K]);y.type==="json"&&(G.responseType="text",!((B=y.headers)===null||B===void 0)&&B.Accept||G.setRequestHeader("Accept","application/json")),G.withCredentials=y.credentials==="include",G.onerror=()=>{R(new Error(G.statusText))},G.onload=()=>{if(!T.signal.aborted)if((G.status>=200&&G.status<300||G.status===0)&&G.response!==null){let K=G.response;if(y.type==="json")try{K=JSON.parse(G.response)}catch(Q){return void R(Q)}D({data:K,cacheControl:G.getResponseHeader("Cache-Control"),expires:G.getResponseHeader("Expires")})}else{let K=new Blob([G.response],{type:G.getResponseHeader("Content-Type")});R(new mt(G.status,G.statusText,y.url,K))}},T.signal.addEventListener("abort",()=>{G.abort(),R(Vt())}),G.send(y.body)})}(d,s)};function Xt(d){if(!d||d.indexOf("://")<=0||d.indexOf("data:image/")===0||d.indexOf("blob:")===0)return!0;let s=new URL(d),u=window.location;return s.protocol===u.protocol&&s.host===u.host}function Lt(d,s,u){u[d]&&u[d].indexOf(s)!==-1||(u[d]=u[d]||[],u[d].push(s))}function di(d,s,u){if(u&&u[d]){let y=u[d].indexOf(s);y!==-1&&u[d].splice(y,1)}}class li{constructor(s,u={}){Os(this,u),this.type=s}}class Zt extends li{constructor(s,u={}){super("error",Os({error:s},u))}}class wi{on(s,u){return this._listeners=this._listeners||{},Lt(s,u,this._listeners),{unsubscribe:()=>{this.off(s,u)}}}off(s,u){return di(s,u,this._listeners),di(s,u,this._oneTimeListeners),this}once(s,u){return u?(this._oneTimeListeners=this._oneTimeListeners||{},Lt(s,u,this._oneTimeListeners),this):new Promise(y=>this.once(s,y))}fire(s,u){typeof s=="string"&&(s=new li(s,u||{}));let y=s.type;if(this.listens(y)){s.target=this;let T=this._listeners&&this._listeners[y]?this._listeners[y].slice():[];for(let B of T)B.call(this,s);let D=this._oneTimeListeners&&this._oneTimeListeners[y]?this._oneTimeListeners[y].slice():[];for(let B of D)di(y,B,this._oneTimeListeners),B.call(this,s);let R=this._eventedParent;R&&(Os(s,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),R.fire(s))}else s instanceof Zt&&console.error(s.error);return this}listens(s){return this._listeners&&this._listeners[s]&&this._listeners[s].length>0||this._oneTimeListeners&&this._oneTimeListeners[s]&&this._oneTimeListeners[s].length>0||this._eventedParent&&this._eventedParent.listens(s)}setEventedParent(s,u){return this._eventedParent=s,this._eventedParentData=u,this}}var Ue={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},centerAltitude:{type:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},roll:{type:"number",default:0,units:"degrees"},state:{type:"state",default:{}},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},"color-relief":{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_color-relief","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_color-relief":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"projectionDefinition",default:"mercator","property-type":"data-constant",transition:!1,expression:{interpolated:!0,parameters:["zoom"]}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_color-relief","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"numberArray",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-altitude":{type:"numberArray",default:45,minimum:0,maximum:90,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"colorArray",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"colorArray",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-method":{type:"enum",values:{standard:{},basic:{},combined:{},igor:{},multidirectional:{}},default:"standard",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},"paint_color-relief":{"color-relief-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"color-relief-color":{type:"color",transition:!1,expression:{interpolated:!0,parameters:["elevation"]},"property-type":"color-ramp"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};let Qi=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function $n(d,s){let u={};for(let y in d)y!=="ref"&&(u[y]=d[y]);return Qi.forEach(y=>{y in s&&(u[y]=s[y])}),u}function ht(d,s){if(Array.isArray(d)){if(!Array.isArray(s)||d.length!==s.length)return!1;for(let u=0;u<d.length;u++)if(!ht(d[u],s[u]))return!1;return!0}if(typeof d=="object"&&d!==null&&s!==null){if(typeof s!="object"||Object.keys(d).length!==Object.keys(s).length)return!1;for(let u in d)if(!ht(d[u],s[u]))return!1;return!0}return d===s}function te(d,s){d.push(s)}function fe(d,s,u){te(u,{command:"addSource",args:[d,s[d]]})}function Ae(d,s,u){te(s,{command:"removeSource",args:[d]}),u[d]=!0}function qe(d,s,u,y){Ae(d,u,y),fe(d,s,u)}function je(d,s,u){let y;for(y in d[u])if(Object.prototype.hasOwnProperty.call(d[u],y)&&y!=="data"&&!ht(d[u][y],s[u][y]))return!1;for(y in s[u])if(Object.prototype.hasOwnProperty.call(s[u],y)&&y!=="data"&&!ht(d[u][y],s[u][y]))return!1;return!0}function We(d,s,u,y,T,D){d=d||{},s=s||{};for(let R in d)Object.prototype.hasOwnProperty.call(d,R)&&(ht(d[R],s[R])||u.push({command:D,args:[y,R,s[R],T]}));for(let R in s)Object.prototype.hasOwnProperty.call(s,R)&&!Object.prototype.hasOwnProperty.call(d,R)&&(ht(d[R],s[R])||u.push({command:D,args:[y,R,s[R],T]}))}function rt(d){return d.id}function ct(d,s){return d[s.id]=s,d}class nt{constructor(s,u,y,T){this.message=(s?`${s}: `:"")+y,T&&(this.identifier=T),u!=null&&u.__line__&&(this.line=u.__line__)}}function Ot(d,...s){for(let u of s)for(let y in u)d[y]=u[y];return d}class wt extends Error{constructor(s,u){super(u),this.message=u,this.key=s}}class _i{constructor(s,u=[]){this.parent=s,this.bindings={};for(let[y,T]of u)this.bindings[y]=T}concat(s){return new _i(this,s)}get(s){if(this.bindings[s])return this.bindings[s];if(this.parent)return this.parent.get(s);throw new Error(`${s} not found in scope.`)}has(s){return!!this.bindings[s]||!!this.parent&&this.parent.has(s)}}let Ii={kind:"null"},Bt={kind:"number"},Di={kind:"string"},Ni={kind:"boolean"},dn={kind:"color"},An={kind:"projectionDefinition"},kr={kind:"object"},Hi={kind:"value"},yr={kind:"collator"},Jn={kind:"formatted"},Un={kind:"padding"},Ar={kind:"colorArray"},go={kind:"numberArray"},yo={kind:"resolvedImage"},Qo={kind:"variableAnchorOffsetCollection"};function To(d,s){return{kind:"array",itemType:d,N:s}}function xo(d){if(d.kind==="array"){let s=xo(d.itemType);return typeof d.N=="number"?`array<${s}, ${d.N}>`:d.itemType.kind==="value"?"array":`array<${s}>`}return d.kind}let oa=[Ii,Bt,Di,Ni,dn,An,Jn,kr,To(Hi),Un,go,Ar,yo,Qo];function Es(d,s){if(s.kind==="error")return null;if(d.kind==="array"){if(s.kind==="array"&&(s.N===0&&s.itemType.kind==="value"||!Es(d.itemType,s.itemType))&&(typeof d.N!="number"||d.N===s.N))return null}else{if(d.kind===s.kind)return null;if(d.kind==="value"){for(let u of oa)if(!Es(u,s))return null}}return`Expected ${xo(d)} but found ${xo(s)} instead.`}function _s(d,s){return s.some(u=>u.kind===d.kind)}function ls(d,s){return s.some(u=>u==="null"?d===null:u==="array"?Array.isArray(d):u==="object"?d&&!Array.isArray(d)&&typeof d=="object":u===typeof d)}function wa(d,s){return d.kind==="array"&&s.kind==="array"?d.itemType.kind===s.itemType.kind&&typeof d.N=="number":d.kind===s.kind}let Eh=.96422,Ru=.82521,ou=4/29,Wc=6/29,zu=3*Wc*Wc,Mh=Wc*Wc*Wc,Hc=Math.PI/180,af=180/Math.PI;function Ml(d){return(d%=360)<0&&(d+=360),d}function Ph([d,s,u,y]){let T,D,R=_l((.2225045*(d=Ra(d))+.7168786*(s=Ra(s))+.0606169*(u=Ra(u)))/1);d===s&&s===u?T=D=R:(T=_l((.4360747*d+.3850649*s+.1430804*u)/Eh),D=_l((.0139322*d+.0971045*s+.7141733*u)/Ru));let B=116*R-16;return[B<0?0:B,500*(T-R),200*(R-D),y]}function Ra(d){return d<=.04045?d/12.92:Math.pow((d+.055)/1.055,2.4)}function _l(d){return d>Mh?Math.pow(d,1/3):d/zu+ou}function xc([d,s,u,y]){let T=(d+16)/116,D=isNaN(s)?T:T+s/500,R=isNaN(u)?T:T-u/200;return T=1*Pl(T),D=Eh*Pl(D),R=Ru*Pl(R),[al(3.1338561*D-1.6168667*T-.4906146*R),al(-.9787684*D+1.9161415*T+.033454*R),al(.0719453*D-.2289914*T+1.4052427*R),y]}function al(d){return(d=d<=.00304?12.92*d:1.055*Math.pow(d,1/2.4)-.055)<0?0:d>1?1:d}function Pl(d){return d>Wc?d*d*d:zu*(d-ou)}let Ms=Object.hasOwn||function(d,s){return Object.prototype.hasOwnProperty.call(d,s)};function Ir(d,s){return Ms(d,s)?d[s]:void 0}function ec(d){return parseInt(d.padEnd(2,d),16)/255}function Ta(d,s){return tc(s?d/100:d,0,1)}function tc(d,s,u){return Math.min(Math.max(s,d),u)}function Id(d){return!d.some(Number.isNaN)}let su={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};function Uo(d,s,u){return d+u*(s-d)}function Al(d,s,u){return d.map((y,T)=>Uo(y,s[T],u))}class Pr{constructor(s,u,y,T=1,D=!0){this.r=s,this.g=u,this.b=y,this.a=T,D||(this.r*=T,this.g*=T,this.b*=T,T||this.overwriteGetter("rgb",[s,u,y,T]))}static parse(s){if(s instanceof Pr)return s;if(typeof s!="string")return;let u=function(y){if((y=y.toLowerCase().trim())==="transparent")return[0,0,0,0];let T=Ir(su,y);if(T){let[R,B,G]=T;return[R/255,B/255,G/255,1]}if(y.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(y)){let R=y.length<6?1:2,B=1;return[ec(y.slice(B,B+=R)),ec(y.slice(B,B+=R)),ec(y.slice(B,B+=R)),ec(y.slice(B,B+R)||"ff")]}if(y.startsWith("rgb")){let R=y.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(R){let[B,G,K,Q,ce,_e,ve,Te,De,Ye,lt,Mt]=R,yt=[Q||" ",ve||" ",Ye].join("");if(yt==="  "||yt==="  /"||yt===",,"||yt===",,,"){let ye=[K,_e,De].join(""),Ze=ye==="%%%"?100:ye===""?255:0;if(Ze){let bt=[tc(+G/Ze,0,1),tc(+ce/Ze,0,1),tc(+Te/Ze,0,1),lt?Ta(+lt,Mt):1];if(Id(bt))return bt}}return}}let D=y.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(D){let[R,B,G,K,Q,ce,_e,ve,Te]=D,De=[G||" ",Q||" ",_e].join("");if(De==="  "||De==="  /"||De===",,"||De===",,,"){let Ye=[+B,tc(+K,0,100),tc(+ce,0,100),ve?Ta(+ve,Te):1];if(Id(Ye))return function([lt,Mt,yt,ye]){function Ze(bt){let ni=(bt+lt/30)%12,Ai=Mt*Math.min(yt,1-yt);return yt-Ai*Math.max(-1,Math.min(ni-3,9-ni,1))}return lt=Ml(lt),Mt/=100,yt/=100,[Ze(0),Ze(8),Ze(4),ye]}(Ye)}}}(s);return u?new Pr(...u,!1):void 0}get rgb(){let{r:s,g:u,b:y,a:T}=this,D=T||1/0;return this.overwriteGetter("rgb",[s/D,u/D,y/D,T])}get hcl(){return this.overwriteGetter("hcl",function(s){let[u,y,T,D]=Ph(s),R=Math.sqrt(y*y+T*T);return[Math.round(1e4*R)?Ml(Math.atan2(T,y)*af):NaN,R,u,D]}(this.rgb))}get lab(){return this.overwriteGetter("lab",Ph(this.rgb))}overwriteGetter(s,u){return Object.defineProperty(this,s,{value:u}),u}toString(){let[s,u,y,T]=this.rgb;return`rgba(${[s,u,y].map(D=>Math.round(255*D)).join(",")},${T})`}static interpolate(s,u,y,T="rgb"){switch(T){case"rgb":{let[D,R,B,G]=Al(s.rgb,u.rgb,y);return new Pr(D,R,B,G,!1)}case"hcl":{let[D,R,B,G]=s.hcl,[K,Q,ce,_e]=u.hcl,ve,Te;if(isNaN(D)||isNaN(K))isNaN(D)?isNaN(K)?ve=NaN:(ve=K,B!==1&&B!==0||(Te=Q)):(ve=D,ce!==1&&ce!==0||(Te=R));else{let yt=K-D;K>D&&yt>180?yt-=360:K<D&&D-K>180&&(yt+=360),ve=D+y*yt}let[De,Ye,lt,Mt]=function([yt,ye,Ze,bt]){return yt=isNaN(yt)?0:yt*Hc,xc([Ze,Math.cos(yt)*ye,Math.sin(yt)*ye,bt])}([ve,Te??Uo(R,Q,y),Uo(B,ce,y),Uo(G,_e,y)]);return new Pr(De,Ye,lt,Mt,!1)}case"lab":{let[D,R,B,G]=xc(Al(s.lab,u.lab,y));return new Pr(D,R,B,G,!1)}}}}Pr.black=new Pr(0,0,0,1),Pr.white=new Pr(1,1,1,1),Pr.transparent=new Pr(0,0,0,0),Pr.red=new Pr(1,0,0,1);class vc{constructor(s,u,y){this.sensitivity=s?u?"variant":"case":u?"accent":"base",this.locale=y,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(s,u){return this.collator.compare(s,u)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}let Cd=["bottom","center","top"];class Lu{constructor(s,u,y,T,D,R){this.text=s,this.image=u,this.scale=y,this.fontStack=T,this.textColor=D,this.verticalAlign=R}}class Xs{constructor(s){this.sections=s}static fromString(s){return new Xs([new Lu(s,null,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(s=>s.text.length!==0||s.image&&s.image.name.length!==0)}static factory(s){return s instanceof Xs?s:Xs.fromString(s)}toString(){return this.sections.length===0?"":this.sections.map(s=>s.text).join("")}}class wn{constructor(s){this.values=s.slice()}static parse(s){if(s instanceof wn)return s;if(typeof s=="number")return new wn([s,s,s,s]);if(Array.isArray(s)&&!(s.length<1||s.length>4)){for(let u of s)if(typeof u!="number")return;switch(s.length){case 1:s=[s[0],s[0],s[0],s[0]];break;case 2:s=[s[0],s[1],s[0],s[1]];break;case 3:s=[s[0],s[1],s[2],s[1]]}return new wn(s)}}toString(){return JSON.stringify(this.values)}static interpolate(s,u,y){return new wn(Al(s.values,u.values,y))}}class Ps{constructor(s){this.values=s.slice()}static parse(s){if(s instanceof Ps)return s;if(typeof s=="number")return new Ps([s]);if(Array.isArray(s)){for(let u of s)if(typeof u!="number")return;return new Ps(s)}}toString(){return JSON.stringify(this.values)}static interpolate(s,u,y){return new Ps(Al(s.values,u.values,y))}}class gs{constructor(s){this.values=s.slice()}static parse(s){if(s instanceof gs)return s;if(typeof s=="string"){let y=Pr.parse(s);return y?new gs([y]):void 0}if(!Array.isArray(s))return;let u=[];for(let y of s){if(typeof y!="string")return;let T=Pr.parse(y);if(!T)return;u.push(T)}return new gs(u)}toString(){return JSON.stringify(this.values)}static interpolate(s,u,y,T="rgb"){let D=[];if(s.values.length!=u.values.length)throw new Error(`colorArray: Arrays have mismatched length (${s.values.length} vs. ${u.values.length}), cannot interpolate.`);for(let R=0;R<s.values.length;R++)D.push(Pr.interpolate(s.values[R],u.values[R],y,T));return new gs(D)}}class cs extends Error{constructor(s){super(s),this.name="RuntimeError"}toJSON(){return this.message}}let Ed=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class Cr{constructor(s){this.values=s.slice()}static parse(s){if(s instanceof Cr)return s;if(Array.isArray(s)&&!(s.length<1)&&s.length%2==0){for(let u=0;u<s.length;u+=2){let y=s[u],T=s[u+1];if(typeof y!="string"||!Ed.has(y)||!Array.isArray(T)||T.length!==2||typeof T[0]!="number"||typeof T[1]!="number")return}return new Cr(s)}}toString(){return JSON.stringify(this.values)}static interpolate(s,u,y){let T=s.values,D=u.values;if(T.length!==D.length)throw new cs(`Cannot interpolate values of different length. from: ${s.toString()}, to: ${u.toString()}`);let R=[];for(let B=0;B<T.length;B+=2){if(T[B]!==D[B])throw new cs(`Cannot interpolate values containing mismatched anchors. from[${B}]: ${T[B]}, to[${B}]: ${D[B]}`);R.push(T[B]);let[G,K]=T[B+1],[Q,ce]=D[B+1];R.push([Uo(G,Q,y),Uo(K,ce,y)])}return new Cr(R)}}class As{constructor(s){this.name=s.name,this.available=s.available}toString(){return this.name}static fromString(s){return s?new As({name:s,available:!1}):null}}class or{constructor(s,u,y){this.from=s,this.to=u,this.transition=y}static interpolate(s,u,y){return new or(s,u,y)}static parse(s){return s instanceof or?s:Array.isArray(s)&&s.length===3&&typeof s[0]=="string"&&typeof s[1]=="string"&&typeof s[2]=="number"?new or(s[0],s[1],s[2]):typeof s=="object"&&typeof s.from=="string"&&typeof s.to=="string"&&typeof s.transition=="number"?new or(s.from,s.to,s.transition):typeof s=="string"?new or(s,s,1):void 0}}function Tr(d,s,u,y){return typeof d=="number"&&d>=0&&d<=255&&typeof s=="number"&&s>=0&&s<=255&&typeof u=="number"&&u>=0&&u<=255?y===void 0||typeof y=="number"&&y>=0&&y<=1?null:`Invalid rgba value [${[d,s,u,y].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof y=="number"?[d,s,u,y]:[d,s,u]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Xc(d){if(d===null||typeof d=="string"||typeof d=="boolean"||typeof d=="number"||d instanceof or||d instanceof Pr||d instanceof vc||d instanceof Xs||d instanceof wn||d instanceof Ps||d instanceof gs||d instanceof Cr||d instanceof As)return!0;if(Array.isArray(d)){for(let s of d)if(!Xc(s))return!1;return!0}if(typeof d=="object"){for(let s in d)if(!Xc(d[s]))return!1;return!0}return!1}function Fn(d){if(d===null)return Ii;if(typeof d=="string")return Di;if(typeof d=="boolean")return Ni;if(typeof d=="number")return Bt;if(d instanceof Pr)return dn;if(d instanceof or)return An;if(d instanceof vc)return yr;if(d instanceof Xs)return Jn;if(d instanceof wn)return Un;if(d instanceof Ps)return go;if(d instanceof gs)return Ar;if(d instanceof Cr)return Qo;if(d instanceof As)return yo;if(Array.isArray(d)){let s=d.length,u;for(let y of d){let T=Fn(y);if(u){if(u===T)continue;u=Hi;break}u=T}return To(u||Hi,s)}return kr}function ic(d){let s=typeof d;return d===null?"":s==="string"||s==="number"||s==="boolean"?String(d):d instanceof Pr||d instanceof or||d instanceof Xs||d instanceof wn||d instanceof Ps||d instanceof gs||d instanceof Cr||d instanceof As?d.toString():JSON.stringify(d)}class Bs{constructor(s,u){this.type=s,this.value=u}static parse(s,u){if(s.length!==2)return u.error(`'literal' expression requires exactly one argument, but found ${s.length-1} instead.`);if(!Xc(s[1]))return u.error("invalid value");let y=s[1],T=Fn(y),D=u.expectedType;return T.kind!=="array"||T.N!==0||!D||D.kind!=="array"||typeof D.N=="number"&&D.N!==0||(T=D),new Bs(T,y)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}let Kc={string:Di,number:Bt,boolean:Ni,object:kr};class ll{constructor(s,u){this.type=s,this.args=u}static parse(s,u){if(s.length<2)return u.error("Expected at least one argument.");let y,T=1,D=s[0];if(D==="array"){let B,G;if(s.length>2){let K=s[1];if(typeof K!="string"||!(K in Kc)||K==="object")return u.error('The item type argument of "array" must be one of string, number, boolean',1);B=Kc[K],T++}else B=Hi;if(s.length>3){if(s[2]!==null&&(typeof s[2]!="number"||s[2]<0||s[2]!==Math.floor(s[2])))return u.error('The length argument to "array" must be a positive integer literal',2);G=s[2],T++}y=To(B,G)}else{if(!Kc[D])throw new Error(`Types doesn't contain name = ${D}`);y=Kc[D]}let R=[];for(;T<s.length;T++){let B=u.parse(s[T],T,Hi);if(!B)return null;R.push(B)}return new ll(y,R)}evaluate(s){for(let u=0;u<this.args.length;u++){let y=this.args[u].evaluate(s);if(!Es(this.type,Fn(y)))return y;if(u===this.args.length-1)throw new cs(`Expected value to be of type ${xo(this.type)}, but found ${xo(Fn(y))} instead.`)}throw new Error}eachChild(s){this.args.forEach(s)}outputDefined(){return this.args.every(s=>s.outputDefined())}}let za={"to-boolean":Ni,"to-color":dn,"to-number":Bt,"to-string":Di};class Sa{constructor(s,u){this.type=s,this.args=u}static parse(s,u){if(s.length<2)return u.error("Expected at least one argument.");let y=s[0];if(!za[y])throw new Error(`Can't parse ${y} as it is not part of the known types`);if((y==="to-boolean"||y==="to-string")&&s.length!==2)return u.error("Expected one argument.");let T=za[y],D=[];for(let R=1;R<s.length;R++){let B=u.parse(s[R],R,Hi);if(!B)return null;D.push(B)}return new Sa(T,D)}evaluate(s){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(s);case"color":{let u,y;for(let T of this.args){if(u=T.evaluate(s),y=null,u instanceof Pr)return u;if(typeof u=="string"){let D=s.parseColor(u);if(D)return D}else if(Array.isArray(u)&&(y=u.length<3||u.length>4?`Invalid rgba value ${JSON.stringify(u)}: expected an array containing either three or four numeric values.`:Tr(u[0],u[1],u[2],u[3]),!y))return new Pr(u[0]/255,u[1]/255,u[2]/255,u[3])}throw new cs(y||`Could not parse color from value '${typeof u=="string"?u:JSON.stringify(u)}'`)}case"padding":{let u;for(let y of this.args){u=y.evaluate(s);let T=wn.parse(u);if(T)return T}throw new cs(`Could not parse padding from value '${typeof u=="string"?u:JSON.stringify(u)}'`)}case"numberArray":{let u;for(let y of this.args){u=y.evaluate(s);let T=Ps.parse(u);if(T)return T}throw new cs(`Could not parse numberArray from value '${typeof u=="string"?u:JSON.stringify(u)}'`)}case"colorArray":{let u;for(let y of this.args){u=y.evaluate(s);let T=gs.parse(u);if(T)return T}throw new cs(`Could not parse colorArray from value '${typeof u=="string"?u:JSON.stringify(u)}'`)}case"variableAnchorOffsetCollection":{let u;for(let y of this.args){u=y.evaluate(s);let T=Cr.parse(u);if(T)return T}throw new cs(`Could not parse variableAnchorOffsetCollection from value '${typeof u=="string"?u:JSON.stringify(u)}'`)}case"number":{let u=null;for(let y of this.args){if(u=y.evaluate(s),u===null)return 0;let T=Number(u);if(!isNaN(T))return T}throw new cs(`Could not convert ${JSON.stringify(u)} to number.`)}case"formatted":return Xs.fromString(ic(this.args[0].evaluate(s)));case"resolvedImage":return As.fromString(ic(this.args[0].evaluate(s)));case"projectionDefinition":return this.args[0].evaluate(s);default:return ic(this.args[0].evaluate(s))}}eachChild(s){this.args.forEach(s)}outputDefined(){return this.args.every(s=>s.outputDefined())}}let Pp=["Unknown","Point","LineString","Polygon"];class Ap{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache=new Map,this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Pp[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(s){let u=this._parseColorCache.get(s);return u||(u=Pr.parse(s),this._parseColorCache.set(s,u)),u}}class Ah{constructor(s,u,y=[],T,D=new _i,R=[]){this.registry=s,this.path=y,this.key=y.map(B=>`[${B}]`).join(""),this.scope=D,this.errors=R,this.expectedType=T,this._isConstant=u}parse(s,u,y,T,D={}){return u?this.concat(u,y,T)._parse(s,D):this._parse(s,D)}_parse(s,u){function y(T,D,R){return R==="assert"?new ll(D,[T]):R==="coerce"?new Sa(D,[T]):T}if(s!==null&&typeof s!="string"&&typeof s!="boolean"&&typeof s!="number"||(s=["literal",s]),Array.isArray(s)){if(s.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');let T=s[0];if(typeof T!="string")return this.error(`Expression name must be a string, but found ${typeof T} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;let D=this.registry[T];if(D){let R=D.parse(s,this);if(!R)return null;if(this.expectedType){let B=this.expectedType,G=R.type;if(B.kind!=="string"&&B.kind!=="number"&&B.kind!=="boolean"&&B.kind!=="object"&&B.kind!=="array"||G.kind!=="value"){if(B.kind==="projectionDefinition"&&["string","array"].includes(G.kind)||["color","formatted","resolvedImage"].includes(B.kind)&&["value","string"].includes(G.kind)||["padding","numberArray"].includes(B.kind)&&["value","number","array"].includes(G.kind)||B.kind==="colorArray"&&["value","string","array"].includes(G.kind)||B.kind==="variableAnchorOffsetCollection"&&["value","array"].includes(G.kind))R=y(R,B,u.typeAnnotation||"coerce");else if(this.checkSubtype(B,G))return null}else R=y(R,B,u.typeAnnotation||"assert")}if(!(R instanceof Bs)&&R.type.kind!=="resolvedImage"&&this._isConstant(R)){let B=new Ap;try{R=new Bs(R.type,R.evaluate(B))}catch(G){return this.error(G.message),null}}return R}return this.error(`Unknown expression "${T}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(s===void 0?"'undefined' value invalid. Use null instead.":typeof s=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof s} instead.`)}concat(s,u,y){let T=typeof s=="number"?this.path.concat(s):this.path,D=y?this.scope.concat(y):this.scope;return new Ah(this.registry,this._isConstant,T,u||null,D,this.errors)}error(s,...u){let y=`${this.key}${u.map(T=>`[${T}]`).join("")}`;this.errors.push(new wt(y,s))}checkSubtype(s,u){let y=Es(s,u);return y&&this.error(y),y}}class nc{constructor(s,u){this.type=u.type,this.bindings=[].concat(s),this.result=u}evaluate(s){return this.result.evaluate(s)}eachChild(s){for(let u of this.bindings)s(u[1]);s(this.result)}static parse(s,u){if(s.length<4)return u.error(`Expected at least 3 arguments, but found ${s.length-1} instead.`);let y=[];for(let D=1;D<s.length-1;D+=2){let R=s[D];if(typeof R!="string")return u.error(`Expected string, but found ${typeof R} instead.`,D);if(/[^a-zA-Z0-9_]/.test(R))return u.error("Variable names must contain only alphanumeric characters or '_'.",D);let B=u.parse(s[D+1],D+1);if(!B)return null;y.push([R,B])}let T=u.parse(s[s.length-1],s.length-1,u.expectedType,y);return T?new nc(y,T):null}outputDefined(){return this.result.outputDefined()}}class hs{constructor(s,u){this.type=u.type,this.name=s,this.boundExpression=u}static parse(s,u){if(s.length!==2||typeof s[1]!="string")return u.error("'var' expression requires exactly one string literal argument.");let y=s[1];return u.scope.has(y)?new hs(y,u.scope.get(y)):u.error(`Unknown variable "${y}". Make sure "${y}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(s){return this.boundExpression.evaluate(s)}eachChild(){}outputDefined(){return!1}}class Ns{constructor(s,u,y){this.type=s,this.index=u,this.input=y}static parse(s,u){if(s.length!==3)return u.error(`Expected 2 arguments, but found ${s.length-1} instead.`);let y=u.parse(s[1],1,Bt),T=u.parse(s[2],2,To(u.expectedType||Hi));return y&&T?new Ns(T.type.itemType,y,T):null}evaluate(s){let u=this.index.evaluate(s),y=this.input.evaluate(s);if(u<0)throw new cs(`Array index out of bounds: ${u} < 0.`);if(u>=y.length)throw new cs(`Array index out of bounds: ${u} > ${y.length-1}.`);if(u!==Math.floor(u))throw new cs(`Array index must be an integer, but found ${u} instead.`);return y[u]}eachChild(s){s(this.index),s(this.input)}outputDefined(){return!1}}class Yc{constructor(s,u){this.type=Ni,this.needle=s,this.haystack=u}static parse(s,u){if(s.length!==3)return u.error(`Expected 2 arguments, but found ${s.length-1} instead.`);let y=u.parse(s[1],1,Hi),T=u.parse(s[2],2,Hi);return y&&T?_s(y.type,[Ni,Di,Bt,Ii,Hi])?new Yc(y,T):u.error(`Expected first argument to be of type boolean, string, number or null, but found ${xo(y.type)} instead`):null}evaluate(s){let u=this.needle.evaluate(s),y=this.haystack.evaluate(s);if(!y)return!1;if(!ls(u,["boolean","string","number","null"]))throw new cs(`Expected first argument to be of type boolean, string, number or null, but found ${xo(Fn(u))} instead.`);if(!ls(y,["string","array"]))throw new cs(`Expected second argument to be of type array or string, but found ${xo(Fn(y))} instead.`);return y.indexOf(u)>=0}eachChild(s){s(this.needle),s(this.haystack)}outputDefined(){return!0}}class Jc{constructor(s,u,y){this.type=Bt,this.needle=s,this.haystack=u,this.fromIndex=y}static parse(s,u){if(s.length<=2||s.length>=5)return u.error(`Expected 3 or 4 arguments, but found ${s.length-1} instead.`);let y=u.parse(s[1],1,Hi),T=u.parse(s[2],2,Hi);if(!y||!T)return null;if(!_s(y.type,[Ni,Di,Bt,Ii,Hi]))return u.error(`Expected first argument to be of type boolean, string, number or null, but found ${xo(y.type)} instead`);if(s.length===4){let D=u.parse(s[3],3,Bt);return D?new Jc(y,T,D):null}return new Jc(y,T)}evaluate(s){let u=this.needle.evaluate(s),y=this.haystack.evaluate(s);if(!ls(u,["boolean","string","number","null"]))throw new cs(`Expected first argument to be of type boolean, string, number or null, but found ${xo(Fn(u))} instead.`);let T;if(this.fromIndex&&(T=this.fromIndex.evaluate(s)),ls(y,["string"])){let D=y.indexOf(u,T);return D===-1?-1:[...y.slice(0,D)].length}if(ls(y,["array"]))return y.indexOf(u,T);throw new cs(`Expected second argument to be of type array or string, but found ${xo(Fn(y))} instead.`)}eachChild(s){s(this.needle),s(this.haystack),this.fromIndex&&s(this.fromIndex)}outputDefined(){return!1}}class sr{constructor(s,u,y,T,D,R){this.inputType=s,this.type=u,this.input=y,this.cases=T,this.outputs=D,this.otherwise=R}static parse(s,u){if(s.length<5)return u.error(`Expected at least 4 arguments, but found only ${s.length-1}.`);if(s.length%2!=1)return u.error("Expected an even number of arguments.");let y,T;u.expectedType&&u.expectedType.kind!=="value"&&(T=u.expectedType);let D={},R=[];for(let K=2;K<s.length-1;K+=2){let Q=s[K],ce=s[K+1];Array.isArray(Q)||(Q=[Q]);let _e=u.concat(K);if(Q.length===0)return _e.error("Expected at least one branch label.");for(let Te of Q){if(typeof Te!="number"&&typeof Te!="string")return _e.error("Branch labels must be numbers or strings.");if(typeof Te=="number"&&Math.abs(Te)>Number.MAX_SAFE_INTEGER)return _e.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof Te=="number"&&Math.floor(Te)!==Te)return _e.error("Numeric branch labels must be integer values.");if(y){if(_e.checkSubtype(y,Fn(Te)))return null}else y=Fn(Te);if(D[String(Te)]!==void 0)return _e.error("Branch labels must be unique.");D[String(Te)]=R.length}let ve=u.parse(ce,K,T);if(!ve)return null;T=T||ve.type,R.push(ve)}let B=u.parse(s[1],1,Hi);if(!B)return null;let G=u.parse(s[s.length-1],s.length-1,T);return G?B.type.kind!=="value"&&u.concat(1).checkSubtype(y,B.type)?null:new sr(y,T,B,D,R,G):null}evaluate(s){let u=this.input.evaluate(s);return(Fn(u)===this.inputType&&this.outputs[this.cases[u]]||this.otherwise).evaluate(s)}eachChild(s){s(this.input),this.outputs.forEach(s),s(this.otherwise)}outputDefined(){return this.outputs.every(s=>s.outputDefined())&&this.otherwise.outputDefined()}}class Ds{constructor(s,u,y){this.type=s,this.branches=u,this.otherwise=y}static parse(s,u){if(s.length<4)return u.error(`Expected at least 3 arguments, but found only ${s.length-1}.`);if(s.length%2!=0)return u.error("Expected an odd number of arguments.");let y;u.expectedType&&u.expectedType.kind!=="value"&&(y=u.expectedType);let T=[];for(let R=1;R<s.length-1;R+=2){let B=u.parse(s[R],R,Ni);if(!B)return null;let G=u.parse(s[R+1],R+1,y);if(!G)return null;T.push([B,G]),y=y||G.type}let D=u.parse(s[s.length-1],s.length-1,y);if(!D)return null;if(!y)throw new Error("Can't infer output type");return new Ds(y,T,D)}evaluate(s){for(let[u,y]of this.branches)if(u.evaluate(s))return y.evaluate(s);return this.otherwise.evaluate(s)}eachChild(s){for(let[u,y]of this.branches)s(u),s(y);s(this.otherwise)}outputDefined(){return this.branches.every(([s,u])=>u.outputDefined())&&this.otherwise.outputDefined()}}class en{constructor(s,u,y,T){this.type=s,this.input=u,this.beginIndex=y,this.endIndex=T}static parse(s,u){if(s.length<=2||s.length>=5)return u.error(`Expected 3 or 4 arguments, but found ${s.length-1} instead.`);let y=u.parse(s[1],1,Hi),T=u.parse(s[2],2,Bt);if(!y||!T)return null;if(!_s(y.type,[To(Hi),Di,Hi]))return u.error(`Expected first argument to be of type array or string, but found ${xo(y.type)} instead`);if(s.length===4){let D=u.parse(s[3],3,Bt);return D?new en(y.type,y,T,D):null}return new en(y.type,y,T)}evaluate(s){let u=this.input.evaluate(s),y=this.beginIndex.evaluate(s),T;if(this.endIndex&&(T=this.endIndex.evaluate(s)),ls(u,["string"]))return[...u].slice(y,T).join("");if(ls(u,["array"]))return u.slice(y,T);throw new cs(`Expected first argument to be of type array or string, but found ${xo(Fn(u))} instead.`)}eachChild(s){s(this.input),s(this.beginIndex),this.endIndex&&s(this.endIndex)}outputDefined(){return!1}}function au(d,s){let u=d.length-1,y,T,D=0,R=u,B=0;for(;D<=R;)if(B=Math.floor((D+R)/2),y=d[B],T=d[B+1],y<=s){if(B===u||s<T)return B;D=B+1}else{if(!(y>s))throw new cs("Input is not a number.");R=B-1}return 0}class Qc{constructor(s,u,y){this.type=s,this.input=u,this.labels=[],this.outputs=[];for(let[T,D]of y)this.labels.push(T),this.outputs.push(D)}static parse(s,u){if(s.length-1<4)return u.error(`Expected at least 4 arguments, but found only ${s.length-1}.`);if((s.length-1)%2!=0)return u.error("Expected an even number of arguments.");let y=u.parse(s[1],1,Bt);if(!y)return null;let T=[],D=null;u.expectedType&&u.expectedType.kind!=="value"&&(D=u.expectedType);for(let R=1;R<s.length;R+=2){let B=R===1?-1/0:s[R],G=s[R+1],K=R,Q=R+1;if(typeof B!="number")return u.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',K);if(T.length&&T[T.length-1][0]>=B)return u.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',K);let ce=u.parse(G,Q,D);if(!ce)return null;D=D||ce.type,T.push([B,ce])}return new Qc(D,y,T)}evaluate(s){let u=this.labels,y=this.outputs;if(u.length===1)return y[0].evaluate(s);let T=this.input.evaluate(s);if(T<=u[0])return y[0].evaluate(s);let D=u.length;return T>=u[D-1]?y[D-1].evaluate(s):y[au(u,T)].evaluate(s)}eachChild(s){s(this.input);for(let u of this.outputs)s(u)}outputDefined(){return this.outputs.every(s=>s.outputDefined())}}function Dp(d){return d&&d.__esModule&&Object.prototype.hasOwnProperty.call(d,"default")?d.default:d}var Dl,La,eh=function(){if(La)return Dl;function d(s,u,y,T){this.cx=3*s,this.bx=3*(y-s)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*u,this.by=3*(T-u)-this.cy,this.ay=1-this.cy-this.by,this.p1x=s,this.p1y=u,this.p2x=y,this.p2y=T}return La=1,Dl=d,d.prototype={sampleCurveX:function(s){return((this.ax*s+this.bx)*s+this.cx)*s},sampleCurveY:function(s){return((this.ay*s+this.by)*s+this.cy)*s},sampleCurveDerivativeX:function(s){return(3*this.ax*s+2*this.bx)*s+this.cx},solveCurveX:function(s,u){if(u===void 0&&(u=1e-6),s<0)return 0;if(s>1)return 1;for(var y=s,T=0;T<8;T++){var D=this.sampleCurveX(y)-s;if(Math.abs(D)<u)return y;var R=this.sampleCurveDerivativeX(y);if(Math.abs(R)<1e-6)break;y-=D/R}var B=0,G=1;for(y=s,T=0;T<20&&(D=this.sampleCurveX(y),!(Math.abs(D-s)<u));T++)s>D?B=y:G=y,y=.5*(G-B)+B;return y},solve:function(s,u){return this.sampleCurveY(this.solveCurveX(s,u))}},Dl}(),Dh=Dp(eh);class Ri{constructor(s,u,y,T,D){this.type=s,this.operator=u,this.interpolation=y,this.input=T,this.labels=[],this.outputs=[];for(let[R,B]of D)this.labels.push(R),this.outputs.push(B)}static interpolationFactor(s,u,y,T){let D=0;if(s.name==="exponential")D=br(u,s.base,y,T);else if(s.name==="linear")D=br(u,1,y,T);else if(s.name==="cubic-bezier"){let R=s.controlPoints;D=new Dh(R[0],R[1],R[2],R[3]).solve(br(u,1,y,T))}return D}static parse(s,u){let[y,T,D,...R]=s;if(!Array.isArray(T)||T.length===0)return u.error("Expected an interpolation type expression.",1);if(T[0]==="linear")T={name:"linear"};else if(T[0]==="exponential"){let K=T[1];if(typeof K!="number")return u.error("Exponential interpolation requires a numeric base.",1,1);T={name:"exponential",base:K}}else{if(T[0]!=="cubic-bezier")return u.error(`Unknown interpolation type ${String(T[0])}`,1,0);{let K=T.slice(1);if(K.length!==4||K.some(Q=>typeof Q!="number"||Q<0||Q>1))return u.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);T={name:"cubic-bezier",controlPoints:K}}}if(s.length-1<4)return u.error(`Expected at least 4 arguments, but found only ${s.length-1}.`);if((s.length-1)%2!=0)return u.error("Expected an even number of arguments.");if(D=u.parse(D,2,Bt),!D)return null;let B=[],G=null;y!=="interpolate-hcl"&&y!=="interpolate-lab"||u.expectedType==Ar?u.expectedType&&u.expectedType.kind!=="value"&&(G=u.expectedType):G=dn;for(let K=0;K<R.length;K+=2){let Q=R[K],ce=R[K+1],_e=K+3,ve=K+4;if(typeof Q!="number")return u.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',_e);if(B.length&&B[B.length-1][0]>=Q)return u.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',_e);let Te=u.parse(ce,ve,G);if(!Te)return null;G=G||Te.type,B.push([Q,Te])}return wa(G,Bt)||wa(G,An)||wa(G,dn)||wa(G,Un)||wa(G,go)||wa(G,Ar)||wa(G,Qo)||wa(G,To(Bt))?new Ri(G,y,T,D,B):u.error(`Type ${xo(G)} is not interpolatable.`)}evaluate(s){let u=this.labels,y=this.outputs;if(u.length===1)return y[0].evaluate(s);let T=this.input.evaluate(s);if(T<=u[0])return y[0].evaluate(s);let D=u.length;if(T>=u[D-1])return y[D-1].evaluate(s);let R=au(u,T),B=Ri.interpolationFactor(this.interpolation,T,u[R],u[R+1]),G=y[R].evaluate(s),K=y[R+1].evaluate(s);switch(this.operator){case"interpolate":switch(this.type.kind){case"number":return Uo(G,K,B);case"color":return Pr.interpolate(G,K,B);case"padding":return wn.interpolate(G,K,B);case"colorArray":return gs.interpolate(G,K,B);case"numberArray":return Ps.interpolate(G,K,B);case"variableAnchorOffsetCollection":return Cr.interpolate(G,K,B);case"array":return Al(G,K,B);case"projectionDefinition":return or.interpolate(G,K,B)}case"interpolate-hcl":switch(this.type.kind){case"color":return Pr.interpolate(G,K,B,"hcl");case"colorArray":return gs.interpolate(G,K,B,"hcl")}case"interpolate-lab":switch(this.type.kind){case"color":return Pr.interpolate(G,K,B,"lab");case"colorArray":return gs.interpolate(G,K,B,"lab")}}}eachChild(s){s(this.input);for(let u of this.outputs)s(u)}outputDefined(){return this.outputs.every(s=>s.outputDefined())}}function br(d,s,u,y){let T=y-u,D=d-u;return T===0?0:s===1?D/T:(Math.pow(s,D)-1)/(Math.pow(s,T)-1)}let Xn={color:Pr.interpolate,number:Uo,padding:wn.interpolate,numberArray:Ps.interpolate,colorArray:gs.interpolate,variableAnchorOffsetCollection:Cr.interpolate,array:Al};class Do{constructor(s,u){this.type=s,this.args=u}static parse(s,u){if(s.length<2)return u.error("Expected at least one argument.");let y=null,T=u.expectedType;T&&T.kind!=="value"&&(y=T);let D=[];for(let B of s.slice(1)){let G=u.parse(B,1+D.length,y,void 0,{typeAnnotation:"omit"});if(!G)return null;y=y||G.type,D.push(G)}if(!y)throw new Error("No output type");let R=T&&D.some(B=>Es(T,B.type));return new Do(R?Hi:y,D)}evaluate(s){let u,y=null,T=0;for(let D of this.args)if(T++,y=D.evaluate(s),y&&y instanceof As&&!y.available&&(u||(u=y.name),y=null,T===this.args.length&&(y=u)),y!==null)break;return y}eachChild(s){this.args.forEach(s)}outputDefined(){return this.args.every(s=>s.outputDefined())}}function bc(d,s){return d==="=="||d==="!="?s.kind==="boolean"||s.kind==="string"||s.kind==="number"||s.kind==="null"||s.kind==="value":s.kind==="string"||s.kind==="number"||s.kind==="value"}function dr(d,s,u,y){return y.compare(s,u)===0}function Rl(d,s,u){let y=d!=="=="&&d!=="!=";return class _w{constructor(D,R,B){this.type=Ni,this.lhs=D,this.rhs=R,this.collator=B,this.hasUntypedArgument=D.type.kind==="value"||R.type.kind==="value"}static parse(D,R){if(D.length!==3&&D.length!==4)return R.error("Expected two or three arguments.");let B=D[0],G=R.parse(D[1],1,Hi);if(!G)return null;if(!bc(B,G.type))return R.concat(1).error(`"${B}" comparisons are not supported for type '${xo(G.type)}'.`);let K=R.parse(D[2],2,Hi);if(!K)return null;if(!bc(B,K.type))return R.concat(2).error(`"${B}" comparisons are not supported for type '${xo(K.type)}'.`);if(G.type.kind!==K.type.kind&&G.type.kind!=="value"&&K.type.kind!=="value")return R.error(`Cannot compare types '${xo(G.type)}' and '${xo(K.type)}'.`);y&&(G.type.kind==="value"&&K.type.kind!=="value"?G=new ll(K.type,[G]):G.type.kind!=="value"&&K.type.kind==="value"&&(K=new ll(G.type,[K])));let Q=null;if(D.length===4){if(G.type.kind!=="string"&&K.type.kind!=="string"&&G.type.kind!=="value"&&K.type.kind!=="value")return R.error("Cannot use collator to compare non-string types.");if(Q=R.parse(D[3],3,yr),!Q)return null}return new _w(G,K,Q)}evaluate(D){let R=this.lhs.evaluate(D),B=this.rhs.evaluate(D);if(y&&this.hasUntypedArgument){let G=Fn(R),K=Fn(B);if(G.kind!==K.kind||G.kind!=="string"&&G.kind!=="number")throw new cs(`Expected arguments for "${d}" to be (string, string) or (number, number), but found (${G.kind}, ${K.kind}) instead.`)}if(this.collator&&!y&&this.hasUntypedArgument){let G=Fn(R),K=Fn(B);if(G.kind!=="string"||K.kind!=="string")return s(D,R,B)}return this.collator?u(D,R,B,this.collator.evaluate(D)):s(D,R,B)}eachChild(D){D(this.lhs),D(this.rhs),this.collator&&D(this.collator)}outputDefined(){return!0}}}let lu=Rl("==",function(d,s,u){return s===u},dr),Md=Rl("!=",function(d,s,u){return s!==u},function(d,s,u,y){return!dr(0,s,u,y)}),ka=Rl("<",function(d,s,u){return s<u},function(d,s,u,y){return y.compare(s,u)<0}),us=Rl(">",function(d,s,u){return s>u},function(d,s,u,y){return y.compare(s,u)>0}),Cm=Rl("<=",function(d,s,u){return s<=u},function(d,s,u,y){return y.compare(s,u)<=0}),Rh=Rl(">=",function(d,s,u){return s>=u},function(d,s,u,y){return y.compare(s,u)>=0});class ku{constructor(s,u,y){this.type=yr,this.locale=y,this.caseSensitive=s,this.diacriticSensitive=u}static parse(s,u){if(s.length!==2)return u.error("Expected one argument.");let y=s[1];if(typeof y!="object"||Array.isArray(y))return u.error("Collator options argument must be an object.");let T=u.parse(y["case-sensitive"]!==void 0&&y["case-sensitive"],1,Ni);if(!T)return null;let D=u.parse(y["diacritic-sensitive"]!==void 0&&y["diacritic-sensitive"],1,Ni);if(!D)return null;let R=null;return y.locale&&(R=u.parse(y.locale,1,Di),!R)?null:new ku(T,D,R)}evaluate(s){return new vc(this.caseSensitive.evaluate(s),this.diacriticSensitive.evaluate(s),this.locale?this.locale.evaluate(s):null)}eachChild(s){s(this.caseSensitive),s(this.diacriticSensitive),this.locale&&s(this.locale)}outputDefined(){return!1}}class th{constructor(s,u,y,T,D){this.type=Di,this.number=s,this.locale=u,this.currency=y,this.minFractionDigits=T,this.maxFractionDigits=D}static parse(s,u){if(s.length!==3)return u.error("Expected two arguments.");let y=u.parse(s[1],1,Bt);if(!y)return null;let T=s[2];if(typeof T!="object"||Array.isArray(T))return u.error("NumberFormat options argument must be an object.");let D=null;if(T.locale&&(D=u.parse(T.locale,1,Di),!D))return null;let R=null;if(T.currency&&(R=u.parse(T.currency,1,Di),!R))return null;let B=null;if(T["min-fraction-digits"]&&(B=u.parse(T["min-fraction-digits"],1,Bt),!B))return null;let G=null;return T["max-fraction-digits"]&&(G=u.parse(T["max-fraction-digits"],1,Bt),!G)?null:new th(y,D,R,B,G)}evaluate(s){return new Intl.NumberFormat(this.locale?this.locale.evaluate(s):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(s):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(s):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(s):void 0}).format(this.number.evaluate(s))}eachChild(s){s(this.number),this.locale&&s(this.locale),this.currency&&s(this.currency),this.minFractionDigits&&s(this.minFractionDigits),this.maxFractionDigits&&s(this.maxFractionDigits)}outputDefined(){return!1}}class zl{constructor(s){this.type=Jn,this.sections=s}static parse(s,u){if(s.length<2)return u.error("Expected at least one argument.");let y=s[1];if(!Array.isArray(y)&&typeof y=="object")return u.error("First argument must be an image or text section.");let T=[],D=!1;for(let R=1;R<=s.length-1;++R){let B=s[R];if(D&&typeof B=="object"&&!Array.isArray(B)){D=!1;let G=null;if(B["font-scale"]&&(G=u.parse(B["font-scale"],1,Bt),!G))return null;let K=null;if(B["text-font"]&&(K=u.parse(B["text-font"],1,To(Di)),!K))return null;let Q=null;if(B["text-color"]&&(Q=u.parse(B["text-color"],1,dn),!Q))return null;let ce=null;if(B["vertical-align"]){if(typeof B["vertical-align"]=="string"&&!Cd.includes(B["vertical-align"]))return u.error(`'vertical-align' must be one of: 'bottom', 'center', 'top' but found '${B["vertical-align"]}' instead.`);if(ce=u.parse(B["vertical-align"],1,Di),!ce)return null}let _e=T[T.length-1];_e.scale=G,_e.font=K,_e.textColor=Q,_e.verticalAlign=ce}else{let G=u.parse(s[R],1,Hi);if(!G)return null;let K=G.type.kind;if(K!=="string"&&K!=="value"&&K!=="null"&&K!=="resolvedImage")return u.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");D=!0,T.push({content:G,scale:null,font:null,textColor:null,verticalAlign:null})}}return new zl(T)}evaluate(s){return new Xs(this.sections.map(u=>{let y=u.content.evaluate(s);return Fn(y)===yo?new Lu("",y,null,null,null,u.verticalAlign?u.verticalAlign.evaluate(s):null):new Lu(ic(y),null,u.scale?u.scale.evaluate(s):null,u.font?u.font.evaluate(s).join(","):null,u.textColor?u.textColor.evaluate(s):null,u.verticalAlign?u.verticalAlign.evaluate(s):null)}))}eachChild(s){for(let u of this.sections)s(u.content),u.scale&&s(u.scale),u.font&&s(u.font),u.textColor&&s(u.textColor),u.verticalAlign&&s(u.verticalAlign)}outputDefined(){return!1}}class Ou{constructor(s){this.type=yo,this.input=s}static parse(s,u){if(s.length!==2)return u.error("Expected two arguments.");let y=u.parse(s[1],1,Di);return y?new Ou(y):u.error("No image name provided.")}evaluate(s){let u=this.input.evaluate(s),y=As.fromString(u);return y&&s.availableImages&&(y.available=s.availableImages.indexOf(u)>-1),y}eachChild(s){s(this.input)}outputDefined(){return!1}}class Ks{constructor(s){this.type=Bt,this.input=s}static parse(s,u){if(s.length!==2)return u.error(`Expected 1 argument, but found ${s.length-1} instead.`);let y=u.parse(s[1],1);return y?y.type.kind!=="array"&&y.type.kind!=="string"&&y.type.kind!=="value"?u.error(`Expected argument of type string or array, but found ${xo(y.type)} instead.`):new Ks(y):null}evaluate(s){let u=this.input.evaluate(s);if(typeof u=="string")return[...u].length;if(Array.isArray(u))return u.length;throw new cs(`Expected value to be of type string or array, but found ${xo(Fn(u))} instead.`)}eachChild(s){s(this.input)}outputDefined(){return!1}}let Vs=8192;function Xa(d,s){let u=(180+d[0])/360,y=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+d[1]*Math.PI/360)))/360,T=Math.pow(2,s.z);return[Math.round(u*T*Vs),Math.round(y*T*Vs)]}function Rp(d,s){let u=Math.pow(2,s.z);return[(T=(d[0]/Vs+s.x)/u,360*T-180),(y=(d[1]/Vs+s.y)/u,360/Math.PI*Math.atan(Math.exp((180-360*y)*Math.PI/180))-90)];var y,T}function wc(d,s){d[0]=Math.min(d[0],s[0]),d[1]=Math.min(d[1],s[1]),d[2]=Math.max(d[2],s[0]),d[3]=Math.max(d[3],s[1])}function $o(d,s){return!(d[0]<=s[0]||d[2]>=s[2]||d[1]<=s[1]||d[3]>=s[3])}function Ia(d,s,u){let y=d[0]-s[0],T=d[1]-s[1],D=d[0]-u[0],R=d[1]-u[1];return y*R-D*T==0&&y*D<=0&&T*R<=0}function Tn(d,s,u,y){return(T=[y[0]-u[0],y[1]-u[1]])[0]*(D=[s[0]-d[0],s[1]-d[1]])[1]-T[1]*D[0]!=0&&!(!ln(d,s,u,y)||!ln(u,y,d,s));var T,D}function Li(d,s,u){for(let y of u)for(let T=0;T<y.length-1;++T)if(Tn(d,s,y[T],y[T+1]))return!0;return!1}function Tc(d,s,u=!1){let y=!1;for(let B of s)for(let G=0;G<B.length-1;G++){if(Ia(d,B[G],B[G+1]))return u;(D=B[G])[1]>(T=d)[1]!=(R=B[G+1])[1]>T[1]&&T[0]<(R[0]-D[0])*(T[1]-D[1])/(R[1]-D[1])+D[0]&&(y=!y)}var T,D,R;return y}function hn(d,s){for(let u of s)if(Tc(d,u))return!0;return!1}function zh(d,s){for(let u of d)if(!Tc(u,s))return!1;for(let u=0;u<d.length-1;++u)if(Li(d[u],d[u+1],s))return!1;return!0}function Fu(d,s){for(let u of s)if(zh(d,u))return!0;return!1}function ln(d,s,u,y){let T=y[0]-u[0],D=y[1]-u[1],R=(d[0]-u[0])*D-T*(d[1]-u[1]),B=(s[0]-u[0])*D-T*(s[1]-u[1]);return R>0&&B<0||R<0&&B>0}function zp(d,s,u){let y=[];for(let T=0;T<d.length;T++){let D=[];for(let R=0;R<d[T].length;R++){let B=Xa(d[T][R],u);wc(s,B),D.push(B)}y.push(D)}return y}function Ll(d,s,u){let y=[];for(let T=0;T<d.length;T++){let D=zp(d[T],s,u);y.push(D)}return y}function lf(d,s,u,y){if(d[0]<u[0]||d[0]>u[2]){let T=.5*y,D=d[0]-u[0]>T?-y:u[0]-d[0]>T?y:0;D===0&&(D=d[0]-u[2]>T?-y:u[2]-d[0]>T?y:0),d[0]+=D}wc(s,d)}function Bu(d,s,u,y){let T=Math.pow(2,y.z)*Vs,D=[y.x*Vs,y.y*Vs],R=[];for(let B of d)for(let G of B){let K=[G.x+D[0],G.y+D[1]];lf(K,s,u,T),R.push(K)}return R}function Ys(d,s,u,y){let T=Math.pow(2,y.z)*Vs,D=[y.x*Vs,y.y*Vs],R=[];for(let G of d){let K=[];for(let Q of G){let ce=[Q.x+D[0],Q.y+D[1]];wc(s,ce),K.push(ce)}R.push(K)}if(s[2]-s[0]<=T/2){(B=s)[0]=B[1]=1/0,B[2]=B[3]=-1/0;for(let G of R)for(let K of G)lf(K,s,u,T)}var B;return R}class ws{constructor(s,u){this.type=Ni,this.geojson=s,this.geometries=u}static parse(s,u){if(s.length!==2)return u.error(`'within' expression requires exactly one argument, but found ${s.length-1} instead.`);if(Xc(s[1])){let y=s[1];if(y.type==="FeatureCollection"){let T=[];for(let D of y.features){let{type:R,coordinates:B}=D.geometry;R==="Polygon"&&T.push(B),R==="MultiPolygon"&&T.push(...B)}if(T.length)return new ws(y,{type:"MultiPolygon",coordinates:T})}else if(y.type==="Feature"){let T=y.geometry.type;if(T==="Polygon"||T==="MultiPolygon")return new ws(y,y.geometry)}else if(y.type==="Polygon"||y.type==="MultiPolygon")return new ws(y,y)}return u.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(s){if(s.geometry()!=null&&s.canonicalID()!=null){if(s.geometryType()==="Point")return function(u,y){let T=[1/0,1/0,-1/0,-1/0],D=[1/0,1/0,-1/0,-1/0],R=u.canonicalID();if(y.type==="Polygon"){let B=zp(y.coordinates,D,R),G=Bu(u.geometry(),T,D,R);if(!$o(T,D))return!1;for(let K of G)if(!Tc(K,B))return!1}if(y.type==="MultiPolygon"){let B=Ll(y.coordinates,D,R),G=Bu(u.geometry(),T,D,R);if(!$o(T,D))return!1;for(let K of G)if(!hn(K,B))return!1}return!0}(s,this.geometries);if(s.geometryType()==="LineString")return function(u,y){let T=[1/0,1/0,-1/0,-1/0],D=[1/0,1/0,-1/0,-1/0],R=u.canonicalID();if(y.type==="Polygon"){let B=zp(y.coordinates,D,R),G=Ys(u.geometry(),T,D,R);if(!$o(T,D))return!1;for(let K of G)if(!zh(K,B))return!1}if(y.type==="MultiPolygon"){let B=Ll(y.coordinates,D,R),G=Ys(u.geometry(),T,D,R);if(!$o(T,D))return!1;for(let K of G)if(!Fu(K,B))return!1}return!0}(s,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}let cu=class{constructor(d=[],s=(u,y)=>u<y?-1:u>y?1:0){if(this.data=d,this.length=this.data.length,this.compare=s,this.length>0)for(let u=(this.length>>1)-1;u>=0;u--)this._down(u)}push(d){this.data.push(d),this._up(this.length++)}pop(){if(this.length===0)return;let d=this.data[0],s=this.data.pop();return--this.length>0&&(this.data[0]=s,this._down(0)),d}peek(){return this.data[0]}_up(d){let{data:s,compare:u}=this,y=s[d];for(;d>0;){let T=d-1>>1,D=s[T];if(u(y,D)>=0)break;s[d]=D,d=T}s[d]=y}_down(d){let{data:s,compare:u}=this,y=this.length>>1,T=s[d];for(;d<y;){let D=1+(d<<1),R=D+1;if(R<this.length&&u(s[R],s[D])<0&&(D=R),u(s[D],T)>=0)break;s[d]=s[D],d=D}s[d]=T}};function Sc(d,s,u=0,y=d.length-1,T=hu){for(;y>u;){if(y-u>600){let G=y-u+1,K=s-u+1,Q=Math.log(G),ce=.5*Math.exp(2*Q/3),_e=.5*Math.sqrt(Q*ce*(G-ce)/G)*(K-G/2<0?-1:1);Sc(d,s,Math.max(u,Math.floor(s-K*ce/G+_e)),Math.min(y,Math.floor(s+(G-K)*ce/G+_e)),T)}let D=d[s],R=u,B=y;for(kl(d,u,s),T(d[y],D)>0&&kl(d,u,y);R<B;){for(kl(d,R,B),R++,B--;T(d[R],D)<0;)R++;for(;T(d[B],D)>0;)B--}T(d[u],D)===0?kl(d,u,B):(B++,kl(d,B,y)),B<=s&&(u=B+1),s<=B&&(y=B-1)}}function kl(d,s,u){let y=d[s];d[s]=d[u],d[u]=y}function hu(d,s){return d<s?-1:d>s?1:0}function Js(d,s){if(d.length<=1)return[d];let u=[],y,T;for(let D of d){let R=Nu(D);R!==0&&(D.area=Math.abs(R),T===void 0&&(T=R<0),T===R<0?(y&&u.push(y),y=[D]):y.push(D))}if(y&&u.push(y),s>1)for(let D=0;D<u.length;D++)u[D].length<=s||(Sc(u[D],s,1,u[D].length-1,Pd),u[D]=u[D].slice(0,s));return u}function Pd(d,s){return s.area-d.area}function Nu(d){let s=0;for(let u,y,T=0,D=d.length,R=D-1;T<D;R=T++)u=d[T],y=d[R],s+=(y.x-u.x)*(u.y+y.y);return s}let Of=1/298.257223563,Ic=Of*(2-Of),Lp=Math.PI/180;class Ol{constructor(s){let u=6378.137*Lp*1e3,y=Math.cos(s*Lp),T=1/(1-Ic*(1-y*y)),D=Math.sqrt(T);this.kx=u*D*y,this.ky=u*D*T*(1-Ic)}distance(s,u){let y=this.wrap(s[0]-u[0])*this.kx,T=(s[1]-u[1])*this.ky;return Math.sqrt(y*y+T*T)}pointOnLine(s,u){let y,T,D,R,B=1/0;for(let G=0;G<s.length-1;G++){let K=s[G][0],Q=s[G][1],ce=this.wrap(s[G+1][0]-K)*this.kx,_e=(s[G+1][1]-Q)*this.ky,ve=0;ce===0&&_e===0||(ve=(this.wrap(u[0]-K)*this.kx*ce+(u[1]-Q)*this.ky*_e)/(ce*ce+_e*_e),ve>1?(K=s[G+1][0],Q=s[G+1][1]):ve>0&&(K+=ce/this.kx*ve,Q+=_e/this.ky*ve)),ce=this.wrap(u[0]-K)*this.kx,_e=(u[1]-Q)*this.ky;let Te=ce*ce+_e*_e;Te<B&&(B=Te,y=K,T=Q,D=G,R=ve)}return{point:[y,T],index:D,t:Math.max(0,Math.min(1,R))}}wrap(s){for(;s<-180;)s+=360;for(;s>180;)s-=360;return s}}function Xr(d,s){return s[0]-d[0]}function rc(d){return d[1]-d[0]+1}function ih(d,s){return d[1]>=d[0]&&d[1]<s}function cf(d,s){if(d[0]>d[1])return[null,null];let u=rc(d);if(s){if(u===2)return[d,null];let T=Math.floor(u/2);return[[d[0],d[0]+T],[d[0]+T,d[1]]]}if(u===1)return[d,null];let y=Math.floor(u/2)-1;return[[d[0],d[0]+y],[d[0]+y+1,d[1]]]}function kp(d,s){if(!ih(s,d.length))return[1/0,1/0,-1/0,-1/0];let u=[1/0,1/0,-1/0,-1/0];for(let y=s[0];y<=s[1];++y)wc(u,d[y]);return u}function Op(d){let s=[1/0,1/0,-1/0,-1/0];for(let u of d)for(let y of u)wc(s,y);return s}function Ff(d){return d[0]!==-1/0&&d[1]!==-1/0&&d[2]!==1/0&&d[3]!==1/0}function Vu(d,s,u){if(!Ff(d)||!Ff(s))return NaN;let y=0,T=0;return d[2]<s[0]&&(y=s[0]-d[2]),d[0]>s[2]&&(y=d[0]-s[2]),d[1]>s[3]&&(T=d[1]-s[3]),d[3]<s[1]&&(T=s[1]-d[3]),u.distance([0,0],[y,T])}function Lh(d,s,u){let y=u.pointOnLine(s,d);return u.distance(d,y.point)}function Cc(d,s,u,y,T){let D=Math.min(Lh(d,[u,y],T),Lh(s,[u,y],T)),R=Math.min(Lh(u,[d,s],T),Lh(y,[d,s],T));return Math.min(D,R)}function Bf(d,s,u,y,T){if(!ih(s,d.length)||!ih(y,u.length))return 1/0;let D=1/0;for(let R=s[0];R<s[1];++R){let B=d[R],G=d[R+1];for(let K=y[0];K<y[1];++K){let Q=u[K],ce=u[K+1];if(Tn(B,G,Q,ce))return 0;D=Math.min(D,Cc(B,G,Q,ce,T))}}return D}function Nf(d,s,u,y,T){if(!ih(s,d.length)||!ih(y,u.length))return NaN;let D=1/0;for(let R=s[0];R<=s[1];++R)for(let B=y[0];B<=y[1];++B)if(D=Math.min(D,T.distance(d[R],u[B])),D===0)return D;return D}function nh(d,s,u){if(Tc(d,s,!0))return 0;let y=1/0;for(let T of s){let D=T[0],R=T[T.length-1];if(D!==R&&(y=Math.min(y,Lh(d,[R,D],u)),y===0))return y;let B=u.pointOnLine(T,d);if(y=Math.min(y,u.distance(d,B.point)),y===0)return y}return y}function Ad(d,s,u,y){if(!ih(s,d.length))return NaN;for(let D=s[0];D<=s[1];++D)if(Tc(d[D],u,!0))return 0;let T=1/0;for(let D=s[0];D<s[1];++D){let R=d[D],B=d[D+1];for(let G of u)for(let K=0,Q=G.length,ce=Q-1;K<Q;ce=K++){let _e=G[ce],ve=G[K];if(Tn(R,B,_e,ve))return 0;T=Math.min(T,Cc(R,B,_e,ve,y))}}return T}function Fp(d,s){for(let u of d)for(let y of u)if(Tc(y,s,!0))return!0;return!1}function Fl(d,s,u,y=1/0){let T=Op(d),D=Op(s);if(y!==1/0&&Vu(T,D,u)>=y)return y;if($o(T,D)){if(Fp(d,s))return 0}else if(Fp(s,d))return 0;let R=1/0;for(let B of d)for(let G=0,K=B.length,Q=K-1;G<K;Q=G++){let ce=B[Q],_e=B[G];for(let ve of s)for(let Te=0,De=ve.length,Ye=De-1;Te<De;Ye=Te++){let lt=ve[Ye],Mt=ve[Te];if(Tn(ce,_e,lt,Mt))return 0;R=Math.min(R,Cc(ce,_e,lt,Mt,u))}}return R}function uu(d,s,u,y,T,D){if(!D)return;let R=Vu(kp(y,D),T,u);R<s&&d.push([R,D,[0,0]])}function rh(d,s,u,y,T,D,R){if(!D||!R)return;let B=Vu(kp(y,D),kp(T,R),u);B<s&&d.push([B,D,R])}function Uu(d,s,u,y,T=1/0){let D=Math.min(y.distance(d[0],u[0][0]),T);if(D===0)return D;let R=new cu([[0,[0,d.length-1],[0,0]]],Xr),B=Op(u);for(;R.length>0;){let G=R.pop();if(G[0]>=D)continue;let K=G[1],Q=s?50:100;if(rc(K)<=Q){if(!ih(K,d.length))return NaN;if(s){let ce=Ad(d,K,u,y);if(isNaN(ce)||ce===0)return ce;D=Math.min(D,ce)}else for(let ce=K[0];ce<=K[1];++ce){let _e=nh(d[ce],u,y);if(D=Math.min(D,_e),D===0)return 0}}else{let ce=cf(K,s);uu(R,D,y,d,B,ce[0]),uu(R,D,y,d,B,ce[1])}}return D}function du(d,s,u,y,T,D=1/0){let R=Math.min(D,T.distance(d[0],u[0]));if(R===0)return R;let B=new cu([[0,[0,d.length-1],[0,u.length-1]]],Xr);for(;B.length>0;){let G=B.pop();if(G[0]>=R)continue;let K=G[1],Q=G[2],ce=s?50:100,_e=y?50:100;if(rc(K)<=ce&&rc(Q)<=_e){if(!ih(K,d.length)&&ih(Q,u.length))return NaN;let ve;if(s&&y)ve=Bf(d,K,u,Q,T),R=Math.min(R,ve);else if(s&&!y){let Te=d.slice(K[0],K[1]+1);for(let De=Q[0];De<=Q[1];++De)if(ve=Lh(u[De],Te,T),R=Math.min(R,ve),R===0)return R}else if(!s&&y){let Te=u.slice(Q[0],Q[1]+1);for(let De=K[0];De<=K[1];++De)if(ve=Lh(d[De],Te,T),R=Math.min(R,ve),R===0)return R}else ve=Nf(d,K,u,Q,T),R=Math.min(R,ve)}else{let ve=cf(K,s),Te=cf(Q,y);rh(B,R,T,d,u,ve[0],Te[0]),rh(B,R,T,d,u,ve[0],Te[1]),rh(B,R,T,d,u,ve[1],Te[0]),rh(B,R,T,d,u,ve[1],Te[1])}}return R}function Ka(d){return d.type==="MultiPolygon"?d.coordinates.map(s=>({type:"Polygon",coordinates:s})):d.type==="MultiLineString"?d.coordinates.map(s=>({type:"LineString",coordinates:s})):d.type==="MultiPoint"?d.coordinates.map(s=>({type:"Point",coordinates:s})):[d]}class Ec{constructor(s,u){this.type=Bt,this.geojson=s,this.geometries=u}static parse(s,u){if(s.length!==2)return u.error(`'distance' expression requires exactly one argument, but found ${s.length-1} instead.`);if(Xc(s[1])){let y=s[1];if(y.type==="FeatureCollection")return new Ec(y,y.features.map(T=>Ka(T.geometry)).flat());if(y.type==="Feature")return new Ec(y,Ka(y.geometry));if("type"in y&&"coordinates"in y)return new Ec(y,Ka(y))}return u.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(s){if(s.geometry()!=null&&s.canonicalID()!=null){if(s.geometryType()==="Point")return function(u,y){let T=u.geometry(),D=T.flat().map(G=>Rp([G.x,G.y],u.canonical));if(T.length===0)return NaN;let R=new Ol(D[0][1]),B=1/0;for(let G of y){switch(G.type){case"Point":B=Math.min(B,du(D,!1,[G.coordinates],!1,R,B));break;case"LineString":B=Math.min(B,du(D,!1,G.coordinates,!0,R,B));break;case"Polygon":B=Math.min(B,Uu(D,!1,G.coordinates,R,B))}if(B===0)return B}return B}(s,this.geometries);if(s.geometryType()==="LineString")return function(u,y){let T=u.geometry(),D=T.flat().map(G=>Rp([G.x,G.y],u.canonical));if(T.length===0)return NaN;let R=new Ol(D[0][1]),B=1/0;for(let G of y){switch(G.type){case"Point":B=Math.min(B,du(D,!0,[G.coordinates],!1,R,B));break;case"LineString":B=Math.min(B,du(D,!0,G.coordinates,!0,R,B));break;case"Polygon":B=Math.min(B,Uu(D,!0,G.coordinates,R,B))}if(B===0)return B}return B}(s,this.geometries);if(s.geometryType()==="Polygon")return function(u,y){let T=u.geometry();if(T.length===0||T[0].length===0)return NaN;let D=Js(T,0).map(G=>G.map(K=>K.map(Q=>Rp([Q.x,Q.y],u.canonical)))),R=new Ol(D[0][0][0][1]),B=1/0;for(let G of y)for(let K of D){switch(G.type){case"Point":B=Math.min(B,Uu([G.coordinates],!1,K,R,B));break;case"LineString":B=Math.min(B,Uu(G.coordinates,!0,K,R,B));break;case"Polygon":B=Math.min(B,Fl(K,G.coordinates,R,B))}if(B===0)return B}return B}(s,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}class xi{constructor(s){this.type=Hi,this.key=s}static parse(s,u){if(s.length!==2)return u.error(`Expected 1 argument, but found ${s.length-1} instead.`);let y=s[1];return y==null?u.error("Global state property must be defined."):typeof y!="string"?u.error(`Global state property must be string, but found ${typeof s[1]} instead.`):new xi(y)}evaluate(s){var u;let y=(u=s.globals)===null||u===void 0?void 0:u.globalState;return y&&Object.keys(y).length!==0?Ir(y,this.key):null}eachChild(){}outputDefined(){return!1}}let kh={"==":lu,"!=":Md,">":us,"<":ka,">=":Rh,"<=":Cm,array:ll,at:Ns,boolean:ll,case:Ds,coalesce:Do,collator:ku,format:zl,image:Ou,in:Yc,"index-of":Jc,interpolate:Ri,"interpolate-hcl":Ri,"interpolate-lab":Ri,length:Ks,let:nc,literal:Bs,match:sr,number:ll,"number-format":th,object:ll,slice:en,step:Qc,string:ll,"to-boolean":Sa,"to-color":Sa,"to-number":Sa,"to-string":Sa,var:hs,within:ws,distance:Ec,"global-state":xi};class Ya{constructor(s,u,y,T){this.name=s,this.type=u,this._evaluate=y,this.args=T}evaluate(s){return this._evaluate(s,this.args)}eachChild(s){this.args.forEach(s)}outputDefined(){return!1}static parse(s,u){let y=s[0],T=Ya.definitions[y];if(!T)return u.error(`Unknown expression "${y}". If you wanted a literal array, use ["literal", [...]].`,0);let D=Array.isArray(T)?T[0]:T.type,R=Array.isArray(T)?[[T[1],T[2]]]:T.overloads,B=R.filter(([K])=>!Array.isArray(K)||K.length===s.length-1),G=null;for(let[K,Q]of B){G=new Ah(u.registry,sh,u.path,null,u.scope);let ce=[],_e=!1;for(let ve=1;ve<s.length;ve++){let Te=s[ve],De=Array.isArray(K)?K[ve-1]:K.type,Ye=G.parse(Te,1+ce.length,De);if(!Ye){_e=!0;break}ce.push(Ye)}if(!_e)if(Array.isArray(K)&&K.length!==ce.length)G.error(`Expected ${K.length} arguments, but found ${ce.length} instead.`);else{for(let ve=0;ve<ce.length;ve++){let Te=Array.isArray(K)?K[ve]:K.type,De=ce[ve];G.concat(ve+1).checkSubtype(Te,De.type)}if(G.errors.length===0)return new Ya(y,D,Q,ce)}}if(B.length===1)u.errors.push(...G.errors);else{let K=(B.length?B:R).map(([ce])=>{return _e=ce,Array.isArray(_e)?`(${_e.map(xo).join(", ")})`:`(${xo(_e.type)}...)`;var _e}).join(" | "),Q=[];for(let ce=1;ce<s.length;ce++){let _e=u.parse(s[ce],1+Q.length);if(!_e)return null;Q.push(xo(_e.type))}u.error(`Expected arguments of type ${K}, but found (${Q.join(", ")}) instead.`)}return null}static register(s,u){Ya.definitions=u;for(let y in u)s[y]=Ya}}function Dd(d,[s,u,y,T]){s=s.evaluate(d),u=u.evaluate(d),y=y.evaluate(d);let D=T?T.evaluate(d):1,R=Tr(s,u,y,D);if(R)throw new cs(R);return new Pr(s/255,u/255,y/255,D,!1)}function Bp(d,s){return d in s}function oh(d,s){let u=s[d];return u===void 0?null:u}function sa(d){return{type:d}}function sh(d){if(d instanceof hs)return sh(d.boundExpression);if(d instanceof Ya&&d.name==="error"||d instanceof ku||d instanceof ws||d instanceof Ec||d instanceof xi)return!1;let s=d instanceof Sa||d instanceof ll,u=!0;return d.eachChild(y=>{u=s?u&&sh(y):u&&y instanceof Bs}),!!u&&oc(d)&&Bl(d,["zoom","heatmap-density","elevation","line-progress","accumulated","is-supported-script"])}function oc(d){if(d instanceof Ya&&(d.name==="get"&&d.args.length===1||d.name==="feature-state"||d.name==="has"&&d.args.length===1||d.name==="properties"||d.name==="geometry-type"||d.name==="id"||/^filter-/.test(d.name))||d instanceof ws||d instanceof Ec)return!1;let s=!0;return d.eachChild(u=>{s&&!oc(u)&&(s=!1)}),s}function ah(d){if(d instanceof Ya&&d.name==="feature-state")return!1;let s=!0;return d.eachChild(u=>{s&&!ah(u)&&(s=!1)}),s}function Bl(d,s){if(d instanceof Ya&&s.indexOf(d.name)>=0)return!1;let u=!0;return d.eachChild(y=>{u&&!Bl(y,s)&&(u=!1)}),u}function pu(d){return{result:"success",value:d}}function Wn(d){return{result:"error",value:d}}function Oh(d){return d["property-type"]==="data-driven"||d["property-type"]==="cross-faded-data-driven"}function hf(d){return!!d.expression&&d.expression.parameters.indexOf("zoom")>-1}function Np(d){return!!d.expression&&d.expression.interpolated}function Dr(d){return d instanceof Number?"number":d instanceof String?"string":d instanceof Boolean?"boolean":Array.isArray(d)?"array":d===null?"null":typeof d}function lh(d){return typeof d=="object"&&d!==null&&!Array.isArray(d)&&Fn(d)===kr}function uo(d){return d}function Vf(d,s){let u=d.stops&&typeof d.stops[0][0]=="object",y=u||!(u||d.property!==void 0),T=d.type||(Np(s)?"exponential":"interval"),D=function(Q){switch(Q.type){case"color":return Pr.parse;case"padding":return wn.parse;case"numberArray":return Ps.parse;case"colorArray":return gs.parse;default:return null}}(s);if(D&&((d=Ot({},d)).stops&&(d.stops=d.stops.map(Q=>[Q[0],D(Q[1])])),d.default=D(d.default?d.default:s.default)),d.colorSpace&&(R=d.colorSpace)!=="rgb"&&R!=="hcl"&&R!=="lab")throw new Error(`Unknown color space: "${d.colorSpace}"`);var R;let B=function(Q){switch(Q){case"exponential":return jf;case"interval":return Uf;case"categorical":return Em;case"identity":return zd;default:throw new Error(`Unknown function type "${Q}"`)}}(T),G,K;if(T==="categorical"){G=Object.create(null);for(let Q of d.stops)G[Q[0]]=Q[1];K=typeof d.stops[0][0]}if(u){let Q={},ce=[];for(let Te=0;Te<d.stops.length;Te++){let De=d.stops[Te],Ye=De[0].zoom;Q[Ye]===void 0&&(Q[Ye]={zoom:Ye,type:d.type,property:d.property,default:d.default,stops:[]},ce.push(Ye)),Q[Ye].stops.push([De[0].value,De[1]])}let _e=[];for(let Te of ce)_e.push([Q[Te].zoom,Vf(Q[Te],s)]);let ve={name:"linear"};return{kind:"composite",interpolationType:ve,interpolationFactor:Ri.interpolationFactor.bind(void 0,ve),zoomStops:_e.map(Te=>Te[0]),evaluate:({zoom:Te},De)=>jf({stops:_e,base:d.base},s,Te).evaluate(Te,De)}}if(y){let Q=T==="exponential"?{name:"exponential",base:d.base!==void 0?d.base:1}:null;return{kind:"camera",interpolationType:Q,interpolationFactor:Ri.interpolationFactor.bind(void 0,Q),zoomStops:d.stops.map(ce=>ce[0]),evaluate:({zoom:ce})=>B(d,s,ce,G,K)}}return{kind:"source",evaluate(Q,ce){let _e=ce&&ce.properties?ce.properties[d.property]:void 0;return _e===void 0?Rd(d.default,s.default):B(d,s,_e,G,K)}}}function Rd(d,s,u){return d!==void 0?d:s!==void 0?s:u!==void 0?u:void 0}function Em(d,s,u,y,T){return Rd(typeof u===T?y[u]:void 0,d.default,s.default)}function Uf(d,s,u){if(Dr(u)!=="number")return Rd(d.default,s.default);let y=d.stops.length;if(y===1||u<=d.stops[0][0])return d.stops[0][1];if(u>=d.stops[y-1][0])return d.stops[y-1][1];let T=au(d.stops.map(D=>D[0]),u);return d.stops[T][1]}function jf(d,s,u){let y=d.base!==void 0?d.base:1;if(Dr(u)!=="number")return Rd(d.default,s.default);let T=d.stops.length;if(T===1||u<=d.stops[0][0])return d.stops[0][1];if(u>=d.stops[T-1][0])return d.stops[T-1][1];let D=au(d.stops.map(Q=>Q[0]),u),R=function(Q,ce,_e,ve){let Te=ve-_e,De=Q-_e;return Te===0?0:ce===1?De/Te:(Math.pow(ce,De)-1)/(Math.pow(ce,Te)-1)}(u,y,d.stops[D][0],d.stops[D+1][0]),B=d.stops[D][1],G=d.stops[D+1][1],K=Xn[s.type]||uo;return typeof B.evaluate=="function"?{evaluate(...Q){let ce=B.evaluate.apply(void 0,Q),_e=G.evaluate.apply(void 0,Q);if(ce!==void 0&&_e!==void 0)return K(ce,_e,R,d.colorSpace)}}:K(B,G,R,d.colorSpace)}function zd(d,s,u){switch(s.type){case"color":u=Pr.parse(u);break;case"formatted":u=Xs.fromString(u.toString());break;case"resolvedImage":u=As.fromString(u.toString());break;case"padding":u=wn.parse(u);break;case"colorArray":u=gs.parse(u);break;case"numberArray":u=Ps.parse(u);break;default:Dr(u)===s.type||s.type==="enum"&&s.values[u]||(u=void 0)}return Rd(u,d.default,s.default)}Ya.register(kh,{error:[{kind:"error"},[Di],(d,[s])=>{throw new cs(s.evaluate(d))}],typeof:[Di,[Hi],(d,[s])=>xo(Fn(s.evaluate(d)))],"to-rgba":[To(Bt,4),[dn],(d,[s])=>{let[u,y,T,D]=s.evaluate(d).rgb;return[255*u,255*y,255*T,D]}],rgb:[dn,[Bt,Bt,Bt],Dd],rgba:[dn,[Bt,Bt,Bt,Bt],Dd],has:{type:Ni,overloads:[[[Di],(d,[s])=>Bp(s.evaluate(d),d.properties())],[[Di,kr],(d,[s,u])=>Bp(s.evaluate(d),u.evaluate(d))]]},get:{type:Hi,overloads:[[[Di],(d,[s])=>oh(s.evaluate(d),d.properties())],[[Di,kr],(d,[s,u])=>oh(s.evaluate(d),u.evaluate(d))]]},"feature-state":[Hi,[Di],(d,[s])=>oh(s.evaluate(d),d.featureState||{})],properties:[kr,[],d=>d.properties()],"geometry-type":[Di,[],d=>d.geometryType()],id:[Hi,[],d=>d.id()],zoom:[Bt,[],d=>d.globals.zoom],"heatmap-density":[Bt,[],d=>d.globals.heatmapDensity||0],elevation:[Bt,[],d=>d.globals.elevation||0],"line-progress":[Bt,[],d=>d.globals.lineProgress||0],accumulated:[Hi,[],d=>d.globals.accumulated===void 0?null:d.globals.accumulated],"+":[Bt,sa(Bt),(d,s)=>{let u=0;for(let y of s)u+=y.evaluate(d);return u}],"*":[Bt,sa(Bt),(d,s)=>{let u=1;for(let y of s)u*=y.evaluate(d);return u}],"-":{type:Bt,overloads:[[[Bt,Bt],(d,[s,u])=>s.evaluate(d)-u.evaluate(d)],[[Bt],(d,[s])=>-s.evaluate(d)]]},"/":[Bt,[Bt,Bt],(d,[s,u])=>s.evaluate(d)/u.evaluate(d)],"%":[Bt,[Bt,Bt],(d,[s,u])=>s.evaluate(d)%u.evaluate(d)],ln2:[Bt,[],()=>Math.LN2],pi:[Bt,[],()=>Math.PI],e:[Bt,[],()=>Math.E],"^":[Bt,[Bt,Bt],(d,[s,u])=>Math.pow(s.evaluate(d),u.evaluate(d))],sqrt:[Bt,[Bt],(d,[s])=>Math.sqrt(s.evaluate(d))],log10:[Bt,[Bt],(d,[s])=>Math.log(s.evaluate(d))/Math.LN10],ln:[Bt,[Bt],(d,[s])=>Math.log(s.evaluate(d))],log2:[Bt,[Bt],(d,[s])=>Math.log(s.evaluate(d))/Math.LN2],sin:[Bt,[Bt],(d,[s])=>Math.sin(s.evaluate(d))],cos:[Bt,[Bt],(d,[s])=>Math.cos(s.evaluate(d))],tan:[Bt,[Bt],(d,[s])=>Math.tan(s.evaluate(d))],asin:[Bt,[Bt],(d,[s])=>Math.asin(s.evaluate(d))],acos:[Bt,[Bt],(d,[s])=>Math.acos(s.evaluate(d))],atan:[Bt,[Bt],(d,[s])=>Math.atan(s.evaluate(d))],min:[Bt,sa(Bt),(d,s)=>Math.min(...s.map(u=>u.evaluate(d)))],max:[Bt,sa(Bt),(d,s)=>Math.max(...s.map(u=>u.evaluate(d)))],abs:[Bt,[Bt],(d,[s])=>Math.abs(s.evaluate(d))],round:[Bt,[Bt],(d,[s])=>{let u=s.evaluate(d);return u<0?-Math.round(-u):Math.round(u)}],floor:[Bt,[Bt],(d,[s])=>Math.floor(s.evaluate(d))],ceil:[Bt,[Bt],(d,[s])=>Math.ceil(s.evaluate(d))],"filter-==":[Ni,[Di,Hi],(d,[s,u])=>d.properties()[s.value]===u.value],"filter-id-==":[Ni,[Hi],(d,[s])=>d.id()===s.value],"filter-type-==":[Ni,[Di],(d,[s])=>d.geometryType()===s.value],"filter-<":[Ni,[Di,Hi],(d,[s,u])=>{let y=d.properties()[s.value],T=u.value;return typeof y==typeof T&&y<T}],"filter-id-<":[Ni,[Hi],(d,[s])=>{let u=d.id(),y=s.value;return typeof u==typeof y&&u<y}],"filter->":[Ni,[Di,Hi],(d,[s,u])=>{let y=d.properties()[s.value],T=u.value;return typeof y==typeof T&&y>T}],"filter-id->":[Ni,[Hi],(d,[s])=>{let u=d.id(),y=s.value;return typeof u==typeof y&&u>y}],"filter-<=":[Ni,[Di,Hi],(d,[s,u])=>{let y=d.properties()[s.value],T=u.value;return typeof y==typeof T&&y<=T}],"filter-id-<=":[Ni,[Hi],(d,[s])=>{let u=d.id(),y=s.value;return typeof u==typeof y&&u<=y}],"filter->=":[Ni,[Di,Hi],(d,[s,u])=>{let y=d.properties()[s.value],T=u.value;return typeof y==typeof T&&y>=T}],"filter-id->=":[Ni,[Hi],(d,[s])=>{let u=d.id(),y=s.value;return typeof u==typeof y&&u>=y}],"filter-has":[Ni,[Hi],(d,[s])=>s.value in d.properties()],"filter-has-id":[Ni,[],d=>d.id()!==null&&d.id()!==void 0],"filter-type-in":[Ni,[To(Di)],(d,[s])=>s.value.indexOf(d.geometryType())>=0],"filter-id-in":[Ni,[To(Hi)],(d,[s])=>s.value.indexOf(d.id())>=0],"filter-in-small":[Ni,[Di,To(Hi)],(d,[s,u])=>u.value.indexOf(d.properties()[s.value])>=0],"filter-in-large":[Ni,[Di,To(Hi)],(d,[s,u])=>function(y,T,D,R){for(;D<=R;){let B=D+R>>1;if(T[B]===y)return!0;T[B]>y?R=B-1:D=B+1}return!1}(d.properties()[s.value],u.value,0,u.value.length-1)],all:{type:Ni,overloads:[[[Ni,Ni],(d,[s,u])=>s.evaluate(d)&&u.evaluate(d)],[sa(Ni),(d,s)=>{for(let u of s)if(!u.evaluate(d))return!1;return!0}]]},any:{type:Ni,overloads:[[[Ni,Ni],(d,[s,u])=>s.evaluate(d)||u.evaluate(d)],[sa(Ni),(d,s)=>{for(let u of s)if(u.evaluate(d))return!0;return!1}]]},"!":[Ni,[Ni],(d,[s])=>!s.evaluate(d)],"is-supported-script":[Ni,[Di],(d,[s])=>{let u=d.globals&&d.globals.isSupportedScript;return!u||u(s.evaluate(d))}],upcase:[Di,[Di],(d,[s])=>s.evaluate(d).toUpperCase()],downcase:[Di,[Di],(d,[s])=>s.evaluate(d).toLowerCase()],concat:[Di,sa(Hi),(d,s)=>s.map(u=>ic(u.evaluate(d))).join("")],"resolved-locale":[Di,[yr],(d,[s])=>s.evaluate(d).resolvedLocale()]});class Vp{constructor(s,u){this.expression=s,this._warningHistory={},this._evaluator=new Ap,this._defaultValue=u?function(y){if(y.type==="color"&&lh(y.default))return new Pr(0,0,0,0);switch(y.type){case"color":return Pr.parse(y.default)||null;case"padding":return wn.parse(y.default)||null;case"numberArray":return Ps.parse(y.default)||null;case"colorArray":return gs.parse(y.default)||null;case"variableAnchorOffsetCollection":return Cr.parse(y.default)||null;case"projectionDefinition":return or.parse(y.default)||null;default:return y.default===void 0?null:y.default}}(u):null,this._enumValues=u&&u.type==="enum"?u.values:null}evaluateWithoutErrorHandling(s,u,y,T,D,R){return this._evaluator.globals=s,this._evaluator.feature=u,this._evaluator.featureState=y,this._evaluator.canonical=T,this._evaluator.availableImages=D||null,this._evaluator.formattedSection=R,this.expression.evaluate(this._evaluator)}evaluate(s,u,y,T,D,R){this._evaluator.globals=s,this._evaluator.feature=u||null,this._evaluator.featureState=y||null,this._evaluator.canonical=T,this._evaluator.availableImages=D||null,this._evaluator.formattedSection=R||null;try{let B=this.expression.evaluate(this._evaluator);if(B==null||typeof B=="number"&&B!=B)return this._defaultValue;if(this._enumValues&&!(B in this._enumValues))throw new cs(`Expected value to be one of ${Object.keys(this._enumValues).map(G=>JSON.stringify(G)).join(", ")}, but found ${JSON.stringify(B)} instead.`);return B}catch(B){return this._warningHistory[B.message]||(this._warningHistory[B.message]=!0,typeof console<"u"&&console.warn(B.message)),this._defaultValue}}}function Ld(d){return Array.isArray(d)&&d.length>0&&typeof d[0]=="string"&&d[0]in kh}function ju(d,s){let u=new Ah(kh,sh,[],s?function(T){let D={color:dn,string:Di,number:Bt,enum:Di,boolean:Ni,formatted:Jn,padding:Un,numberArray:go,colorArray:Ar,projectionDefinition:An,resolvedImage:yo,variableAnchorOffsetCollection:Qo};return T.type==="array"?To(D[T.value]||Hi,T.length):D[T.type]}(s):void 0),y=u.parse(d,void 0,void 0,void 0,s&&s.type==="string"?{typeAnnotation:"coerce"}:void 0);return y?pu(new Vp(y,s)):Wn(u.errors)}class Fh{constructor(s,u){this.kind=s,this._styleExpression=u,this.isStateDependent=s!=="constant"&&!ah(u.expression),this.globalStateRefs=sc(u.expression)}evaluateWithoutErrorHandling(s,u,y,T,D,R){return this._styleExpression.evaluateWithoutErrorHandling(s,u,y,T,D,R)}evaluate(s,u,y,T,D,R){return this._styleExpression.evaluate(s,u,y,T,D,R)}}class Gu{constructor(s,u,y,T){this.kind=s,this.zoomStops=y,this._styleExpression=u,this.isStateDependent=s!=="camera"&&!ah(u.expression),this.globalStateRefs=sc(u.expression),this.interpolationType=T}evaluateWithoutErrorHandling(s,u,y,T,D,R){return this._styleExpression.evaluateWithoutErrorHandling(s,u,y,T,D,R)}evaluate(s,u,y,T,D,R){return this._styleExpression.evaluate(s,u,y,T,D,R)}interpolationFactor(s,u,y){return this.interpolationType?Ri.interpolationFactor(this.interpolationType,s,u,y):0}}function ch(d,s){let u=ju(d,s);if(u.result==="error")return u;let y=u.value.expression,T=oc(y);if(!T&&!Oh(s))return Wn([new wt("","data expressions not supported")]);let D=Bl(y,["zoom"]);if(!D&&!hf(s))return Wn([new wt("","zoom expressions not supported")]);let R=mu(y);return R||D?R instanceof wt?Wn([R]):R instanceof Ri&&!Np(s)?Wn([new wt("",'"interpolate" expressions cannot be used with this property')]):pu(R?new Gu(T?"camera":"composite",u.value,R.labels,R instanceof Ri?R.interpolation:void 0):new Fh(T?"constant":"source",u.value)):Wn([new wt("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class fu{constructor(s,u){this._parameters=s,this._specification=u,Ot(this,Vf(this._parameters,this._specification))}static deserialize(s){return new fu(s._parameters,s._specification)}static serialize(s){return{_parameters:s._parameters,_specification:s._specification}}}function mu(d){let s=null;if(d instanceof nc)s=mu(d.result);else if(d instanceof Do){for(let u of d.args)if(s=mu(u),s)break}else(d instanceof Qc||d instanceof Ri)&&d.input instanceof Ya&&d.input.name==="zoom"&&(s=d);return s instanceof wt||d.eachChild(u=>{let y=mu(u);y instanceof wt?s=y:!s&&y?s=new wt("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):s&&y&&s!==y&&(s=new wt("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),s}function sc(d,s=new Set){return d instanceof xi&&s.add(d.key),d.eachChild(u=>{sc(u,s)}),s}function hh(d){if(d===!0||d===!1)return!0;if(!Array.isArray(d)||d.length===0)return!1;switch(d[0]){case"has":return d.length>=2&&d[1]!=="$id"&&d[1]!=="$type";case"in":return d.length>=3&&(typeof d[1]!="string"||Array.isArray(d[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return d.length!==3||Array.isArray(d[1])||Array.isArray(d[2]);case"any":case"all":for(let s of d.slice(1))if(!hh(s)&&typeof s!="boolean")return!1;return!0;default:return!0}}let Zu={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function ac(d){if(d==null)return{filter:()=>!0,needGeometry:!1,getGlobalStateRefs:()=>new Set};hh(d)||(d=$u(d));let s=ju(d,Zu);if(s.result==="error")throw new Error(s.value.map(u=>`${u.key}: ${u.message}`).join(", "));return{filter:(u,y,T)=>s.value.evaluate(u,y,{},T),needGeometry:kd(d),getGlobalStateRefs:()=>sc(s.value.expression)}}function qu(d,s){return d<s?-1:d>s?1:0}function kd(d){if(!Array.isArray(d))return!1;if(d[0]==="within"||d[0]==="distance")return!0;for(let s=1;s<d.length;s++)if(kd(d[s]))return!0;return!1}function $u(d){if(!d)return!0;let s=d[0];return d.length<=1?s!=="any":s==="=="?Up(d[1],d[2],"=="):s==="!="?uh(Up(d[1],d[2],"==")):s==="<"||s===">"||s==="<="||s===">="?Up(d[1],d[2],s):s==="any"?(u=d.slice(1),["any"].concat(u.map($u))):s==="all"?["all"].concat(d.slice(1).map($u)):s==="none"?["all"].concat(d.slice(1).map($u).map(uh)):s==="in"?jp(d[1],d.slice(2)):s==="!in"?uh(jp(d[1],d.slice(2))):s==="has"?Od(d[1]):s!=="!has"||uh(Od(d[1]));var u}function Up(d,s,u){switch(d){case"$type":return[`filter-type-${u}`,s];case"$id":return[`filter-id-${u}`,s];default:return[`filter-${u}`,d,s]}}function jp(d,s){if(s.length===0)return!1;switch(d){case"$type":return["filter-type-in",["literal",s]];case"$id":return["filter-id-in",["literal",s]];default:return s.length>200&&!s.some(u=>typeof u!=typeof s[0])?["filter-in-large",d,["literal",s.sort(qu)]]:["filter-in-small",d,["literal",s]]}}function Od(d){switch(d){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",d]}}function uh(d){return["!",d]}function Fd(d){let s=typeof d;if(s==="number"||s==="boolean"||s==="string"||d==null)return JSON.stringify(d);if(Array.isArray(d)){let T="[";for(let D of d)T+=`${Fd(D)},`;return`${T}]`}let u=Object.keys(d).sort(),y="{";for(let T=0;T<u.length;T++)y+=`${JSON.stringify(u[T])}:${Fd(d[u[T]])},`;return`${y}}`}function Bd(d){let s="";for(let u of Qi)s+=`/${Fd(d[u])}`;return s}function uf(d){let s=d.value;return s?[new nt(d.key,s,"constants have been deprecated as of v8")]:[]}function Ro(d){return d instanceof Number||d instanceof String||d instanceof Boolean?d.valueOf():d}function dh(d){if(Array.isArray(d))return d.map(dh);if(d instanceof Object&&!(d instanceof Number||d instanceof String||d instanceof Boolean)){let s={};for(let u in d)s[u]=dh(d[u]);return s}return Ro(d)}function Nl(d){let s=d.key,u=d.value,y=d.valueSpec||{},T=d.objectElementValidators||{},D=d.style,R=d.styleSpec,B=d.validateSpec,G=[],K=Dr(u);if(K!=="object")return[new nt(s,u,`object expected, ${K} found`)];for(let Q in u){let ce=Q.split(".")[0],_e=Ir(y,ce)||y["*"],ve;if(Ir(T,ce))ve=T[ce];else if(Ir(y,ce))ve=B;else if(T["*"])ve=T["*"];else{if(!y["*"]){G.push(new nt(s,u[Q],`unknown property "${Q}"`));continue}ve=B}G=G.concat(ve({key:(s&&`${s}.`)+Q,value:u[Q],valueSpec:_e,style:D,styleSpec:R,object:u,objectKey:Q,validateSpec:B},u))}for(let Q in y)T[Q]||y[Q].required&&y[Q].default===void 0&&u[Q]===void 0&&G.push(new nt(s,u,`missing required property "${Q}"`));return G}function Wu(d){let s=d.value,u=d.valueSpec,y=d.style,T=d.styleSpec,D=d.key,R=d.arrayElementValidator||d.validateSpec;if(Dr(s)!=="array")return[new nt(D,s,`array expected, ${Dr(s)} found`)];if(u.length&&s.length!==u.length)return[new nt(D,s,`array length ${u.length} expected, length ${s.length} found`)];if(u["min-length"]&&s.length<u["min-length"])return[new nt(D,s,`array length at least ${u["min-length"]} expected, length ${s.length} found`)];let B={type:u.value,values:u.values};T.$version<7&&(B.function=u.function),Dr(u.value)==="object"&&(B=u.value);let G=[];for(let K=0;K<s.length;K++)G=G.concat(R({array:s,arrayIndex:K,value:s[K],valueSpec:B,validateSpec:d.validateSpec,style:y,styleSpec:T,key:`${D}[${K}]`}));return G}function Nd(d){let s=d.key,u=d.value,y=d.valueSpec,T=Dr(u);return T==="number"&&u!=u&&(T="NaN"),T!=="number"?[new nt(s,u,`number expected, ${T} found`)]:"minimum"in y&&u<y.minimum?[new nt(s,u,`${u} is less than the minimum value ${y.minimum}`)]:"maximum"in y&&u>y.maximum?[new nt(s,u,`${u} is greater than the maximum value ${y.maximum}`)]:[]}function ph(d){let s=d.valueSpec,u=Ro(d.value.type),y,T,D,R={},B=u!=="categorical"&&d.value.property===void 0,G=!B,K=Dr(d.value.stops)==="array"&&Dr(d.value.stops[0])==="array"&&Dr(d.value.stops[0][0])==="object",Q=Nl({key:d.key,value:d.value,valueSpec:d.styleSpec.function,validateSpec:d.validateSpec,style:d.style,styleSpec:d.styleSpec,objectElementValidators:{stops:function(ve){if(u==="identity")return[new nt(ve.key,ve.value,'identity function may not have a "stops" property')];let Te=[],De=ve.value;return Te=Te.concat(Wu({key:ve.key,value:De,valueSpec:ve.valueSpec,validateSpec:ve.validateSpec,style:ve.style,styleSpec:ve.styleSpec,arrayElementValidator:ce})),Dr(De)==="array"&&De.length===0&&Te.push(new nt(ve.key,De,"array must have at least one stop")),Te},default:function(ve){return ve.validateSpec({key:ve.key,value:ve.value,valueSpec:s,validateSpec:ve.validateSpec,style:ve.style,styleSpec:ve.styleSpec})}}});return u==="identity"&&B&&Q.push(new nt(d.key,d.value,'missing required property "property"')),u==="identity"||d.value.stops||Q.push(new nt(d.key,d.value,'missing required property "stops"')),u==="exponential"&&d.valueSpec.expression&&!Np(d.valueSpec)&&Q.push(new nt(d.key,d.value,"exponential functions not supported")),d.styleSpec.$version>=8&&(G&&!Oh(d.valueSpec)?Q.push(new nt(d.key,d.value,"property functions not supported")):B&&!hf(d.valueSpec)&&Q.push(new nt(d.key,d.value,"zoom functions not supported"))),u!=="categorical"&&!K||d.value.property!==void 0||Q.push(new nt(d.key,d.value,'"property" property is required')),Q;function ce(ve){let Te=[],De=ve.value,Ye=ve.key;if(Dr(De)!=="array")return[new nt(Ye,De,`array expected, ${Dr(De)} found`)];if(De.length!==2)return[new nt(Ye,De,`array length 2 expected, length ${De.length} found`)];if(K){if(Dr(De[0])!=="object")return[new nt(Ye,De,`object expected, ${Dr(De[0])} found`)];if(De[0].zoom===void 0)return[new nt(Ye,De,"object stop key must have zoom")];if(De[0].value===void 0)return[new nt(Ye,De,"object stop key must have value")];if(D&&D>Ro(De[0].zoom))return[new nt(Ye,De[0].zoom,"stop zoom values must appear in ascending order")];Ro(De[0].zoom)!==D&&(D=Ro(De[0].zoom),T=void 0,R={}),Te=Te.concat(Nl({key:`${Ye}[0]`,value:De[0],valueSpec:{zoom:{}},validateSpec:ve.validateSpec,style:ve.style,styleSpec:ve.styleSpec,objectElementValidators:{zoom:Nd,value:_e}}))}else Te=Te.concat(_e({key:`${Ye}[0]`,value:De[0],validateSpec:ve.validateSpec,style:ve.style,styleSpec:ve.styleSpec},De));return Ld(dh(De[1]))?Te.concat([new nt(`${Ye}[1]`,De[1],"expressions are not allowed in function stops.")]):Te.concat(ve.validateSpec({key:`${Ye}[1]`,value:De[1],valueSpec:s,validateSpec:ve.validateSpec,style:ve.style,styleSpec:ve.styleSpec}))}function _e(ve,Te){let De=Dr(ve.value),Ye=Ro(ve.value),lt=ve.value!==null?ve.value:Te;if(y){if(De!==y)return[new nt(ve.key,lt,`${De} stop domain type must match previous stop domain type ${y}`)]}else y=De;if(De!=="number"&&De!=="string"&&De!=="boolean")return[new nt(ve.key,lt,"stop domain value must be a number, string, or boolean")];if(De!=="number"&&u!=="categorical"){let Mt=`number expected, ${De} found`;return Oh(s)&&u===void 0&&(Mt+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new nt(ve.key,lt,Mt)]}return u!=="categorical"||De!=="number"||isFinite(Ye)&&Math.floor(Ye)===Ye?u!=="categorical"&&De==="number"&&T!==void 0&&Ye<T?[new nt(ve.key,lt,"stop domain values must appear in ascending order")]:(T=Ye,u==="categorical"&&Ye in R?[new nt(ve.key,lt,"stop domain values must be unique")]:(R[Ye]=!0,[])):[new nt(ve.key,lt,`integer expected, found ${Ye}`)]}}function Bh(d){let s=(d.expressionContext==="property"?ch:ju)(dh(d.value),d.valueSpec);if(s.result==="error")return s.value.map(y=>new nt(`${d.key}${y.key}`,d.value,y.message));let u=s.value.expression||s.value._styleExpression.expression;if(d.expressionContext==="property"&&d.propertyKey==="text-font"&&!u.outputDefined())return[new nt(d.key,d.value,`Invalid data expression for "${d.propertyKey}". Output values must be contained as literals within the expression.`)];if(d.expressionContext==="property"&&d.propertyType==="layout"&&!ah(u))return[new nt(d.key,d.value,'"feature-state" data expressions are not supported with layout properties.')];if(d.expressionContext==="filter"&&!ah(u))return[new nt(d.key,d.value,'"feature-state" data expressions are not supported with filters.')];if(d.expressionContext&&d.expressionContext.indexOf("cluster")===0){if(!Bl(u,["zoom","feature-state"]))return[new nt(d.key,d.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(d.expressionContext==="cluster-initial"&&!oc(u))return[new nt(d.key,d.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Vd(d){let s=d.key,u=d.value,y=Dr(u);return y!=="string"?[new nt(s,u,`color expected, ${y} found`)]:Pr.parse(String(u))?[]:[new nt(s,u,`color expected, "${u}" found`)]}function _u(d){let s=d.key,u=d.value,y=d.valueSpec,T=[];return Array.isArray(y.values)?y.values.indexOf(Ro(u))===-1&&T.push(new nt(s,u,`expected one of [${y.values.join(", ")}], ${JSON.stringify(u)} found`)):Object.keys(y.values).indexOf(Ro(u))===-1&&T.push(new nt(s,u,`expected one of [${Object.keys(y.values).join(", ")}], ${JSON.stringify(u)} found`)),T}function Ud(d){return hh(dh(d.value))?Bh(Ot({},d,{expressionContext:"filter",valueSpec:{value:"boolean"}})):Gp(d)}function Gp(d){let s=d.value,u=d.key;if(Dr(s)!=="array")return[new nt(u,s,`array expected, ${Dr(s)} found`)];let y=d.styleSpec,T,D=[];if(s.length<1)return[new nt(u,s,"filter array must have at least 1 element")];switch(D=D.concat(_u({key:`${u}[0]`,value:s[0],valueSpec:y.filter_operator,style:d.style,styleSpec:d.styleSpec})),Ro(s[0])){case"<":case"<=":case">":case">=":s.length>=2&&Ro(s[1])==="$type"&&D.push(new nt(u,s,`"$type" cannot be use with operator "${s[0]}"`));case"==":case"!=":s.length!==3&&D.push(new nt(u,s,`filter array for operator "${s[0]}" must have 3 elements`));case"in":case"!in":s.length>=2&&(T=Dr(s[1]),T!=="string"&&D.push(new nt(`${u}[1]`,s[1],`string expected, ${T} found`)));for(let R=2;R<s.length;R++)T=Dr(s[R]),Ro(s[1])==="$type"?D=D.concat(_u({key:`${u}[${R}]`,value:s[R],valueSpec:y.geometry_type,style:d.style,styleSpec:d.styleSpec})):T!=="string"&&T!=="number"&&T!=="boolean"&&D.push(new nt(`${u}[${R}]`,s[R],`string, number, or boolean expected, ${T} found`));break;case"any":case"all":case"none":for(let R=1;R<s.length;R++)D=D.concat(Gp({key:`${u}[${R}]`,value:s[R],style:d.style,styleSpec:d.styleSpec}));break;case"has":case"!has":T=Dr(s[1]),s.length!==2?D.push(new nt(u,s,`filter array for "${s[0]}" operator must have 2 elements`)):T!=="string"&&D.push(new nt(`${u}[1]`,s[1],`string expected, ${T} found`))}return D}function gu(d,s){let u=d.key,y=d.validateSpec,T=d.style,D=d.styleSpec,R=d.value,B=d.objectKey,G=D[`${s}_${d.layerType}`];if(!G)return[];let K=B.match(/^(.*)-transition$/);if(s==="paint"&&K&&G[K[1]]&&G[K[1]].transition)return y({key:u,value:R,valueSpec:D.transition,style:T,styleSpec:D});let Q=d.valueSpec||G[B];if(!Q)return[new nt(u,R,`unknown property "${B}"`)];let ce;if(Dr(R)==="string"&&Oh(Q)&&!Q.tokens&&(ce=/^{([^}]+)}$/.exec(R)))return[new nt(u,R,`"${B}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(ce[1])} }\`.`)];let _e=[];return d.layerType==="symbol"&&(B==="text-field"&&T&&!T.glyphs&&_e.push(new nt(u,R,'use of "text-field" requires a style "glyphs" property')),B==="text-font"&&lh(dh(R))&&Ro(R.type)==="identity"&&_e.push(new nt(u,R,'"text-font" does not support identity functions'))),_e.concat(y({key:d.key,value:R,valueSpec:Q,style:T,styleSpec:D,expressionContext:"property",propertyType:s,propertyKey:B}))}function lc(d){return gu(d,"paint")}function cc(d){return gu(d,"layout")}function Ja(d){let s=[],u=d.value,y=d.key,T=d.style,D=d.styleSpec;if(Dr(u)!=="object")return[new nt(y,u,`object expected, ${Dr(u)} found`)];u.type||u.ref||s.push(new nt(y,u,'either "type" or "ref" is required'));let R=Ro(u.type),B=Ro(u.ref);if(u.id){let G=Ro(u.id);for(let K=0;K<d.arrayIndex;K++){let Q=T.layers[K];Ro(Q.id)===G&&s.push(new nt(y,u.id,`duplicate layer id "${u.id}", previously used at line ${Q.id.__line__}`))}}if("ref"in u){let G;["type","source","source-layer","filter","layout"].forEach(K=>{K in u&&s.push(new nt(y,u[K],`"${K}" is prohibited for ref layers`))}),T.layers.forEach(K=>{Ro(K.id)===B&&(G=K)}),G?G.ref?s.push(new nt(y,u.ref,"ref cannot reference another ref layer")):R=Ro(G.type):s.push(new nt(y,u.ref,`ref layer "${B}" not found`))}else if(R!=="background")if(u.source){let G=T.sources&&T.sources[u.source],K=G&&Ro(G.type);G?K==="vector"&&R==="raster"?s.push(new nt(y,u.source,`layer "${u.id}" requires a raster source`)):K!=="raster-dem"&&R==="hillshade"||K!=="raster-dem"&&R==="color-relief"?s.push(new nt(y,u.source,`layer "${u.id}" requires a raster-dem source`)):K==="raster"&&R!=="raster"?s.push(new nt(y,u.source,`layer "${u.id}" requires a vector source`)):K!=="vector"||u["source-layer"]?K==="raster-dem"&&R!=="hillshade"&&R!=="color-relief"?s.push(new nt(y,u.source,"raster-dem source can only be used with layer type 'hillshade' or 'color-relief'.")):R!=="line"||!u.paint||!u.paint["line-gradient"]||K==="geojson"&&G.lineMetrics||s.push(new nt(y,u,`layer "${u.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):s.push(new nt(y,u,`layer "${u.id}" must specify a "source-layer"`)):s.push(new nt(y,u.source,`source "${u.source}" not found`))}else s.push(new nt(y,u,'missing required property "source"'));return s=s.concat(Nl({key:y,value:u,valueSpec:D.layer,style:d.style,styleSpec:d.styleSpec,validateSpec:d.validateSpec,objectElementValidators:{"*":()=>[],type:()=>d.validateSpec({key:`${y}.type`,value:u.type,valueSpec:D.layer.type,style:d.style,styleSpec:d.styleSpec,validateSpec:d.validateSpec,object:u,objectKey:"type"}),filter:Ud,layout:G=>Nl({layer:u,key:G.key,value:G.value,style:G.style,styleSpec:G.styleSpec,validateSpec:G.validateSpec,objectElementValidators:{"*":K=>cc(Ot({layerType:R},K))}}),paint:G=>Nl({layer:u,key:G.key,value:G.value,style:G.style,styleSpec:G.styleSpec,validateSpec:G.validateSpec,objectElementValidators:{"*":K=>lc(Ot({layerType:R},K))}})}})),s}function es(d){let s=d.value,u=d.key,y=Dr(s);return y!=="string"?[new nt(u,s,`string expected, ${y} found`)]:[]}let yu={promoteId:function({key:d,value:s}){if(Dr(s)==="string")return es({key:d,value:s});{let u=[];for(let y in s)u.push(...es({key:`${d}.${y}`,value:s[y]}));return u}}};function jd(d){let s=d.value,u=d.key,y=d.styleSpec,T=d.style,D=d.validateSpec;if(!s.type)return[new nt(u,s,'"type" is required')];let R=Ro(s.type),B;switch(R){case"vector":case"raster":return B=Nl({key:u,value:s,valueSpec:y[`source_${R.replace("-","_")}`],style:d.style,styleSpec:y,objectElementValidators:yu,validateSpec:D}),B;case"raster-dem":return B=function(G){var K;let Q=(K=G.sourceName)!==null&&K!==void 0?K:"",ce=G.value,_e=G.styleSpec,ve=_e.source_raster_dem,Te=G.style,De=[],Ye=Dr(ce);if(ce===void 0)return De;if(Ye!=="object")return De.push(new nt("source_raster_dem",ce,`object expected, ${Ye} found`)),De;let lt=Ro(ce.encoding)==="custom",Mt=["redFactor","greenFactor","blueFactor","baseShift"],yt=G.value.encoding?`"${G.value.encoding}"`:"Default";for(let ye in ce)!lt&&Mt.includes(ye)?De.push(new nt(ye,ce[ye],`In "${Q}": "${ye}" is only valid when "encoding" is set to "custom". ${yt} encoding found`)):ve[ye]?De=De.concat(G.validateSpec({key:ye,value:ce[ye],valueSpec:ve[ye],validateSpec:G.validateSpec,style:Te,styleSpec:_e})):De.push(new nt(ye,ce[ye],`unknown property "${ye}"`));return De}({sourceName:u,value:s,style:d.style,styleSpec:y,validateSpec:D}),B;case"geojson":if(B=Nl({key:u,value:s,valueSpec:y.source_geojson,style:T,styleSpec:y,validateSpec:D,objectElementValidators:yu}),s.cluster)for(let G in s.clusterProperties){let[K,Q]=s.clusterProperties[G],ce=typeof K=="string"?[K,["accumulated"],["get",G]]:K;B.push(...Bh({key:`${u}.${G}.map`,value:Q,expressionContext:"cluster-map"})),B.push(...Bh({key:`${u}.${G}.reduce`,value:ce,expressionContext:"cluster-reduce"}))}return B;case"video":return Nl({key:u,value:s,valueSpec:y.source_video,style:T,validateSpec:D,styleSpec:y});case"image":return Nl({key:u,value:s,valueSpec:y.source_image,style:T,validateSpec:D,styleSpec:y});case"canvas":return[new nt(u,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return _u({key:`${u}.type`,value:s.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]}})}}function Gd(d){let s=d.value,u=d.styleSpec,y=u.light,T=d.style,D=[],R=Dr(s);if(s===void 0)return D;if(R!=="object")return D=D.concat([new nt("light",s,`object expected, ${R} found`)]),D;for(let B in s){let G=B.match(/^(.*)-transition$/);D=D.concat(G&&y[G[1]]&&y[G[1]].transition?d.validateSpec({key:B,value:s[B],valueSpec:u.transition,validateSpec:d.validateSpec,style:T,styleSpec:u}):y[B]?d.validateSpec({key:B,value:s[B],valueSpec:y[B],validateSpec:d.validateSpec,style:T,styleSpec:u}):[new nt(B,s[B],`unknown property "${B}"`)])}return D}function fh(d){let s=d.value,u=d.styleSpec,y=u.sky,T=d.style,D=Dr(s);if(s===void 0)return[];if(D!=="object")return[new nt("sky",s,`object expected, ${D} found`)];let R=[];for(let B in s)R=R.concat(y[B]?d.validateSpec({key:B,value:s[B],valueSpec:y[B],style:T,styleSpec:u}):[new nt(B,s[B],`unknown property "${B}"`)]);return R}function Hu(d){let s=d.value,u=d.styleSpec,y=u.terrain,T=d.style,D=[],R=Dr(s);if(s===void 0)return D;if(R!=="object")return D=D.concat([new nt("terrain",s,`object expected, ${R} found`)]),D;for(let B in s)D=D.concat(y[B]?d.validateSpec({key:B,value:s[B],valueSpec:y[B],validateSpec:d.validateSpec,style:T,styleSpec:u}):[new nt(B,s[B],`unknown property "${B}"`)]);return D}function Xu(d){let s=[],u=d.value,y=d.key;if(Array.isArray(u)){let T=[],D=[];for(let R in u)u[R].id&&T.includes(u[R].id)&&s.push(new nt(y,u,`all the sprites' ids must be unique, but ${u[R].id} is duplicated`)),T.push(u[R].id),u[R].url&&D.includes(u[R].url)&&s.push(new nt(y,u,`all the sprites' URLs must be unique, but ${u[R].url} is duplicated`)),D.push(u[R].url),s=s.concat(Nl({key:`${y}[${R}]`,value:u[R],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:d.validateSpec}));return s}return es({key:y,value:u})}function Zd(d){return s=d.value,s&&s.constructor===Object?[]:[new nt(d.key,d.value,`object expected, ${Dr(d.value)} found`)];var s}let Ku={"*":()=>[],array:Wu,boolean:function(d){let s=d.value,u=d.key,y=Dr(s);return y!=="boolean"?[new nt(u,s,`boolean expected, ${y} found`)]:[]},number:Nd,color:Vd,constants:uf,enum:_u,filter:Ud,function:ph,layer:Ja,object:Nl,source:jd,light:Gd,sky:fh,terrain:Hu,projection:function(d){let s=d.value,u=d.styleSpec,y=u.projection,T=d.style,D=Dr(s);if(s===void 0)return[];if(D!=="object")return[new nt("projection",s,`object expected, ${D} found`)];let R=[];for(let B in s)R=R.concat(y[B]?d.validateSpec({key:B,value:s[B],valueSpec:y[B],style:T,styleSpec:u}):[new nt(B,s[B],`unknown property "${B}"`)]);return R},projectionDefinition:function(d){let s=d.key,u=d.value;u=u instanceof String?u.valueOf():u;let y=Dr(u);return y!=="array"||function(T){return Array.isArray(T)&&T.length===3&&typeof T[0]=="string"&&typeof T[1]=="string"&&typeof T[2]=="number"}(u)||function(T){return!!["interpolate","step","literal"].includes(T[0])}(u)?["array","string"].includes(y)?[]:[new nt(s,u,`projection expected, invalid type "${y}" found`)]:[new nt(s,u,`projection expected, invalid array ${JSON.stringify(u)} found`)]},string:es,formatted:function(d){return es(d).length===0?[]:Bh(d)},resolvedImage:function(d){return es(d).length===0?[]:Bh(d)},padding:function(d){let s=d.key,u=d.value;if(Dr(u)==="array"){if(u.length<1||u.length>4)return[new nt(s,u,`padding requires 1 to 4 values; ${u.length} values found`)];let y={type:"number"},T=[];for(let D=0;D<u.length;D++)T=T.concat(d.validateSpec({key:`${s}[${D}]`,value:u[D],validateSpec:d.validateSpec,valueSpec:y}));return T}return Nd({key:s,value:u,valueSpec:{}})},numberArray:function(d){let s=d.key,u=d.value;if(Dr(u)==="array"){let y={type:"number"};if(u.length<1)return[new nt(s,u,"array length at least 1 expected, length 0 found")];let T=[];for(let D=0;D<u.length;D++)T=T.concat(d.validateSpec({key:`${s}[${D}]`,value:u[D],validateSpec:d.validateSpec,valueSpec:y}));return T}return Nd({key:s,value:u,valueSpec:{}})},colorArray:function(d){let s=d.key,u=d.value;if(Dr(u)==="array"){if(u.length<1)return[new nt(s,u,"array length at least 1 expected, length 0 found")];let y=[];for(let T=0;T<u.length;T++)y=y.concat(Vd({key:`${s}[${T}]`,value:u[T]}));return y}return Vd({key:s,value:u})},variableAnchorOffsetCollection:function(d){let s=d.key,u=d.value,y=Dr(u),T=d.styleSpec;if(y!=="array"||u.length<1||u.length%2!=0)return[new nt(s,u,"variableAnchorOffsetCollection requires a non-empty array of even length")];let D=[];for(let R=0;R<u.length;R+=2)D=D.concat(_u({key:`${s}[${R}]`,value:u[R],valueSpec:T.layout_symbol["text-anchor"]})),D=D.concat(Wu({key:`${s}[${R+1}]`,value:u[R+1],valueSpec:{length:2,value:"number"},validateSpec:d.validateSpec,style:d.style,styleSpec:T}));return D},sprite:Xu,state:Zd};function xu(d){let s=d.value,u=d.valueSpec,y=d.styleSpec;return d.validateSpec=xu,u.expression&&lh(Ro(s))?ph(d):u.expression&&Ld(dh(s))?Bh(d):u.type&&Ku[u.type]?Ku[u.type](d):Nl(Ot({},d,{valueSpec:u.type?y[u.type]:u}))}function Mc(d){let s=d.value,u=d.key,y=es(d);return y.length||(s.indexOf("{fontstack}")===-1&&y.push(new nt(u,s,'"glyphs" url must include a "{fontstack}" token')),s.indexOf("{range}")===-1&&y.push(new nt(u,s,'"glyphs" url must include a "{range}" token'))),y}function Oa(d,s=Ue){let u=[];return u=u.concat(xu({key:"",value:d,valueSpec:s.$root,styleSpec:s,style:d,validateSpec:xu,objectElementValidators:{glyphs:Mc,"*":()=>[]}})),d.constants&&(u=u.concat(uf({key:"constants",value:d.constants}))),Nh(u)}function Vl(d){return function(s){return d(Mb(Eb({},s),{validateSpec:xu}))}}function Nh(d){return[].concat(d).sort((s,u)=>s.line-u.line)}function Qa(d){return function(...s){return Nh(d.apply(this,s))}}Oa.source=Qa(Vl(jd)),Oa.sprite=Qa(Vl(Xu)),Oa.glyphs=Qa(Vl(Mc)),Oa.light=Qa(Vl(Gd)),Oa.sky=Qa(Vl(fh)),Oa.terrain=Qa(Vl(Hu)),Oa.state=Qa(Vl(Zd)),Oa.layer=Qa(Vl(Ja)),Oa.filter=Qa(Vl(Ud)),Oa.paintProperty=Qa(Vl(lc)),Oa.layoutProperty=Qa(Vl(cc));let Yu=Oa,Gf=Yu.light,qd=Yu.sky,Mm=Yu.paintProperty,df=Yu.layoutProperty;function vu(d,s){let u=!1;if(s&&s.length)for(let y of s)d.fire(new Zt(new Error(y.message))),u=!0;return u}class Pc{constructor(s,u,y){let T=this.cells=[];if(s instanceof ArrayBuffer){this.arrayBuffer=s;let R=new Int32Array(this.arrayBuffer);s=R[0],this.d=(u=R[1])+2*(y=R[2]);for(let G=0;G<this.d*this.d;G++){let K=R[3+G],Q=R[3+G+1];T.push(K===Q?null:R.subarray(K,Q))}let B=R[3+T.length+1];this.keys=R.subarray(R[3+T.length],B),this.bboxes=R.subarray(B),this.insert=this._insertReadonly}else{this.d=u+2*y;for(let R=0;R<this.d*this.d;R++)T.push([]);this.keys=[],this.bboxes=[]}this.n=u,this.extent=s,this.padding=y,this.scale=u/s,this.uid=0;let D=y/u*s;this.min=-D,this.max=s+D}insert(s,u,y,T,D){this._forEachCell(u,y,T,D,this._insertCell,this.uid++,void 0,void 0),this.keys.push(s),this.bboxes.push(u),this.bboxes.push(y),this.bboxes.push(T),this.bboxes.push(D)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(s,u,y,T,D,R){this.cells[D].push(R)}query(s,u,y,T,D){let R=this.min,B=this.max;if(s<=R&&u<=R&&B<=y&&B<=T&&!D)return Array.prototype.slice.call(this.keys);{let G=[];return this._forEachCell(s,u,y,T,this._queryCell,G,{},D),G}}_queryCell(s,u,y,T,D,R,B,G){let K=this.cells[D];if(K!==null){let Q=this.keys,ce=this.bboxes;for(let _e=0;_e<K.length;_e++){let ve=K[_e];if(B[ve]===void 0){let Te=4*ve;(G?G(ce[Te+0],ce[Te+1],ce[Te+2],ce[Te+3]):s<=ce[Te+2]&&u<=ce[Te+3]&&y>=ce[Te+0]&&T>=ce[Te+1])?(B[ve]=!0,R.push(Q[ve])):B[ve]=!1}}}}_forEachCell(s,u,y,T,D,R,B,G){let K=this._convertToCellCoord(s),Q=this._convertToCellCoord(u),ce=this._convertToCellCoord(y),_e=this._convertToCellCoord(T);for(let ve=K;ve<=ce;ve++)for(let Te=Q;Te<=_e;Te++){let De=this.d*Te+ve;if((!G||G(this._convertFromCellCoord(ve),this._convertFromCellCoord(Te),this._convertFromCellCoord(ve+1),this._convertFromCellCoord(Te+1)))&&D.call(this,s,u,y,T,De,R,B,G))return}}_convertFromCellCoord(s){return(s-this.padding)/this.scale}_convertToCellCoord(s){return Math.max(0,Math.min(this.d-1,Math.floor(s*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;let s=this.cells,u=3+this.cells.length+1+1,y=0;for(let R=0;R<this.cells.length;R++)y+=this.cells[R].length;let T=new Int32Array(u+y+this.keys.length+this.bboxes.length);T[0]=this.extent,T[1]=this.n,T[2]=this.padding;let D=u;for(let R=0;R<s.length;R++){let B=s[R];T[3+R]=D,T.set(B,D),D+=B.length}return T[3+s.length]=D,T.set(this.keys,D),D+=this.keys.length,T[3+s.length+1]=D,T.set(this.bboxes,D),D+=this.bboxes.length,T.buffer}static serialize(s,u){let y=s.toArrayBuffer();return u&&u.push(y),{buffer:y}}static deserialize(s){return new Pc(s.buffer)}}let hc={};function sn(d,s,u={}){if(hc[d])throw new Error(`${d} is already registered.`);Object.defineProperty(s,"_classRegistryKey",{value:d,writeable:!1}),hc[d]={klass:s,omit:u.omit||[],shallow:u.shallow||[]}}sn("Object",Object),sn("Set",Set),sn("TransferableGridIndex",Pc),sn("Color",Pr),sn("Error",Error),sn("AJAXError",mt),sn("ResolvedImage",As),sn("StylePropertyFunction",fu),sn("StyleExpression",Vp,{omit:["_evaluator"]}),sn("ZoomDependentExpression",Gu),sn("ZoomConstantExpression",Fh),sn("CompoundExpression",Ya,{omit:["_evaluate"]});for(let d in kh)kh[d]._classRegistryKey||sn(`Expression_${d}`,kh[d]);function Zp(d){return d&&typeof ArrayBuffer<"u"&&(d instanceof ArrayBuffer||d.constructor&&d.constructor.name==="ArrayBuffer")}function Ju(d){return d.$name||d.constructor._classRegistryKey}function $d(d){return!function(s){if(s===null||typeof s!="object")return!1;let u=Ju(s);return!(!u||u==="Object")}(d)&&(d==null||typeof d=="boolean"||typeof d=="number"||typeof d=="string"||d instanceof Boolean||d instanceof Number||d instanceof String||d instanceof Date||d instanceof RegExp||d instanceof Blob||d instanceof Error||Zp(d)||Wa(d)||ArrayBuffer.isView(d)||d instanceof ImageData)}function Vh(d,s){if($d(d))return(Zp(d)||Wa(d))&&s&&s.push(d),ArrayBuffer.isView(d)&&s&&s.push(d.buffer),d instanceof ImageData&&s&&s.push(d.data.buffer),d;if(Array.isArray(d)){let D=[];for(let R of d)D.push(Vh(R,s));return D}if(typeof d!="object")throw new Error("can't serialize object of type "+typeof d);let u=Ju(d);if(!u)throw new Error(`can't serialize object of unregistered class ${d.constructor.name}`);if(!hc[u])throw new Error(`${u} is not registered.`);let{klass:y}=hc[u],T=y.serialize?y.serialize(d,s):{};if(y.serialize){if(s&&T===s[s.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(let D in d){if(!d.hasOwnProperty(D)||hc[u].omit.indexOf(D)>=0)continue;let R=d[D];T[D]=hc[u].shallow.indexOf(D)>=0?R:Vh(R,s)}d instanceof Error&&(T.message=d.message)}if(T.$name)throw new Error("$name property is reserved for worker serialization logic.");return u!=="Object"&&(T.$name=u),T}function gl(d){if($d(d))return d;if(Array.isArray(d))return d.map(gl);if(typeof d!="object")throw new Error("can't deserialize object of type "+typeof d);let s=Ju(d)||"Object";if(!hc[s])throw new Error(`can't deserialize unregistered class ${s}`);let{klass:u}=hc[s];if(!u)throw new Error(`can't deserialize unregistered class ${s}`);if(u.deserialize)return u.deserialize(d);let y=Object.create(u.prototype);for(let T of Object.keys(d)){if(T==="$name")continue;let D=d[T];y[T]=hc[s].shallow.indexOf(T)>=0?D:gl(D)}return y}class qp{constructor(){this.first=!0}update(s,u){let y=Math.floor(s);return this.first?(this.first=!1,this.lastIntegerZoom=y,this.lastIntegerZoomTime=0,this.lastZoom=s,this.lastFloorZoom=y,!0):(this.lastFloorZoom>y?(this.lastIntegerZoom=y+1,this.lastIntegerZoomTime=u):this.lastFloorZoom<y&&(this.lastIntegerZoom=y,this.lastIntegerZoomTime=u),s!==this.lastZoom&&(this.lastZoom=s,this.lastFloorZoom=y,!0))}}let ar={"Latin-1 Supplement":d=>d>=128&&d<=255,"Hangul Jamo":d=>d>=4352&&d<=4607,Khmer:d=>d>=6016&&d<=6143,"General Punctuation":d=>d>=8192&&d<=8303,"Letterlike Symbols":d=>d>=8448&&d<=8527,"Number Forms":d=>d>=8528&&d<=8591,"Miscellaneous Technical":d=>d>=8960&&d<=9215,"Control Pictures":d=>d>=9216&&d<=9279,"Optical Character Recognition":d=>d>=9280&&d<=9311,"Enclosed Alphanumerics":d=>d>=9312&&d<=9471,"Geometric Shapes":d=>d>=9632&&d<=9727,"Miscellaneous Symbols":d=>d>=9728&&d<=9983,"Miscellaneous Symbols and Arrows":d=>d>=11008&&d<=11263,"Ideographic Description Characters":d=>d>=12272&&d<=12287,"CJK Symbols and Punctuation":d=>d>=12288&&d<=12351,Hiragana:d=>d>=12352&&d<=12447,Katakana:d=>d>=12448&&d<=12543,Kanbun:d=>d>=12688&&d<=12703,"CJK Strokes":d=>d>=12736&&d<=12783,"Enclosed CJK Letters and Months":d=>d>=12800&&d<=13055,"CJK Compatibility":d=>d>=13056&&d<=13311,"Yijing Hexagram Symbols":d=>d>=19904&&d<=19967,"CJK Unified Ideographs":d=>d>=19968&&d<=40959,"Hangul Syllables":d=>d>=44032&&d<=55215,"Private Use Area":d=>d>=57344&&d<=63743,"Vertical Forms":d=>d>=65040&&d<=65055,"CJK Compatibility Forms":d=>d>=65072&&d<=65103,"Small Form Variants":d=>d>=65104&&d<=65135,"Halfwidth and Fullwidth Forms":d=>d>=65280&&d<=65519};function Wd(d){for(let s of d)if(Kd(s.charCodeAt(0)))return!0;return!1}function Hd(d){for(let s of d)if(!$p(s.charCodeAt(0)))return!1;return!0}function Xd(d){let s=d.map(u=>{try{return new RegExp(`\\p{sc=${u}}`,"u").source}catch{return null}}).filter(u=>u);return new RegExp(s.join("|"),"u")}let pf=Xd(["Arab","Dupl","Mong","Ougr","Syrc"]);function $p(d){return!pf.test(String.fromCodePoint(d))}let Qu=Xd(["Bopo","Hani","Hira","Kana","Kits","Nshu","Tang","Yiii"]);function Kd(d){return!(d!==746&&d!==747&&(d<4352||!(ar["CJK Compatibility Forms"](d)&&!(d>=65097&&d<=65103)||ar["CJK Compatibility"](d)||ar["CJK Strokes"](d)||!(!ar["CJK Symbols and Punctuation"](d)||d>=12296&&d<=12305||d>=12308&&d<=12319||d===12336)||ar["Enclosed CJK Letters and Months"](d)||ar["Ideographic Description Characters"](d)||ar.Kanbun(d)||ar.Katakana(d)&&d!==12540||!(!ar["Halfwidth and Fullwidth Forms"](d)||d===65288||d===65289||d===65293||d>=65306&&d<=65310||d===65339||d===65341||d===65343||d>=65371&&d<=65503||d===65507||d>=65512&&d<=65519)||!(!ar["Small Form Variants"](d)||d>=65112&&d<=65118||d>=65123&&d<=65126)||ar["Vertical Forms"](d)||ar["Yijing Hexagram Symbols"](d)||new RegExp("\\p{sc=Cans}","u").test(String.fromCodePoint(d))||new RegExp("\\p{sc=Hang}","u").test(String.fromCodePoint(d))||Qu.test(String.fromCodePoint(d)))))}function ed(d){return!(Kd(d)||function(s){return!!(ar["Latin-1 Supplement"](s)&&(s===167||s===169||s===174||s===177||s===188||s===189||s===190||s===215||s===247)||ar["General Punctuation"](s)&&(s===8214||s===8224||s===8225||s===8240||s===8241||s===8251||s===8252||s===8258||s===8263||s===8264||s===8265||s===8273)||ar["Letterlike Symbols"](s)||ar["Number Forms"](s)||ar["Miscellaneous Technical"](s)&&(s>=8960&&s<=8967||s>=8972&&s<=8991||s>=8996&&s<=9e3||s===9003||s>=9085&&s<=9114||s>=9150&&s<=9165||s===9167||s>=9169&&s<=9179||s>=9186&&s<=9215)||ar["Control Pictures"](s)&&s!==9251||ar["Optical Character Recognition"](s)||ar["Enclosed Alphanumerics"](s)||ar["Geometric Shapes"](s)||ar["Miscellaneous Symbols"](s)&&!(s>=9754&&s<=9759)||ar["Miscellaneous Symbols and Arrows"](s)&&(s>=11026&&s<=11055||s>=11088&&s<=11097||s>=11192&&s<=11243)||ar["CJK Symbols and Punctuation"](s)||ar.Katakana(s)||ar["Private Use Area"](s)||ar["CJK Compatibility Forms"](s)||ar["Small Form Variants"](s)||ar["Halfwidth and Fullwidth Forms"](s)||s===8734||s===8756||s===8757||s>=9984&&s<=10087||s>=10102&&s<=10131||s===65532||s===65533)}(d))}let Uh=Xd(["Adlm","Arab","Armi","Avst","Chrs","Cprt","Egyp","Elym","Gara","Hatr","Hebr","Hung","Khar","Lydi","Mand","Mani","Mend","Merc","Mero","Narb","Nbat","Nkoo","Orkh","Palm","Phli","Phlp","Phnx","Prti","Rohg","Samr","Sarb","Sogo","Syrc","Thaa","Todr","Yezi"]);function td(d){return Uh.test(String.fromCodePoint(d))}function Pm(d,s){return!(!s&&td(d)||d>=2304&&d<=3583||d>=3840&&d<=4255||ar.Khmer(d))}function Yd(d){for(let s of d)if(td(s.charCodeAt(0)))return!0;return!1}let jh=new class{constructor(){this.TIMEOUT=5e3,this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null,this.loadScriptResolve=()=>{}}setState(d){this.pluginStatus=d.pluginStatus,this.pluginURL=d.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(d){if(jh.isParsed())throw new Error("RTL text plugin already registered.");this.applyArabicShaping=d.applyArabicShaping,this.processBidirectionalText=d.processBidirectionalText,this.processStyledBidirectionalText=d.processStyledBidirectionalText,this.loadScriptResolve()}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getRTLTextPluginStatus(){return this.pluginStatus}syncState(d,s){return t(this,void 0,void 0,function*(){if(this.isParsed())return this.getState();if(d.pluginStatus!=="loading")return this.setState(d),d;let u=d.pluginURL,y=new Promise(D=>{this.loadScriptResolve=D});s(u);let T=new Promise(D=>setTimeout(()=>D(),this.TIMEOUT));if(yield Promise.race([y,T]),this.isParsed()){let D={pluginStatus:"loaded",pluginURL:u};return this.setState(D),D}throw this.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${u}`)})}};class jo{constructor(s,u){this.zoom=s,u?(this.now=u.now||0,this.fadeDuration=u.fadeDuration||0,this.zoomHistory=u.zoomHistory||new qp,this.transition=u.transition||{},this.globalState=u.globalState||{}):(this.now=0,this.fadeDuration=0,this.zoomHistory=new qp,this.transition={},this.globalState={})}isSupportedScript(s){return function(u,y){for(let T of u)if(!Pm(T.charCodeAt(0),y))return!1;return!0}(s,jh.getRTLTextPluginStatus()==="loaded")}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){let s=this.zoom,u=s-Math.floor(s),y=this.crossFadingFactor();return s>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:u+(1-u)*y}:{fromScale:.5,toScale:1,t:1-(1-y)*u}}}class Gh{constructor(s,u){this.property=s,this.value=u,this.expression=function(y,T){if(lh(y))return new fu(y,T);if(Ld(y)){let D=ch(y,T);if(D.result==="error")throw new Error(D.value.map(R=>`${R.key}: ${R.message}`).join(", "));return D.value}{let D=y;return T.type==="color"&&typeof y=="string"?D=Pr.parse(y):T.type!=="padding"||typeof y!="number"&&!Array.isArray(y)?T.type!=="numberArray"||typeof y!="number"&&!Array.isArray(y)?T.type!=="colorArray"||typeof y!="string"&&!Array.isArray(y)?T.type==="variableAnchorOffsetCollection"&&Array.isArray(y)?D=Cr.parse(y):T.type==="projectionDefinition"&&typeof y=="string"&&(D=or.parse(y)):D=gs.parse(y):D=Ps.parse(y):D=wn.parse(y),{globalStateRefs:new Set,kind:"constant",evaluate:()=>D}}}(u===void 0?s.specification.default:u,s.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}getGlobalStateRefs(){return this.expression.globalStateRefs||new Set}possiblyEvaluate(s,u,y){return this.property.possiblyEvaluate(this,s,u,y)}}class mh{constructor(s){this.property=s,this.value=new Gh(s,void 0)}transitioned(s,u){return new bu(this.property,this.value,u,Os({},s.transition,this.transition),s.now)}untransitioned(){return new bu(this.property,this.value,null,{},0)}}class _h{constructor(s){this._properties=s,this._values=Object.create(s.defaultTransitionablePropertyValues)}getValue(s){return ra(this._values[s].value.value)}setValue(s,u){Object.prototype.hasOwnProperty.call(this._values,s)||(this._values[s]=new mh(this._values[s].property)),this._values[s].value=new Gh(this._values[s].property,u===null?void 0:ra(u))}getTransition(s){return ra(this._values[s].transition)}setTransition(s,u){Object.prototype.hasOwnProperty.call(this._values,s)||(this._values[s]=new mh(this._values[s].property)),this._values[s].transition=ra(u)||void 0}serialize(){let s={};for(let u of Object.keys(this._values)){let y=this.getValue(u);y!==void 0&&(s[u]=y);let T=this.getTransition(u);T!==void 0&&(s[`${u}-transition`]=T)}return s}transitioned(s,u){let y=new id(this._properties);for(let T of Object.keys(this._values))y._values[T]=this._values[T].transitioned(s,u._values[T]);return y}untransitioned(){let s=new id(this._properties);for(let u of Object.keys(this._values))s._values[u]=this._values[u].untransitioned();return s}}class bu{constructor(s,u,y,T,D){this.property=s,this.value=u,this.begin=D+T.delay||0,this.end=this.begin+T.duration||0,s.specification.transition&&(T.delay||T.duration)&&(this.prior=y)}possiblyEvaluate(s,u,y){let T=s.now||0,D=this.value.possiblyEvaluate(s,u,y),R=this.prior;if(R){if(T>this.end)return this.prior=null,D;if(this.value.isDataDriven())return this.prior=null,D;if(T<this.begin)return R.possiblyEvaluate(s,u,y);{let B=(T-this.begin)/(this.end-this.begin);return this.property.interpolate(R.possiblyEvaluate(s,u,y),D,jr(B))}}return D}}class id{constructor(s){this._properties=s,this._values=Object.create(s.defaultTransitioningPropertyValues)}possiblyEvaluate(s,u,y){let T=new nd(this._properties);for(let D of Object.keys(this._values))T._values[D]=this._values[D].possiblyEvaluate(s,u,y);return T}hasTransition(){for(let s of Object.keys(this._values))if(this._values[s].prior)return!0;return!1}}class Jd{constructor(s){this._properties=s,this._values=Object.create(s.defaultPropertyValues)}hasValue(s){return this._values[s].value!==void 0}getValue(s){return ra(this._values[s].value)}setValue(s,u){this._values[s]=new Gh(this._values[s].property,u===null?void 0:ra(u))}serialize(){let s={};for(let u of Object.keys(this._values)){let y=this.getValue(u);y!==void 0&&(s[u]=y)}return s}possiblyEvaluate(s,u,y){let T=new nd(this._properties);for(let D of Object.keys(this._values))T._values[D]=this._values[D].possiblyEvaluate(s,u,y);return T}}class yl{constructor(s,u,y){this.property=s,this.value=u,this.parameters=y}isConstant(){return this.value.kind==="constant"}constantOr(s){return this.value.kind==="constant"?this.value.value:s}evaluate(s,u,y,T){return this.property.evaluate(this.value,this.parameters,s,u,y,T)}}class nd{constructor(s){this._properties=s,this._values=Object.create(s.defaultPossiblyEvaluatedValues)}get(s){return this._values[s]}}class pn{constructor(s){this.specification=s}possiblyEvaluate(s,u){if(s.isDataDriven())throw new Error("Value should not be data driven");return s.expression.evaluate(u)}interpolate(s,u,y){let T=Xn[this.specification.type];return T?T(s,u,y):s}}class jn{constructor(s,u){this.specification=s,this.overrides=u}possiblyEvaluate(s,u,y,T){return new yl(this,s.expression.kind==="constant"||s.expression.kind==="camera"?{kind:"constant",value:s.expression.evaluate(u,null,{},y,T)}:s.expression,u)}interpolate(s,u,y){if(s.value.kind!=="constant"||u.value.kind!=="constant")return s;if(s.value.value===void 0||u.value.value===void 0)return new yl(this,{kind:"constant",value:void 0},s.parameters);let T=Xn[this.specification.type];if(T){let D=T(s.value.value,u.value.value,y);return new yl(this,{kind:"constant",value:D},s.parameters)}return s}evaluate(s,u,y,T,D,R){return s.kind==="constant"?s.value:s.evaluate(u,y,T,D,R)}}class gh extends jn{possiblyEvaluate(s,u,y,T){if(s.value===void 0)return new yl(this,{kind:"constant",value:void 0},u);if(s.expression.kind==="constant"){let D=s.expression.evaluate(u,null,{},y,T),R=s.property.specification.type==="resolvedImage"&&typeof D!="string"?D.name:D,B=this._calculate(R,R,R,u);return new yl(this,{kind:"constant",value:B},u)}if(s.expression.kind==="camera"){let D=this._calculate(s.expression.evaluate({zoom:u.zoom-1}),s.expression.evaluate({zoom:u.zoom}),s.expression.evaluate({zoom:u.zoom+1}),u);return new yl(this,{kind:"constant",value:D},u)}return new yl(this,s.expression,u)}evaluate(s,u,y,T,D,R){if(s.kind==="source"){let B=s.evaluate(u,y,T,D,R);return this._calculate(B,B,B,u)}return s.kind==="composite"?this._calculate(s.evaluate({zoom:Math.floor(u.zoom)-1},y,T),s.evaluate({zoom:Math.floor(u.zoom)},y,T),s.evaluate({zoom:Math.floor(u.zoom)+1},y,T),u):s.value}_calculate(s,u,y,T){return T.zoom>T.zoomHistory.lastIntegerZoom?{from:s,to:u}:{from:y,to:u}}interpolate(s){return s}}class wu{constructor(s){this.specification=s}possiblyEvaluate(s,u,y,T){if(s.value!==void 0){if(s.expression.kind==="constant"){let D=s.expression.evaluate(u,null,{},y,T);return this._calculate(D,D,D,u)}return this._calculate(s.expression.evaluate(new jo(Math.floor(u.zoom-1),u)),s.expression.evaluate(new jo(Math.floor(u.zoom),u)),s.expression.evaluate(new jo(Math.floor(u.zoom+1),u)),u)}}_calculate(s,u,y,T){return T.zoom>T.zoomHistory.lastIntegerZoom?{from:s,to:u}:{from:y,to:u}}interpolate(s){return s}}class Ei{constructor(s){this.specification=s}possiblyEvaluate(s,u,y,T){return!!s.expression.evaluate(u,null,{},y,T)}interpolate(){return!1}}class Qs{constructor(s){this.properties=s,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(let u in s){let y=s[u];y.specification.overridable&&this.overridableProperties.push(u);let T=this.defaultPropertyValues[u]=new Gh(y,void 0),D=this.defaultTransitionablePropertyValues[u]=new mh(y);this.defaultTransitioningPropertyValues[u]=D.untransitioned(),this.defaultPossiblyEvaluatedValues[u]=T.possiblyEvaluate({})}}}sn("DataDrivenProperty",jn),sn("DataConstantProperty",pn),sn("CrossFadedDataDrivenProperty",gh),sn("CrossFadedProperty",wu),sn("ColorRampProperty",Ei);let Zh="-transition";class ds extends wi{constructor(s,u){if(super(),this.id=s.id,this.type=s.type,this._featureFilter={filter:()=>!0,needGeometry:!1,getGlobalStateRefs:()=>new Set},s.type!=="custom"&&(this.metadata=s.metadata,this.minzoom=s.minzoom,this.maxzoom=s.maxzoom,s.type!=="background"&&(this.source=s.source,this.sourceLayer=s["source-layer"],this.filter=s.filter,this._featureFilter=ac(s.filter)),u.layout&&(this._unevaluatedLayout=new Jd(u.layout)),u.paint)){this._transitionablePaint=new _h(u.paint);for(let y in s.paint)this.setPaintProperty(y,s.paint[y],{validate:!1});for(let y in s.layout)this.setLayoutProperty(y,s.layout[y],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new nd(u.paint)}}setFilter(s){this.filter=s,this._featureFilter=ac(s)}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(s){return s==="visibility"?this.visibility:this._unevaluatedLayout.getValue(s)}getLayoutAffectingGlobalStateRefs(){let s=new Set;if(this._unevaluatedLayout)for(let u in this._unevaluatedLayout._values){let y=this._unevaluatedLayout._values[u];for(let T of y.getGlobalStateRefs())s.add(T)}for(let u of this._featureFilter.getGlobalStateRefs())s.add(u);return s}setLayoutProperty(s,u,y={}){u!=null&&this._validate(df,`layers.${this.id}.layout.${s}`,s,u,y)||(s!=="visibility"?this._unevaluatedLayout.setValue(s,u):this.visibility=u)}getPaintProperty(s){return s.endsWith(Zh)?this._transitionablePaint.getTransition(s.slice(0,-11)):this._transitionablePaint.getValue(s)}setPaintProperty(s,u,y={}){if(u!=null&&this._validate(Mm,`layers.${this.id}.paint.${s}`,s,u,y))return!1;if(s.endsWith(Zh))return this._transitionablePaint.setTransition(s.slice(0,-11),u||void 0),!1;{let T=this._transitionablePaint._values[s],D=T.property.specification["property-type"]==="cross-faded-data-driven",R=T.value.isDataDriven(),B=T.value;this._transitionablePaint.setValue(s,u),this._handleSpecialPaintPropertyUpdate(s);let G=this._transitionablePaint._values[s].value;return G.isDataDriven()||R||D||this._handleOverridablePaintPropertyUpdate(s,B,G)}}_handleSpecialPaintPropertyUpdate(s){}_handleOverridablePaintPropertyUpdate(s,u,y){return!1}isHidden(s){return!!(this.minzoom&&s<this.minzoom)||!!(this.maxzoom&&s>=this.maxzoom)||this.visibility==="none"}updateTransitions(s){this._transitioningPaint=this._transitionablePaint.transitioned(s,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(s,u){s.getCrossfadeParameters&&(this._crossfadeParameters=s.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(s,void 0,u)),this.paint=this._transitioningPaint.possiblyEvaluate(s,void 0,u)}serialize(){let s={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(s.layout=s.layout||{},s.layout.visibility=this.visibility),Cl(s,(u,y)=>!(u===void 0||y==="layout"&&!Object.keys(u).length||y==="paint"&&!Object.keys(u).length))}_validate(s,u,y,T,D={}){return(!D||D.validate!==!1)&&vu(this,s.call(Yu,{key:u,layerType:this.type,objectKey:y,value:T,styleSpec:Ue,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(let s in this.paint._values){let u=this.paint.get(s);if(u instanceof yl&&Oh(u.property.specification)&&(u.value.kind==="source"||u.value.kind==="composite")&&u.value.isStateDependent)return!0}return!1}}let yh={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class tn{constructor(s,u){this._structArray=s,this._pos1=u*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Wo{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(s,u){return s._trim(),u&&(s.isTransferred=!0,u.push(s.arrayBuffer)),{length:s.length,arrayBuffer:s.arrayBuffer}}static deserialize(s){let u=Object.create(this.prototype);return u.arrayBuffer=s.arrayBuffer,u.length=s.length,u.capacity=s.arrayBuffer.byteLength/u.bytesPerElement,u._refreshViews(),u}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(s){this.reserve(s),this.length=s}reserve(s){if(s>this.capacity){this.capacity=Math.max(s,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);let u=this.uint8;this._refreshViews(),u&&this.uint8.set(u)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function ys(d,s=1){let u=0,y=0;return{members:d.map(T=>{let D=yh[T.type].BYTES_PER_ELEMENT,R=u=ff(u,Math.max(s,D)),B=T.components||1;return y=Math.max(y,D),u+=D*B,{name:T.name,type:T.type,components:B,offset:R}}),size:ff(u,Math.max(y,s)),alignment:s}}function ff(d,s){return Math.ceil(d/s)*s}class Ul extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,u){let y=this.length;return this.resize(y+1),this.emplace(y,s,u)}emplace(s,u,y){let T=2*s;return this.int16[T+0]=u,this.int16[T+1]=y,s}}Ul.prototype.bytesPerElement=4,sn("StructArrayLayout2i4",Ul);class xh extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,u,y){let T=this.length;return this.resize(T+1),this.emplace(T,s,u,y)}emplace(s,u,y,T){let D=3*s;return this.int16[D+0]=u,this.int16[D+1]=y,this.int16[D+2]=T,s}}xh.prototype.bytesPerElement=6,sn("StructArrayLayout3i6",xh);class mf extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,u,y,T){let D=this.length;return this.resize(D+1),this.emplace(D,s,u,y,T)}emplace(s,u,y,T,D){let R=4*s;return this.int16[R+0]=u,this.int16[R+1]=y,this.int16[R+2]=T,this.int16[R+3]=D,s}}mf.prototype.bytesPerElement=8,sn("StructArrayLayout4i8",mf);class Qd extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,u,y,T,D,R){let B=this.length;return this.resize(B+1),this.emplace(B,s,u,y,T,D,R)}emplace(s,u,y,T,D,R,B){let G=6*s;return this.int16[G+0]=u,this.int16[G+1]=y,this.int16[G+2]=T,this.int16[G+3]=D,this.int16[G+4]=R,this.int16[G+5]=B,s}}Qd.prototype.bytesPerElement=12,sn("StructArrayLayout2i4i12",Qd);class Tu extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,u,y,T,D,R){let B=this.length;return this.resize(B+1),this.emplace(B,s,u,y,T,D,R)}emplace(s,u,y,T,D,R,B){let G=4*s,K=8*s;return this.int16[G+0]=u,this.int16[G+1]=y,this.uint8[K+4]=T,this.uint8[K+5]=D,this.uint8[K+6]=R,this.uint8[K+7]=B,s}}Tu.prototype.bytesPerElement=8,sn("StructArrayLayout2i4ub8",Tu);class ep extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,u){let y=this.length;return this.resize(y+1),this.emplace(y,s,u)}emplace(s,u,y){let T=2*s;return this.float32[T+0]=u,this.float32[T+1]=y,s}}ep.prototype.bytesPerElement=8,sn("StructArrayLayout2f8",ep);class tp extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,u,y,T,D,R,B,G,K,Q){let ce=this.length;return this.resize(ce+1),this.emplace(ce,s,u,y,T,D,R,B,G,K,Q)}emplace(s,u,y,T,D,R,B,G,K,Q,ce){let _e=10*s;return this.uint16[_e+0]=u,this.uint16[_e+1]=y,this.uint16[_e+2]=T,this.uint16[_e+3]=D,this.uint16[_e+4]=R,this.uint16[_e+5]=B,this.uint16[_e+6]=G,this.uint16[_e+7]=K,this.uint16[_e+8]=Q,this.uint16[_e+9]=ce,s}}tp.prototype.bytesPerElement=20,sn("StructArrayLayout10ui20",tp);class rd extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,u,y,T,D,R,B,G,K,Q,ce,_e){let ve=this.length;return this.resize(ve+1),this.emplace(ve,s,u,y,T,D,R,B,G,K,Q,ce,_e)}emplace(s,u,y,T,D,R,B,G,K,Q,ce,_e,ve){let Te=12*s;return this.int16[Te+0]=u,this.int16[Te+1]=y,this.int16[Te+2]=T,this.int16[Te+3]=D,this.uint16[Te+4]=R,this.uint16[Te+5]=B,this.uint16[Te+6]=G,this.uint16[Te+7]=K,this.int16[Te+8]=Q,this.int16[Te+9]=ce,this.int16[Te+10]=_e,this.int16[Te+11]=ve,s}}rd.prototype.bytesPerElement=24,sn("StructArrayLayout4i4ui4i24",rd);class ip extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,u,y){let T=this.length;return this.resize(T+1),this.emplace(T,s,u,y)}emplace(s,u,y,T){let D=3*s;return this.float32[D+0]=u,this.float32[D+1]=y,this.float32[D+2]=T,s}}ip.prototype.bytesPerElement=12,sn("StructArrayLayout3f12",ip);class M extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(s){let u=this.length;return this.resize(u+1),this.emplace(u,s)}emplace(s,u){return this.uint32[1*s+0]=u,s}}M.prototype.bytesPerElement=4,sn("StructArrayLayout1ul4",M);class r extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,u,y,T,D,R,B,G,K){let Q=this.length;return this.resize(Q+1),this.emplace(Q,s,u,y,T,D,R,B,G,K)}emplace(s,u,y,T,D,R,B,G,K,Q){let ce=10*s,_e=5*s;return this.int16[ce+0]=u,this.int16[ce+1]=y,this.int16[ce+2]=T,this.int16[ce+3]=D,this.int16[ce+4]=R,this.int16[ce+5]=B,this.uint32[_e+3]=G,this.uint16[ce+8]=K,this.uint16[ce+9]=Q,s}}r.prototype.bytesPerElement=20,sn("StructArrayLayout6i1ul2ui20",r);class h extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,u,y,T,D,R){let B=this.length;return this.resize(B+1),this.emplace(B,s,u,y,T,D,R)}emplace(s,u,y,T,D,R,B){let G=6*s;return this.int16[G+0]=u,this.int16[G+1]=y,this.int16[G+2]=T,this.int16[G+3]=D,this.int16[G+4]=R,this.int16[G+5]=B,s}}h.prototype.bytesPerElement=12,sn("StructArrayLayout2i2i2i12",h);class x extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,u,y,T,D){let R=this.length;return this.resize(R+1),this.emplace(R,s,u,y,T,D)}emplace(s,u,y,T,D,R){let B=4*s,G=8*s;return this.float32[B+0]=u,this.float32[B+1]=y,this.float32[B+2]=T,this.int16[G+6]=D,this.int16[G+7]=R,s}}x.prototype.bytesPerElement=16,sn("StructArrayLayout2f1f2i16",x);class w extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,u,y,T,D,R){let B=this.length;return this.resize(B+1),this.emplace(B,s,u,y,T,D,R)}emplace(s,u,y,T,D,R,B){let G=16*s,K=4*s,Q=8*s;return this.uint8[G+0]=u,this.uint8[G+1]=y,this.float32[K+1]=T,this.float32[K+2]=D,this.int16[Q+6]=R,this.int16[Q+7]=B,s}}w.prototype.bytesPerElement=16,sn("StructArrayLayout2ub2f2i16",w);class A extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,u,y){let T=this.length;return this.resize(T+1),this.emplace(T,s,u,y)}emplace(s,u,y,T){let D=3*s;return this.uint16[D+0]=u,this.uint16[D+1]=y,this.uint16[D+2]=T,s}}A.prototype.bytesPerElement=6,sn("StructArrayLayout3ui6",A);class k extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,u,y,T,D,R,B,G,K,Q,ce,_e,ve,Te,De,Ye,lt){let Mt=this.length;return this.resize(Mt+1),this.emplace(Mt,s,u,y,T,D,R,B,G,K,Q,ce,_e,ve,Te,De,Ye,lt)}emplace(s,u,y,T,D,R,B,G,K,Q,ce,_e,ve,Te,De,Ye,lt,Mt){let yt=24*s,ye=12*s,Ze=48*s;return this.int16[yt+0]=u,this.int16[yt+1]=y,this.uint16[yt+2]=T,this.uint16[yt+3]=D,this.uint32[ye+2]=R,this.uint32[ye+3]=B,this.uint32[ye+4]=G,this.uint16[yt+10]=K,this.uint16[yt+11]=Q,this.uint16[yt+12]=ce,this.float32[ye+7]=_e,this.float32[ye+8]=ve,this.uint8[Ze+36]=Te,this.uint8[Ze+37]=De,this.uint8[Ze+38]=Ye,this.uint32[ye+10]=lt,this.int16[yt+22]=Mt,s}}k.prototype.bytesPerElement=48,sn("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",k);class j extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,u,y,T,D,R,B,G,K,Q,ce,_e,ve,Te,De,Ye,lt,Mt,yt,ye,Ze,bt,ni,Ai,ci,gi,Fi,Mi){let Zi=this.length;return this.resize(Zi+1),this.emplace(Zi,s,u,y,T,D,R,B,G,K,Q,ce,_e,ve,Te,De,Ye,lt,Mt,yt,ye,Ze,bt,ni,Ai,ci,gi,Fi,Mi)}emplace(s,u,y,T,D,R,B,G,K,Q,ce,_e,ve,Te,De,Ye,lt,Mt,yt,ye,Ze,bt,ni,Ai,ci,gi,Fi,Mi,Zi){let bi=32*s,fn=16*s;return this.int16[bi+0]=u,this.int16[bi+1]=y,this.int16[bi+2]=T,this.int16[bi+3]=D,this.int16[bi+4]=R,this.int16[bi+5]=B,this.int16[bi+6]=G,this.int16[bi+7]=K,this.uint16[bi+8]=Q,this.uint16[bi+9]=ce,this.uint16[bi+10]=_e,this.uint16[bi+11]=ve,this.uint16[bi+12]=Te,this.uint16[bi+13]=De,this.uint16[bi+14]=Ye,this.uint16[bi+15]=lt,this.uint16[bi+16]=Mt,this.uint16[bi+17]=yt,this.uint16[bi+18]=ye,this.uint16[bi+19]=Ze,this.uint16[bi+20]=bt,this.uint16[bi+21]=ni,this.uint16[bi+22]=Ai,this.uint32[fn+12]=ci,this.float32[fn+13]=gi,this.float32[fn+14]=Fi,this.uint16[bi+30]=Mi,this.uint16[bi+31]=Zi,s}}j.prototype.bytesPerElement=64,sn("StructArrayLayout8i15ui1ul2f2ui64",j);class q extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s){let u=this.length;return this.resize(u+1),this.emplace(u,s)}emplace(s,u){return this.float32[1*s+0]=u,s}}q.prototype.bytesPerElement=4,sn("StructArrayLayout1f4",q);class J extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,u,y){let T=this.length;return this.resize(T+1),this.emplace(T,s,u,y)}emplace(s,u,y,T){let D=3*s;return this.uint16[6*s+0]=u,this.float32[D+1]=y,this.float32[D+2]=T,s}}J.prototype.bytesPerElement=12,sn("StructArrayLayout1ui2f12",J);class ne extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,u,y){let T=this.length;return this.resize(T+1),this.emplace(T,s,u,y)}emplace(s,u,y,T){let D=4*s;return this.uint32[2*s+0]=u,this.uint16[D+2]=y,this.uint16[D+3]=T,s}}ne.prototype.bytesPerElement=8,sn("StructArrayLayout1ul2ui8",ne);class pe extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,u){let y=this.length;return this.resize(y+1),this.emplace(y,s,u)}emplace(s,u,y){let T=2*s;return this.uint16[T+0]=u,this.uint16[T+1]=y,s}}pe.prototype.bytesPerElement=4,sn("StructArrayLayout2ui4",pe);class ue extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s){let u=this.length;return this.resize(u+1),this.emplace(u,s)}emplace(s,u){return this.uint16[1*s+0]=u,s}}ue.prototype.bytesPerElement=2,sn("StructArrayLayout1ui2",ue);class ge extends Wo{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,u,y,T){let D=this.length;return this.resize(D+1),this.emplace(D,s,u,y,T)}emplace(s,u,y,T,D){let R=4*s;return this.float32[R+0]=u,this.float32[R+1]=y,this.float32[R+2]=T,this.float32[R+3]=D,s}}ge.prototype.bytesPerElement=16,sn("StructArrayLayout4f16",ge);class Ee extends tn{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new Wi(this.anchorPointX,this.anchorPointY)}}Ee.prototype.size=20;class tt extends r{get(s){return new Ee(this,s)}}sn("CollisionBoxArray",tt);class Xe extends tn{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(s){this._structArray.uint8[this._pos1+37]=s}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(s){this._structArray.uint8[this._pos1+38]=s}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(s){this._structArray.uint32[this._pos4+10]=s}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}Xe.prototype.size=48;class et extends k{get(s){return new Xe(this,s)}}sn("PlacedSymbolArray",et);class Se extends tn{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(s){this._structArray.uint32[this._pos4+12]=s}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}Se.prototype.size=64;class Be extends j{get(s){return new Se(this,s)}}sn("SymbolInstanceArray",Be);class ft extends q{getoffsetX(s){return this.float32[1*s+0]}}sn("GlyphOffsetArray",ft);class dt extends xh{getx(s){return this.int16[3*s+0]}gety(s){return this.int16[3*s+1]}gettileUnitDistanceFromAnchor(s){return this.int16[3*s+2]}}sn("SymbolLineVertexArray",dt);class xe extends tn{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}xe.prototype.size=12;class pt extends J{get(s){return new xe(this,s)}}sn("TextAnchorOffsetArray",pt);class zt extends tn{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}zt.prototype.size=8;class ei extends ne{get(s){return new zt(this,s)}}sn("FeatureIndexArray",ei);class Kt extends Ul{}class Jt extends Ul{}class si extends Ul{}class Xi extends Qd{}class Ki extends Tu{}class Pi extends ep{}class yn extends tp{}class xr extends rd{}class Kr extends ip{}class Ho extends M{}class Eo extends h{}class Go extends w{}class vo extends A{}class Yr extends pe{}let Mo=ys([{name:"a_pos",components:2,type:"Int16"}],4),{members:ps}=Mo;class lr{constructor(s=[]){this._forceNewSegmentOnNextPrepare=!1,this.segments=s}prepareSegment(s,u,y,T){let D=this.segments[this.segments.length-1];return s>lr.MAX_VERTEX_ARRAY_LENGTH&&Jo(`Max vertices per segment is ${lr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${s}. Consider using the \`fillLargeMeshArrays\` function if you require meshes with more than ${lr.MAX_VERTEX_ARRAY_LENGTH} vertices.`),this._forceNewSegmentOnNextPrepare||!D||D.vertexLength+s>lr.MAX_VERTEX_ARRAY_LENGTH||D.sortKey!==T?this.createNewSegment(u,y,T):D}createNewSegment(s,u,y){let T={vertexOffset:s.length,primitiveOffset:u.length,vertexLength:0,primitiveLength:0,vaos:{}};return y!==void 0&&(T.sortKey=y),this._forceNewSegmentOnNextPrepare=!1,this.segments.push(T),T}getOrCreateLatestSegment(s,u,y){return this.prepareSegment(0,s,u,y)}forceNewSegmentOnNextPrepare(){this._forceNewSegmentOnNextPrepare=!0}get(){return this.segments}destroy(){for(let s of this.segments)for(let u in s.vaos)s.vaos[u].destroy()}static simpleSegment(s,u,y,T){return new lr([{vertexOffset:s,primitiveOffset:u,vertexLength:y,primitiveLength:T,vaos:{},sortKey:0}])}}function aa(d,s){return 256*(d=gr(Math.floor(d),0,255))+gr(Math.floor(s),0,255)}lr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,sn("SegmentVector",lr);let Rs=ys([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var Rr,Kn,Ac,la={exports:{}},qh={exports:{}},uc={exports:{}},dc=function(){if(Ac)return la.exports;Ac=1;var d=(Rr||(Rr=1,qh.exports=function(u,y){var T,D,R,B,G,K,Q,ce;for(D=u.length-(T=3&u.length),R=y,G=3432918353,K=461845907,ce=0;ce<D;)Q=255&u.charCodeAt(ce)|(255&u.charCodeAt(++ce))<<8|(255&u.charCodeAt(++ce))<<16|(255&u.charCodeAt(++ce))<<24,++ce,R=27492+(65535&(B=5*(65535&(R=(R^=Q=(65535&(Q=(Q=(65535&Q)*G+(((Q>>>16)*G&65535)<<16)&4294967295)<<15|Q>>>17))*K+(((Q>>>16)*K&65535)<<16)&4294967295)<<13|R>>>19))+((5*(R>>>16)&65535)<<16)&4294967295))+((58964+(B>>>16)&65535)<<16);switch(Q=0,T){case 3:Q^=(255&u.charCodeAt(ce+2))<<16;case 2:Q^=(255&u.charCodeAt(ce+1))<<8;case 1:R^=Q=(65535&(Q=(Q=(65535&(Q^=255&u.charCodeAt(ce)))*G+(((Q>>>16)*G&65535)<<16)&4294967295)<<15|Q>>>17))*K+(((Q>>>16)*K&65535)<<16)&4294967295}return R^=u.length,R=2246822507*(65535&(R^=R>>>16))+((2246822507*(R>>>16)&65535)<<16)&4294967295,R=3266489909*(65535&(R^=R>>>13))+((3266489909*(R>>>16)&65535)<<16)&4294967295,(R^=R>>>16)>>>0}),qh.exports),s=(Kn||(Kn=1,uc.exports=function(u,y){for(var T,D=u.length,R=y^D,B=0;D>=4;)T=1540483477*(65535&(T=255&u.charCodeAt(B)|(255&u.charCodeAt(++B))<<8|(255&u.charCodeAt(++B))<<16|(255&u.charCodeAt(++B))<<24))+((1540483477*(T>>>16)&65535)<<16),R=1540483477*(65535&R)+((1540483477*(R>>>16)&65535)<<16)^(T=1540483477*(65535&(T^=T>>>24))+((1540483477*(T>>>16)&65535)<<16)),D-=4,++B;switch(D){case 3:R^=(255&u.charCodeAt(B+2))<<16;case 2:R^=(255&u.charCodeAt(B+1))<<8;case 1:R=1540483477*(65535&(R^=255&u.charCodeAt(B)))+((1540483477*(R>>>16)&65535)<<16)}return R=1540483477*(65535&(R^=R>>>13))+((1540483477*(R>>>16)&65535)<<16),(R^=R>>>15)>>>0}),uc.exports);return la.exports=d,la.exports.murmur3=d,la.exports.murmur2=s,la.exports}(),Ca=at(dc);class Fa{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(s,u,y,T){this.ids.push(Dc(s)),this.positions.push(u,y,T)}getPositions(s){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");let u=Dc(s),y=0,T=this.ids.length-1;for(;y<T;){let R=y+T>>1;this.ids[R]>=u?T=R:y=R+1}let D=[];for(;this.ids[y]===u;)D.push({index:this.positions[3*y],start:this.positions[3*y+1],end:this.positions[3*y+2]}),y++;return D}static serialize(s,u){let y=new Float64Array(s.ids),T=new Uint32Array(s.positions);return vh(y,T,0,y.length-1),u&&u.push(y.buffer,T.buffer),{ids:y,positions:T}}static deserialize(s){let u=new Fa;return u.ids=s.ids,u.positions=s.positions,u.indexed=!0,u}}function Dc(d){let s=+d;return!isNaN(s)&&s<=Number.MAX_SAFE_INTEGER?s:Ca(String(d))}function vh(d,s,u,y){for(;u<y;){let T=d[u+y>>1],D=u-1,R=y+1;for(;;){do D++;while(d[D]<T);do R--;while(d[R]>T);if(D>=R)break;So(d,D,R),So(s,3*D,3*R),So(s,3*D+1,3*R+1),So(s,3*D+2,3*R+2)}R-u<y-R?(vh(d,s,u,R),u=R+1):(vh(d,s,R+1,y),y=R)}}function So(d,s,u){let y=d[s];d[s]=d[u],d[u]=y}sn("FeaturePositionMap",Fa);class io{constructor(s,u){this.gl=s.gl,this.location=u}}class ca extends io{constructor(s,u){super(s,u),this.current=0}set(s){this.current!==s&&(this.current=s,this.gl.uniform1f(this.location,s))}}class ts extends io{constructor(s,u){super(s,u),this.current=[0,0,0,0]}set(s){s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]&&s[3]===this.current[3]||(this.current=s,this.gl.uniform4f(this.location,s[0],s[1],s[2],s[3]))}}class Su extends io{constructor(s,u){super(s,u),this.current=Pr.transparent}set(s){s.r===this.current.r&&s.g===this.current.g&&s.b===this.current.b&&s.a===this.current.a||(this.current=s,this.gl.uniform4f(this.location,s.r,s.g,s.b,s.a))}}let el=new Float32Array(16);function jl(d){return[aa(255*d.r,255*d.g),aa(255*d.b,255*d.a)]}class Iu{constructor(s,u,y){this.value=s,this.uniformNames=u.map(T=>`u_${T}`),this.type=y}setUniform(s,u,y){s.set(y.constantOr(this.value))}getBinding(s,u,y){return this.type==="color"?new Su(s,u):new ca(s,u)}}class xl{constructor(s,u){this.uniformNames=u.map(y=>`u_${y}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(s,u){this.pixelRatioFrom=u.pixelRatio,this.pixelRatioTo=s.pixelRatio,this.patternFrom=u.tlbr,this.patternTo=s.tlbr}setUniform(s,u,y,T){let D=T==="u_pattern_to"?this.patternTo:T==="u_pattern_from"?this.patternFrom:T==="u_pixel_ratio_to"?this.pixelRatioTo:T==="u_pixel_ratio_from"?this.pixelRatioFrom:null;D&&s.set(D)}getBinding(s,u,y){return y.substr(0,9)==="u_pattern"?new ts(s,u):new ca(s,u)}}class pc{constructor(s,u,y,T){this.expression=s,this.type=y,this.maxValue=0,this.paintVertexAttributes=u.map(D=>({name:`a_${D}`,type:"Float32",components:y==="color"?2:1,offset:0})),this.paintVertexArray=new T}populatePaintArray(s,u,y,T,D){let R=this.paintVertexArray.length,B=this.expression.evaluate(new jo(0),u,{},T,[],D);this.paintVertexArray.resize(s),this._setPaintValue(R,s,B)}updatePaintArray(s,u,y,T){let D=this.expression.evaluate({zoom:0},y,T);this._setPaintValue(s,u,D)}_setPaintValue(s,u,y){if(this.type==="color"){let T=jl(y);for(let D=s;D<u;D++)this.paintVertexArray.emplace(D,T[0],T[1])}else{for(let T=s;T<u;T++)this.paintVertexArray.emplace(T,y);this.maxValue=Math.max(this.maxValue,Math.abs(y))}}upload(s){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=s.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Us{constructor(s,u,y,T,D,R){this.expression=s,this.uniformNames=u.map(B=>`u_${B}_t`),this.type=y,this.useIntegerZoom=T,this.zoom=D,this.maxValue=0,this.paintVertexAttributes=u.map(B=>({name:`a_${B}`,type:"Float32",components:y==="color"?4:2,offset:0})),this.paintVertexArray=new R}populatePaintArray(s,u,y,T,D){let R=this.expression.evaluate(new jo(this.zoom),u,{},T,[],D),B=this.expression.evaluate(new jo(this.zoom+1),u,{},T,[],D),G=this.paintVertexArray.length;this.paintVertexArray.resize(s),this._setPaintValue(G,s,R,B)}updatePaintArray(s,u,y,T){let D=this.expression.evaluate({zoom:this.zoom},y,T),R=this.expression.evaluate({zoom:this.zoom+1},y,T);this._setPaintValue(s,u,D,R)}_setPaintValue(s,u,y,T){if(this.type==="color"){let D=jl(y),R=jl(T);for(let B=s;B<u;B++)this.paintVertexArray.emplace(B,D[0],D[1],R[0],R[1])}else{for(let D=s;D<u;D++)this.paintVertexArray.emplace(D,y,T);this.maxValue=Math.max(this.maxValue,Math.abs(y),Math.abs(T))}}upload(s){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=s.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(s,u){let y=this.useIntegerZoom?Math.floor(u.zoom):u.zoom,T=gr(this.expression.interpolationFactor(y,this.zoom,this.zoom+1),0,1);s.set(T)}getBinding(s,u,y){return new ca(s,u)}}class vl{constructor(s,u,y,T,D,R){this.expression=s,this.type=u,this.useIntegerZoom=y,this.zoom=T,this.layerId=R,this.zoomInPaintVertexArray=new D,this.zoomOutPaintVertexArray=new D}populatePaintArray(s,u,y){let T=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(s),this.zoomOutPaintVertexArray.resize(s),this._setPaintValues(T,s,u.patterns&&u.patterns[this.layerId],y)}updatePaintArray(s,u,y,T,D){this._setPaintValues(s,u,y.patterns&&y.patterns[this.layerId],D)}_setPaintValues(s,u,y,T){if(!T||!y)return;let{min:D,mid:R,max:B}=y,G=T[D],K=T[R],Q=T[B];if(G&&K&&Q)for(let ce=s;ce<u;ce++)this.zoomInPaintVertexArray.emplace(ce,K.tl[0],K.tl[1],K.br[0],K.br[1],G.tl[0],G.tl[1],G.br[0],G.br[1],K.pixelRatio,G.pixelRatio),this.zoomOutPaintVertexArray.emplace(ce,K.tl[0],K.tl[1],K.br[0],K.br[1],Q.tl[0],Q.tl[1],Q.br[0],Q.br[1],K.pixelRatio,Q.pixelRatio)}upload(s){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=s.createVertexBuffer(this.zoomInPaintVertexArray,Rs.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=s.createVertexBuffer(this.zoomOutPaintVertexArray,Rs.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class np{constructor(s,u,y){this.binders={},this._buffers=[];let T=[];for(let D in s.paint._values){if(!y(D))continue;let R=s.paint.get(D);if(!(R instanceof yl&&Oh(R.property.specification)))continue;let B=rp(D,s.type),G=R.value,K=R.property.specification.type,Q=R.property.useIntegerZoom,ce=R.property.specification["property-type"],_e=ce==="cross-faded"||ce==="cross-faded-data-driven";if(G.kind==="constant")this.binders[D]=_e?new xl(G.value,B):new Iu(G.value,B,K),T.push(`/u_${D}`);else if(G.kind==="source"||_e){let ve=op(D,K,"source");this.binders[D]=_e?new vl(G,K,Q,u,ve,s.id):new pc(G,B,K,ve),T.push(`/a_${D}`)}else{let ve=op(D,K,"composite");this.binders[D]=new Us(G,B,K,Q,u,ve),T.push(`/z_${D}`)}}this.cacheKey=T.sort().join("")}getMaxValue(s){let u=this.binders[s];return u instanceof pc||u instanceof Us?u.maxValue:0}populatePaintArrays(s,u,y,T,D){for(let R in this.binders){let B=this.binders[R];(B instanceof pc||B instanceof Us||B instanceof vl)&&B.populatePaintArray(s,u,y,T,D)}}setConstantPatternPositions(s,u){for(let y in this.binders){let T=this.binders[y];T instanceof xl&&T.setConstantPatternPositions(s,u)}}updatePaintArrays(s,u,y,T,D){let R=!1;for(let B in s){let G=u.getPositions(B);for(let K of G){let Q=y.feature(K.index);for(let ce in this.binders){let _e=this.binders[ce];if((_e instanceof pc||_e instanceof Us||_e instanceof vl)&&_e.expression.isStateDependent===!0){let ve=T.paint.get(ce);_e.expression=ve.value,_e.updatePaintArray(K.start,K.end,Q,s[B],D),R=!0}}}}return R}defines(){let s=[];for(let u in this.binders){let y=this.binders[u];(y instanceof Iu||y instanceof xl)&&s.push(...y.uniformNames.map(T=>`#define HAS_UNIFORM_${T}`))}return s}getBinderAttributes(){let s=[];for(let u in this.binders){let y=this.binders[u];if(y instanceof pc||y instanceof Us)for(let T=0;T<y.paintVertexAttributes.length;T++)s.push(y.paintVertexAttributes[T].name);else if(y instanceof vl)for(let T=0;T<Rs.members.length;T++)s.push(Rs.members[T].name)}return s}getBinderUniforms(){let s=[];for(let u in this.binders){let y=this.binders[u];if(y instanceof Iu||y instanceof xl||y instanceof Us)for(let T of y.uniformNames)s.push(T)}return s}getPaintVertexBuffers(){return this._buffers}getUniforms(s,u){let y=[];for(let T in this.binders){let D=this.binders[T];if(D instanceof Iu||D instanceof xl||D instanceof Us){for(let R of D.uniformNames)if(u[R]){let B=D.getBinding(s,u[R],R);y.push({name:R,property:T,binding:B})}}}return y}setUniforms(s,u,y,T){for(let{name:D,property:R,binding:B}of u)this.binders[R].setUniform(B,T,y.get(R),D)}updatePaintBuffers(s){this._buffers=[];for(let u in this.binders){let y=this.binders[u];if(s&&y instanceof vl){let T=s.fromScale===2?y.zoomInPaintVertexBuffer:y.zoomOutPaintVertexBuffer;T&&this._buffers.push(T)}else(y instanceof pc||y instanceof Us)&&y.paintVertexBuffer&&this._buffers.push(y.paintVertexBuffer)}}upload(s){for(let u in this.binders){let y=this.binders[u];(y instanceof pc||y instanceof Us||y instanceof vl)&&y.upload(s)}this.updatePaintBuffers()}destroy(){for(let s in this.binders){let u=this.binders[s];(u instanceof pc||u instanceof Us||u instanceof vl)&&u.destroy()}}}class zo{constructor(s,u,y=()=>!0){this.programConfigurations={};for(let T of s)this.programConfigurations[T.id]=new np(T,u,y);this.needsUpload=!1,this._featureMap=new Fa,this._bufferOffset=0}populatePaintArrays(s,u,y,T,D,R){for(let B in this.programConfigurations)this.programConfigurations[B].populatePaintArrays(s,u,T,D,R);u.id!==void 0&&this._featureMap.add(u.id,y,this._bufferOffset,s),this._bufferOffset=s,this.needsUpload=!0}updatePaintArrays(s,u,y,T){for(let D of y)this.needsUpload=this.programConfigurations[D.id].updatePaintArrays(s,this._featureMap,u,D,T)||this.needsUpload}get(s){return this.programConfigurations[s]}upload(s){if(this.needsUpload){for(let u in this.programConfigurations)this.programConfigurations[u].upload(s);this.needsUpload=!1}}destroy(){for(let s in this.programConfigurations)this.programConfigurations[s].destroy()}}function rp(d,s){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[d]||[d.replace(`${s}-`,"").replace(/-/g,"_")]}function op(d,s,u){let y={color:{source:ep,composite:ge},number:{source:q,composite:ep}},T=function(D){return{"line-pattern":{source:yn,composite:yn},"fill-pattern":{source:yn,composite:yn},"fill-extrusion-pattern":{source:yn,composite:yn}}[D]}(d);return T&&T[u]||y[s][u]}sn("ConstantBinder",Iu),sn("CrossFadedConstantBinder",xl),sn("SourceExpressionBinder",pc),sn("CrossFadedCompositeBinder",vl),sn("CompositeExpressionBinder",Us),sn("ProgramConfiguration",np,{omit:["_buffers"]}),sn("ProgramConfigurationSet",zo);let Gl=Math.pow(2,14)-1,Wp=-Gl-1;function Cu(d){let s=Hr/d.extent,u=d.loadGeometry();for(let y=0;y<u.length;y++){let T=u[y];for(let D=0;D<T.length;D++){let R=T[D],B=Math.round(R.x*s),G=Math.round(R.y*s);R.x=gr(B,Wp,Gl),R.y=gr(G,Wp,Gl),(B<R.x||B>R.x+1||G<R.y||G>R.y+1)&&Jo("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return u}function $h(d,s){return{type:d.type,id:d.id,properties:d.properties,geometry:s?Cu(d):[]}}let od=-32768;function Am(d,s,u,y,T){d.emplaceBack(od+8*s+y,od+8*u+T)}class sp{constructor(s){this.zoom=s.zoom,this.globalState=s.globalState,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map(u=>u.id),this.index=s.index,this.hasPattern=!1,this.layoutVertexArray=new Jt,this.indexArray=new vo,this.segments=new lr,this.programConfigurations=new zo(s.layers,s.zoom),this.stateDependentLayerIds=this.layers.filter(u=>u.isStateDependent()).map(u=>u.id)}populate(s,u,y){let T=this.layers[0],D=[],R=null,B=!1,G=T.type==="heatmap";if(T.type==="circle"){let Q=T;R=Q.layout.get("circle-sort-key"),B=!R.isConstant(),G=G||Q.paint.get("circle-pitch-alignment")==="map"}let K=G?u.subdivisionGranularity.circle:1;for(let{feature:Q,id:ce,index:_e,sourceLayerIndex:ve}of s){let Te=this.layers[0]._featureFilter.needGeometry,De=$h(Q,Te);if(!this.layers[0]._featureFilter.filter(new jo(this.zoom,{globalState:this.globalState}),De,y))continue;let Ye=B?R.evaluate(De,{},y):void 0,lt={id:ce,properties:Q.properties,type:Q.type,sourceLayerIndex:ve,index:_e,geometry:Te?De.geometry:Cu(Q),patterns:{},sortKey:Ye};D.push(lt)}B&&D.sort((Q,ce)=>Q.sortKey-ce.sortKey);for(let Q of D){let{geometry:ce,index:_e,sourceLayerIndex:ve}=Q,Te=s[_e].feature;this.addFeature(Q,ce,_e,y,K),u.featureIndex.insert(Te,ce,_e,ve,this.index)}}update(s,u,y){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(s,u,this.stateDependentLayers,y)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(s){this.uploaded||(this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,ps),this.indexBuffer=s.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(s),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(s,u,y,T,D=1){let R;switch(D){case 1:R=[0,7];break;case 3:R=[0,2,5,7];break;case 5:R=[0,1,3,4,6,7];break;case 7:R=[0,1,2,3,4,5,6,7];break;default:throw new Error(`Invalid circle bucket granularity: ${D}; valid values are 1, 3, 5, 7.`)}let B=R.length;for(let G of u)for(let K of G){let Q=K.x,ce=K.y;if(Q<0||Q>=Hr||ce<0||ce>=Hr)continue;let _e=this.segments.prepareSegment(B*B,this.layoutVertexArray,this.indexArray,s.sortKey),ve=_e.vertexLength;for(let Te=0;Te<B;Te++)for(let De=0;De<B;De++)Am(this.layoutVertexArray,Q,ce,R[De],R[Te]);for(let Te=0;Te<B-1;Te++)for(let De=0;De<B-1;De++){let Ye=ve+Te*B+De,lt=ve+(Te+1)*B+De;this.indexArray.emplaceBack(Ye,lt+1,Ye+1),this.indexArray.emplaceBack(Ye,lt,lt+1)}_e.vertexLength+=B*B,_e.primitiveLength+=(B-1)*(B-1)*2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,s,y,{},T)}}function ap(d,s){for(let u=0;u<d.length;u++)if(lp(s,d[u]))return!0;for(let u=0;u<s.length;u++)if(lp(d,s[u]))return!0;return!!$f(d,s)}function _f(d,s,u){return!!lp(d,s)||!!Hf(s,d,u)}function Zf(d,s){if(d.length===1)return Rm(s,d[0]);for(let u=0;u<s.length;u++){let y=s[u];for(let T=0;T<y.length;T++)if(lp(d,y[T]))return!0}for(let u=0;u<d.length;u++)if(Rm(s,d[u]))return!0;for(let u=0;u<s.length;u++)if($f(d,s[u]))return!0;return!1}function qf(d,s,u){if(d.length>1){if($f(d,s))return!0;for(let y=0;y<s.length;y++)if(Hf(s[y],d,u))return!0}for(let y=0;y<d.length;y++)if(Hf(d[y],s,u))return!0;return!1}function $f(d,s){if(d.length===0||s.length===0)return!1;for(let u=0;u<d.length-1;u++){let y=d[u],T=d[u+1];for(let D=0;D<s.length-1;D++)if(Wf(y,T,s[D],s[D+1]))return!0}return!1}function Wf(d,s,u,y){return Fs(d,u,y)!==Fs(s,u,y)&&Fs(d,s,u)!==Fs(d,s,y)}function Hf(d,s,u){let y=u*u;if(s.length===1)return d.distSqr(s[0])<y;for(let T=1;T<s.length;T++)if(Dm(d,s[T-1],s[T])<y)return!0;return!1}function Dm(d,s,u){let y=s.distSqr(u);if(y===0)return d.distSqr(s);let T=((d.x-s.x)*(u.x-s.x)+(d.y-s.y)*(u.y-s.y))/y;return d.distSqr(T<0?s:T>1?u:u.sub(s)._mult(T)._add(s))}function Rm(d,s){let u,y,T,D=!1;for(let R=0;R<d.length;R++){u=d[R];for(let B=0,G=u.length-1;B<u.length;G=B++)y=u[B],T=u[G],y.y>s.y!=T.y>s.y&&s.x<(T.x-y.x)*(s.y-y.y)/(T.y-y.y)+y.x&&(D=!D)}return D}function lp(d,s){let u=!1;for(let y=0,T=d.length-1;y<d.length;T=y++){let D=d[y],R=d[T];D.y>s.y!=R.y>s.y&&s.x<(R.x-D.x)*(s.y-D.y)/(R.y-D.y)+D.x&&(u=!u)}return u}function zm(d,s,u){let y=u[0],T=u[2];if(d.x<y.x&&s.x<y.x||d.x>T.x&&s.x>T.x||d.y<y.y&&s.y<y.y||d.y>T.y&&s.y>T.y)return!1;let D=Fs(d,s,u[0]);return D!==Fs(d,s,u[1])||D!==Fs(d,s,u[2])||D!==Fs(d,s,u[3])}function Hp(d,s,u){let y=s.paint.get(d).value;return y.kind==="constant"?y.value:u.programConfigurations.get(s.id).getMaxValue(d)}function gf(d){return Math.sqrt(d[0]*d[0]+d[1]*d[1])}function yf(d,s,u,y,T){if(!s[0]&&!s[1])return d;let D=Wi.convert(s)._mult(T);u==="viewport"&&D._rotate(-y);let R=[];for(let B=0;B<d.length;B++)R.push(d[B].sub(D));return R}let Lm,km;sn("CircleBucket",sp,{omit:["layers"]});var c_={get paint(){return km=km||new Qs({"circle-radius":new jn(Ue.paint_circle["circle-radius"]),"circle-color":new jn(Ue.paint_circle["circle-color"]),"circle-blur":new jn(Ue.paint_circle["circle-blur"]),"circle-opacity":new jn(Ue.paint_circle["circle-opacity"]),"circle-translate":new pn(Ue.paint_circle["circle-translate"]),"circle-translate-anchor":new pn(Ue.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new pn(Ue.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new pn(Ue.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new jn(Ue.paint_circle["circle-stroke-width"]),"circle-stroke-color":new jn(Ue.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new jn(Ue.paint_circle["circle-stroke-opacity"])})},get layout(){return Lm=Lm||new Qs({"circle-sort-key":new jn(Ue.layout_circle["circle-sort-key"])})}};class sg extends ds{constructor(s){super(s,c_)}createBucket(s){return new sp(s)}queryRadius(s){let u=s;return Hp("circle-radius",this,u)+Hp("circle-stroke-width",this,u)+gf(this.paint.get("circle-translate"))}queryIntersectsFeature({queryGeometry:s,feature:u,featureState:y,geometry:T,transform:D,pixelsToTileUnits:R,unwrappedTileID:B,getElevation:G}){let K=yf(s,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),-D.bearingInRadians,R),Q=this.paint.get("circle-radius").evaluate(u,y)+this.paint.get("circle-stroke-width").evaluate(u,y),ce=this.paint.get("circle-pitch-alignment")==="map",_e=ce?K:function(Te,De,Ye,lt){return Te.map(Mt=>h_(Mt,De,Ye,lt))}(K,D,B,G),ve=ce?Q*R:Q;for(let Te of T)for(let De of Te){let Ye=ce?De:h_(De,D,B,G),lt=ve,Mt=D.projectTileCoordinates(De.x,De.y,B,G).signedDistanceFromCamera;if(this.paint.get("circle-pitch-scale")==="viewport"&&this.paint.get("circle-pitch-alignment")==="map"?lt*=Mt/D.cameraToCenterDistance:this.paint.get("circle-pitch-scale")==="map"&&this.paint.get("circle-pitch-alignment")==="viewport"&&(lt*=D.cameraToCenterDistance/Mt),_f(_e,Ye,lt))return!0}return!1}}function h_(d,s,u,y){let T=s.projectTileCoordinates(d.x,d.y,u,y).point;return new Wi((.5*T.x+.5)*s.width,(.5*-T.y+.5)*s.height)}class bo extends sp{}let Om;sn("HeatmapBucket",bo,{omit:["layers"]});var ag={get paint(){return Om=Om||new Qs({"heatmap-radius":new jn(Ue.paint_heatmap["heatmap-radius"]),"heatmap-weight":new jn(Ue.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new pn(Ue.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Ei(Ue.paint_heatmap["heatmap-color"]),"heatmap-opacity":new pn(Ue.paint_heatmap["heatmap-opacity"])})}};function sd(d,{width:s,height:u},y,T){if(T){if(T instanceof Uint8ClampedArray)T=new Uint8Array(T.buffer);else if(T.length!==s*u*y)throw new RangeError(`mismatched image size. expected: ${T.length} but got: ${s*u*y}`)}else T=new Uint8Array(s*u*y);return d.width=s,d.height=u,d.data=T,d}function u_(d,{width:s,height:u},y){if(s===d.width&&u===d.height)return;let T=sd({},{width:s,height:u},y);ad(d,T,{x:0,y:0},{x:0,y:0},{width:Math.min(d.width,s),height:Math.min(d.height,u)},y),d.width=s,d.height=u,d.data=T.data}function ad(d,s,u,y,T,D){if(T.width===0||T.height===0)return s;if(T.width>d.width||T.height>d.height||u.x>d.width-T.width||u.y>d.height-T.height)throw new RangeError("out of range source coordinates for image copy");if(T.width>s.width||T.height>s.height||y.x>s.width-T.width||y.y>s.height-T.height)throw new RangeError("out of range destination coordinates for image copy");let R=d.data,B=s.data;if(R===B)throw new Error("srcData equals dstData, so image is already copied");for(let G=0;G<T.height;G++){let K=((u.y+G)*d.width+u.x)*D,Q=((y.y+G)*s.width+y.x)*D;for(let ce=0;ce<T.width*D;ce++)B[Q+ce]=R[K+ce]}return s}class Xp{constructor(s,u){sd(this,s,1,u)}resize(s){u_(this,s,1)}clone(){return new Xp({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(s,u,y,T,D){ad(s,u,y,T,D,1)}}class Ba{constructor(s,u){sd(this,s,4,u)}resize(s){u_(this,s,4)}replace(s,u){u?this.data.set(s):this.data=s instanceof Uint8ClampedArray?new Uint8Array(s.buffer):s}clone(){return new Ba({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(s,u,y,T,D){ad(s,u,y,T,D,4)}setPixel(s,u,y){let T=4*(s*this.width+u);this.data[T+0]=Math.round(255*y.r/y.a),this.data[T+1]=Math.round(255*y.g/y.a),this.data[T+2]=Math.round(255*y.b/y.a),this.data[T+3]=Math.round(255*y.a)}}function Kp(d){let s={},u=d.resolution||256,y=d.clips?d.clips.length:1,T=d.image||new Ba({width:u,height:y});if(Math.log(u)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${u}`);let D=(R,B,G)=>{s[d.evaluationKey]=G;let K=d.expression.evaluate(s);T.setPixel(R/4/u,B/4,K)};if(d.clips)for(let R=0,B=0;R<y;++R,B+=4*u)for(let G=0,K=0;G<u;G++,K+=4){let Q=G/(u-1),{start:ce,end:_e}=d.clips[R];D(B,K,ce*(1-Q)+_e*Q)}else for(let R=0,B=0;R<u;R++,B+=4)D(0,B,R/(u-1));return T}sn("AlphaImage",Xp),sn("RGBAImage",Ba);let Rc="big-fb";class Xf extends ds{createBucket(s){return new bo(s)}constructor(s){super(s,ag),this.heatmapFbos=new Map,this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(s){s==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Kp({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbos.has(Rc)&&this.heatmapFbos.delete(Rc)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}}let is;var bh={get paint(){return is=is||new Qs({"hillshade-illumination-direction":new pn(Ue.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-altitude":new pn(Ue.paint_hillshade["hillshade-illumination-altitude"]),"hillshade-illumination-anchor":new pn(Ue.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new pn(Ue.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new pn(Ue.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new pn(Ue.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new pn(Ue.paint_hillshade["hillshade-accent-color"]),"hillshade-method":new pn(Ue.paint_hillshade["hillshade-method"])})}};class xf extends ds{constructor(s){super(s,bh),this.recalculate({zoom:0,zoomHistory:{}},void 0)}getIlluminationProperties(){let s=this.paint.get("hillshade-illumination-direction").values,u=this.paint.get("hillshade-illumination-altitude").values,y=this.paint.get("hillshade-highlight-color").values,T=this.paint.get("hillshade-shadow-color").values,D=Math.max(s.length,u.length,y.length,T.length);s=s.concat(Array(D-s.length).fill(s.at(-1))),u=u.concat(Array(D-u.length).fill(u.at(-1))),y=y.concat(Array(D-y.length).fill(y.at(-1))),T=T.concat(Array(D-T.length).fill(T.at(-1)));let R=u.map(Hs);return{directionRadians:s.map(Hs),altitudeRadians:R,shadowColor:T,highlightColor:y}}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}}let vf;var d_={get paint(){return vf=vf||new Qs({"color-relief-opacity":new pn(Ue["paint_color-relief"]["color-relief-opacity"]),"color-relief-color":new Ei(Ue["paint_color-relief"]["color-relief-color"])})}};class Fm{constructor(s,u,y,T){this.context=s,this.format=y,this.texture=s.gl.createTexture(),this.update(u,T)}update(s,u,y){let{width:T,height:D}=s,R=!(this.size&&this.size[0]===T&&this.size[1]===D||y),{context:B}=this,{gl:G}=B;if(this.useMipmap=!!(u&&u.useMipmap),G.bindTexture(G.TEXTURE_2D,this.texture),B.pixelStoreUnpackFlipY.set(!1),B.pixelStoreUnpack.set(1),B.pixelStoreUnpackPremultiplyAlpha.set(this.format===G.RGBA&&(!u||u.premultiply!==!1)),R)this.size=[T,D],s instanceof HTMLImageElement||s instanceof HTMLCanvasElement||s instanceof HTMLVideoElement||s instanceof ImageData||Wa(s)?G.texImage2D(G.TEXTURE_2D,0,this.format,this.format,G.UNSIGNED_BYTE,s):G.texImage2D(G.TEXTURE_2D,0,this.format,T,D,0,this.format,G.UNSIGNED_BYTE,s.data);else{let{x:K,y:Q}=y||{x:0,y:0};s instanceof HTMLImageElement||s instanceof HTMLCanvasElement||s instanceof HTMLVideoElement||s instanceof ImageData||Wa(s)?G.texSubImage2D(G.TEXTURE_2D,0,K,Q,G.RGBA,G.UNSIGNED_BYTE,s):G.texSubImage2D(G.TEXTURE_2D,0,K,Q,T,D,G.RGBA,G.UNSIGNED_BYTE,s.data)}this.useMipmap&&this.isSizePowerOfTwo()&&G.generateMipmap(G.TEXTURE_2D),B.pixelStoreUnpackFlipY.setDefault(),B.pixelStoreUnpack.setDefault(),B.pixelStoreUnpackPremultiplyAlpha.setDefault()}bind(s,u,y){let{context:T}=this,{gl:D}=T;D.bindTexture(D.TEXTURE_2D,this.texture),y!==D.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(y=D.LINEAR),s!==this.filter&&(D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MAG_FILTER,s),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MIN_FILTER,y||s),this.filter=s),u!==this.wrap&&(D.texParameteri(D.TEXTURE_2D,D.TEXTURE_WRAP_S,u),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_WRAP_T,u),this.wrap=u)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){let{gl:s}=this.context;s.deleteTexture(this.texture),this.texture=null}}class Yp{constructor(s,u,y,T=1,D=1,R=1,B=0){if(this.uid=s,u.height!==u.width)throw new RangeError("DEM tiles must be square");if(y&&!["mapbox","terrarium","custom"].includes(y))return void Jo(`"${y}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=u.height;let G=this.dim=u.height-2;switch(this.data=new Uint32Array(u.data.buffer),y){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=T,this.greenFactor=D,this.blueFactor=R,this.baseShift=B;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let K=0;K<G;K++)this.data[this._idx(-1,K)]=this.data[this._idx(0,K)],this.data[this._idx(G,K)]=this.data[this._idx(G-1,K)],this.data[this._idx(K,-1)]=this.data[this._idx(K,0)],this.data[this._idx(K,G)]=this.data[this._idx(K,G-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(G,-1)]=this.data[this._idx(G-1,0)],this.data[this._idx(-1,G)]=this.data[this._idx(0,G-1)],this.data[this._idx(G,G)]=this.data[this._idx(G-1,G-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let K=0;K<G;K++)for(let Q=0;Q<G;Q++){let ce=this.get(K,Q);ce>this.max&&(this.max=ce),ce<this.min&&(this.min=ce)}}get(s,u){let y=new Uint8Array(this.data.buffer),T=4*this._idx(s,u);return this.unpack(y[T],y[T+1],y[T+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(s,u){if(s<-1||s>=this.dim+1||u<-1||u>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(u+1)*this.stride+(s+1)}unpack(s,u,y){return s*this.redFactor+u*this.greenFactor+y*this.blueFactor-this.baseShift}pack(s){return Bm(s,this.getUnpackVector())}getPixels(){return new Ba({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(s,u,y){if(this.dim!==s.dim)throw new Error("dem dimension mismatch");let T=u*this.dim,D=u*this.dim+this.dim,R=y*this.dim,B=y*this.dim+this.dim;switch(u){case-1:T=D-1;break;case 1:D=T+1}switch(y){case-1:R=B-1;break;case 1:B=R+1}let G=-u*this.dim,K=-y*this.dim;for(let Q=R;Q<B;Q++)for(let ce=T;ce<D;ce++)this.data[this._idx(ce,Q)]=s.data[this._idx(ce+G,Q+K)]}}function Bm(d,s){let u=s[0],y=s[1],T=s[2],D=s[3],R=Math.min(u,y,T),B=Math.round((d+D)/R);return{r:Math.floor(B*R/u)%256,g:Math.floor(B*R/y)%256,b:Math.floor(B*R/T)%256}}sn("DEMData",Yp);class Nm extends ds{constructor(s){super(s,d_)}_createColorRamp(s){let u={elevationStops:[],colorStops:[]},y=this._transitionablePaint._values["color-relief-color"].value.expression;if(y instanceof Fh&&y._styleExpression.expression instanceof Ri){this.colorRampExpression=y;let R=y._styleExpression.expression;u.elevationStops=R.labels,u.colorStops=[];for(let B of u.elevationStops)u.colorStops.push(R.evaluate({globals:{elevation:B}}))}if(u.elevationStops.length<1&&(u.elevationStops=[0],u.colorStops=[Pr.transparent]),u.elevationStops.length<2&&(u.elevationStops.push(u.elevationStops[0]+1),u.colorStops.push(u.colorStops[0])),u.elevationStops.length<=s)return u;let T={elevationStops:[],colorStops:[]},D=(u.elevationStops.length-1)/(s-1);for(let R=0;R<u.elevationStops.length-.5;R+=D)T.elevationStops.push(u.elevationStops[Math.round(R)]),T.colorStops.push(u.colorStops[Math.round(R)]);return Jo(`Too many colors in specification of ${this.id} color-relief layer, may not render properly.`),T}_colorRampChanged(){return this.colorRampExpression!=this._transitionablePaint._values["color-relief-color"].value.expression}getColorRampTextures(s,u,y){if(this.colorRampTextures&&!this._colorRampChanged())return this.colorRampTextures;let T=this._createColorRamp(u),D=new Ba({width:T.colorStops.length,height:1}),R=new Ba({width:T.colorStops.length,height:1});for(let B=0;B<T.elevationStops.length;B++){let G=Bm(T.elevationStops[B],y);R.setPixel(0,B,new Pr(G.r/255,G.g/255,G.b/255,1)),D.setPixel(0,B,T.colorStops[B])}return this.colorRampTextures={elevationTexture:new Fm(s,R,s.gl.RGBA),colorTexture:new Fm(s,D,s.gl.RGBA)},this.colorRampTextures}hasOffscreenPass(){return this.visibility!=="none"&&!!this.colorRampTextures}}let zc=ys([{name:"a_pos",components:2,type:"Int16"}],4),{members:bf}=zc;function cp(d,s,u){let y=u.patternDependencies,T=!1;for(let D of s){let R=D.paint.get(`${d}-pattern`);R.isConstant()||(T=!0);let B=R.constantOr(null);B&&(T=!0,y[B.to]=!0,y[B.from]=!0)}return T}function ld(d,s,u,y,T){let D=T.patternDependencies;for(let R of s){let B=R.paint.get(`${d}-pattern`).value;if(B.kind!=="constant"){let G=B.evaluate({zoom:y-1},u,{},T.availableImages),K=B.evaluate({zoom:y},u,{},T.availableImages),Q=B.evaluate({zoom:y+1},u,{},T.availableImages);G=G&&G.name?G.name:G,K=K&&K.name?K.name:K,Q=Q&&Q.name?Q.name:Q,D[G]=!0,D[K]=!0,D[Q]=!0,u.patterns[R.id]={min:G,mid:K,max:Q}}}return u}function Wh(d,s,u,y,T){let D;if(T===function(R,B,G,K){let Q=0;for(let ce=B,_e=G-K;ce<G;ce+=K)Q+=(R[_e]-R[ce])*(R[ce+1]+R[_e+1]),_e=ce;return Q}(d,s,u,y)>0)for(let R=s;R<u;R+=y)D=ae(R/y|0,d[R],d[R+1],D);else for(let R=u-y;R>=s;R-=y)D=ae(R/y|0,d[R],d[R+1],D);return D&&$(D,D.next)&&(be(D),D=D.next),D}function tl(d,s){if(!d)return d;s||(s=d);let u,y=d;do if(u=!1,y.steiner||!$(y,y.next)&&U(y.prev,y,y.next)!==0)y=y.next;else{if(be(y),y=s=y.prev,y===y.next)break;u=!0}while(u||y!==s);return s}function bl(d,s,u,y,T,D,R){if(!d)return;!R&&D&&function(G,K,Q,ce){let _e=G;do _e.z===0&&(_e.z=v(_e.x,_e.y,K,Q,ce)),_e.prevZ=_e.prev,_e.nextZ=_e.next,_e=_e.next;while(_e!==G);_e.prevZ.nextZ=null,_e.prevZ=null,function(ve){let Te,De=1;do{let Ye,lt=ve;ve=null;let Mt=null;for(Te=0;lt;){Te++;let yt=lt,ye=0;for(let bt=0;bt<De&&(ye++,yt=yt.nextZ,yt);bt++);let Ze=De;for(;ye>0||Ze>0&&yt;)ye!==0&&(Ze===0||!yt||lt.z<=yt.z)?(Ye=lt,lt=lt.nextZ,ye--):(Ye=yt,yt=yt.nextZ,Ze--),Mt?Mt.nextZ=Ye:ve=Ye,Ye.prevZ=Mt,Mt=Ye;lt=yt}Mt.nextZ=null,De*=2}while(Te>1)}(_e)}(d,y,T,D);let B=d;for(;d.prev!==d.next;){let G=d.prev,K=d.next;if(D?hp(d,y,T,D):cd(d))s.push(G.i,d.i,K.i),be(d),d=K.next,B=K.next;else if((d=K)===B){R?R===1?bl(d=p(tl(d),s),s,u,y,T,D,2):R===2&&i(d,s,u,y,T,D):bl(tl(d),s,u,y,T,D,1);break}}}function cd(d){let s=d.prev,u=d,y=d.next;if(U(s,u,y)>=0)return!1;let T=s.x,D=u.x,R=y.x,B=s.y,G=u.y,K=y.y,Q=Math.min(T,D,R),ce=Math.min(B,G,K),_e=Math.max(T,D,R),ve=Math.max(B,G,K),Te=y.next;for(;Te!==s;){if(Te.x>=Q&&Te.x<=_e&&Te.y>=ce&&Te.y<=ve&&z(T,B,D,G,R,K,Te.x,Te.y)&&U(Te.prev,Te,Te.next)>=0)return!1;Te=Te.next}return!0}function hp(d,s,u,y){let T=d.prev,D=d,R=d.next;if(U(T,D,R)>=0)return!1;let B=T.x,G=D.x,K=R.x,Q=T.y,ce=D.y,_e=R.y,ve=Math.min(B,G,K),Te=Math.min(Q,ce,_e),De=Math.max(B,G,K),Ye=Math.max(Q,ce,_e),lt=v(ve,Te,s,u,y),Mt=v(De,Ye,s,u,y),yt=d.prevZ,ye=d.nextZ;for(;yt&&yt.z>=lt&&ye&&ye.z<=Mt;){if(yt.x>=ve&&yt.x<=De&&yt.y>=Te&&yt.y<=Ye&&yt!==T&&yt!==R&&z(B,Q,G,ce,K,_e,yt.x,yt.y)&&U(yt.prev,yt,yt.next)>=0||(yt=yt.prevZ,ye.x>=ve&&ye.x<=De&&ye.y>=Te&&ye.y<=Ye&&ye!==T&&ye!==R&&z(B,Q,G,ce,K,_e,ye.x,ye.y)&&U(ye.prev,ye,ye.next)>=0))return!1;ye=ye.nextZ}for(;yt&&yt.z>=lt;){if(yt.x>=ve&&yt.x<=De&&yt.y>=Te&&yt.y<=Ye&&yt!==T&&yt!==R&&z(B,Q,G,ce,K,_e,yt.x,yt.y)&&U(yt.prev,yt,yt.next)>=0)return!1;yt=yt.prevZ}for(;ye&&ye.z<=Mt;){if(ye.x>=ve&&ye.x<=De&&ye.y>=Te&&ye.y<=Ye&&ye!==T&&ye!==R&&z(B,Q,G,ce,K,_e,ye.x,ye.y)&&U(ye.prev,ye,ye.next)>=0)return!1;ye=ye.nextZ}return!0}function p(d,s){let u=d;do{let y=u.prev,T=u.next.next;!$(y,T)&&Z(y,u,u.next,T)&&re(y,T)&&re(T,y)&&(s.push(y.i,u.i,T.i),be(u),be(u.next),u=d=T),u=u.next}while(u!==d);return tl(u)}function i(d,s,u,y,T,D){let R=d;do{let B=R.next.next;for(;B!==R.prev;){if(R.i!==B.i&&N(R,B)){let G=he(R,B);return R=tl(R,R.next),G=tl(G,G.next),bl(R,s,u,y,T,D,0),void bl(G,s,u,y,T,D,0)}B=B.next}R=R.next}while(R!==d)}function a(d,s){let u=d.x-s.x;return u===0&&(u=d.y-s.y,u===0)&&(u=(d.next.y-d.y)/(d.next.x-d.x)-(s.next.y-s.y)/(s.next.x-s.x)),u}function f(d,s){let u=function(T,D){let R=D,B=T.x,G=T.y,K,Q=-1/0;if($(T,R))return R;do{if($(T,R.next))return R.next;if(G<=R.y&&G>=R.next.y&&R.next.y!==R.y){let De=R.x+(G-R.y)*(R.next.x-R.x)/(R.next.y-R.y);if(De<=B&&De>Q&&(Q=De,K=R.x<R.next.x?R:R.next,De===B))return K}R=R.next}while(R!==D);if(!K)return null;let ce=K,_e=K.x,ve=K.y,Te=1/0;R=K;do{if(B>=R.x&&R.x>=_e&&B!==R.x&&C(G<ve?B:Q,G,_e,ve,G<ve?Q:B,G,R.x,R.y)){let De=Math.abs(G-R.y)/(B-R.x);re(R,T)&&(De<Te||De===Te&&(R.x>K.x||R.x===K.x&&g(K,R)))&&(K=R,Te=De)}R=R.next}while(R!==ce);return K}(d,s);if(!u)return s;let y=he(u,d);return tl(y,y.next),tl(u,u.next)}function g(d,s){return U(d.prev,d,s.prev)<0&&U(s.next,d,d.next)<0}function v(d,s,u,y,T){return(d=1431655765&((d=858993459&((d=252645135&((d=16711935&((d=(d-u)*T|0)|d<<8))|d<<4))|d<<2))|d<<1))|(s=1431655765&((s=858993459&((s=252645135&((s=16711935&((s=(s-y)*T|0)|s<<8))|s<<4))|s<<2))|s<<1))<<1}function S(d){let s=d,u=d;do(s.x<u.x||s.x===u.x&&s.y<u.y)&&(u=s),s=s.next;while(s!==d);return u}function C(d,s,u,y,T,D,R,B){return(T-R)*(s-B)>=(d-R)*(D-B)&&(d-R)*(y-B)>=(u-R)*(s-B)&&(u-R)*(D-B)>=(T-R)*(y-B)}function z(d,s,u,y,T,D,R,B){return!(d===R&&s===B)&&C(d,s,u,y,T,D,R,B)}function N(d,s){return d.next.i!==s.i&&d.prev.i!==s.i&&!function(u,y){let T=u;do{if(T.i!==u.i&&T.next.i!==u.i&&T.i!==y.i&&T.next.i!==y.i&&Z(T,T.next,u,y))return!0;T=T.next}while(T!==u);return!1}(d,s)&&(re(d,s)&&re(s,d)&&function(u,y){let T=u,D=!1,R=(u.x+y.x)/2,B=(u.y+y.y)/2;do T.y>B!=T.next.y>B&&T.next.y!==T.y&&R<(T.next.x-T.x)*(B-T.y)/(T.next.y-T.y)+T.x&&(D=!D),T=T.next;while(T!==u);return D}(d,s)&&(U(d.prev,d,s.prev)||U(d,s.prev,s))||$(d,s)&&U(d.prev,d,d.next)>0&&U(s.prev,s,s.next)>0)}function U(d,s,u){return(s.y-d.y)*(u.x-s.x)-(s.x-d.x)*(u.y-s.y)}function $(d,s){return d.x===s.x&&d.y===s.y}function Z(d,s,u,y){let T=se(U(d,s,u)),D=se(U(d,s,y)),R=se(U(u,y,d)),B=se(U(u,y,s));return T!==D&&R!==B||!(T!==0||!X(d,u,s))||!(D!==0||!X(d,y,s))||!(R!==0||!X(u,d,y))||!(B!==0||!X(u,s,y))}function X(d,s,u){return s.x<=Math.max(d.x,u.x)&&s.x>=Math.min(d.x,u.x)&&s.y<=Math.max(d.y,u.y)&&s.y>=Math.min(d.y,u.y)}function se(d){return d>0?1:d<0?-1:0}function re(d,s){return U(d.prev,d,d.next)<0?U(d,s,d.next)>=0&&U(d,d.prev,s)>=0:U(d,s,d.prev)<0||U(d,d.next,s)<0}function he(d,s){let u=Pe(d.i,d.x,d.y),y=Pe(s.i,s.x,s.y),T=d.next,D=s.prev;return d.next=s,s.prev=d,u.next=T,T.prev=u,y.next=u,u.prev=y,D.next=y,y.prev=D,y}function ae(d,s,u,y){let T=Pe(d,s,u);return y?(T.next=y.next,T.prev=y,y.next.prev=T,y.next=T):(T.prev=T,T.next=T),T}function be(d){d.next.prev=d.prev,d.prev.next=d.next,d.prevZ&&(d.prevZ.nextZ=d.nextZ),d.nextZ&&(d.nextZ.prevZ=d.prevZ)}function Pe(d,s,u){return{i:d,x:s,y:u,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}class Re{constructor(s,u){if(u>s)throw new Error("Min granularity must not be greater than base granularity.");this._baseZoomGranularity=s,this._minGranularity=u}getGranularityForZoomLevel(s){return Math.max(Math.floor(this._baseZoomGranularity/(1<<s)),this._minGranularity,1)}}class Ge{constructor(s){this.fill=s.fill,this.line=s.line,this.tile=s.tile,this.stencil=s.stencil,this.circle=s.circle}}Ge.noSubdivision=new Ge({fill:new Re(0,0),line:new Re(0,0),tile:new Re(0,0),stencil:new Re(0,0),circle:1}),sn("SubdivisionGranularityExpression",Re),sn("SubdivisionGranularitySetting",Ge);let Ne=-32768,Ve=32767;class Oe{constructor(s,u){this._vertexBuffer=[],this._vertexDictionary=new Map,this._used=!1,this._granularity=s,this._granularityCellSize=Hr/s,this._canonical=u}_getKey(s,u){return(s+=32768)<<16|u+32768}_vertexToIndex(s,u){if(s<-32768||u<-32768||s>32767||u>32767)throw new Error("Vertex coordinates are out of signed 16 bit integer range.");let y=0|Math.round(s),T=0|Math.round(u),D=this._getKey(y,T);if(this._vertexDictionary.has(D))return this._vertexDictionary.get(D);let R=this._vertexBuffer.length/2;return this._vertexDictionary.set(D,R),this._vertexBuffer.push(y,T),R}_subdivideTrianglesScanline(s){if(this._granularity<2)return function(T,D){let R=[];for(let B=0;B<D.length;B+=3){let G=D[B],K=D[B+1],Q=D[B+2],ce=T[2*G],_e=T[2*G+1];(T[2*K]-ce)*(T[2*Q+1]-_e)-(T[2*K+1]-_e)*(T[2*Q]-ce)>0?(R.push(G),R.push(Q),R.push(K)):(R.push(G),R.push(K),R.push(Q))}return R}(this._vertexBuffer,s);let u=[],y=s.length;for(let T=0;T<y;T+=3){let D=[s[T+0],s[T+1],s[T+2]],R=[this._vertexBuffer[2*s[T+0]+0],this._vertexBuffer[2*s[T+0]+1],this._vertexBuffer[2*s[T+1]+0],this._vertexBuffer[2*s[T+1]+1],this._vertexBuffer[2*s[T+2]+0],this._vertexBuffer[2*s[T+2]+1]],B=1/0,G=1/0,K=-1/0,Q=-1/0;for(let De=0;De<3;De++){let Ye=R[2*De],lt=R[2*De+1];B=Math.min(B,Ye),K=Math.max(K,Ye),G=Math.min(G,lt),Q=Math.max(Q,lt)}if(B===K||G===Q)continue;let ce=Math.floor(B/this._granularityCellSize),_e=Math.ceil(K/this._granularityCellSize),ve=Math.floor(G/this._granularityCellSize),Te=Math.ceil(Q/this._granularityCellSize);if(ce!==_e||ve!==Te)for(let De=ve;De<Te;De++){let Ye=this._scanlineGenerateVertexRingForCellRow(De,R,D);It(this._vertexBuffer,Ye,u)}else u.push(...D)}return u}_scanlineGenerateVertexRingForCellRow(s,u,y){let T=s*this._granularityCellSize,D=T+this._granularityCellSize,R=[];for(let B=0;B<3;B++){let G=u[2*B],K=u[2*B+1],Q=u[2*(B+1)%6],ce=u[(2*(B+1)+1)%6],_e=u[2*(B+2)%6],ve=u[(2*(B+2)+1)%6],Te=Q-G,De=ce-K,Ye=Te===0,lt=De===0,Mt=(T-K)/De,yt=(D-K)/De,ye=Math.min(Mt,yt),Ze=Math.max(Mt,yt);if(!lt&&(ye>=1||Ze<=0)||lt&&(K<T||K>D)){ce>=T&&ce<=D&&R.push(y[(B+1)%3]);continue}!lt&&ye>0&&R.push(this._vertexToIndex(G+Te*ye,K+De*ye));let bt=G+Te*Math.max(ye,0),ni=G+Te*Math.min(Ze,1);Ye||this._generateIntraEdgeVertices(R,G,K,Q,ce,bt,ni),!lt&&Ze<1&&R.push(this._vertexToIndex(G+Te*Ze,K+De*Ze)),(lt||ce>=T&&ce<=D)&&R.push(y[(B+1)%3]),!lt&&(ce<=T||ce>=D)&&this._generateInterEdgeVertices(R,G,K,Q,ce,_e,ve,ni,T,D)}return R}_generateIntraEdgeVertices(s,u,y,T,D,R,B){let G=T-u,K=D-y,Q=K===0,ce=Q?Math.min(u,T):Math.min(R,B),_e=Q?Math.max(u,T):Math.max(R,B),ve=Math.floor(ce/this._granularityCellSize)+1,Te=Math.ceil(_e/this._granularityCellSize)-1;if(Q?u<T:R<B)for(let De=ve;De<=Te;De++){let Ye=De*this._granularityCellSize;s.push(this._vertexToIndex(Ye,y+K*(Ye-u)/G))}else for(let De=Te;De>=ve;De--){let Ye=De*this._granularityCellSize;s.push(this._vertexToIndex(Ye,y+K*(Ye-u)/G))}}_generateInterEdgeVertices(s,u,y,T,D,R,B,G,K,Q){let ce=D-y,_e=R-T,ve=B-D,Te=(K-D)/ve,De=(Q-D)/ve,Ye=Math.min(Te,De),lt=Math.max(Te,De),Mt=T+_e*Ye,yt=Math.floor(Math.min(Mt,G)/this._granularityCellSize)+1,ye=Math.ceil(Math.max(Mt,G)/this._granularityCellSize)-1,Ze=G<Mt,bt=ve===0;if(bt&&(B===K||B===Q))return;if(bt||Ye>=1||lt<=0){let Ai=y-B,ci=R+(u-R)*Math.min((K-B)/Ai,(Q-B)/Ai);yt=Math.floor(Math.min(ci,G)/this._granularityCellSize)+1,ye=Math.ceil(Math.max(ci,G)/this._granularityCellSize)-1,Ze=G<ci}let ni=ce>0?Q:K;if(Ze)for(let Ai=yt;Ai<=ye;Ai++)s.push(this._vertexToIndex(Ai*this._granularityCellSize,ni));else for(let Ai=ye;Ai>=yt;Ai--)s.push(this._vertexToIndex(Ai*this._granularityCellSize,ni))}_generateOutline(s){let u=[];for(let y of s){let T=Qe(y,this._granularity,!0),D=this._pointArrayToIndices(T),R=[];for(let B=1;B<D.length;B++)R.push(D[B-1]),R.push(D[B]);u.push(R)}return u}_handlePoles(s){let u=!1,y=!1;this._canonical&&(this._canonical.y===0&&(u=!0),this._canonical.y===(1<<this._canonical.z)-1&&(y=!0)),(u||y)&&this._fillPoles(s,u,y)}_ensureNoPoleVertices(){let s=this._vertexBuffer;for(let u=0;u<s.length;u+=2){let y=s[u+1];y===Ne&&(s[u+1]=-32767),y===Ve&&(s[u+1]=32766)}}_generatePoleQuad(s,u,y,T,D,R){T>D!=(R===Ne)?(s.push(u),s.push(y),s.push(this._vertexToIndex(T,R)),s.push(y),s.push(this._vertexToIndex(D,R)),s.push(this._vertexToIndex(T,R))):(s.push(y),s.push(u),s.push(this._vertexToIndex(T,R)),s.push(this._vertexToIndex(D,R)),s.push(y),s.push(this._vertexToIndex(T,R)))}_fillPoles(s,u,y){let T=this._vertexBuffer,D=Hr,R=s.length;for(let B=2;B<R;B+=3){let G=s[B-2],K=s[B-1],Q=s[B],ce=T[2*G],_e=T[2*G+1],ve=T[2*K],Te=T[2*K+1],De=T[2*Q],Ye=T[2*Q+1];u&&(_e===0&&Te===0&&this._generatePoleQuad(s,G,K,ce,ve,Ne),Te===0&&Ye===0&&this._generatePoleQuad(s,K,Q,ve,De,Ne),Ye===0&&_e===0&&this._generatePoleQuad(s,Q,G,De,ce,Ne)),y&&(_e===D&&Te===D&&this._generatePoleQuad(s,G,K,ce,ve,Ve),Te===D&&Ye===D&&this._generatePoleQuad(s,K,Q,ve,De,Ve),Ye===D&&_e===D&&this._generatePoleQuad(s,Q,G,De,ce,Ve))}}_initializeVertices(s){for(let u=0;u<s.length;u+=2)this._vertexToIndex(s[u],s[u+1])}subdividePolygonInternal(s,u){if(this._used)throw new Error("Subdivision: multiple use not allowed.");this._used=!0;let{flattened:y,holeIndices:T}=function(B){let G=[],K=[];for(let Q of B)if(Q.length!==0){Q!==B[0]&&G.push(K.length/2);for(let ce=0;ce<Q.length;ce++)K.push(Q[ce].x),K.push(Q[ce].y)}return{flattened:K,holeIndices:G}}(s),D;this._initializeVertices(y);try{let B=function(K,Q,ce=2){let _e=Q&&Q.length,ve=_e?Q[0]*ce:K.length,Te=Wh(K,0,ve,ce,!0),De=[];if(!Te||Te.next===Te.prev)return De;let Ye,lt,Mt;if(_e&&(Te=function(yt,ye,Ze,bt){let ni=[];for(let Ai=0,ci=ye.length;Ai<ci;Ai++){let gi=Wh(yt,ye[Ai]*bt,Ai<ci-1?ye[Ai+1]*bt:yt.length,bt,!1);gi===gi.next&&(gi.steiner=!0),ni.push(S(gi))}ni.sort(a);for(let Ai=0;Ai<ni.length;Ai++)Ze=f(ni[Ai],Ze);return Ze}(K,Q,Te,ce)),K.length>80*ce){Ye=1/0,lt=1/0;let yt=-1/0,ye=-1/0;for(let Ze=ce;Ze<ve;Ze+=ce){let bt=K[Ze],ni=K[Ze+1];bt<Ye&&(Ye=bt),ni<lt&&(lt=ni),bt>yt&&(yt=bt),ni>ye&&(ye=ni)}Mt=Math.max(yt-Ye,ye-lt),Mt=Mt!==0?32767/Mt:0}return bl(Te,De,ce,Ye,lt,Mt,0),De}(y,T),G=this._convertIndices(y,B);D=this._subdivideTrianglesScanline(G)}catch(B){console.error(B)}let R=[];return u&&(R=this._generateOutline(s)),this._ensureNoPoleVertices(),this._handlePoles(D),{verticesFlattened:this._vertexBuffer,indicesTriangles:D,indicesLineList:R}}_convertIndices(s,u){let y=[];for(let T=0;T<u.length;T++)y.push(this._vertexToIndex(s[2*u[T]],s[2*u[T]+1]));return y}_pointArrayToIndices(s){let u=[];for(let y=0;y<s.length;y++){let T=s[y];u.push(this._vertexToIndex(T.x,T.y))}return u}}function Ke(d,s,u,y=!0){return new Oe(u,s).subdividePolygonInternal(d,y)}function Qe(d,s,u=!1){if(!d||d.length<1)return[];if(d.length<2)return[];let y=d[0],T=d[d.length-1],D=u&&(y.x!==T.x||y.y!==T.y);if(s<2)return D?[...d,d[0]]:[...d];let R=Math.floor(Hr/s),B=[];B.push(new Wi(d[0].x,d[0].y));let G=d.length,K=D?G:G-1;for(let Q=0;Q<K;Q++){let ce=d[Q],_e=Q<G-1?d[Q+1]:d[0],ve=ce.x,Te=ce.y,De=_e.x,Ye=_e.y,lt=ve!==De,Mt=Te!==Ye;if(!lt&&!Mt)continue;let yt=De-ve,ye=Ye-Te,Ze=Math.abs(yt),bt=Math.abs(ye),ni=ve,Ai=Te;for(;;){let gi=yt>0?(Math.floor(ni/R)+1)*R:(Math.ceil(ni/R)-1)*R,Fi=ye>0?(Math.floor(Ai/R)+1)*R:(Math.ceil(Ai/R)-1)*R,Mi=Math.abs(ni-gi),Zi=Math.abs(Ai-Fi),bi=Math.abs(ni-De),fn=Math.abs(Ai-Ye),Hn=lt?Mi/Ze:Number.POSITIVE_INFINITY,Nn=Mt?Zi/bt:Number.POSITIVE_INFINITY;if((bi<=Mi||!lt)&&(fn<=Zi||!Mt))break;if(Hn<Nn&&lt||!Mt){ni=gi,Ai+=ye*Hn;let Sn=new Wi(ni,Math.round(Ai));B[B.length-1].x===Sn.x&&B[B.length-1].y===Sn.y||B.push(Sn)}else{ni+=yt*Nn,Ai=Fi;let Sn=new Wi(Math.round(ni),Ai);B[B.length-1].x===Sn.x&&B[B.length-1].y===Sn.y||B.push(Sn)}}let ci=new Wi(De,Ye);B[B.length-1].x===ci.x&&B[B.length-1].y===ci.y||B.push(ci)}return B}function It(d,s,u){if(s.length===0)throw new Error("Subdivision vertex ring is empty.");let y=0,T=d[2*s[0]];for(let G=1;G<s.length;G++){let K=d[2*s[G]];K<T&&(T=K,y=G)}let D=s.length,R=y,B=(R+1)%D;for(;;){let G=R-1>=0?R-1:D-1,K=(B+1)%D,Q=d[2*s[G]],ce=d[2*s[K]],_e=d[2*s[R]],ve=d[2*s[R]+1],Te=d[2*s[B]+1],De=!1;if(Q<ce)De=!0;else if(Q>ce)De=!1;else{let Ye=Te-ve,lt=-(d[2*s[B]]-_e),Mt=ve<Te?1:-1;((Q-_e)*Ye+(d[2*s[G]+1]-ve)*lt)*Mt>((ce-_e)*Ye+(d[2*s[K]+1]-ve)*lt)*Mt&&(De=!0)}if(De){let Ye=s[G],lt=s[R],Mt=s[B];Ye!==lt&&Ye!==Mt&&lt!==Mt&&u.push(Mt,lt,Ye),R--,R<0&&(R=D-1)}else{let Ye=s[K],lt=s[R],Mt=s[B];Ye!==lt&&Ye!==Mt&&lt!==Mt&&u.push(Mt,lt,Ye),B++,B>=D&&(B=0)}if(G===K)break}}function gt(d,s,u,y,T,D,R,B,G){let K=T.length/2,Q=R&&B&&G;if(K<lr.MAX_VERTEX_ARRAY_LENGTH){let ce=s.prepareSegment(K,u,y),_e=ce.vertexLength;for(let De=0;De<D.length;De+=3)y.emplaceBack(_e+D[De],_e+D[De+1],_e+D[De+2]);let ve,Te;ce.vertexLength+=K,ce.primitiveLength+=D.length/3,Q&&(Te=R.prepareSegment(K,u,B),ve=Te.vertexLength,Te.vertexLength+=K);for(let De=0;De<T.length;De+=2)d(T[De],T[De+1]);if(Q)for(let De=0;De<G.length;De++){let Ye=G[De];for(let lt=1;lt<Ye.length;lt+=2)B.emplaceBack(ve+Ye[lt-1],ve+Ye[lt]);Te.primitiveLength+=Ye.length/2}}else(function(ce,_e,ve,Te,De,Ye){let lt=[];for(let bt=0;bt<Te.length/2;bt++)lt.push(-1);let Mt={count:0},yt=0,ye=ce.getOrCreateLatestSegment(_e,ve),Ze=ye.vertexLength;for(let bt=2;bt<De.length;bt+=3){let ni=De[bt-2],Ai=De[bt-1],ci=De[bt],gi=lt[ni]<yt,Fi=lt[Ai]<yt,Mi=lt[ci]<yt;ye.vertexLength+((gi?1:0)+(Fi?1:0)+(Mi?1:0))>lr.MAX_VERTEX_ARRAY_LENGTH&&(ye=ce.createNewSegment(_e,ve),yt=Mt.count,gi=!0,Fi=!0,Mi=!0,Ze=0);let Zi=jt(lt,Te,Ye,Mt,ni,gi,ye),bi=jt(lt,Te,Ye,Mt,Ai,Fi,ye),fn=jt(lt,Te,Ye,Mt,ci,Mi,ye);ve.emplaceBack(Ze+Zi-yt,Ze+bi-yt,Ze+fn-yt),ye.primitiveLength++}})(s,u,y,T,D,d),Q&&function(ce,_e,ve,Te,De,Ye){let lt=[];for(let bt=0;bt<Te.length/2;bt++)lt.push(-1);let Mt={count:0},yt=0,ye=ce.getOrCreateLatestSegment(_e,ve),Ze=ye.vertexLength;for(let bt=0;bt<De.length;bt++){let ni=De[bt];for(let Ai=1;Ai<De[bt].length;Ai+=2){let ci=ni[Ai-1],gi=ni[Ai],Fi=lt[ci]<yt,Mi=lt[gi]<yt;ye.vertexLength+((Fi?1:0)+(Mi?1:0))>lr.MAX_VERTEX_ARRAY_LENGTH&&(ye=ce.createNewSegment(_e,ve),yt=Mt.count,Fi=!0,Mi=!0,Ze=0);let Zi=jt(lt,Te,Ye,Mt,ci,Fi,ye),bi=jt(lt,Te,Ye,Mt,gi,Mi,ye);ve.emplaceBack(Ze+Zi-yt,Ze+bi-yt),ye.primitiveLength++}}}(R,u,B,T,G,d),s.forceNewSegmentOnNextPrepare(),R?.forceNewSegmentOnNextPrepare()}function jt(d,s,u,y,T,D,R){if(D){let B=y.count;return u(s[2*T],s[2*T+1]),d[T]=y.count,y.count++,R.vertexLength++,B}return d[T]}class Ut{constructor(s){this.zoom=s.zoom,this.globalState=s.globalState,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map(u=>u.id),this.index=s.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new si,this.indexArray=new vo,this.indexArray2=new Yr,this.programConfigurations=new zo(s.layers,s.zoom),this.segments=new lr,this.segments2=new lr,this.stateDependentLayerIds=this.layers.filter(u=>u.isStateDependent()).map(u=>u.id)}populate(s,u,y){this.hasPattern=cp("fill",this.layers,u);let T=this.layers[0].layout.get("fill-sort-key"),D=!T.isConstant(),R=[];for(let{feature:B,id:G,index:K,sourceLayerIndex:Q}of s){let ce=this.layers[0]._featureFilter.needGeometry,_e=$h(B,ce);if(!this.layers[0]._featureFilter.filter(new jo(this.zoom,{globalState:this.globalState}),_e,y))continue;let ve=D?T.evaluate(_e,{},y,u.availableImages):void 0,Te={id:G,properties:B.properties,type:B.type,sourceLayerIndex:Q,index:K,geometry:ce?_e.geometry:Cu(B),patterns:{},sortKey:ve};R.push(Te)}D&&R.sort((B,G)=>B.sortKey-G.sortKey);for(let B of R){let{geometry:G,index:K,sourceLayerIndex:Q}=B;if(this.hasPattern){let ce=ld("fill",this.layers,B,this.zoom,u);this.patternFeatures.push(ce)}else this.addFeature(B,G,K,y,{},u.subdivisionGranularity);u.featureIndex.insert(s[K].feature,G,K,Q,this.index)}}update(s,u,y){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(s,u,this.stateDependentLayers,y)}addFeatures(s,u,y){for(let T of this.patternFeatures)this.addFeature(T,T.geometry,T.index,u,y,s.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(s){this.uploaded||(this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,bf),this.indexBuffer=s.createIndexBuffer(this.indexArray),this.indexBuffer2=s.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(s),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(s,u,y,T,D,R){for(let B of Js(u,500)){let G=Ke(B,T,R.fill.getGranularityForZoomLevel(T.z)),K=this.layoutVertexArray;gt((Q,ce)=>{K.emplaceBack(Q,ce)},this.segments,this.layoutVertexArray,this.indexArray,G.verticesFlattened,G.indicesTriangles,this.segments2,this.indexArray2,G.indicesLineList)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,s,y,D,T)}}let fi,vt;sn("FillBucket",Ut,{omit:["layers","patternFeatures"]});var Ct={get paint(){return vt=vt||new Qs({"fill-antialias":new pn(Ue.paint_fill["fill-antialias"]),"fill-opacity":new jn(Ue.paint_fill["fill-opacity"]),"fill-color":new jn(Ue.paint_fill["fill-color"]),"fill-outline-color":new jn(Ue.paint_fill["fill-outline-color"]),"fill-translate":new pn(Ue.paint_fill["fill-translate"]),"fill-translate-anchor":new pn(Ue.paint_fill["fill-translate-anchor"]),"fill-pattern":new gh(Ue.paint_fill["fill-pattern"])})},get layout(){return fi=fi||new Qs({"fill-sort-key":new jn(Ue.layout_fill["fill-sort-key"])})}};class _t extends ds{constructor(s){super(s,Ct)}recalculate(s,u){super.recalculate(s,u);let y=this.paint._values["fill-outline-color"];y.value.kind==="constant"&&y.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(s){return new Ut(s)}queryRadius(){return gf(this.paint.get("fill-translate"))}queryIntersectsFeature({queryGeometry:s,geometry:u,transform:y,pixelsToTileUnits:T}){return Zf(yf(s,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),-y.bearingInRadians,T),u)}isTileClipped(){return!0}}let qt=ys([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),Pt=ys([{name:"a_centroid",components:2,type:"Int16"}],4),{members:ti}=qt;var Gt,ii,oi,ki,ji,zi,$i,Oi={};function nn(){if(ii)return Gt;ii=1;var d=_r();function s(T,D,R,B,G){this.properties={},this.extent=R,this.type=0,this._pbf=T,this._geometry=-1,this._keys=B,this._values=G,T.readFields(u,this,D)}function u(T,D,R){T==1?D.id=R.readVarint():T==2?function(B,G){for(var K=B.readVarint()+B.pos;B.pos<K;){var Q=G._keys[B.readVarint()],ce=G._values[B.readVarint()];G.properties[Q]=ce}}(R,D):T==3?D.type=R.readVarint():T==4&&(D._geometry=R.pos)}function y(T){for(var D,R,B=0,G=0,K=T.length,Q=K-1;G<K;Q=G++)B+=((R=T[Q]).x-(D=T[G]).x)*(D.y+R.y);return B}return Gt=s,s.types=["Unknown","Point","LineString","Polygon"],s.prototype.loadGeometry=function(){var T=this._pbf;T.pos=this._geometry;for(var D,R=T.readVarint()+T.pos,B=1,G=0,K=0,Q=0,ce=[];T.pos<R;){if(G<=0){var _e=T.readVarint();B=7&_e,G=_e>>3}if(G--,B===1||B===2)K+=T.readSVarint(),Q+=T.readSVarint(),B===1&&(D&&ce.push(D),D=[]),D.push(new d(K,Q));else{if(B!==7)throw new Error("unknown command "+B);D&&D.push(D[0].clone())}}return D&&ce.push(D),ce},s.prototype.bbox=function(){var T=this._pbf;T.pos=this._geometry;for(var D=T.readVarint()+T.pos,R=1,B=0,G=0,K=0,Q=1/0,ce=-1/0,_e=1/0,ve=-1/0;T.pos<D;){if(B<=0){var Te=T.readVarint();R=7&Te,B=Te>>3}if(B--,R===1||R===2)(G+=T.readSVarint())<Q&&(Q=G),G>ce&&(ce=G),(K+=T.readSVarint())<_e&&(_e=K),K>ve&&(ve=K);else if(R!==7)throw new Error("unknown command "+R)}return[Q,_e,ce,ve]},s.prototype.toGeoJSON=function(T,D,R){var B,G,K=this.extent*Math.pow(2,R),Q=this.extent*T,ce=this.extent*D,_e=this.loadGeometry(),ve=s.types[this.type];function Te(lt){for(var Mt=0;Mt<lt.length;Mt++){var yt=lt[Mt];lt[Mt]=[360*(yt.x+Q)/K-180,360/Math.PI*Math.atan(Math.exp((180-360*(yt.y+ce)/K)*Math.PI/180))-90]}}switch(this.type){case 1:var De=[];for(B=0;B<_e.length;B++)De[B]=_e[B][0];Te(_e=De);break;case 2:for(B=0;B<_e.length;B++)Te(_e[B]);break;case 3:for(_e=function(lt){var Mt=lt.length;if(Mt<=1)return[lt];for(var yt,ye,Ze=[],bt=0;bt<Mt;bt++){var ni=y(lt[bt]);ni!==0&&(ye===void 0&&(ye=ni<0),ye===ni<0?(yt&&Ze.push(yt),yt=[lt[bt]]):yt.push(lt[bt]))}return yt&&Ze.push(yt),Ze}(_e),B=0;B<_e.length;B++)for(G=0;G<_e[B].length;G++)Te(_e[B][G])}_e.length===1?_e=_e[0]:ve="Multi"+ve;var Ye={type:"Feature",geometry:{type:ve,coordinates:_e},properties:this.properties};return"id"in this&&(Ye.id=this.id),Ye},Gt}function xn(){if(ki)return oi;ki=1;var d=nn();function s(y,T){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=y,this._keys=[],this._values=[],this._features=[],y.readFields(u,this,T),this.length=this._features.length}function u(y,T,D){y===15?T.version=D.readVarint():y===1?T.name=D.readString():y===5?T.extent=D.readVarint():y===2?T._features.push(D.pos):y===3?T._keys.push(D.readString()):y===4&&T._values.push(function(R){for(var B=null,G=R.readVarint()+R.pos;R.pos<G;){var K=R.readVarint()>>3;B=K===1?R.readString():K===2?R.readFloat():K===3?R.readDouble():K===4?R.readVarint64():K===5?R.readVarint():K===6?R.readSVarint():K===7?R.readBoolean():null}return B}(D))}return oi=s,s.prototype.feature=function(y){if(y<0||y>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[y];var T=this._pbf.readVarint()+this._pbf.pos;return new d(this._pbf,T,this.extent,this._keys,this._values)},oi}function Bn(){return $i||($i=1,Oi.VectorTile=function(){if(zi)return ji;zi=1;var d=xn();function s(u,y,T){if(u===3){var D=new d(T,T.readVarint()+T.pos);D.length&&(y[D.name]=D)}}return ji=function(u,y){this.layers=u.readFields(s,{},y)},ji}(),Oi.VectorTileFeature=nn(),Oi.VectorTileLayer=xn()),Oi}var Er=at(Bn());let zr=Er.VectorTileFeature.types,Gn=Math.pow(2,13);function po(d,s,u,y,T,D,R,B){d.emplaceBack(s,u,2*Math.floor(y*Gn)+R,T*Gn*2,D*Gn*2,Math.round(B))}class no{constructor(s){this.zoom=s.zoom,this.globalState=s.globalState,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map(u=>u.id),this.index=s.index,this.hasPattern=!1,this.layoutVertexArray=new Xi,this.centroidVertexArray=new Kt,this.indexArray=new vo,this.programConfigurations=new zo(s.layers,s.zoom),this.segments=new lr,this.stateDependentLayerIds=this.layers.filter(u=>u.isStateDependent()).map(u=>u.id)}populate(s,u,y){this.features=[],this.hasPattern=cp("fill-extrusion",this.layers,u);for(let{feature:T,id:D,index:R,sourceLayerIndex:B}of s){let G=this.layers[0]._featureFilter.needGeometry,K=$h(T,G);if(!this.layers[0]._featureFilter.filter(new jo(this.zoom,{globalState:this.globalState}),K,y))continue;let Q={id:D,sourceLayerIndex:B,index:R,geometry:G?K.geometry:Cu(T),properties:T.properties,type:T.type,patterns:{}};this.hasPattern?this.features.push(ld("fill-extrusion",this.layers,Q,this.zoom,u)):this.addFeature(Q,Q.geometry,R,y,{},u.subdivisionGranularity),u.featureIndex.insert(T,Q.geometry,R,B,this.index,!0)}}addFeatures(s,u,y){for(let T of this.features){let{geometry:D}=T;this.addFeature(T,D,T.index,u,y,s.subdivisionGranularity)}}update(s,u,y){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(s,u,this.stateDependentLayers,y)}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(s){this.uploaded||(this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,ti),this.centroidVertexBuffer=s.createVertexBuffer(this.centroidVertexArray,Pt.members,!0),this.indexBuffer=s.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(s),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(s,u,y,T,D,R){for(let B of Js(u,500)){let G={x:0,y:0,sampleCount:0},K=this.layoutVertexArray.length;this.processPolygon(G,T,s,B,R);let Q=this.layoutVertexArray.length-K,ce=Math.floor(G.x/G.sampleCount),_e=Math.floor(G.y/G.sampleCount);for(let ve=0;ve<Q;ve++)this.centroidVertexArray.emplaceBack(ce,_e)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,s,y,D,T)}processPolygon(s,u,y,T,D){if(T.length<1||pr(T[0]))return;for(let ce of T)ce.length!==0&&En(s,ce);let R={segment:this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray)},B=D.fill.getGranularityForZoomLevel(u.z),G=zr[y.type]==="Polygon";for(let ce of T){if(ce.length===0||pr(ce))continue;let _e=Qe(ce,B,G);this._generateSideFaces(_e,R)}if(!G)return;let K=Ke(T,u,B,!1),Q=this.layoutVertexArray;gt((ce,_e)=>{po(Q,ce,_e,0,0,1,1,0)},this.segments,this.layoutVertexArray,this.indexArray,K.verticesFlattened,K.indicesTriangles)}_generateSideFaces(s,u){let y=0;for(let T=1;T<s.length;T++){let D=s[T],R=s[T-1];if(cr(D,R))continue;u.segment.vertexLength+4>lr.MAX_VERTEX_ARRAY_LENGTH&&(u.segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));let B=D.sub(R)._perp()._unit(),G=R.dist(D);y+G>32768&&(y=0),po(this.layoutVertexArray,D.x,D.y,B.x,B.y,0,0,y),po(this.layoutVertexArray,D.x,D.y,B.x,B.y,0,1,y),y+=G,po(this.layoutVertexArray,R.x,R.y,B.x,B.y,0,0,y),po(this.layoutVertexArray,R.x,R.y,B.x,B.y,0,1,y);let K=u.segment.vertexLength;this.indexArray.emplaceBack(K,K+2,K+1),this.indexArray.emplaceBack(K+1,K+2,K+3),u.segment.vertexLength+=4,u.segment.primitiveLength+=2}}}function En(d,s){for(let u=0;u<s.length;u++){let y=s[u];u===s.length-1&&s[0].x===y.x&&s[0].y===y.y||(d.x+=y.x,d.y+=y.y,d.sampleCount++)}}function cr(d,s){return d.x===s.x&&(d.x<0||d.x>Hr)||d.y===s.y&&(d.y<0||d.y>Hr)}function pr(d){return d.every(s=>s.x<0)||d.every(s=>s.x>Hr)||d.every(s=>s.y<0)||d.every(s=>s.y>Hr)}let Or;sn("FillExtrusionBucket",no,{omit:["layers","features"]});var xs={get paint(){return Or=Or||new Qs({"fill-extrusion-opacity":new pn(Ue["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new jn(Ue["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new pn(Ue["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new pn(Ue["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new gh(Ue["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new jn(Ue["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new jn(Ue["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new pn(Ue["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class Lo extends ds{constructor(s){super(s,xs)}createBucket(s){return new no(s)}queryRadius(){return gf(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature({queryGeometry:s,feature:u,featureState:y,geometry:T,transform:D,pixelsToTileUnits:R,pixelPosMatrix:B}){let G=yf(s,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),-D.bearingInRadians,R),K=this.paint.get("fill-extrusion-height").evaluate(u,y),Q=this.paint.get("fill-extrusion-base").evaluate(u,y),ce=function(ve,Te){let De=[];for(let Ye of ve){let lt=[Ye.x,Ye.y,0,1];ya(lt,lt,Te),De.push(new Wi(lt[0]/lt[3],lt[1]/lt[3]))}return De}(G,B),_e=function(ve,Te,De,Ye){let lt=[],Mt=[],yt=Ye[8]*Te,ye=Ye[9]*Te,Ze=Ye[10]*Te,bt=Ye[11]*Te,ni=Ye[8]*De,Ai=Ye[9]*De,ci=Ye[10]*De,gi=Ye[11]*De;for(let Fi of ve){let Mi=[],Zi=[];for(let bi of Fi){let fn=bi.x,Hn=bi.y,Nn=Ye[0]*fn+Ye[4]*Hn+Ye[12],Sn=Ye[1]*fn+Ye[5]*Hn+Ye[13],Zr=Ye[2]*fn+Ye[6]*Hn+Ye[14],zs=Ye[3]*fn+Ye[7]*Hn+Ye[15],Ea=Zr+Ze,il=zs+bt,ql=Nn+ni,$l=Sn+Ai,nl=Zr+ci,bs=zs+gi,da=new Wi((Nn+yt)/il,(Sn+ye)/il);da.z=Ea/il,Mi.push(da);let Va=new Wi(ql/bs,$l/bs);Va.z=nl/bs,Zi.push(Va)}lt.push(Mi),Mt.push(Zi)}return[lt,Mt]}(T,Q,K,B);return function(ve,Te,De){let Ye=1/0;Zf(De,Te)&&(Ye=ro(De,Te[0]));for(let lt=0;lt<Te.length;lt++){let Mt=Te[lt],yt=ve[lt];for(let ye=0;ye<Mt.length-1;ye++){let Ze=Mt[ye],bt=[Ze,Mt[ye+1],yt[ye+1],yt[ye],Ze];ap(De,bt)&&(Ye=Math.min(Ye,ro(De,bt)))}}return Ye!==1/0&&Ye}(_e[0],_e[1],ce)}}function ko(d,s){return d.x*s.x+d.y*s.y}function ro(d,s){if(d.length===1){let u=0,y=s[u++],T;for(;!T||y.equals(T);)if(T=s[u++],!T)return 1/0;for(;u<s.length;u++){let D=s[u],R=d[0],B=T.sub(y),G=D.sub(y),K=R.sub(y),Q=ko(B,B),ce=ko(B,G),_e=ko(G,G),ve=ko(K,B),Te=ko(K,G),De=Q*_e-ce*ce,Ye=(_e*ve-ce*Te)/De,lt=(Q*Te-ce*ve)/De,Mt=y.z*(1-Ye-lt)+T.z*Ye+D.z*lt;if(isFinite(Mt))return Mt}return 1/0}{let u=1/0;for(let y of s)u=Math.min(u,y.z);return u}}let Dn=ys([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:oo}=Dn,fr=ys([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:so}=fr,Sr=Er.VectorTileFeature.types,fo=Math.cos(Math.PI/180*37.5),js=Math.pow(2,14)/.5;class Gr{constructor(s){this.zoom=s.zoom,this.globalState=s.globalState,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map(u=>u.id),this.index=s.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(u=>{this.gradients[u.id]={}}),this.layoutVertexArray=new Ki,this.layoutVertexArray2=new Pi,this.indexArray=new vo,this.programConfigurations=new zo(s.layers,s.zoom),this.segments=new lr,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(u=>u.isStateDependent()).map(u=>u.id)}populate(s,u,y){this.hasPattern=cp("line",this.layers,u);let T=this.layers[0].layout.get("line-sort-key"),D=!T.isConstant(),R=[];for(let{feature:B,id:G,index:K,sourceLayerIndex:Q}of s){let ce=this.layers[0]._featureFilter.needGeometry,_e=$h(B,ce);if(!this.layers[0]._featureFilter.filter(new jo(this.zoom,{globalState:this.globalState}),_e,y))continue;let ve=D?T.evaluate(_e,{},y):void 0,Te={id:G,properties:B.properties,type:B.type,sourceLayerIndex:Q,index:K,geometry:ce?_e.geometry:Cu(B),patterns:{},sortKey:ve};R.push(Te)}D&&R.sort((B,G)=>B.sortKey-G.sortKey);for(let B of R){let{geometry:G,index:K,sourceLayerIndex:Q}=B;if(this.hasPattern){let ce=ld("line",this.layers,B,this.zoom,u);this.patternFeatures.push(ce)}else this.addFeature(B,G,K,y,{},u.subdivisionGranularity);u.featureIndex.insert(s[K].feature,G,K,Q,this.index)}}update(s,u,y){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(s,u,this.stateDependentLayers,y)}addFeatures(s,u,y){for(let T of this.patternFeatures)this.addFeature(T,T.geometry,T.index,u,y,s.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(s){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=s.createVertexBuffer(this.layoutVertexArray2,so)),this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,oo),this.indexBuffer=s.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(s),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(s){if(s.properties&&Object.prototype.hasOwnProperty.call(s.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(s.properties,"mapbox_clip_end"))return{start:+s.properties.mapbox_clip_start,end:+s.properties.mapbox_clip_end}}addFeature(s,u,y,T,D,R){let B=this.layers[0].layout,G=B.get("line-join").evaluate(s,{}),K=B.get("line-cap"),Q=B.get("line-miter-limit"),ce=B.get("line-round-limit");this.lineClips=this.lineFeatureClips(s);for(let _e of u)this.addLine(_e,s,G,K,Q,ce,T,R);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,s,y,D,T)}addLine(s,u,y,T,D,R,B,G){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,s=Qe(s,B?G.line.getGranularityForZoomLevel(B.z):1),this.lineClips){this.lineClipsArray.push(this.lineClips);for(let yt=0;yt<s.length-1;yt++)this.totalDistance+=s[yt].dist(s[yt+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}let K=Sr[u.type]==="Polygon",Q=s.length;for(;Q>=2&&s[Q-1].equals(s[Q-2]);)Q--;let ce=0;for(;ce<Q-1&&s[ce].equals(s[ce+1]);)ce++;if(Q<(K?3:2))return;y==="bevel"&&(D=1.05);let _e=this.overscaling<=16?122880/(512*this.overscaling):0,ve=this.segments.prepareSegment(10*Q,this.layoutVertexArray,this.indexArray),Te,De,Ye,lt,Mt;this.e1=this.e2=-1,K&&(Te=s[Q-2],Mt=s[ce].sub(Te)._unit()._perp());for(let yt=ce;yt<Q;yt++){if(Ye=yt===Q-1?K?s[ce+1]:void 0:s[yt+1],Ye&&s[yt].equals(Ye))continue;Mt&&(lt=Mt),Te&&(De=Te),Te=s[yt],Mt=Ye?Ye.sub(Te)._unit()._perp():lt,lt=lt||Mt;let ye=lt.add(Mt);ye.x===0&&ye.y===0||ye._unit();let Ze=lt.x*Mt.x+lt.y*Mt.y,bt=ye.x*Mt.x+ye.y*Mt.y,ni=bt!==0?1/bt:1/0,Ai=2*Math.sqrt(2-2*bt),ci=bt<fo&&De&&Ye,gi=lt.x*Mt.y-lt.y*Mt.x>0;if(ci&&yt>ce){let Zi=Te.dist(De);if(Zi>2*_e){let bi=Te.sub(Te.sub(De)._mult(_e/Zi)._round());this.updateDistance(De,bi),this.addCurrentVertex(bi,lt,0,0,ve),De=bi}}let Fi=De&&Ye,Mi=Fi?y:K?"butt":T;if(Fi&&Mi==="round"&&(ni<R?Mi="miter":ni<=2&&(Mi="fakeround")),Mi==="miter"&&ni>D&&(Mi="bevel"),Mi==="bevel"&&(ni>2&&(Mi="flipbevel"),ni<D&&(Mi="miter")),De&&this.updateDistance(De,Te),Mi==="miter")ye._mult(ni),this.addCurrentVertex(Te,ye,0,0,ve);else if(Mi==="flipbevel"){if(ni>100)ye=Mt.mult(-1);else{let Zi=ni*lt.add(Mt).mag()/lt.sub(Mt).mag();ye._perp()._mult(Zi*(gi?-1:1))}this.addCurrentVertex(Te,ye,0,0,ve),this.addCurrentVertex(Te,ye.mult(-1),0,0,ve)}else if(Mi==="bevel"||Mi==="fakeround"){let Zi=-Math.sqrt(ni*ni-1),bi=gi?Zi:0,fn=gi?0:Zi;if(De&&this.addCurrentVertex(Te,lt,bi,fn,ve),Mi==="fakeround"){let Hn=Math.round(180*Ai/Math.PI/20);for(let Nn=1;Nn<Hn;Nn++){let Sn=Nn/Hn;if(Sn!==.5){let zs=Sn-.5;Sn+=Sn*zs*(Sn-1)*((1.0904+Ze*(Ze*(3.55645-1.43519*Ze)-3.2452))*zs*zs+(.848013+Ze*(.215638*Ze-1.06021)))}let Zr=Mt.sub(lt)._mult(Sn)._add(lt)._unit()._mult(gi?-1:1);this.addHalfVertex(Te,Zr.x,Zr.y,!1,gi,0,ve)}}Ye&&this.addCurrentVertex(Te,Mt,-bi,-fn,ve)}else if(Mi==="butt")this.addCurrentVertex(Te,ye,0,0,ve);else if(Mi==="square"){let Zi=De?1:-1;this.addCurrentVertex(Te,ye,Zi,Zi,ve)}else Mi==="round"&&(De&&(this.addCurrentVertex(Te,lt,0,0,ve),this.addCurrentVertex(Te,lt,1,1,ve,!0)),Ye&&(this.addCurrentVertex(Te,Mt,-1,-1,ve,!0),this.addCurrentVertex(Te,Mt,0,0,ve)));if(ci&&yt<Q-1){let Zi=Te.dist(Ye);if(Zi>2*_e){let bi=Te.add(Ye.sub(Te)._mult(_e/Zi)._round());this.updateDistance(Te,bi),this.addCurrentVertex(bi,Mt,0,0,ve),Te=bi}}}}addCurrentVertex(s,u,y,T,D,R=!1){let B=u.y*T-u.x,G=-u.y-u.x*T;this.addHalfVertex(s,u.x+u.y*y,u.y-u.x*y,R,!1,y,D),this.addHalfVertex(s,B,G,R,!0,-T,D),this.distance>js/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(s,u,y,T,D,R))}addHalfVertex({x:s,y:u},y,T,D,R,B,G){let K=.5*(this.lineClips?this.scaledDistance*(js-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((s<<1)+(D?1:0),(u<<1)+(R?1:0),Math.round(63*y)+128,Math.round(63*T)+128,1+(B===0?0:B<0?-1:1)|(63&K)<<2,K>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);let Q=G.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,Q,this.e2),G.primitiveLength++),R?this.e2=Q:this.e1=Q}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(s,u){this.distance+=s.dist(u),this.updateScaledDistance()}}let ea,Xo;sn("LineBucket",Gr,{omit:["layers","patternFeatures"]});var ha={get paint(){return Xo=Xo||new Qs({"line-opacity":new jn(Ue.paint_line["line-opacity"]),"line-color":new jn(Ue.paint_line["line-color"]),"line-translate":new pn(Ue.paint_line["line-translate"]),"line-translate-anchor":new pn(Ue.paint_line["line-translate-anchor"]),"line-width":new jn(Ue.paint_line["line-width"]),"line-gap-width":new jn(Ue.paint_line["line-gap-width"]),"line-offset":new jn(Ue.paint_line["line-offset"]),"line-blur":new jn(Ue.paint_line["line-blur"]),"line-dasharray":new wu(Ue.paint_line["line-dasharray"]),"line-pattern":new gh(Ue.paint_line["line-pattern"]),"line-gradient":new Ei(Ue.paint_line["line-gradient"])})},get layout(){return ea=ea||new Qs({"line-cap":new pn(Ue.layout_line["line-cap"]),"line-join":new jn(Ue.layout_line["line-join"]),"line-miter-limit":new pn(Ue.layout_line["line-miter-limit"]),"line-round-limit":new pn(Ue.layout_line["line-round-limit"]),"line-sort-key":new jn(Ue.layout_line["line-sort-key"])})}};class wh extends jn{possiblyEvaluate(s,u){return u=new jo(Math.floor(u.zoom),{now:u.now,fadeDuration:u.fadeDuration,zoomHistory:u.zoomHistory,transition:u.transition}),super.possiblyEvaluate(s,u)}evaluate(s,u,y,T){return u=Os({},u,{zoom:Math.floor(u.zoom)}),super.evaluate(s,u,y,T)}}let Lc;class Zl extends ds{constructor(s){super(s,ha),this.gradientVersion=0,Lc||(Lc=new wh(ha.paint.properties["line-width"].specification),Lc.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(s){if(s==="line-gradient"){let u=this.gradientExpression();this.stepInterpolant=!!function(y){return y._styleExpression!==void 0}(u)&&u._styleExpression.expression instanceof Qc,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(s,u){super.recalculate(s,u),this.paint._values["line-floorwidth"]=Lc.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,s)}createBucket(s){return new Gr(s)}queryRadius(s){let u=s,y=fc(Hp("line-width",this,u),Hp("line-gap-width",this,u)),T=Hp("line-offset",this,u);return y/2+Math.abs(T)+gf(this.paint.get("line-translate"))}queryIntersectsFeature({queryGeometry:s,feature:u,featureState:y,geometry:T,transform:D,pixelsToTileUnits:R}){let B=yf(s,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),-D.bearingInRadians,R),G=R/2*fc(this.paint.get("line-width").evaluate(u,y),this.paint.get("line-gap-width").evaluate(u,y)),K=this.paint.get("line-offset").evaluate(u,y);return K&&(T=function(Q,ce){let _e=[];for(let ve=0;ve<Q.length;ve++){let Te=Q[ve],De=[];for(let Ye=0;Ye<Te.length;Ye++){let lt=Te[Ye-1],Mt=Te[Ye],yt=Te[Ye+1],ye=Ye===0?new Wi(0,0):Mt.sub(lt)._unit()._perp(),Ze=Ye===Te.length-1?new Wi(0,0):yt.sub(Mt)._unit()._perp(),bt=ye._add(Ze)._unit(),ni=bt.x*Ze.x+bt.y*Ze.y;ni!==0&&bt._mult(1/ni),De.push(bt._mult(ce)._add(Mt))}_e.push(De)}return _e}(T,K*R)),function(Q,ce,_e){for(let ve=0;ve<ce.length;ve++){let Te=ce[ve];if(Q.length>=3){for(let De=0;De<Te.length;De++)if(lp(Q,Te[De]))return!0}if(qf(Q,Te,_e))return!0}return!1}(B,T,G)}isTileClipped(){return!0}}function fc(d,s){return s>0?s+2*d:d}let Hh=ys([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Xh=ys([{name:"a_projected_pos",components:3,type:"Float32"}],4);ys([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);let Th=ys([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_box_real",components:2,type:"Int16"}]);ys([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);let up=ys([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),dp=ys([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function Kf(d,s,u){return d.sections.forEach(y=>{y.text=function(T,D,R){let B=D.layout.get("text-transform").evaluate(R,{});return B==="uppercase"?T=T.toLocaleUpperCase():B==="lowercase"&&(T=T.toLocaleLowerCase()),jh.applyArabicShaping&&(T=jh.applyArabicShaping(T)),T}(y.text,s,u)}),d}ys([{name:"triangle",components:3,type:"Uint16"}]),ys([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),ys([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),ys([{type:"Float32",name:"offsetX"}]),ys([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),ys([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);let hd={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42"};var wf,pp,Jr,vs=24,Tf={};function py(){return wf||(wf=1,Tf.read=function(d,s,u,y,T){var D,R,B=8*T-y-1,G=(1<<B)-1,K=G>>1,Q=-7,ce=u?T-1:0,_e=u?-1:1,ve=d[s+ce];for(ce+=_e,D=ve&(1<<-Q)-1,ve>>=-Q,Q+=B;Q>0;D=256*D+d[s+ce],ce+=_e,Q-=8);for(R=D&(1<<-Q)-1,D>>=-Q,Q+=y;Q>0;R=256*R+d[s+ce],ce+=_e,Q-=8);if(D===0)D=1-K;else{if(D===G)return R?NaN:1/0*(ve?-1:1);R+=Math.pow(2,y),D-=K}return(ve?-1:1)*R*Math.pow(2,D-y)},Tf.write=function(d,s,u,y,T,D){var R,B,G,K=8*D-T-1,Q=(1<<K)-1,ce=Q>>1,_e=T===23?Math.pow(2,-24)-Math.pow(2,-77):0,ve=y?0:D-1,Te=y?1:-1,De=s<0||s===0&&1/s<0?1:0;for(s=Math.abs(s),isNaN(s)||s===1/0?(B=isNaN(s)?1:0,R=Q):(R=Math.floor(Math.log(s)/Math.LN2),s*(G=Math.pow(2,-R))<1&&(R--,G*=2),(s+=R+ce>=1?_e/G:_e*Math.pow(2,1-ce))*G>=2&&(R++,G/=2),R+ce>=Q?(B=0,R=Q):R+ce>=1?(B=(s*G-1)*Math.pow(2,T),R+=ce):(B=s*Math.pow(2,ce-1)*Math.pow(2,T),R=0));T>=8;d[u+ve]=255&B,ve+=Te,B/=256,T-=8);for(R=R<<T|B,K+=T;K>0;d[u+ve]=255&R,ve+=Te,R/=256,K-=8);d[u+ve-Te]|=128*De}),Tf}function fy(){if(Jr)return pp;Jr=1,pp=s;var d=py();function s(ye){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(ye)?ye:new Uint8Array(ye||0),this.pos=0,this.type=0,this.length=this.buf.length}s.Varint=0,s.Fixed64=1,s.Bytes=2,s.Fixed32=5;var u=4294967296,y=1/u,T=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");function D(ye){return ye.type===s.Bytes?ye.readVarint()+ye.pos:ye.pos+1}function R(ye,Ze,bt){return bt?4294967296*Ze+(ye>>>0):4294967296*(Ze>>>0)+(ye>>>0)}function B(ye,Ze,bt){var ni=Ze<=16383?1:Ze<=2097151?2:Ze<=268435455?3:Math.floor(Math.log(Ze)/(7*Math.LN2));bt.realloc(ni);for(var Ai=bt.pos-1;Ai>=ye;Ai--)bt.buf[Ai+ni]=bt.buf[Ai]}function G(ye,Ze){for(var bt=0;bt<ye.length;bt++)Ze.writeVarint(ye[bt])}function K(ye,Ze){for(var bt=0;bt<ye.length;bt++)Ze.writeSVarint(ye[bt])}function Q(ye,Ze){for(var bt=0;bt<ye.length;bt++)Ze.writeFloat(ye[bt])}function ce(ye,Ze){for(var bt=0;bt<ye.length;bt++)Ze.writeDouble(ye[bt])}function _e(ye,Ze){for(var bt=0;bt<ye.length;bt++)Ze.writeBoolean(ye[bt])}function ve(ye,Ze){for(var bt=0;bt<ye.length;bt++)Ze.writeFixed32(ye[bt])}function Te(ye,Ze){for(var bt=0;bt<ye.length;bt++)Ze.writeSFixed32(ye[bt])}function De(ye,Ze){for(var bt=0;bt<ye.length;bt++)Ze.writeFixed64(ye[bt])}function Ye(ye,Ze){for(var bt=0;bt<ye.length;bt++)Ze.writeSFixed64(ye[bt])}function lt(ye,Ze){return(ye[Ze]|ye[Ze+1]<<8|ye[Ze+2]<<16)+16777216*ye[Ze+3]}function Mt(ye,Ze,bt){ye[bt]=Ze,ye[bt+1]=Ze>>>8,ye[bt+2]=Ze>>>16,ye[bt+3]=Ze>>>24}function yt(ye,Ze){return(ye[Ze]|ye[Ze+1]<<8|ye[Ze+2]<<16)+(ye[Ze+3]<<24)}return s.prototype={destroy:function(){this.buf=null},readFields:function(ye,Ze,bt){for(bt=bt||this.length;this.pos<bt;){var ni=this.readVarint(),Ai=ni>>3,ci=this.pos;this.type=7&ni,ye(Ai,Ze,this),this.pos===ci&&this.skip(ni)}return Ze},readMessage:function(ye,Ze){return this.readFields(ye,Ze,this.readVarint()+this.pos)},readFixed32:function(){var ye=lt(this.buf,this.pos);return this.pos+=4,ye},readSFixed32:function(){var ye=yt(this.buf,this.pos);return this.pos+=4,ye},readFixed64:function(){var ye=lt(this.buf,this.pos)+lt(this.buf,this.pos+4)*u;return this.pos+=8,ye},readSFixed64:function(){var ye=lt(this.buf,this.pos)+yt(this.buf,this.pos+4)*u;return this.pos+=8,ye},readFloat:function(){var ye=d.read(this.buf,this.pos,!0,23,4);return this.pos+=4,ye},readDouble:function(){var ye=d.read(this.buf,this.pos,!0,52,8);return this.pos+=8,ye},readVarint:function(ye){var Ze,bt,ni=this.buf;return Ze=127&(bt=ni[this.pos++]),bt<128?Ze:(Ze|=(127&(bt=ni[this.pos++]))<<7,bt<128?Ze:(Ze|=(127&(bt=ni[this.pos++]))<<14,bt<128?Ze:(Ze|=(127&(bt=ni[this.pos++]))<<21,bt<128?Ze:function(Ai,ci,gi){var Fi,Mi,Zi=gi.buf;if(Fi=(112&(Mi=Zi[gi.pos++]))>>4,Mi<128||(Fi|=(127&(Mi=Zi[gi.pos++]))<<3,Mi<128)||(Fi|=(127&(Mi=Zi[gi.pos++]))<<10,Mi<128)||(Fi|=(127&(Mi=Zi[gi.pos++]))<<17,Mi<128)||(Fi|=(127&(Mi=Zi[gi.pos++]))<<24,Mi<128)||(Fi|=(1&(Mi=Zi[gi.pos++]))<<31,Mi<128))return R(Ai,Fi,ci);throw new Error("Expected varint not more than 10 bytes")}(Ze|=(15&(bt=ni[this.pos]))<<28,ye,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var ye=this.readVarint();return ye%2==1?(ye+1)/-2:ye/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var ye=this.readVarint()+this.pos,Ze=this.pos;return this.pos=ye,ye-Ze>=12&&T?function(bt,ni,Ai){return T.decode(bt.subarray(ni,Ai))}(this.buf,Ze,ye):function(bt,ni,Ai){for(var ci="",gi=ni;gi<Ai;){var Fi,Mi,Zi,bi=bt[gi],fn=null,Hn=bi>239?4:bi>223?3:bi>191?2:1;if(gi+Hn>Ai)break;Hn===1?bi<128&&(fn=bi):Hn===2?(192&(Fi=bt[gi+1]))==128&&(fn=(31&bi)<<6|63&Fi)<=127&&(fn=null):Hn===3?(Mi=bt[gi+2],(192&(Fi=bt[gi+1]))==128&&(192&Mi)==128&&((fn=(15&bi)<<12|(63&Fi)<<6|63&Mi)<=2047||fn>=55296&&fn<=57343)&&(fn=null)):Hn===4&&(Mi=bt[gi+2],Zi=bt[gi+3],(192&(Fi=bt[gi+1]))==128&&(192&Mi)==128&&(192&Zi)==128&&((fn=(15&bi)<<18|(63&Fi)<<12|(63&Mi)<<6|63&Zi)<=65535||fn>=1114112)&&(fn=null)),fn===null?(fn=65533,Hn=1):fn>65535&&(fn-=65536,ci+=String.fromCharCode(fn>>>10&1023|55296),fn=56320|1023&fn),ci+=String.fromCharCode(fn),gi+=Hn}return ci}(this.buf,Ze,ye)},readBytes:function(){var ye=this.readVarint()+this.pos,Ze=this.buf.subarray(this.pos,ye);return this.pos=ye,Ze},readPackedVarint:function(ye,Ze){if(this.type!==s.Bytes)return ye.push(this.readVarint(Ze));var bt=D(this);for(ye=ye||[];this.pos<bt;)ye.push(this.readVarint(Ze));return ye},readPackedSVarint:function(ye){if(this.type!==s.Bytes)return ye.push(this.readSVarint());var Ze=D(this);for(ye=ye||[];this.pos<Ze;)ye.push(this.readSVarint());return ye},readPackedBoolean:function(ye){if(this.type!==s.Bytes)return ye.push(this.readBoolean());var Ze=D(this);for(ye=ye||[];this.pos<Ze;)ye.push(this.readBoolean());return ye},readPackedFloat:function(ye){if(this.type!==s.Bytes)return ye.push(this.readFloat());var Ze=D(this);for(ye=ye||[];this.pos<Ze;)ye.push(this.readFloat());return ye},readPackedDouble:function(ye){if(this.type!==s.Bytes)return ye.push(this.readDouble());var Ze=D(this);for(ye=ye||[];this.pos<Ze;)ye.push(this.readDouble());return ye},readPackedFixed32:function(ye){if(this.type!==s.Bytes)return ye.push(this.readFixed32());var Ze=D(this);for(ye=ye||[];this.pos<Ze;)ye.push(this.readFixed32());return ye},readPackedSFixed32:function(ye){if(this.type!==s.Bytes)return ye.push(this.readSFixed32());var Ze=D(this);for(ye=ye||[];this.pos<Ze;)ye.push(this.readSFixed32());return ye},readPackedFixed64:function(ye){if(this.type!==s.Bytes)return ye.push(this.readFixed64());var Ze=D(this);for(ye=ye||[];this.pos<Ze;)ye.push(this.readFixed64());return ye},readPackedSFixed64:function(ye){if(this.type!==s.Bytes)return ye.push(this.readSFixed64());var Ze=D(this);for(ye=ye||[];this.pos<Ze;)ye.push(this.readSFixed64());return ye},skip:function(ye){var Ze=7&ye;if(Ze===s.Varint)for(;this.buf[this.pos++]>127;);else if(Ze===s.Bytes)this.pos=this.readVarint()+this.pos;else if(Ze===s.Fixed32)this.pos+=4;else{if(Ze!==s.Fixed64)throw new Error("Unimplemented type: "+Ze);this.pos+=8}},writeTag:function(ye,Ze){this.writeVarint(ye<<3|Ze)},realloc:function(ye){for(var Ze=this.length||16;Ze<this.pos+ye;)Ze*=2;if(Ze!==this.length){var bt=new Uint8Array(Ze);bt.set(this.buf),this.buf=bt,this.length=Ze}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(ye){this.realloc(4),Mt(this.buf,ye,this.pos),this.pos+=4},writeSFixed32:function(ye){this.realloc(4),Mt(this.buf,ye,this.pos),this.pos+=4},writeFixed64:function(ye){this.realloc(8),Mt(this.buf,-1&ye,this.pos),Mt(this.buf,Math.floor(ye*y),this.pos+4),this.pos+=8},writeSFixed64:function(ye){this.realloc(8),Mt(this.buf,-1&ye,this.pos),Mt(this.buf,Math.floor(ye*y),this.pos+4),this.pos+=8},writeVarint:function(ye){(ye=+ye||0)>268435455||ye<0?function(Ze,bt){var ni,Ai;if(Ze>=0?(ni=Ze%4294967296|0,Ai=Ze/4294967296|0):(Ai=~(-Ze/4294967296),4294967295^(ni=~(-Ze%4294967296))?ni=ni+1|0:(ni=0,Ai=Ai+1|0)),Ze>=18446744073709552e3||Ze<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");bt.realloc(10),function(ci,gi,Fi){Fi.buf[Fi.pos++]=127&ci|128,ci>>>=7,Fi.buf[Fi.pos++]=127&ci|128,ci>>>=7,Fi.buf[Fi.pos++]=127&ci|128,ci>>>=7,Fi.buf[Fi.pos++]=127&ci|128,Fi.buf[Fi.pos]=127&(ci>>>=7)}(ni,0,bt),function(ci,gi){var Fi=(7&ci)<<4;gi.buf[gi.pos++]|=Fi|((ci>>>=3)?128:0),ci&&(gi.buf[gi.pos++]=127&ci|((ci>>>=7)?128:0),ci&&(gi.buf[gi.pos++]=127&ci|((ci>>>=7)?128:0),ci&&(gi.buf[gi.pos++]=127&ci|((ci>>>=7)?128:0),ci&&(gi.buf[gi.pos++]=127&ci|((ci>>>=7)?128:0),ci&&(gi.buf[gi.pos++]=127&ci)))))}(Ai,bt)}(ye,this):(this.realloc(4),this.buf[this.pos++]=127&ye|(ye>127?128:0),ye<=127||(this.buf[this.pos++]=127&(ye>>>=7)|(ye>127?128:0),ye<=127||(this.buf[this.pos++]=127&(ye>>>=7)|(ye>127?128:0),ye<=127||(this.buf[this.pos++]=ye>>>7&127))))},writeSVarint:function(ye){this.writeVarint(ye<0?2*-ye-1:2*ye)},writeBoolean:function(ye){this.writeVarint(!!ye)},writeString:function(ye){ye=String(ye),this.realloc(4*ye.length),this.pos++;var Ze=this.pos;this.pos=function(ni,Ai,ci){for(var gi,Fi,Mi=0;Mi<Ai.length;Mi++){if((gi=Ai.charCodeAt(Mi))>55295&&gi<57344){if(!Fi){gi>56319||Mi+1===Ai.length?(ni[ci++]=239,ni[ci++]=191,ni[ci++]=189):Fi=gi;continue}if(gi<56320){ni[ci++]=239,ni[ci++]=191,ni[ci++]=189,Fi=gi;continue}gi=Fi-55296<<10|gi-56320|65536,Fi=null}else Fi&&(ni[ci++]=239,ni[ci++]=191,ni[ci++]=189,Fi=null);gi<128?ni[ci++]=gi:(gi<2048?ni[ci++]=gi>>6|192:(gi<65536?ni[ci++]=gi>>12|224:(ni[ci++]=gi>>18|240,ni[ci++]=gi>>12&63|128),ni[ci++]=gi>>6&63|128),ni[ci++]=63&gi|128)}return ci}(this.buf,ye,this.pos);var bt=this.pos-Ze;bt>=128&&B(Ze,bt,this),this.pos=Ze-1,this.writeVarint(bt),this.pos+=bt},writeFloat:function(ye){this.realloc(4),d.write(this.buf,ye,this.pos,!0,23,4),this.pos+=4},writeDouble:function(ye){this.realloc(8),d.write(this.buf,ye,this.pos,!0,52,8),this.pos+=8},writeBytes:function(ye){var Ze=ye.length;this.writeVarint(Ze),this.realloc(Ze);for(var bt=0;bt<Ze;bt++)this.buf[this.pos++]=ye[bt]},writeRawMessage:function(ye,Ze){this.pos++;var bt=this.pos;ye(Ze,this);var ni=this.pos-bt;ni>=128&&B(bt,ni,this),this.pos=bt-1,this.writeVarint(ni),this.pos+=ni},writeMessage:function(ye,Ze,bt){this.writeTag(ye,s.Bytes),this.writeRawMessage(Ze,bt)},writePackedVarint:function(ye,Ze){Ze.length&&this.writeMessage(ye,G,Ze)},writePackedSVarint:function(ye,Ze){Ze.length&&this.writeMessage(ye,K,Ze)},writePackedBoolean:function(ye,Ze){Ze.length&&this.writeMessage(ye,_e,Ze)},writePackedFloat:function(ye,Ze){Ze.length&&this.writeMessage(ye,Q,Ze)},writePackedDouble:function(ye,Ze){Ze.length&&this.writeMessage(ye,ce,Ze)},writePackedFixed32:function(ye,Ze){Ze.length&&this.writeMessage(ye,ve,Ze)},writePackedSFixed32:function(ye,Ze){Ze.length&&this.writeMessage(ye,Te,Ze)},writePackedFixed64:function(ye,Ze){Ze.length&&this.writeMessage(ye,De,Ze)},writePackedSFixed64:function(ye,Ze){Ze.length&&this.writeMessage(ye,Ye,Ze)},writeBytesField:function(ye,Ze){this.writeTag(ye,s.Bytes),this.writeBytes(Ze)},writeFixed32Field:function(ye,Ze){this.writeTag(ye,s.Fixed32),this.writeFixed32(Ze)},writeSFixed32Field:function(ye,Ze){this.writeTag(ye,s.Fixed32),this.writeSFixed32(Ze)},writeFixed64Field:function(ye,Ze){this.writeTag(ye,s.Fixed64),this.writeFixed64(Ze)},writeSFixed64Field:function(ye,Ze){this.writeTag(ye,s.Fixed64),this.writeSFixed64(Ze)},writeVarintField:function(ye,Ze){this.writeTag(ye,s.Varint),this.writeVarint(Ze)},writeSVarintField:function(ye,Ze){this.writeTag(ye,s.Varint),this.writeSVarint(Ze)},writeStringField:function(ye,Ze){this.writeTag(ye,s.Bytes),this.writeString(Ze)},writeFloatField:function(ye,Ze){this.writeTag(ye,s.Fixed32),this.writeFloat(Ze)},writeDoubleField:function(ye,Ze){this.writeTag(ye,s.Fixed64),this.writeDouble(Ze)},writeBooleanField:function(ye,Ze){this.writeVarintField(ye,!!Ze)}},pp}var ud,Kh=at(fy());function fp(d,s,u){d===1&&u.readMessage(my,s)}function my(d,s,u){if(d===3){let{id:y,bitmap:T,width:D,height:R,left:B,top:G,advance:K}=u.readMessage(_y,{});s.push({id:y,bitmap:new Xp({width:D+6,height:R+6},T),metrics:{width:D,height:R,left:B,top:G,advance:K}})}}function _y(d,s,u){d===1?s.id=u.readVarint():d===2?s.bitmap=u.readBytes():d===3?s.width=u.readVarint():d===4?s.height=u.readVarint():d===5?s.left=u.readSVarint():d===6?s.top=u.readSVarint():d===7&&(s.advance=u.readVarint())}function Vm(d){let s=0,u=0;for(let R of d)s+=R.w*R.h,u=Math.max(u,R.w);d.sort((R,B)=>B.h-R.h);let y=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(s/.95)),u),h:1/0}],T=0,D=0;for(let R of d)for(let B=y.length-1;B>=0;B--){let G=y[B];if(!(R.w>G.w||R.h>G.h)){if(R.x=G.x,R.y=G.y,D=Math.max(D,R.y+R.h),T=Math.max(T,R.x+R.w),R.w===G.w&&R.h===G.h){let K=y.pop();B<y.length&&(y[B]=K)}else R.h===G.h?(G.x+=R.w,G.w-=R.w):R.w===G.w?(G.y+=R.h,G.h-=R.h):(y.push({x:G.x+R.w,y:G.y,w:G.w-R.w,h:R.h}),G.y+=R.h,G.h-=R.h);break}}return{w:T,h:D,fill:s/(T*D)||0}}class Um{constructor(s,{pixelRatio:u,version:y,stretchX:T,stretchY:D,content:R,textFitWidth:B,textFitHeight:G}){this.paddedRect=s,this.pixelRatio=u,this.stretchX=T,this.stretchY=D,this.content=R,this.version=y,this.textFitWidth=B,this.textFitHeight=G}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class Yf{constructor(s,u){let y={},T={};this.haveRenderCallbacks=[];let D=[];this.addImages(s,y,D),this.addImages(u,T,D);let{w:R,h:B}=Vm(D),G=new Ba({width:R||1,height:B||1});for(let K in s){let Q=s[K],ce=y[K].paddedRect;Ba.copy(Q.data,G,{x:0,y:0},{x:ce.x+1,y:ce.y+1},Q.data)}for(let K in u){let Q=u[K],ce=T[K].paddedRect,_e=ce.x+1,ve=ce.y+1,Te=Q.data.width,De=Q.data.height;Ba.copy(Q.data,G,{x:0,y:0},{x:_e,y:ve},Q.data),Ba.copy(Q.data,G,{x:0,y:De-1},{x:_e,y:ve-1},{width:Te,height:1}),Ba.copy(Q.data,G,{x:0,y:0},{x:_e,y:ve+De},{width:Te,height:1}),Ba.copy(Q.data,G,{x:Te-1,y:0},{x:_e-1,y:ve},{width:1,height:De}),Ba.copy(Q.data,G,{x:0,y:0},{x:_e+Te,y:ve},{width:1,height:De})}this.image=G,this.iconPositions=y,this.patternPositions=T}addImages(s,u,y){for(let T in s){let D=s[T],R={x:0,y:0,w:D.data.width+2,h:D.data.height+2};y.push(R),u[T]=new Um(R,D),D.hasRenderCallback&&this.haveRenderCallbacks.push(T)}}patchUpdatedImages(s,u){s.dispatchRenderCallbacks(this.haveRenderCallbacks);for(let y in s.updatedImages)this.patchUpdatedImage(this.iconPositions[y],s.getImage(y),u),this.patchUpdatedImage(this.patternPositions[y],s.getImage(y),u)}patchUpdatedImage(s,u,y){if(!s||!u||s.version===u.version)return;s.version=u.version;let[T,D]=s.tl;y.update(u.data,void 0,{x:T,y:D})}}sn("ImagePosition",Um),sn("ImageAtlas",Yf),O.an=void 0,(ud=O.an||(O.an={}))[ud.none=0]="none",ud[ud.horizontal=1]="horizontal",ud[ud.vertical=2]="vertical",ud[ud.horizontalOnly=3]="horizontalOnly";class Jp{constructor(){this.scale=1,this.fontStack="",this.imageName=null,this.verticalAlign="bottom"}static forText(s,u,y){let T=new Jp;return T.scale=s||1,T.fontStack=u,T.verticalAlign=y||"bottom",T}static forImage(s,u){let y=new Jp;return y.imageName=s,y.verticalAlign=u||"bottom",y}}class Sf{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(s,u){let y=new Sf;for(let T=0;T<s.sections.length;T++){let D=s.sections[T];D.image?y.addImageSection(D):y.addTextSection(D,u)}return y}length(){return this.text.length}getSection(s){return this.sections[this.sectionIndex[s]]}getSectionIndex(s){return this.sectionIndex[s]}getCharCode(s){return this.text.charCodeAt(s)}verticalizePunctuation(){this.text=function(s){let u="";for(let y=0;y<s.length;y++){let T=s.charCodeAt(y+1)||null,D=s.charCodeAt(y-1)||null;u+=T&&ed(T)&&!hd[s[y+1]]||D&&ed(D)&&!hd[s[y-1]]||!hd[s[y]]?s[y]:hd[s[y]]}return u}(this.text)}trim(){let s=0;for(let y=0;y<this.text.length&&Jf[this.text.charCodeAt(y)];y++)s++;let u=this.text.length;for(let y=this.text.length-1;y>=0&&y>=s&&Jf[this.text.charCodeAt(y)];y--)u--;this.text=this.text.substring(s,u),this.sectionIndex=this.sectionIndex.slice(s,u)}substring(s,u){let y=new Sf;return y.text=this.text.substring(s,u),y.sectionIndex=this.sectionIndex.slice(s,u),y.sections=this.sections,y}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((s,u)=>Math.max(s,this.sections[u].scale),0)}getMaxImageSize(s){let u=0,y=0;for(let T=0;T<this.length();T++){let D=this.getSection(T);if(D.imageName){let R=s[D.imageName];if(!R)continue;let B=R.displaySize;u=Math.max(u,B[0]),y=Math.max(y,B[1])}}return{maxImageWidth:u,maxImageHeight:y}}addTextSection(s,u){this.text+=s.text,this.sections.push(Jp.forText(s.scale,s.fontStack||u,s.verticalAlign));let y=this.sections.length-1;for(let T=0;T<s.text.length;++T)this.sectionIndex.push(y)}addImageSection(s){let u=s.image?s.image.name:"";if(u.length===0)return void Jo("Can't add FormattedSection with an empty image.");let y=this.getNextImageSectionCharCode();y?(this.text+=String.fromCharCode(y),this.sections.push(Jp.forImage(u,s.verticalAlign)),this.sectionIndex.push(this.sections.length-1)):Jo("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function If(d,s,u,y,T,D,R,B,G,K,Q,ce,_e,ve,Te){let De=Sf.fromFeature(d,T),Ye;ce===O.an.vertical&&De.verticalizePunctuation();let{processBidirectionalText:lt,processStyledBidirectionalText:Mt}=jh;if(lt&&De.sections.length===1){Ye=[];let Ze=lt(De.toString(),ug(De,K,D,s,y,ve));for(let bt of Ze){let ni=new Sf;ni.text=bt,ni.sections=De.sections;for(let Ai=0;Ai<bt.length;Ai++)ni.sectionIndex.push(0);Ye.push(ni)}}else if(Mt){Ye=[];let Ze=Mt(De.text,De.sectionIndex,ug(De,K,D,s,y,ve));for(let bt of Ze){let ni=new Sf;ni.text=bt[0],ni.sectionIndex=bt[1],ni.sections=De.sections,Ye.push(ni)}}else Ye=function(Ze,bt){let ni=[],Ai=Ze.text,ci=0;for(let gi of bt)ni.push(Ze.substring(ci,gi)),ci=gi;return ci<Ai.length&&ni.push(Ze.substring(ci,Ai.length)),ni}(De,ug(De,K,D,s,y,ve));let yt=[],ye={positionedLines:yt,text:De.toString(),top:Q[1],bottom:Q[1],left:Q[0],right:Q[0],writingMode:ce,iconsInText:!1,verticalizable:!1};return function(Ze,bt,ni,Ai,ci,gi,Fi,Mi,Zi,bi,fn,Hn){let Nn=0,Sn=0,Zr=0,zs=0,Ea=Mi==="right"?1:Mi==="left"?0:.5,il=vs/Hn,ql=0;for(let bs of ci){bs.trim();let da=bs.getMaxScale(),Va={positionedGlyphs:[],lineOffset:0};Ze.positionedLines[ql]=Va;let Ua=Va.positionedGlyphs,wl=0;if(!bs.length()){Sn+=gi,++ql;continue}let Oc=X0(Ai,bs,il);for(let _c=0;_c<bs.length();_c++){let pa=bs.getSection(_c),Pa=bs.getSectionIndex(_c),Ts=bs.getCharCode(_c),ta=xy(Zi,fn,Ts),ns;if(pa.imageName){if(Ze.iconsInText=!0,pa.scale=pa.scale*il,ns=vy(pa,ta,da,Oc,Ai),!ns)continue;wl=Math.max(wl,ns.imageOffset)}else if(ns=K0(pa,Ts,ta,Oc,bt,ni),!ns)continue;let{rect:Jh,metrics:wp,baselineOffset:Mu}=ns;Ua.push({glyph:Ts,imageName:pa.imageName,x:Nn,y:Sn+Mu+-17,vertical:ta,scale:pa.scale,fontStack:pa.fontStack,sectionIndex:Pa,metrics:wp,rect:Jh}),ta?(Ze.verticalizable=!0,Nn+=(pa.imageName?wp.advance:vs)*pa.scale+bi):Nn+=wp.advance*pa.scale+bi}Ua.length!==0&&(Zr=Math.max(Nn-bi,Zr),Y0(Ua,0,Ua.length-1,Ea)),Nn=0,Va.lineOffset=Math.max(wl,(da-1)*vs);let Ma=gi*da+wl;Sn+=Ma,zs=Math.max(Ma,zs),++ql}let{horizontalAlign:$l,verticalAlign:nl}=dg(Fi);(function(bs,da,Va,Ua,wl,Oc,Ma,_c,pa){let Pa=(da-Va)*wl,Ts=0;Ts=Oc!==Ma?-_c*Ua- -17:-Ua*pa*Ma+.5*Ma;for(let ta of bs)for(let ns of ta.positionedGlyphs)ns.x+=Pa,ns.y+=Ts})(Ze.positionedLines,Ea,$l,nl,Zr,zs,gi,Sn,ci.length),Ze.top+=-nl*Sn,Ze.bottom=Ze.top+Sn,Ze.left+=-$l*Zr,Ze.right=Ze.left+Zr}(ye,s,u,y,Ye,R,B,G,ce,K,_e,Te),!function(Ze){for(let bt of Ze)if(bt.positionedGlyphs.length!==0)return!1;return!0}(yt)&&ye}let Jf={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},lg={10:!0,32:!0,38:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0},gy={40:!0};function cg(d,s,u,y,T,D){if(s.imageName){let R=y[s.imageName];return R?R.displaySize[0]*s.scale*vs/D+T:0}{let R=u[s.fontStack],B=R&&R[d];return B?B.metrics.advance*s.scale+T:0}}function mp(d,s,u,y){let T=Math.pow(d-s,2);return y?d<s?T/2:2*T:T+Math.abs(u)*u}function yy(d,s,u){let y=0;return d===10&&(y-=1e4),u&&(y+=150),d!==40&&d!==65288||(y+=50),s!==41&&s!==65289||(y+=50),y}function p_(d,s,u,y,T,D){let R=null,B=mp(s,u,T,D);for(let G of y){let K=mp(s-G.x,u,T,D)+G.badness;K<=B&&(R=G,B=K)}return{index:d,x:s,priorBreak:R,badness:B}}function hg(d){return d?hg(d.priorBreak).concat(d.index):[]}function ug(d,s,u,y,T,D){if(!d)return[];let R=[],B=function(ce,_e,ve,Te,De,Ye){let lt=0;for(let Mt=0;Mt<ce.length();Mt++){let yt=ce.getSection(Mt);lt+=cg(ce.getCharCode(Mt),yt,Te,De,_e,Ye)}return lt/Math.max(1,Math.ceil(lt/ve))}(d,s,u,y,T,D),G=d.text.indexOf("\u200B")>=0,K=0;for(let ce=0;ce<d.length();ce++){let _e=d.getSection(ce),ve=d.getCharCode(ce);if(Jf[ve]||(K+=cg(ve,_e,y,T,s,D)),ce<d.length()-1){let Te=!((Q=ve)<11904)&&(!!ar["CJK Compatibility Forms"](Q)||!!ar["CJK Compatibility"](Q)||!!ar["CJK Strokes"](Q)||!!ar["CJK Symbols and Punctuation"](Q)||!!ar["Enclosed CJK Letters and Months"](Q)||!!ar["Halfwidth and Fullwidth Forms"](Q)||!!ar["Ideographic Description Characters"](Q)||!!ar["Vertical Forms"](Q)||Qu.test(String.fromCodePoint(Q)));(lg[ve]||Te||_e.imageName||ce!==d.length()-2&&gy[d.getCharCode(ce+1)])&&R.push(p_(ce+1,K,B,R,yy(ve,d.getCharCode(ce+1),Te&&G),!1))}}var Q;return hg(p_(d.length(),K,B,R,0,!0))}function dg(d){let s=.5,u=.5;switch(d){case"right":case"top-right":case"bottom-right":s=1;break;case"left":case"top-left":case"bottom-left":s=0}switch(d){case"bottom":case"bottom-right":case"bottom-left":u=1;break;case"top":case"top-right":case"top-left":u=0}return{horizontalAlign:s,verticalAlign:u}}function X0(d,s,u){let y=s.getMaxScale()*vs,{maxImageWidth:T,maxImageHeight:D}=s.getMaxImageSize(d),R=Math.max(y,D*u);return{verticalLineContentWidth:Math.max(y,T*u),horizontalLineContentHeight:R}}function pg(d){switch(d){case"top":return 0;case"center":return .5;default:return 1}}function xy(d,s,u){return!(d===O.an.horizontal||!s&&!Kd(u)||s&&(Jf[u]||(y=u,new RegExp("\\p{sc=Arab}","u").test(String.fromCodePoint(y)))));var y}function K0(d,s,u,y,T,D){let R=D[d.fontStack],B=function(K,Q,ce,_e){if(K&&K.rect)return K;let ve=Q[ce.fontStack],Te=ve&&ve[_e];return Te?{rect:null,metrics:Te.metrics}:null}(R&&R[s],T,d,s);if(B===null)return null;let G;if(u)G=y.verticalLineContentWidth-d.scale*vs;else{let K=pg(d.verticalAlign);G=(y.horizontalLineContentHeight-d.scale*vs)*K}return{rect:B.rect,metrics:B.metrics,baselineOffset:G}}function vy(d,s,u,y,T){let D=T[d.imageName];if(!D)return null;let R=D.paddedRect,B=D.displaySize,G={width:B[0],height:B[1],left:1,top:-3,advance:s?B[1]:B[0]},K;if(s)K=y.verticalLineContentWidth-B[1]*d.scale;else{let Q=pg(d.verticalAlign);K=(y.horizontalLineContentHeight-B[1]*d.scale)*Q}return{rect:R,metrics:G,baselineOffset:K,imageOffset:(s?B[0]:B[1])*d.scale-vs*u}}function Y0(d,s,u,y){if(y===0)return;let T=d[u],D=(d[u].x+T.metrics.advance*T.scale)*y;for(let R=s;R<=u;R++)d[R].x-=D}function J0(d,s,u){let{horizontalAlign:y,verticalAlign:T}=dg(u),D=s[0]-d.displaySize[0]*y,R=s[1]-d.displaySize[1]*T;return{image:d,top:R,bottom:R+d.displaySize[1],left:D,right:D+d.displaySize[0]}}function fg(d){var s,u;let y=d.left,T=d.top,D=d.right-y,R=d.bottom-T,B=(s=d.image.textFitWidth)!==null&&s!==void 0?s:"stretchOrShrink",G=(u=d.image.textFitHeight)!==null&&u!==void 0?u:"stretchOrShrink",K=(d.image.content[2]-d.image.content[0])/(d.image.content[3]-d.image.content[1]);if(G==="proportional"){if(B==="stretchOnly"&&D/R<K||B==="proportional"){let Q=Math.ceil(R*K);y*=Q/D,D=Q}}else if(B==="proportional"&&G==="stretchOnly"&&K!==0&&D/R>K){let Q=Math.ceil(D/K);T*=Q/R,R=Q}return{x1:y,y1:T,x2:y+D,y2:T+R}}function mg(d,s,u,y,T,D){let R=d.image,B;if(R.content){let Ye=R.content,lt=R.pixelRatio||1;B=[Ye[0]/lt,Ye[1]/lt,R.displaySize[0]-Ye[2]/lt,R.displaySize[1]-Ye[3]/lt]}let G=s.left*D,K=s.right*D,Q,ce,_e,ve;u==="width"||u==="both"?(ve=T[0]+G-y[3],ce=T[0]+K+y[1]):(ve=T[0]+(G+K-R.displaySize[0])/2,ce=ve+R.displaySize[0]);let Te=s.top*D,De=s.bottom*D;return u==="height"||u==="both"?(Q=T[1]+Te-y[0],_e=T[1]+De+y[2]):(Q=T[1]+(Te+De-R.displaySize[1])/2,_e=Q+R.displaySize[1]),{image:R,top:Q,right:ce,bottom:_e,left:ve,collisionPadding:B}}let dd=128,_p=32640;function _g(d,s){let{expression:u}=s;if(u.kind==="constant")return{kind:"constant",layoutSize:u.evaluate(new jo(d+1))};if(u.kind==="source")return{kind:"source"};{let{zoomStops:y,interpolationType:T}=u,D=0;for(;D<y.length&&y[D]<=d;)D++;D=Math.max(0,D-1);let R=D;for(;R<y.length&&y[R]<d+1;)R++;R=Math.min(y.length-1,R);let B=y[D],G=y[R];return u.kind==="composite"?{kind:"composite",minZoom:B,maxZoom:G,interpolationType:T}:{kind:"camera",minZoom:B,maxZoom:G,minSize:u.evaluate(new jo(B)),maxSize:u.evaluate(new jo(G)),interpolationType:T}}}function f_(d,s,u){let y="never",T=d.get(s);return T?y=T:d.get(u)&&(y="always"),y}let by=Er.VectorTileFeature.types,gg=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Eu(d,s,u,y,T,D,R,B,G,K,Q,ce,_e){let ve=B?Math.min(_p,Math.round(B[0])):0,Te=B?Math.min(_p,Math.round(B[1])):0;d.emplaceBack(s,u,Math.round(32*y),Math.round(32*T),D,R,(ve<<1)+(G?1:0),Te,16*K,16*Q,256*ce,256*_e)}function ua(d,s,u){d.emplaceBack(s.x,s.y,u),d.emplaceBack(s.x,s.y,u),d.emplaceBack(s.x,s.y,u),d.emplaceBack(s.x,s.y,u)}function wy(d){for(let s of d.sections)if(Yd(s.text))return!0;return!1}class Cf{constructor(s){this.layoutVertexArray=new xr,this.indexArray=new vo,this.programConfigurations=s,this.segments=new lr,this.dynamicLayoutVertexArray=new Kr,this.opacityVertexArray=new Ho,this.hasVisibleVertices=!1,this.placedSymbolArray=new et}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(s,u,y,T){this.isEmpty()||(y&&(this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,Hh.members),this.indexBuffer=s.createIndexBuffer(this.indexArray,u),this.dynamicLayoutVertexBuffer=s.createVertexBuffer(this.dynamicLayoutVertexArray,Xh.members,!0),this.opacityVertexBuffer=s.createVertexBuffer(this.opacityVertexArray,gg,!0),this.opacityVertexBuffer.itemSize=1),(y||T)&&this.programConfigurations.upload(s))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}sn("SymbolBuffers",Cf);class yg{constructor(s,u,y){this.layoutVertexArray=new s,this.layoutAttributes=u,this.indexArray=new y,this.segments=new lr,this.collisionVertexArray=new Go}upload(s){this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=s.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=s.createVertexBuffer(this.collisionVertexArray,Th.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}sn("CollisionBuffers",yg);class Qf{constructor(s){this.collisionBoxArray=s.collisionBoxArray,this.zoom=s.zoom,this.globalState=s.globalState,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map(R=>R.id),this.index=s.index,this.pixelRatio=s.pixelRatio,this.sourceLayerIndex=s.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[];let u=this.layers[0]._unevaluatedLayout._values;this.textSizeData=_g(this.zoom,u["text-size"]),this.iconSizeData=_g(this.zoom,u["icon-size"]);let y=this.layers[0].layout,T=y.get("symbol-sort-key"),D=y.get("symbol-z-order");this.canOverlap=f_(y,"text-overlap","text-allow-overlap")!=="never"||f_(y,"icon-overlap","icon-allow-overlap")!=="never"||y.get("text-ignore-placement")||y.get("icon-ignore-placement"),this.sortFeaturesByKey=D!=="viewport-y"&&!T.isConstant(),this.sortFeaturesByY=(D==="viewport-y"||D==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,y.get("symbol-placement")==="point"&&(this.writingModes=y.get("text-writing-mode").map(R=>O.an[R])),this.stateDependentLayerIds=this.layers.filter(R=>R.isStateDependent()).map(R=>R.id),this.sourceID=s.sourceID}createArrays(){this.text=new Cf(new zo(this.layers,this.zoom,s=>/^text/.test(s))),this.icon=new Cf(new zo(this.layers,this.zoom,s=>/^icon/.test(s))),this.glyphOffsetArray=new ft,this.lineVertexArray=new dt,this.symbolInstances=new Be,this.textAnchorOffsets=new pt}calculateGlyphDependencies(s,u,y,T,D){for(let R=0;R<s.length;R++)if(u[s.charCodeAt(R)]=!0,(y||T)&&D){let B=hd[s.charAt(R)];B&&(u[B.charCodeAt(0)]=!0)}}populate(s,u,y){let T=this.layers[0],D=T.layout,R=D.get("text-font"),B=D.get("text-field"),G=D.get("icon-image"),K=(B.value.kind!=="constant"||B.value.value instanceof Xs&&!B.value.value.isEmpty()||B.value.value.toString().length>0)&&(R.value.kind!=="constant"||R.value.value.length>0),Q=G.value.kind!=="constant"||!!G.value.value||Object.keys(G.parameters).length>0,ce=D.get("symbol-sort-key");if(this.features=[],!K&&!Q)return;let _e=u.iconDependencies,ve=u.glyphDependencies,Te=u.availableImages,De=new jo(this.zoom,{globalState:this.globalState});for(let{feature:Ye,id:lt,index:Mt,sourceLayerIndex:yt}of s){let ye=T._featureFilter.needGeometry,Ze=$h(Ye,ye);if(!T._featureFilter.filter(De,Ze,y))continue;let bt,ni;if(ye||(Ze.geometry=Cu(Ye)),K){let ci=T.getValueAndResolveTokens("text-field",Ze,y,Te),gi=Xs.factory(ci),Fi=this.hasRTLText=this.hasRTLText||wy(gi);(!Fi||jh.getRTLTextPluginStatus()==="unavailable"||Fi&&jh.isParsed())&&(bt=Kf(gi,T,Ze))}if(Q){let ci=T.getValueAndResolveTokens("icon-image",Ze,y,Te);ni=ci instanceof As?ci:As.fromString(ci)}if(!bt&&!ni)continue;let Ai=this.sortFeaturesByKey?ce.evaluate(Ze,{},y):void 0;if(this.features.push({id:lt,text:bt,icon:ni,index:Mt,sourceLayerIndex:yt,geometry:Ze.geometry,properties:Ye.properties,type:by[Ye.type],sortKey:Ai}),ni&&(_e[ni.name]=!0),bt){let ci=R.evaluate(Ze,{},y).join(","),gi=D.get("text-rotation-alignment")!=="viewport"&&D.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(O.an.vertical)>=0;for(let Fi of bt.sections)if(Fi.image)_e[Fi.image.name]=!0;else{let Mi=Wd(bt.toString()),Zi=Fi.fontStack||ci,bi=ve[Zi]=ve[Zi]||{};this.calculateGlyphDependencies(Fi.text,bi,gi,this.allowVerticalPlacement,Mi)}}}D.get("symbol-placement")==="line"&&(this.features=function(Ye){let lt={},Mt={},yt=[],ye=0;function Ze(ci){yt.push(Ye[ci]),ye++}function bt(ci,gi,Fi){let Mi=Mt[ci];return delete Mt[ci],Mt[gi]=Mi,yt[Mi].geometry[0].pop(),yt[Mi].geometry[0]=yt[Mi].geometry[0].concat(Fi[0]),Mi}function ni(ci,gi,Fi){let Mi=lt[gi];return delete lt[gi],lt[ci]=Mi,yt[Mi].geometry[0].shift(),yt[Mi].geometry[0]=Fi[0].concat(yt[Mi].geometry[0]),Mi}function Ai(ci,gi,Fi){let Mi=Fi?gi[0][gi[0].length-1]:gi[0][0];return`${ci}:${Mi.x}:${Mi.y}`}for(let ci=0;ci<Ye.length;ci++){let gi=Ye[ci],Fi=gi.geometry,Mi=gi.text?gi.text.toString():null;if(!Mi){Ze(ci);continue}let Zi=Ai(Mi,Fi),bi=Ai(Mi,Fi,!0);if(Zi in Mt&&bi in lt&&Mt[Zi]!==lt[bi]){let fn=ni(Zi,bi,Fi),Hn=bt(Zi,bi,yt[fn].geometry);delete lt[Zi],delete Mt[bi],Mt[Ai(Mi,yt[Hn].geometry,!0)]=Hn,yt[fn].geometry=null}else Zi in Mt?bt(Zi,bi,Fi):bi in lt?ni(Zi,bi,Fi):(Ze(ci),lt[Zi]=ye-1,Mt[bi]=ye-1)}return yt.filter(ci=>ci.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((Ye,lt)=>Ye.sortKey-lt.sortKey)}update(s,u,y){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(s,u,this.layers,y),this.icon.programConfigurations.updatePaintArrays(s,u,this.layers,y))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(s){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(s),this.iconCollisionBox.upload(s)),this.text.upload(s,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(s,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(s,u){let y=this.lineVertexArray.length;if(s.segment!==void 0){let T=s.dist(u[s.segment+1]),D=s.dist(u[s.segment]),R={};for(let B=s.segment+1;B<u.length;B++)R[B]={x:u[B].x,y:u[B].y,tileUnitDistanceFromAnchor:T},B<u.length-1&&(T+=u[B+1].dist(u[B]));for(let B=s.segment||0;B>=0;B--)R[B]={x:u[B].x,y:u[B].y,tileUnitDistanceFromAnchor:D},B>0&&(D+=u[B-1].dist(u[B]));for(let B=0;B<u.length;B++){let G=R[B];this.lineVertexArray.emplaceBack(G.x,G.y,G.tileUnitDistanceFromAnchor)}}return{lineStartIndex:y,lineLength:this.lineVertexArray.length-y}}addSymbols(s,u,y,T,D,R,B,G,K,Q,ce,_e){let ve=s.indexArray,Te=s.layoutVertexArray,De=s.segments.prepareSegment(4*u.length,Te,ve,this.canOverlap?R.sortKey:void 0),Ye=this.glyphOffsetArray.length,lt=De.vertexLength,Mt=this.allowVerticalPlacement&&B===O.an.vertical?Math.PI/2:0,yt=R.text&&R.text.sections;for(let ye=0;ye<u.length;ye++){let{tl:Ze,tr:bt,bl:ni,br:Ai,tex:ci,pixelOffsetTL:gi,pixelOffsetBR:Fi,minFontScaleX:Mi,minFontScaleY:Zi,glyphOffset:bi,isSDF:fn,sectionIndex:Hn}=u[ye],Nn=De.vertexLength,Sn=bi[1];Eu(Te,G.x,G.y,Ze.x,Sn+Ze.y,ci.x,ci.y,y,fn,gi.x,gi.y,Mi,Zi),Eu(Te,G.x,G.y,bt.x,Sn+bt.y,ci.x+ci.w,ci.y,y,fn,Fi.x,gi.y,Mi,Zi),Eu(Te,G.x,G.y,ni.x,Sn+ni.y,ci.x,ci.y+ci.h,y,fn,gi.x,Fi.y,Mi,Zi),Eu(Te,G.x,G.y,Ai.x,Sn+Ai.y,ci.x+ci.w,ci.y+ci.h,y,fn,Fi.x,Fi.y,Mi,Zi),ua(s.dynamicLayoutVertexArray,G,Mt),ve.emplaceBack(Nn,Nn+2,Nn+1),ve.emplaceBack(Nn+1,Nn+2,Nn+3),De.vertexLength+=4,De.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(bi[0]),ye!==u.length-1&&Hn===u[ye+1].sectionIndex||s.programConfigurations.populatePaintArrays(Te.length,R,R.index,{},_e,yt&&yt[Hn])}s.placedSymbolArray.emplaceBack(G.x,G.y,Ye,this.glyphOffsetArray.length-Ye,lt,K,Q,G.segment,y?y[0]:0,y?y[1]:0,T[0],T[1],B,0,!1,0,ce)}_addCollisionDebugVertex(s,u,y,T,D,R){return u.emplaceBack(0,0),s.emplaceBack(y.x,y.y,T,D,Math.round(R.x),Math.round(R.y))}addCollisionDebugVertices(s,u,y,T,D,R,B){let G=D.segments.prepareSegment(4,D.layoutVertexArray,D.indexArray),K=G.vertexLength,Q=D.layoutVertexArray,ce=D.collisionVertexArray,_e=B.anchorX,ve=B.anchorY;this._addCollisionDebugVertex(Q,ce,R,_e,ve,new Wi(s,u)),this._addCollisionDebugVertex(Q,ce,R,_e,ve,new Wi(y,u)),this._addCollisionDebugVertex(Q,ce,R,_e,ve,new Wi(y,T)),this._addCollisionDebugVertex(Q,ce,R,_e,ve,new Wi(s,T)),G.vertexLength+=4;let Te=D.indexArray;Te.emplaceBack(K,K+1),Te.emplaceBack(K+1,K+2),Te.emplaceBack(K+2,K+3),Te.emplaceBack(K+3,K),G.primitiveLength+=4}addDebugCollisionBoxes(s,u,y,T){for(let D=s;D<u;D++){let R=this.collisionBoxArray.get(D);this.addCollisionDebugVertices(R.x1,R.y1,R.x2,R.y2,T?this.textCollisionBox:this.iconCollisionBox,R.anchorPoint,y)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new yg(Eo,up.members,Yr),this.iconCollisionBox=new yg(Eo,up.members,Yr);for(let s=0;s<this.symbolInstances.length;s++){let u=this.symbolInstances.get(s);this.addDebugCollisionBoxes(u.textBoxStartIndex,u.textBoxEndIndex,u,!0),this.addDebugCollisionBoxes(u.verticalTextBoxStartIndex,u.verticalTextBoxEndIndex,u,!0),this.addDebugCollisionBoxes(u.iconBoxStartIndex,u.iconBoxEndIndex,u,!1),this.addDebugCollisionBoxes(u.verticalIconBoxStartIndex,u.verticalIconBoxEndIndex,u,!1)}}_deserializeCollisionBoxesForSymbol(s,u,y,T,D,R,B,G,K){let Q={};for(let ce=u;ce<y;ce++){let _e=s.get(ce);Q.textBox={x1:_e.x1,y1:_e.y1,x2:_e.x2,y2:_e.y2,anchorPointX:_e.anchorPointX,anchorPointY:_e.anchorPointY},Q.textFeatureIndex=_e.featureIndex;break}for(let ce=T;ce<D;ce++){let _e=s.get(ce);Q.verticalTextBox={x1:_e.x1,y1:_e.y1,x2:_e.x2,y2:_e.y2,anchorPointX:_e.anchorPointX,anchorPointY:_e.anchorPointY},Q.verticalTextFeatureIndex=_e.featureIndex;break}for(let ce=R;ce<B;ce++){let _e=s.get(ce);Q.iconBox={x1:_e.x1,y1:_e.y1,x2:_e.x2,y2:_e.y2,anchorPointX:_e.anchorPointX,anchorPointY:_e.anchorPointY},Q.iconFeatureIndex=_e.featureIndex;break}for(let ce=G;ce<K;ce++){let _e=s.get(ce);Q.verticalIconBox={x1:_e.x1,y1:_e.y1,x2:_e.x2,y2:_e.y2,anchorPointX:_e.anchorPointX,anchorPointY:_e.anchorPointY},Q.verticalIconFeatureIndex=_e.featureIndex;break}return Q}deserializeCollisionBoxes(s){this.collisionArrays=[];for(let u=0;u<this.symbolInstances.length;u++){let y=this.symbolInstances.get(u);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(s,y.textBoxStartIndex,y.textBoxEndIndex,y.verticalTextBoxStartIndex,y.verticalTextBoxEndIndex,y.iconBoxStartIndex,y.iconBoxEndIndex,y.verticalIconBoxStartIndex,y.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(s,u){let y=s.placedSymbolArray.get(u),T=y.vertexStartIndex+4*y.numGlyphs;for(let D=y.vertexStartIndex;D<T;D+=4)s.indexArray.emplaceBack(D,D+2,D+1),s.indexArray.emplaceBack(D+1,D+2,D+3)}getSortedSymbolIndexes(s){if(this.sortedAngle===s&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;let u=Math.sin(s),y=Math.cos(s),T=[],D=[],R=[];for(let B=0;B<this.symbolInstances.length;++B){R.push(B);let G=this.symbolInstances.get(B);T.push(0|Math.round(u*G.anchorX+y*G.anchorY)),D.push(G.featureIndex)}return R.sort((B,G)=>T[B]-T[G]||D[G]-D[B]),R}addToSortKeyRanges(s,u){let y=this.sortKeyRanges[this.sortKeyRanges.length-1];y&&y.sortKey===u?y.symbolInstanceEnd=s+1:this.sortKeyRanges.push({sortKey:u,symbolInstanceStart:s,symbolInstanceEnd:s+1})}sortFeatures(s){if(this.sortFeaturesByY&&this.sortedAngle!==s&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(s),this.sortedAngle=s,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(let u of this.symbolInstanceIndexes){let y=this.symbolInstances.get(u);this.featureSortOrder.push(y.featureIndex),[y.rightJustifiedTextSymbolIndex,y.centerJustifiedTextSymbolIndex,y.leftJustifiedTextSymbolIndex].forEach((T,D,R)=>{T>=0&&R.indexOf(T)===D&&this.addIndicesForPlacedSymbol(this.text,T)}),y.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,y.verticalPlacedTextSymbolIndex),y.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,y.placedIconSymbolIndex),y.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,y.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let Ty,Sy;sn("SymbolBucket",Qf,{omit:["layers","collisionBoxArray","features","compareText"]}),Qf.MAX_GLYPHS=65535,Qf.addDynamicAttributes=ua;var Ef={get paint(){return Sy=Sy||new Qs({"icon-opacity":new jn(Ue.paint_symbol["icon-opacity"]),"icon-color":new jn(Ue.paint_symbol["icon-color"]),"icon-halo-color":new jn(Ue.paint_symbol["icon-halo-color"]),"icon-halo-width":new jn(Ue.paint_symbol["icon-halo-width"]),"icon-halo-blur":new jn(Ue.paint_symbol["icon-halo-blur"]),"icon-translate":new pn(Ue.paint_symbol["icon-translate"]),"icon-translate-anchor":new pn(Ue.paint_symbol["icon-translate-anchor"]),"text-opacity":new jn(Ue.paint_symbol["text-opacity"]),"text-color":new jn(Ue.paint_symbol["text-color"],{runtimeType:dn,getOverride:d=>d.textColor,hasOverride:d=>!!d.textColor}),"text-halo-color":new jn(Ue.paint_symbol["text-halo-color"]),"text-halo-width":new jn(Ue.paint_symbol["text-halo-width"]),"text-halo-blur":new jn(Ue.paint_symbol["text-halo-blur"]),"text-translate":new pn(Ue.paint_symbol["text-translate"]),"text-translate-anchor":new pn(Ue.paint_symbol["text-translate-anchor"])})},get layout(){return Ty=Ty||new Qs({"symbol-placement":new pn(Ue.layout_symbol["symbol-placement"]),"symbol-spacing":new pn(Ue.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new pn(Ue.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new jn(Ue.layout_symbol["symbol-sort-key"]),"symbol-z-order":new pn(Ue.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new pn(Ue.layout_symbol["icon-allow-overlap"]),"icon-overlap":new pn(Ue.layout_symbol["icon-overlap"]),"icon-ignore-placement":new pn(Ue.layout_symbol["icon-ignore-placement"]),"icon-optional":new pn(Ue.layout_symbol["icon-optional"]),"icon-rotation-alignment":new pn(Ue.layout_symbol["icon-rotation-alignment"]),"icon-size":new jn(Ue.layout_symbol["icon-size"]),"icon-text-fit":new pn(Ue.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new pn(Ue.layout_symbol["icon-text-fit-padding"]),"icon-image":new jn(Ue.layout_symbol["icon-image"]),"icon-rotate":new jn(Ue.layout_symbol["icon-rotate"]),"icon-padding":new jn(Ue.layout_symbol["icon-padding"]),"icon-keep-upright":new pn(Ue.layout_symbol["icon-keep-upright"]),"icon-offset":new jn(Ue.layout_symbol["icon-offset"]),"icon-anchor":new jn(Ue.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new pn(Ue.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new pn(Ue.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new pn(Ue.layout_symbol["text-rotation-alignment"]),"text-field":new jn(Ue.layout_symbol["text-field"]),"text-font":new jn(Ue.layout_symbol["text-font"]),"text-size":new jn(Ue.layout_symbol["text-size"]),"text-max-width":new jn(Ue.layout_symbol["text-max-width"]),"text-line-height":new pn(Ue.layout_symbol["text-line-height"]),"text-letter-spacing":new jn(Ue.layout_symbol["text-letter-spacing"]),"text-justify":new jn(Ue.layout_symbol["text-justify"]),"text-radial-offset":new jn(Ue.layout_symbol["text-radial-offset"]),"text-variable-anchor":new pn(Ue.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new jn(Ue.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new jn(Ue.layout_symbol["text-anchor"]),"text-max-angle":new pn(Ue.layout_symbol["text-max-angle"]),"text-writing-mode":new pn(Ue.layout_symbol["text-writing-mode"]),"text-rotate":new jn(Ue.layout_symbol["text-rotate"]),"text-padding":new pn(Ue.layout_symbol["text-padding"]),"text-keep-upright":new pn(Ue.layout_symbol["text-keep-upright"]),"text-transform":new jn(Ue.layout_symbol["text-transform"]),"text-offset":new jn(Ue.layout_symbol["text-offset"]),"text-allow-overlap":new pn(Ue.layout_symbol["text-allow-overlap"]),"text-overlap":new pn(Ue.layout_symbol["text-overlap"]),"text-ignore-placement":new pn(Ue.layout_symbol["text-ignore-placement"]),"text-optional":new pn(Ue.layout_symbol["text-optional"])})}};class xg{constructor(s){if(s.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=s.property.overrides?s.property.overrides.runtimeType:Ii,this.defaultValue=s}evaluate(s){if(s.formattedSection){let u=this.defaultValue.property.overrides;if(u&&u.hasOverride(s.formattedSection))return u.getOverride(s.formattedSection)}return s.feature&&s.featureState?this.defaultValue.evaluate(s.feature,s.featureState):this.defaultValue.property.specification.default}eachChild(s){this.defaultValue.isConstant()||s(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}sn("FormatSectionOverride",xg,{omit:["defaultValue"]});class pd extends ds{constructor(s){super(s,Ef)}recalculate(s,u){if(super.recalculate(s,u),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){let y=this.layout.get("text-writing-mode");if(y){let T=[];for(let D of y)T.indexOf(D)<0&&T.push(D);this.layout._values["text-writing-mode"]=T}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(s,u,y,T){let D=this.layout.get(s).evaluate(u,{},y,T),R=this._unevaluatedLayout._values[s];return R.isDataDriven()||Ld(R.value)||!D?D:function(B,G){return G.replace(/{([^{}]+)}/g,(K,Q)=>B&&Q in B?String(B[Q]):"")}(u.properties,D)}createBucket(s){return new Qf(s)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(let s of Ef.paint.overridableProperties){if(!pd.hasPaintOverride(this.layout,s))continue;let u=this.paint.get(s),y=new xg(u),T=new Vp(y,u.property.specification),D=null;D=u.value.kind==="constant"||u.value.kind==="source"?new Fh("source",T):new Gu("composite",T,u.value.zoomStops),this.paint._values[s]=new yl(u.property,D,u.parameters)}}_handleOverridablePaintPropertyUpdate(s,u,y){return!(!this.layout||u.isDataDriven()||y.isDataDriven())&&pd.hasPaintOverride(this.layout,s)}static hasPaintOverride(s,u){let y=s.get("text-field"),T=Ef.paint.properties[u],D=!1,R=B=>{for(let G of B)if(T.overrides&&T.overrides.hasOverride(G))return void(D=!0)};if(y.value.kind==="constant"&&y.value.value instanceof Xs)R(y.value.value.sections);else if(y.value.kind==="source"){let B=K=>{D||(K instanceof Bs&&Fn(K.value)===Jn?R(K.value.sections):K instanceof zl?R(K.sections):K.eachChild(B))},G=y.value;G._styleExpression&&B(G._styleExpression.expression)}return D}}let em;var Q0={get paint(){return em=em||new Qs({"background-color":new pn(Ue.paint_background["background-color"]),"background-pattern":new wu(Ue.paint_background["background-pattern"]),"background-opacity":new pn(Ue.paint_background["background-opacity"])})}};class ex extends ds{constructor(s){super(s,Q0)}}let Iy;var tx={get paint(){return Iy=Iy||new Qs({"raster-opacity":new pn(Ue.paint_raster["raster-opacity"]),"raster-hue-rotate":new pn(Ue.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new pn(Ue.paint_raster["raster-brightness-min"]),"raster-brightness-max":new pn(Ue.paint_raster["raster-brightness-max"]),"raster-saturation":new pn(Ue.paint_raster["raster-saturation"]),"raster-contrast":new pn(Ue.paint_raster["raster-contrast"]),"raster-resampling":new pn(Ue.paint_raster["raster-resampling"]),"raster-fade-duration":new pn(Ue.paint_raster["raster-fade-duration"])})}};class ix extends ds{constructor(s){super(s,tx)}}class nx extends ds{constructor(s){super(s,{}),this.onAdd=u=>{this.implementation.onAdd&&this.implementation.onAdd(u,u.painter.context.gl)},this.onRemove=u=>{this.implementation.onRemove&&this.implementation.onRemove(u,u.painter.context.gl)},this.implementation=s}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class rx{constructor(s){this._methodToThrottle=s,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._methodToThrottle()},0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}let vg={once:!0},bg=63710088e-1;class gp{constructor(s,u){if(isNaN(s)||isNaN(u))throw new Error(`Invalid LngLat object: (${s}, ${u})`);if(this.lng=+s,this.lat=+u,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new gp(yc(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(s){let u=Math.PI/180,y=this.lat*u,T=s.lat*u,D=Math.sin(y)*Math.sin(T)+Math.cos(y)*Math.cos(T)*Math.cos((s.lng-this.lng)*u);return bg*Math.acos(Math.min(D,1))}static convert(s){if(s instanceof gp)return s;if(Array.isArray(s)&&(s.length===2||s.length===3))return new gp(Number(s[0]),Number(s[1]));if(!Array.isArray(s)&&typeof s=="object"&&s!==null)return new gp(Number("lng"in s?s.lng:s.lon),Number(s.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}let tm=2*Math.PI*bg;function Cy(d){return tm*Math.cos(d*Math.PI/180)}function Gs(d){return(180+d)/360}function Mf(d){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+d*Math.PI/360)))/360}function wg(d,s){return d/Cy(s)}function im(d){return 360/Math.PI*Math.atan(Math.exp((180-360*d)*Math.PI/180))-90}function jm(d,s){return d*Cy(im(s))}class yp{constructor(s,u,y=0){this.x=+s,this.y=+u,this.z=+y}static fromLngLat(s,u=0){let y=gp.convert(s);return new yp(Gs(y.lng),Mf(y.lat),wg(u,y.lat))}toLngLat(){return new gp(360*this.x-180,im(this.y))}toAltitude(){return jm(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/tm*(s=im(this.y),1/Math.cos(s*Math.PI/180));var s}}function Tg(d,s,u){var y=2*Math.PI*6378137/256/Math.pow(2,u);return[d*y-2*Math.PI*6378137/2,s*y-2*Math.PI*6378137/2]}class m_{constructor(s,u,y){if(!function(T,D,R){return!(T<0||T>25||R<0||R>=Math.pow(2,T)||D<0||D>=Math.pow(2,T))}(s,u,y))throw new Error(`x=${u}, y=${y}, z=${s} outside of bounds. 0<=x<${Math.pow(2,s)}, 0<=y<${Math.pow(2,s)} 0<=z<=25 `);this.z=s,this.x=u,this.y=y,this.key=xp(0,s,s,u,y)}equals(s){return this.z===s.z&&this.x===s.x&&this.y===s.y}url(s,u,y){let T=(R=this.y,B=this.z,G=Tg(256*(D=this.x),256*(R=Math.pow(2,B)-R-1),B),K=Tg(256*(D+1),256*(R+1),B),G[0]+","+G[1]+","+K[0]+","+K[1]);var D,R,B,G,K;let Q=function(ce,_e,ve){let Te,De="";for(let Ye=ce;Ye>0;Ye--)Te=1<<Ye-1,De+=(_e&Te?1:0)+(ve&Te?2:0);return De}(this.z,this.x,this.y);return s[(this.x+this.y)%s.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(y==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,u>1?"@2x":"").replace(/{quadkey}/g,Q).replace(/{bbox-epsg-3857}/g,T)}isChildOf(s){let u=this.z-s.z;return u>0&&s.x===this.x>>u&&s.y===this.y>>u}getTilePoint(s){let u=Math.pow(2,this.z);return new Wi((s.x*u-this.x)*Hr,(s.y*u-this.y)*Hr)}toString(){return`${this.z}/${this.x}/${this.y}`}}class nm{constructor(s,u){this.wrap=s,this.canonical=u,this.key=xp(s,u.z,u.z,u.x,u.y)}}class mc{constructor(s,u,y,T,D){if(this.terrainRttPosMatrix32f=null,s<y)throw new Error(`overscaledZ should be >= z; overscaledZ = ${s}; z = ${y}`);this.overscaledZ=s,this.wrap=u,this.canonical=new m_(y,+T,+D),this.key=xp(u,s,y,T,D)}clone(){return new mc(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(s){return this.overscaledZ===s.overscaledZ&&this.wrap===s.wrap&&this.canonical.equals(s.canonical)}scaledTo(s){if(s>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${s}; overscaledZ = ${this.overscaledZ}`);let u=this.canonical.z-s;return s>this.canonical.z?new mc(s,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new mc(s,this.wrap,s,this.canonical.x>>u,this.canonical.y>>u)}calculateScaledKey(s,u){if(s>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${s}; overscaledZ = ${this.overscaledZ}`);let y=this.canonical.z-s;return s>this.canonical.z?xp(this.wrap*+u,s,this.canonical.z,this.canonical.x,this.canonical.y):xp(this.wrap*+u,s,s,this.canonical.x>>y,this.canonical.y>>y)}isChildOf(s){if(s.wrap!==this.wrap)return!1;let u=this.canonical.z-s.canonical.z;return s.overscaledZ===0||s.overscaledZ<this.overscaledZ&&s.canonical.x===this.canonical.x>>u&&s.canonical.y===this.canonical.y>>u}children(s){if(this.overscaledZ>=s)return[new mc(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];let u=this.canonical.z+1,y=2*this.canonical.x,T=2*this.canonical.y;return[new mc(u,this.wrap,u,y,T),new mc(u,this.wrap,u,y+1,T),new mc(u,this.wrap,u,y,T+1),new mc(u,this.wrap,u,y+1,T+1)]}isLessThan(s){return this.wrap<s.wrap||!(this.wrap>s.wrap)&&(this.overscaledZ<s.overscaledZ||!(this.overscaledZ>s.overscaledZ)&&(this.canonical.x<s.canonical.x||!(this.canonical.x>s.canonical.x)&&this.canonical.y<s.canonical.y))}wrapped(){return new mc(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(s){return new mc(this.overscaledZ,s,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new nm(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(s){return this.canonical.getTilePoint(new yp(s.x-this.wrap,s.y))}}function xp(d,s,u,y,T){(d*=2)<0&&(d=-1*d-1);let D=1<<u;return(D*D*d+D*T+y).toString(36)+u.toString(36)+s.toString(36)}sn("CanonicalTileID",m_),sn("OverscaledTileID",mc,{omit:["terrainRttPosMatrix32f"]});class Pf{constructor(){this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0}extend(s){return this.minX=Math.min(this.minX,s.x),this.minY=Math.min(this.minY,s.y),this.maxX=Math.max(this.maxX,s.x),this.maxY=Math.max(this.maxY,s.y),this}expandBy(s){return this.minX-=s,this.minY-=s,this.maxX+=s,this.maxY+=s,(this.minX>this.maxX||this.minY>this.maxY)&&(this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0),this}shrinkBy(s){return this.expandBy(-s)}map(s){let u=new Pf;return u.extend(s(new Wi(this.minX,this.minY))),u.extend(s(new Wi(this.maxX,this.minY))),u.extend(s(new Wi(this.minX,this.maxY))),u.extend(s(new Wi(this.maxX,this.maxY))),u}static fromPoints(s){let u=new Pf;for(let y of s)u.extend(y);return u}contains(s){return s.x>=this.minX&&s.x<=this.maxX&&s.y>=this.minY&&s.y<=this.maxY}empty(){return this.minX>this.maxX}width(){return this.maxX-this.minX}height(){return this.maxY-this.minY}covers(s){return!this.empty()&&!s.empty()&&s.minX>=this.minX&&s.maxX<=this.maxX&&s.minY>=this.minY&&s.maxY<=this.maxY}intersects(s){return!this.empty()&&!s.empty()&&s.minX<=this.maxX&&s.maxX>=this.minX&&s.minY<=this.maxY&&s.maxY>=this.minY}}class Sg{constructor(s){this._stringToNumber={},this._numberToString=[];for(let u=0;u<s.length;u++){let y=s[u];this._stringToNumber[y]=u,this._numberToString[u]=y}}encode(s){return this._stringToNumber[s]}decode(s){if(s>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${s} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[s]}}class __{constructor(s,u,y,T,D){this.type="Feature",this._vectorTileFeature=s,s._z=u,s._x=y,s._y=T,this.properties=s.properties,this.id=D}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(s){this._geometry=s}toJSON(){let s={geometry:this.geometry};for(let u in this)u!=="_geometry"&&u!=="_vectorTileFeature"&&(s[u]=this[u]);return s}}class g_{constructor(s,u){this.tileID=s,this.x=s.canonical.x,this.y=s.canonical.y,this.z=s.canonical.z,this.grid=new Pc(Hr,16,0),this.grid3D=new Pc(Hr,16,0),this.featureIndexArray=new ei,this.promoteId=u}insert(s,u,y,T,D,R){let B=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(y,T,D);let G=R?this.grid3D:this.grid;for(let K=0;K<u.length;K++){let Q=u[K],ce=[1/0,1/0,-1/0,-1/0];for(let _e=0;_e<Q.length;_e++){let ve=Q[_e];ce[0]=Math.min(ce[0],ve.x),ce[1]=Math.min(ce[1],ve.y),ce[2]=Math.max(ce[2],ve.x),ce[3]=Math.max(ce[3],ve.y)}ce[0]<Hr&&ce[1]<Hr&&ce[2]>=0&&ce[3]>=0&&G.insert(B,ce[0],ce[1],ce[2],ce[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new Er.VectorTile(new Kh(this.rawTileData)).layers,this.sourceLayerCoder=new Sg(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(s,u,y,T){this.loadVTLayers();let D=s.params,R=Hr/s.tileSize/s.scale,B=ac(D.filter),G=s.queryGeometry,K=s.queryPadding*R,Q=Pf.fromPoints(G),ce=this.grid.query(Q.minX-K,Q.minY-K,Q.maxX+K,Q.maxY+K),_e=Pf.fromPoints(s.cameraQueryGeometry).expandBy(K),ve=this.grid3D.query(_e.minX,_e.minY,_e.maxX,_e.maxY,(Ye,lt,Mt,yt)=>function(ye,Ze,bt,ni,Ai){for(let gi of ye)if(Ze<=gi.x&&bt<=gi.y&&ni>=gi.x&&Ai>=gi.y)return!0;let ci=[new Wi(Ze,bt),new Wi(Ze,Ai),new Wi(ni,Ai),new Wi(ni,bt)];if(ye.length>2){for(let gi of ci)if(lp(ye,gi))return!0}for(let gi=0;gi<ye.length-1;gi++)if(zm(ye[gi],ye[gi+1],ci))return!0;return!1}(s.cameraQueryGeometry,Ye-K,lt-K,Mt+K,yt+K));for(let Ye of ve)ce.push(Ye);ce.sort(Ey);let Te={},De;for(let Ye=0;Ye<ce.length;Ye++){let lt=ce[Ye];if(lt===De)continue;De=lt;let Mt=this.featureIndexArray.get(lt),yt=null;this.loadMatchingFeature(Te,Mt.bucketIndex,Mt.sourceLayerIndex,Mt.featureIndex,B,D.layers,D.availableImages,u,y,T,(ye,Ze,bt)=>(yt||(yt=Cu(ye)),Ze.queryIntersectsFeature({queryGeometry:G,feature:ye,featureState:bt,geometry:yt,zoom:this.z,transform:s.transform,pixelsToTileUnits:R,pixelPosMatrix:s.pixelPosMatrix,unwrappedTileID:this.tileID.toUnwrapped(),getElevation:s.getElevation})))}return Te}loadMatchingFeature(s,u,y,T,D,R,B,G,K,Q,ce){let _e=this.bucketLayerIDs[u];if(R&&!_e.some(Ye=>R.has(Ye)))return;let ve=this.sourceLayerCoder.decode(y),Te=this.vtLayers[ve].feature(T);if(D.needGeometry){let Ye=$h(Te,!0);if(!D.filter(new jo(this.tileID.overscaledZ),Ye,this.tileID.canonical))return}else if(!D.filter(new jo(this.tileID.overscaledZ),Te))return;let De=this.getId(Te,ve);for(let Ye=0;Ye<_e.length;Ye++){let lt=_e[Ye];if(R&&!R.has(lt))continue;let Mt=G[lt];if(!Mt)continue;let yt={};De&&Q&&(yt=Q.getState(Mt.sourceLayer||"_geojsonTileLayer",De));let ye=Os({},K[lt]);ye.paint=y_(ye.paint,Mt.paint,Te,yt,B),ye.layout=y_(ye.layout,Mt.layout,Te,yt,B);let Ze=!ce||ce(Te,Mt,yt);if(!Ze)continue;let bt=new __(Te,this.z,this.x,this.y,De);bt.layer=ye;let ni=s[lt];ni===void 0&&(ni=s[lt]=[]),ni.push({featureIndex:T,feature:bt,intersectionZ:Ze})}}lookupSymbolFeatures(s,u,y,T,D,R,B,G){let K={};this.loadVTLayers();let Q=ac(D);for(let ce of s)this.loadMatchingFeature(K,y,T,ce,Q,R,B,G,u);return K}hasLayer(s){for(let u of this.bucketLayerIDs)for(let y of u)if(s===y)return!0;return!1}getId(s,u){var y;let T=s.id;return this.promoteId&&(T=s.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[u]],typeof T=="boolean"&&(T=Number(T)),T===void 0&&(!((y=s.properties)===null||y===void 0)&&y.cluster)&&this.promoteId&&(T=Number(s.properties.cluster_id))),T}}function y_(d,s,u,y,T){return hr(d,(D,R)=>{let B=s instanceof nd?s.get(R):null;return B&&B.evaluate?B.evaluate(u,y,T):B})}function Ey(d,s){return s-d}function x_(d,s,u,y,T){let D=[];for(let R=0;R<d.length;R++){let B=d[R],G;for(let K=0;K<B.length-1;K++){let Q=B[K],ce=B[K+1];Q.x<s&&ce.x<s||(Q.x<s?Q=new Wi(s,Q.y+(s-Q.x)/(ce.x-Q.x)*(ce.y-Q.y))._round():ce.x<s&&(ce=new Wi(s,Q.y+(s-Q.x)/(ce.x-Q.x)*(ce.y-Q.y))._round()),Q.y<u&&ce.y<u||(Q.y<u?Q=new Wi(Q.x+(u-Q.y)/(ce.y-Q.y)*(ce.x-Q.x),u)._round():ce.y<u&&(ce=new Wi(Q.x+(u-Q.y)/(ce.y-Q.y)*(ce.x-Q.x),u)._round()),Q.x>=y&&ce.x>=y||(Q.x>=y?Q=new Wi(y,Q.y+(y-Q.x)/(ce.x-Q.x)*(ce.y-Q.y))._round():ce.x>=y&&(ce=new Wi(y,Q.y+(y-Q.x)/(ce.x-Q.x)*(ce.y-Q.y))._round()),Q.y>=T&&ce.y>=T||(Q.y>=T?Q=new Wi(Q.x+(T-Q.y)/(ce.y-Q.y)*(ce.x-Q.x),T)._round():ce.y>=T&&(ce=new Wi(Q.x+(T-Q.y)/(ce.y-Q.y)*(ce.x-Q.x),T)._round()),G&&Q.equals(G[G.length-1])||(G=[Q],D.push(G)),G.push(ce)))))}}return D}sn("FeatureIndex",g_,{omit:["rawTileData","sourceLayerCoder"]});class vp extends Wi{constructor(s,u,y,T){super(s,u),this.angle=y,T!==void 0&&(this.segment=T)}clone(){return new vp(this.x,this.y,this.angle,this.segment)}}function v_(d,s,u,y,T){if(s.segment===void 0||u===0)return!0;let D=s,R=s.segment+1,B=0;for(;B>-u/2;){if(R--,R<0)return!1;B-=d[R].dist(D),D=d[R]}B+=d[R].dist(d[R+1]),R++;let G=[],K=0;for(;B<u/2;){let Q=d[R],ce=d[R+1];if(!ce)return!1;let _e=d[R-1].angleTo(Q)-Q.angleTo(ce);for(_e=Math.abs((_e+3*Math.PI)%(2*Math.PI)-Math.PI),G.push({distance:B,angleDelta:_e}),K+=_e;B-G[0].distance>y;)K-=G.shift().angleDelta;if(K>T)return!1;R++,B+=Q.dist(ce)}return!0}function Ig(d){let s=0;for(let u=0;u<d.length-1;u++)s+=d[u].dist(d[u+1]);return s}function Cg(d,s,u){return d?.6*s*u:0}function Gm(d,s){return Math.max(d?d.right-d.left:0,s?s.right-s.left:0)}function My(d,s,u,y,T,D){let R=Cg(u,T,D),B=Gm(u,y)*D,G=0,K=Ig(d)/2;for(let Q=0;Q<d.length-1;Q++){let ce=d[Q],_e=d[Q+1],ve=ce.dist(_e);if(G+ve>K){let Te=(K-G)/ve,De=Xn.number(ce.x,_e.x,Te),Ye=Xn.number(ce.y,_e.y,Te),lt=new vp(De,Ye,_e.angleTo(ce),Q);return lt._round(),!R||v_(d,lt,B,R,s)?lt:void 0}G+=ve}}function Py(d,s,u,y,T,D,R,B,G){let K=Cg(y,D,R),Q=Gm(y,T),ce=Q*R,_e=d[0].x===0||d[0].x===G||d[0].y===0||d[0].y===G;return s-ce<s/4&&(s=ce+s/4),Eg(d,_e?s/2*B%s:(Q/2+2*D)*R*B%s,s,K,u,ce,_e,!1,G)}function Eg(d,s,u,y,T,D,R,B,G){let K=D/2,Q=Ig(d),ce=0,_e=s-u,ve=[];for(let Te=0;Te<d.length-1;Te++){let De=d[Te],Ye=d[Te+1],lt=De.dist(Ye),Mt=Ye.angleTo(De);for(;_e+u<ce+lt;){_e+=u;let yt=(_e-ce)/lt,ye=Xn.number(De.x,Ye.x,yt),Ze=Xn.number(De.y,Ye.y,yt);if(ye>=0&&ye<G&&Ze>=0&&Ze<G&&_e-K>=0&&_e+K<=Q){let bt=new vp(ye,Ze,Mt,Te);bt._round(),y&&!v_(d,bt,D,y,T)||ve.push(bt)}}ce+=lt}return B||ve.length||R||(ve=Eg(d,ce/2,u,y,T,D,R,!0,G)),ve}function bp(d,s,u,y){let T=[],D=d.image,R=D.pixelRatio,B=D.paddedRect.w-2,G=D.paddedRect.h-2,K={x1:d.left,y1:d.top,x2:d.right,y2:d.bottom},Q=D.stretchX||[[0,B]],ce=D.stretchY||[[0,G]],_e=(bi,fn)=>bi+fn[1]-fn[0],ve=Q.reduce(_e,0),Te=ce.reduce(_e,0),De=B-ve,Ye=G-Te,lt=0,Mt=ve,yt=0,ye=Te,Ze=0,bt=De,ni=0,Ai=Ye;if(D.content&&y){let bi=D.content,fn=bi[2]-bi[0],Hn=bi[3]-bi[1];(D.textFitWidth||D.textFitHeight)&&(K=fg(d)),lt=fd(Q,0,bi[0]),yt=fd(ce,0,bi[1]),Mt=fd(Q,bi[0],bi[2]),ye=fd(ce,bi[1],bi[3]),Ze=bi[0]-lt,ni=bi[1]-yt,bt=fn-Mt,Ai=Hn-ye}let ci=K.x1,gi=K.y1,Fi=K.x2-ci,Mi=K.y2-gi,Zi=(bi,fn,Hn,Nn)=>{let Sn=b_(bi.stretch-lt,Mt,Fi,ci),Zr=Zm(bi.fixed-Ze,bt,bi.stretch,ve),zs=b_(fn.stretch-yt,ye,Mi,gi),Ea=Zm(fn.fixed-ni,Ai,fn.stretch,Te),il=b_(Hn.stretch-lt,Mt,Fi,ci),ql=Zm(Hn.fixed-Ze,bt,Hn.stretch,ve),$l=b_(Nn.stretch-yt,ye,Mi,gi),nl=Zm(Nn.fixed-ni,Ai,Nn.stretch,Te),bs=new Wi(Sn,zs),da=new Wi(il,zs),Va=new Wi(il,$l),Ua=new Wi(Sn,$l),wl=new Wi(Zr/R,Ea/R),Oc=new Wi(ql/R,nl/R),Ma=s*Math.PI/180;if(Ma){let Pa=Math.sin(Ma),Ts=Math.cos(Ma),ta=[Ts,-Pa,Pa,Ts];bs._matMult(ta),da._matMult(ta),Ua._matMult(ta),Va._matMult(ta)}let _c=bi.stretch+bi.fixed,pa=fn.stretch+fn.fixed;return{tl:bs,tr:da,bl:Ua,br:Va,tex:{x:D.paddedRect.x+1+_c,y:D.paddedRect.y+1+pa,w:Hn.stretch+Hn.fixed-_c,h:Nn.stretch+Nn.fixed-pa},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:wl,pixelOffsetBR:Oc,minFontScaleX:bt/R/Fi,minFontScaleY:Ai/R/Mi,isSDF:u}};if(y&&(D.stretchX||D.stretchY)){let bi=Mg(Q,De,ve),fn=Mg(ce,Ye,Te);for(let Hn=0;Hn<bi.length-1;Hn++){let Nn=bi[Hn],Sn=bi[Hn+1];for(let Zr=0;Zr<fn.length-1;Zr++)T.push(Zi(Nn,fn[Zr],Sn,fn[Zr+1]))}}else T.push(Zi({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:B+1},{fixed:0,stretch:G+1}));return T}function fd(d,s,u){let y=0;for(let T of d)y+=Math.max(s,Math.min(u,T[1]))-Math.max(s,Math.min(u,T[0]));return y}function Mg(d,s,u){let y=[{fixed:-1,stretch:0}];for(let[T,D]of d){let R=y[y.length-1];y.push({fixed:T-R.stretch,stretch:R.stretch}),y.push({fixed:T-R.stretch,stretch:R.stretch+(D-T)})}return y.push({fixed:s+1,stretch:u}),y}function b_(d,s,u,y){return d/s*u+y}function Zm(d,s,u,y){return d-s*u/y}sn("Anchor",vp);class w_{constructor(s,u,y,T,D,R,B,G,K,Q){var ce;if(this.boxStartIndex=s.length,K){let _e=R.top,ve=R.bottom,Te=R.collisionPadding;Te&&(_e-=Te[1],ve+=Te[3]);let De=ve-_e;De>0&&(De=Math.max(10,De),this.circleDiameter=De)}else{let _e=!((ce=R.image)===null||ce===void 0)&&ce.content&&(R.image.textFitWidth||R.image.textFitHeight)?fg(R):{x1:R.left,y1:R.top,x2:R.right,y2:R.bottom};_e.y1=_e.y1*B-G[0],_e.y2=_e.y2*B+G[2],_e.x1=_e.x1*B-G[3],_e.x2=_e.x2*B+G[1];let ve=R.collisionPadding;if(ve&&(_e.x1-=ve[0]*B,_e.y1-=ve[1]*B,_e.x2+=ve[2]*B,_e.y2+=ve[3]*B),Q){let Te=new Wi(_e.x1,_e.y1),De=new Wi(_e.x2,_e.y1),Ye=new Wi(_e.x1,_e.y2),lt=new Wi(_e.x2,_e.y2),Mt=Q*Math.PI/180;Te._rotate(Mt),De._rotate(Mt),Ye._rotate(Mt),lt._rotate(Mt),_e.x1=Math.min(Te.x,De.x,Ye.x,lt.x),_e.x2=Math.max(Te.x,De.x,Ye.x,lt.x),_e.y1=Math.min(Te.y,De.y,Ye.y,lt.y),_e.y2=Math.max(Te.y,De.y,Ye.y,lt.y)}s.emplaceBack(u.x,u.y,_e.x1,_e.y1,_e.x2,_e.y2,y,T,D)}this.boxEndIndex=s.length}}class ox{constructor(s=[],u=(y,T)=>y<T?-1:y>T?1:0){if(this.data=s,this.length=this.data.length,this.compare=u,this.length>0)for(let y=(this.length>>1)-1;y>=0;y--)this._down(y)}push(s){this.data.push(s),this._up(this.length++)}pop(){if(this.length===0)return;let s=this.data[0],u=this.data.pop();return--this.length>0&&(this.data[0]=u,this._down(0)),s}peek(){return this.data[0]}_up(s){let{data:u,compare:y}=this,T=u[s];for(;s>0;){let D=s-1>>1,R=u[D];if(y(T,R)>=0)break;u[s]=R,s=D}u[s]=T}_down(s){let{data:u,compare:y}=this,T=this.length>>1,D=u[s];for(;s<T;){let R=1+(s<<1),B=R+1;if(B<this.length&&y(u[B],u[R])<0&&(R=B),y(u[R],D)>=0)break;u[s]=u[R],s=R}u[s]=D}}function Af(d,s=1,u=!1){let y=Pf.fromPoints(d[0]),T=Math.min(y.width(),y.height()),D=T/2,R=new ox([],Ay),{minX:B,minY:G,maxX:K,maxY:Q}=y;if(T===0)return new Wi(B,G);for(let ve=B;ve<K;ve+=T)for(let Te=G;Te<Q;Te+=T)R.push(new Qp(ve+D,Te+D,D,d));let ce=function(ve){let Te=0,De=0,Ye=0,lt=ve[0];for(let Mt=0,yt=lt.length,ye=yt-1;Mt<yt;ye=Mt++){let Ze=lt[Mt],bt=lt[ye],ni=Ze.x*bt.y-bt.x*Ze.y;De+=(Ze.x+bt.x)*ni,Ye+=(Ze.y+bt.y)*ni,Te+=3*ni}return new Qp(De/Te,Ye/Te,0,ve)}(d),_e=R.length;for(;R.length;){let ve=R.pop();(ve.d>ce.d||!ce.d)&&(ce=ve,u&&console.log("found best %d after %d probes",Math.round(1e4*ve.d)/1e4,_e)),ve.max-ce.d<=s||(D=ve.h/2,R.push(new Qp(ve.p.x-D,ve.p.y-D,D,d)),R.push(new Qp(ve.p.x+D,ve.p.y-D,D,d)),R.push(new Qp(ve.p.x-D,ve.p.y+D,D,d)),R.push(new Qp(ve.p.x+D,ve.p.y+D,D,d)),_e+=4)}return u&&(console.log(`num probes: ${_e}`),console.log(`best distance: ${ce.d}`)),ce.p}function Ay(d,s){return s.max-d.max}function Qp(d,s,u,y){this.p=new Wi(d,s),this.h=u,this.d=function(T,D){let R=!1,B=1/0;for(let G=0;G<D.length;G++){let K=D[G];for(let Q=0,ce=K.length,_e=ce-1;Q<ce;_e=Q++){let ve=K[Q],Te=K[_e];ve.y>T.y!=Te.y>T.y&&T.x<(Te.x-ve.x)*(T.y-ve.y)/(Te.y-ve.y)+ve.x&&(R=!R),B=Math.min(B,Dm(T,ve,Te))}}return(R?1:-1)*Math.sqrt(B)}(this.p,y),this.max=this.d+this.h*Math.SQRT2}var Na;O.aD=void 0,(Na=O.aD||(O.aD={}))[Na.center=1]="center",Na[Na.left=2]="left",Na[Na.right=3]="right",Na[Na.top=4]="top",Na[Na.bottom=5]="bottom",Na[Na["top-left"]=6]="top-left",Na[Na["top-right"]=7]="top-right",Na[Na["bottom-left"]=8]="bottom-left",Na[Na["bottom-right"]=9]="bottom-right";let T_=Number.POSITIVE_INFINITY;function Pg(d,s){return s[1]!==T_?function(u,y,T){let D=0,R=0;switch(y=Math.abs(y),T=Math.abs(T),u){case"top-right":case"top-left":case"top":R=T-7;break;case"bottom-right":case"bottom-left":case"bottom":R=7-T}switch(u){case"top-right":case"bottom-right":case"right":D=-y;break;case"top-left":case"bottom-left":case"left":D=y}return[D,R]}(d,s[0],s[1]):function(u,y){let T=0,D=0;y<0&&(y=0);let R=y/Math.SQRT2;switch(u){case"top-right":case"top-left":D=R-7;break;case"bottom-right":case"bottom-left":D=7-R;break;case"bottom":D=7-y;break;case"top":D=y-7}switch(u){case"top-right":case"bottom-right":T=-R;break;case"top-left":case"bottom-left":T=R;break;case"left":T=y;break;case"right":T=-y}return[T,D]}(d,s[0])}function ef(d,s,u){var y;let T=d.layout,D=(y=T.get("text-variable-anchor-offset"))===null||y===void 0?void 0:y.evaluate(s,{},u);if(D){let B=D.values,G=[];for(let K=0;K<B.length;K+=2){let Q=G[K]=B[K],ce=B[K+1].map(_e=>_e*vs);Q.startsWith("top")?ce[1]-=7:Q.startsWith("bottom")&&(ce[1]+=7),G[K+1]=ce}return new Cr(G)}let R=T.get("text-variable-anchor");if(R){let B;B=d._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[T.get("text-radial-offset").evaluate(s,{},u)*vs,T_]:T.get("text-offset").evaluate(s,{},u).map(K=>K*vs);let G=[];for(let K of R)G.push(K,Pg(K,B));return new Cr(G)}return null}function Ag(d){switch(d){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function kc(d,s,u,y,T,D,R,B,G,K,Q,ce){let _e=D.textMaxSize.evaluate(s,{});_e===void 0&&(_e=R);let ve=d.layers[0].layout,Te=ve.get("icon-offset").evaluate(s,{},Q),De=Rg(u.horizontal),Ye=R/24,lt=d.tilePixelRatio*Ye,Mt=d.tilePixelRatio*_e/24,yt=d.tilePixelRatio*B,ye=d.tilePixelRatio*ve.get("symbol-spacing"),Ze=ve.get("text-padding")*d.tilePixelRatio,bt=function(Hn,Nn,Sn,Zr=1){let zs=Hn.get("icon-padding").evaluate(Nn,{},Sn),Ea=zs&&zs.values;return[Ea[0]*Zr,Ea[1]*Zr,Ea[2]*Zr,Ea[3]*Zr]}(ve,s,Q,d.tilePixelRatio),ni=ve.get("text-max-angle")/180*Math.PI,Ai=ve.get("text-rotation-alignment")!=="viewport"&&ve.get("symbol-placement")!=="point",ci=ve.get("icon-rotation-alignment")==="map"&&ve.get("symbol-placement")!=="point",gi=ve.get("symbol-placement"),Fi=ye/2,Mi=ve.get("icon-text-fit"),Zi;y&&Mi!=="none"&&(d.allowVerticalPlacement&&u.vertical&&(Zi=mg(y,u.vertical,Mi,ve.get("icon-text-fit-padding"),Te,Ye)),De&&(y=mg(y,De,Mi,ve.get("icon-text-fit-padding"),Te,Ye)));let bi=Q?ce.line.getGranularityForZoomLevel(Q.z):1,fn=(Hn,Nn)=>{Nn.x<0||Nn.x>=Hr||Nn.y<0||Nn.y>=Hr||function(Sn,Zr,zs,Ea,il,ql,$l,nl,bs,da,Va,Ua,wl,Oc,Ma,_c,pa,Pa,Ts,ta,ns,Jh,wp,Mu,zy){let md=Sn.addToLineVertexArray(Zr,zs),tf,Df,sm,am,Ly=0,ky=0,Oy=0,Fy=0,kg=-1,M_=-1,Tp={},By=Ca("");if(Sn.allowVerticalPlacement&&Ea.vertical){let cl=nl.layout.get("text-rotate").evaluate(ns,{},Mu)+90;sm=new w_(bs,Zr,da,Va,Ua,Ea.vertical,wl,Oc,Ma,cl),$l&&(am=new w_(bs,Zr,da,Va,Ua,$l,pa,Pa,Ma,cl))}if(il){let cl=nl.layout.get("icon-rotate").evaluate(ns,{}),Sh=nl.layout.get("icon-text-fit")!=="none",Rf=bp(il,cl,wp,Sh),Pu=$l?bp($l,cl,wp,Sh):void 0;Df=new w_(bs,Zr,da,Va,Ua,il,pa,Pa,!1,cl),Ly=4*Rf.length;let zf=Sn.iconSizeData,_d=null;zf.kind==="source"?(_d=[dd*nl.layout.get("icon-size").evaluate(ns,{})],_d[0]>_p&&Jo(`${Sn.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):zf.kind==="composite"&&(_d=[dd*Jh.compositeIconSizes[0].evaluate(ns,{},Mu),dd*Jh.compositeIconSizes[1].evaluate(ns,{},Mu)],(_d[0]>_p||_d[1]>_p)&&Jo(`${Sn.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),Sn.addSymbols(Sn.icon,Rf,_d,ta,Ts,ns,O.an.none,Zr,md.lineStartIndex,md.lineLength,-1,Mu),kg=Sn.icon.placedSymbolArray.length-1,Pu&&(ky=4*Pu.length,Sn.addSymbols(Sn.icon,Pu,_d,ta,Ts,ns,O.an.vertical,Zr,md.lineStartIndex,md.lineLength,-1,Mu),M_=Sn.icon.placedSymbolArray.length-1)}let Ny=Object.keys(Ea.horizontal);for(let cl of Ny){let Sh=Ea.horizontal[cl];if(!tf){By=Ca(Sh.text);let Pu=nl.layout.get("text-rotate").evaluate(ns,{},Mu);tf=new w_(bs,Zr,da,Va,Ua,Sh,wl,Oc,Ma,Pu)}let Rf=Sh.positionedLines.length===1;if(Oy+=Dg(Sn,Zr,Sh,ql,nl,Ma,ns,_c,md,Ea.vertical?O.an.horizontal:O.an.horizontalOnly,Rf?Ny:[cl],Tp,kg,Jh,Mu),Rf)break}Ea.vertical&&(Fy+=Dg(Sn,Zr,Ea.vertical,ql,nl,Ma,ns,_c,md,O.an.vertical,["vertical"],Tp,M_,Jh,Mu));let Og=tf?tf.boxStartIndex:Sn.collisionBoxArray.length,Fg=tf?tf.boxEndIndex:Sn.collisionBoxArray.length,Vy=sm?sm.boxStartIndex:Sn.collisionBoxArray.length,Uy=sm?sm.boxEndIndex:Sn.collisionBoxArray.length,jy=Df?Df.boxStartIndex:Sn.collisionBoxArray.length,Gy=Df?Df.boxEndIndex:Sn.collisionBoxArray.length,Zy=am?am.boxStartIndex:Sn.collisionBoxArray.length,qy=am?am.boxEndIndex:Sn.collisionBoxArray.length,Qh=-1,Xm=(cl,Sh)=>cl&&cl.circleDiameter?Math.max(cl.circleDiameter,Sh):Sh;Qh=Xm(tf,Qh),Qh=Xm(sm,Qh),Qh=Xm(Df,Qh),Qh=Xm(am,Qh);let P_=Qh>-1?1:0;P_&&(Qh*=zy/vs),Sn.glyphOffsetArray.length>=Qf.MAX_GLYPHS&&Jo("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),ns.sortKey!==void 0&&Sn.addToSortKeyRanges(Sn.symbolInstances.length,ns.sortKey);let $y=ef(nl,ns,Mu),[sx,Km]=function(cl,Sh){let Rf=cl.length,Pu=Sh?.values;if(Pu?.length>0)for(let zf=0;zf<Pu.length;zf+=2){let _d=Pu[zf+1];cl.emplaceBack(O.aD[Pu[zf]],_d[0],_d[1])}return[Rf,cl.length]}(Sn.textAnchorOffsets,$y);Sn.symbolInstances.emplaceBack(Zr.x,Zr.y,Tp.right>=0?Tp.right:-1,Tp.center>=0?Tp.center:-1,Tp.left>=0?Tp.left:-1,Tp.vertical||-1,kg,M_,By,Og,Fg,Vy,Uy,jy,Gy,Zy,qy,da,Oy,Fy,Ly,ky,P_,0,wl,Qh,sx,Km)}(d,Nn,Hn,u,y,T,Zi,d.layers[0],d.collisionBoxArray,s.index,s.sourceLayerIndex,d.index,lt,[Ze,Ze,Ze,Ze],Ai,G,yt,bt,ci,Te,s,D,K,Q,R)};if(gi==="line")for(let Hn of x_(s.geometry,0,0,Hr,Hr)){let Nn=Qe(Hn,bi),Sn=Py(Nn,ye,ni,u.vertical||De,y,24,Mt,d.overscaling,Hr);for(let Zr of Sn)De&&Dy(d,De.text,Fi,Zr)||fn(Nn,Zr)}else if(gi==="line-center"){for(let Hn of s.geometry)if(Hn.length>1){let Nn=Qe(Hn,bi),Sn=My(Nn,ni,u.vertical||De,y,24,Mt);Sn&&fn(Nn,Sn)}}else if(s.type==="Polygon")for(let Hn of Js(s.geometry,0)){let Nn=Af(Hn,16);fn(Qe(Hn[0],bi,!0),new vp(Nn.x,Nn.y,0))}else if(s.type==="LineString")for(let Hn of s.geometry){let Nn=Qe(Hn,bi);fn(Nn,new vp(Nn[0].x,Nn[0].y,0))}else if(s.type==="Point")for(let Hn of s.geometry)for(let Nn of Hn)fn([Nn],new vp(Nn.x,Nn.y,0))}function Dg(d,s,u,y,T,D,R,B,G,K,Q,ce,_e,ve,Te){let De=function(Mt,yt,ye,Ze,bt,ni,Ai,ci){let gi=Ze.layout.get("text-rotate").evaluate(ni,{})*Math.PI/180,Fi=[];for(let Mi of yt.positionedLines)for(let Zi of Mi.positionedGlyphs){if(!Zi.rect)continue;let bi=Zi.rect||{},fn=4,Hn=!0,Nn=1,Sn=0,Zr=(bt||ci)&&Zi.vertical,zs=Zi.metrics.advance*Zi.scale/2;if(ci&&yt.verticalizable&&(Sn=Mi.lineOffset/2-(Zi.imageName?-(vs-Zi.metrics.width*Zi.scale)/2:(Zi.scale-1)*vs)),Zi.imageName){let Pa=Ai[Zi.imageName];Hn=Pa.sdf,Nn=Pa.pixelRatio,fn=1/Nn}let Ea=bt?[Zi.x+zs,Zi.y]:[0,0],il=bt?[0,0]:[Zi.x+zs+ye[0],Zi.y+ye[1]-Sn],ql=[0,0];Zr&&(ql=il,il=[0,0]);let $l=Zi.metrics.isDoubleResolution?2:1,nl=(Zi.metrics.left-fn)*Zi.scale-zs+il[0],bs=(-Zi.metrics.top-fn)*Zi.scale+il[1],da=nl+bi.w/$l*Zi.scale/Nn,Va=bs+bi.h/$l*Zi.scale/Nn,Ua=new Wi(nl,bs),wl=new Wi(da,bs),Oc=new Wi(nl,Va),Ma=new Wi(da,Va);if(Zr){let Pa=new Wi(-zs,zs- -17),Ts=-Math.PI/2,ta=12-zs,ns=new Wi(22-ta,-(Zi.imageName?ta:0)),Jh=new Wi(...ql);Ua._rotateAround(Ts,Pa)._add(ns)._add(Jh),wl._rotateAround(Ts,Pa)._add(ns)._add(Jh),Oc._rotateAround(Ts,Pa)._add(ns)._add(Jh),Ma._rotateAround(Ts,Pa)._add(ns)._add(Jh)}if(gi){let Pa=Math.sin(gi),Ts=Math.cos(gi),ta=[Ts,-Pa,Pa,Ts];Ua._matMult(ta),wl._matMult(ta),Oc._matMult(ta),Ma._matMult(ta)}let _c=new Wi(0,0),pa=new Wi(0,0);Fi.push({tl:Ua,tr:wl,bl:Oc,br:Ma,tex:bi,writingMode:yt.writingMode,glyphOffset:Ea,sectionIndex:Zi.sectionIndex,isSDF:Hn,pixelOffsetTL:_c,pixelOffsetBR:pa,minFontScaleX:0,minFontScaleY:0})}return Fi}(0,u,B,T,D,R,y,d.allowVerticalPlacement),Ye=d.textSizeData,lt=null;Ye.kind==="source"?(lt=[dd*T.layout.get("text-size").evaluate(R,{})],lt[0]>_p&&Jo(`${d.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):Ye.kind==="composite"&&(lt=[dd*ve.compositeTextSizes[0].evaluate(R,{},Te),dd*ve.compositeTextSizes[1].evaluate(R,{},Te)],(lt[0]>_p||lt[1]>_p)&&Jo(`${d.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),d.addSymbols(d.text,De,lt,B,D,R,K,s,G.lineStartIndex,G.lineLength,_e,Te);for(let Mt of Q)ce[Mt]=d.text.placedSymbolArray.length-1;return 4*De.length}function Rg(d){for(let s in d)return d[s];return null}function Dy(d,s,u,y){let T=d.compareText;if(s in T){let D=T[s];for(let R=D.length-1;R>=0;R--)if(y.dist(D[R])<u)return!0}else T[s]=[];return T[s].push(y),!1}let qm=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class zg{static from(s){if(!(s instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");let[u,y]=new Uint8Array(s,0,2);if(u!==219)throw new Error("Data does not appear to be in a KDBush format.");let T=y>>4;if(T!==1)throw new Error(`Got v${T} data when expected v1.`);let D=qm[15&y];if(!D)throw new Error("Unrecognized array type.");let[R]=new Uint16Array(s,2,1),[B]=new Uint32Array(s,4,1);return new zg(B,R,D,s)}constructor(s,u=64,y=Float64Array,T){if(isNaN(s)||s<0)throw new Error(`Unpexpected numItems value: ${s}.`);this.numItems=+s,this.nodeSize=Math.min(Math.max(+u,2),65535),this.ArrayType=y,this.IndexArrayType=s<65536?Uint16Array:Uint32Array;let D=qm.indexOf(this.ArrayType),R=2*s*this.ArrayType.BYTES_PER_ELEMENT,B=s*this.IndexArrayType.BYTES_PER_ELEMENT,G=(8-B%8)%8;if(D<0)throw new Error(`Unexpected typed array class: ${y}.`);T&&T instanceof ArrayBuffer?(this.data=T,this.ids=new this.IndexArrayType(this.data,8,s),this.coords=new this.ArrayType(this.data,8+B+G,2*s),this._pos=2*s,this._finished=!0):(this.data=new ArrayBuffer(8+R+B+G),this.ids=new this.IndexArrayType(this.data,8,s),this.coords=new this.ArrayType(this.data,8+B+G,2*s),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+D]),new Uint16Array(this.data,2,1)[0]=u,new Uint32Array(this.data,4,1)[0]=s)}add(s,u){let y=this._pos>>1;return this.ids[y]=y,this.coords[this._pos++]=s,this.coords[this._pos++]=u,y}finish(){let s=this._pos>>1;if(s!==this.numItems)throw new Error(`Added ${s} items when expected ${this.numItems}.`);return Lg(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(s,u,y,T){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:D,coords:R,nodeSize:B}=this,G=[0,D.length-1,0],K=[];for(;G.length;){let Q=G.pop()||0,ce=G.pop()||0,_e=G.pop()||0;if(ce-_e<=B){for(let Ye=_e;Ye<=ce;Ye++){let lt=R[2*Ye],Mt=R[2*Ye+1];lt>=s&&lt<=y&&Mt>=u&&Mt<=T&&K.push(D[Ye])}continue}let ve=_e+ce>>1,Te=R[2*ve],De=R[2*ve+1];Te>=s&&Te<=y&&De>=u&&De<=T&&K.push(D[ve]),(Q===0?s<=Te:u<=De)&&(G.push(_e),G.push(ve-1),G.push(1-Q)),(Q===0?y>=Te:T>=De)&&(G.push(ve+1),G.push(ce),G.push(1-Q))}return K}within(s,u,y){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:T,coords:D,nodeSize:R}=this,B=[0,T.length-1,0],G=[],K=y*y;for(;B.length;){let Q=B.pop()||0,ce=B.pop()||0,_e=B.pop()||0;if(ce-_e<=R){for(let Ye=_e;Ye<=ce;Ye++)I_(D[2*Ye],D[2*Ye+1],s,u)<=K&&G.push(T[Ye]);continue}let ve=_e+ce>>1,Te=D[2*ve],De=D[2*ve+1];I_(Te,De,s,u)<=K&&G.push(T[ve]),(Q===0?s-y<=Te:u-y<=De)&&(B.push(_e),B.push(ve-1),B.push(1-Q)),(Q===0?s+y>=Te:u+y>=De)&&(B.push(ve+1),B.push(ce),B.push(1-Q))}return G}}function Lg(d,s,u,y,T,D){if(T-y<=u)return;let R=y+T>>1;S_(d,s,R,y,T,D),Lg(d,s,u,y,R-1,1-D),Lg(d,s,u,R+1,T,1-D)}function S_(d,s,u,y,T,D){for(;T>y;){if(T-y>600){let K=T-y+1,Q=u-y+1,ce=Math.log(K),_e=.5*Math.exp(2*ce/3),ve=.5*Math.sqrt(ce*_e*(K-_e)/K)*(Q-K/2<0?-1:1);S_(d,s,u,Math.max(y,Math.floor(u-Q*_e/K+ve)),Math.min(T,Math.floor(u+(K-Q)*_e/K+ve)),D)}let R=s[2*u+D],B=y,G=T;for(rm(d,s,y,u),s[2*T+D]>R&&rm(d,s,y,T);B<G;){for(rm(d,s,B,G),B++,G--;s[2*B+D]<R;)B++;for(;s[2*G+D]>R;)G--}s[2*y+D]===R?rm(d,s,y,G):(G++,rm(d,s,G,T)),G<=u&&(y=G+1),u<=G&&(T=G-1)}}function rm(d,s,u,y){$m(d,u,y),$m(s,2*u,2*y),$m(s,2*u+1,2*y+1)}function $m(d,s,u){let y=d[s];d[s]=d[u],d[u]=y}function I_(d,s,u,y){let T=d-u,D=s-y;return T*T+D*D}var C_;O.cw=void 0,(C_=O.cw||(O.cw={})).create="create",C_.load="load",C_.fullLoad="fullLoad";let Wm=null,om=[],E_=1e3/60,Hm="loadTime",Yh="fullLoadTime",Ry={mark(d){performance.mark(d)},frame(d){let s=d;Wm!=null&&om.push(s-Wm),Wm=s},clearMetrics(){Wm=null,om=[],performance.clearMeasures(Hm),performance.clearMeasures(Yh);for(let d in O.cw)performance.clearMarks(O.cw[d])},getPerformanceMetrics(){performance.measure(Hm,O.cw.create,O.cw.load),performance.measure(Yh,O.cw.create,O.cw.fullLoad);let d=performance.getEntriesByName(Hm)[0].duration,s=performance.getEntriesByName(Yh)[0].duration,u=om.length,y=1/(om.reduce((D,R)=>D+R,0)/u/1e3),T=om.filter(D=>D>E_).reduce((D,R)=>D+(R-E_)/E_,0);return{loadTime:d,fullLoadTime:s,fps:y,percentDroppedFrames:T/(u+T)*100,totalFrames:u}}};O.$=Hr,O.A=Br,O.B=function([d,s,u]){return s+=90,s*=Math.PI/180,u*=Math.PI/180,{x:d*Math.cos(s)*Math.sin(u),y:d*Math.sin(s)*Math.sin(u),z:d*Math.cos(u)}},O.C=Xn,O.D=pn,O.E=wi,O.F=jo,O.G=qd,O.H=function(d){if(ba==null){let s=d.navigator?d.navigator.userAgent:null;ba=!!d.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return ba},O.I=Um,O.J=class{constructor(d,s){this.target=d,this.mapId=s,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new rx(()=>this.process()),this.subscription=ml(this.target,"message",u=>this.receive(u),!1),this.globalScope=Vo(self)?d:window}registerMessageHandler(d,s){this.messageHandlers[d]=s}sendAsync(d,s){return new Promise((u,y)=>{let T=Math.round(1e18*Math.random()).toString(36).substring(0,10),D=s?ml(s.signal,"abort",()=>{D?.unsubscribe(),delete this.resolveRejects[T];let G={id:T,type:"<cancel>",origin:location.origin,targetMapId:d.targetMapId,sourceMapId:this.mapId};this.target.postMessage(G)},vg):null;this.resolveRejects[T]={resolve:G=>{D?.unsubscribe(),u(G)},reject:G=>{D?.unsubscribe(),y(G)}};let R=[],B=Object.assign(Object.assign({},d),{id:T,sourceMapId:this.mapId,origin:location.origin,data:Vh(d.data,R)});this.target.postMessage(B,{transfer:R})})}receive(d){let s=d.data,u=s.id;if(!(s.origin!=="file://"&&location.origin!=="file://"&&s.origin!=="resource://android"&&location.origin!=="resource://android"&&s.origin!==location.origin||s.targetMapId&&this.mapId!==s.targetMapId)){if(s.type==="<cancel>"){delete this.tasks[u];let y=this.abortControllers[u];return delete this.abortControllers[u],void(y&&y.abort())}if(Vo(self)||s.mustQueue)return this.tasks[u]=s,this.taskQueue.push(u),void this.invoker.trigger();this.processTask(u,s)}}process(){if(this.taskQueue.length===0)return;let d=this.taskQueue.shift(),s=this.tasks[d];delete this.tasks[d],this.taskQueue.length>0&&this.invoker.trigger(),s&&this.processTask(d,s)}processTask(d,s){return t(this,void 0,void 0,function*(){if(s.type==="<response>"){let T=this.resolveRejects[d];return delete this.resolveRejects[d],T?void(s.error?T.reject(gl(s.error)):T.resolve(gl(s.data))):void 0}if(!this.messageHandlers[s.type])return void this.completeTask(d,new Error(`Could not find a registered handler for ${s.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));let u=gl(s.data),y=new AbortController;this.abortControllers[d]=y;try{let T=yield this.messageHandlers[s.type](s.sourceMapId,u,y);this.completeTask(d,null,T)}catch(T){this.completeTask(d,T)}})}completeTask(d,s,u){let y=[];delete this.abortControllers[d];let T={id:d,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:s?Vh(s):null,data:Vh(u,y)};this.target.postMessage(T,{transfer:y})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},O.K=He,O.L=function(){var d=new Br(16);return Br!=Float32Array&&(d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[11]=0,d[12]=0,d[13]=0,d[14]=0),d[0]=1,d[5]=1,d[10]=1,d[15]=1,d},O.M=function(d,s,u){var y,T,D,R,B,G,K,Q,ce,_e,ve,Te,De=u[0],Ye=u[1],lt=u[2];return s===d?(d[12]=s[0]*De+s[4]*Ye+s[8]*lt+s[12],d[13]=s[1]*De+s[5]*Ye+s[9]*lt+s[13],d[14]=s[2]*De+s[6]*Ye+s[10]*lt+s[14],d[15]=s[3]*De+s[7]*Ye+s[11]*lt+s[15]):(T=s[1],D=s[2],R=s[3],B=s[4],G=s[5],K=s[6],Q=s[7],ce=s[8],_e=s[9],ve=s[10],Te=s[11],d[0]=y=s[0],d[1]=T,d[2]=D,d[3]=R,d[4]=B,d[5]=G,d[6]=K,d[7]=Q,d[8]=ce,d[9]=_e,d[10]=ve,d[11]=Te,d[12]=y*De+B*Ye+ce*lt+s[12],d[13]=T*De+G*Ye+_e*lt+s[13],d[14]=D*De+K*Ye+ve*lt+s[14],d[15]=R*De+Q*Ye+Te*lt+s[15]),d},O.N=function(d,s,u){var y=u[0],T=u[1],D=u[2];return d[0]=s[0]*y,d[1]=s[1]*y,d[2]=s[2]*y,d[3]=s[3]*y,d[4]=s[4]*T,d[5]=s[5]*T,d[6]=s[6]*T,d[7]=s[7]*T,d[8]=s[8]*D,d[9]=s[9]*D,d[10]=s[10]*D,d[11]=s[11]*D,d[12]=s[12],d[13]=s[13],d[14]=s[14],d[15]=s[15],d},O.O=function(d,s,u){var y=s[0],T=s[1],D=s[2],R=s[3],B=s[4],G=s[5],K=s[6],Q=s[7],ce=s[8],_e=s[9],ve=s[10],Te=s[11],De=s[12],Ye=s[13],lt=s[14],Mt=s[15],yt=u[0],ye=u[1],Ze=u[2],bt=u[3];return d[0]=yt*y+ye*B+Ze*ce+bt*De,d[1]=yt*T+ye*G+Ze*_e+bt*Ye,d[2]=yt*D+ye*K+Ze*ve+bt*lt,d[3]=yt*R+ye*Q+Ze*Te+bt*Mt,d[4]=(yt=u[4])*y+(ye=u[5])*B+(Ze=u[6])*ce+(bt=u[7])*De,d[5]=yt*T+ye*G+Ze*_e+bt*Ye,d[6]=yt*D+ye*K+Ze*ve+bt*lt,d[7]=yt*R+ye*Q+Ze*Te+bt*Mt,d[8]=(yt=u[8])*y+(ye=u[9])*B+(Ze=u[10])*ce+(bt=u[11])*De,d[9]=yt*T+ye*G+Ze*_e+bt*Ye,d[10]=yt*D+ye*K+Ze*ve+bt*lt,d[11]=yt*R+ye*Q+Ze*Te+bt*Mt,d[12]=(yt=u[12])*y+(ye=u[13])*B+(Ze=u[14])*ce+(bt=u[15])*De,d[13]=yt*T+ye*G+Ze*_e+bt*Ye,d[14]=yt*D+ye*K+Ze*ve+bt*lt,d[15]=yt*R+ye*Q+Ze*Te+bt*Mt,d},O.P=Wi,O.Q=function(d,s){let u={};for(let y=0;y<s.length;y++){let T=s[y];T in d&&(u[T]=d[T])}return u},O.R=Ba,O.S=gp,O.T=Fm,O.U=Mf,O.V=Gs,O.W=Bo,O.X=qo,O.Y=fl,O.Z=mc,O._=t,O.a=Le,O.a$=function(d,s,u){return d[0]=s[0]*u,d[1]=s[1]*u,d[2]=s[2]*u,d[3]=s[3]*u,d},O.a0=yp,O.a1=Pf,O.a2=25,O.a3=m_,O.a4=d=>{let s=window.document.createElement("video");return s.muted=!0,new Promise(u=>{s.onloadstart=()=>{u(s)};for(let y of d){let T=window.document.createElement("source");Xt(y)||(s.crossOrigin="Anonymous"),T.src=y,s.appendChild(T)}})},O.a5=nt,O.a6=function(){return va++},O.a7=tt,O.a8=Qf,O.a9=ac,O.aA=vs,O.aB=Da,O.aC=function(d,s,u,y,T=!1){if(!u[0]&&!u[1])return[0,0];let D=T?y==="map"?-d.bearingInRadians:0:y==="viewport"?d.bearingInRadians:0;if(D){let R=Math.sin(D),B=Math.cos(D);u=[u[0]*B-u[1]*R,u[0]*R+u[1]*B]}return[T?u[0]:Da(s,u[0],d.zoom),T?u[1]:Da(s,u[1],d.zoom)]},O.aE=f_,O.aF=Ag,O.aG=dg,O.aH=zg,O.aI=ys,O.aJ=Ge,O.aK=Kt,O.aL=lr,O.aM=vo,O.aN=yc,O.aO=Ha,O.aP=jm,O.aQ=No,O.aR=qa,O.aS=function(d){var s=new Br(3);return s[0]=d[0],s[1]=d[1],s[2]=d[2],s},O.aT=function(d,s,u){return d[0]=s[0]-u[0],d[1]=s[1]-u[1],d[2]=s[2]-u[2],d},O.aU=function(d,s){var u=s[0],y=s[1],T=s[2],D=u*u+y*y+T*T;return D>0&&(D=1/Math.sqrt(D)),d[0]=s[0]*D,d[1]=s[1]*D,d[2]=s[2]*D,d},O.aV=Ur,O.aW=function(d,s){return d[0]*s[0]+d[1]*s[1]+d[2]*s[2]},O.aX=function(d,s,u){return d[0]=s[0]*u[0],d[1]=s[1]*u[1],d[2]=s[2]*u[2],d[3]=s[3]*u[3],d},O.aY=Ql,O.aZ=function(d,s,u){let y=s[0]*u[0]+s[1]*u[1]+s[2]*u[2];return y===0?null:(-(d[0]*u[0]+d[1]*u[1]+d[2]*u[2])-u[3])/y},O.a_=ss,O.aa=$h,O.ab=__,O.ac=function(d){let s={};if(d.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(u,y,T,D)=>{let R=T||D;return s[y]=!R||R.toLowerCase(),""}),s["max-age"]){let u=parseInt(s["max-age"],10);isNaN(u)?delete s["max-age"]:s["max-age"]=u}return s},O.ad=Hs,O.ae=function(d){return Math.pow(2,d)},O.af=ga,O.ag=gr,O.ah=85.051129,O.ai=wg,O.aj=function(d){return Math.log(d)/Math.LN2},O.ak=function(d){var s=d[0],u=d[1];return s*s+u*u},O.al=function(d,s){let u=[];for(let y in d)y in s||u.push(y);return u},O.am=function(d,s){let u=0,y=0;if(d.kind==="constant")y=d.layoutSize;else if(d.kind!=="source"){let{interpolationType:T,minZoom:D,maxZoom:R}=d,B=T?gr(Ri.interpolationFactor(T,s,D,R),0,1):0;d.kind==="camera"?y=Xn.number(d.minSize,d.maxSize,B):u=B}return{uSizeT:u,uSize:y}},O.ao=function(d,{uSize:s,uSizeT:u},{lowerSize:y,upperSize:T}){return d.kind==="source"?y/dd:d.kind==="composite"?Xn.number(y/dd,T/dd,u):s},O.ap=function(d,s){var u=s[0],y=s[1],T=s[2],D=s[3],R=s[4],B=s[5],G=s[6],K=s[7],Q=s[8],ce=s[9],_e=s[10],ve=s[11],Te=s[12],De=s[13],Ye=s[14],lt=s[15],Mt=u*B-y*R,yt=u*G-T*R,ye=u*K-D*R,Ze=y*G-T*B,bt=y*K-D*B,ni=T*K-D*G,Ai=Q*De-ce*Te,ci=Q*Ye-_e*Te,gi=Q*lt-ve*Te,Fi=ce*Ye-_e*De,Mi=ce*lt-ve*De,Zi=_e*lt-ve*Ye,bi=Mt*Zi-yt*Mi+ye*Fi+Ze*gi-bt*ci+ni*Ai;return bi?(d[0]=(B*Zi-G*Mi+K*Fi)*(bi=1/bi),d[1]=(T*Mi-y*Zi-D*Fi)*bi,d[2]=(De*ni-Ye*bt+lt*Ze)*bi,d[3]=(_e*bt-ce*ni-ve*Ze)*bi,d[4]=(G*gi-R*Zi-K*ci)*bi,d[5]=(u*Zi-T*gi+D*ci)*bi,d[6]=(Ye*ye-Te*ni-lt*yt)*bi,d[7]=(Q*ni-_e*ye+ve*yt)*bi,d[8]=(R*Mi-B*gi+K*Ai)*bi,d[9]=(y*gi-u*Mi-D*Ai)*bi,d[10]=(Te*bt-De*ye+lt*Mt)*bi,d[11]=(ce*ye-Q*bt-ve*Mt)*bi,d[12]=(B*ci-R*Fi-G*Ai)*bi,d[13]=(u*Fi-y*ci+T*Ai)*bi,d[14]=(De*yt-Te*Ze-Ye*Mt)*bi,d[15]=(Q*Ze-ce*yt+_e*Mt)*bi,d):null},O.aq=Mr,O.ar=function(d){return Math.hypot(d[0],d[1])},O.as=function(d){return d[0]=0,d[1]=0,d},O.at=function(d,s,u){return d[0]=s[0]*u,d[1]=s[1]*u,d},O.au=ua,O.av=ya,O.aw=function(d,s,u,y){let T=s.y-d.y,D=s.x-d.x,R=y.y-u.y,B=y.x-u.x,G=R*D-B*T;if(G===0)return null;let K=(B*(d.y-u.y)-R*(d.x-u.x))/G;return new Wi(d.x+K*D,d.y+K*T)},O.ax=x_,O.ay=ap,O.az=function(d){let s=1/0,u=1/0,y=-1/0,T=-1/0;for(let D of d)s=Math.min(s,D.x),u=Math.min(u,D.y),y=Math.max(y,D.x),T=Math.max(T,D.y);return[s,u,y,T]},O.b=Wa,O.b$=dp,O.b0=function(d,s){return d[0]*s[0]+d[1]*s[1]+d[2]*s[2]+d[3]},O.b1=nm,O.b2=xp,O.b3=function(d,s,u,y,T){var D,R=1/Math.tan(s/2);return d[0]=R/u,d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=R,d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[11]=-1,d[12]=0,d[13]=0,d[15]=0,T!=null&&T!==1/0?(d[10]=(T+y)*(D=1/(y-T)),d[14]=2*T*y*D):(d[10]=-1,d[14]=-2*y),d},O.b4=function(d){var s=new Br(16);return s[0]=d[0],s[1]=d[1],s[2]=d[2],s[3]=d[3],s[4]=d[4],s[5]=d[5],s[6]=d[6],s[7]=d[7],s[8]=d[8],s[9]=d[9],s[10]=d[10],s[11]=d[11],s[12]=d[12],s[13]=d[13],s[14]=d[14],s[15]=d[15],s},O.b5=function(d,s,u){var y=Math.sin(u),T=Math.cos(u),D=s[0],R=s[1],B=s[2],G=s[3],K=s[4],Q=s[5],ce=s[6],_e=s[7];return s!==d&&(d[8]=s[8],d[9]=s[9],d[10]=s[10],d[11]=s[11],d[12]=s[12],d[13]=s[13],d[14]=s[14],d[15]=s[15]),d[0]=D*T+K*y,d[1]=R*T+Q*y,d[2]=B*T+ce*y,d[3]=G*T+_e*y,d[4]=K*T-D*y,d[5]=Q*T-R*y,d[6]=ce*T-B*y,d[7]=_e*T-G*y,d},O.b6=function(d,s,u){var y=Math.sin(u),T=Math.cos(u),D=s[4],R=s[5],B=s[6],G=s[7],K=s[8],Q=s[9],ce=s[10],_e=s[11];return s!==d&&(d[0]=s[0],d[1]=s[1],d[2]=s[2],d[3]=s[3],d[12]=s[12],d[13]=s[13],d[14]=s[14],d[15]=s[15]),d[4]=D*T+K*y,d[5]=R*T+Q*y,d[6]=B*T+ce*y,d[7]=G*T+_e*y,d[8]=K*T-D*y,d[9]=Q*T-R*y,d[10]=ce*T-B*y,d[11]=_e*T-G*y,d},O.b7=function(){let d=new Float32Array(16);return ga(d),d},O.b8=function(){let d=new Float64Array(16);return ga(d),d},O.b9=function(){return new Float64Array(16)},O.bA=function(d){return d[0]=0,d[1]=0,d[2]=0,d},O.bB=function(d,s,u,y){let T=Math.sqrt(d*d+s*s),D=Math.sqrt(u*u+y*y);d/=T,s/=T,u/=D,y/=D;let R=Math.acos(d*u+s*y);return-s*u+d*y>0?R:-R},O.bC=function(d,s){let u=xa(d,2*Math.PI),y=xa(s,2*Math.PI);return Math.min(Math.abs(u-y),Math.abs(u-y+2*Math.PI),Math.abs(u-y-2*Math.PI))},O.bD=function(){let d={},s=Ue.$version;for(let u in Ue.$root){let y=Ue.$root[u];if(y.required){let T=null;T=u==="version"?s:y.type==="array"?[]:{},T!=null&&(d[u]=T)}}return d},O.bE=qp,O.bF=St,O.bG=function d(s,u){if(Array.isArray(s)){if(!Array.isArray(u)||s.length!==u.length)return!1;for(let y=0;y<s.length;y++)if(!d(s[y],u[y]))return!1;return!0}if(typeof s=="object"&&s!==null&&u!==null){if(typeof u!="object"||Object.keys(s).length!==Object.keys(u).length)return!1;for(let y in s)if(!d(s[y],u[y]))return!1;return!0}return s===u},O.bH=function(d){d=d.slice();let s=Object.create(null);for(let u=0;u<d.length;u++)s[d[u].id]=d[u];for(let u=0;u<d.length;u++)"ref"in d[u]&&(d[u]=$n(d[u],s[d[u].ref]));return d},O.bI=function(d){if(d.type==="custom")return new nx(d);switch(d.type){case"background":return new ex(d);case"circle":return new sg(d);case"color-relief":return new Nm(d);case"fill":return new _t(d);case"fill-extrusion":return new Lo(d);case"heatmap":return new Xf(d);case"hillshade":return new xf(d);case"line":return new Zl(d);case"raster":return new ix(d);case"symbol":return new pd(d)}},O.bJ=ra,O.bK=function(d,s){if(!d)return[{command:"setStyle",args:[s]}];let u=[];try{if(!ht(d.version,s.version))return[{command:"setStyle",args:[s]}];ht(d.center,s.center)||u.push({command:"setCenter",args:[s.center]}),ht(d.state,s.state)||u.push({command:"setGlobalState",args:[s.state]}),ht(d.centerAltitude,s.centerAltitude)||u.push({command:"setCenterAltitude",args:[s.centerAltitude]}),ht(d.zoom,s.zoom)||u.push({command:"setZoom",args:[s.zoom]}),ht(d.bearing,s.bearing)||u.push({command:"setBearing",args:[s.bearing]}),ht(d.pitch,s.pitch)||u.push({command:"setPitch",args:[s.pitch]}),ht(d.roll,s.roll)||u.push({command:"setRoll",args:[s.roll]}),ht(d.sprite,s.sprite)||u.push({command:"setSprite",args:[s.sprite]}),ht(d.glyphs,s.glyphs)||u.push({command:"setGlyphs",args:[s.glyphs]}),ht(d.transition,s.transition)||u.push({command:"setTransition",args:[s.transition]}),ht(d.light,s.light)||u.push({command:"setLight",args:[s.light]}),ht(d.terrain,s.terrain)||u.push({command:"setTerrain",args:[s.terrain]}),ht(d.sky,s.sky)||u.push({command:"setSky",args:[s.sky]}),ht(d.projection,s.projection)||u.push({command:"setProjection",args:[s.projection]});let y={},T=[];(function(R,B,G,K){let Q;for(Q in B=B||{},R=R||{})Object.prototype.hasOwnProperty.call(R,Q)&&(Object.prototype.hasOwnProperty.call(B,Q)||Ae(Q,G,K));for(Q in B)Object.prototype.hasOwnProperty.call(B,Q)&&(Object.prototype.hasOwnProperty.call(R,Q)?ht(R[Q],B[Q])||(R[Q].type==="geojson"&&B[Q].type==="geojson"&&je(R,B,Q)?te(G,{command:"setGeoJSONSourceData",args:[Q,B[Q].data]}):qe(Q,B,G,K)):fe(Q,B,G))})(d.sources,s.sources,T,y);let D=[];d.layers&&d.layers.forEach(R=>{"source"in R&&y[R.source]?u.push({command:"removeLayer",args:[R.id]}):D.push(R)}),u=u.concat(T),function(R,B,G){B=B||[];let K=(R=R||[]).map(rt),Q=B.map(rt),ce=R.reduce(ct,{}),_e=B.reduce(ct,{}),ve=K.slice(),Te=Object.create(null),De,Ye,lt,Mt,yt;for(let ye=0,Ze=0;ye<K.length;ye++)De=K[ye],Object.prototype.hasOwnProperty.call(_e,De)?Ze++:(te(G,{command:"removeLayer",args:[De]}),ve.splice(ve.indexOf(De,Ze),1));for(let ye=0,Ze=0;ye<Q.length;ye++)De=Q[Q.length-1-ye],ve[ve.length-1-ye]!==De&&(Object.prototype.hasOwnProperty.call(ce,De)?(te(G,{command:"removeLayer",args:[De]}),ve.splice(ve.lastIndexOf(De,ve.length-Ze),1)):Ze++,Mt=ve[ve.length-ye],te(G,{command:"addLayer",args:[_e[De],Mt]}),ve.splice(ve.length-ye,0,De),Te[De]=!0);for(let ye=0;ye<Q.length;ye++)if(De=Q[ye],Ye=ce[De],lt=_e[De],!Te[De]&&!ht(Ye,lt))if(ht(Ye.source,lt.source)&&ht(Ye["source-layer"],lt["source-layer"])&&ht(Ye.type,lt.type)){for(yt in We(Ye.layout,lt.layout,G,De,null,"setLayoutProperty"),We(Ye.paint,lt.paint,G,De,null,"setPaintProperty"),ht(Ye.filter,lt.filter)||te(G,{command:"setFilter",args:[De,lt.filter]}),ht(Ye.minzoom,lt.minzoom)&&ht(Ye.maxzoom,lt.maxzoom)||te(G,{command:"setLayerZoomRange",args:[De,lt.minzoom,lt.maxzoom]}),Ye)Object.prototype.hasOwnProperty.call(Ye,yt)&&yt!=="layout"&&yt!=="paint"&&yt!=="filter"&&yt!=="metadata"&&yt!=="minzoom"&&yt!=="maxzoom"&&(yt.indexOf("paint.")===0?We(Ye[yt],lt[yt],G,De,yt.slice(6),"setPaintProperty"):ht(Ye[yt],lt[yt])||te(G,{command:"setLayerProperty",args:[De,yt,lt[yt]]}));for(yt in lt)Object.prototype.hasOwnProperty.call(lt,yt)&&!Object.prototype.hasOwnProperty.call(Ye,yt)&&yt!=="layout"&&yt!=="paint"&&yt!=="filter"&&yt!=="metadata"&&yt!=="minzoom"&&yt!=="maxzoom"&&(yt.indexOf("paint.")===0?We(Ye[yt],lt[yt],G,De,yt.slice(6),"setPaintProperty"):ht(Ye[yt],lt[yt])||te(G,{command:"setLayerProperty",args:[De,yt,lt[yt]]}))}else te(G,{command:"removeLayer",args:[De]}),Mt=ve[ve.lastIndexOf(De)+1],te(G,{command:"addLayer",args:[lt,Mt]})}(D,s.layers,u)}catch(y){console.warn("Unable to compute style diff:",y),u=[{command:"setStyle",args:[s]}]}return u},O.bL=function(d){let s=[],u=d.id;return u===void 0&&s.push({message:`layers.${u}: missing required property "id"`}),d.render===void 0&&s.push({message:`layers.${u}: missing required method "render"`}),d.renderingMode&&d.renderingMode!=="2d"&&d.renderingMode!=="3d"&&s.push({message:`layers.${u}: property "renderingMode" must be either "2d" or "3d"`}),s},O.bM=hr,O.bN=Cl,O.bO=class extends io{constructor(d,s){super(d,s),this.current=0}set(d){this.current!==d&&(this.current=d,this.gl.uniform1i(this.location,d))}},O.bP=Su,O.bQ=class extends io{constructor(d,s){super(d,s),this.current=el}set(d){if(d[12]!==this.current[12]||d[0]!==this.current[0])return this.current=d,void this.gl.uniformMatrix4fv(this.location,!1,d);for(let s=1;s<16;s++)if(d[s]!==this.current[s]){this.current=d,this.gl.uniformMatrix4fv(this.location,!1,d);break}}},O.bR=ts,O.bS=class extends io{constructor(d,s){super(d,s),this.current=[0,0,0]}set(d){d[0]===this.current[0]&&d[1]===this.current[1]&&d[2]===this.current[2]||(this.current=d,this.gl.uniform3f(this.location,d[0],d[1],d[2]))}},O.bT=class extends io{constructor(d,s){super(d,s),this.current=[0,0]}set(d){d[0]===this.current[0]&&d[1]===this.current[1]||(this.current=d,this.gl.uniform2f(this.location,d[0],d[1]))}},O.bU=os,O.bV=function(d,s){var u=Math.sin(s),y=Math.cos(s);return d[0]=y,d[1]=u,d[2]=0,d[3]=-u,d[4]=y,d[5]=0,d[6]=0,d[7]=0,d[8]=1,d},O.bW=function(d,s,u){var y=s[0],T=s[1],D=s[2];return d[0]=y*u[0]+T*u[3]+D*u[6],d[1]=y*u[1]+T*u[4]+D*u[7],d[2]=y*u[2]+T*u[5]+D*u[8],d},O.bX=function(d,s,u,y,T,D,R){var B=1/(s-u),G=1/(y-T),K=1/(D-R);return d[0]=-2*B,d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=-2*G,d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[10]=2*K,d[11]=0,d[12]=(s+u)*B,d[13]=(T+y)*G,d[14]=(R+D)*K,d[15]=1,d},O.bY=class extends io{constructor(d,s){super(d,s),this.current=new Array}set(d){if(d!=this.current){this.current=d;let s=new Float32Array(4*d.length);for(let u=0;u<d.length;u++)s[4*u]=d[u].r,s[4*u+1]=d[u].g,s[4*u+2]=d[u].b,s[4*u+3]=d[u].a;this.gl.uniform4fv(this.location,s)}}},O.bZ=class extends io{constructor(d,s){super(d,s),this.current=new Array}set(d){if(d!=this.current){this.current=d;let s=new Float32Array(d);this.gl.uniform1fv(this.location,s)}}},O.b_=class extends x{},O.ba=function(d,s,u){let y=new Float64Array(4);return $a(y,d,s-90,u),y},O.bb=function(d,s,u,y){var T,D,R,B,G,K=s[0],Q=s[1],ce=s[2],_e=s[3],ve=u[0],Te=u[1],De=u[2],Ye=u[3];return(D=K*ve+Q*Te+ce*De+_e*Ye)<0&&(D=-D,ve=-ve,Te=-Te,De=-De,Ye=-Ye),1-D>to?(T=Math.acos(D),R=Math.sin(T),B=Math.sin((1-y)*T)/R,G=Math.sin(y*T)/R):(B=1-y,G=y),d[0]=B*K+G*ve,d[1]=B*Q+G*Te,d[2]=B*ce+G*De,d[3]=B*_e+G*Ye,d},O.bc=function(d){let s=new Float64Array(9);var u,y,T,D,R,B,G,K,Q,ce,_e,ve,Te,De,Ye,lt,Mt,yt;ce=(T=(y=d)[0])*(G=T+T),_e=(D=y[1])*G,Te=(R=y[2])*G,De=R*(K=D+D),lt=(B=y[3])*G,Mt=B*K,yt=B*(Q=R+R),(u=s)[0]=1-(ve=D*K)-(Ye=R*Q),u[3]=_e-yt,u[6]=Te+Mt,u[1]=_e+yt,u[4]=1-ce-Ye,u[7]=De-lt,u[2]=Te-Mt,u[5]=De+lt,u[8]=1-ce-ve;let ye=Ha(-Math.asin(gr(s[2],-1,1))),Ze,bt;return Math.hypot(s[5],s[8])<.001?(Ze=0,bt=-Ha(Math.atan2(s[3],s[4]))):(Ze=Ha(s[5]===0&&s[8]===0?0:Math.atan2(s[5],s[8])),bt=Ha(s[1]===0&&s[0]===0?0:Math.atan2(s[1],s[0]))),{roll:Ze,pitch:ye+90,bearing:bt}},O.bd=function(d,s){return d.roll==s.roll&&d.pitch==s.pitch&&d.bearing==s.bearing},O.be=Pr,O.bf=ca,O.bg=Ne,O.bh=Ve,O.bi=Re,O.bj=Lr,O.bk=jr,O.bl=or,O.bm=function(d,s,u,y,T){return Lr(y,T,gr((d-s)/(u-s),0,1))},O.bn=xa,O.bo=function(){return new Float64Array(3)},O.bp=function(d,s,u,y){return d[0]=s[0]+u[0]*y,d[1]=s[1]+u[1]*y,d[2]=s[2]+u[2]*y,d},O.bq=$a,O.br=function(d,s,u){var y=u[0],T=u[1],D=u[2],R=s[0],B=s[1],G=s[2],K=T*G-D*B,Q=D*R-y*G,ce=y*B-T*R,_e=T*ce-D*Q,ve=D*K-y*ce,Te=y*Q-T*K,De=2*u[3];return Q*=De,ce*=De,ve*=2,Te*=2,d[0]=R+(K*=De)+(_e*=2),d[1]=B+Q+ve,d[2]=G+ce+Te,d},O.bs=function(d,s,u){let y=(T=[d[0],d[1],d[2],s[0],s[1],s[2],u[0],u[1],u[2]])[0]*((Q=T[8])*(R=T[4])-(B=T[5])*(K=T[7]))+T[1]*(-Q*(D=T[3])+B*(G=T[6]))+T[2]*(K*D-R*G);var T,D,R,B,G,K,Q;if(y===0)return null;let ce=Ur([],[s[0],s[1],s[2]],[u[0],u[1],u[2]]),_e=Ur([],[u[0],u[1],u[2]],[d[0],d[1],d[2]]),ve=Ur([],[d[0],d[1],d[2]],[s[0],s[1],s[2]]),Te=No([],ce,-d[3]);return qa(Te,Te,No([],_e,-s[3])),qa(Te,Te,No([],ve,-u[3])),No(Te,Te,1/y),Te},O.bt=bg,O.bu=function(){return new Float64Array(4)},O.bv=function(d,s,u,y){var T=[],D=[];return T[0]=s[0]-u[0],T[1]=s[1]-u[1],T[2]=s[2]-u[2],D[0]=T[0]*Math.cos(y)-T[1]*Math.sin(y),D[1]=T[0]*Math.sin(y)+T[1]*Math.cos(y),D[2]=T[2],d[0]=D[0]+u[0],d[1]=D[1]+u[1],d[2]=D[2]+u[2],d},O.bw=function(d,s,u,y){var T=[],D=[];return T[0]=s[0]-u[0],T[1]=s[1]-u[1],T[2]=s[2]-u[2],D[0]=T[0],D[1]=T[1]*Math.cos(y)-T[2]*Math.sin(y),D[2]=T[1]*Math.sin(y)+T[2]*Math.cos(y),d[0]=D[0]+u[0],d[1]=D[1]+u[1],d[2]=D[2]+u[2],d},O.bx=function(d,s,u,y){var T=[],D=[];return T[0]=s[0]-u[0],T[1]=s[1]-u[1],T[2]=s[2]-u[2],D[0]=T[2]*Math.sin(y)+T[0]*Math.cos(y),D[1]=T[1],D[2]=T[2]*Math.cos(y)-T[0]*Math.sin(y),d[0]=D[0]+u[0],d[1]=D[1]+u[1],d[2]=D[2]+u[2],d},O.by=function(d,s,u){var y=Math.sin(u),T=Math.cos(u),D=s[0],R=s[1],B=s[2],G=s[3],K=s[8],Q=s[9],ce=s[10],_e=s[11];return s!==d&&(d[4]=s[4],d[5]=s[5],d[6]=s[6],d[7]=s[7],d[12]=s[12],d[13]=s[13],d[14]=s[14],d[15]=s[15]),d[0]=D*T-K*y,d[1]=R*T-Q*y,d[2]=B*T-ce*y,d[3]=G*T-_e*y,d[8]=D*y+K*T,d[9]=R*y+Q*T,d[10]=B*y+ce*T,d[11]=G*y+_e*T,d},O.bz=function(d,s){let u=xa(d,360),y=xa(s,360),T=y-u,D=y>u?T-360:T+360;return Math.abs(T)<Math.abs(D)?T:D},O.c=Vt,O.c0=class extends A{},O.c1=Rc,O.c2=function(d){return d<=1?1:Math.pow(2,Math.ceil(Math.log(d)/Math.LN2))},O.c3=Kp,O.c4=function(d,s,u){var y=s[0],T=s[1],D=s[2],R=u[3]*y+u[7]*T+u[11]*D+u[15];return d[0]=(u[0]*y+u[4]*T+u[8]*D+u[12])/(R=R||1),d[1]=(u[1]*y+u[5]*T+u[9]*D+u[13])/R,d[2]=(u[2]*y+u[6]*T+u[10]*D+u[14])/R,d},O.c5=class extends mf{},O.c6=class extends ue{},O.c7=function(d,s){return d[0]===s[0]&&d[1]===s[1]&&d[2]===s[2]&&d[3]===s[3]&&d[4]===s[4]&&d[5]===s[5]&&d[6]===s[6]&&d[7]===s[7]&&d[8]===s[8]&&d[9]===s[9]&&d[10]===s[10]&&d[11]===s[11]&&d[12]===s[12]&&d[13]===s[13]&&d[14]===s[14]&&d[15]===s[15]},O.c8=function(d,s){var u=d[0],y=d[1],T=d[2],D=d[3],R=d[4],B=d[5],G=d[6],K=d[7],Q=d[8],ce=d[9],_e=d[10],ve=d[11],Te=d[12],De=d[13],Ye=d[14],lt=d[15],Mt=s[0],yt=s[1],ye=s[2],Ze=s[3],bt=s[4],ni=s[5],Ai=s[6],ci=s[7],gi=s[8],Fi=s[9],Mi=s[10],Zi=s[11],bi=s[12],fn=s[13],Hn=s[14],Nn=s[15];return Math.abs(u-Mt)<=to*Math.max(1,Math.abs(u),Math.abs(Mt))&&Math.abs(y-yt)<=to*Math.max(1,Math.abs(y),Math.abs(yt))&&Math.abs(T-ye)<=to*Math.max(1,Math.abs(T),Math.abs(ye))&&Math.abs(D-Ze)<=to*Math.max(1,Math.abs(D),Math.abs(Ze))&&Math.abs(R-bt)<=to*Math.max(1,Math.abs(R),Math.abs(bt))&&Math.abs(B-ni)<=to*Math.max(1,Math.abs(B),Math.abs(ni))&&Math.abs(G-Ai)<=to*Math.max(1,Math.abs(G),Math.abs(Ai))&&Math.abs(K-ci)<=to*Math.max(1,Math.abs(K),Math.abs(ci))&&Math.abs(Q-gi)<=to*Math.max(1,Math.abs(Q),Math.abs(gi))&&Math.abs(ce-Fi)<=to*Math.max(1,Math.abs(ce),Math.abs(Fi))&&Math.abs(_e-Mi)<=to*Math.max(1,Math.abs(_e),Math.abs(Mi))&&Math.abs(ve-Zi)<=to*Math.max(1,Math.abs(ve),Math.abs(Zi))&&Math.abs(Te-bi)<=to*Math.max(1,Math.abs(Te),Math.abs(bi))&&Math.abs(De-fn)<=to*Math.max(1,Math.abs(De),Math.abs(fn))&&Math.abs(Ye-Hn)<=to*Math.max(1,Math.abs(Ye),Math.abs(Hn))&&Math.abs(lt-Nn)<=to*Math.max(1,Math.abs(lt),Math.abs(Nn))},O.c9=function(d,s){return d[0]=s[0],d[1]=s[1],d[2]=s[2],d[3]=s[3],d[4]=s[4],d[5]=s[5],d[6]=s[6],d[7]=s[7],d[8]=s[8],d[9]=s[9],d[10]=s[10],d[11]=s[11],d[12]=s[12],d[13]=s[13],d[14]=s[14],d[15]=s[15],d},O.cA=function(d){delete Le.REGISTERED_PROTOCOLS[d]},O.cB=function(d,s){let u={};for(let T=0;T<d.length;T++){let D=s&&s[d[T].id]||Bd(d[T]);s&&(s[d[T].id]=D);let R=u[D];R||(R=u[D]=[]),R.push(d[T])}let y=[];for(let T in u)y.push(u[T]);return y},O.cC=sn,O.cD=Sg,O.cE=g_,O.cF=Yf,O.cG=function(d){d.bucket.createArrays(),d.bucket.tilePixelRatio=Hr/(512*d.bucket.overscaling),d.bucket.compareText={},d.bucket.iconsNeedLinear=!1;let s=d.bucket.layers[0],u=s.layout,y=s._unevaluatedLayout._values,T={layoutIconSize:y["icon-size"].possiblyEvaluate(new jo(d.bucket.zoom+1),d.canonical),layoutTextSize:y["text-size"].possiblyEvaluate(new jo(d.bucket.zoom+1),d.canonical),textMaxSize:y["text-size"].possiblyEvaluate(new jo(18))};if(d.bucket.textSizeData.kind==="composite"){let{minZoom:K,maxZoom:Q}=d.bucket.textSizeData;T.compositeTextSizes=[y["text-size"].possiblyEvaluate(new jo(K),d.canonical),y["text-size"].possiblyEvaluate(new jo(Q),d.canonical)]}if(d.bucket.iconSizeData.kind==="composite"){let{minZoom:K,maxZoom:Q}=d.bucket.iconSizeData;T.compositeIconSizes=[y["icon-size"].possiblyEvaluate(new jo(K),d.canonical),y["icon-size"].possiblyEvaluate(new jo(Q),d.canonical)]}let D=u.get("text-line-height")*vs,R=u.get("text-rotation-alignment")!=="viewport"&&u.get("symbol-placement")!=="point",B=u.get("text-keep-upright"),G=u.get("text-size");for(let K of d.bucket.features){let Q=u.get("text-font").evaluate(K,{},d.canonical).join(","),ce=G.evaluate(K,{},d.canonical),_e=T.layoutTextSize.evaluate(K,{},d.canonical),ve=T.layoutIconSize.evaluate(K,{},d.canonical),Te={horizontal:{},vertical:void 0},De=K.text,Ye,lt=[0,0];if(De){let ye=De.toString(),Ze=u.get("text-letter-spacing").evaluate(K,{},d.canonical)*vs,bt=Hd(ye)?Ze:0,ni=u.get("text-anchor").evaluate(K,{},d.canonical),Ai=ef(s,K,d.canonical);if(!Ai){let Mi=u.get("text-radial-offset").evaluate(K,{},d.canonical);lt=Mi?Pg(ni,[Mi*vs,T_]):u.get("text-offset").evaluate(K,{},d.canonical).map(Zi=>Zi*vs)}let ci=R?"center":u.get("text-justify").evaluate(K,{},d.canonical),gi=u.get("symbol-placement")==="point"?u.get("text-max-width").evaluate(K,{},d.canonical)*vs:1/0,Fi=()=>{d.bucket.allowVerticalPlacement&&Wd(ye)&&(Te.vertical=If(De,d.glyphMap,d.glyphPositions,d.imagePositions,Q,gi,D,ni,"left",bt,lt,O.an.vertical,!0,_e,ce))};if(!R&&Ai){let Mi=new Set;if(ci==="auto")for(let bi=0;bi<Ai.values.length;bi+=2)Mi.add(Ag(Ai.values[bi]));else Mi.add(ci);let Zi=!1;for(let bi of Mi)if(!Te.horizontal[bi])if(Zi)Te.horizontal[bi]=Te.horizontal[0];else{let fn=If(De,d.glyphMap,d.glyphPositions,d.imagePositions,Q,gi,D,"center",bi,bt,lt,O.an.horizontal,!1,_e,ce);fn&&(Te.horizontal[bi]=fn,Zi=fn.positionedLines.length===1)}Fi()}else{ci==="auto"&&(ci=Ag(ni));let Mi=If(De,d.glyphMap,d.glyphPositions,d.imagePositions,Q,gi,D,ni,ci,bt,lt,O.an.horizontal,!1,_e,ce);Mi&&(Te.horizontal[ci]=Mi),Fi(),Wd(ye)&&R&&B&&(Te.vertical=If(De,d.glyphMap,d.glyphPositions,d.imagePositions,Q,gi,D,ni,ci,bt,lt,O.an.vertical,!1,_e,ce))}}let Mt=!1;if(K.icon&&K.icon.name){let ye=d.imageMap[K.icon.name];ye&&(Ye=J0(d.imagePositions[K.icon.name],u.get("icon-offset").evaluate(K,{},d.canonical),u.get("icon-anchor").evaluate(K,{},d.canonical)),Mt=!!ye.sdf,d.bucket.sdfIcons===void 0?d.bucket.sdfIcons=Mt:d.bucket.sdfIcons!==Mt&&Jo("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(ye.pixelRatio!==d.bucket.pixelRatio||u.get("icon-rotate").constantOr(1)!==0)&&(d.bucket.iconsNeedLinear=!0))}let yt=Rg(Te.horizontal)||Te.vertical;d.bucket.iconsInText=!!yt&&yt.iconsInText,(yt||Ye)&&kc(d.bucket,K,Te,Ye,d.imageMap,T,_e,ve,lt,Mt,d.canonical,d.subdivisionGranularity)}d.showCollisionBoxes&&d.bucket.generateCollisionDebugBuffers()},O.cH=Gr,O.cI=Ut,O.cJ=no,O.cK=Er,O.cL=Kh,O.cM=class{constructor(d){this._marks={start:[d.url,"start"].join("#"),end:[d.url,"end"].join("#"),measure:d.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let d=performance.getEntriesByName(this._marks.measure);return d.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),d=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),d}},O.cN=function(d,s,u,y,T){return t(this,void 0,void 0,function*(){if(qo())try{return yield fl(d,s,u,y,T)}catch{}return function(D,R,B,G,K){let Q=D.width,ce=D.height;fs&&Ws||(fs=new OffscreenCanvas(Q,ce),Ws=fs.getContext("2d",{willReadFrequently:!0})),fs.width=Q,fs.height=ce,Ws.drawImage(D,0,0,Q,ce);let _e=Ws.getImageData(R,B,G,K);return Ws.clearRect(0,0,Q,ce),_e.data}(d,s,u,y,T)})},O.cO=Yp,O.cP=at,O.cQ=_r,O.cR=Bn,O.cS=fy,O.cT=ju,O.cU=jh,O.ca=d=>d.type==="symbol",O.cb=d=>d.type==="circle",O.cc=d=>d.type==="heatmap",O.cd=d=>d.type==="line",O.ce=d=>d.type==="fill",O.cf=d=>d.type==="fill-extrusion",O.cg=d=>d.type==="hillshade",O.ch=d=>d.type==="color-relief",O.ci=d=>d.type==="raster",O.cj=d=>d.type==="background",O.ck=d=>d.type==="custom",O.cl=Co,O.cm=function(d,s,u){let y=as(s.x-u.x,s.y-u.y),T=as(d.x-u.x,d.y-u.y);var D,R;return Ha(Math.atan2(y[0]*T[1]-y[1]*T[0],(D=y)[0]*(R=T)[0]+D[1]*R[1]))},O.cn=$c,O.co=function(d,s){return El[s]&&(d instanceof MouseEvent||d instanceof WheelEvent)},O.cp=function(d,s){return sl[s]&&"touches"in d},O.cq=function(d){return sl[d]||El[d]},O.cr=function(d,s,u){var y=s[0],T=s[1];return d[0]=u[0]*y+u[4]*T+u[12],d[1]=u[1]*y+u[5]*T+u[13],d},O.cs=function(d,s){let{x:u,y}=yp.fromLngLat(s);return!(d<0||d>25||y<0||y>=1||u<0||u>=1)},O.ct=function(d,s){return d[0]=s[0],d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=s[1],d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[10]=s[2],d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,d},O.cu=class extends xh{},O.cv=Ry,O.cx=function(d){return d.message===ms},O.cy=mt,O.cz=function(d,s){Le.REGISTERED_PROTOCOLS[d]=s},O.d=Xt,O.e=Os,O.f=d=>t(void 0,void 0,void 0,function*(){if(d.byteLength===0)return createImageBitmap(new ImageData(1,1));let s=new Blob([new Uint8Array(d)],{type:"image/png"});try{return createImageBitmap(s)}catch(u){throw new Error(`Could not load image because of ${u.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}}),O.g=Fe,O.h=d=>new Promise((s,u)=>{let y=new Image;y.onload=()=>{s(y),URL.revokeObjectURL(y.src),y.onload=null,window.requestAnimationFrame(()=>{y.src=pl})},y.onerror=()=>u(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));let T=new Blob([new Uint8Array(d)],{type:"image/png"});y.src=d.byteLength?URL.createObjectURL(T):pl}),O.i=Vo,O.j=(d,s)=>Tt(Os(d,{type:"json"}),s),O.k=Zt,O.l=li,O.m=Tt,O.n=(d,s)=>Tt(Os(d,{type:"arrayBuffer"}),s),O.o=function(d){return new Kh(d).readFields(fp,[])},O.p=Vm,O.q=Xp,O.r=Qs,O.s=ml,O.t=_h,O.u=ar,O.v=Ue,O.w=Jo,O.x=Gf,O.y=vu,O.z=Yu}),P("worker",["./shared"],function(O){"use strict";class t{constructor(Le){this.keyCache={},Le&&this.replace(Le)}replace(Le){this._layerConfigs={},this._layers={},this.update(Le,[])}update(Le,Fe){for(let mt of Le){this._layerConfigs[mt.id]=mt;let St=this._layers[mt.id]=O.bI(mt);St._featureFilter=O.a9(St.filter),this.keyCache[mt.id]&&delete this.keyCache[mt.id]}for(let mt of Fe)delete this.keyCache[mt],delete this._layerConfigs[mt],delete this._layers[mt];this.familiesBySource={};let He=O.cB(Object.values(this._layerConfigs),this.keyCache);for(let mt of He){let St=mt.map(Zt=>this._layers[Zt.id]),Tt=St[0];if(Tt.visibility==="none")continue;let Xt=Tt.source||"",Lt=this.familiesBySource[Xt];Lt||(Lt=this.familiesBySource[Xt]={});let di=Tt.sourceLayer||"_geojsonTileLayer",li=Lt[di];li||(li=Lt[di]=[]),li.push(St)}}}class at{constructor(Le){let Fe={},He=[];for(let Xt in Le){let Lt=Le[Xt],di=Fe[Xt]={};for(let li in Lt){let Zt=Lt[+li];if(!Zt||Zt.bitmap.width===0||Zt.bitmap.height===0)continue;let wi={x:0,y:0,w:Zt.bitmap.width+2,h:Zt.bitmap.height+2};He.push(wi),di[li]={rect:wi,metrics:Zt.metrics}}}let{w:mt,h:St}=O.p(He),Tt=new O.q({width:mt||1,height:St||1});for(let Xt in Le){let Lt=Le[Xt];for(let di in Lt){let li=Lt[+di];if(!li||li.bitmap.width===0||li.bitmap.height===0)continue;let Zt=Fe[Xt][di].rect;O.q.copy(li.bitmap,Tt,{x:0,y:0},{x:Zt.x+1,y:Zt.y+1},li.bitmap)}}this.image=Tt,this.positions=Fe}}O.cC("GlyphAtlas",at);class yi{constructor(Le){this.tileID=new O.Z(Le.tileID.overscaledZ,Le.tileID.wrap,Le.tileID.canonical.z,Le.tileID.canonical.x,Le.tileID.canonical.y),this.uid=Le.uid,this.zoom=Le.zoom,this.pixelRatio=Le.pixelRatio,this.tileSize=Le.tileSize,this.source=Le.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=Le.showCollisionBoxes,this.collectResourceTiming=!!Le.collectResourceTiming,this.returnDependencies=!!Le.returnDependencies,this.promoteId=Le.promoteId,this.inFlightDependencies=[],this.globalState=Le.globalState}parse(Le,Fe,He,mt,St){return O._(this,void 0,void 0,function*(){this.status="parsing",this.data=Le,this.collisionBoxArray=new O.a7;let Tt=new O.cD(Object.keys(Le.layers).sort()),Xt=new O.cE(this.tileID,this.promoteId);Xt.bucketLayerIDs=[];let Lt={},di={featureIndex:Xt,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:He,subdivisionGranularity:St},li=Fe.familiesBySource[this.source];for(let We in li){let rt=Le.layers[We];if(!rt)continue;rt.version===1&&O.w(`Vector tile source "${this.source}" layer "${We}" does not use vector tile spec v2 and therefore may have some rendering errors.`);let ct=Tt.encode(We),nt=[];for(let Ot=0;Ot<rt.length;Ot++){let wt=rt.feature(Ot),_i=Xt.getId(wt,We);nt.push({feature:wt,id:_i,index:Ot,sourceLayerIndex:ct})}for(let Ot of li[We]){let wt=Ot[0];wt.source!==this.source&&O.w(`layer.source = ${wt.source} does not equal this.source = ${this.source}`),wt.minzoom&&this.zoom<Math.floor(wt.minzoom)||wt.maxzoom&&this.zoom>=wt.maxzoom||wt.visibility!=="none"&&(Cn(Ot,this.zoom,He),(Lt[wt.id]=wt.createBucket({index:Xt.bucketLayerIDs.length,layers:Ot,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:ct,sourceID:this.source,globalState:this.globalState})).populate(nt,di,this.tileID.canonical),Xt.bucketLayerIDs.push(Ot.map(_i=>_i.id)))}}let Zt=O.bM(di.glyphDependencies,We=>Object.keys(We).map(Number));this.inFlightDependencies.forEach(We=>We?.abort()),this.inFlightDependencies=[];let wi=Promise.resolve({});if(Object.keys(Zt).length){let We=new AbortController;this.inFlightDependencies.push(We),wi=mt.sendAsync({type:"GG",data:{stacks:Zt,source:this.source,tileID:this.tileID,type:"glyphs"}},We)}let Ue=Object.keys(di.iconDependencies),Qi=Promise.resolve({});if(Ue.length){let We=new AbortController;this.inFlightDependencies.push(We),Qi=mt.sendAsync({type:"GI",data:{icons:Ue,source:this.source,tileID:this.tileID,type:"icons"}},We)}let $n=Object.keys(di.patternDependencies),ht=Promise.resolve({});if($n.length){let We=new AbortController;this.inFlightDependencies.push(We),ht=mt.sendAsync({type:"GI",data:{icons:$n,source:this.source,tileID:this.tileID,type:"patterns"}},We)}let[te,fe,Ae]=yield Promise.all([wi,Qi,ht]),qe=new at(te),je=new O.cF(fe,Ae);for(let We in Lt){let rt=Lt[We];rt instanceof O.a8?(Cn(rt.layers,this.zoom,He),O.cG({bucket:rt,glyphMap:te,glyphPositions:qe.positions,imageMap:fe,imagePositions:je.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical,subdivisionGranularity:di.subdivisionGranularity})):rt.hasPattern&&(rt instanceof O.cH||rt instanceof O.cI||rt instanceof O.cJ)&&(Cn(rt.layers,this.zoom,He),rt.addFeatures(di,this.tileID.canonical,je.patternPositions))}return this.status="done",{buckets:Object.values(Lt).filter(We=>!We.isEmpty()),featureIndex:Xt,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:qe.image,imageAtlas:je,glyphMap:this.returnDependencies?te:null,iconMap:this.returnDependencies?fe:null,glyphPositions:this.returnDependencies?qe.positions:null}})}}function Cn(Vt,Le,Fe){let He=new O.F(Le);for(let mt of Vt)mt.recalculate(He,Fe)}class _r{constructor(Le,Fe,He){this.actor=Le,this.layerIndex=Fe,this.availableImages=He,this.fetching={},this.loading={},this.loaded={}}loadVectorTile(Le,Fe){return O._(this,void 0,void 0,function*(){let He=yield O.n(Le.request,Fe);try{return{vectorTile:new O.cK.VectorTile(new O.cL(He.data)),rawData:He.data,cacheControl:He.cacheControl,expires:He.expires}}catch(mt){let St=new Uint8Array(He.data),Tt=`Unable to parse the tile at ${Le.request.url}, `;throw Tt+=St[0]===31&&St[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${mt.message}`,new Error(Tt)}})}loadTile(Le){return O._(this,void 0,void 0,function*(){let Fe=Le.uid,He=!!(Le&&Le.request&&Le.request.collectResourceTiming)&&new O.cM(Le.request),mt=new yi(Le);this.loading[Fe]=mt;let St=new AbortController;mt.abort=St;try{let Tt=yield this.loadVectorTile(Le,St);if(delete this.loading[Fe],!Tt)return null;let Xt=Tt.rawData,Lt={};Tt.expires&&(Lt.expires=Tt.expires),Tt.cacheControl&&(Lt.cacheControl=Tt.cacheControl);let di={};if(He){let Zt=He.finish();Zt&&(di.resourceTiming=JSON.parse(JSON.stringify(Zt)))}mt.vectorTile=Tt.vectorTile;let li=mt.parse(Tt.vectorTile,this.layerIndex,this.availableImages,this.actor,Le.subdivisionGranularity);this.loaded[Fe]=mt,this.fetching[Fe]={rawTileData:Xt,cacheControl:Lt,resourceTiming:di};try{let Zt=yield li;return O.e({rawTileData:Xt.slice(0)},Zt,Lt,di)}finally{delete this.fetching[Fe]}}catch(Tt){throw delete this.loading[Fe],mt.status="done",this.loaded[Fe]=mt,Tt}})}reloadTile(Le){return O._(this,void 0,void 0,function*(){let Fe=Le.uid;if(!this.loaded||!this.loaded[Fe])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");let He=this.loaded[Fe];if(He.showCollisionBoxes=Le.showCollisionBoxes,He.globalState=Le.globalState,He.status==="parsing"){let mt=yield He.parse(He.vectorTile,this.layerIndex,this.availableImages,this.actor,Le.subdivisionGranularity),St;if(this.fetching[Fe]){let{rawTileData:Tt,cacheControl:Xt,resourceTiming:Lt}=this.fetching[Fe];delete this.fetching[Fe],St=O.e({rawTileData:Tt.slice(0)},mt,Xt,Lt)}else St=mt;return St}if(He.status==="done"&&He.vectorTile)return He.parse(He.vectorTile,this.layerIndex,this.availableImages,this.actor,Le.subdivisionGranularity)})}abortTile(Le){return O._(this,void 0,void 0,function*(){let Fe=this.loading,He=Le.uid;Fe&&Fe[He]&&Fe[He].abort&&(Fe[He].abort.abort(),delete Fe[He])})}removeTile(Le){return O._(this,void 0,void 0,function*(){this.loaded&&this.loaded[Le.uid]&&delete this.loaded[Le.uid]})}}class an{constructor(){this.loaded={}}loadTile(Le){return O._(this,void 0,void 0,function*(){let{uid:Fe,encoding:He,rawImageData:mt,redFactor:St,greenFactor:Tt,blueFactor:Xt,baseShift:Lt}=Le,di=mt.width+2,li=mt.height+2,Zt=O.b(mt)?new O.R({width:di,height:li},yield O.cN(mt,-1,-1,di,li)):mt,wi=new O.cO(Fe,Zt,He,St,Tt,Xt,Lt);return this.loaded=this.loaded||{},this.loaded[Fe]=wi,wi})}removeTile(Le){let Fe=this.loaded,He=Le.uid;Fe&&Fe[He]&&delete Fe[He]}}var Dt,Wi,on=function(){if(Wi)return Dt;function Vt(Fe,He){if(Fe.length!==0){Le(Fe[0],He);for(var mt=1;mt<Fe.length;mt++)Le(Fe[mt],!He)}}function Le(Fe,He){for(var mt=0,St=0,Tt=0,Xt=Fe.length,Lt=Xt-1;Tt<Xt;Lt=Tt++){var di=(Fe[Tt][0]-Fe[Lt][0])*(Fe[Lt][1]+Fe[Tt][1]),li=mt+di;St+=Math.abs(mt)>=Math.abs(di)?mt-li+di:di-li+mt,mt=li}mt+St>=0!=!!He&&Fe.reverse()}return Wi=1,Dt=function Fe(He,mt){var St,Tt=He&&He.type;if(Tt==="FeatureCollection")for(St=0;St<He.features.length;St++)Fe(He.features[St],mt);else if(Tt==="GeometryCollection")for(St=0;St<He.geometries.length;St++)Fe(He.geometries[St],mt);else if(Tt==="Feature")Fe(He.geometry,mt);else if(Tt==="Polygon")Vt(He.coordinates,mt);else if(Tt==="MultiPolygon")for(St=0;St<He.coordinates.length;St++)Vt(He.coordinates[St],mt);return He}}(),vn=O.cP(on);let gn=O.cK.VectorTileFeature.prototype.toGeoJSON;class vr{constructor(Le){this._feature=Le,this.extent=O.$,this.type=Le.type,this.properties=Le.tags,"id"in Le&&!isNaN(Le.id)&&(this.id=parseInt(Le.id,10))}loadGeometry(){if(this._feature.type===1){let Le=[];for(let Fe of this._feature.geometry)Le.push([new O.P(Fe[0],Fe[1])]);return Le}{let Le=[];for(let Fe of this._feature.geometry){let He=[];for(let mt of Fe)He.push(new O.P(mt[0],mt[1]));Le.push(He)}return Le}}toGeoJSON(Le,Fe,He){return gn.call(this,Le,Fe,He)}}class Bo{constructor(Le){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=O.$,this.length=Le.length,this._features=Le}feature(Le){return new vr(this._features[Le])}}var qo,to,Br,os={exports:{}},ga=function(){if(Br)return os.exports;Br=1;var Vt=O.cS(),Le=function(){if(to)return qo;to=1;var li=O.cQ(),Zt=O.cR().VectorTileFeature;function wi(Qi,$n){this.options=$n||{},this.features=Qi,this.length=Qi.length}function Ue(Qi,$n){this.id=typeof Qi.id=="number"?Qi.id:void 0,this.type=Qi.type,this.rawGeometry=Qi.type===1?[Qi.geometry]:Qi.geometry,this.properties=Qi.tags,this.extent=$n||4096}return qo=wi,wi.prototype.feature=function(Qi){return new Ue(this.features[Qi],this.options.extent)},Ue.prototype.loadGeometry=function(){var Qi=this.rawGeometry;this.geometry=[];for(var $n=0;$n<Qi.length;$n++){for(var ht=Qi[$n],te=[],fe=0;fe<ht.length;fe++)te.push(new li(ht[fe][0],ht[fe][1]));this.geometry.push(te)}return this.geometry},Ue.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var Qi=this.geometry,$n=1/0,ht=-1/0,te=1/0,fe=-1/0,Ae=0;Ae<Qi.length;Ae++)for(var qe=Qi[Ae],je=0;je<qe.length;je++){var We=qe[je];$n=Math.min($n,We.x),ht=Math.max(ht,We.x),te=Math.min(te,We.y),fe=Math.max(fe,We.y)}return[$n,te,ht,fe]},Ue.prototype.toGeoJSON=Zt.prototype.toGeoJSON,qo}();function Fe(li){var Zt=new Vt;return function(wi,Ue){for(var Qi in wi.layers)Ue.writeMessage(3,He,wi.layers[Qi])}(li,Zt),Zt.finish()}function He(li,Zt){var wi;Zt.writeVarintField(15,li.version||1),Zt.writeStringField(1,li.name||""),Zt.writeVarintField(5,li.extent||4096);var Ue={keys:[],values:[],keycache:{},valuecache:{}};for(wi=0;wi<li.length;wi++)Ue.feature=li.feature(wi),Zt.writeMessage(2,mt,Ue);var Qi=Ue.keys;for(wi=0;wi<Qi.length;wi++)Zt.writeStringField(3,Qi[wi]);var $n=Ue.values;for(wi=0;wi<$n.length;wi++)Zt.writeMessage(4,di,$n[wi])}function mt(li,Zt){var wi=li.feature;wi.id!==void 0&&Zt.writeVarintField(1,wi.id),Zt.writeMessage(2,St,li),Zt.writeVarintField(3,wi.type),Zt.writeMessage(4,Lt,wi)}function St(li,Zt){var wi=li.feature,Ue=li.keys,Qi=li.values,$n=li.keycache,ht=li.valuecache;for(var te in wi.properties){var fe=wi.properties[te],Ae=$n[te];if(fe!==null){Ae===void 0&&(Ue.push(te),$n[te]=Ae=Ue.length-1),Zt.writeVarint(Ae);var qe=typeof fe;qe!=="string"&&qe!=="boolean"&&qe!=="number"&&(fe=JSON.stringify(fe));var je=qe+":"+fe,We=ht[je];We===void 0&&(Qi.push(fe),ht[je]=We=Qi.length-1),Zt.writeVarint(We)}}}function Tt(li,Zt){return(Zt<<3)+(7&li)}function Xt(li){return li<<1^li>>31}function Lt(li,Zt){for(var wi=li.loadGeometry(),Ue=li.type,Qi=0,$n=0,ht=wi.length,te=0;te<ht;te++){var fe=wi[te],Ae=1;Ue===1&&(Ae=fe.length),Zt.writeVarint(Tt(1,Ae));for(var qe=Ue===3?fe.length-1:fe.length,je=0;je<qe;je++){je===1&&Ue!==1&&Zt.writeVarint(Tt(2,qe-1));var We=fe[je].x-Qi,rt=fe[je].y-$n;Zt.writeVarint(Xt(We)),Zt.writeVarint(Xt(rt)),Qi+=We,$n+=rt}Ue===3&&Zt.writeVarint(Tt(7,1))}}function di(li,Zt){var wi=typeof li;wi==="string"?Zt.writeStringField(1,li):wi==="boolean"?Zt.writeBooleanField(7,li):wi==="number"&&(li%1!=0?Zt.writeDoubleField(3,li):li<0?Zt.writeSVarintField(6,li):Zt.writeVarintField(5,li))}return os.exports=Fe,os.exports.fromVectorTileJs=Fe,os.exports.fromGeojsonVt=function(li,Zt){Zt=Zt||{};var wi={};for(var Ue in li)wi[Ue]=new Le(li[Ue].features,Zt),wi[Ue].name=Ue,wi[Ue].version=Zt.version,wi[Ue].extent=Zt.extent;return Fe({layers:wi})},os.exports.GeoJSONWrapper=Le,os.exports}(),Aa=O.cP(ga);let Ql={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Vt=>Vt},Io=Math.fround||(qa=new Float32Array(1),Vt=>(qa[0]=+Vt,qa[0]));var qa;class No{constructor(Le){this.options=Object.assign(Object.create(Ql),Le),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(Le){let{log:Fe,minZoom:He,maxZoom:mt}=this.options;Fe&&console.time("total time");let St=`prepare ${Le.length} points`;Fe&&console.time(St),this.points=Le;let Tt=[];for(let Lt=0;Lt<Le.length;Lt++){let di=Le[Lt];if(!di.geometry)continue;let[li,Zt]=di.geometry.coordinates,wi=Io(ss(li)),Ue=Io(ya(Zt));Tt.push(wi,Ue,1/0,Lt,-1,1),this.options.reduce&&Tt.push(0)}let Xt=this.trees[mt+1]=this._createTree(Tt);Fe&&console.timeEnd(St);for(let Lt=mt;Lt>=He;Lt--){let di=+Date.now();Xt=this.trees[Lt]=this._createTree(this._cluster(Xt,Lt)),Fe&&console.log("z%d: %d clusters in %dms",Lt,Xt.numItems,+Date.now()-di)}return Fe&&console.timeEnd("total time"),this}getClusters(Le,Fe){let He=((Le[0]+180)%360+360)%360-180,mt=Math.max(-90,Math.min(90,Le[1])),St=Le[2]===180?180:((Le[2]+180)%360+360)%360-180,Tt=Math.max(-90,Math.min(90,Le[3]));if(Le[2]-Le[0]>=360)He=-180,St=180;else if(He>St){let Zt=this.getClusters([He,mt,180,Tt],Fe),wi=this.getClusters([-180,mt,St,Tt],Fe);return Zt.concat(wi)}let Xt=this.trees[this._limitZoom(Fe)],Lt=Xt.range(ss(He),ya(Tt),ss(St),ya(mt)),di=Xt.data,li=[];for(let Zt of Lt){let wi=this.stride*Zt;li.push(di[wi+5]>1?Ur(di,wi,this.clusterProps):this.points[di[wi+3]])}return li}getChildren(Le){let Fe=this._getOriginId(Le),He=this._getOriginZoom(Le),mt="No cluster with the specified id.",St=this.trees[He];if(!St)throw new Error(mt);let Tt=St.data;if(Fe*this.stride>=Tt.length)throw new Error(mt);let Xt=this.options.radius/(this.options.extent*Math.pow(2,He-1)),Lt=St.within(Tt[Fe*this.stride],Tt[Fe*this.stride+1],Xt),di=[];for(let li of Lt){let Zt=li*this.stride;Tt[Zt+4]===Le&&di.push(Tt[Zt+5]>1?Ur(Tt,Zt,this.clusterProps):this.points[Tt[Zt+3]])}if(di.length===0)throw new Error(mt);return di}getLeaves(Le,Fe,He){let mt=[];return this._appendLeaves(mt,Le,Fe=Fe||10,He=He||0,0),mt}getTile(Le,Fe,He){let mt=this.trees[this._limitZoom(Le)],St=Math.pow(2,Le),{extent:Tt,radius:Xt}=this.options,Lt=Xt/Tt,di=(He-Lt)/St,li=(He+1+Lt)/St,Zt={features:[]};return this._addTileFeatures(mt.range((Fe-Lt)/St,di,(Fe+1+Lt)/St,li),mt.data,Fe,He,St,Zt),Fe===0&&this._addTileFeatures(mt.range(1-Lt/St,di,1,li),mt.data,St,He,St,Zt),Fe===St-1&&this._addTileFeatures(mt.range(0,di,Lt/St,li),mt.data,-1,He,St,Zt),Zt.features.length?Zt:null}getClusterExpansionZoom(Le){let Fe=this._getOriginZoom(Le)-1;for(;Fe<=this.options.maxZoom;){let He=this.getChildren(Le);if(Fe++,He.length!==1)break;Le=He[0].properties.cluster_id}return Fe}_appendLeaves(Le,Fe,He,mt,St){let Tt=this.getChildren(Fe);for(let Xt of Tt){let Lt=Xt.properties;if(Lt&&Lt.cluster?St+Lt.point_count<=mt?St+=Lt.point_count:St=this._appendLeaves(Le,Lt.cluster_id,He,mt,St):St<mt?St++:Le.push(Xt),Le.length===He)break}return St}_createTree(Le){let Fe=new O.aH(Le.length/this.stride|0,this.options.nodeSize,Float32Array);for(let He=0;He<Le.length;He+=this.stride)Fe.add(Le[He],Le[He+1]);return Fe.finish(),Fe.data=Le,Fe}_addTileFeatures(Le,Fe,He,mt,St,Tt){for(let Xt of Le){let Lt=Xt*this.stride,di=Fe[Lt+5]>1,li,Zt,wi;if(di)li=ho(Fe,Lt,this.clusterProps),Zt=Fe[Lt],wi=Fe[Lt+1];else{let $n=this.points[Fe[Lt+3]];li=$n.properties;let[ht,te]=$n.geometry.coordinates;Zt=ss(ht),wi=ya(te)}let Ue={type:1,geometry:[[Math.round(this.options.extent*(Zt*St-He)),Math.round(this.options.extent*(wi*St-mt))]],tags:li},Qi;Qi=di||this.options.generateId?Fe[Lt+3]:this.points[Fe[Lt+3]].id,Qi!==void 0&&(Ue.id=Qi),Tt.features.push(Ue)}}_limitZoom(Le){return Math.max(this.options.minZoom,Math.min(Math.floor(+Le),this.options.maxZoom+1))}_cluster(Le,Fe){let{radius:He,extent:mt,reduce:St,minPoints:Tt}=this.options,Xt=He/(mt*Math.pow(2,Fe)),Lt=Le.data,di=[],li=this.stride;for(let Zt=0;Zt<Lt.length;Zt+=li){if(Lt[Zt+2]<=Fe)continue;Lt[Zt+2]=Fe;let wi=Lt[Zt],Ue=Lt[Zt+1],Qi=Le.within(Lt[Zt],Lt[Zt+1],Xt),$n=Lt[Zt+5],ht=$n;for(let te of Qi){let fe=te*li;Lt[fe+2]>Fe&&(ht+=Lt[fe+5])}if(ht>$n&&ht>=Tt){let te,fe=wi*$n,Ae=Ue*$n,qe=-1,je=(Zt/li<<5)+(Fe+1)+this.points.length;for(let We of Qi){let rt=We*li;if(Lt[rt+2]<=Fe)continue;Lt[rt+2]=Fe;let ct=Lt[rt+5];fe+=Lt[rt]*ct,Ae+=Lt[rt+1]*ct,Lt[rt+4]=je,St&&(te||(te=this._map(Lt,Zt,!0),qe=this.clusterProps.length,this.clusterProps.push(te)),St(te,this._map(Lt,rt)))}Lt[Zt+4]=je,di.push(fe/ht,Ae/ht,1/0,je,-1,ht),St&&di.push(qe)}else{for(let te=0;te<li;te++)di.push(Lt[Zt+te]);if(ht>1)for(let te of Qi){let fe=te*li;if(!(Lt[fe+2]<=Fe)){Lt[fe+2]=Fe;for(let Ae=0;Ae<li;Ae++)di.push(Lt[fe+Ae])}}}}return di}_getOriginId(Le){return Le-this.points.length>>5}_getOriginZoom(Le){return(Le-this.points.length)%32}_map(Le,Fe,He){if(Le[Fe+5]>1){let Tt=this.clusterProps[Le[Fe+6]];return He?Object.assign({},Tt):Tt}let mt=this.points[Le[Fe+3]].properties,St=this.options.map(mt);return He&&St===mt?Object.assign({},St):St}}function Ur(Vt,Le,Fe){return{type:"Feature",id:Vt[Le+3],properties:ho(Vt,Le,Fe),geometry:{type:"Point",coordinates:[(He=Vt[Le],360*(He-.5)),dl(Vt[Le+1])]}};var He}function ho(Vt,Le,Fe){let He=Vt[Le+5],mt=He>=1e4?`${Math.round(He/1e3)}k`:He>=1e3?Math.round(He/100)/10+"k":He,St=Vt[Le+6],Tt=St===-1?{}:Object.assign({},Fe[St]);return Object.assign(Tt,{cluster:!0,cluster_id:Vt[Le+3],point_count:He,point_count_abbreviated:mt})}function ss(Vt){return Vt/360+.5}function ya(Vt){let Le=Math.sin(Vt*Math.PI/180),Fe=.5-.25*Math.log((1+Le)/(1-Le))/Math.PI;return Fe<0?0:Fe>1?1:Fe}function dl(Vt){let Le=(180-360*Vt)*Math.PI/180;return 360*Math.atan(Math.exp(Le))/Math.PI-90}function $a(Vt,Le,Fe,He){let mt=He,St=Le+(Fe-Le>>1),Tt,Xt=Fe-Le,Lt=Vt[Le],di=Vt[Le+1],li=Vt[Fe],Zt=Vt[Fe+1];for(let wi=Le+3;wi<Fe;wi+=3){let Ue=Mr(Vt[wi],Vt[wi+1],Lt,di,li,Zt);if(Ue>mt)Tt=wi,mt=Ue;else if(Ue===mt){let Qi=Math.abs(wi-St);Qi<Xt&&(Tt=wi,Xt=Qi)}}mt>He&&(Tt-Le>3&&$a(Vt,Le,Tt,He),Vt[Tt+2]=mt,Fe-Tt>3&&$a(Vt,Tt,Fe,He))}function Mr(Vt,Le,Fe,He,mt,St){let Tt=mt-Fe,Xt=St-He;if(Tt!==0||Xt!==0){let Lt=((Vt-Fe)*Tt+(Le-He)*Xt)/(Tt*Tt+Xt*Xt);Lt>1?(Fe=mt,He=St):Lt>0&&(Fe+=Tt*Lt,He+=Xt*Lt)}return Tt=Vt-Fe,Xt=Le-He,Tt*Tt+Xt*Xt}function as(Vt,Le,Fe,He){let mt={id:Vt??null,type:Le,geometry:Fe,tags:He,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(Le==="Point"||Le==="MultiPoint"||Le==="LineString")Hr(mt,Fe);else if(Le==="Polygon")Hr(mt,Fe[0]);else if(Le==="MultiLineString")for(let St of Fe)Hr(mt,St);else if(Le==="MultiPolygon")for(let St of Fe)Hr(mt,St[0]);return mt}function Hr(Vt,Le){for(let Fe=0;Fe<Le.length;Fe+=3)Vt.minX=Math.min(Vt.minX,Le[Fe]),Vt.minY=Math.min(Vt.minY,Le[Fe+1]),Vt.maxX=Math.max(Vt.maxX,Le[Fe]),Vt.maxY=Math.max(Vt.maxY,Le[Fe+1])}function Da(Vt,Le,Fe,He){if(!Le.geometry)return;let mt=Le.geometry.coordinates;if(mt&&mt.length===0)return;let St=Le.geometry.type,Tt=Math.pow(Fe.tolerance/((1<<Fe.maxZoom)*Fe.extent),2),Xt=[],Lt=Le.id;if(Fe.promoteId?Lt=Le.properties[Fe.promoteId]:Fe.generateId&&(Lt=He||0),St==="Point")xa(mt,Xt);else if(St==="MultiPoint")for(let di of mt)xa(di,Xt);else if(St==="LineString")Lr(mt,Xt,Tt,!1);else if(St==="MultiLineString"){if(Fe.lineMetrics){for(let di of mt)Xt=[],Lr(di,Xt,Tt,!1),Vt.push(as(Lt,"LineString",Xt,Le.properties));return}jr(mt,Xt,Tt,!1)}else if(St==="Polygon")jr(mt,Xt,Tt,!0);else{if(St!=="MultiPolygon"){if(St==="GeometryCollection"){for(let di of Le.geometry.geometries)Da(Vt,{id:Lt,geometry:di,properties:Le.properties},Fe,He);return}throw new Error("Input data is not a valid GeoJSON object.")}for(let di of mt){let li=[];jr(di,li,Tt,!0),Xt.push(li)}}Vt.push(as(Lt,St,Xt,Le.properties))}function xa(Vt,Le){Le.push(Co(Vt[0]),$c(Vt[1]),0)}function Lr(Vt,Le,Fe,He){let mt,St,Tt=0;for(let Lt=0;Lt<Vt.length;Lt++){let di=Co(Vt[Lt][0]),li=$c(Vt[Lt][1]);Le.push(di,li,0),Lt>0&&(Tt+=He?(mt*li-di*St)/2:Math.sqrt(Math.pow(di-mt,2)+Math.pow(li-St,2))),mt=di,St=li}let Xt=Le.length-3;Le[2]=1,$a(Le,0,Xt,Fe),Le[Xt+2]=1,Le.size=Math.abs(Tt),Le.start=0,Le.end=Le.size}function jr(Vt,Le,Fe,He){for(let mt=0;mt<Vt.length;mt++){let St=[];Lr(Vt[mt],St,Fe,He),Le.push(St)}}function Co(Vt){return Vt/360+.5}function $c(Vt){let Le=Math.sin(Vt*Math.PI/180),Fe=.5-.25*Math.log((1+Le)/(1-Le))/Math.PI;return Fe<0?0:Fe>1?1:Fe}function gr(Vt,Le,Fe,He,mt,St,Tt,Xt){if(He/=Le,St>=(Fe/=Le)&&Tt<He)return Vt;if(Tt<Fe||St>=He)return null;let Lt=[];for(let di of Vt){let li=di.geometry,Zt=di.type,wi=mt===0?di.minX:di.minY,Ue=mt===0?di.maxX:di.maxY;if(wi>=Fe&&Ue<He){Lt.push(di);continue}if(Ue<Fe||wi>=He)continue;let Qi=[];if(Zt==="Point"||Zt==="MultiPoint")yc(li,Qi,Fe,He,mt);else if(Zt==="LineString")Os(li,Qi,Fe,He,mt,!1,Xt.lineMetrics);else if(Zt==="MultiLineString")hr(li,Qi,Fe,He,mt,!1);else if(Zt==="Polygon")hr(li,Qi,Fe,He,mt,!0);else if(Zt==="MultiPolygon")for(let $n of li){let ht=[];hr($n,ht,Fe,He,mt,!0),ht.length&&Qi.push(ht)}if(Qi.length){if(Xt.lineMetrics&&Zt==="LineString"){for(let $n of Qi)Lt.push(as(di.id,Zt,$n,di.tags));continue}Zt!=="LineString"&&Zt!=="MultiLineString"||(Qi.length===1?(Zt="LineString",Qi=Qi[0]):Zt="MultiLineString"),Zt!=="Point"&&Zt!=="MultiPoint"||(Zt=Qi.length===3?"Point":"MultiPoint"),Lt.push(as(di.id,Zt,Qi,di.tags))}}return Lt.length?Lt:null}function yc(Vt,Le,Fe,He,mt){for(let St=0;St<Vt.length;St+=3){let Tt=Vt[St+mt];Tt>=Fe&&Tt<=He&&Cl(Le,Vt[St],Vt[St+1],Vt[St+2])}}function Os(Vt,Le,Fe,He,mt,St,Tt){let Xt=va(Vt),Lt=mt===0?ra:Cs,di,li,Zt=Vt.start;for(let ht=0;ht<Vt.length-3;ht+=3){let te=Vt[ht],fe=Vt[ht+1],Ae=Vt[ht+2],qe=Vt[ht+3],je=Vt[ht+4],We=mt===0?te:fe,rt=mt===0?qe:je,ct=!1;Tt&&(di=Math.sqrt(Math.pow(te-qe,2)+Math.pow(fe-je,2))),We<Fe?rt>Fe&&(li=Lt(Xt,te,fe,qe,je,Fe),Tt&&(Xt.start=Zt+di*li)):We>He?rt<He&&(li=Lt(Xt,te,fe,qe,je,He),Tt&&(Xt.start=Zt+di*li)):Cl(Xt,te,fe,Ae),rt<Fe&&We>=Fe&&(li=Lt(Xt,te,fe,qe,je,Fe),ct=!0),rt>He&&We<=He&&(li=Lt(Xt,te,fe,qe,je,He),ct=!0),!St&&ct&&(Tt&&(Xt.end=Zt+di*li),Le.push(Xt),Xt=va(Vt)),Tt&&(Zt+=di)}let wi=Vt.length-3,Ue=Vt[wi],Qi=Vt[wi+1],$n=mt===0?Ue:Qi;$n>=Fe&&$n<=He&&Cl(Xt,Ue,Qi,Vt[wi+2]),wi=Xt.length-3,St&&wi>=3&&(Xt[wi]!==Xt[0]||Xt[wi+1]!==Xt[1])&&Cl(Xt,Xt[0],Xt[1],Xt[2]),Xt.length&&Le.push(Xt)}function va(Vt){let Le=[];return Le.size=Vt.size,Le.start=Vt.start,Le.end=Vt.end,Le}function hr(Vt,Le,Fe,He,mt,St){for(let Tt of Vt)Os(Tt,Le,Fe,He,mt,St,!1)}function Cl(Vt,Le,Fe,He){Vt.push(Le,Fe,He)}function ra(Vt,Le,Fe,He,mt,St){let Tt=(St-Le)/(He-Le);return Cl(Vt,St,Fe+(mt-Fe)*Tt,1),Tt}function Cs(Vt,Le,Fe,He,mt,St){let Tt=(St-Fe)/(mt-Fe);return Cl(Vt,Le+(He-Le)*Tt,St,1),Tt}function Jo(Vt,Le){let Fe=[];for(let He=0;He<Vt.length;He++){let mt=Vt[He],St=mt.type,Tt;if(St==="Point"||St==="MultiPoint"||St==="LineString")Tt=Fs(mt.geometry,Le);else if(St==="MultiLineString"||St==="Polygon"){Tt=[];for(let Xt of mt.geometry)Tt.push(Fs(Xt,Le))}else if(St==="MultiPolygon"){Tt=[];for(let Xt of mt.geometry){let Lt=[];for(let di of Xt)Lt.push(Fs(di,Le));Tt.push(Lt)}}Fe.push(as(mt.id,St,Tt,mt.tags))}return Fe}function Fs(Vt,Le){let Fe=[];Fe.size=Vt.size,Vt.start!==void 0&&(Fe.start=Vt.start,Fe.end=Vt.end);for(let He=0;He<Vt.length;He+=3)Fe.push(Vt[He]+Le,Vt[He+1],Vt[He+2]);return Fe}function Vo(Vt,Le){if(Vt.transformed)return Vt;let Fe=1<<Vt.z,He=Vt.x,mt=Vt.y;for(let St of Vt.features){let Tt=St.geometry,Xt=St.type;if(St.geometry=[],Xt===1)for(let Lt=0;Lt<Tt.length;Lt+=2)St.geometry.push(ba(Tt[Lt],Tt[Lt+1],Le,Fe,He,mt));else for(let Lt=0;Lt<Tt.length;Lt++){let di=[];for(let li=0;li<Tt[Lt].length;li+=2)di.push(ba(Tt[Lt][li],Tt[Lt][li+1],Le,Fe,He,mt));St.geometry.push(di)}}return Vt.transformed=!0,Vt}function ba(Vt,Le,Fe,He,mt,St){return[Math.round(Fe*(Vt*He-mt)),Math.round(Fe*(Le*He-St))]}function Wa(Vt,Le,Fe,He,mt){let St=Le===mt.maxZoom?0:mt.tolerance/((1<<Le)*mt.extent),Tt={features:[],numPoints:0,numSimplified:0,numFeatures:Vt.length,source:null,x:Fe,y:He,z:Le,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(let Xt of Vt)pl(Tt,Xt,St,mt);return Tt}function pl(Vt,Le,Fe,He){let mt=Le.geometry,St=Le.type,Tt=[];if(Vt.minX=Math.min(Vt.minX,Le.minX),Vt.minY=Math.min(Vt.minY,Le.minY),Vt.maxX=Math.max(Vt.maxX,Le.maxX),Vt.maxY=Math.max(Vt.maxY,Le.maxY),St==="Point"||St==="MultiPoint")for(let Xt=0;Xt<mt.length;Xt+=3)Tt.push(mt[Xt],mt[Xt+1]),Vt.numPoints++,Vt.numSimplified++;else if(St==="LineString")fl(Tt,mt,Vt,Fe,!1,!1);else if(St==="MultiLineString"||St==="Polygon")for(let Xt=0;Xt<mt.length;Xt++)fl(Tt,mt[Xt],Vt,Fe,St==="Polygon",Xt===0);else if(St==="MultiPolygon")for(let Xt=0;Xt<mt.length;Xt++){let Lt=mt[Xt];for(let di=0;di<Lt.length;di++)fl(Tt,Lt[di],Vt,Fe,!0,di===0)}if(Tt.length){let Xt=Le.tags||null;if(St==="LineString"&&He.lineMetrics){Xt={};for(let di in Le.tags)Xt[di]=Le.tags[di];Xt.mapbox_clip_start=mt.start/mt.size,Xt.mapbox_clip_end=mt.end/mt.size}let Lt={geometry:Tt,type:St==="Polygon"||St==="MultiPolygon"?3:St==="LineString"||St==="MultiLineString"?2:1,tags:Xt};Le.id!==null&&(Lt.id=Le.id),Vt.features.push(Lt)}}function fl(Vt,Le,Fe,He,mt,St){let Tt=He*He;if(He>0&&Le.size<(mt?Tt:He))return void(Fe.numPoints+=Le.length/3);let Xt=[];for(let Lt=0;Lt<Le.length;Lt+=3)(He===0||Le[Lt+2]>Tt)&&(Fe.numSimplified++,Xt.push(Le[Lt],Le[Lt+1])),Fe.numPoints++;mt&&function(Lt,di){let li=0;for(let Zt=0,wi=Lt.length,Ue=wi-2;Zt<wi;Ue=Zt,Zt+=2)li+=(Lt[Zt]-Lt[Ue])*(Lt[Zt+1]+Lt[Ue+1]);if(li>0===di)for(let Zt=0,wi=Lt.length;Zt<wi/2;Zt+=2){let Ue=Lt[Zt],Qi=Lt[Zt+1];Lt[Zt]=Lt[wi-2-Zt],Lt[Zt+1]=Lt[wi-1-Zt],Lt[wi-2-Zt]=Ue,Lt[wi-1-Zt]=Qi}}(Xt,St),Vt.push(Xt)}let fs={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Ws{constructor(Le,Fe){let He=(Fe=this.options=function(St,Tt){for(let Xt in Tt)St[Xt]=Tt[Xt];return St}(Object.create(fs),Fe)).debug;if(He&&console.time("preprocess data"),Fe.maxZoom<0||Fe.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(Fe.promoteId&&Fe.generateId)throw new Error("promoteId and generateId cannot be used together.");let mt=function(St,Tt){let Xt=[];if(St.type==="FeatureCollection")for(let Lt=0;Lt<St.features.length;Lt++)Da(Xt,St.features[Lt],Tt,Lt);else Da(Xt,St.type==="Feature"?St:{geometry:St},Tt);return Xt}(Le,Fe);this.tiles={},this.tileCoords=[],He&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",Fe.indexMaxZoom,Fe.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),mt=function(St,Tt){let Xt=Tt.buffer/Tt.extent,Lt=St,di=gr(St,1,-1-Xt,Xt,0,-1,2,Tt),li=gr(St,1,1-Xt,2+Xt,0,-1,2,Tt);return(di||li)&&(Lt=gr(St,1,-Xt,1+Xt,0,-1,2,Tt)||[],di&&(Lt=Jo(di,1).concat(Lt)),li&&(Lt=Lt.concat(Jo(li,-1)))),Lt}(mt,Fe),mt.length&&this.splitTile(mt,0,0,0),He&&(mt.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(Le,Fe,He,mt,St,Tt,Xt){let Lt=[Le,Fe,He,mt],di=this.options,li=di.debug;for(;Lt.length;){mt=Lt.pop(),He=Lt.pop(),Fe=Lt.pop(),Le=Lt.pop();let Zt=1<<Fe,wi=ml(Fe,He,mt),Ue=this.tiles[wi];if(!Ue&&(li>1&&console.time("creation"),Ue=this.tiles[wi]=Wa(Le,Fe,He,mt,di),this.tileCoords.push({z:Fe,x:He,y:mt}),li)){li>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",Fe,He,mt,Ue.numFeatures,Ue.numPoints,Ue.numSimplified),console.timeEnd("creation"));let ct=`z${Fe}`;this.stats[ct]=(this.stats[ct]||0)+1,this.total++}if(Ue.source=Le,St==null){if(Fe===di.indexMaxZoom||Ue.numPoints<=di.indexMaxPoints)continue}else{if(Fe===di.maxZoom||Fe===St)continue;if(St!=null){let ct=St-Fe;if(He!==Tt>>ct||mt!==Xt>>ct)continue}}if(Ue.source=null,Le.length===0)continue;li>1&&console.time("clipping");let Qi=.5*di.buffer/di.extent,$n=.5-Qi,ht=.5+Qi,te=1+Qi,fe=null,Ae=null,qe=null,je=null,We=gr(Le,Zt,He-Qi,He+ht,0,Ue.minX,Ue.maxX,di),rt=gr(Le,Zt,He+$n,He+te,0,Ue.minX,Ue.maxX,di);Le=null,We&&(fe=gr(We,Zt,mt-Qi,mt+ht,1,Ue.minY,Ue.maxY,di),Ae=gr(We,Zt,mt+$n,mt+te,1,Ue.minY,Ue.maxY,di),We=null),rt&&(qe=gr(rt,Zt,mt-Qi,mt+ht,1,Ue.minY,Ue.maxY,di),je=gr(rt,Zt,mt+$n,mt+te,1,Ue.minY,Ue.maxY,di),rt=null),li>1&&console.timeEnd("clipping"),Lt.push(fe||[],Fe+1,2*He,2*mt),Lt.push(Ae||[],Fe+1,2*He,2*mt+1),Lt.push(qe||[],Fe+1,2*He+1,2*mt),Lt.push(je||[],Fe+1,2*He+1,2*mt+1)}}getTile(Le,Fe,He){Le=+Le,Fe=+Fe,He=+He;let mt=this.options,{extent:St,debug:Tt}=mt;if(Le<0||Le>24)return null;let Xt=1<<Le,Lt=ml(Le,Fe=Fe+Xt&Xt-1,He);if(this.tiles[Lt])return Vo(this.tiles[Lt],St);Tt>1&&console.log("drilling down to z%d-%d-%d",Le,Fe,He);let di,li=Le,Zt=Fe,wi=He;for(;!di&&li>0;)li--,Zt>>=1,wi>>=1,di=this.tiles[ml(li,Zt,wi)];return di&&di.source?(Tt>1&&(console.log("found parent tile z%d-%d-%d",li,Zt,wi),console.time("drilling down")),this.splitTile(di.source,li,Zt,wi,Le,Fe,He),Tt>1&&console.timeEnd("drilling down"),this.tiles[Lt]?Vo(this.tiles[Lt],St):null):null}}function ml(Vt,Le,Fe){return 32*((1<<Vt)*Fe+Le)+Vt}function Hs(Vt,Le){return Le?Vt.properties[Le]:Vt.id}function Ha(Vt,Le){if(Vt==null)return!0;if(Vt.type==="Feature")return Hs(Vt,Le)!=null;if(Vt.type==="FeatureCollection"){let Fe=new Set;for(let He of Vt.features){let mt=Hs(He,Le);if(mt==null||Fe.has(mt))return!1;Fe.add(mt)}return!0}return!1}function sl(Vt,Le){let Fe=new Map;if(Vt!=null)if(Vt.type==="Feature")Fe.set(Hs(Vt,Le),Vt);else for(let He of Vt.features)Fe.set(Hs(He,Le),He);return Fe}class El extends _r{constructor(){super(...arguments),this._dataUpdateable=new Map}loadVectorTile(Le,Fe){return O._(this,void 0,void 0,function*(){let He=Le.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");let mt=this._geoJSONIndex.getTile(He.z,He.x,He.y);if(!mt)return null;let St=new Bo(mt.features),Tt=Aa(St);return Tt.byteOffset===0&&Tt.byteLength===Tt.buffer.byteLength||(Tt=new Uint8Array(Tt)),{vectorTile:St,rawData:Tt.buffer}})}loadData(Le){return O._(this,void 0,void 0,function*(){var Fe;(Fe=this._pendingRequest)===null||Fe===void 0||Fe.abort();let He=!!(Le&&Le.request&&Le.request.collectResourceTiming)&&new O.cM(Le.request);this._pendingRequest=new AbortController;try{this._pendingData=this.loadAndProcessGeoJSON(Le,this._pendingRequest),this._geoJSONIndex=Le.cluster?new No(function({superclusterOptions:Tt,clusterProperties:Xt}){if(!Xt||!Tt)return Tt;let Lt={},di={},li={accumulated:null,zoom:0},Zt={properties:null},wi=Object.keys(Xt);for(let Ue of wi){let[Qi,$n]=Xt[Ue],ht=O.cT($n),te=O.cT(typeof Qi=="string"?[Qi,["accumulated"],["get",Ue]]:Qi);Lt[Ue]=ht.value,di[Ue]=te.value}return Tt.map=Ue=>{Zt.properties=Ue;let Qi={};for(let $n of wi)Qi[$n]=Lt[$n].evaluate(li,Zt);return Qi},Tt.reduce=(Ue,Qi)=>{Zt.properties=Qi;for(let $n of wi)li.accumulated=Ue[$n],Ue[$n]=di[$n].evaluate(li,Zt)},Tt}(Le)).load((yield this._pendingData).features):(mt=yield this._pendingData,new Ws(mt,Le.geojsonVtOptions)),this.loaded={};let St={};if(He){let Tt=He.finish();Tt&&(St.resourceTiming={},St.resourceTiming[Le.source]=JSON.parse(JSON.stringify(Tt)))}return St}catch(St){if(delete this._pendingRequest,O.cx(St))return{abandoned:!0};throw St}var mt})}getData(){return O._(this,void 0,void 0,function*(){return this._pendingData})}reloadTile(Le){let Fe=this.loaded;return Fe&&Fe[Le.uid]?super.reloadTile(Le):this.loadTile(Le)}loadAndProcessGeoJSON(Le,Fe){return O._(this,void 0,void 0,function*(){let He=yield this.loadGeoJSON(Le,Fe);if(delete this._pendingRequest,typeof He!="object")throw new Error(`Input data given to '${Le.source}' is not a valid GeoJSON object.`);if(vn(He,!0),Le.filter){let mt=O.cT(Le.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(mt.result==="error")throw new Error(mt.value.map(Tt=>`${Tt.key}: ${Tt.message}`).join(", "));He={type:"FeatureCollection",features:He.features.filter(Tt=>mt.value.evaluate({zoom:0},Tt))}}return He})}loadGeoJSON(Le,Fe){return O._(this,void 0,void 0,function*(){let{promoteId:He}=Le;if(Le.request){let mt=yield O.j(Le.request,Fe);return this._dataUpdateable=Ha(mt.data,He)?sl(mt.data,He):void 0,mt.data}if(typeof Le.data=="string")try{let mt=JSON.parse(Le.data);return this._dataUpdateable=Ha(mt,He)?sl(mt,He):void 0,mt}catch{throw new Error(`Input data given to '${Le.source}' is not a valid GeoJSON object.`)}if(!Le.dataDiff)throw new Error(`Input data given to '${Le.source}' is not a valid GeoJSON object.`);if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${Le.source}`);return function(mt,St,Tt){var Xt,Lt,di,li;if(St.removeAll&&mt.clear(),St.remove)for(let Zt of St.remove)mt.delete(Zt);if(St.add)for(let Zt of St.add){let wi=Hs(Zt,Tt);wi!=null&&mt.set(wi,Zt)}if(St.update)for(let Zt of St.update){let wi=mt.get(Zt.id);if(wi==null)continue;let Ue=!Zt.removeAllProperties&&(((Xt=Zt.removeProperties)===null||Xt===void 0?void 0:Xt.length)>0||((Lt=Zt.addOrUpdateProperties)===null||Lt===void 0?void 0:Lt.length)>0);if((Zt.newGeometry||Zt.removeAllProperties||Ue)&&(wi=Object.assign({},wi),mt.set(Zt.id,wi),Ue&&(wi.properties=Object.assign({},wi.properties))),Zt.newGeometry&&(wi.geometry=Zt.newGeometry),Zt.removeAllProperties)wi.properties={};else if(((di=Zt.removeProperties)===null||di===void 0?void 0:di.length)>0)for(let Qi of Zt.removeProperties)Object.prototype.hasOwnProperty.call(wi.properties,Qi)&&delete wi.properties[Qi];if(((li=Zt.addOrUpdateProperties)===null||li===void 0?void 0:li.length)>0)for(let{key:Qi,value:$n}of Zt.addOrUpdateProperties)wi.properties[Qi]=$n}}(this._dataUpdateable,Le.dataDiff,He),{type:"FeatureCollection",features:Array.from(this._dataUpdateable.values())}})}removeSource(Le){return O._(this,void 0,void 0,function*(){this._pendingRequest&&this._pendingRequest.abort()})}getClusterExpansionZoom(Le){return this._geoJSONIndex.getClusterExpansionZoom(Le.clusterId)}getClusterChildren(Le){return this._geoJSONIndex.getChildren(Le.clusterId)}getClusterLeaves(Le){return this._geoJSONIndex.getLeaves(Le.clusterId,Le.limit,Le.offset)}}class ms{constructor(Le){this.self=Le,this.actor=new O.J(Le),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.self.registerWorkerSource=(Fe,He)=>{if(this.externalWorkerSourceTypes[Fe])throw new Error(`Worker source with name "${Fe}" already registered.`);this.externalWorkerSourceTypes[Fe]=He},this.self.addProtocol=O.cz,this.self.removeProtocol=O.cA,this.self.registerRTLTextPlugin=Fe=>{O.cU.setMethods(Fe)},this.actor.registerMessageHandler("LDT",(Fe,He)=>this._getDEMWorkerSource(Fe,He.source).loadTile(He)),this.actor.registerMessageHandler("RDT",(Fe,He)=>O._(this,void 0,void 0,function*(){this._getDEMWorkerSource(Fe,He.source).removeTile(He)})),this.actor.registerMessageHandler("GCEZ",(Fe,He)=>O._(this,void 0,void 0,function*(){return this._getWorkerSource(Fe,He.type,He.source).getClusterExpansionZoom(He)})),this.actor.registerMessageHandler("GCC",(Fe,He)=>O._(this,void 0,void 0,function*(){return this._getWorkerSource(Fe,He.type,He.source).getClusterChildren(He)})),this.actor.registerMessageHandler("GCL",(Fe,He)=>O._(this,void 0,void 0,function*(){return this._getWorkerSource(Fe,He.type,He.source).getClusterLeaves(He)})),this.actor.registerMessageHandler("LD",(Fe,He)=>this._getWorkerSource(Fe,He.type,He.source).loadData(He)),this.actor.registerMessageHandler("GD",(Fe,He)=>this._getWorkerSource(Fe,He.type,He.source).getData()),this.actor.registerMessageHandler("LT",(Fe,He)=>this._getWorkerSource(Fe,He.type,He.source).loadTile(He)),this.actor.registerMessageHandler("RT",(Fe,He)=>this._getWorkerSource(Fe,He.type,He.source).reloadTile(He)),this.actor.registerMessageHandler("AT",(Fe,He)=>this._getWorkerSource(Fe,He.type,He.source).abortTile(He)),this.actor.registerMessageHandler("RMT",(Fe,He)=>this._getWorkerSource(Fe,He.type,He.source).removeTile(He)),this.actor.registerMessageHandler("RS",(Fe,He)=>O._(this,void 0,void 0,function*(){if(!this.workerSources[Fe]||!this.workerSources[Fe][He.type]||!this.workerSources[Fe][He.type][He.source])return;let mt=this.workerSources[Fe][He.type][He.source];delete this.workerSources[Fe][He.type][He.source],mt.removeSource!==void 0&&mt.removeSource(He)})),this.actor.registerMessageHandler("RM",Fe=>O._(this,void 0,void 0,function*(){delete this.layerIndexes[Fe],delete this.availableImages[Fe],delete this.workerSources[Fe],delete this.demWorkerSources[Fe]})),this.actor.registerMessageHandler("SR",(Fe,He)=>O._(this,void 0,void 0,function*(){this.referrer=He})),this.actor.registerMessageHandler("SRPS",(Fe,He)=>this._syncRTLPluginState(Fe,He)),this.actor.registerMessageHandler("IS",(Fe,He)=>O._(this,void 0,void 0,function*(){this.self.importScripts(He)})),this.actor.registerMessageHandler("SI",(Fe,He)=>this._setImages(Fe,He)),this.actor.registerMessageHandler("UL",(Fe,He)=>O._(this,void 0,void 0,function*(){this._getLayerIndex(Fe).update(He.layers,He.removedIds)})),this.actor.registerMessageHandler("SL",(Fe,He)=>O._(this,void 0,void 0,function*(){this._getLayerIndex(Fe).replace(He)}))}_setImages(Le,Fe){return O._(this,void 0,void 0,function*(){this.availableImages[Le]=Fe;for(let He in this.workerSources[Le]){let mt=this.workerSources[Le][He];for(let St in mt)mt[St].availableImages=Fe}})}_syncRTLPluginState(Le,Fe){return O._(this,void 0,void 0,function*(){return yield O.cU.syncState(Fe,this.self.importScripts)})}_getAvailableImages(Le){let Fe=this.availableImages[Le];return Fe||(Fe=[]),Fe}_getLayerIndex(Le){let Fe=this.layerIndexes[Le];return Fe||(Fe=this.layerIndexes[Le]=new t),Fe}_getWorkerSource(Le,Fe,He){if(this.workerSources[Le]||(this.workerSources[Le]={}),this.workerSources[Le][Fe]||(this.workerSources[Le][Fe]={}),!this.workerSources[Le][Fe][He]){let mt={sendAsync:(St,Tt)=>(St.targetMapId=Le,this.actor.sendAsync(St,Tt))};switch(Fe){case"vector":this.workerSources[Le][Fe][He]=new _r(mt,this._getLayerIndex(Le),this._getAvailableImages(Le));break;case"geojson":this.workerSources[Le][Fe][He]=new El(mt,this._getLayerIndex(Le),this._getAvailableImages(Le));break;default:this.workerSources[Le][Fe][He]=new this.externalWorkerSourceTypes[Fe](mt,this._getLayerIndex(Le),this._getAvailableImages(Le))}}return this.workerSources[Le][Fe][He]}_getDEMWorkerSource(Le,Fe){return this.demWorkerSources[Le]||(this.demWorkerSources[Le]={}),this.demWorkerSources[Le][Fe]||(this.demWorkerSources[Le][Fe]=new an),this.demWorkerSources[Le][Fe]}}return O.i(self)&&(self.worker=new ms(self)),ms}),P("index",["exports","./shared"],function(O,t){"use strict";var at="5.6.0";function yi(){var M=new t.A(4);return t.A!=Float32Array&&(M[1]=0,M[2]=0),M[0]=1,M[3]=1,M}let Cn,_r,an={now:typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frame(M,r,h){let x=requestAnimationFrame(A=>{w(),r(A)}),{unsubscribe:w}=t.s(M.signal,"abort",()=>{w(),cancelAnimationFrame(x),h(t.c())},!1)},frameAsync(M){return new Promise((r,h)=>{this.frame(M,r,h)})},getImageData(M,r=0){return this.getImageCanvasContext(M).getImageData(-r,-r,M.width+2*r,M.height+2*r)},getImageCanvasContext(M){let r=window.document.createElement("canvas"),h=r.getContext("2d",{willReadFrequently:!0});if(!h)throw new Error("failed to create canvas 2d context");return r.width=M.width,r.height=M.height,h.drawImage(M,0,0,M.width,M.height),h},resolveURL:M=>(Cn||(Cn=document.createElement("a")),Cn.href=M,Cn.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(_r==null&&(_r=matchMedia("(prefers-reduced-motion: reduce)")),_r.matches)}};class Dt{static testProp(r){if(!Dt.docStyle)return r[0];for(let h=0;h<r.length;h++)if(r[h]in Dt.docStyle)return r[h];return r[0]}static create(r,h,x){let w=window.document.createElement(r);return h!==void 0&&(w.className=h),x&&x.appendChild(w),w}static createNS(r,h){return window.document.createElementNS(r,h)}static disableDrag(){Dt.docStyle&&Dt.selectProp&&(Dt.userSelect=Dt.docStyle[Dt.selectProp],Dt.docStyle[Dt.selectProp]="none")}static enableDrag(){Dt.docStyle&&Dt.selectProp&&(Dt.docStyle[Dt.selectProp]=Dt.userSelect)}static setTransform(r,h){r.style[Dt.transformProp]=h}static addEventListener(r,h,x,w={}){r.addEventListener(h,x,"passive"in w?w:w.capture)}static removeEventListener(r,h,x,w={}){r.removeEventListener(h,x,"passive"in w?w:w.capture)}static suppressClickInternal(r){r.preventDefault(),r.stopPropagation(),window.removeEventListener("click",Dt.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",Dt.suppressClickInternal,!0),window.setTimeout(()=>{window.removeEventListener("click",Dt.suppressClickInternal,!0)},0)}static getScale(r){let h=r.getBoundingClientRect();return{x:h.width/r.offsetWidth||1,y:h.height/r.offsetHeight||1,boundingClientRect:h}}static getPoint(r,h,x){let w=h.boundingClientRect;return new t.P((x.clientX-w.left)/h.x-r.clientLeft,(x.clientY-w.top)/h.y-r.clientTop)}static mousePos(r,h){let x=Dt.getScale(r);return Dt.getPoint(r,x,h)}static touchPos(r,h){let x=[],w=Dt.getScale(r);for(let A=0;A<h.length;A++)x.push(Dt.getPoint(r,w,h[A]));return x}static mouseButton(r){return r.button}static remove(r){r.parentNode&&r.parentNode.removeChild(r)}static sanitize(r){let h=new DOMParser().parseFromString(r,"text/html").body||document.createElement("body"),x=h.querySelectorAll("script");for(let w of x)w.remove();return Dt.clean(h),h.innerHTML}static isPossiblyDangerous(r,h){let x=h.replace(/\s+/g,"").toLowerCase();return!(!["src","href","xlink:href"].includes(r)||!x.includes("javascript:")&&!x.includes("data:"))||!!r.startsWith("on")||void 0}static clean(r){let h=r.children;for(let x of h)Dt.removeAttributes(x),Dt.clean(x)}static removeAttributes(r){for(let{name:h,value:x}of r.attributes)Dt.isPossiblyDangerous(h,x)&&r.removeAttribute(h)}}Dt.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,Dt.selectProp=Dt.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),Dt.transformProp=Dt.testProp(["transform","WebkitTransform"]);let Wi={supported:!1,testSupport:function(M){!gn&&vn&&(vr?Bo(M):on=M)}},on,vn,gn=!1,vr=!1;function Bo(M){let r=M.createTexture();M.bindTexture(M.TEXTURE_2D,r);try{if(M.texImage2D(M.TEXTURE_2D,0,M.RGBA,M.RGBA,M.UNSIGNED_BYTE,vn),M.isContextLost())return;Wi.supported=!0}catch{}M.deleteTexture(r),gn=!0}var qo;typeof document<"u"&&(vn=document.createElement("img"),vn.onload=()=>{on&&Bo(on),on=null,vr=!0},vn.onerror=()=>{gn=!0,on=null},vn.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),function(M){let r,h,x,w;M.resetRequestQueue=()=>{r=[],h=0,x=0,w={}},M.addThrottleControl=q=>{let J=x++;return w[J]=q,J},M.removeThrottleControl=q=>{delete w[q],k()},M.getImage=(q,J,ne=!0)=>new Promise((pe,ue)=>{Wi.supported&&(q.headers||(q.headers={}),q.headers.accept="image/webp,*/*"),t.e(q,{type:"image"}),r.push({abortController:J,requestParameters:q,supportImageRefresh:ne,state:"queued",onError:ge=>{ue(ge)},onSuccess:ge=>{pe(ge)}}),k()});let A=q=>t._(this,void 0,void 0,function*(){q.state="running";let{requestParameters:J,supportImageRefresh:ne,onError:pe,onSuccess:ue,abortController:ge}=q,Ee=ne===!1&&!t.i(self)&&!t.g(J.url)&&(!J.headers||Object.keys(J.headers).reduce((et,Se)=>et&&Se==="accept",!0));h++;let tt=Ee?j(J,ge):t.m(J,ge);try{let et=yield tt;delete q.abortController,q.state="completed",et.data instanceof HTMLImageElement||t.b(et.data)?ue(et):et.data&&ue({data:yield(Xe=et.data,typeof createImageBitmap=="function"?t.f(Xe):t.h(Xe)),cacheControl:et.cacheControl,expires:et.expires})}catch(et){delete q.abortController,pe(et)}finally{h--,k()}var Xe}),k=()=>{let q=(()=>{for(let J of Object.keys(w))if(w[J]())return!0;return!1})()?t.a.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:t.a.MAX_PARALLEL_IMAGE_REQUESTS;for(let J=h;J<q&&r.length>0;J++){let ne=r.shift();ne.abortController.signal.aborted?J--:A(ne)}},j=(q,J)=>new Promise((ne,pe)=>{let ue=new Image,ge=q.url,Ee=q.credentials;Ee&&Ee==="include"?ue.crossOrigin="use-credentials":(Ee&&Ee==="same-origin"||!t.d(ge))&&(ue.crossOrigin="anonymous"),J.signal.addEventListener("abort",()=>{ue.src="",pe(t.c())}),ue.fetchPriority="high",ue.onload=()=>{ue.onerror=ue.onload=null,ne({data:ue})},ue.onerror=()=>{ue.onerror=ue.onload=null,J.signal.aborted||pe(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},ue.src=ge})}(qo||(qo={})),qo.resetRequestQueue();class to{constructor(r){this._transformRequestFn=r}transformRequest(r,h){return this._transformRequestFn&&this._transformRequestFn(r,h)||{url:r}}setTransformRequest(r){this._transformRequestFn=r}}function Br(M){let r=[];if(typeof M=="string")r.push({id:"default",url:M});else if(M&&M.length>0){let h=[];for(let{id:x,url:w}of M){let A=`${x}${w}`;h.indexOf(A)===-1&&(h.push(A),r.push({id:x,url:w}))}}return r}function os(M,r,h){try{let x=new URL(M);return x.pathname+=`${r}${h}`,x.toString()}catch{throw new Error(`Invalid sprite URL "${M}", must be absolute. Modify style specification directly or use TransformStyleFunction to correct the issue dynamically`)}}function ga(M){let{userImage:r}=M;return!!(r&&r.render&&r.render())&&(M.data.replace(new Uint8Array(r.data.buffer)),!0)}class Aa extends t.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new t.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(r){if(this.loaded!==r&&(this.loaded=r,r)){for(let{ids:h,promiseResolve:x}of this.requestors)x(this._getImagesForIds(h));this.requestors=[]}}getImage(r){let h=this.images[r];if(h&&!h.data&&h.spriteData){let x=h.spriteData;h.data=new t.R({width:x.width,height:x.height},x.context.getImageData(x.x,x.y,x.width,x.height).data),h.spriteData=null}return h}addImage(r,h){if(this.images[r])throw new Error(`Image id ${r} already exist, use updateImage instead`);this._validate(r,h)&&(this.images[r]=h)}_validate(r,h){let x=!0,w=h.data||h.spriteData;return this._validateStretch(h.stretchX,w&&w.width)||(this.fire(new t.k(new Error(`Image "${r}" has invalid "stretchX" value`))),x=!1),this._validateStretch(h.stretchY,w&&w.height)||(this.fire(new t.k(new Error(`Image "${r}" has invalid "stretchY" value`))),x=!1),this._validateContent(h.content,h)||(this.fire(new t.k(new Error(`Image "${r}" has invalid "content" value`))),x=!1),x}_validateStretch(r,h){if(!r)return!0;let x=0;for(let w of r){if(w[0]<x||w[1]<w[0]||h<w[1])return!1;x=w[1]}return!0}_validateContent(r,h){if(!r)return!0;if(r.length!==4)return!1;let x=h.spriteData,w=x&&x.width||h.data.width,A=x&&x.height||h.data.height;return!(r[0]<0||w<r[0]||r[1]<0||A<r[1]||r[2]<0||w<r[2]||r[3]<0||A<r[3]||r[2]<r[0]||r[3]<r[1])}updateImage(r,h,x=!0){let w=this.getImage(r);if(x&&(w.data.width!==h.data.width||w.data.height!==h.data.height))throw new Error(`size mismatch between old image (${w.data.width}x${w.data.height}) and new image (${h.data.width}x${h.data.height}).`);h.version=w.version+1,this.images[r]=h,this.updatedImages[r]=!0}removeImage(r){let h=this.images[r];delete this.images[r],delete this.patterns[r],h.userImage&&h.userImage.onRemove&&h.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(r){return new Promise((h,x)=>{let w=!0;if(!this.isLoaded())for(let A of r)this.images[A]||(w=!1);this.isLoaded()||w?h(this._getImagesForIds(r)):this.requestors.push({ids:r,promiseResolve:h})})}_getImagesForIds(r){let h={};for(let x of r){let w=this.getImage(x);w||(this.fire(new t.l("styleimagemissing",{id:x})),w=this.getImage(x)),w?h[x]={data:w.data.clone(),pixelRatio:w.pixelRatio,sdf:w.sdf,version:w.version,stretchX:w.stretchX,stretchY:w.stretchY,content:w.content,textFitWidth:w.textFitWidth,textFitHeight:w.textFitHeight,hasRenderCallback:!!(w.userImage&&w.userImage.render)}:t.w(`Image "${x}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return h}getPixelSize(){let{width:r,height:h}=this.atlasImage;return{width:r,height:h}}getPattern(r){let h=this.patterns[r],x=this.getImage(r);if(!x)return null;if(h&&h.position.version===x.version)return h.position;if(h)h.position.version=x.version;else{let w={w:x.data.width+2,h:x.data.height+2,x:0,y:0},A=new t.I(w,x);this.patterns[r]={bin:w,position:A}}return this._updatePatternAtlas(),this.patterns[r].position}bind(r){let h=r.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new t.T(r,this.atlasImage,h.RGBA),this.atlasTexture.bind(h.LINEAR,h.CLAMP_TO_EDGE)}_updatePatternAtlas(){let r=[];for(let A in this.patterns)r.push(this.patterns[A].bin);let{w:h,h:x}=t.p(r),w=this.atlasImage;w.resize({width:h||1,height:x||1});for(let A in this.patterns){let{bin:k}=this.patterns[A],j=k.x+1,q=k.y+1,J=this.getImage(A).data,ne=J.width,pe=J.height;t.R.copy(J,w,{x:0,y:0},{x:j,y:q},{width:ne,height:pe}),t.R.copy(J,w,{x:0,y:pe-1},{x:j,y:q-1},{width:ne,height:1}),t.R.copy(J,w,{x:0,y:0},{x:j,y:q+pe},{width:ne,height:1}),t.R.copy(J,w,{x:ne-1,y:0},{x:j-1,y:q},{width:1,height:pe}),t.R.copy(J,w,{x:0,y:0},{x:j+ne,y:q},{width:1,height:pe})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(r){for(let h of r){if(this.callbackDispatchedThisFrame[h])continue;this.callbackDispatchedThisFrame[h]=!0;let x=this.getImage(h);x||t.w(`Image with ID: "${h}" was not found`),ga(x)&&this.updateImage(h,x)}}}let Ql=1e20;function Io(M,r,h,x,w,A,k,j,q){for(let J=r;J<r+x;J++)qa(M,h*A+J,A,w,k,j,q);for(let J=h;J<h+w;J++)qa(M,J*A+r,1,x,k,j,q)}function qa(M,r,h,x,w,A,k){A[0]=0,k[0]=-1e20,k[1]=Ql,w[0]=M[r];for(let j=1,q=0,J=0;j<x;j++){w[j]=M[r+j*h];let ne=j*j;do{let pe=A[q];J=(w[j]-w[pe]+ne-pe*pe)/(j-pe)/2}while(J<=k[q]&&--q>-1);q++,A[q]=j,k[q]=J,k[q+1]=Ql}for(let j=0,q=0;j<x;j++){for(;k[q+1]<j;)q++;let J=A[q],ne=j-J;M[r+j*h]=w[J]+ne*ne}}class No{constructor(r,h){this.requestManager=r,this.localIdeographFontFamily=h,this.entries={}}setURL(r){this.url=r}getGlyphs(r){return t._(this,void 0,void 0,function*(){let h=[];for(let A in r)for(let k of r[A])h.push(this._getAndCacheGlyphsPromise(A,k));let x=yield Promise.all(h),w={};for(let{stack:A,id:k,glyph:j}of x)w[A]||(w[A]={}),w[A][k]=j&&{id:j.id,bitmap:j.bitmap.clone(),metrics:j.metrics};return w})}_getAndCacheGlyphsPromise(r,h){return t._(this,void 0,void 0,function*(){let x=this.entries[r];x||(x=this.entries[r]={glyphs:{},requests:{},ranges:{}});let w=x.glyphs[h];if(w!==void 0)return{stack:r,id:h,glyph:w};if(w=this._tinySDF(x,r,h),w)return x.glyphs[h]=w,{stack:r,id:h,glyph:w};let A=Math.floor(h/256);if(256*A>65535)throw new Error("glyphs > 65535 not supported");if(x.ranges[A])return{stack:r,id:h,glyph:w};if(!this.url)throw new Error("glyphsUrl is not set");if(!x.requests[A]){let j=No.loadGlyphRange(r,A,this.url,this.requestManager);x.requests[A]=j}let k=yield x.requests[A];for(let j in k)this._doesCharSupportLocalGlyph(+j)||(x.glyphs[+j]=k[+j]);return x.ranges[A]=!0,{stack:r,id:h,glyph:k[h]||null}})}_doesCharSupportLocalGlyph(r){return!!this.localIdeographFontFamily&&(new RegExp("\\p{Ideo}|\\p{sc=Hang}|\\p{sc=Hira}|\\p{sc=Kana}","u").test(String.fromCodePoint(r))||t.u["CJK Unified Ideographs"](r)||t.u["Hangul Syllables"](r)||t.u.Hiragana(r)||t.u.Katakana(r)||t.u["CJK Symbols and Punctuation"](r)||t.u["Halfwidth and Fullwidth Forms"](r))}_tinySDF(r,h,x){let w=this.localIdeographFontFamily;if(!w||!this._doesCharSupportLocalGlyph(x))return;let A=r.tinySDF;if(!A){let j="400";/bold/i.test(h)?j="900":/medium/i.test(h)?j="500":/light/i.test(h)&&(j="200"),A=r.tinySDF=new No.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:w,fontWeight:j})}let k=A.draw(String.fromCharCode(x));return{id:x,bitmap:new t.q({width:k.width||60,height:k.height||60},k.data),metrics:{width:k.glyphWidth/2||24,height:k.glyphHeight/2||24,left:k.glyphLeft/2+.5||0,top:k.glyphTop/2-27.5||-8,advance:k.glyphAdvance/2||24,isDoubleResolution:!0}}}}No.loadGlyphRange=function(M,r,h,x){return t._(this,void 0,void 0,function*(){let w=256*r,A=w+255,k=x.transformRequest(h.replace("{fontstack}",M).replace("{range}",`${w}-${A}`),"Glyphs"),j=yield t.n(k,new AbortController);if(!j||!j.data)throw new Error(`Could not load glyph range. range: ${r}, ${w}-${A}`);let q={};for(let J of t.o(j.data))q[J.id]=J;return q})},No.TinySDF=class{constructor({fontSize:M=24,buffer:r=3,radius:h=8,cutoff:x=.25,fontFamily:w="sans-serif",fontWeight:A="normal",fontStyle:k="normal"}={}){this.buffer=r,this.cutoff=x,this.radius=h;let j=this.size=M+4*r,q=this._createCanvas(j),J=this.ctx=q.getContext("2d",{willReadFrequently:!0});J.font=`${k} ${A} ${M}px ${w}`,J.textBaseline="alphabetic",J.textAlign="left",J.fillStyle="black",this.gridOuter=new Float64Array(j*j),this.gridInner=new Float64Array(j*j),this.f=new Float64Array(j),this.z=new Float64Array(j+1),this.v=new Uint16Array(j)}_createCanvas(M){let r=document.createElement("canvas");return r.width=r.height=M,r}draw(M){let{width:r,actualBoundingBoxAscent:h,actualBoundingBoxDescent:x,actualBoundingBoxLeft:w,actualBoundingBoxRight:A}=this.ctx.measureText(M),k=Math.ceil(h),j=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(A-w))),q=Math.min(this.size-this.buffer,k+Math.ceil(x)),J=j+2*this.buffer,ne=q+2*this.buffer,pe=Math.max(J*ne,0),ue=new Uint8ClampedArray(pe),ge={data:ue,width:J,height:ne,glyphWidth:j,glyphHeight:q,glyphTop:k,glyphLeft:0,glyphAdvance:r};if(j===0||q===0)return ge;let{ctx:Ee,buffer:tt,gridInner:Xe,gridOuter:et}=this;Ee.clearRect(tt,tt,j,q),Ee.fillText(M,tt,tt+k);let Se=Ee.getImageData(tt,tt,j,q);et.fill(Ql,0,pe),Xe.fill(0,0,pe);for(let Be=0;Be<q;Be++)for(let ft=0;ft<j;ft++){let dt=Se.data[4*(Be*j+ft)+3]/255;if(dt===0)continue;let xe=(Be+tt)*J+ft+tt;if(dt===1)et[xe]=0,Xe[xe]=Ql;else{let pt=.5-dt;et[xe]=pt>0?pt*pt:0,Xe[xe]=pt<0?pt*pt:0}}Io(et,0,0,J,ne,J,this.f,this.v,this.z),Io(Xe,tt,tt,j,q,J,this.f,this.v,this.z);for(let Be=0;Be<pe;Be++){let ft=Math.sqrt(et[Be])-Math.sqrt(Xe[Be]);ue[Be]=Math.round(255-255*(ft/this.radius+this.cutoff))}return ge}};class Ur{constructor(){this.specification=t.v.light.position}possiblyEvaluate(r,h){return t.B(r.expression.evaluate(h))}interpolate(r,h,x){return{x:t.C.number(r.x,h.x,x),y:t.C.number(r.y,h.y,x),z:t.C.number(r.z,h.z,x)}}}let ho;class ss extends t.E{constructor(r){super(),ho=ho||new t.r({anchor:new t.D(t.v.light.anchor),position:new Ur,color:new t.D(t.v.light.color),intensity:new t.D(t.v.light.intensity)}),this._transitionable=new t.t(ho),this.setLight(r),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(r,h={}){if(!this._validate(t.x,r,h))for(let x in r){let w=r[x];x.endsWith("-transition")?this._transitionable.setTransition(x.slice(0,-11),w):this._transitionable.setValue(x,w)}}updateTransitions(r){this._transitioning=this._transitionable.transitioned(r,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(r){this.properties=this._transitioning.possiblyEvaluate(r)}_validate(r,h,x){return(!x||x.validate!==!1)&&t.y(this,r.call(t.z,{value:h,style:{glyphs:!0,sprite:!0},styleSpec:t.v}))}}let ya=new t.r({"sky-color":new t.D(t.v.sky["sky-color"]),"horizon-color":new t.D(t.v.sky["horizon-color"]),"fog-color":new t.D(t.v.sky["fog-color"]),"fog-ground-blend":new t.D(t.v.sky["fog-ground-blend"]),"horizon-fog-blend":new t.D(t.v.sky["horizon-fog-blend"]),"sky-horizon-blend":new t.D(t.v.sky["sky-horizon-blend"]),"atmosphere-blend":new t.D(t.v.sky["atmosphere-blend"])});class dl extends t.E{constructor(r){super(),this._transitionable=new t.t(ya),this.setSky(r),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new t.F(0))}setSky(r,h={}){if(!this._validate(t.G,r,h)){r||(r={"sky-color":"transparent","horizon-color":"transparent","fog-color":"transparent","fog-ground-blend":1,"atmosphere-blend":0});for(let x in r){let w=r[x];x.endsWith("-transition")?this._transitionable.setTransition(x.slice(0,-11),w):this._transitionable.setValue(x,w)}}}getSky(){return this._transitionable.serialize()}updateTransitions(r){this._transitioning=this._transitionable.transitioned(r,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(r){this.properties=this._transitioning.possiblyEvaluate(r)}_validate(r,h,x={}){return x?.validate!==!1&&t.y(this,r.call(t.z,t.e({value:h,style:{glyphs:!0,sprite:!0},styleSpec:t.v})))}calculateFogBlendOpacity(r){return r<60?0:r<70?(r-60)/10:1}}class $a{constructor(r,h){this.width=r,this.height=h,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(r,h){let x=r.join(",")+String(h);return this.dashEntry[x]||(this.dashEntry[x]=this.addDash(r,h)),this.dashEntry[x]}getDashRanges(r,h,x){let w=[],A=r.length%2==1?-r[r.length-1]*x:0,k=r[0]*x,j=!0;w.push({left:A,right:k,isDash:j,zeroLength:r[0]===0});let q=r[0];for(let J=1;J<r.length;J++){j=!j;let ne=r[J];A=q*x,q+=ne,k=q*x,w.push({left:A,right:k,isDash:j,zeroLength:ne===0})}return w}addRoundDash(r,h,x){let w=h/2;for(let A=-x;A<=x;A++){let k=this.width*(this.nextRow+x+A),j=0,q=r[j];for(let J=0;J<this.width;J++){J/q.right>1&&(q=r[++j]);let ne=Math.abs(J-q.left),pe=Math.abs(J-q.right),ue=Math.min(ne,pe),ge,Ee=A/x*(w+1);if(q.isDash){let tt=w-Math.abs(Ee);ge=Math.sqrt(ue*ue+tt*tt)}else ge=w-Math.sqrt(ue*ue+Ee*Ee);this.data[k+J]=Math.max(0,Math.min(255,ge+128))}}}addRegularDash(r){for(let j=r.length-1;j>=0;--j){let q=r[j],J=r[j+1];q.zeroLength?r.splice(j,1):J&&J.isDash===q.isDash&&(J.left=q.left,r.splice(j,1))}let h=r[0],x=r[r.length-1];h.isDash===x.isDash&&(h.left=x.left-this.width,x.right=h.right+this.width);let w=this.width*this.nextRow,A=0,k=r[A];for(let j=0;j<this.width;j++){j/k.right>1&&(k=r[++A]);let q=Math.abs(j-k.left),J=Math.abs(j-k.right),ne=Math.min(q,J);this.data[w+j]=Math.max(0,Math.min(255,(k.isDash?ne:-ne)+128))}}addDash(r,h){let x=h?7:0,w=2*x+1;if(this.nextRow+w>this.height)return t.w("LineAtlas out of space"),null;let A=0;for(let j=0;j<r.length;j++)A+=r[j];if(A!==0){let j=this.width/A,q=this.getDashRanges(r,this.width,j);h?this.addRoundDash(q,j,x):this.addRegularDash(q)}let k={y:(this.nextRow+x+.5)/this.height,height:2*x/this.height,width:A};return this.nextRow+=w,this.dirty=!0,k}bind(r){let h=r.gl;this.texture?(h.bindTexture(h.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,h.texSubImage2D(h.TEXTURE_2D,0,0,0,this.width,this.height,h.ALPHA,h.UNSIGNED_BYTE,this.data))):(this.texture=h.createTexture(),h.bindTexture(h.TEXTURE_2D,this.texture),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.REPEAT),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.REPEAT),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.LINEAR),h.texImage2D(h.TEXTURE_2D,0,h.ALPHA,this.width,this.height,0,h.ALPHA,h.UNSIGNED_BYTE,this.data))}}let Mr="maplibre_preloaded_worker_pool";class as{constructor(){this.active={}}acquire(r){if(!this.workers)for(this.workers=[];this.workers.length<as.workerCount;)this.workers.push(new Worker(t.a.WORKER_URL));return this.active[r]=!0,this.workers.slice()}release(r){delete this.active[r],this.numActive()===0&&(this.workers.forEach(h=>{h.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Mr]}numActive(){return Object.keys(this.active).length}}let Hr=Math.floor(an.hardwareConcurrency/2),Da,xa;function Lr(){return Da||(Da=new as),Da}as.workerCount=t.H(globalThis)?Math.max(Math.min(Hr,3),1):1;class jr{constructor(r,h){this.workerPool=r,this.actors=[],this.currentActor=0,this.id=h;let x=this.workerPool.acquire(h);for(let w=0;w<x.length;w++){let A=new t.J(x[w],h);A.name=`Worker ${w}`,this.actors.push(A)}if(!this.actors.length)throw new Error("No actors found")}broadcast(r,h){let x=[];for(let w of this.actors)x.push(w.sendAsync({type:r,data:h}));return Promise.all(x)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(r=!0){this.actors.forEach(h=>{h.remove()}),this.actors=[],r&&this.workerPool.release(this.id)}registerMessageHandler(r,h){for(let x of this.actors)x.registerMessageHandler(r,h)}}function Co(){return xa||(xa=new jr(Lr(),t.K),xa.registerMessageHandler("GR",(M,r,h)=>t.m(r,h))),xa}function $c(M,r){let h=t.L();return t.M(h,h,[1,1,0]),t.N(h,h,[.5*M.width,.5*M.height,1]),M.calculatePosMatrix?t.O(h,h,M.calculatePosMatrix(r.toUnwrapped())):h}function gr(M,r,h,x,w,A,k){var j;let q=function(ue,ge,Ee){if(ue)for(let tt of ue){let Xe=ge[tt];if(Xe&&Xe.source===Ee&&Xe.type==="fill-extrusion")return!0}else for(let tt in ge){let Xe=ge[tt];if(Xe.source===Ee&&Xe.type==="fill-extrusion")return!0}return!1}((j=w?.layers)!==null&&j!==void 0?j:null,r,M.id),J=A.maxPitchScaleFactor(),ne=M.tilesIn(x,J,q);ne.sort(yc);let pe=[];for(let ue of ne)pe.push({wrappedTileID:ue.tileID.wrapped().key,queryResults:ue.tile.queryRenderedFeatures(r,h,M._state,ue.queryGeometry,ue.cameraQueryGeometry,ue.scale,w,A,J,$c(M.transform,ue.tileID),k?(ge,Ee)=>k(ue.tileID,ge,Ee):void 0)});return function(ue,ge){for(let Ee in ue)for(let tt of ue[Ee])Os(tt,ge);return ue}(function(ue){let ge={},Ee={};for(let tt of ue){let Xe=tt.queryResults,et=tt.wrappedTileID,Se=Ee[et]=Ee[et]||{};for(let Be in Xe){let ft=Xe[Be],dt=Se[Be]=Se[Be]||{},xe=ge[Be]=ge[Be]||[];for(let pt of ft)dt[pt.featureIndex]||(dt[pt.featureIndex]=!0,xe.push(pt))}}return ge}(pe),M)}function yc(M,r){let h=M.tileID,x=r.tileID;return h.overscaledZ-x.overscaledZ||h.canonical.y-x.canonical.y||h.wrap-x.wrap||h.canonical.x-x.canonical.x}function Os(M,r){let h=M.feature,x=r.getFeatureState(h.layer["source-layer"],h.id);h.source=h.layer.source,h.layer["source-layer"]&&(h.sourceLayer=h.layer["source-layer"]),h.state=x}function va(M,r,h){return t._(this,void 0,void 0,function*(){let x=M;if(M.url?x=(yield t.j(r.transformRequest(M.url,"Source"),h)).data:yield an.frameAsync(h),!x)return null;let w=t.Q(t.e(x,M),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in x&&x.vector_layers&&(w.vectorLayerIds=x.vector_layers.map(A=>A.id)),w})}class hr{constructor(r,h){r&&(h?this.setSouthWest(r).setNorthEast(h):Array.isArray(r)&&(r.length===4?this.setSouthWest([r[0],r[1]]).setNorthEast([r[2],r[3]]):this.setSouthWest(r[0]).setNorthEast(r[1])))}setNorthEast(r){return this._ne=r instanceof t.S?new t.S(r.lng,r.lat):t.S.convert(r),this}setSouthWest(r){return this._sw=r instanceof t.S?new t.S(r.lng,r.lat):t.S.convert(r),this}extend(r){let h=this._sw,x=this._ne,w,A;if(r instanceof t.S)w=r,A=r;else{if(!(r instanceof hr))return Array.isArray(r)?r.length===4||r.every(Array.isArray)?this.extend(hr.convert(r)):this.extend(t.S.convert(r)):r&&("lng"in r||"lon"in r)&&"lat"in r?this.extend(t.S.convert(r)):this;if(w=r._sw,A=r._ne,!w||!A)return this}return h||x?(h.lng=Math.min(w.lng,h.lng),h.lat=Math.min(w.lat,h.lat),x.lng=Math.max(A.lng,x.lng),x.lat=Math.max(A.lat,x.lat)):(this._sw=new t.S(w.lng,w.lat),this._ne=new t.S(A.lng,A.lat)),this}getCenter(){return new t.S((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new t.S(this.getWest(),this.getNorth())}getSouthEast(){return new t.S(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(r){let{lng:h,lat:x}=t.S.convert(r),w=this._sw.lng<=h&&h<=this._ne.lng;return this._sw.lng>this._ne.lng&&(w=this._sw.lng>=h&&h>=this._ne.lng),this._sw.lat<=x&&x<=this._ne.lat&&w}static convert(r){return r instanceof hr?r:r&&new hr(r)}static fromLngLat(r,h=0){let x=360*h/40075017,w=x/Math.cos(Math.PI/180*r.lat);return new hr(new t.S(r.lng-w,r.lat-x),new t.S(r.lng+w,r.lat+x))}adjustAntiMeridian(){let r=new t.S(this._sw.lng,this._sw.lat),h=new t.S(this._ne.lng,this._ne.lat);return new hr(r,r.lng>h.lng?new t.S(h.lng+360,h.lat):h)}}class Cl{constructor(r,h,x){this.bounds=hr.convert(this.validateBounds(r)),this.minzoom=h||0,this.maxzoom=x||24}validateBounds(r){return Array.isArray(r)&&r.length===4?[Math.max(-180,r[0]),Math.max(-90,r[1]),Math.min(180,r[2]),Math.min(90,r[3])]:[-180,-90,180,90]}contains(r){let h=Math.pow(2,r.z),x=Math.floor(t.V(this.bounds.getWest())*h),w=Math.floor(t.U(this.bounds.getNorth())*h),A=Math.ceil(t.V(this.bounds.getEast())*h),k=Math.ceil(t.U(this.bounds.getSouth())*h);return r.x>=x&&r.x<A&&r.y>=w&&r.y<k}}class ra extends t.E{constructor(r,h,x,w){if(super(),this.id=r,this.dispatcher=x,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,t.e(this,t.Q(h,["url","scheme","tileSize","promoteId"])),this._options=t.e({type:"vector"},h),this._collectResourceTiming=h.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(w)}load(){return t._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new t.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{let r=yield va(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),r&&(t.e(this,r),r.bounds&&(this.tileBounds=new Cl(r.bounds,this.minzoom,this.maxzoom)),this.fire(new t.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new t.l("data",{dataType:"source",sourceDataType:"content"})))}catch(r){this._tileJSONRequest=null,this.fire(new t.k(r))}})}loaded(){return this._loaded}hasTile(r){return!this.tileBounds||this.tileBounds.contains(r.canonical)}onAdd(r){this.map=r,this.load()}setSourceProperty(r){this._tileJSONRequest&&this._tileJSONRequest.abort(),r(),this.load()}setTiles(r){return this.setSourceProperty(()=>{this._options.tiles=r}),this}setUrl(r){return this.setSourceProperty(()=>{this.url=r,this._options.url=r}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return t.e({},this._options)}loadTile(r){return t._(this,void 0,void 0,function*(){let h=r.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),x={request:this.map._requestManager.transformRequest(h,"Tile"),uid:r.uid,tileID:r.tileID,zoom:r.tileID.overscaledZ,tileSize:this.tileSize*r.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity,globalState:this.map.getGlobalState()};x.request.collectResourceTiming=this._collectResourceTiming;let w="RT";if(r.actor&&r.state!=="expired"){if(r.state==="loading")return new Promise((A,k)=>{r.reloadPromise={resolve:A,reject:k}})}else r.actor=this.dispatcher.getActor(),w="LT";r.abortController=new AbortController;try{let A=yield r.actor.sendAsync({type:w,data:x},r.abortController);if(delete r.abortController,r.aborted)return;this._afterTileLoadWorkerResponse(r,A)}catch(A){if(delete r.abortController,r.aborted)return;if(A&&A.status!==404)throw A;this._afterTileLoadWorkerResponse(r,null)}})}_afterTileLoadWorkerResponse(r,h){if(h&&h.resourceTiming&&(r.resourceTiming=h.resourceTiming),h&&this.map._refreshExpiredTiles&&r.setExpiryData(h),r.loadVectorData(h,this.map.painter),r.reloadPromise){let x=r.reloadPromise;r.reloadPromise=null,this.loadTile(r).then(x.resolve).catch(x.reject)}}abortTile(r){return t._(this,void 0,void 0,function*(){r.abortController&&(r.abortController.abort(),delete r.abortController),r.actor&&(yield r.actor.sendAsync({type:"AT",data:{uid:r.uid,type:this.type,source:this.id}}))})}unloadTile(r){return t._(this,void 0,void 0,function*(){r.unloadVectorData(),r.actor&&(yield r.actor.sendAsync({type:"RMT",data:{uid:r.uid,type:this.type,source:this.id}}))})}hasTransition(){return!1}}class Cs extends t.E{constructor(r,h,x,w){super(),this.id=r,this.dispatcher=x,this.setEventedParent(w),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=t.e({type:"raster"},h),t.e(this,t.Q(h,["url","scheme","tileSize"]))}load(){return t._(this,arguments,void 0,function*(r=!1){this._loaded=!1,this.fire(new t.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{let h=yield va(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,h&&(t.e(this,h),h.bounds&&(this.tileBounds=new Cl(h.bounds,this.minzoom,this.maxzoom)),this.fire(new t.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new t.l("data",{dataType:"source",sourceDataType:"content",sourceDataChanged:r})))}catch(h){this._tileJSONRequest=null,this.fire(new t.k(h))}})}loaded(){return this._loaded}onAdd(r){this.map=r,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(r){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),r(),this.load(!0)}setTiles(r){return this.setSourceProperty(()=>{this._options.tiles=r}),this}setUrl(r){return this.setSourceProperty(()=>{this.url=r,this._options.url=r}),this}serialize(){return t.e({},this._options)}hasTile(r){return!this.tileBounds||this.tileBounds.contains(r.canonical)}loadTile(r){return t._(this,void 0,void 0,function*(){let h=r.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);r.abortController=new AbortController;try{let x=yield qo.getImage(this.map._requestManager.transformRequest(h,"Tile"),r.abortController,this.map._refreshExpiredTiles);if(delete r.abortController,r.aborted)return void(r.state="unloaded");if(x&&x.data){this.map._refreshExpiredTiles&&(x.cacheControl||x.expires)&&r.setExpiryData({cacheControl:x.cacheControl,expires:x.expires});let w=this.map.painter.context,A=w.gl,k=x.data;r.texture=this.map.painter.getTileTexture(k.width),r.texture?r.texture.update(k,{useMipmap:!0}):(r.texture=new t.T(w,k,A.RGBA,{useMipmap:!0}),r.texture.bind(A.LINEAR,A.CLAMP_TO_EDGE,A.LINEAR_MIPMAP_NEAREST)),r.state="loaded"}}catch(x){if(delete r.abortController,r.aborted)r.state="unloaded";else if(x)throw r.state="errored",x}})}abortTile(r){return t._(this,void 0,void 0,function*(){r.abortController&&(r.abortController.abort(),delete r.abortController)})}unloadTile(r){return t._(this,void 0,void 0,function*(){r.texture&&this.map.painter.saveTileTexture(r.texture)})}hasTransition(){return!1}}class Jo extends Cs{constructor(r,h,x,w){super(r,h,x,w),this.type="raster-dem",this.maxzoom=22,this._options=t.e({type:"raster-dem"},h),this.encoding=h.encoding||"mapbox",this.redFactor=h.redFactor,this.greenFactor=h.greenFactor,this.blueFactor=h.blueFactor,this.baseShift=h.baseShift}loadTile(r){return t._(this,void 0,void 0,function*(){let h=r.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),x=this.map._requestManager.transformRequest(h,"Tile");r.neighboringTiles=this._getNeighboringTiles(r.tileID),r.abortController=new AbortController;try{let w=yield qo.getImage(x,r.abortController,this.map._refreshExpiredTiles);if(delete r.abortController,r.aborted)return void(r.state="unloaded");if(w&&w.data){let A=w.data;this.map._refreshExpiredTiles&&(w.cacheControl||w.expires)&&r.setExpiryData({cacheControl:w.cacheControl,expires:w.expires});let k=t.b(A)&&t.W()?A:yield this.readImageNow(A),j={type:this.type,uid:r.uid,source:this.id,rawImageData:k,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!r.actor||r.state==="expired"){r.actor=this.dispatcher.getActor();let q=yield r.actor.sendAsync({type:"LDT",data:j});r.dem=q,r.needsHillshadePrepare=!0,r.needsTerrainPrepare=!0,r.state="loaded"}}}catch(w){if(delete r.abortController,r.aborted)r.state="unloaded";else if(w)throw r.state="errored",w}})}readImageNow(r){return t._(this,void 0,void 0,function*(){if(typeof VideoFrame<"u"&&t.X()){let h=r.width+2,x=r.height+2;try{return new t.R({width:h,height:x},yield t.Y(r,-1,-1,h,x))}catch{}}return an.getImageData(r,1)})}_getNeighboringTiles(r){let h=r.canonical,x=Math.pow(2,h.z),w=(h.x-1+x)%x,A=h.x===0?r.wrap-1:r.wrap,k=(h.x+1+x)%x,j=h.x+1===x?r.wrap+1:r.wrap,q={};return q[new t.Z(r.overscaledZ,A,h.z,w,h.y).key]={backfilled:!1},q[new t.Z(r.overscaledZ,j,h.z,k,h.y).key]={backfilled:!1},h.y>0&&(q[new t.Z(r.overscaledZ,A,h.z,w,h.y-1).key]={backfilled:!1},q[new t.Z(r.overscaledZ,r.wrap,h.z,h.x,h.y-1).key]={backfilled:!1},q[new t.Z(r.overscaledZ,j,h.z,k,h.y-1).key]={backfilled:!1}),h.y+1<x&&(q[new t.Z(r.overscaledZ,A,h.z,w,h.y+1).key]={backfilled:!1},q[new t.Z(r.overscaledZ,r.wrap,h.z,h.x,h.y+1).key]={backfilled:!1},q[new t.Z(r.overscaledZ,j,h.z,k,h.y+1).key]={backfilled:!1}),q}unloadTile(r){return t._(this,void 0,void 0,function*(){r.demTexture&&this.map.painter.saveTileTexture(r.demTexture),r.fbo&&(r.fbo.destroy(),delete r.fbo),r.dem&&delete r.dem,delete r.neighboringTiles,r.state="unloaded",r.actor&&(yield r.actor.sendAsync({type:"RDT",data:{type:this.type,uid:r.uid,source:this.id}}))})}}class Fs extends t.E{constructor(r,h,x,w){super(),this.id=r,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=x.getActor(),this.setEventedParent(w),this._data=h.data,this._options=t.e({},h),this._collectResourceTiming=h.collectResourceTiming,h.maxzoom!==void 0&&(this.maxzoom=h.maxzoom),h.type&&(this.type=h.type),h.attribution&&(this.attribution=h.attribution),this.promoteId=h.promoteId,h.clusterMaxZoom!==void 0&&this.maxzoom<=h.clusterMaxZoom&&t.w(`The maxzoom value "${this.maxzoom}" is expected to be greater than the clusterMaxZoom value "${h.clusterMaxZoom}".`),this.workerOptions=t.e({source:this.id,cluster:h.cluster||!1,geojsonVtOptions:{buffer:this._pixelsToTileUnits(h.buffer!==void 0?h.buffer:128),tolerance:this._pixelsToTileUnits(h.tolerance!==void 0?h.tolerance:.375),extent:t.$,maxZoom:this.maxzoom,lineMetrics:h.lineMetrics||!1,generateId:h.generateId||!1},superclusterOptions:{maxZoom:this._getClusterMaxZoom(h.clusterMaxZoom),minPoints:Math.max(2,h.clusterMinPoints||2),extent:t.$,radius:this._pixelsToTileUnits(h.clusterRadius||50),log:!1,generateId:h.generateId||!1},clusterProperties:h.clusterProperties,filter:h.filter},h.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}_pixelsToTileUnits(r){return r*(t.$/this.tileSize)}_getClusterMaxZoom(r){let h=r?Math.round(r):this.maxzoom-1;return Number.isInteger(r)||r===void 0||t.w(`Integer expected for option 'clusterMaxZoom': provided value "${r}" rounded to "${h}"`),h}load(){return t._(this,void 0,void 0,function*(){yield this._updateWorkerData()})}onAdd(r){this.map=r,this.load()}setData(r){return this._data=r,this._updateWorkerData(),this}updateData(r){return this._updateWorkerData(r),this}getData(){return t._(this,void 0,void 0,function*(){let r=t.e({type:this.type},this.workerOptions);return this.actor.sendAsync({type:"GD",data:r})})}getCoordinatesFromGeometry(r){return r.type==="GeometryCollection"?r.geometries.map(h=>h.coordinates).flat(1/0):r.coordinates.flat(1/0)}getBounds(){return t._(this,void 0,void 0,function*(){let r=new hr,h=yield this.getData(),x;switch(h.type){case"FeatureCollection":x=h.features.map(w=>this.getCoordinatesFromGeometry(w.geometry)).flat(1/0);break;case"Feature":x=this.getCoordinatesFromGeometry(h.geometry);break;default:x=this.getCoordinatesFromGeometry(h)}if(x.length==0)return r;for(let w=0;w<x.length-1;w+=2)r.extend([x[w],x[w+1]]);return r})}setClusterOptions(r){return this.workerOptions.cluster=r.cluster,r&&(r.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=this._pixelsToTileUnits(r.clusterRadius)),r.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=this._getClusterMaxZoom(r.clusterMaxZoom))),this._updateWorkerData(),this}getClusterExpansionZoom(r){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:r,source:this.id}})}getClusterChildren(r){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:r,source:this.id}})}getClusterLeaves(r,h,x){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:r,limit:h,offset:x}})}_updateWorkerData(r){return t._(this,void 0,void 0,function*(){let h=t.e({type:this.type},this.workerOptions);r?h.dataDiff=r:typeof this._data=="string"?(h.request=this.map._requestManager.transformRequest(an.resolveURL(this._data),"Source"),h.request.collectResourceTiming=this._collectResourceTiming):h.data=JSON.stringify(this._data),this._pendingLoads++,this.fire(new t.l("dataloading",{dataType:"source"}));try{let x=yield this.actor.sendAsync({type:"LD",data:h});if(this._pendingLoads--,this._removed||x.abandoned)return void this.fire(new t.l("dataabort",{dataType:"source"}));let w=null;x.resourceTiming&&x.resourceTiming[this.id]&&(w=x.resourceTiming[this.id].slice(0));let A={dataType:"source"};this._collectResourceTiming&&w&&w.length>0&&t.e(A,{resourceTiming:w}),this.fire(new t.l("data",Object.assign(Object.assign({},A),{sourceDataType:"metadata"}))),this.fire(new t.l("data",Object.assign(Object.assign({},A),{sourceDataType:"content"})))}catch(x){if(this._pendingLoads--,this._removed)return void this.fire(new t.l("dataabort",{dataType:"source"}));this.fire(new t.k(x))}})}loaded(){return this._pendingLoads===0}loadTile(r){return t._(this,void 0,void 0,function*(){let h=r.actor?"RT":"LT";r.actor=this.actor;let x={type:this.type,uid:r.uid,tileID:r.tileID,zoom:r.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity,globalState:this.map.getGlobalState()};r.abortController=new AbortController;let w=yield this.actor.sendAsync({type:h,data:x},r.abortController);delete r.abortController,r.unloadVectorData(),r.aborted||r.loadVectorData(w,this.map.painter,h==="RT")})}abortTile(r){return t._(this,void 0,void 0,function*(){r.abortController&&(r.abortController.abort(),delete r.abortController),r.aborted=!0})}unloadTile(r){return t._(this,void 0,void 0,function*(){r.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:r.uid,type:this.type,source:this.id}})})}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return t.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}class Vo extends t.E{constructor(r,h,x,w){super(),this.flippedWindingOrder=!1,this.id=r,this.dispatcher=x,this.coordinates=h.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(w),this.options=h}load(r){return t._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new t.l("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{let h=yield qo.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,h&&h.data&&(this.image=h.data,r&&(this.coordinates=r),this._finishLoading())}catch(h){this._request=null,this._loaded=!0,this.fire(new t.k(h))}})}loaded(){return this._loaded}updateImage(r){return r.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=r.url,this.load(r.coordinates).finally(()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new t.l("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(r){this.map=r,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(r){this.coordinates=r;let h=r.map(t.a0.fromLngLat);var x;return this.tileID=function(w){let A=t.a1.fromPoints(w),k=A.width(),j=A.height(),q=Math.max(k,j),J=Math.max(0,Math.floor(-Math.log(q)/Math.LN2)),ne=Math.pow(2,J);return new t.a3(J,Math.floor((A.minX+A.maxX)/2*ne),Math.floor((A.minY+A.maxY)/2*ne))}(h),this.terrainTileRanges=this._getOverlappingTileRanges(h),this.minzoom=this.maxzoom=this.tileID.z,this.tileCoords=h.map(w=>this.tileID.getTilePoint(w)._round()),this.flippedWindingOrder=((x=this.tileCoords)[1].x-x[0].x)*(x[2].y-x[0].y)-(x[1].y-x[0].y)*(x[2].x-x[0].x)<0,this.fire(new t.l("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;let r=this.map.painter.context,h=r.gl;this.texture||(this.texture=new t.T(r,this.image,h.RGBA),this.texture.bind(h.LINEAR,h.CLAMP_TO_EDGE));let x=!1;for(let w in this.tiles){let A=this.tiles[w];A.state!=="loaded"&&(A.state="loaded",A.texture=this.texture,x=!0)}x&&this.fire(new t.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(r){return t._(this,void 0,void 0,function*(){this.tileID&&this.tileID.equals(r.tileID.canonical)?(this.tiles[String(r.tileID.wrap)]=r,r.buckets={}):r.state="errored"})}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}_getOverlappingTileRanges(r){let{minX:h,minY:x,maxX:w,maxY:A}=t.a1.fromPoints(r),k={};for(let j=0;j<=t.a2;j++){let q=Math.pow(2,j),J=Math.floor(h*q),ne=Math.floor(x*q),pe=Math.floor(w*q),ue=Math.floor(A*q);k[j]={minTileX:J,minTileY:ne,maxTileX:pe,maxTileY:ue}}return k}}class ba extends Vo{constructor(r,h,x,w){super(r,h,x,w),this.roundZoom=!0,this.type="video",this.options=h}load(){return t._(this,void 0,void 0,function*(){this._loaded=!1;let r=this.options;this.urls=[];for(let h of r.urls)this.urls.push(this.map._requestManager.transformRequest(h,"Source").url);try{let h=yield t.a4(this.urls);if(this._loaded=!0,!h)return;this.video=h,this.video.loop=!0,this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading()}catch(h){this.fire(new t.k(h))}})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(r){if(this.video){let h=this.video.seekable;r<h.start(0)||r>h.end(0)?this.fire(new t.k(new t.a5(`sources.${this.id}`,null,`Playback for this video can be set only between the ${h.start(0)} and ${h.end(0)}-second mark.`))):this.video.currentTime=r}}getVideo(){return this.video}onAdd(r){this.map||(this.map=r,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;let r=this.map.painter.context,h=r.gl;this.texture?this.video.paused||(this.texture.bind(h.LINEAR,h.CLAMP_TO_EDGE),h.texSubImage2D(h.TEXTURE_2D,0,0,0,h.RGBA,h.UNSIGNED_BYTE,this.video)):(this.texture=new t.T(r,this.video,h.RGBA),this.texture.bind(h.LINEAR,h.CLAMP_TO_EDGE));let x=!1;for(let w in this.tiles){let A=this.tiles[w];A.state!=="loaded"&&(A.state="loaded",A.texture=this.texture,x=!0)}x&&this.fire(new t.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class Wa extends Vo{constructor(r,h,x,w){super(r,h,x,w),h.coordinates?Array.isArray(h.coordinates)&&h.coordinates.length===4&&!h.coordinates.some(A=>!Array.isArray(A)||A.length!==2||A.some(k=>typeof k!="number"))||this.fire(new t.k(new t.a5(`sources.${r}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new t.k(new t.a5(`sources.${r}`,null,'missing required property "coordinates"'))),h.animate&&typeof h.animate!="boolean"&&this.fire(new t.k(new t.a5(`sources.${r}`,null,'optional "animate" property must be a boolean value'))),h.canvas?typeof h.canvas=="string"||h.canvas instanceof HTMLCanvasElement||this.fire(new t.k(new t.a5(`sources.${r}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new t.k(new t.a5(`sources.${r}`,null,'missing required property "canvas"'))),this.options=h,this.animate=h.animate===void 0||h.animate}load(){return t._(this,void 0,void 0,function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new t.k(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())})}getCanvas(){return this.canvas}onAdd(r){this.map=r,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let r=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,r=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,r=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;let h=this.map.painter.context,x=h.gl;this.texture?(r||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new t.T(h,this.canvas,x.RGBA,{premultiply:!0});let w=!1;for(let A in this.tiles){let k=this.tiles[A];k.state!=="loaded"&&(k.state="loaded",k.texture=this.texture,w=!0)}w&&this.fire(new t.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(let r of[this.canvas.width,this.canvas.height])if(isNaN(r)||r<=0)return!0;return!1}}let pl={},fl=M=>{switch(M){case"geojson":return Fs;case"image":return Vo;case"raster":return Cs;case"raster-dem":return Jo;case"vector":return ra;case"video":return ba;case"canvas":return Wa}return pl[M]},fs="RTLPluginLoaded";class Ws extends t.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=Co()}_syncState(r){return this.status=r,this.dispatcher.broadcast("SRPS",{pluginStatus:r,pluginURL:this.url}).catch(h=>{throw this.status="error",h})}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(r){return t._(this,arguments,void 0,function*(h,x=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=an.resolveURL(h),!this.url)throw new Error(`requested url ${h} is invalid`);if(this.status==="unavailable"){if(!x)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()})}_requestImport(){return t._(this,void 0,void 0,function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new t.l(fs))})}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let ml=null;function Hs(){return ml||(ml=new Ws),ml}class Ha{constructor(r,h){this.timeAdded=0,this.fadeEndTime=0,this.tileID=r,this.uid=t.a6(),this.uses=0,this.tileSize=h,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(r){let h=r+this.timeAdded;h<this.fadeEndTime||(this.fadeEndTime=h)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(r){this.demTexture&&r.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(r,h,x){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",r){r.featureIndex&&(this.latestFeatureIndex=r.featureIndex,r.rawTileData?(this.latestRawTileData=r.rawTileData,this.latestFeatureIndex.rawTileData=r.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=r.collisionBoxArray,this.buckets=function(w,A){let k={};if(!A)return k;for(let j of w){let q=j.layerIds.map(J=>A.getLayer(J)).filter(Boolean);if(q.length!==0){j.layers=q,j.stateDependentLayerIds&&(j.stateDependentLayers=j.stateDependentLayerIds.map(J=>q.filter(ne=>ne.id===J)[0]));for(let J of q)k[J.id]=j}}return k}(r.buckets,h?.style),this.hasSymbolBuckets=!1;for(let w in this.buckets){let A=this.buckets[w];if(A instanceof t.a8){if(this.hasSymbolBuckets=!0,!x)break;A.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(let w in this.buckets){let A=this.buckets[w];if(A instanceof t.a8&&A.hasRTLText){this.hasRTLText=!0,Hs().lazyLoad();break}}this.queryPadding=0;for(let w in this.buckets){let A=this.buckets[w];this.queryPadding=Math.max(this.queryPadding,h.style.getLayer(w).queryRadius(A))}r.imageAtlas&&(this.imageAtlas=r.imageAtlas),r.glyphAtlasImage&&(this.glyphAtlasImage=r.glyphAtlasImage)}else this.collisionBoxArray=new t.a7}unloadVectorData(){for(let r in this.buckets)this.buckets[r].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(r){return this.buckets[r.id]}upload(r){for(let x in this.buckets){let w=this.buckets[x];w.uploadPending()&&w.upload(r)}let h=r.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new t.T(r,this.imageAtlas.image,h.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new t.T(r,this.glyphAtlasImage,h.ALPHA),this.glyphAtlasImage=null)}prepare(r){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(r,this.imageAtlasTexture)}queryRenderedFeatures(r,h,x,w,A,k,j,q,J,ne,pe){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:w,cameraQueryGeometry:A,scale:k,tileSize:this.tileSize,pixelPosMatrix:ne,transform:q,params:j,queryPadding:this.queryPadding*J,getElevation:pe},r,h,x):{}}querySourceFeatures(r,h){let x=this.latestFeatureIndex;if(!x||!x.rawTileData)return;let w=x.loadVTLayers(),A=h&&h.sourceLayer?h.sourceLayer:"",k=w._geojsonTileLayer||w[A];if(!k)return;let j=t.a9(h&&h.filter),{z:q,x:J,y:ne}=this.tileID.canonical,pe={z:q,x:J,y:ne};for(let ue=0;ue<k.length;ue++){let ge=k.feature(ue);if(j.needGeometry){let Xe=t.aa(ge,!0);if(!j.filter(new t.F(this.tileID.overscaledZ),Xe,this.tileID.canonical))continue}else if(!j.filter(new t.F(this.tileID.overscaledZ),ge))continue;let Ee=x.getId(ge,A),tt=new t.ab(ge,q,J,ne,Ee);tt.tile=pe,r.push(tt)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(r){let h=this.expirationTime;if(r.cacheControl){let x=t.ac(r.cacheControl);x["max-age"]&&(this.expirationTime=Date.now()+1e3*x["max-age"])}else r.expires&&(this.expirationTime=new Date(r.expires).getTime());if(this.expirationTime){let x=Date.now(),w=!1;if(this.expirationTime>x)w=!1;else if(h)if(this.expirationTime<h)w=!0;else{let A=this.expirationTime-h;A?this.expirationTime=x+Math.max(A,3e4):w=!0}else w=!0;w?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(r,h){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(r).length===0)return;let x=this.latestFeatureIndex.loadVTLayers();for(let w in this.buckets){if(!h.style.hasLayer(w))continue;let A=this.buckets[w],k=A.layers[0].sourceLayer||"_geojsonTileLayer",j=x[k],q=r[k];if(!j||!q||Object.keys(q).length===0)continue;A.update(q,j,this.imageAtlas&&this.imageAtlas.patternPositions||{});let J=h&&h.style&&h.style.getLayer(w);J&&(this.queryPadding=Math.max(this.queryPadding,J.queryRadius(A)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<an.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(r){this.symbolFadeHoldUntil=an.now()+r}setDependencies(r,h){let x={};for(let w of h)x[w]=!0;this.dependencies[r]=x}hasDependency(r,h){for(let x of r){let w=this.dependencies[x];if(w){for(let A of h)if(w[A])return!0}}return!1}}class sl{constructor(r,h){this.max=r,this.onRemove=h,this.reset()}reset(){for(let r in this.data)for(let h of this.data[r])h.timeout&&clearTimeout(h.timeout),this.onRemove(h.value);return this.data={},this.order=[],this}add(r,h,x){let w=r.wrapped().key;this.data[w]===void 0&&(this.data[w]=[]);let A={value:h,timeout:void 0};if(x!==void 0&&(A.timeout=setTimeout(()=>{this.remove(r,A)},x)),this.data[w].push(A),this.order.push(w),this.order.length>this.max){let k=this._getAndRemoveByKey(this.order[0]);k&&this.onRemove(k)}return this}has(r){return r.wrapped().key in this.data}getAndRemove(r){return this.has(r)?this._getAndRemoveByKey(r.wrapped().key):null}_getAndRemoveByKey(r){let h=this.data[r].shift();return h.timeout&&clearTimeout(h.timeout),this.data[r].length===0&&delete this.data[r],this.order.splice(this.order.indexOf(r),1),h.value}getByKey(r){let h=this.data[r];return h?h[0].value:null}get(r){return this.has(r)?this.data[r.wrapped().key][0].value:null}remove(r,h){if(!this.has(r))return this;let x=r.wrapped().key,w=h===void 0?0:this.data[x].indexOf(h),A=this.data[x][w];return this.data[x].splice(w,1),A.timeout&&clearTimeout(A.timeout),this.data[x].length===0&&delete this.data[x],this.onRemove(A.value),this.order.splice(this.order.indexOf(x),1),this}setMaxSize(r){for(this.max=r;this.order.length>this.max;){let h=this._getAndRemoveByKey(this.order[0]);h&&this.onRemove(h)}return this}filter(r){let h=[];for(let x in this.data)for(let w of this.data[x])r(w.value)||h.push(w);for(let x of h)this.remove(x.value.tileID,x)}}class El{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(r,h,x){let w=String(h);if(this.stateChanges[r]=this.stateChanges[r]||{},this.stateChanges[r][w]=this.stateChanges[r][w]||{},t.e(this.stateChanges[r][w],x),this.deletedStates[r]===null){this.deletedStates[r]={};for(let A in this.state[r])A!==w&&(this.deletedStates[r][A]=null)}else if(this.deletedStates[r]&&this.deletedStates[r][w]===null){this.deletedStates[r][w]={};for(let A in this.state[r][w])x[A]||(this.deletedStates[r][w][A]=null)}else for(let A in x)this.deletedStates[r]&&this.deletedStates[r][w]&&this.deletedStates[r][w][A]===null&&delete this.deletedStates[r][w][A]}removeFeatureState(r,h,x){if(this.deletedStates[r]===null)return;let w=String(h);if(this.deletedStates[r]=this.deletedStates[r]||{},x&&h!==void 0)this.deletedStates[r][w]!==null&&(this.deletedStates[r][w]=this.deletedStates[r][w]||{},this.deletedStates[r][w][x]=null);else if(h!==void 0)if(this.stateChanges[r]&&this.stateChanges[r][w])for(x in this.deletedStates[r][w]={},this.stateChanges[r][w])this.deletedStates[r][w][x]=null;else this.deletedStates[r][w]=null;else this.deletedStates[r]=null}getState(r,h){let x=String(h),w=t.e({},(this.state[r]||{})[x],(this.stateChanges[r]||{})[x]);if(this.deletedStates[r]===null)return{};if(this.deletedStates[r]){let A=this.deletedStates[r][h];if(A===null)return{};for(let k in A)delete w[k]}return w}initializeTileState(r,h){r.setFeatureState(this.state,h)}coalesceChanges(r,h){let x={};for(let w in this.stateChanges){this.state[w]=this.state[w]||{};let A={};for(let k in this.stateChanges[w])this.state[w][k]||(this.state[w][k]={}),t.e(this.state[w][k],this.stateChanges[w][k]),A[k]=this.state[w][k];x[w]=A}for(let w in this.deletedStates){this.state[w]=this.state[w]||{};let A={};if(this.deletedStates[w]===null)for(let k in this.state[w])A[k]={},this.state[w][k]={};else for(let k in this.deletedStates[w]){if(this.deletedStates[w][k]===null)this.state[w][k]={};else for(let j of Object.keys(this.deletedStates[w][k]))delete this.state[w][k][j];A[k]=this.state[w][k]}x[w]=x[w]||{},t.e(x[w],A)}if(this.stateChanges={},this.deletedStates={},Object.keys(x).length!==0)for(let w in r)r[w].setFeatureState(x,h)}}let ms=89.25;function Vt(M,r){let h=t.ag(r.lat,-85.051129,t.ah);return new t.P(t.V(r.lng)*M,t.U(h)*M)}function Le(M,r){return new t.a0(r.x/M,r.y/M).toLngLat()}function Fe(M){return M.cameraToCenterDistance*Math.min(.85*Math.tan(t.ad(90-M.pitch)),Math.tan(t.ad(ms-M.pitch)))}function He(M,r){let h=M.canonical,x=r/t.ae(h.z),w=h.x+Math.pow(2,h.z)*M.wrap,A=t.af(new Float64Array(16));return t.M(A,A,[w*x,h.y*x,0]),t.N(A,A,[x/t.$,x/t.$,1]),A}function mt(M,r,h,x,w){let A=t.a0.fromLngLat(M,r),k=w*t.ai(1,M.lat),j=k*Math.cos(t.ad(h)),q=Math.sqrt(k*k-j*j),J=q*Math.sin(t.ad(-x)),ne=q*Math.cos(t.ad(-x));return new t.a0(A.x+J,A.y+ne,A.z+j)}function St(M,r,h){let x=r.intersectsFrustum(M);if(!h||x===0)return x;let w=r.intersectsPlane(h);return w===0?0:x===2&&w===2?2:1}function Tt(M,r,h){let x=0,w=(h-r)/10;for(let A=0;A<10;A++)x+=w*Math.pow(Math.cos(r+(A+.5)/10*(h-r)),M);return x}function Xt(M,r){return function(h,x,w,A,k){let j=2*((M-1)/t.aj(Math.cos(t.ad(ms-k))/Math.cos(t.ad(ms)))-1),q=Math.acos(w/A),J=2*Tt(j-1,0,t.ad(k/2)),ne=Math.min(t.ad(ms),q+t.ad(k/2)),pe=Tt(j-1,Math.min(ne,q-t.ad(k/2)),ne),ue=Math.atan(x/w),ge=Math.hypot(x,w),Ee=h;return Ee+=t.aj(A/ge/Math.max(.5,Math.cos(t.ad(k/2)))),Ee+=j*t.aj(Math.cos(ue))/2,Ee-=t.aj(Math.max(1,pe/J/r))/2,Ee}}let Lt=Xt(9.314,3);function di(M,r){let h=(r.roundZoom?Math.round:Math.floor)(M.zoom+t.aj(M.tileSize/r.tileSize));return Math.max(0,h)}function li(M,r){let h=M.getCameraFrustum(),x=M.getClippingPlane(),w=M.screenPointToMercatorCoordinate(M.getCameraPoint()),A=t.a0.fromLngLat(M.center,M.elevation);w.z=A.z+Math.cos(M.pitchInRadians)*M.cameraToCenterDistance/M.worldSize;let k=M.getCoveringTilesDetailsProvider(),j=k.allowVariableZoom(M,r),q=di(M,r),J=r.minzoom||0,ne=r.maxzoom!==void 0?r.maxzoom:M.maxZoom,pe=Math.min(Math.max(0,q),ne),ue=Math.pow(2,pe),ge=[ue*w.x,ue*w.y,0],Ee=[ue*A.x,ue*A.y,0],tt=Math.hypot(A.x-w.x,A.y-w.y),Xe=Math.abs(A.z-w.z),et=Math.hypot(tt,Xe),Se=dt=>({zoom:0,x:0,y:0,wrap:dt,fullyVisible:!1}),Be=[],ft=[];if(M.renderWorldCopies&&k.allowWorldCopies())for(let dt=1;dt<=3;dt++)Be.push(Se(-dt)),Be.push(Se(dt));for(Be.push(Se(0));Be.length>0;){let dt=Be.pop(),xe=dt.x,pt=dt.y,zt=dt.fullyVisible,ei={x:xe,y:pt,z:dt.zoom},Kt=k.getTileBoundingVolume(ei,dt.wrap,M.elevation,r);if(!zt){let Ki=St(h,Kt,x);if(Ki===0)continue;zt=Ki===2}let Jt=k.distanceToTile2d(w.x,w.y,ei,Kt),si=q;j&&(si=(r.calculateTileZoom||Lt)(M.zoom+t.aj(M.tileSize/r.tileSize),Jt,Xe,et,M.fov)),si=(r.roundZoom?Math.round:Math.floor)(si),si=Math.max(0,si);let Xi=Math.min(si,ne);if(dt.wrap=k.getWrap(A,ei,dt.wrap),dt.zoom>=Xi){if(dt.zoom<J)continue;let Ki=pe-dt.zoom,Pi=ge[0]-.5-(xe<<Ki),yn=ge[1]-.5-(pt<<Ki),xr=r.reparseOverscaled?Math.max(dt.zoom,si):dt.zoom;ft.push({tileID:new t.Z(dt.zoom===ne?xr:dt.zoom,dt.wrap,dt.zoom,xe,pt),distanceSq:t.ak([Ee[0]-.5-xe,Ee[1]-.5-pt]),tileDistanceToCamera:Math.sqrt(Pi*Pi+yn*yn)})}else for(let Ki=0;Ki<4;Ki++)Be.push({zoom:dt.zoom+1,x:(xe<<1)+Ki%2,y:(pt<<1)+(Ki>>1),wrap:dt.wrap,fullyVisible:zt})}return ft.sort((dt,xe)=>dt.distanceSq-xe.distanceSq).map(dt=>dt.tileID)}let Zt=t.a1.fromPoints([new t.P(0,0),new t.P(t.$,t.$)]);class wi extends t.E{constructor(r,h,x){super(),this.id=r,this.dispatcher=x,this.on("data",w=>this._dataHandler(w)),this.on("dataloading",()=>{this._sourceErrored=!1}),this.on("error",()=>{this._sourceErrored=this._source.loaded()}),this._source=((w,A,k,j)=>{let q=new(fl(A.type))(w,A,k,j);if(q.id!==w)throw new Error(`Expected Source id to be ${w} instead of ${q.id}`);return q})(r,h,x,this),this._tiles={},this._cache=new sl(0,w=>this._unloadTile(w)),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new El,this._didEmitContent=!1,this._updated=!1}onAdd(r){this.map=r,this._maxTileCacheSize=r?r._maxTileCacheSize:null,this._maxTileCacheZoomLevels=r?r._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(r)}onRemove(r){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(r)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(let r in this._tiles){let h=this._tiles[r];if(h.state!=="loaded"&&h.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;let r=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,r&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(r,h,x){return t._(this,void 0,void 0,function*(){try{yield this._source.loadTile(r),this._tileLoaded(r,h,x)}catch(w){r.state="errored",w.status!==404?this._source.fire(new t.k(w,{tile:r})):this.update(this.transform,this.terrain)}})}_unloadTile(r){this._source.unloadTile&&this._source.unloadTile(r)}_abortTile(r){this._source.abortTile&&this._source.abortTile(r),this._source.fire(new t.l("dataabort",{tile:r,coord:r.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(r){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(let h in this._tiles){let x=this._tiles[h];x.upload(r),x.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map(r=>r.tileID).sort(Ue).map(r=>r.key)}getRenderableIds(r){let h=[];for(let x in this._tiles)this._isIdRenderable(x,r)&&h.push(this._tiles[x]);return r?h.sort((x,w)=>{let A=x.tileID,k=w.tileID,j=new t.P(A.canonical.x,A.canonical.y)._rotate(-this.transform.bearingInRadians),q=new t.P(k.canonical.x,k.canonical.y)._rotate(-this.transform.bearingInRadians);return A.overscaledZ-k.overscaledZ||q.y-j.y||q.x-j.x}).map(x=>x.tileID.key):h.map(x=>x.tileID).sort(Ue).map(x=>x.key)}hasRenderableParent(r){let h=this.findLoadedParent(r,0);return!!h&&this._isIdRenderable(h.tileID.key)}_isIdRenderable(r,h){return this._tiles[r]&&this._tiles[r].hasData()&&!this._coveredTiles[r]&&(h||!this._tiles[r].holdingForFade())}reload(r){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(let h in this._tiles)r?this._reloadTile(h,"expired"):this._tiles[h].state!=="errored"&&this._reloadTile(h,"reloading")}}_reloadTile(r,h){return t._(this,void 0,void 0,function*(){let x=this._tiles[r];x&&(x.state!=="loading"&&(x.state=h),yield this._loadTile(x,r,h))})}_tileLoaded(r,h,x){r.timeAdded=an.now(),x==="expired"&&(r.refreshedUponExpiration=!0),this._setTileReloadTimer(h,r),this.getSource().type==="raster-dem"&&r.dem&&this._backfillDEM(r),this._state.initializeTileState(r,this.map?this.map.painter:null),r.aborted||this._source.fire(new t.l("data",{dataType:"source",tile:r,coord:r.tileID}))}_backfillDEM(r){let h=this.getRenderableIds();for(let w=0;w<h.length;w++){let A=h[w];if(r.neighboringTiles&&r.neighboringTiles[A]){let k=this.getTileByID(A);x(r,k),x(k,r)}}function x(w,A){w.needsHillshadePrepare=!0,w.needsTerrainPrepare=!0;let k=A.tileID.canonical.x-w.tileID.canonical.x,j=A.tileID.canonical.y-w.tileID.canonical.y,q=Math.pow(2,w.tileID.canonical.z),J=A.tileID.key;k===0&&j===0||Math.abs(j)>1||(Math.abs(k)>1&&(Math.abs(k+q)===1?k+=q:Math.abs(k-q)===1&&(k-=q)),A.dem&&w.dem&&(w.dem.backfillBorder(A.dem,k,j),w.neighboringTiles&&w.neighboringTiles[J]&&(w.neighboringTiles[J].backfilled=!0)))}}getTile(r){return this.getTileByID(r.key)}getTileByID(r){return this._tiles[r]}_retainLoadedChildren(r,h,x,w){for(let A in this._tiles){let k=this._tiles[A];if(w[A]||!k.hasData()||k.tileID.overscaledZ<=h||k.tileID.overscaledZ>x)continue;let j=k.tileID;for(;k&&k.tileID.overscaledZ>h+1;){let J=k.tileID.scaledTo(k.tileID.overscaledZ-1);k=this._tiles[J.key],k&&k.hasData()&&(j=J)}let q=j;for(;q.overscaledZ>h;)if(q=q.scaledTo(q.overscaledZ-1),r[q.key]||r[q.canonical.key]){w[j.key]=j;break}}}findLoadedParent(r,h){if(r.key in this._loadedParentTiles){let x=this._loadedParentTiles[r.key];return x&&x.tileID.overscaledZ>=h?x:null}for(let x=r.overscaledZ-1;x>=h;x--){let w=r.scaledTo(x),A=this._getLoadedTile(w);if(A)return A}}findLoadedSibling(r){return this._getLoadedTile(r)}_getLoadedTile(r){let h=this._tiles[r.key];return h&&h.hasData()?h:this._cache.getByKey(r.wrapped().key)}updateCacheSize(r){let h=Math.ceil(r.width/this._source.tileSize)+1,x=Math.ceil(r.height/this._source.tileSize)+1,w=Math.floor(h*x*(this._maxTileCacheZoomLevels===null?t.a.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),A=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,w):w;this._cache.setMaxSize(A)}handleWrapJump(r){let h=Math.round((r-(this._prevLng===void 0?r:this._prevLng))/360);if(this._prevLng=r,h){let x={};for(let w in this._tiles){let A=this._tiles[w];A.tileID=A.tileID.unwrapTo(A.tileID.wrap+h),x[A.tileID.key]=A}this._tiles=x;for(let w in this._timers)clearTimeout(this._timers[w]),delete this._timers[w];for(let w in this._tiles)this._setTileReloadTimer(w,this._tiles[w])}}_updateCoveredAndRetainedTiles(r,h,x,w,A,k){let j={},q={},J=Object.keys(r),ne=an.now();for(let pe of J){let ue=r[pe],ge=this._tiles[pe];if(!ge||ge.fadeEndTime!==0&&ge.fadeEndTime<=ne)continue;let Ee=this.findLoadedParent(ue,h),tt=this.findLoadedSibling(ue),Xe=Ee||tt||null;Xe&&(this._addTile(Xe.tileID),j[Xe.tileID.key]=Xe.tileID),q[pe]=ue}this._retainLoadedChildren(q,w,x,r);for(let pe in j)r[pe]||(this._coveredTiles[pe]=!0,r[pe]=j[pe]);if(k){let pe={},ue={};for(let ge of A)this._tiles[ge.key].hasData()?pe[ge.key]=ge:ue[ge.key]=ge;for(let ge in ue){let Ee=ue[ge].children(this._source.maxzoom);this._tiles[Ee[0].key]&&this._tiles[Ee[1].key]&&this._tiles[Ee[2].key]&&this._tiles[Ee[3].key]&&(pe[Ee[0].key]=r[Ee[0].key]=Ee[0],pe[Ee[1].key]=r[Ee[1].key]=Ee[1],pe[Ee[2].key]=r[Ee[2].key]=Ee[2],pe[Ee[3].key]=r[Ee[3].key]=Ee[3],delete ue[ge])}for(let ge in ue){let Ee=ue[ge],tt=this.findLoadedParent(Ee,this._source.minzoom),Xe=this.findLoadedSibling(Ee),et=tt||Xe||null;if(et){pe[et.tileID.key]=r[et.tileID.key]=et.tileID;for(let Se in pe)pe[Se].isChildOf(et.tileID)&&delete pe[Se]}}for(let ge in this._tiles)pe[ge]||(this._coveredTiles[ge]=!0)}}update(r,h){if(!this._sourceLoaded||this._paused)return;let x;this.transform=r,this.terrain=h,this.updateCacheSize(r),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?x=r.getVisibleUnwrappedCoordinates(this._source.tileID).map(ne=>new t.Z(ne.canonical.z,ne.wrap,ne.canonical.z,ne.canonical.x,ne.canonical.y)):(x=li(r,{tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:h,calculateTileZoom:this._source.calculateTileZoom}),this._source.hasTile&&(x=x.filter(ne=>this._source.hasTile(ne)))):x=[];let w=di(r,this._source),A=Math.max(w-wi.maxOverzooming,this._source.minzoom),k=Math.max(w+wi.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){let ne={};for(let pe of x)if(pe.canonical.z>this._source.minzoom){let ue=pe.scaledTo(pe.canonical.z-1);ne[ue.key]=ue;let ge=pe.scaledTo(Math.max(this._source.minzoom,Math.min(pe.canonical.z,5)));ne[ge.key]=ge}x=x.concat(Object.values(ne))}let j=x.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,j&&this.fire(new t.l("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));let q=this._updateRetainedTiles(x,w);Qi(this._source.type)&&this._updateCoveredAndRetainedTiles(q,A,k,w,x,h);for(let ne in q)this._tiles[ne].clearFadeHold();let J=t.al(this._tiles,q);for(let ne of J){let pe=this._tiles[ne];pe.hasSymbolBuckets&&!pe.holdingForFade()?pe.setHoldDuration(this.map._fadeDuration):pe.hasSymbolBuckets&&!pe.symbolFadeFinished()||this._removeTile(ne)}this._updateLoadedParentTileCache(),this._updateLoadedSiblingTileCache()}releaseSymbolFadeTiles(){for(let r in this._tiles)this._tiles[r].holdingForFade()&&this._removeTile(r)}_updateRetainedTiles(r,h){var x;let w={},A={},k=Math.max(h-wi.maxOverzooming,this._source.minzoom),j=Math.max(h+wi.maxUnderzooming,this._source.minzoom),q={};for(let J of r){let ne=this._addTile(J);w[J.key]=J,ne.hasData()||h<this._source.maxzoom&&(q[J.key]=J)}this._retainLoadedChildren(q,h,j,w);for(let J of r){let ne=this._tiles[J.key];if(ne.hasData())continue;if(h+1>this._source.maxzoom){let ue=J.children(this._source.maxzoom)[0],ge=this.getTile(ue);if(ge&&ge.hasData()){w[ue.key]=ue;continue}}else{let ue=J.children(this._source.maxzoom);if(w[ue[0].key]&&w[ue[1].key]&&w[ue[2].key]&&w[ue[3].key])continue}let pe=ne.wasRequested();for(let ue=J.overscaledZ-1;ue>=k;--ue){let ge=J.scaledTo(ue);if(A[ge.key])break;if(A[ge.key]=!0,ne=this.getTile(ge),!ne&&pe&&(ne=this._addTile(ge)),ne){let Ee=ne.hasData();if((Ee||!(!((x=this.map)===null||x===void 0)&&x.cancelPendingTileRequestsWhileZooming)||pe)&&(w[ge.key]=ge),pe=ne.wasRequested(),Ee)break}}}return w}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(let r in this._tiles){let h=[],x,w=this._tiles[r].tileID;for(;w.overscaledZ>0;){if(w.key in this._loadedParentTiles){x=this._loadedParentTiles[w.key];break}h.push(w.key);let A=w.scaledTo(w.overscaledZ-1);if(x=this._getLoadedTile(A),x)break;w=A}for(let A of h)this._loadedParentTiles[A]=x}}_updateLoadedSiblingTileCache(){this._loadedSiblingTiles={};for(let r in this._tiles){let h=this._tiles[r].tileID,x=this._getLoadedTile(h);this._loadedSiblingTiles[h.key]=x}}_addTile(r){let h=this._tiles[r.key];if(h)return h;h=this._cache.getAndRemove(r),h&&(this._setTileReloadTimer(r.key,h),h.tileID=r,this._state.initializeTileState(h,this.map?this.map.painter:null),this._cacheTimers[r.key]&&(clearTimeout(this._cacheTimers[r.key]),delete this._cacheTimers[r.key],this._setTileReloadTimer(r.key,h)));let x=h;return h||(h=new Ha(r,this._source.tileSize*r.overscaleFactor()),this._loadTile(h,r.key,h.state)),h.uses++,this._tiles[r.key]=h,x||this._source.fire(new t.l("dataloading",{tile:h,coord:h.tileID,dataType:"source"})),h}_setTileReloadTimer(r,h){r in this._timers&&(clearTimeout(this._timers[r]),delete this._timers[r]);let x=h.getExpiryTimeout();x&&(this._timers[r]=setTimeout(()=>{this._reloadTile(r,"expired"),delete this._timers[r]},x))}refreshTiles(r){for(let h in this._tiles)(this._isIdRenderable(h)||this._tiles[h].state=="errored")&&r.some(x=>x.equals(this._tiles[h].tileID.canonical))&&this._reloadTile(h,"expired")}_removeTile(r){let h=this._tiles[r];h&&(h.uses--,delete this._tiles[r],this._timers[r]&&(clearTimeout(this._timers[r]),delete this._timers[r]),h.uses>0||(h.hasData()&&h.state!=="reloading"?this._cache.add(h.tileID,h,h.getExpiryTimeout()):(h.aborted=!0,this._abortTile(h),this._unloadTile(h))))}_dataHandler(r){let h=r.sourceDataType;r.dataType==="source"&&h==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&r.dataType==="source"&&h==="content"&&(this.reload(r.sourceDataChanged),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(let r in this._tiles)this._removeTile(r);this._cache.reset()}tilesIn(r,h,x){let w=[],A=this.transform;if(!A)return w;let k=A.getCoveringTilesDetailsProvider().allowWorldCopies(),j=x?A.getCameraQueryGeometry(r):r,q=ge=>A.screenPointToMercatorCoordinate(ge,this.terrain),J=this.transformBbox(r,q,!k),ne=this.transformBbox(j,q,!k),pe=this.getIds(),ue=t.a1.fromPoints(ne);for(let ge=0;ge<pe.length;ge++){let Ee=this._tiles[pe[ge]];if(Ee.holdingForFade())continue;let tt=k?[Ee.tileID]:[Ee.tileID.unwrapTo(-1),Ee.tileID.unwrapTo(0)],Xe=Math.pow(2,A.zoom-Ee.tileID.overscaledZ),et=h*Ee.queryPadding*t.$/Ee.tileSize/Xe;for(let Se of tt){let Be=ue.map(ft=>Se.getTilePoint(new t.a0(ft.x,ft.y)));if(Be.expandBy(et),Be.intersects(Zt)){let ft=J.map(xe=>Se.getTilePoint(xe)),dt=ne.map(xe=>Se.getTilePoint(xe));w.push({tile:Ee,tileID:k?Se:Se.unwrapTo(0),queryGeometry:ft,cameraQueryGeometry:dt,scale:Xe})}}}return w}transformBbox(r,h,x){let w=r.map(h);if(x){let A=t.a1.fromPoints(r);A.shrinkBy(.001*Math.min(A.width(),A.height()));let k=A.map(h);t.a1.fromPoints(w).covers(k)||(w=w.map(j=>j.x>.5?new t.a0(j.x-1,j.y,j.z):j))}return w}getVisibleCoordinates(r){let h=this.getRenderableIds(r).map(x=>this._tiles[x].tileID);return this.transform&&this.transform.populateCache(h),h}hasTransition(){if(this._source.hasTransition())return!0;if(Qi(this._source.type)){let r=an.now();for(let h in this._tiles)if(this._tiles[h].fadeEndTime>=r)return!0}return!1}setFeatureState(r,h,x){this._state.updateState(r=r||"_geojsonTileLayer",h,x)}removeFeatureState(r,h,x){this._state.removeFeatureState(r=r||"_geojsonTileLayer",h,x)}getFeatureState(r,h){return this._state.getState(r=r||"_geojsonTileLayer",h)}setDependencies(r,h,x){let w=this._tiles[r];w&&w.setDependencies(h,x)}reloadTilesForDependencies(r,h){for(let x in this._tiles)this._tiles[x].hasDependency(r,h)&&this._reloadTile(x,"reloading");this._cache.filter(x=>!x.hasDependency(r,h))}}function Ue(M,r){let h=Math.abs(2*M.wrap)-+(M.wrap<0),x=Math.abs(2*r.wrap)-+(r.wrap<0);return M.overscaledZ-r.overscaledZ||x-h||r.canonical.y-M.canonical.y||r.canonical.x-M.canonical.x}function Qi(M){return M==="raster"||M==="image"||M==="video"}wi.maxOverzooming=10,wi.maxUnderzooming=3;class $n{constructor(r,h){this.reset(r,h)}reset(r,h){this.points=r||[],this._distances=[0];for(let x=1;x<this.points.length;x++)this._distances[x]=this._distances[x-1]+this.points[x].dist(this.points[x-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(h||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(r){if(this.points.length===1)return this.points[0];r=t.ag(r,0,1);let h=1,x=this._distances[h],w=r*this.paddedLength+this.padding;for(;x<w&&h<this._distances.length;)x=this._distances[++h];let A=h-1,k=this._distances[A],j=x-k,q=j>0?(w-k)/j:0;return this.points[A].mult(1-q).add(this.points[h].mult(q))}}function ht(M,r){let h=!0;return M==="always"||M!=="never"&&r!=="never"||(h=!1),h}class te{constructor(r,h,x){let w=this.boxCells=[],A=this.circleCells=[];this.xCellCount=Math.ceil(r/x),this.yCellCount=Math.ceil(h/x);for(let k=0;k<this.xCellCount*this.yCellCount;k++)w.push([]),A.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=r,this.height=h,this.xScale=this.xCellCount/r,this.yScale=this.yCellCount/h,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(r,h,x,w,A){this._forEachCell(h,x,w,A,this._insertBoxCell,this.boxUid++),this.boxKeys.push(r),this.bboxes.push(h),this.bboxes.push(x),this.bboxes.push(w),this.bboxes.push(A)}insertCircle(r,h,x,w){this._forEachCell(h-w,x-w,h+w,x+w,this._insertCircleCell,this.circleUid++),this.circleKeys.push(r),this.circles.push(h),this.circles.push(x),this.circles.push(w)}_insertBoxCell(r,h,x,w,A,k){this.boxCells[A].push(k)}_insertCircleCell(r,h,x,w,A,k){this.circleCells[A].push(k)}_query(r,h,x,w,A,k,j){if(x<0||r>this.width||w<0||h>this.height)return[];let q=[];if(r<=0&&h<=0&&this.width<=x&&this.height<=w){if(A)return[{key:null,x1:r,y1:h,x2:x,y2:w}];for(let J=0;J<this.boxKeys.length;J++)q.push({key:this.boxKeys[J],x1:this.bboxes[4*J],y1:this.bboxes[4*J+1],x2:this.bboxes[4*J+2],y2:this.bboxes[4*J+3]});for(let J=0;J<this.circleKeys.length;J++){let ne=this.circles[3*J],pe=this.circles[3*J+1],ue=this.circles[3*J+2];q.push({key:this.circleKeys[J],x1:ne-ue,y1:pe-ue,x2:ne+ue,y2:pe+ue})}}else this._forEachCell(r,h,x,w,this._queryCell,q,{hitTest:A,overlapMode:k,seenUids:{box:{},circle:{}}},j);return q}query(r,h,x,w){return this._query(r,h,x,w,!1,null)}hitTest(r,h,x,w,A,k){return this._query(r,h,x,w,!0,A,k).length>0}hitTestCircle(r,h,x,w,A){let k=r-x,j=r+x,q=h-x,J=h+x;if(j<0||k>this.width||J<0||q>this.height)return!1;let ne=[];return this._forEachCell(k,q,j,J,this._queryCellCircle,ne,{hitTest:!0,overlapMode:w,circle:{x:r,y:h,radius:x},seenUids:{box:{},circle:{}}},A),ne.length>0}_queryCell(r,h,x,w,A,k,j,q){let{seenUids:J,hitTest:ne,overlapMode:pe}=j,ue=this.boxCells[A];if(ue!==null){let Ee=this.bboxes;for(let tt of ue)if(!J.box[tt]){J.box[tt]=!0;let Xe=4*tt,et=this.boxKeys[tt];if(r<=Ee[Xe+2]&&h<=Ee[Xe+3]&&x>=Ee[Xe+0]&&w>=Ee[Xe+1]&&(!q||q(et))&&(!ne||!ht(pe,et.overlapMode))&&(k.push({key:et,x1:Ee[Xe],y1:Ee[Xe+1],x2:Ee[Xe+2],y2:Ee[Xe+3]}),ne))return!0}}let ge=this.circleCells[A];if(ge!==null){let Ee=this.circles;for(let tt of ge)if(!J.circle[tt]){J.circle[tt]=!0;let Xe=3*tt,et=this.circleKeys[tt];if(this._circleAndRectCollide(Ee[Xe],Ee[Xe+1],Ee[Xe+2],r,h,x,w)&&(!q||q(et))&&(!ne||!ht(pe,et.overlapMode))){let Se=Ee[Xe],Be=Ee[Xe+1],ft=Ee[Xe+2];if(k.push({key:et,x1:Se-ft,y1:Be-ft,x2:Se+ft,y2:Be+ft}),ne)return!0}}}return!1}_queryCellCircle(r,h,x,w,A,k,j,q){let{circle:J,seenUids:ne,overlapMode:pe}=j,ue=this.boxCells[A];if(ue!==null){let Ee=this.bboxes;for(let tt of ue)if(!ne.box[tt]){ne.box[tt]=!0;let Xe=4*tt,et=this.boxKeys[tt];if(this._circleAndRectCollide(J.x,J.y,J.radius,Ee[Xe+0],Ee[Xe+1],Ee[Xe+2],Ee[Xe+3])&&(!q||q(et))&&!ht(pe,et.overlapMode))return k.push(!0),!0}}let ge=this.circleCells[A];if(ge!==null){let Ee=this.circles;for(let tt of ge)if(!ne.circle[tt]){ne.circle[tt]=!0;let Xe=3*tt,et=this.circleKeys[tt];if(this._circlesCollide(Ee[Xe],Ee[Xe+1],Ee[Xe+2],J.x,J.y,J.radius)&&(!q||q(et))&&!ht(pe,et.overlapMode))return k.push(!0),!0}}}_forEachCell(r,h,x,w,A,k,j,q){let J=this._convertToXCellCoord(r),ne=this._convertToYCellCoord(h),pe=this._convertToXCellCoord(x),ue=this._convertToYCellCoord(w);for(let ge=J;ge<=pe;ge++)for(let Ee=ne;Ee<=ue;Ee++)if(A.call(this,r,h,x,w,this.xCellCount*Ee+ge,k,j,q))return}_convertToXCellCoord(r){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(r*this.xScale)))}_convertToYCellCoord(r){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(r*this.yScale)))}_circlesCollide(r,h,x,w,A,k){let j=w-r,q=A-h,J=x+k;return J*J>j*j+q*q}_circleAndRectCollide(r,h,x,w,A,k,j){let q=(k-w)/2,J=Math.abs(r-(w+q));if(J>q+x)return!1;let ne=(j-A)/2,pe=Math.abs(h-(A+ne));if(pe>ne+x)return!1;if(J<=q||pe<=ne)return!0;let ue=J-q,ge=pe-ne;return ue*ue+ge*ge<=x*x}}function fe(M,r,h){let x=t.L();if(!M){let{vecSouth:pe,vecEast:ue}=qe(r),ge=yi();ge[0]=ue[0],ge[1]=ue[1],ge[2]=pe[0],ge[3]=pe[1],w=ge,(ne=(k=(A=ge)[0])*(J=A[3])-(q=A[2])*(j=A[1]))&&(w[0]=J*(ne=1/ne),w[1]=-j*ne,w[2]=-q*ne,w[3]=k*ne),x[0]=ge[0],x[1]=ge[1],x[4]=ge[2],x[5]=ge[3]}var w,A,k,j,q,J,ne;return t.N(x,x,[1/h,1/h,1]),x}function Ae(M,r,h,x){if(M){let w=t.L();if(!r){let{vecSouth:A,vecEast:k}=qe(h);w[0]=k[0],w[1]=k[1],w[4]=A[0],w[5]=A[1]}return t.N(w,w,[x,x,1]),w}return h.pixelsToClipSpaceMatrix}function qe(M){let r=Math.cos(M.rollInRadians),h=Math.sin(M.rollInRadians),x=Math.cos(M.pitchInRadians),w=Math.cos(M.bearingInRadians),A=Math.sin(M.bearingInRadians),k=t.aq();k[0]=-w*x*h-A*r,k[1]=-A*x*h+w*r;let j=t.ar(k);j<1e-9?t.as(k):t.at(k,k,1/j);let q=t.aq();q[0]=w*x*r-A*h,q[1]=A*x*r+w*h;let J=t.ar(q);return J<1e-9?t.as(q):t.at(q,q,1/J),{vecEast:q,vecSouth:k}}function je(M,r,h,x){let w;x?(w=[M,r,x(M,r),1],t.av(w,w,h)):(w=[M,r,0,1],Jn(w,w,h));let A=w[3];return{point:new t.P(w[0]/A,w[1]/A),signedDistanceFromCamera:A,isOccluded:!1}}function We(M,r){return .5+M/r*.5}function rt(M,r){return M.x>=-r[0]&&M.x<=r[0]&&M.y>=-r[1]&&M.y<=r[1]}function ct(M,r,h,x,w,A,k,j,q,J,ne,pe,ue){let ge=h?M.textSizeData:M.iconSizeData,Ee=t.am(ge,r.transform.zoom),tt=[256/r.width*2+1,256/r.height*2+1],Xe=h?M.text.dynamicLayoutVertexArray:M.icon.dynamicLayoutVertexArray;Xe.clear();let et=M.lineVertexArray,Se=h?M.text.placedSymbolArray:M.icon.placedSymbolArray,Be=r.transform.width/r.transform.height,ft=!1;for(let dt=0;dt<Se.length;dt++){let xe=Se.get(dt);if(xe.hidden||xe.writingMode===t.an.vertical&&!ft){yr(xe.numGlyphs,Xe);continue}ft=!1;let pt=new t.P(xe.anchorX,xe.anchorY),zt={getElevation:ue,pitchedLabelPlaneMatrix:x,lineVertexArray:et,pitchWithMap:A,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:r.transform,tileAnchorPoint:pt,unwrappedTileID:q,width:J,height:ne,translation:pe},ei=Ni(xe.anchorX,xe.anchorY,zt);if(!rt(ei.point,tt)){yr(xe.numGlyphs,Xe);continue}let Kt=We(r.transform.cameraToCenterDistance,ei.signedDistanceFromCamera),Jt=t.ao(ge,Ee,xe),si=A?Jt*r.transform.getPitchedTextCorrection(xe.anchorX,xe.anchorY,q)/Kt:Jt*Kt,Xi=wt({projectionContext:zt,pitchedLabelPlaneMatrixInverse:w,symbol:xe,fontSize:si,flip:!1,keepUpright:k,glyphOffsetArray:M.glyphOffsetArray,dynamicLayoutVertexArray:Xe,aspectRatio:Be,rotateToLine:j});ft=Xi.useVertical,(Xi.notEnoughRoom||ft||Xi.needsFlipping&&wt({projectionContext:zt,pitchedLabelPlaneMatrixInverse:w,symbol:xe,fontSize:si,flip:!0,keepUpright:k,glyphOffsetArray:M.glyphOffsetArray,dynamicLayoutVertexArray:Xe,aspectRatio:Be,rotateToLine:j}).notEnoughRoom)&&yr(xe.numGlyphs,Xe)}h?M.text.dynamicLayoutVertexBuffer.updateData(Xe):M.icon.dynamicLayoutVertexBuffer.updateData(Xe)}function nt(M,r,h,x,w,A,k,j){let q=A.glyphStartIndex+A.numGlyphs,J=A.lineStartIndex,ne=A.lineStartIndex+A.lineLength,pe=r.getoffsetX(A.glyphStartIndex),ue=r.getoffsetX(q-1),ge=kr(M*pe,h,x,w,A.segment,J,ne,j,k);if(!ge)return null;let Ee=kr(M*ue,h,x,w,A.segment,J,ne,j,k);return Ee?j.projectionCache.anyProjectionOccluded?null:{first:ge,last:Ee}:null}function Ot(M,r,h,x){return M===t.an.horizontal&&Math.abs(h.y-r.y)>Math.abs(h.x-r.x)*x?{useVertical:!0}:(M===t.an.vertical?r.y<h.y:r.x>h.x)?{needsFlipping:!0}:null}function wt(M){let{projectionContext:r,pitchedLabelPlaneMatrixInverse:h,symbol:x,fontSize:w,flip:A,keepUpright:k,glyphOffsetArray:j,dynamicLayoutVertexArray:q,aspectRatio:J,rotateToLine:ne}=M,pe=w/24,ue=x.lineOffsetX*pe,ge=x.lineOffsetY*pe,Ee;if(x.numGlyphs>1){let tt=x.glyphStartIndex+x.numGlyphs,Xe=x.lineStartIndex,et=x.lineStartIndex+x.lineLength,Se=nt(pe,j,ue,ge,A,x,ne,r);if(!Se)return{notEnoughRoom:!0};let Be=Di(Se.first.point.x,Se.first.point.y,r,h),ft=Di(Se.last.point.x,Se.last.point.y,r,h);if(k&&!A){let dt=Ot(x.writingMode,Be,ft,J);if(dt)return dt}Ee=[Se.first];for(let dt=x.glyphStartIndex+1;dt<tt-1;dt++){let xe=kr(pe*j.getoffsetX(dt),ue,ge,A,x.segment,Xe,et,r,ne);if(!xe)return{notEnoughRoom:!0};Ee.push(xe)}Ee.push(Se.last)}else{if(k&&!A){let Xe=Bt(r.tileAnchorPoint.x,r.tileAnchorPoint.y,r).point,et=x.lineStartIndex+x.segment+1,Se=new t.P(r.lineVertexArray.getx(et),r.lineVertexArray.gety(et)),Be=Bt(Se.x,Se.y,r),ft=Be.signedDistanceFromCamera>0?Be.point:_i(r.tileAnchorPoint,Se,Xe,1,r),dt=Di(Xe.x,Xe.y,r,h),xe=Di(ft.x,ft.y,r,h),pt=Ot(x.writingMode,dt,xe,J);if(pt)return pt}let tt=kr(pe*j.getoffsetX(x.glyphStartIndex),ue,ge,A,x.segment,x.lineStartIndex,x.lineStartIndex+x.lineLength,r,ne);if(!tt||r.projectionCache.anyProjectionOccluded)return{notEnoughRoom:!0};Ee=[tt]}for(let tt of Ee)t.au(q,tt.point,tt.angle);return{}}function _i(M,r,h,x,w){let A=M.add(M.sub(r)._unit()),k=Bt(A.x,A.y,w).point,j=h.sub(k);return h.add(j._mult(x/j.mag()))}function Ii(M,r,h){let x=r.projectionCache;if(x.projections[M])return x.projections[M];let w=new t.P(r.lineVertexArray.getx(M),r.lineVertexArray.gety(M)),A=Bt(w.x,w.y,r);if(A.signedDistanceFromCamera>0)return x.projections[M]=A.point,x.anyProjectionOccluded=x.anyProjectionOccluded||A.isOccluded,A.point;let k=M-h.direction;return _i(h.distanceFromAnchor===0?r.tileAnchorPoint:new t.P(r.lineVertexArray.getx(k),r.lineVertexArray.gety(k)),w,h.previousVertex,h.absOffsetX-h.distanceFromAnchor+1,r)}function Bt(M,r,h){let x=M+h.translation[0],w=r+h.translation[1],A;return h.pitchWithMap?(A=je(x,w,h.pitchedLabelPlaneMatrix,h.getElevation),A.isOccluded=!1):(A=h.transform.projectTileCoordinates(x,w,h.unwrappedTileID,h.getElevation),A.point.x=(.5*A.point.x+.5)*h.width,A.point.y=(.5*-A.point.y+.5)*h.height),A}function Di(M,r,h,x){if(h.pitchWithMap){let w=[M,r,0,1];return t.av(w,w,x),h.transform.projectTileCoordinates(w[0]/w[3],w[1]/w[3],h.unwrappedTileID,h.getElevation).point}return{x:M/h.width*2-1,y:r/h.height*2-1}}function Ni(M,r,h){return h.transform.projectTileCoordinates(M,r,h.unwrappedTileID,h.getElevation)}function dn(M,r,h){return M._unit()._perp()._mult(r*h)}function An(M,r,h,x,w,A,k,j,q){if(j.projectionCache.offsets[M])return j.projectionCache.offsets[M];let J=h.add(r);if(M+q.direction<x||M+q.direction>=w)return j.projectionCache.offsets[M]=J,J;let ne=Ii(M+q.direction,j,q),pe=dn(ne.sub(h),k,q.direction),ue=h.add(pe),ge=ne.add(pe);return j.projectionCache.offsets[M]=t.aw(A,J,ue,ge)||J,j.projectionCache.offsets[M]}function kr(M,r,h,x,w,A,k,j,q){let J=x?M-r:M+r,ne=J>0?1:-1,pe=0;x&&(ne*=-1,pe=Math.PI),ne<0&&(pe+=Math.PI);let ue,ge=ne>0?A+w:A+w+1;j.projectionCache.cachedAnchorPoint?ue=j.projectionCache.cachedAnchorPoint:(ue=Bt(j.tileAnchorPoint.x,j.tileAnchorPoint.y,j).point,j.projectionCache.cachedAnchorPoint=ue);let Ee,tt,Xe=ue,et=ue,Se=0,Be=0,ft=Math.abs(J),dt=[],xe;for(;Se+Be<=ft;){if(ge+=ne,ge<A||ge>=k)return null;Se+=Be,et=Xe,tt=Ee;let ei={absOffsetX:ft,direction:ne,distanceFromAnchor:Se,previousVertex:et};if(Xe=Ii(ge,j,ei),h===0)dt.push(et),xe=Xe.sub(et);else{let Kt,Jt=Xe.sub(et);Kt=Jt.mag()===0?dn(Ii(ge+ne,j,ei).sub(Xe),h,ne):dn(Jt,h,ne),tt||(tt=et.add(Kt)),Ee=An(ge,Kt,Xe,A,k,tt,h,j,ei),dt.push(tt),xe=Ee.sub(tt)}Be=xe.mag()}let pt=xe._mult((ft-Se)/Be)._add(tt||et),zt=pe+Math.atan2(Xe.y-et.y,Xe.x-et.x);return dt.push(pt),{point:pt,angle:q?zt:0,path:dt}}let Hi=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function yr(M,r){for(let h=0;h<M;h++){let x=r.length;r.resize(x+4),r.float32.set(Hi,3*x)}}function Jn(M,r,h){let x=r[0],w=r[1];return M[0]=h[0]*x+h[4]*w+h[12],M[1]=h[1]*x+h[5]*w+h[13],M[3]=h[3]*x+h[7]*w+h[15],M}let Un=100;class Ar{constructor(r,h=new te(r.width+200,r.height+200,25),x=new te(r.width+200,r.height+200,25)){this.transform=r,this.grid=h,this.ignoredGrid=x,this.pitchFactor=Math.cos(r.pitch*Math.PI/180)*r.cameraToCenterDistance,this.screenRightBoundary=r.width+Un,this.screenBottomBoundary=r.height+Un,this.gridRightBoundary=r.width+200,this.gridBottomBoundary=r.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(r,h,x,w,A,k,j,q,J,ne,pe,ue){let ge=this.projectAndGetPerspectiveRatio(r.anchorPointX+q[0],r.anchorPointY+q[1],A,ne,ue),Ee=x*ge.perspectiveRatio,tt;if(k||j)tt=this._projectCollisionBox(r,Ee,w,A,k,j,q,ge,ne,pe,ue);else{let xe=ge.x+(pe?pe.x*Ee:0),pt=ge.y+(pe?pe.y*Ee:0);tt={allPointsOccluded:!1,box:[xe+r.x1*Ee,pt+r.y1*Ee,xe+r.x2*Ee,pt+r.y2*Ee]}}let[Xe,et,Se,Be]=tt.box,ft=k?tt.allPointsOccluded:ge.isOccluded,dt=ft;return dt||(dt=ge.perspectiveRatio<this.perspectiveRatioCutoff),dt||(dt=!this.isInsideGrid(Xe,et,Se,Be)),dt||h!=="always"&&this.grid.hitTest(Xe,et,Se,Be,h,J)?{box:[Xe,et,Se,Be],placeable:!1,offscreen:!1,occluded:ft}:{box:[Xe,et,Se,Be],placeable:!0,offscreen:this.isOffscreen(Xe,et,Se,Be),occluded:ft}}placeCollisionCircles(r,h,x,w,A,k,j,q,J,ne,pe,ue,ge,Ee){let tt=[],Xe=new t.P(h.anchorX,h.anchorY),et=this.getPerspectiveRatio(Xe.x,Xe.y,k,Ee),Se=(J?A*this.transform.getPitchedTextCorrection(h.anchorX,h.anchorY,k)/et:A*et)/t.aA,Be={getElevation:Ee,pitchedLabelPlaneMatrix:j,lineVertexArray:x,pitchWithMap:J,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:this.transform,tileAnchorPoint:Xe,unwrappedTileID:k,width:this.transform.width,height:this.transform.height,translation:ge},ft=nt(Se,w,h.lineOffsetX*Se,h.lineOffsetY*Se,!1,h,!1,Be),dt=!1,xe=!1,pt=!0;if(ft){let zt=.5*pe*et+ue,ei=new t.P(-100,-100),Kt=new t.P(this.screenRightBoundary,this.screenBottomBoundary),Jt=new $n,si=ft.first,Xi=ft.last,Ki=[];for(let xr=si.path.length-1;xr>=1;xr--)Ki.push(si.path[xr]);for(let xr=1;xr<Xi.path.length;xr++)Ki.push(Xi.path[xr]);let Pi=2.5*zt;if(J){let xr=this.projectPathToScreenSpace(Ki,Be);Ki=xr.some(Kr=>Kr.signedDistanceFromCamera<=0)?[]:xr.map(Kr=>Kr.point)}let yn=[];if(Ki.length>0){let xr=Ki[0].clone(),Kr=Ki[0].clone();for(let Ho=1;Ho<Ki.length;Ho++)xr.x=Math.min(xr.x,Ki[Ho].x),xr.y=Math.min(xr.y,Ki[Ho].y),Kr.x=Math.max(Kr.x,Ki[Ho].x),Kr.y=Math.max(Kr.y,Ki[Ho].y);yn=xr.x>=ei.x&&Kr.x<=Kt.x&&xr.y>=ei.y&&Kr.y<=Kt.y?[Ki]:Kr.x<ei.x||xr.x>Kt.x||Kr.y<ei.y||xr.y>Kt.y?[]:t.ax([Ki],ei.x,ei.y,Kt.x,Kt.y)}for(let xr of yn){Jt.reset(xr,.25*zt);let Kr=0;Kr=Jt.length<=.5*zt?1:Math.ceil(Jt.paddedLength/Pi)+1;for(let Ho=0;Ho<Kr;Ho++){let Eo=Ho/Math.max(Kr-1,1),Go=Jt.lerp(Eo),vo=Go.x+Un,Yr=Go.y+Un;tt.push(vo,Yr,zt,0);let Mo=vo-zt,ps=Yr-zt,lr=vo+zt,aa=Yr+zt;if(pt=pt&&this.isOffscreen(Mo,ps,lr,aa),xe=xe||this.isInsideGrid(Mo,ps,lr,aa),r!=="always"&&this.grid.hitTestCircle(vo,Yr,zt,r,ne)&&(dt=!0,!q))return{circles:[],offscreen:!1,collisionDetected:dt}}}}return{circles:!q&&dt||!xe||et<this.perspectiveRatioCutoff?[]:tt,offscreen:pt,collisionDetected:dt}}projectPathToScreenSpace(r,h){let x=function(w,A){let k=t.L();return t.ap(k,A.pitchedLabelPlaneMatrix),w.map(j=>{let q=je(j.x,j.y,k,A.getElevation),J=A.transform.projectTileCoordinates(q.point.x,q.point.y,A.unwrappedTileID,A.getElevation);return J.point.x=(.5*J.point.x+.5)*A.width,J.point.y=(.5*-J.point.y+.5)*A.height,J})}(r,h);return function(w){let A=0,k=0,j=0,q=0;for(let J=0;J<w.length;J++)w[J].isOccluded?(j=J+1,q=0):(q++,q>k&&(k=q,A=j));return w.slice(A,A+k)}(x)}queryRenderedSymbols(r){if(r.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};let h=[],x=new t.a1;for(let pe of r){let ue=new t.P(pe.x+Un,pe.y+Un);x.extend(ue),h.push(ue)}let{minX:w,minY:A,maxX:k,maxY:j}=x,q=this.grid.query(w,A,k,j).concat(this.ignoredGrid.query(w,A,k,j)),J={},ne={};for(let pe of q){let ue=pe.key;if(J[ue.bucketInstanceId]===void 0&&(J[ue.bucketInstanceId]={}),J[ue.bucketInstanceId][ue.featureIndex])continue;let ge=[new t.P(pe.x1,pe.y1),new t.P(pe.x2,pe.y1),new t.P(pe.x2,pe.y2),new t.P(pe.x1,pe.y2)];t.ay(h,ge)&&(J[ue.bucketInstanceId][ue.featureIndex]=!0,ne[ue.bucketInstanceId]===void 0&&(ne[ue.bucketInstanceId]=[]),ne[ue.bucketInstanceId].push(ue.featureIndex))}return ne}insertCollisionBox(r,h,x,w,A,k){(x?this.ignoredGrid:this.grid).insert({bucketInstanceId:w,featureIndex:A,collisionGroupID:k,overlapMode:h},r[0],r[1],r[2],r[3])}insertCollisionCircles(r,h,x,w,A,k){let j=x?this.ignoredGrid:this.grid,q={bucketInstanceId:w,featureIndex:A,collisionGroupID:k,overlapMode:h};for(let J=0;J<r.length;J+=4)j.insertCircle(q,r[J],r[J+1],r[J+2])}projectAndGetPerspectiveRatio(r,h,x,w,A){if(A){let k;w?(k=[r,h,w(r,h),1],t.av(k,k,A)):(k=[r,h,0,1],Jn(k,k,A));let j=k[3];return{x:(k[0]/j+1)/2*this.transform.width+Un,y:(-k[1]/j+1)/2*this.transform.height+Un,perspectiveRatio:.5+this.transform.cameraToCenterDistance/j*.5,isOccluded:!1,signedDistanceFromCamera:j}}{let k=this.transform.projectTileCoordinates(r,h,x,w);return{x:(k.point.x+1)/2*this.transform.width+Un,y:(1-k.point.y)/2*this.transform.height+Un,perspectiveRatio:.5+this.transform.cameraToCenterDistance/k.signedDistanceFromCamera*.5,isOccluded:k.isOccluded,signedDistanceFromCamera:k.signedDistanceFromCamera}}}getPerspectiveRatio(r,h,x,w){let A=this.transform.projectTileCoordinates(r,h,x,w);return .5+this.transform.cameraToCenterDistance/A.signedDistanceFromCamera*.5}isOffscreen(r,h,x,w){return x<Un||r>=this.screenRightBoundary||w<Un||h>this.screenBottomBoundary}isInsideGrid(r,h,x,w){return x>=0&&r<this.gridRightBoundary&&w>=0&&h<this.gridBottomBoundary}getViewportMatrix(){let r=t.af([]);return t.M(r,r,[-100,-100,0]),r}_projectCollisionBox(r,h,x,w,A,k,j,q,J,ne,pe){let ue=1,ge=0,Ee=0,tt=1,Xe=r.anchorPointX+j[0],et=r.anchorPointY+j[1];if(k&&!A){let Ki=this.projectAndGetPerspectiveRatio(Xe+1,et,w,J,pe),Pi=Ki.x-q.x,yn=Math.atan((Ki.y-q.y)/Pi)+(Pi<0?Math.PI:0),xr=Math.sin(yn),Kr=Math.cos(yn);ue=Kr,ge=xr,Ee=-xr,tt=Kr}else if(!k&&A){let Ki=qe(this.transform);ue=Ki.vecEast[0],ge=Ki.vecEast[1],Ee=Ki.vecSouth[0],tt=Ki.vecSouth[1]}let Se=q.x,Be=q.y,ft=h;A&&(Se=Xe,Be=et,ft=Math.pow(2,-(this.transform.zoom-x.overscaledZ)),ft*=this.transform.getPitchedTextCorrection(Xe,et,w),ne||(ft*=t.ag(.5+q.signedDistanceFromCamera/this.transform.cameraToCenterDistance*.5,0,4))),ne&&(Se+=ue*ne.x*ft+Ee*ne.y*ft,Be+=ge*ne.x*ft+tt*ne.y*ft);let dt=r.x1*ft,xe=r.x2*ft,pt=(dt+xe)/2,zt=r.y1*ft,ei=r.y2*ft,Kt=(zt+ei)/2,Jt=[{offsetX:dt,offsetY:zt},{offsetX:pt,offsetY:zt},{offsetX:xe,offsetY:zt},{offsetX:xe,offsetY:Kt},{offsetX:xe,offsetY:ei},{offsetX:pt,offsetY:ei},{offsetX:dt,offsetY:ei},{offsetX:dt,offsetY:Kt}],si=[];for(let{offsetX:Ki,offsetY:Pi}of Jt)si.push(new t.P(Se+ue*Ki+Ee*Pi,Be+ge*Ki+tt*Pi));let Xi=!1;if(A){let Ki=si.map(Pi=>this.projectAndGetPerspectiveRatio(Pi.x,Pi.y,w,J,pe));Xi=Ki.some(Pi=>!Pi.isOccluded),si=Ki.map(Pi=>new t.P(Pi.x,Pi.y))}else Xi=!0;return{box:t.az(si),allPointsOccluded:!Xi}}}class go{constructor(r,h,x,w){this.opacity=r?Math.max(0,Math.min(1,r.opacity+(r.placed?h:-h))):w&&x?1:0,this.placed=x}isHidden(){return this.opacity===0&&!this.placed}}class yo{constructor(r,h,x,w,A){this.text=new go(r?r.text:null,h,x,A),this.icon=new go(r?r.icon:null,h,w,A)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Qo{constructor(r,h,x){this.text=r,this.icon=h,this.skipFade=x}}class To{constructor(r,h,x,w,A){this.bucketInstanceId=r,this.featureIndex=h,this.sourceLayerIndex=x,this.bucketIndex=w,this.tileID=A}}class xo{constructor(r){this.crossSourceCollisions=r,this.maxGroupID=0,this.collisionGroups={}}get(r){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[r]){let h=++this.maxGroupID;this.collisionGroups[r]={ID:h,predicate:x=>x.collisionGroupID===h}}return this.collisionGroups[r]}}function oa(M,r,h,x,w){let{horizontalAlign:A,verticalAlign:k}=t.aG(M);return new t.P(-(A-.5)*r+x[0]*w,-(k-.5)*h+x[1]*w)}class Es{constructor(r,h,x,w,A){this.transform=r.clone(),this.terrain=h,this.collisionIndex=new Ar(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=x,this.retainedQueryData={},this.collisionGroups=new xo(w),this.collisionCircleArrays={},this.collisionBoxArrays=new Map,this.prevPlacement=A,A&&(A.prevPlacement=void 0),this.placedOrientations={}}_getTerrainElevationFunc(r){let h=this.terrain;return h?(x,w)=>h.getElevation(r,x,w):null}getBucketParts(r,h,x,w){let A=x.getBucket(h),k=x.latestFeatureIndex;if(!A||!k||h.id!==A.layerIds[0])return;let j=x.collisionBoxArray,q=A.layers[0].layout,J=A.layers[0].paint,ne=Math.pow(2,this.transform.zoom-x.tileID.overscaledZ),pe=x.tileSize/t.$,ue=x.tileID.toUnwrapped(),ge=q.get("text-rotation-alignment")==="map",Ee=t.aB(x,1,this.transform.zoom),tt=t.aC(this.collisionIndex.transform,x,J.get("text-translate"),J.get("text-translate-anchor")),Xe=t.aC(this.collisionIndex.transform,x,J.get("icon-translate"),J.get("icon-translate-anchor")),et=fe(ge,this.transform,Ee);this.retainedQueryData[A.bucketInstanceId]=new To(A.bucketInstanceId,k,A.sourceLayerIndex,A.index,x.tileID);let Se={bucket:A,layout:q,translationText:tt,translationIcon:Xe,unwrappedTileID:ue,pitchedLabelPlaneMatrix:et,scale:ne,textPixelRatio:pe,holdingForFade:x.holdingForFade(),collisionBoxArray:j,partiallyEvaluatedTextSize:t.am(A.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(A.sourceID)};if(w)for(let Be of A.sortKeyRanges){let{sortKey:ft,symbolInstanceStart:dt,symbolInstanceEnd:xe}=Be;r.push({sortKey:ft,symbolInstanceStart:dt,symbolInstanceEnd:xe,parameters:Se})}else r.push({symbolInstanceStart:0,symbolInstanceEnd:A.symbolInstances.length,parameters:Se})}attemptAnchorPlacement(r,h,x,w,A,k,j,q,J,ne,pe,ue,ge,Ee,tt,Xe,et,Se,Be,ft){let dt=t.aD[r.textAnchor],xe=[r.textOffset0,r.textOffset1],pt=oa(dt,x,w,xe,A),zt=this.collisionIndex.placeCollisionBox(h,ue,q,J,ne,j,k,Xe,pe.predicate,Be,pt,ft);if((!Se||this.collisionIndex.placeCollisionBox(Se,ue,q,J,ne,j,k,et,pe.predicate,Be,pt,ft).placeable)&&zt.placeable){let ei;if(this.prevPlacement&&this.prevPlacement.variableOffsets[ge.crossTileID]&&this.prevPlacement.placements[ge.crossTileID]&&this.prevPlacement.placements[ge.crossTileID].text&&(ei=this.prevPlacement.variableOffsets[ge.crossTileID].anchor),ge.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[ge.crossTileID]={textOffset:xe,width:x,height:w,anchor:dt,textBoxScale:A,prevAnchor:ei},this.markUsedJustification(Ee,dt,ge,tt),Ee.allowVerticalPlacement&&(this.markUsedOrientation(Ee,tt,ge),this.placedOrientations[ge.crossTileID]=tt),{shift:pt,placedGlyphBoxes:zt}}}placeLayerBucketPart(r,h,x){let{bucket:w,layout:A,translationText:k,translationIcon:j,unwrappedTileID:q,pitchedLabelPlaneMatrix:J,textPixelRatio:ne,holdingForFade:pe,collisionBoxArray:ue,partiallyEvaluatedTextSize:ge,collisionGroup:Ee}=r.parameters,tt=A.get("text-optional"),Xe=A.get("icon-optional"),et=t.aE(A,"text-overlap","text-allow-overlap"),Se=et==="always",Be=t.aE(A,"icon-overlap","icon-allow-overlap"),ft=Be==="always",dt=A.get("text-rotation-alignment")==="map",xe=A.get("text-pitch-alignment")==="map",pt=A.get("icon-text-fit")!=="none",zt=A.get("symbol-z-order")==="viewport-y",ei=Se&&(ft||!w.hasIconData()||Xe),Kt=ft&&(Se||!w.hasTextData()||tt);!w.collisionArrays&&ue&&w.deserializeCollisionBoxes(ue);let Jt=this.retainedQueryData[w.bucketInstanceId].tileID,si=this._getTerrainElevationFunc(Jt),Xi=this.transform.getFastPathSimpleProjectionMatrix(Jt),Ki=(Pi,yn,xr)=>{var Kr,Ho;if(h[Pi.crossTileID])return;if(pe)return void(this.placements[Pi.crossTileID]=new Qo(!1,!1,!1));let Eo=!1,Go=!1,vo=!0,Yr=null,Mo={box:null,placeable:!1,offscreen:null,occluded:!1},ps={placeable:!1},lr=null,aa=null,Rs=null,Rr=0,Kn=0,Ac=0;yn.textFeatureIndex?Rr=yn.textFeatureIndex:Pi.useRuntimeCollisionCircles&&(Rr=Pi.featureIndex),yn.verticalTextFeatureIndex&&(Kn=yn.verticalTextFeatureIndex);let la=yn.textBox;if(la){let Ca=So=>{let io=t.an.horizontal;if(w.allowVerticalPlacement&&!So&&this.prevPlacement){let ca=this.prevPlacement.placedOrientations[Pi.crossTileID];ca&&(this.placedOrientations[Pi.crossTileID]=ca,io=ca,this.markUsedOrientation(w,io,Pi))}return io},Fa=(So,io)=>{if(w.allowVerticalPlacement&&Pi.numVerticalGlyphVertices>0&&yn.verticalTextBox){for(let ca of w.writingModes)if(ca===t.an.vertical?(Mo=io(),ps=Mo):Mo=So(),Mo&&Mo.placeable)break}else Mo=So()},Dc=Pi.textAnchorOffsetStartIndex,vh=Pi.textAnchorOffsetEndIndex;if(vh===Dc){let So=(io,ca)=>{let ts=this.collisionIndex.placeCollisionBox(io,et,ne,Jt,q,xe,dt,k,Ee.predicate,si,void 0,Xi);return ts&&ts.placeable&&(this.markUsedOrientation(w,ca,Pi),this.placedOrientations[Pi.crossTileID]=ca),ts};Fa(()=>So(la,t.an.horizontal),()=>{let io=yn.verticalTextBox;return w.allowVerticalPlacement&&Pi.numVerticalGlyphVertices>0&&io?So(io,t.an.vertical):{box:null,offscreen:null}}),Ca(Mo&&Mo.placeable)}else{let So=t.aD[(Ho=(Kr=this.prevPlacement)===null||Kr===void 0?void 0:Kr.variableOffsets[Pi.crossTileID])===null||Ho===void 0?void 0:Ho.anchor],io=(ts,Su,el)=>{let jl=ts.x2-ts.x1,Iu=ts.y2-ts.y1,xl=Pi.textBoxScale,pc=pt&&Be==="never"?Su:null,Us=null,vl=et==="never"?1:2,np="never";So&&vl++;for(let zo=0;zo<vl;zo++){for(let rp=Dc;rp<vh;rp++){let op=w.textAnchorOffsets.get(rp);if(So&&op.textAnchor!==So)continue;let Gl=this.attemptAnchorPlacement(op,ts,jl,Iu,xl,dt,xe,ne,Jt,q,Ee,np,Pi,w,el,k,j,pc,si);if(Gl&&(Us=Gl.placedGlyphBoxes,Us&&Us.placeable))return Eo=!0,Yr=Gl.shift,Us}So?So=null:np=et}return x&&!Us&&(Us={box:this.collisionIndex.placeCollisionBox(la,"always",ne,Jt,q,xe,dt,k,Ee.predicate,si,void 0,Xi).box,offscreen:!1,placeable:!1,occluded:!1}),Us};Fa(()=>io(la,yn.iconBox,t.an.horizontal),()=>{let ts=yn.verticalTextBox;return w.allowVerticalPlacement&&(!Mo||!Mo.placeable)&&Pi.numVerticalGlyphVertices>0&&ts?io(ts,yn.verticalIconBox,t.an.vertical):{box:null,occluded:!0,offscreen:null}}),Mo&&(Eo=Mo.placeable,vo=Mo.offscreen);let ca=Ca(Mo&&Mo.placeable);if(!Eo&&this.prevPlacement){let ts=this.prevPlacement.variableOffsets[Pi.crossTileID];ts&&(this.variableOffsets[Pi.crossTileID]=ts,this.markUsedJustification(w,ts.anchor,Pi,ca))}}}if(lr=Mo,Eo=lr&&lr.placeable,vo=lr&&lr.offscreen,Pi.useRuntimeCollisionCircles){let Ca=w.text.placedSymbolArray.get(Pi.centerJustifiedTextSymbolIndex),Fa=t.ao(w.textSizeData,ge,Ca),Dc=A.get("text-padding");aa=this.collisionIndex.placeCollisionCircles(et,Ca,w.lineVertexArray,w.glyphOffsetArray,Fa,q,J,x,xe,Ee.predicate,Pi.collisionCircleDiameter,Dc,k,si),aa.circles.length&&aa.collisionDetected&&!x&&t.w("Collisions detected, but collision boxes are not shown"),Eo=Se||aa.circles.length>0&&!aa.collisionDetected,vo=vo&&aa.offscreen}if(yn.iconFeatureIndex&&(Ac=yn.iconFeatureIndex),yn.iconBox){let Ca=Fa=>this.collisionIndex.placeCollisionBox(Fa,Be,ne,Jt,q,xe,dt,j,Ee.predicate,si,pt&&Yr?Yr:void 0,Xi);ps&&ps.placeable&&yn.verticalIconBox?(Rs=Ca(yn.verticalIconBox),Go=Rs.placeable):(Rs=Ca(yn.iconBox),Go=Rs.placeable),vo=vo&&Rs.offscreen}let qh=tt||Pi.numHorizontalGlyphVertices===0&&Pi.numVerticalGlyphVertices===0,uc=Xe||Pi.numIconVertices===0;qh||uc?uc?qh||(Go=Go&&Eo):Eo=Go&&Eo:Go=Eo=Go&&Eo;let dc=Go&&Rs.placeable;if(Eo&&lr.placeable&&this.collisionIndex.insertCollisionBox(lr.box,et,A.get("text-ignore-placement"),w.bucketInstanceId,ps&&ps.placeable&&Kn?Kn:Rr,Ee.ID),dc&&this.collisionIndex.insertCollisionBox(Rs.box,Be,A.get("icon-ignore-placement"),w.bucketInstanceId,Ac,Ee.ID),aa&&Eo&&this.collisionIndex.insertCollisionCircles(aa.circles,et,A.get("text-ignore-placement"),w.bucketInstanceId,Rr,Ee.ID),x&&this.storeCollisionData(w.bucketInstanceId,xr,yn,lr,Rs,aa),Pi.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(w.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[Pi.crossTileID]=new Qo((Eo||ei)&&!lr?.occluded,(Go||Kt)&&!Rs?.occluded,vo||w.justReloaded),h[Pi.crossTileID]=!0};if(zt){if(r.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");let Pi=w.getSortedSymbolIndexes(-this.transform.bearingInRadians);for(let yn=Pi.length-1;yn>=0;--yn){let xr=Pi[yn];Ki(w.symbolInstances.get(xr),w.collisionArrays[xr],xr)}}else for(let Pi=r.symbolInstanceStart;Pi<r.symbolInstanceEnd;Pi++)Ki(w.symbolInstances.get(Pi),w.collisionArrays[Pi],Pi);w.justReloaded=!1}storeCollisionData(r,h,x,w,A,k){if(x.textBox||x.iconBox){let j,q;this.collisionBoxArrays.has(r)?j=this.collisionBoxArrays.get(r):(j=new Map,this.collisionBoxArrays.set(r,j)),j.has(h)?q=j.get(h):(q={text:null,icon:null},j.set(h,q)),x.textBox&&(q.text=w.box),x.iconBox&&(q.icon=A.box)}if(k){let j=this.collisionCircleArrays[r];j===void 0&&(j=this.collisionCircleArrays[r]=[]);for(let q=0;q<k.circles.length;q+=4)j.push(k.circles[q+0]-Un),j.push(k.circles[q+1]-Un),j.push(k.circles[q+2]),j.push(k.collisionDetected?1:0)}}markUsedJustification(r,h,x,w){let A;A=w===t.an.vertical?x.verticalPlacedTextSymbolIndex:{left:x.leftJustifiedTextSymbolIndex,center:x.centerJustifiedTextSymbolIndex,right:x.rightJustifiedTextSymbolIndex}[t.aF(h)];let k=[x.leftJustifiedTextSymbolIndex,x.centerJustifiedTextSymbolIndex,x.rightJustifiedTextSymbolIndex,x.verticalPlacedTextSymbolIndex];for(let j of k)j>=0&&(r.text.placedSymbolArray.get(j).crossTileID=A>=0&&j!==A?0:x.crossTileID)}markUsedOrientation(r,h,x){let w=h===t.an.horizontal||h===t.an.horizontalOnly?h:0,A=h===t.an.vertical?h:0,k=[x.leftJustifiedTextSymbolIndex,x.centerJustifiedTextSymbolIndex,x.rightJustifiedTextSymbolIndex];for(let j of k)r.text.placedSymbolArray.get(j).placedOrientation=w;x.verticalPlacedTextSymbolIndex&&(r.text.placedSymbolArray.get(x.verticalPlacedTextSymbolIndex).placedOrientation=A)}commit(r){this.commitTime=r,this.zoomAtLastRecencyCheck=this.transform.zoom;let h=this.prevPlacement,x=!1;this.prevZoomAdjustment=h?h.zoomAdjustment(this.transform.zoom):0;let w=h?h.symbolFadeChange(r):1,A=h?h.opacities:{},k=h?h.variableOffsets:{},j=h?h.placedOrientations:{};for(let q in this.placements){let J=this.placements[q],ne=A[q];ne?(this.opacities[q]=new yo(ne,w,J.text,J.icon),x=x||J.text!==ne.text.placed||J.icon!==ne.icon.placed):(this.opacities[q]=new yo(null,w,J.text,J.icon,J.skipFade),x=x||J.text||J.icon)}for(let q in A){let J=A[q];if(!this.opacities[q]){let ne=new yo(J,w,!1,!1);ne.isHidden()||(this.opacities[q]=ne,x=x||J.text.placed||J.icon.placed)}}for(let q in k)this.variableOffsets[q]||!this.opacities[q]||this.opacities[q].isHidden()||(this.variableOffsets[q]=k[q]);for(let q in j)this.placedOrientations[q]||!this.opacities[q]||this.opacities[q].isHidden()||(this.placedOrientations[q]=j[q]);if(h&&h.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");x?this.lastPlacementChangeTime=r:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=h?h.lastPlacementChangeTime:r)}updateLayerOpacities(r,h){let x={};for(let w of h){let A=w.getBucket(r);A&&w.latestFeatureIndex&&r.id===A.layerIds[0]&&this.updateBucketOpacities(A,w.tileID,x,w.collisionBoxArray)}}updateBucketOpacities(r,h,x,w){r.hasTextData()&&(r.text.opacityVertexArray.clear(),r.text.hasVisibleVertices=!1),r.hasIconData()&&(r.icon.opacityVertexArray.clear(),r.icon.hasVisibleVertices=!1),r.hasIconCollisionBoxData()&&r.iconCollisionBox.collisionVertexArray.clear(),r.hasTextCollisionBoxData()&&r.textCollisionBox.collisionVertexArray.clear();let A=r.layers[0],k=A.layout,j=new yo(null,0,!1,!1,!0),q=k.get("text-allow-overlap"),J=k.get("icon-allow-overlap"),ne=A._unevaluatedLayout.hasValue("text-variable-anchor")||A._unevaluatedLayout.hasValue("text-variable-anchor-offset"),pe=k.get("text-rotation-alignment")==="map",ue=k.get("text-pitch-alignment")==="map",ge=k.get("icon-text-fit")!=="none",Ee=new yo(null,0,q&&(J||!r.hasIconData()||k.get("icon-optional")),J&&(q||!r.hasTextData()||k.get("text-optional")),!0);!r.collisionArrays&&w&&(r.hasIconCollisionBoxData()||r.hasTextCollisionBoxData())&&r.deserializeCollisionBoxes(w);let tt=(et,Se,Be)=>{for(let ft=0;ft<Se/4;ft++)et.opacityVertexArray.emplaceBack(Be);et.hasVisibleVertices=et.hasVisibleVertices||Be!==Hc},Xe=this.collisionBoxArrays.get(r.bucketInstanceId);for(let et=0;et<r.symbolInstances.length;et++){let Se=r.symbolInstances.get(et),{numHorizontalGlyphVertices:Be,numVerticalGlyphVertices:ft,crossTileID:dt}=Se,xe=this.opacities[dt];x[dt]?xe=j:xe||(xe=Ee,this.opacities[dt]=xe),x[dt]=!0;let pt=Se.numIconVertices>0,zt=this.placedOrientations[Se.crossTileID],ei=zt===t.an.vertical,Kt=zt===t.an.horizontal||zt===t.an.horizontalOnly;if(Be>0||ft>0){let si=Mh(xe.text);tt(r.text,Be,ei?Hc:si),tt(r.text,ft,Kt?Hc:si);let Xi=xe.text.isHidden();[Se.rightJustifiedTextSymbolIndex,Se.centerJustifiedTextSymbolIndex,Se.leftJustifiedTextSymbolIndex].forEach(yn=>{yn>=0&&(r.text.placedSymbolArray.get(yn).hidden=Xi||ei?1:0)}),Se.verticalPlacedTextSymbolIndex>=0&&(r.text.placedSymbolArray.get(Se.verticalPlacedTextSymbolIndex).hidden=Xi||Kt?1:0);let Ki=this.variableOffsets[Se.crossTileID];Ki&&this.markUsedJustification(r,Ki.anchor,Se,zt);let Pi=this.placedOrientations[Se.crossTileID];Pi&&(this.markUsedJustification(r,"left",Se,Pi),this.markUsedOrientation(r,Pi,Se))}if(pt){let si=Mh(xe.icon),Xi=!(ge&&Se.verticalPlacedIconSymbolIndex&&ei);Se.placedIconSymbolIndex>=0&&(tt(r.icon,Se.numIconVertices,Xi?si:Hc),r.icon.placedSymbolArray.get(Se.placedIconSymbolIndex).hidden=xe.icon.isHidden()),Se.verticalPlacedIconSymbolIndex>=0&&(tt(r.icon,Se.numVerticalIconVertices,Xi?Hc:si),r.icon.placedSymbolArray.get(Se.verticalPlacedIconSymbolIndex).hidden=xe.icon.isHidden())}let Jt=Xe&&Xe.has(et)?Xe.get(et):{text:null,icon:null};if(r.hasIconCollisionBoxData()||r.hasTextCollisionBoxData()){let si=r.collisionArrays[et];if(si){let Xi=new t.P(0,0);if(si.textBox||si.verticalTextBox){let Ki=!0;if(ne){let Pi=this.variableOffsets[dt];Pi?(Xi=oa(Pi.anchor,Pi.width,Pi.height,Pi.textOffset,Pi.textBoxScale),pe&&Xi._rotate(ue?-this.transform.bearingInRadians:this.transform.bearingInRadians)):Ki=!1}if(si.textBox||si.verticalTextBox){let Pi;si.textBox&&(Pi=ei),si.verticalTextBox&&(Pi=Kt),_s(r.textCollisionBox.collisionVertexArray,xe.text.placed,!Ki||Pi,Jt.text,Xi.x,Xi.y)}}if(si.iconBox||si.verticalIconBox){let Ki=!!(!Kt&&si.verticalIconBox),Pi;si.iconBox&&(Pi=Ki),si.verticalIconBox&&(Pi=!Ki),_s(r.iconCollisionBox.collisionVertexArray,xe.icon.placed,Pi,Jt.icon,ge?Xi.x:0,ge?Xi.y:0)}}}}if(r.sortFeatures(-this.transform.bearingInRadians),this.retainedQueryData[r.bucketInstanceId]&&(this.retainedQueryData[r.bucketInstanceId].featureSortOrder=r.featureSortOrder),r.hasTextData()&&r.text.opacityVertexBuffer&&r.text.opacityVertexBuffer.updateData(r.text.opacityVertexArray),r.hasIconData()&&r.icon.opacityVertexBuffer&&r.icon.opacityVertexBuffer.updateData(r.icon.opacityVertexArray),r.hasIconCollisionBoxData()&&r.iconCollisionBox.collisionVertexBuffer&&r.iconCollisionBox.collisionVertexBuffer.updateData(r.iconCollisionBox.collisionVertexArray),r.hasTextCollisionBoxData()&&r.textCollisionBox.collisionVertexBuffer&&r.textCollisionBox.collisionVertexBuffer.updateData(r.textCollisionBox.collisionVertexArray),r.text.opacityVertexArray.length!==r.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${r.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${r.text.layoutVertexArray.length}) / 4`);if(r.icon.opacityVertexArray.length!==r.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${r.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${r.icon.layoutVertexArray.length}) / 4`);r.bucketInstanceId in this.collisionCircleArrays&&(r.collisionCircleArray=this.collisionCircleArrays[r.bucketInstanceId],delete this.collisionCircleArrays[r.bucketInstanceId])}symbolFadeChange(r){return this.fadeDuration===0?1:(r-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(r){return Math.max(0,(this.transform.zoom-r)/1.5)}hasTransitions(r){return this.stale||r-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(r,h){let x=this.zoomAtLastRecencyCheck===h?1-this.zoomAdjustment(h):1;return this.zoomAtLastRecencyCheck=h,this.commitTime+this.fadeDuration*x>r}setStale(){this.stale=!0}}function _s(M,r,h,x,w,A){x&&x.length!==0||(x=[0,0,0,0]);let k=x[0]-Un,j=x[1]-Un,q=x[2]-Un,J=x[3]-Un;M.emplaceBack(r?1:0,h?1:0,w||0,A||0,k,j),M.emplaceBack(r?1:0,h?1:0,w||0,A||0,q,j),M.emplaceBack(r?1:0,h?1:0,w||0,A||0,q,J),M.emplaceBack(r?1:0,h?1:0,w||0,A||0,k,J)}let ls=Math.pow(2,25),wa=Math.pow(2,24),Eh=Math.pow(2,17),Ru=Math.pow(2,16),ou=Math.pow(2,9),Wc=Math.pow(2,8),zu=Math.pow(2,1);function Mh(M){if(M.opacity===0&&!M.placed)return 0;if(M.opacity===1&&M.placed)return 4294967295;let r=M.placed?1:0,h=Math.floor(127*M.opacity);return h*ls+r*wa+h*Eh+r*Ru+h*ou+r*Wc+h*zu+r}let Hc=0;class af{constructor(r){this._sortAcrossTiles=r.layout.get("symbol-z-order")!=="viewport-y"&&!r.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(r,h,x,w,A){let k=this._bucketParts;for(;this._currentTileIndex<r.length;)if(h.getBucketParts(k,w,r[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,A())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,k.sort((j,q)=>j.sortKey-q.sortKey));this._currentPartIndex<k.length;)if(h.placeLayerBucketPart(k[this._currentPartIndex],this._seenCrossTileIDs,x),this._currentPartIndex++,A())return!0;return!1}}class Ml{constructor(r,h,x,w,A,k,j,q){this.placement=new Es(r,h,k,j,q),this._currentPlacementIndex=x.length-1,this._forceFullPlacement=w,this._showCollisionBoxes=A,this._done=!1}isDone(){return this._done}continuePlacement(r,h,x){let w=an.now(),A=()=>!this._forceFullPlacement&&an.now()-w>2;for(;this._currentPlacementIndex>=0;){let k=h[r[this._currentPlacementIndex]],j=this.placement.collisionIndex.transform.zoom;if(k.type==="symbol"&&(!k.minzoom||k.minzoom<=j)&&(!k.maxzoom||k.maxzoom>j)){if(this._inProgressLayer||(this._inProgressLayer=new af(k)),this._inProgressLayer.continuePlacement(x[k.source],this.placement,this._showCollisionBoxes,k,A))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(r){return this.placement.commit(r),this.placement}}let Ph=512/t.$/2;class Ra{constructor(r,h,x){this.tileID=r,this.bucketInstanceId=x,this._symbolsByKey={};let w=new Map;for(let A=0;A<h.length;A++){let k=h.get(A),j=k.key,q=w.get(j);q?q.push(k):w.set(j,[k])}for(let[A,k]of w){let j={positions:k.map(q=>({x:Math.floor(q.anchorX*Ph),y:Math.floor(q.anchorY*Ph)})),crossTileIDs:k.map(q=>q.crossTileID)};if(j.positions.length>128){let q=new t.aH(j.positions.length,16,Uint16Array);for(let{x:J,y:ne}of j.positions)q.add(J,ne);q.finish(),delete j.positions,j.index=q}this._symbolsByKey[A]=j}}getScaledCoordinates(r,h){let{x,y:w,z:A}=this.tileID.canonical,{x:k,y:j,z:q}=h.canonical,J=Ph/Math.pow(2,q-A),ne=(j*t.$+r.anchorY)*J,pe=w*t.$*Ph;return{x:Math.floor((k*t.$+r.anchorX)*J-x*t.$*Ph),y:Math.floor(ne-pe)}}findMatches(r,h,x){let w=this.tileID.canonical.z<h.canonical.z?1:Math.pow(2,this.tileID.canonical.z-h.canonical.z);for(let A=0;A<r.length;A++){let k=r.get(A);if(k.crossTileID)continue;let j=this._symbolsByKey[k.key];if(!j)continue;let q=this.getScaledCoordinates(k,h);if(j.index){let J=j.index.range(q.x-w,q.y-w,q.x+w,q.y+w).sort();for(let ne of J){let pe=j.crossTileIDs[ne];if(!x[pe]){x[pe]=!0,k.crossTileID=pe;break}}}else if(j.positions)for(let J=0;J<j.positions.length;J++){let ne=j.positions[J],pe=j.crossTileIDs[J];if(Math.abs(ne.x-q.x)<=w&&Math.abs(ne.y-q.y)<=w&&!x[pe]){x[pe]=!0,k.crossTileID=pe;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map(({crossTileIDs:r})=>r)}}class _l{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class xc{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(r){let h=Math.round((r-this.lng)/360);if(h!==0)for(let x in this.indexes){let w=this.indexes[x],A={};for(let k in w){let j=w[k];j.tileID=j.tileID.unwrapTo(j.tileID.wrap+h),A[j.tileID.key]=j}this.indexes[x]=A}this.lng=r}addBucket(r,h,x){if(this.indexes[r.overscaledZ]&&this.indexes[r.overscaledZ][r.key]){if(this.indexes[r.overscaledZ][r.key].bucketInstanceId===h.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(r.overscaledZ,this.indexes[r.overscaledZ][r.key])}for(let A=0;A<h.symbolInstances.length;A++)h.symbolInstances.get(A).crossTileID=0;this.usedCrossTileIDs[r.overscaledZ]||(this.usedCrossTileIDs[r.overscaledZ]={});let w=this.usedCrossTileIDs[r.overscaledZ];for(let A in this.indexes){let k=this.indexes[A];if(Number(A)>r.overscaledZ)for(let j in k){let q=k[j];q.tileID.isChildOf(r)&&q.findMatches(h.symbolInstances,r,w)}else{let j=k[r.scaledTo(Number(A)).key];j&&j.findMatches(h.symbolInstances,r,w)}}for(let A=0;A<h.symbolInstances.length;A++){let k=h.symbolInstances.get(A);k.crossTileID||(k.crossTileID=x.generate(),w[k.crossTileID]=!0)}return this.indexes[r.overscaledZ]===void 0&&(this.indexes[r.overscaledZ]={}),this.indexes[r.overscaledZ][r.key]=new Ra(r,h.symbolInstances,h.bucketInstanceId),!0}removeBucketCrossTileIDs(r,h){for(let x of h.getCrossTileIDsLists())for(let w of x)delete this.usedCrossTileIDs[r][w]}removeStaleBuckets(r){let h=!1;for(let x in this.indexes){let w=this.indexes[x];for(let A in w)r[w[A].bucketInstanceId]||(this.removeBucketCrossTileIDs(x,w[A]),delete w[A],h=!0)}return h}}class al{constructor(){this.layerIndexes={},this.crossTileIDs=new _l,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(r,h,x){let w=this.layerIndexes[r.id];w===void 0&&(w=this.layerIndexes[r.id]=new xc);let A=!1,k={};w.handleWrapJump(x);for(let j of h){let q=j.getBucket(r);q&&r.id===q.layerIds[0]&&(q.bucketInstanceId||(q.bucketInstanceId=++this.maxBucketInstanceId),w.addBucket(j.tileID,q,this.crossTileIDs)&&(A=!0),k[q.bucketInstanceId]=!0)}return w.removeStaleBuckets(k)&&(A=!0),A}pruneUnusedLayers(r){let h={};r.forEach(x=>{h[x]=!0});for(let x in this.layerIndexes)h[x]||delete this.layerIndexes[x]}}var Pl="void main() {fragColor=vec4(1.0);}";let Ms={prelude:Ir(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
out highp vec4 fragColor;`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}mat3 rotationMatrixFromAxisAngle(vec3 u,float angle) {float c=cos(angle);float s=sin(angle);float c2=1.0-c;return mat3(u.x*u.x*c2+      c,u.x*u.y*c2-u.z*s,u.x*u.z*c2+u.y*s,u.y*u.x*c2+u.z*s,u.y*u.y*c2+    c,u.y*u.z*c2-u.x*s,u.z*u.x*c2-u.y*s,u.z*u.y*c2+u.x*s,u.z*u.z*c2+    c
);}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
#ifdef GLOBE
if ((pos.y <-32767.5) || (pos.y > 32766.5)) {return 0.0;}
#endif
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}const float PI=3.141592653589793;uniform mat4 u_projection_matrix;`),projectionMercator:Ir("","float projectLineThickness(float tileY) {return 1.0;}float projectCircleRadius(float tileY) {return 1.0;}vec4 projectTile(vec2 p) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);return result;}vec4 projectTile(vec2 p,vec2 rawPos) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);if (rawPos.y <-32767.5 || rawPos.y > 32766.5) {result.z=-10000000.0;}return result;}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_projection_matrix*vec4(posInTile,elevation,1.0);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {return projectTileWithElevation(posInTile,elevation);}"),projectionGlobe:Ir("",`#define GLOBE_RADIUS 6371008.8
uniform highp vec4 u_projection_tile_mercator_coords;uniform highp vec4 u_projection_clipping_plane;uniform highp float u_projection_transition;uniform mat4 u_projection_fallback_matrix;vec3 globeRotateVector(vec3 vec,vec2 angles) {vec3 axisRight=vec3(vec.z,0.0,-vec.x);vec3 axisUp=cross(axisRight,vec);axisRight=normalize(axisRight);axisUp=normalize(axisUp);vec2 t=tan(angles);return normalize(vec+axisRight*t.x+axisUp*t.y);}mat3 globeGetRotationMatrix(vec3 spherePos) {vec3 axisRight=vec3(spherePos.z,0.0,-spherePos.x);vec3 axisDown=cross(axisRight,spherePos);axisRight=normalize(axisRight);axisDown=normalize(axisDown);return mat3(axisRight,axisDown,spherePos
);}float circumferenceRatioAtTileY(float tileY) {float mercator_pos_y=u_projection_tile_mercator_coords.y+u_projection_tile_mercator_coords.w*tileY;float spherical_y=2.0*atan(exp(PI-(mercator_pos_y*PI*2.0)))-PI*0.5;return cos(spherical_y);}float projectLineThickness(float tileY) {float thickness=1.0/circumferenceRatioAtTileY(tileY); 
if (u_projection_transition < 0.999) {return mix(1.0,thickness,u_projection_transition);} else {return thickness;}}vec3 projectToSphere(vec2 translatedPos,vec2 rawPos) {vec2 mercator_pos=u_projection_tile_mercator_coords.xy+u_projection_tile_mercator_coords.zw*translatedPos;vec2 spherical;spherical.x=mercator_pos.x*PI*2.0+PI;spherical.y=2.0*atan(exp(PI-(mercator_pos.y*PI*2.0)))-PI*0.5;float len=cos(spherical.y);vec3 pos=vec3(sin(spherical.x)*len,sin(spherical.y),cos(spherical.x)*len
);if (rawPos.y <-32767.5) {pos=vec3(0.0,1.0,0.0);}if (rawPos.y > 32766.5) {pos=vec3(0.0,-1.0,0.0);}return pos;}vec3 projectToSphere(vec2 posInTile) {return projectToSphere(posInTile,vec2(0.0,0.0));}float globeComputeClippingZ(vec3 spherePos) {return (1.0-(dot(spherePos,u_projection_clipping_plane.xyz)+u_projection_clipping_plane.w));}vec4 interpolateProjection(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);globePosition.z=globeComputeClippingZ(elevatedPos)*globePosition.w;if (u_projection_transition > 0.999) {return globePosition;}vec4 flatPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);const float z_globeness_threshold=0.2;vec4 result=globePosition;result.z=mix(0.0,globePosition.z,clamp((u_projection_transition-z_globeness_threshold)/(1.0-z_globeness_threshold),0.0,1.0));result.xyw=mix(flatPosition.xyw,globePosition.xyw,u_projection_transition);if ((posInTile.y <-32767.5) || (posInTile.y > 32766.5)) {result=globePosition;const float poles_hidden_anim_percentage=0.02;result.z=mix(globePosition.z,100.0,pow(max((1.0-u_projection_transition)/poles_hidden_anim_percentage,0.0),8.0));}return result;}vec4 interpolateProjectionFor3D(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);if (u_projection_transition > 0.999) {return globePosition;}vec4 fallbackPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);return mix(fallbackPosition,globePosition,u_projection_transition);}vec4 projectTile(vec2 posInTile) {return interpolateProjection(posInTile,projectToSphere(posInTile),0.0);}vec4 projectTile(vec2 posInTile,vec2 rawPos) {return interpolateProjection(posInTile,projectToSphere(posInTile,rawPos),0.0);}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return interpolateProjection(posInTile,projectToSphere(posInTile),elevation);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {vec3 spherePos=projectToSphere(posInTile,posInTile);return interpolateProjectionFor3D(posInTile,spherePos,elevation);}`),background:Ir(`uniform vec4 u_color;uniform float u_opacity;void main() {fragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),backgroundPattern:Ir(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;void main() {gl_Position=projectTile(a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:Ir(`in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);float antialiased_blur=v_data.z;float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));fragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);const float epsilon=0.5/255.0;if (fragColor.r < epsilon && fragColor.g < epsilon && fragColor.b < epsilon && fragColor.a < epsilon) {discard;}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform highp float u_globe_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;uniform vec2 u_translate;in vec2 a_pos;out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 pos_raw=a_pos+32768.0;vec2 extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);vec2 circle_center=floor(pos_raw/8.0)+u_translate;float ele=get_elevation(circle_center);v_visibility=calculate_visibility(projectTileWithElevation(circle_center,ele));if (u_pitch_with_map) {
#ifdef GLOBE
vec3 center_vector=projectToSphere(circle_center);
#endif
float angle_scale=u_globe_extrude_scale;vec2 corner_position=circle_center;if (u_scale_with_map) {angle_scale*=(radius+stroke_width);corner_position+=extrude*u_extrude_scale*(radius+stroke_width);} else {
#ifdef GLOBE
vec4 projected_center=interpolateProjection(circle_center,center_vector,ele);
#else
vec4 projected_center=projectTileWithElevation(circle_center,ele);
#endif
corner_position+=extrude*u_extrude_scale*(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);angle_scale*=(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);}
#ifdef GLOBE
vec2 angles=extrude*angle_scale;vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(corner_position,corner_vector,ele);
#else
gl_Position=projectTileWithElevation(corner_position,ele);
#endif
} else {gl_Position=projectTileWithElevation(circle_center,ele);if (gl_Position.z/gl_Position.w > 1.0) {gl_Position.xy=vec2(10000.0);}if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}float antialiasblur=-max(1.0/u_device_pixel_ratio/(radius+stroke_width),blur);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:Ir(Pl,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),heatmap:Ir(`uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);fragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;uniform highp float u_globe_extrude_scale;in vec2 a_pos;out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 pos_raw=a_pos+32768.0;vec2 unscaled_extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 circle_center=floor(pos_raw/8.0);
#ifdef GLOBE
vec2 angles=v_extrude*radius*u_globe_extrude_scale;vec3 center_vector=projectToSphere(circle_center);vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(circle_center+extrude,corner_vector,0.0);
#else
gl_Position=projectTileFor3D(circle_center+extrude,get_elevation(circle_center));
#endif
}`),heatmapTexture:Ir(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));fragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:Ir("in float v_placed;in float v_notUsed;void main() {float alpha=0.5;fragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {fragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {fragColor*=.1;}}","in vec2 a_anchor_pos;in vec2 a_placed;in vec2 a_box_real;uniform vec2 u_pixel_extrude_scale;out float v_placed;out float v_notUsed;void main() {gl_Position=projectTileWithElevation(a_anchor_pos,get_elevation(a_anchor_pos));gl_Position.xy=((a_box_real+0.5)*u_pixel_extrude_scale*2.0-1.0)*vec2(1.0,-1.0)*gl_Position.w;if (gl_Position.z/gl_Position.w < 1.1) {gl_Position.z=0.5;}v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:Ir("in float v_radius;in vec2 v_extrude;in float v_collision;void main() {float alpha=0.5;float stroke_radius=0.9;float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);fragColor=color*alpha*opacity_t;}","in vec2 a_pos;in float a_radius;in vec2 a_flags;uniform vec2 u_viewport_size;out float v_radius;out vec2 v_extrude;out float v_collision;void main() {float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_collision=collision;gl_Position=vec4((a_pos/u_viewport_size*2.0-1.0)*vec2(1.0,-1.0),0.0,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),colorRelief:Ir(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;uniform vec4 u_unpack;uniform sampler2D u_elevation_stops;uniform sampler2D u_color_stops;uniform float u_opacity;in vec2 v_pos;float getElevation(vec2 coord) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack);}float getElevationStop(int stop) {float x=(float(stop)+0.5)/float(textureSize(u_elevation_stops,0)[0]);vec4 data=texture(u_elevation_stops,vec2(x,0))*255.0;data.a=-1.0;return dot(data,u_unpack);}void main() {float el=getElevation(v_pos);int num_elevation_stops=textureSize(u_elevation_stops,0)[0];int r=(num_elevation_stops-1);int l=0;float el_l=getElevationStop(l);float el_r=getElevationStop(r);while(r-l > 1){int m=(r+l)/2;float el_m=getElevationStop(m);if(el < el_m){r=m;el_r=el_m;}else
{l=m;el_l=el_m;}}float x=(float(l)+(el-el_l)/(el_r-el_l)+0.5)/float(textureSize(u_color_stops,0)[0]);fragColor=u_opacity*texture(u_color_stops,vec2(x,0));
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_dimension;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_pos/8192.0)*scale+epsilon;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),debug:Ir("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);fragColor=mix(u_color,overlay_color,overlay_color.a);}","in vec2 a_pos;out vec2 v_uv;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=projectTileWithElevation(a_pos*u_overlay_scale,get_elevation(a_pos));}"),depth:Ir(Pl,`in vec2 a_pos;void main() {
#ifdef GLOBE
gl_Position=projectTileFor3D(a_pos,0.0);
#else
gl_Position=u_projection_matrix*vec4(a_pos,0.0,1.0);
#endif
}`),fill:Ir(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
fragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_fill_translate;in vec2 a_pos;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);}`),fillOutline:Ir(`in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=outline_color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillOutlinePattern:Ir(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;in vec2 v_pos_a;in vec2 v_pos_b;in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillPattern:Ir(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:Ir(`in vec4 v_color;void main() {fragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
out vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;vec3 normalForLighting=normal/16384.0;float directional=clamp(dot(normalForLighting,u_lightpos),0.0,1.0);
#ifdef GLOBE
mat3 rotMatrix=globeGetRotationMatrix(spherePos);normalForLighting=rotMatrix*normalForLighting;directional=mix(directional,clamp(dot(normalForLighting,u_lightpos_globe),0.0,1.0),u_projection_transition);
#endif
directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:Ir(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;in vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);fragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
#ifdef GLOBE
out vec3 v_sphere_pos;
#endif
out vec2 v_pos_a;out vec2 v_pos_b;out vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);v_sphere_pos=elevatedPos;gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,elevation*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:Ir(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack);}void main() {vec2 epsilon=1.0/u_dimension;float tileSize=u_dimension.x-2.0;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))*tileSize/pow(2.0,exaggeration+(28.2562-u_zoom));fragColor=clamp(vec4(deriv.x/8.0+0.5,deriv.y/8.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Ir(`uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform float u_exaggeration;uniform vec4 u_accent;uniform int u_method;uniform float u_altitudes[NUM_ILLUMINATION_SOURCES];uniform float u_azimuths[NUM_ILLUMINATION_SOURCES];uniform vec4 u_shadows[NUM_ILLUMINATION_SOURCES];uniform vec4 u_highlights[NUM_ILLUMINATION_SOURCES];
#define PI 3.141592653589793
#define STANDARD 0
#define COMBINED 1
#define IGOR 2
#define MULTIDIRECTIONAL 3
#define BASIC 4
float get_aspect(vec2 deriv){return deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);}void igor_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float aspect=get_aspect(deriv);float azimuth=u_azimuths[0]+PI;float slope_stength=atan(length(deriv))*2.0/PI;float aspect_strength=1.0-abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);float shadow_strength=slope_stength*aspect_strength;float highlight_strength=slope_stength*(1.0-aspect_strength);fragColor=u_shadows[0]*shadow_strength+u_highlights[0]*highlight_strength;}void standard_hillshade(vec2 deriv){float azimuth=u_azimuths[0]+PI;float slope=atan(0.625*length(deriv));float aspect=get_aspect(deriv);float intensity=u_exaggeration;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadows[0],u_highlights[0],shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);fragColor=accent_color*(1.0-shade_color.a)+shade_color;}void basic_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float azimuth=u_azimuths[0]+PI;float cos_az=cos(azimuth);float sin_az=sin(azimuth);float cos_alt=cos(u_altitudes[0]);float sin_alt=sin(u_altitudes[0]);float cang=(sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv));float shade=clamp(cang,0.0,1.0);if(shade > 0.5){fragColor=u_highlights[0]*(2.0*shade-1.0);}else
{fragColor=u_shadows[0]*(1.0-2.0*shade);}}void multidirectional_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;fragColor=vec4(0,0,0,0);for(int i=0; i < NUM_ILLUMINATION_SOURCES; i++){float cos_alt=cos(u_altitudes[i]);float sin_alt=sin(u_altitudes[i]);float cos_az=-cos(u_azimuths[i]);float sin_az=-sin(u_azimuths[i]);float cang=(sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv));float shade=clamp(cang,0.0,1.0);if(shade > 0.5){fragColor+=u_highlights[i]*(2.0*shade-1.0)/float(NUM_ILLUMINATION_SOURCES);}else
{fragColor+=u_shadows[i]*(1.0-2.0*shade)/float(NUM_ILLUMINATION_SOURCES);}}}void combined_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float azimuth=u_azimuths[0]+PI;float cos_az=cos(azimuth);float sin_az=sin(azimuth);float cos_alt=cos(u_altitudes[0]);float sin_alt=sin(u_altitudes[0]);float cang=acos((sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv)));cang=clamp(cang,0.0,PI/2.0);float shade=cang*atan(length(deriv))*4.0/PI/PI;float highlight=(PI/2.0-cang)*atan(length(deriv))*4.0/PI/PI;fragColor=u_shadows[0]*shade+u_highlights[0]*highlight;}void main() {vec4 pixel=texture(u_image,v_pos);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));vec2 deriv=((pixel.rg*8.0)-4.0)/scaleFactor;switch(u_method){case BASIC:
basic_hillshade(deriv);break;case COMBINED:
combined_hillshade(deriv);break;case IGOR:
igor_hillshade(deriv);break;case MULTIDIRECTIONAL:
multidirectional_hillshade(deriv);break;case STANDARD:
default:
standard_hillshade(deriv);break;}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);v_pos=a_pos/8192.0;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),line:Ir(`uniform lowp float u_device_pixel_ratio;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp float v_linesofar;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:Ir(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec2 v_uv;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture(u_image,v_uv);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;in float a_uv_x;in float a_split_index;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec2 v_uv;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:Ir(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture(u_image,pos_a),texture(u_image,pos_b),u_fade);fragColor=color*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:Ir(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;in vec2 v_normal;in vec2 v_width2;in vec2 v_tex_a;in vec2 v_tex_b;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture(u_image,v_tex_a).a;float sdfdist_b=texture(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;out vec2 v_normal;out vec2 v_width2;out vec2 v_tex_a;out vec2 v_tex_b;out float v_gamma_scale;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}`),raster:Ir(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;in vec2 v_pos0;in vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture(u_image0,v_pos0);vec4 color1=texture(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);fragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;uniform vec4 u_coords_top;uniform vec4 u_coords_bottom;in vec2 a_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {vec2 fractionalPos=a_pos/8192.0;vec2 position=mix(mix(u_coords_top.xy,u_coords_top.zw,fractionalPos.x),mix(u_coords_bottom.xy,u_coords_bottom.zw,fractionalPos.x),fractionalPos.y);gl_Position=projectTile(position,position);v_pos0=((fractionalPos-0.5)/u_buffer_scale)+0.5;
#ifdef GLOBE
if (a_pos.y <-32767.5) {v_pos0.y=0.0;}if (a_pos.y > 32766.5) {v_pos0.y=1.0;}
#endif
v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),symbolIcon:Ir(`uniform sampler2D u_texture;in vec2 v_tex;in float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;fragColor=texture(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_tex;out float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}gl_Position=finalPos;v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:Ir(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;in vec2 v_data0;in vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_data0;out vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:Ir(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;in vec4 v_data0;in vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;fragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec4 v_data0;out vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map && !u_is_along_line) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:Ir("uniform sampler2D u_texture;uniform vec4 u_fog_color;uniform vec4 u_horizon_color;uniform float u_fog_ground_blend;uniform float u_fog_ground_blend_opacity;uniform float u_horizon_fog_blend;uniform bool u_is_globe_mode;in vec2 v_texture_pos;in float v_fog_depth;const float gamma=2.2;vec4 gammaToLinear(vec4 color) {return pow(color,vec4(gamma));}vec4 linearToGamma(vec4 color) {return pow(color,vec4(1.0/gamma));}void main() {vec4 surface_color=texture(u_texture,vec2(v_texture_pos.x,1.0-v_texture_pos.y));if (!u_is_globe_mode && v_fog_depth > u_fog_ground_blend) {vec4 surface_color_linear=gammaToLinear(surface_color);float blend_color=smoothstep(0.0,1.0,max((v_fog_depth-u_horizon_fog_blend)/(1.0-u_horizon_fog_blend),0.0));vec4 fog_horizon_color_linear=mix(gammaToLinear(u_fog_color),gammaToLinear(u_horizon_color),blend_color);float factor_fog=max(v_fog_depth-u_fog_ground_blend,0.0)/(1.0-u_fog_ground_blend);fragColor=linearToGamma(mix(surface_color_linear,fog_horizon_color_linear,pow(factor_fog,2.0)*u_fog_ground_blend_opacity));} else {fragColor=surface_color;}}","in vec3 a_pos3d;uniform mat4 u_fog_matrix;uniform float u_ele_delta;out vec2 v_texture_pos;out float v_fog_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta);vec4 pos=u_fog_matrix*vec4(a_pos3d.xy,ele,1.0);v_fog_depth=pos.z/pos.w*0.5+0.5;}"),terrainDepth:Ir("in float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {fragColor=pack(v_depth);}","in vec3 a_pos3d;uniform float u_ele_delta;out float v_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);v_depth=gl_Position.z/gl_Position.w;}"),terrainCoords:Ir("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;in vec2 v_texture_pos;void main() {vec4 rgba=texture(u_texture,v_texture_pos);fragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}","in vec3 a_pos3d;uniform float u_ele_delta;out vec2 v_texture_pos;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);}"),projectionErrorMeasurement:Ir("in vec4 v_output_error_encoded;void main() {fragColor=v_output_error_encoded;}","in vec2 a_pos;uniform highp float u_input;uniform highp float u_output_expected;out vec4 v_output_error_encoded;void main() {float real_output=2.0*atan(exp(PI-(u_input*PI*2.0)))-PI*0.5;float error=real_output-u_output_expected;float abs_error=abs(error)*128.0;v_output_error_encoded.x=min(floor(abs_error*256.0),255.0)/255.0;abs_error-=v_output_error_encoded.x;v_output_error_encoded.y=min(floor(abs_error*65536.0),255.0)/255.0;abs_error-=v_output_error_encoded.x/255.0;v_output_error_encoded.z=min(floor(abs_error*16777216.0),255.0)/255.0;v_output_error_encoded.w=error >=0.0 ? 1.0 : 0.0;gl_Position=vec4(a_pos,0.0,1.0);}"),atmosphere:Ir(`in vec3 view_direction;uniform vec3 u_sun_pos;uniform vec3 u_globe_position;uniform float u_globe_radius;uniform float u_atmosphere_blend;/**Shader use from https:*Made some change to adapt to MapLibre Globe geometry*/const float PI=3.141592653589793;const int iSteps=5;const int jSteps=3;/*radius of the planet*/const float EARTH_RADIUS=6371e3;/*radius of the atmosphere*/const float ATMOS_RADIUS=6471e3;vec2 rsi(vec3 r0,vec3 rd,float sr) {float a=dot(rd,rd);float b=2.0*dot(rd,r0);float c=dot(r0,r0)-(sr*sr);float d=(b*b)-4.0*a*c;if (d < 0.0) return vec2(1e5,-1e5);return vec2((-b-sqrt(d))/(2.0*a),(-b+sqrt(d))/(2.0*a));}vec4 atmosphere(vec3 r,vec3 r0,vec3 pSun,float iSun,float rPlanet,float rAtmos,vec3 kRlh,float kMie,float shRlh,float shMie,float g) {pSun=normalize(pSun);r=normalize(r);vec2 p=rsi(r0,r,rAtmos);if (p.x > p.y) {return vec4(0.0,0.0,0.0,1.0);}if (p.x < 0.0) {p.x=0.0;}vec3 pos=r0+r*p.x;vec2 p2=rsi(r0,r,rPlanet);if (p2.x <=p2.y && p2.x > 0.0) {p.y=min(p.y,p2.x);}float iStepSize=(p.y-p.x)/float(iSteps);float iTime=p.x+iStepSize*0.5;vec3 totalRlh=vec3(0,0,0);vec3 totalMie=vec3(0,0,0);float iOdRlh=0.0;float iOdMie=0.0;float mu=dot(r,pSun);float mumu=mu*mu;float gg=g*g;float pRlh=3.0/(16.0*PI)*(1.0+mumu);float pMie=3.0/(8.0*PI)*((1.0-gg)*(mumu+1.0))/(pow(1.0+gg-2.0*mu*g,1.5)*(2.0+gg));for (int i=0; i < iSteps; i++) {vec3 iPos=r0+r*iTime;float iHeight=length(iPos)-rPlanet;float odStepRlh=exp(-iHeight/shRlh)*iStepSize;float odStepMie=exp(-iHeight/shMie)*iStepSize;iOdRlh+=odStepRlh;iOdMie+=odStepMie;float jStepSize=rsi(iPos,pSun,rAtmos).y/float(jSteps);float jTime=jStepSize*0.5;float jOdRlh=0.0;float jOdMie=0.0;for (int j=0; j < jSteps; j++) {vec3 jPos=iPos+pSun*jTime;float jHeight=length(jPos)-rPlanet;jOdRlh+=exp(-jHeight/shRlh)*jStepSize;jOdMie+=exp(-jHeight/shMie)*jStepSize;jTime+=jStepSize;}vec3 attn=exp(-(kMie*(iOdMie+jOdMie)+kRlh*(iOdRlh+jOdRlh)));totalRlh+=odStepRlh*attn;totalMie+=odStepMie*attn;iTime+=iStepSize;}float opacity=exp(-(length(kRlh)*length(totalRlh)+kMie*length(totalMie)));vec3 color=iSun*(pRlh*kRlh*totalRlh+pMie*kMie*totalMie);return vec4(color,opacity);}void main() {vec3 scale_camera_pos=-u_globe_position*EARTH_RADIUS/u_globe_radius;vec4 color=atmosphere(normalize(view_direction),scale_camera_pos,u_sun_pos,22.0,EARTH_RADIUS,ATMOS_RADIUS,vec3(5.5e-6,13.0e-6,22.4e-6),21e-6,8e3,1.2e3,0.758
);color.rgb=1.0-exp(-1.0*color.rgb);color=pow(color,vec4(1.0/2.2));fragColor=vec4(color.rgb,1.0-color.a)*u_atmosphere_blend;}`,"in vec2 a_pos;uniform mat4 u_inv_proj_matrix;out vec3 view_direction;void main() {view_direction=(u_inv_proj_matrix*vec4(a_pos,0.0,1.0)).xyz;gl_Position=vec4(a_pos,0.0,1.0);}"),sky:Ir("uniform vec4 u_sky_color;uniform vec4 u_horizon_color;uniform vec2 u_horizon;uniform vec2 u_horizon_normal;uniform float u_sky_horizon_blend;uniform float u_sky_blend;void main() {float x=gl_FragCoord.x;float y=gl_FragCoord.y;float blend=(y-u_horizon.y)*u_horizon_normal.y+(x-u_horizon.x)*u_horizon_normal.x;if (blend > 0.0) {if (blend < u_sky_horizon_blend) {fragColor=mix(u_sky_color,u_horizon_color,pow(1.0-blend/u_sky_horizon_blend,2.0));} else {fragColor=u_sky_color;}}fragColor=mix(fragColor,vec4(vec3(0.0),0.0),u_sky_blend);}","in vec2 a_pos;void main() {gl_Position=vec4(a_pos,1.0,1.0);}")};function Ir(M,r){let h=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,x=r.match(/in ([\w]+) ([\w]+)/g),w=M.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),A=r.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),k=A?A.concat(w):w,j={};return{fragmentSource:M=M.replace(h,(q,J,ne,pe,ue)=>(j[ue]=!0,J==="define"?`
#ifndef HAS_UNIFORM_u_${ue}
in ${ne} ${pe} ${ue};
#else
uniform ${ne} ${pe} u_${ue};
#endif
`:`
#ifdef HAS_UNIFORM_u_${ue}
    ${ne} ${pe} ${ue} = u_${ue};
#endif
`)),vertexSource:r=r.replace(h,(q,J,ne,pe,ue)=>{let ge=pe==="float"?"vec2":"vec4",Ee=ue.match(/color/)?"color":ge;return j[ue]?J==="define"?`
#ifndef HAS_UNIFORM_u_${ue}
uniform lowp float u_${ue}_t;
in ${ne} ${ge} a_${ue};
out ${ne} ${pe} ${ue};
#else
uniform ${ne} ${pe} u_${ue};
#endif
`:Ee==="vec4"?`
#ifndef HAS_UNIFORM_u_${ue}
    ${ue} = a_${ue};
#else
    ${ne} ${pe} ${ue} = u_${ue};
#endif
`:`
#ifndef HAS_UNIFORM_u_${ue}
    ${ue} = unpack_mix_${Ee}(a_${ue}, u_${ue}_t);
#else
    ${ne} ${pe} ${ue} = u_${ue};
#endif
`:J==="define"?`
#ifndef HAS_UNIFORM_u_${ue}
uniform lowp float u_${ue}_t;
in ${ne} ${ge} a_${ue};
#else
uniform ${ne} ${pe} u_${ue};
#endif
`:Ee==="vec4"?`
#ifndef HAS_UNIFORM_u_${ue}
    ${ne} ${pe} ${ue} = a_${ue};
#else
    ${ne} ${pe} ${ue} = u_${ue};
#endif
`:`
#ifndef HAS_UNIFORM_u_${ue}
    ${ne} ${pe} ${ue} = unpack_mix_${Ee}(a_${ue}, u_${ue}_t);
#else
    ${ne} ${pe} ${ue} = u_${ue};
#endif
`}),staticAttributes:x,staticUniforms:k}}class ec{constructor(r,h,x){this.vertexBuffer=r,this.indexBuffer=h,this.segments=x}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.vertexBuffer=null,this.indexBuffer=null,this.segments=null}}var Ta=t.aI([{name:"a_pos",type:"Int16",components:2}]);let tc="#define PROJECTION_MERCATOR",Id="mercator";class su{constructor(){this._cachedMesh=null}get name(){return"mercator"}get useSubdivision(){return!1}get shaderVariantName(){return Id}get shaderDefine(){return tc}get shaderPreludeCode(){return Ms.projectionMercator}get vertexShaderPreludeCode(){return Ms.projectionMercator.vertexSource}get subdivisionGranularity(){return t.aJ.noSubdivision}get useGlobeControls(){return!1}get transitionState(){return 0}get latitudeErrorCorrectionRadians(){return 0}destroy(){}updateGPUdependent(r){}getMeshFromTileID(r,h,x,w,A){if(this._cachedMesh)return this._cachedMesh;let k=new t.aK;k.emplaceBack(0,0),k.emplaceBack(t.$,0),k.emplaceBack(0,t.$),k.emplaceBack(t.$,t.$);let j=r.createVertexBuffer(k,Ta.members),q=t.aL.simpleSegment(0,0,4,2),J=new t.aM;J.emplaceBack(1,0,2),J.emplaceBack(1,2,3);let ne=r.createIndexBuffer(J);return this._cachedMesh=new ec(j,ne,q),this._cachedMesh}recalculate(){}hasTransition(){return!1}setErrorQueryLatitudeDegrees(r){}}class Uo{constructor(r=0,h=0,x=0,w=0){if(isNaN(r)||r<0||isNaN(h)||h<0||isNaN(x)||x<0||isNaN(w)||w<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=r,this.bottom=h,this.left=x,this.right=w}interpolate(r,h,x){return h.top!=null&&r.top!=null&&(this.top=t.C.number(r.top,h.top,x)),h.bottom!=null&&r.bottom!=null&&(this.bottom=t.C.number(r.bottom,h.bottom,x)),h.left!=null&&r.left!=null&&(this.left=t.C.number(r.left,h.left,x)),h.right!=null&&r.right!=null&&(this.right=t.C.number(r.right,h.right,x)),this}getCenter(r,h){let x=t.ag((this.left+r-this.right)/2,0,r),w=t.ag((this.top+h-this.bottom)/2,0,h);return new t.P(x,w)}equals(r){return this.top===r.top&&this.bottom===r.bottom&&this.left===r.left&&this.right===r.right}clone(){return new Uo(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Al(M,r){if(!M.renderWorldCopies||M.lngRange)return;let h=r.lng-M.center.lng;r.lng+=h>180?-360:h<-180?360:0}function Pr(M){return Math.max(0,Math.floor(M))}class vc{constructor(r,h,x,w,A,k){this._callbacks=r,this._tileSize=512,this._renderWorldCopies=k===void 0||!!k,this._minZoom=h||0,this._maxZoom=x||22,this._minPitch=w??0,this._maxPitch=A??60,this.setMaxBounds(),this._width=0,this._height=0,this._center=new t.S(0,0),this._elevation=0,this._zoom=0,this._tileZoom=Pr(this._zoom),this._scale=t.ae(this._zoom),this._bearingInRadians=0,this._fovInRadians=.6435011087932844,this._pitchInRadians=0,this._rollInRadians=0,this._unmodified=!0,this._edgeInsets=new Uo,this._minElevationForCurrentTile=0,this._autoCalculateNearFarZ=!0}apply(r,h,x){this._latRange=r.latRange,this._lngRange=r.lngRange,this._width=r.width,this._height=r.height,this._center=r.center,this._elevation=r.elevation,this._minElevationForCurrentTile=r.minElevationForCurrentTile,this._zoom=r.zoom,this._tileZoom=Pr(this._zoom),this._scale=t.ae(this._zoom),this._bearingInRadians=r.bearingInRadians,this._fovInRadians=r.fovInRadians,this._pitchInRadians=r.pitchInRadians,this._rollInRadians=r.rollInRadians,this._unmodified=r.unmodified,this._edgeInsets=new Uo(r.padding.top,r.padding.bottom,r.padding.left,r.padding.right),this._minZoom=r.minZoom,this._maxZoom=r.maxZoom,this._minPitch=r.minPitch,this._maxPitch=r.maxPitch,this._renderWorldCopies=r.renderWorldCopies,this._cameraToCenterDistance=r.cameraToCenterDistance,this._nearZ=r.nearZ,this._farZ=r.farZ,this._autoCalculateNearFarZ=!x&&r.autoCalculateNearFarZ,h&&this._constrain(),this._calcMatrices()}get pixelsToClipSpaceMatrix(){return this._pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._clipSpaceToPixelsMatrix}get minElevationForCurrentTile(){return this._minElevationForCurrentTile}setMinElevationForCurrentTile(r){this._minElevationForCurrentTile=r}get tileSize(){return this._tileSize}get tileZoom(){return this._tileZoom}get scale(){return this._scale}get width(){return this._width}get height(){return this._height}get bearingInRadians(){return this._bearingInRadians}get lngRange(){return this._lngRange}get latRange(){return this._latRange}get pixelsToGLUnits(){return this._pixelsToGLUnits}get minZoom(){return this._minZoom}setMinZoom(r){this._minZoom!==r&&(this._minZoom=r,this.setZoom(this.getConstrained(this._center,this.zoom).zoom))}get maxZoom(){return this._maxZoom}setMaxZoom(r){this._maxZoom!==r&&(this._maxZoom=r,this.setZoom(this.getConstrained(this._center,this.zoom).zoom))}get minPitch(){return this._minPitch}setMinPitch(r){this._minPitch!==r&&(this._minPitch=r,this.setPitch(Math.max(this.pitch,r)))}get maxPitch(){return this._maxPitch}setMaxPitch(r){this._maxPitch!==r&&(this._maxPitch=r,this.setPitch(Math.min(this.pitch,r)))}get renderWorldCopies(){return this._renderWorldCopies}setRenderWorldCopies(r){r===void 0?r=!0:r===null&&(r=!1),this._renderWorldCopies=r}get worldSize(){return this._tileSize*this._scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new t.P(this._width,this._height)}get bearing(){return this._bearingInRadians/Math.PI*180}setBearing(r){let h=t.aN(r,-180,180)*Math.PI/180;var x,w,A,k,j,q,J,ne,pe;this._bearingInRadians!==h&&(this._unmodified=!1,this._bearingInRadians=h,this._calcMatrices(),this._rotationMatrix=yi(),x=this._rotationMatrix,A=-this._bearingInRadians,k=(w=this._rotationMatrix)[0],j=w[1],q=w[2],J=w[3],ne=Math.sin(A),pe=Math.cos(A),x[0]=k*pe+q*ne,x[1]=j*pe+J*ne,x[2]=k*-ne+q*pe,x[3]=j*-ne+J*pe)}get rotationMatrix(){return this._rotationMatrix}get pitchInRadians(){return this._pitchInRadians}get pitch(){return this._pitchInRadians/Math.PI*180}setPitch(r){let h=t.ag(r,this.minPitch,this.maxPitch)/180*Math.PI;this._pitchInRadians!==h&&(this._unmodified=!1,this._pitchInRadians=h,this._calcMatrices())}get rollInRadians(){return this._rollInRadians}get roll(){return this._rollInRadians/Math.PI*180}setRoll(r){let h=r/180*Math.PI;this._rollInRadians!==h&&(this._unmodified=!1,this._rollInRadians=h,this._calcMatrices())}get fovInRadians(){return this._fovInRadians}get fov(){return t.aO(this._fovInRadians)}setFov(r){r=t.ag(r,.1,150),this.fov!==r&&(this._unmodified=!1,this._fovInRadians=t.ad(r),this._calcMatrices())}get zoom(){return this._zoom}setZoom(r){let h=this.getConstrained(this._center,r).zoom;this._zoom!==h&&(this._unmodified=!1,this._zoom=h,this._tileZoom=Math.max(0,Math.floor(h)),this._scale=t.ae(h),this._constrain(),this._calcMatrices())}get center(){return this._center}setCenter(r){r.lat===this._center.lat&&r.lng===this._center.lng||(this._unmodified=!1,this._center=r,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}setElevation(r){r!==this._elevation&&(this._elevation=r,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}setPadding(r){this._edgeInsets.equals(r)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,r,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this._width,this._height)}get pixelsPerMeter(){return this._pixelPerMeter}get unmodified(){return this._unmodified}get cameraToCenterDistance(){return this._cameraToCenterDistance}get nearZ(){return this._nearZ}get farZ(){return this._farZ}get autoCalculateNearFarZ(){return this._autoCalculateNearFarZ}overrideNearFarZ(r,h){this._autoCalculateNearFarZ=!1,this._nearZ=r,this._farZ=h,this._calcMatrices()}clearNearFarZOverride(){this._autoCalculateNearFarZ=!0,this._calcMatrices()}isPaddingEqual(r){return this._edgeInsets.equals(r)}interpolatePadding(r,h,x){this._unmodified=!1,this._edgeInsets.interpolate(r,h,x),this._constrain(),this._calcMatrices()}resize(r,h,x=!0){this._width=r,this._height=h,x&&this._constrain(),this._calcMatrices()}getMaxBounds(){return this._latRange&&this._latRange.length===2&&this._lngRange&&this._lngRange.length===2?new hr([this._lngRange[0],this._latRange[0]],[this._lngRange[1],this._latRange[1]]):null}setMaxBounds(r){r?(this._lngRange=[r.getWest(),r.getEast()],this._latRange=[r.getSouth(),r.getNorth()],this._constrain()):(this._lngRange=null,this._latRange=[-85.051129,t.ah])}getConstrained(r,h){return this._callbacks.getConstrained(r,h)}getCameraQueryGeometry(r,h){if(h.length===1)return[h[0],r];{let{minX:x,minY:w,maxX:A,maxY:k}=t.a1.fromPoints(h).extend(r);return[new t.P(x,w),new t.P(A,w),new t.P(A,k),new t.P(x,k),new t.P(x,w)]}}_constrain(){if(!this.center||!this._width||!this._height||this._constraining)return;this._constraining=!0;let r=this._unmodified,{center:h,zoom:x}=this.getConstrained(this.center,this.zoom);this.setCenter(h),this.setZoom(x),this._unmodified=r,this._constraining=!1}_calcMatrices(){if(this._width&&this._height){this._pixelsToGLUnits=[2/this._width,-2/this._height];let r=t.af(new Float64Array(16));t.N(r,r,[this._width/2,-this._height/2,1]),t.M(r,r,[1,-1,0]),this._clipSpaceToPixelsMatrix=r,r=t.af(new Float64Array(16)),t.N(r,r,[1,-1,1]),t.M(r,r,[-1,-1,0]),t.N(r,r,[2/this._width,2/this._height,1]),this._pixelsToClipSpaceMatrix=r,this._cameraToCenterDistance=.5/Math.tan(this.fovInRadians/2)*this._height}this._callbacks.calcMatrices()}calculateCenterFromCameraLngLatAlt(r,h,x,w){let A=x!==void 0?x:this.bearing,k=w=w!==void 0?w:this.pitch,j=t.a0.fromLngLat(r,h),q=-Math.cos(t.ad(k)),J=Math.sin(t.ad(k)),ne=J*Math.sin(t.ad(A)),pe=-J*Math.cos(t.ad(A)),ue=this.elevation,ge=h-ue,Ee;q*ge>=0||Math.abs(q)<.1?(Ee=1e4,ue=h+Ee*q):Ee=-ge/q;let tt,Xe,et=t.aP(1,j.y),Se=0;do{if(Se+=1,Se>10)break;Xe=Ee/et,tt=new t.a0(j.x+ne*Xe,j.y+pe*Xe),et=1/tt.meterInMercatorCoordinateUnits()}while(Math.abs(Ee-Xe*et)>1e-12);return{center:tt.toLngLat(),elevation:ue,zoom:t.aj(this.height/2/Math.tan(this.fovInRadians/2)/Xe/this.tileSize)}}recalculateZoomAndCenter(r){if(this.elevation-r==0)return;let h=t.ai(1,this.center.lat)*this.worldSize,x=this.cameraToCenterDistance/h,w=t.a0.fromLngLat(this.center,this.elevation),A=mt(this.center,this.elevation,this.pitch,this.bearing,x);this._elevation=r;let k=this.calculateCenterFromCameraLngLatAlt(A.toLngLat(),t.aP(A.z,w.y),this.bearing,this.pitch);this._elevation=k.elevation,this._center=k.center,this.setZoom(k.zoom)}getCameraPoint(){let r=Math.tan(this.pitchInRadians)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new t.P(r*Math.sin(this.rollInRadians),r*Math.cos(this.rollInRadians)))}getCameraAltitude(){return Math.cos(this.pitchInRadians)*this._cameraToCenterDistance/this._pixelPerMeter+this.elevation}getCameraLngLat(){let r=t.ai(1,this.center.lat)*this.worldSize;return mt(this.center,this.elevation,this.pitch,this.bearing,this.cameraToCenterDistance/r).toLngLat()}getMercatorTileCoordinates(r){if(!r)return[0,0,1,1];let h=r.canonical.z>=0?1<<r.canonical.z:Math.pow(2,r.canonical.z);return[r.canonical.x/h,r.canonical.y/h,1/h/t.$,1/h/t.$]}}class Cd{constructor(r,h){this.min=r,this.max=h,this.center=t.aQ([],t.aR([],this.min,this.max),.5)}quadrant(r){let h=[r%2==0,r<2],x=t.aS(this.min),w=t.aS(this.max);for(let A=0;A<h.length;A++)x[A]=h[A]?this.min[A]:this.center[A],w[A]=h[A]?this.center[A]:this.max[A];return w[2]=this.max[2],new Cd(x,w)}distanceX(r){return Math.max(Math.min(this.max[0],r[0]),this.min[0])-r[0]}distanceY(r){return Math.max(Math.min(this.max[1],r[1]),this.min[1])-r[1]}intersectsFrustum(r){let h=!0;for(let x=0;x<r.planes.length;x++){let w=this.intersectsPlane(r.planes[x]);if(w===0)return 0;w===1&&(h=!1)}return h?2:r.aabb.min[0]>this.max[0]||r.aabb.min[1]>this.max[1]||r.aabb.min[2]>this.max[2]||r.aabb.max[0]<this.min[0]||r.aabb.max[1]<this.min[1]||r.aabb.max[2]<this.min[2]?0:1}intersectsPlane(r){let h=r[3],x=r[3];for(let w=0;w<3;w++)r[w]>0?(h+=r[w]*this.min[w],x+=r[w]*this.max[w]):(x+=r[w]*this.min[w],h+=r[w]*this.max[w]);return h>=0?2:x<0?0:1}}class Lu{distanceToTile2d(r,h,x,w){let A=w.distanceX([r,h]),k=w.distanceY([r,h]);return Math.hypot(A,k)}getWrap(r,h,x){return x}getTileBoundingVolume(r,h,x,w){var A,k;let j=x,q=x;if(w?.terrain){let ne=new t.Z(r.z,h,r.z,r.x,r.y),pe=w.terrain.getMinMaxElevation(ne);j=(A=pe.minElevation)!==null&&A!==void 0?A:x,q=(k=pe.maxElevation)!==null&&k!==void 0?k:x}let J=1<<r.z;return new Cd([h+r.x/J,r.y/J,j],[h+(r.x+1)/J,(r.y+1)/J,q])}allowVariableZoom(r,h){let x=r.fov*(Math.abs(Math.cos(r.rollInRadians))*r.height+Math.abs(Math.sin(r.rollInRadians))*r.width)/r.height,w=t.ag(78.5-x/2,0,60);return!!h.terrain||r.pitch>w}allowWorldCopies(){return!0}prepareNextFrame(){}}class Xs{constructor(r,h,x){this.points=r,this.planes=h,this.aabb=x}static fromInvProjectionMatrix(r,h=1,x=0,w,A){let k=A?[[6,5,4],[0,1,2],[0,3,7],[2,1,5],[3,2,6],[0,4,5]]:[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]],j=Math.pow(2,x),q=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(ue=>function(ge,Ee,tt,Xe){let et=t.av([],ge,Ee),Se=1/et[3]/tt*Xe;return t.aX(et,et,[Se,Se,1/et[3],Se])}(ue,r,h,j));w&&function(ue,ge,Ee,tt){let Xe=tt?4:0,et=tt?0:4,Se=0,Be=[],ft=[];for(let pt=0;pt<4;pt++){let zt=t.aT([],ue[pt+et],ue[pt+Xe]),ei=t.aY(zt);t.aQ(zt,zt,1/ei),Be.push(ei),ft.push(zt)}for(let pt=0;pt<4;pt++){let zt=t.aZ(ue[pt+Xe],ft[pt],Ee);Se=zt!==null&&zt>=0?Math.max(Se,zt):Math.max(Se,Be[pt])}let dt=function(pt,zt){let ei=t.aT([],pt[zt[0]],pt[zt[1]]),Kt=t.aT([],pt[zt[2]],pt[zt[1]]),Jt=[0,0,0,0];return t.aU(Jt,t.aV([],ei,Kt)),Jt[3]=-t.aW(Jt,pt[zt[0]]),Jt}(ue,ge),xe=function(pt,zt){let ei=t.a_(pt),Kt=t.a$([],pt,1/ei),Jt=t.aT([],zt,t.aQ([],Kt,t.aW(zt,Kt))),si=t.a_(Jt);if(si>0){let Xi=Math.sqrt(1-Kt[3]*Kt[3]),Ki=t.aQ([],Kt,-Kt[3]),Pi=t.aR([],Ki,t.aQ([],Jt,Xi/si));return t.b0(zt,Pi)}return null}(Ee,dt);if(xe!==null){let pt=xe/t.aW(ft[0],dt);Se=Math.min(Se,pt)}for(let pt=0;pt<4;pt++){let zt=Math.min(Se,Be[pt]);ue[pt+et]=[ue[pt+Xe][0]+ft[pt][0]*zt,ue[pt+Xe][1]+ft[pt][1]*zt,ue[pt+Xe][2]+ft[pt][2]*zt,1]}}(q,k[0],w,A);let J=k.map(ue=>{let ge=t.aT([],q[ue[0]],q[ue[1]]),Ee=t.aT([],q[ue[2]],q[ue[1]]),tt=t.aU([],t.aV([],ge,Ee)),Xe=-t.aW(tt,q[ue[1]]);return tt.concat(Xe)}),ne=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],pe=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];for(let ue of q)for(let ge=0;ge<3;ge++)ne[ge]=Math.min(ne[ge],ue[ge]),pe[ge]=Math.max(pe[ge],ue[ge]);return new Xs(q,J,new Cd(ne,pe))}}class wn{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(r){this._helper.setMinZoom(r)}setMaxZoom(r){this._helper.setMaxZoom(r)}setMinPitch(r){this._helper.setMinPitch(r)}setMaxPitch(r){this._helper.setMaxPitch(r)}setRenderWorldCopies(r){this._helper.setRenderWorldCopies(r)}setBearing(r){this._helper.setBearing(r)}setPitch(r){this._helper.setPitch(r)}setRoll(r){this._helper.setRoll(r)}setFov(r){this._helper.setFov(r)}setZoom(r){this._helper.setZoom(r)}setCenter(r){this._helper.setCenter(r)}setElevation(r){this._helper.setElevation(r)}setMinElevationForCurrentTile(r){this._helper.setMinElevationForCurrentTile(r)}setPadding(r){this._helper.setPadding(r)}interpolatePadding(r,h,x){return this._helper.interpolatePadding(r,h,x)}isPaddingEqual(r){return this._helper.isPaddingEqual(r)}resize(r,h,x=!0){this._helper.resize(r,h,x)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(r){this._helper.setMaxBounds(r)}overrideNearFarZ(r,h){this._helper.overrideNearFarZ(r,h)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(r){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),r)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(r,h){}constructor(r,h,x,w,A){this._posMatrixCache=new Map,this._alignedPosMatrixCache=new Map,this._fogMatrixCacheF32=new Map,this._helper=new vc({calcMatrices:()=>{this._calcMatrices()},getConstrained:(k,j)=>this.getConstrained(k,j)},r,h,x,w,A),this._coveringTilesDetailsProvider=new Lu}clone(){let r=new wn;return r.apply(this),r}apply(r,h,x){this._helper.apply(r,h,x)}get cameraPosition(){return this._cameraPosition}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._viewProjMatrix}get inverseProjectionMatrix(){return this._invProjMatrix}get mercatorMatrix(){return this._mercatorMatrix}getVisibleUnwrappedCoordinates(r){let h=[new t.b1(0,r)];if(this._helper._renderWorldCopies){let x=this.screenPointToMercatorCoordinate(new t.P(0,0)),w=this.screenPointToMercatorCoordinate(new t.P(this._helper._width,0)),A=this.screenPointToMercatorCoordinate(new t.P(this._helper._width,this._helper._height)),k=this.screenPointToMercatorCoordinate(new t.P(0,this._helper._height)),j=Math.floor(Math.min(x.x,w.x,A.x,k.x)),q=Math.floor(Math.max(x.x,w.x,A.x,k.x)),J=1;for(let ne=j-J;ne<=q+J;ne++)ne!==0&&h.push(new t.b1(ne,r))}return h}getCameraFrustum(){return Xs.fromInvProjectionMatrix(this._invViewProjMatrix,this.worldSize)}getClippingPlane(){return null}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(r){let h=this.screenPointToLocation(this.centerPoint,r),x=r?r.getElevationForLngLatZoom(h,this._helper._tileZoom):0;this._helper.recalculateZoomAndCenter(x)}setLocationAtPoint(r,h){let x=t.ai(this.elevation,this.center.lat),w=this.screenPointToMercatorCoordinateAtZ(h,x),A=this.screenPointToMercatorCoordinateAtZ(this.centerPoint,x),k=t.a0.fromLngLat(r),j=new t.a0(k.x-(w.x-A.x),k.y-(w.y-A.y));this.setCenter(j?.toLngLat()),this._helper._renderWorldCopies&&this.setCenter(this.center.wrap())}locationToScreenPoint(r,h){return h?this.coordinatePoint(t.a0.fromLngLat(r),h.getElevationForLngLatZoom(r,this._helper._tileZoom),this._pixelMatrix3D):this.coordinatePoint(t.a0.fromLngLat(r))}screenPointToLocation(r,h){var x;return(x=this.screenPointToMercatorCoordinate(r,h))===null||x===void 0?void 0:x.toLngLat()}screenPointToMercatorCoordinate(r,h){if(h){let x=h.pointCoordinate(r);if(x!=null)return x}return this.screenPointToMercatorCoordinateAtZ(r)}screenPointToMercatorCoordinateAtZ(r,h){let x=h||0,w=[r.x,r.y,0,1],A=[r.x,r.y,1,1];t.av(w,w,this._pixelMatrixInverse),t.av(A,A,this._pixelMatrixInverse);let k=w[3],j=A[3],q=w[1]/k,J=A[1]/j,ne=w[2]/k,pe=A[2]/j,ue=ne===pe?0:(x-ne)/(pe-ne);return new t.a0(t.C.number(w[0]/k,A[0]/j,ue)/this.worldSize,t.C.number(q,J,ue)/this.worldSize,x)}coordinatePoint(r,h=0,x=this._pixelMatrix){let w=[r.x*this.worldSize,r.y*this.worldSize,h,1];return t.av(w,w,x),new t.P(w[0]/w[3],w[1]/w[3])}getBounds(){let r=Math.max(0,this._helper._height/2-Fe(this));return new hr().extend(this.screenPointToLocation(new t.P(0,r))).extend(this.screenPointToLocation(new t.P(this._helper._width,r))).extend(this.screenPointToLocation(new t.P(this._helper._width,this._helper._height))).extend(this.screenPointToLocation(new t.P(0,this._helper._height)))}isPointOnMapSurface(r,h){return h?h.pointCoordinate(r)!=null:r.y>this.height/2-Fe(this)}calculatePosMatrix(r,h=!1,x){var w;let A=(w=r.key)!==null&&w!==void 0?w:t.b2(r.wrap,r.canonical.z,r.canonical.z,r.canonical.x,r.canonical.y),k=h?this._alignedPosMatrixCache:this._posMatrixCache;if(k.has(A)){let J=k.get(A);return x?J.f32:J.f64}let j=He(r,this.worldSize);t.O(j,h?this._alignedProjMatrix:this._viewProjMatrix,j);let q={f64:j,f32:new Float32Array(j)};return k.set(A,q),x?q.f32:q.f64}calculateFogMatrix(r){let h=r.key,x=this._fogMatrixCacheF32;if(x.has(h))return x.get(h);let w=He(r,this.worldSize);return t.O(w,this._fogMatrix,w),x.set(h,new Float32Array(w)),x.get(h)}getConstrained(r,h){h=t.ag(+h,this.minZoom,this.maxZoom);let x={center:new t.S(r.lng,r.lat),zoom:h},w=this._helper._lngRange;this._helper._renderWorldCopies||w!==null||(w=[-179.9999999999,180-1e-10]);let A=this.tileSize*t.ae(x.zoom),k=0,j=A,q=0,J=A,ne=0,pe=0,{x:ue,y:ge}=this.size;if(this._helper._latRange){let Be=this._helper._latRange;k=t.U(Be[1])*A,j=t.U(Be[0])*A,j-k<ge&&(ne=ge/(j-k))}w&&(q=t.aN(t.V(w[0])*A,0,A),J=t.aN(t.V(w[1])*A,0,A),J<q&&(J+=A),J-q<ue&&(pe=ue/(J-q)));let{x:Ee,y:tt}=Vt(A,r),Xe,et,Se=Math.max(pe||0,ne||0);if(Se){let Be=new t.P(pe?(J+q)/2:Ee,ne?(j+k)/2:tt);return x.center=Le(A,Be).wrap(),x.zoom+=t.aj(Se),x}if(this._helper._latRange){let Be=ge/2;tt-Be<k&&(et=k+Be),tt+Be>j&&(et=j-Be)}if(w){let Be=(q+J)/2,ft=Ee;this._helper._renderWorldCopies&&(ft=t.aN(Ee,Be-A/2,Be+A/2));let dt=ue/2;ft-dt<q&&(Xe=q+dt),ft+dt>J&&(Xe=J-dt)}if(Xe!==void 0||et!==void 0){let Be=new t.P(Xe??Ee,et??tt);x.center=Le(A,Be).wrap()}return x}calculateCenterFromCameraLngLatAlt(r,h,x,w){return this._helper.calculateCenterFromCameraLngLatAlt(r,h,x,w)}_calculateNearFarZIfNeeded(r,h,x){if(!this._helper.autoCalculateNearFarZ)return;let w=Math.min(this.elevation,this.minElevationForCurrentTile,this.getCameraAltitude()-100),A=r-w*this._helper._pixelPerMeter/Math.cos(h),k=w<0?A:r,j=Math.PI/2+this.pitchInRadians,q=t.ad(this.fov)*(Math.abs(Math.cos(t.ad(this.roll)))*this.height+Math.abs(Math.sin(t.ad(this.roll)))*this.width)/this.height*(.5+x.y/this.height),J=Math.sin(q)*k/Math.sin(t.ag(Math.PI-j-q,.01,Math.PI-.01)),ne=Fe(this),pe=Math.atan(ne/this._helper.cameraToCenterDistance),ue=t.ad(.75),ge=pe>ue?2*pe*(.5+x.y/(2*ne)):ue,Ee=Math.sin(ge)*k/Math.sin(t.ag(Math.PI-j-ge,.01,Math.PI-.01)),tt=Math.min(J,Ee);this._helper._farZ=1.01*(Math.cos(Math.PI/2-h)*tt+k),this._helper._nearZ=this._helper._height/50}_calcMatrices(){if(!this._helper._height)return;let r=this.centerOffset,h=Vt(this.worldSize,this.center),x=h.x,w=h.y;this._helper._pixelPerMeter=t.ai(1,this.center.lat)*this.worldSize;let A=t.ad(Math.min(this.pitch,ms)),k=Math.max(this._helper.cameraToCenterDistance/2,this._helper.cameraToCenterDistance+this._helper._elevation*this._helper._pixelPerMeter/Math.cos(A)),j;this._calculateNearFarZIfNeeded(k,A,r),j=new Float64Array(16),t.b3(j,this.fovInRadians,this._helper._width/this._helper._height,this._helper._nearZ,this._helper._farZ),this._invProjMatrix=new Float64Array(16),t.ap(this._invProjMatrix,j),j[8]=2*-r.x/this._helper._width,j[9]=2*r.y/this._helper._height,this._projectionMatrix=t.b4(j),t.N(j,j,[1,-1,1]),t.M(j,j,[0,0,-this._helper.cameraToCenterDistance]),t.b5(j,j,-this.rollInRadians),t.b6(j,j,this.pitchInRadians),t.b5(j,j,-this.bearingInRadians),t.M(j,j,[-x,-w,0]),this._mercatorMatrix=t.N([],j,[this.worldSize,this.worldSize,this.worldSize]),t.N(j,j,[1,1,this._helper._pixelPerMeter]),this._pixelMatrix=t.O(new Float64Array(16),this.clipSpaceToPixelsMatrix,j),t.M(j,j,[0,0,-this.elevation]),this._viewProjMatrix=j,this._invViewProjMatrix=t.ap([],j);let q=[0,0,-1,1];t.av(q,q,this._invViewProjMatrix),this._cameraPosition=[q[0]/q[3],q[1]/q[3],q[2]/q[3]],this._fogMatrix=new Float64Array(16),t.b3(this._fogMatrix,this.fovInRadians,this.width/this.height,k,this._helper._farZ),this._fogMatrix[8]=2*-r.x/this.width,this._fogMatrix[9]=2*r.y/this.height,t.N(this._fogMatrix,this._fogMatrix,[1,-1,1]),t.M(this._fogMatrix,this._fogMatrix,[0,0,-this.cameraToCenterDistance]),t.b5(this._fogMatrix,this._fogMatrix,-this.rollInRadians),t.b6(this._fogMatrix,this._fogMatrix,this.pitchInRadians),t.b5(this._fogMatrix,this._fogMatrix,-this.bearingInRadians),t.M(this._fogMatrix,this._fogMatrix,[-x,-w,0]),t.N(this._fogMatrix,this._fogMatrix,[1,1,this._helper._pixelPerMeter]),t.M(this._fogMatrix,this._fogMatrix,[0,0,-this.elevation]),this._pixelMatrix3D=t.O(new Float64Array(16),this.clipSpaceToPixelsMatrix,j);let J=this._helper._width%2/2,ne=this._helper._height%2/2,pe=Math.cos(this.bearingInRadians),ue=Math.sin(-this.bearingInRadians),ge=x-Math.round(x)+pe*J+ue*ne,Ee=w-Math.round(w)+pe*ne+ue*J,tt=new Float64Array(j);if(t.M(tt,tt,[ge>.5?ge-1:ge,Ee>.5?Ee-1:Ee,0]),this._alignedProjMatrix=tt,j=t.ap(new Float64Array(16),this._pixelMatrix),!j)throw new Error("failed to invert matrix");this._pixelMatrixInverse=j,this._clearMatrixCaches()}_clearMatrixCaches(){this._posMatrixCache.clear(),this._alignedPosMatrixCache.clear(),this._fogMatrixCacheF32.clear()}maxPitchScaleFactor(){if(!this._pixelMatrixInverse)return 1;let r=this.screenPointToMercatorCoordinate(new t.P(0,0)),h=[r.x*this.worldSize,r.y*this.worldSize,0,1];return t.av(h,h,this._pixelMatrix)[3]/this._helper.cameraToCenterDistance}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){let r=t.ai(1,this.center.lat)*this.worldSize;return mt(this.center,this.elevation,this.pitch,this.bearing,this._helper.cameraToCenterDistance/r).toLngLat()}lngLatToCameraDepth(r,h){let x=t.a0.fromLngLat(r),w=[x.x*this.worldSize,x.y*this.worldSize,h,1];return t.av(w,w,this._viewProjMatrix),w[2]/w[3]}getProjectionData(r){let{overscaledTileID:h,aligned:x,applyTerrainMatrix:w}=r,A=this._helper.getMercatorTileCoordinates(h),k=h?this.calculatePosMatrix(h,x,!0):null,j;return j=h&&h.terrainRttPosMatrix32f&&w?h.terrainRttPosMatrix32f:k||t.b7(),{mainMatrix:j,tileMercatorCoords:A,clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:j}}isLocationOccluded(r){return!1}getPixelScale(){return 1}getCircleRadiusCorrection(){return 1}getPitchedTextCorrection(r,h,x){return 1}transformLightDirection(r){return t.aS(r)}getRayDirectionFromPixel(r){throw new Error("Not implemented.")}projectTileCoordinates(r,h,x,w){let A=this.calculatePosMatrix(x),k;w?(k=[r,h,w(r,h),1],t.av(k,k,A)):(k=[r,h,0,1],Jn(k,k,A));let j=k[3];return{point:new t.P(k[0]/j,k[1]/j),signedDistanceFromCamera:j,isOccluded:!1}}populateCache(r){for(let h of r)this.calculatePosMatrix(h)}getMatrixForModel(r,h){let x=t.a0.fromLngLat(r,h),w=x.meterInMercatorCoordinateUnits(),A=t.b8();return t.M(A,A,[x.x,x.y,x.z]),t.b5(A,A,Math.PI),t.b6(A,A,Math.PI/2),t.N(A,A,[-w,w,w]),A}getProjectionDataForCustomLayer(r=!0){let h=new t.Z(0,0,0,0,0),x=this.getProjectionData({overscaledTileID:h,applyGlobeMatrix:r}),w=He(h,this.worldSize);t.O(w,this._viewProjMatrix,w),x.tileMercatorCoords=[0,0,1,1];let A=[t.$,t.$,this.worldSize/this._helper.pixelsPerMeter],k=t.b9();return t.N(k,w,A),x.fallbackMatrix=k,x.mainMatrix=k,x}getFastPathSimpleProjectionMatrix(r){return this.calculatePosMatrix(r)}}function Ps(){t.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}function gs(M){if(M.useSlerp)if(M.k<1){let r=t.ba(M.startEulerAngles.roll,M.startEulerAngles.pitch,M.startEulerAngles.bearing),h=t.ba(M.endEulerAngles.roll,M.endEulerAngles.pitch,M.endEulerAngles.bearing),x=new Float64Array(4);t.bb(x,r,h,M.k);let w=t.bc(x);M.tr.setRoll(w.roll),M.tr.setPitch(w.pitch),M.tr.setBearing(w.bearing)}else M.tr.setRoll(M.endEulerAngles.roll),M.tr.setPitch(M.endEulerAngles.pitch),M.tr.setBearing(M.endEulerAngles.bearing);else M.tr.setRoll(t.C.number(M.startEulerAngles.roll,M.endEulerAngles.roll,M.k)),M.tr.setPitch(t.C.number(M.startEulerAngles.pitch,M.endEulerAngles.pitch,M.k)),M.tr.setBearing(t.C.number(M.startEulerAngles.bearing,M.endEulerAngles.bearing,M.k))}function cs(M,r,h,x,w){let A=w.padding,k=Vt(w.worldSize,h.getNorthWest()),j=Vt(w.worldSize,h.getNorthEast()),q=Vt(w.worldSize,h.getSouthEast()),J=Vt(w.worldSize,h.getSouthWest()),ne=t.ad(-x),pe=k.rotate(ne),ue=j.rotate(ne),ge=q.rotate(ne),Ee=J.rotate(ne),tt=new t.P(Math.max(pe.x,ue.x,Ee.x,ge.x),Math.max(pe.y,ue.y,Ee.y,ge.y)),Xe=new t.P(Math.min(pe.x,ue.x,Ee.x,ge.x),Math.min(pe.y,ue.y,Ee.y,ge.y)),et=tt.sub(Xe),Se=(w.width-(A.left+A.right+r.left+r.right))/et.x,Be=(w.height-(A.top+A.bottom+r.top+r.bottom))/et.y;if(Be<0||Se<0)return void Ps();let ft=Math.min(t.aj(w.scale*Math.min(Se,Be)),M.maxZoom),dt=t.P.convert(M.offset),xe=new t.P((r.left-r.right)/2,(r.top-r.bottom)/2).rotate(t.ad(x)),pt=dt.add(xe).mult(w.scale/t.ae(ft));return{center:Le(w.worldSize,k.add(q).div(2).sub(pt)),zoom:ft,bearing:x}}class Ed{get useGlobeControls(){return!1}handlePanInertia(r,h){return{easingOffset:r,easingCenter:h.center}}handleMapControlsRollPitchBearingZoom(r,h){r.bearingDelta&&h.setBearing(h.bearing+r.bearingDelta),r.pitchDelta&&h.setPitch(h.pitch+r.pitchDelta),r.rollDelta&&h.setRoll(h.roll+r.rollDelta),r.zoomDelta&&h.setZoom(h.zoom+r.zoomDelta)}handleMapControlsPan(r,h,x){r.around.distSqr(h.centerPoint)<.01||h.setLocationAtPoint(x,r.around)}cameraForBoxAndBearing(r,h,x,w,A){return cs(r,h,x,w,A)}handleJumpToCenterZoom(r,h){r.zoom!==(h.zoom!==void 0?+h.zoom:r.zoom)&&r.setZoom(+h.zoom),h.center!==void 0&&r.setCenter(t.S.convert(h.center))}handleEaseTo(r,h){let x=r.zoom,w=r.padding,A={roll:r.roll,pitch:r.pitch,bearing:r.bearing},k={roll:h.roll===void 0?r.roll:h.roll,pitch:h.pitch===void 0?r.pitch:h.pitch,bearing:h.bearing===void 0?r.bearing:h.bearing},j=h.zoom!==void 0,q=!r.isPaddingEqual(h.padding),J=!1,ne=j?+h.zoom:r.zoom,pe=r.centerPoint.add(h.offsetAsPoint),ue=r.screenPointToLocation(pe),{center:ge,zoom:Ee}=r.getConstrained(t.S.convert(h.center||ue),ne??x);Al(r,ge);let tt=Vt(r.worldSize,ue),Xe=Vt(r.worldSize,ge).sub(tt),et=t.ae(Ee-x);return J=Ee!==x,{easeFunc:Se=>{if(J&&r.setZoom(t.C.number(x,Ee,Se)),t.bd(A,k)||gs({startEulerAngles:A,endEulerAngles:k,tr:r,k:Se,useSlerp:A.roll!=k.roll}),q&&(r.interpolatePadding(w,h.padding,Se),pe=r.centerPoint.add(h.offsetAsPoint)),h.around)r.setLocationAtPoint(h.around,h.aroundPoint);else{let Be=t.ae(r.zoom-x),ft=Ee>x?Math.min(2,et):Math.max(.5,et),dt=Math.pow(ft,1-Se),xe=Le(r.worldSize,tt.add(Xe.mult(Se*dt)).mult(Be));r.setLocationAtPoint(r.renderWorldCopies?xe.wrap():xe,pe)}},isZooming:J,elevationCenter:ge}}handleFlyTo(r,h){let x=h.zoom!==void 0,w=r.zoom,A=r.getConstrained(t.S.convert(h.center||h.locationAtOffset),x?+h.zoom:w),k=A.center,j=A.zoom;Al(r,k);let q=Vt(r.worldSize,h.locationAtOffset),J=Vt(r.worldSize,k).sub(q),ne=J.mag(),pe=t.ae(j-w),ue;if(h.minZoom!==void 0){let ge=Math.min(+h.minZoom,w,j),Ee=r.getConstrained(k,ge).zoom;ue=t.ae(Ee-w)}return{easeFunc:(ge,Ee,tt,Xe)=>{r.setZoom(ge===1?j:w+t.aj(Ee));let et=ge===1?k:Le(r.worldSize,q.add(J.mult(tt)).mult(Ee));r.setLocationAtPoint(r.renderWorldCopies?et.wrap():et,Xe)},scaleOfZoom:pe,targetCenter:k,scaleOfMinZoom:ue,pixelPathLength:ne}}}class Cr{constructor(r,h,x){this.blendFunction=r,this.blendColor=h,this.mask=x}}Cr.Replace=[1,0],Cr.disabled=new Cr(Cr.Replace,t.be.transparent,[!1,!1,!1,!1]),Cr.unblended=new Cr(Cr.Replace,t.be.transparent,[!0,!0,!0,!0]),Cr.alphaBlended=new Cr([1,771],t.be.transparent,[!0,!0,!0,!0]);let As=2305;class or{constructor(r,h,x){this.enable=r,this.mode=h,this.frontFace=x}}or.disabled=new or(!1,1029,As),or.backCCW=new or(!0,1029,As),or.frontCCW=new or(!0,1028,As);class Tr{constructor(r,h,x){this.func=r,this.mask=h,this.range=x}}Tr.ReadOnly=!1,Tr.ReadWrite=!0,Tr.disabled=new Tr(519,Tr.ReadOnly,[0,1]);let Xc=7680;class Fn{constructor(r,h,x,w,A,k){this.test=r,this.ref=h,this.mask=x,this.fail=w,this.depthFail=A,this.pass=k}}Fn.disabled=new Fn({func:519,mask:0},0,0,Xc,Xc,Xc);let ic=new WeakMap;function Bs(M){var r;if(ic.has(M))return ic.get(M);{let h=(r=M.getParameter(M.VERSION))===null||r===void 0?void 0:r.startsWith("WebGL 2.0");return ic.set(M,h),h}}class Kc{get awaitingQuery(){return!!this._readbackQueue}constructor(r){this._readbackWaitFrames=4,this._measureWaitFrames=6,this._texWidth=1,this._texHeight=1,this._measuredError=0,this._updateCount=0,this._lastReadbackFrame=-1e3,this._readbackQueue=null,this._cachedRenderContext=r;let h=r.context,x=h.gl;this._texFormat=x.RGBA,this._texType=x.UNSIGNED_BYTE;let w=new t.aK;w.emplaceBack(-1,-1),w.emplaceBack(2,-1),w.emplaceBack(-1,2);let A=new t.aM;A.emplaceBack(0,1,2),this._fullscreenTriangle=new ec(h.createVertexBuffer(w,Ta.members),h.createIndexBuffer(A),t.aL.simpleSegment(0,0,w.length,A.length)),this._resultBuffer=new Uint8Array(4),h.activeTexture.set(x.TEXTURE1);let k=x.createTexture();x.bindTexture(x.TEXTURE_2D,k),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.NEAREST),x.texImage2D(x.TEXTURE_2D,0,this._texFormat,this._texWidth,this._texHeight,0,this._texFormat,this._texType,null),this._fbo=h.createFramebuffer(this._texWidth,this._texHeight,!1,!1),this._fbo.colorAttachment.set(k),Bs(x)&&(this._pbo=x.createBuffer(),x.bindBuffer(x.PIXEL_PACK_BUFFER,this._pbo),x.bufferData(x.PIXEL_PACK_BUFFER,4,x.STREAM_READ),x.bindBuffer(x.PIXEL_PACK_BUFFER,null))}destroy(){let r=this._cachedRenderContext.context.gl;this._fullscreenTriangle.destroy(),this._fbo.destroy(),r.deleteBuffer(this._pbo),this._fullscreenTriangle=null,this._fbo=null,this._pbo=null,this._resultBuffer=null}updateErrorLoop(r,h){let x=this._updateCount;return this._readbackQueue?x>=this._readbackQueue.frameNumberIssued+this._readbackWaitFrames&&this._tryReadback():x>=this._lastReadbackFrame+this._measureWaitFrames&&this._renderErrorTexture(r,h),this._updateCount++,this._measuredError}_bindFramebuffer(){let r=this._cachedRenderContext.context,h=r.gl;r.activeTexture.set(h.TEXTURE1),h.bindTexture(h.TEXTURE_2D,this._fbo.colorAttachment.get()),r.bindFramebuffer.set(this._fbo.framebuffer)}_renderErrorTexture(r,h){let x=this._cachedRenderContext.context,w=x.gl;if(this._bindFramebuffer(),x.viewport.set([0,0,this._texWidth,this._texHeight]),x.clear({color:t.be.transparent}),this._cachedRenderContext.useProgram("projectionErrorMeasurement").draw(x,w.TRIANGLES,Tr.disabled,Fn.disabled,Cr.unblended,or.disabled,((A,k)=>({u_input:A,u_output_expected:k}))(r,h),null,null,"$clipping",this._fullscreenTriangle.vertexBuffer,this._fullscreenTriangle.indexBuffer,this._fullscreenTriangle.segments),this._pbo&&Bs(w)){w.bindBuffer(w.PIXEL_PACK_BUFFER,this._pbo),w.readBuffer(w.COLOR_ATTACHMENT0),w.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,0),w.bindBuffer(w.PIXEL_PACK_BUFFER,null);let A=w.fenceSync(w.SYNC_GPU_COMMANDS_COMPLETE,0);w.flush(),this._readbackQueue={frameNumberIssued:this._updateCount,sync:A}}else this._readbackQueue={frameNumberIssued:this._updateCount,sync:null}}_tryReadback(){let r=this._cachedRenderContext.context.gl;if(this._pbo&&this._readbackQueue&&Bs(r)){let h=r.clientWaitSync(this._readbackQueue.sync,0,0);if(h===r.WAIT_FAILED)return t.w("WebGL2 clientWaitSync failed."),this._readbackQueue=null,void(this._lastReadbackFrame=this._updateCount);if(h===r.TIMEOUT_EXPIRED)return;r.bindBuffer(r.PIXEL_PACK_BUFFER,this._pbo),r.getBufferSubData(r.PIXEL_PACK_BUFFER,0,this._resultBuffer,0,4),r.bindBuffer(r.PIXEL_PACK_BUFFER,null)}else this._bindFramebuffer(),r.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,this._resultBuffer);this._readbackQueue=null,this._measuredError=Kc._parseRGBA8float(this._resultBuffer),this._lastReadbackFrame=this._updateCount}static _parseRGBA8float(r){let h=0;return h+=r[0]/256,h+=r[1]/65536,h+=r[2]/16777216,r[3]<127&&(h=-h),h/128}}let ll=t.$/128;function za(M,r){let h=M.granularity!==void 0?Math.max(M.granularity,1):1,x=h+(M.generateBorders?2:0),w=h+(M.extendToNorthPole||M.generateBorders?1:0)+(M.extendToSouthPole||M.generateBorders?1:0),A=x+1,k=w+1,j=M.generateBorders?-1:0,q=M.generateBorders||M.extendToNorthPole?-1:0,J=h+(M.generateBorders?1:0),ne=h+(M.generateBorders||M.extendToSouthPole?1:0),pe=A*k,ue=x*w*6,ge=A*k>65536;if(ge&&r==="16bit")throw new Error("Granularity is too large and meshes would not fit inside 16 bit vertex indices.");let Ee=ge||r==="32bit",tt=new Int16Array(2*pe),Xe=0;for(let Be=q;Be<=ne;Be++)for(let ft=j;ft<=J;ft++){let dt=ft/h*t.$;ft===-1&&(dt=-64),ft===h+1&&(dt=t.$+ll);let xe=Be/h*t.$;Be===-1&&(xe=M.extendToNorthPole?t.bg:-64),Be===h+1&&(xe=M.extendToSouthPole?t.bh:t.$+ll),tt[Xe++]=dt,tt[Xe++]=xe}let et=Ee?new Uint32Array(ue):new Uint16Array(ue),Se=0;for(let Be=0;Be<w;Be++)for(let ft=0;ft<x;ft++){let dt=ft+1+Be*A,xe=ft+(Be+1)*A,pt=ft+1+(Be+1)*A;et[Se++]=ft+Be*A,et[Se++]=xe,et[Se++]=dt,et[Se++]=dt,et[Se++]=xe,et[Se++]=pt}return{vertices:tt.buffer.slice(0),indices:et.buffer.slice(0),uses32bitIndices:Ee}}let Sa=new t.aJ({fill:new t.bi(128,2),line:new t.bi(512,0),tile:new t.bi(128,32),stencil:new t.bi(128,1),circle:3});class Pp{constructor(){this._tileMeshCache={},this._errorCorrectionUsable=0,this._errorMeasurementLastValue=0,this._errorCorrectionPreviousValue=0,this._errorMeasurementLastChangeTime=-1e3}get name(){return"vertical-perspective"}get transitionState(){return 1}get useSubdivision(){return!0}get shaderVariantName(){return"globe"}get shaderDefine(){return"#define GLOBE"}get shaderPreludeCode(){return Ms.projectionGlobe}get vertexShaderPreludeCode(){return Ms.projectionMercator.vertexSource}get subdivisionGranularity(){return Sa}get useGlobeControls(){return!0}get latitudeErrorCorrectionRadians(){return this._errorCorrectionUsable}destroy(){this._errorMeasurement&&this._errorMeasurement.destroy()}updateGPUdependent(r){this._errorMeasurement||(this._errorMeasurement=new Kc(r));let h=t.U(this._errorQueryLatitudeDegrees),x=2*Math.atan(Math.exp(Math.PI-h*Math.PI*2))-.5*Math.PI,w=this._errorMeasurement.updateErrorLoop(h,x),A=an.now();w!==this._errorMeasurementLastValue&&(this._errorCorrectionPreviousValue=this._errorCorrectionUsable,this._errorMeasurementLastValue=w,this._errorMeasurementLastChangeTime=A);let k=Math.min(Math.max((A-this._errorMeasurementLastChangeTime)/1e3/.5,0),1);this._errorCorrectionUsable=t.bj(this._errorCorrectionPreviousValue,-this._errorMeasurementLastValue,t.bk(k))}_getMeshKey(r){return`${r.granularity.toString(36)}_${r.generateBorders?"b":""}${r.extendToNorthPole?"n":""}${r.extendToSouthPole?"s":""}`}getMeshFromTileID(r,h,x,w,A){let k=(A==="stencil"?Sa.stencil:Sa.tile).getGranularityForZoomLevel(h.z);return this._getMesh(r,{granularity:k,generateBorders:x,extendToNorthPole:h.y===0&&w,extendToSouthPole:h.y===(1<<h.z)-1&&w})}_getMesh(r,h){let x=this._getMeshKey(h);if(x in this._tileMeshCache)return this._tileMeshCache[x];let w=function(A,k){let j=za(k,"16bit"),q=t.aK.deserialize({arrayBuffer:j.vertices,length:j.vertices.byteLength/2/2}),J=t.aM.deserialize({arrayBuffer:j.indices,length:j.indices.byteLength/2/3});return new ec(A.createVertexBuffer(q,Ta.members),A.createIndexBuffer(J),t.aL.simpleSegment(0,0,q.length,J.length))}(r,h);return this._tileMeshCache[x]=w,w}recalculate(r){}hasTransition(){let r=an.now(),h=!1;return h=h||(r-this._errorMeasurementLastChangeTime)/1e3<.7,h=h||this._errorMeasurement&&this._errorMeasurement.awaitingQuery,h}setErrorQueryLatitudeDegrees(r){this._errorQueryLatitudeDegrees=r}}let Ap=new t.r({type:new t.D(t.v.projection.type)});class Ah extends t.E{constructor(r){super(),this._transitionable=new t.t(Ap),this.setProjection(r),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new t.F(0)),this._mercatorProjection=new su,this._verticalPerspectiveProjection=new Pp}get transitionState(){let r=this.properties.get("type");if(typeof r=="string"&&r==="mercator")return 0;if(typeof r=="string"&&r==="vertical-perspective")return 1;if(r instanceof t.bl){if(r.from==="vertical-perspective"&&r.to==="mercator")return 1-r.transition;if(r.from==="mercator"&&r.to==="vertical-perspective")return r.transition}return 1}get useGlobeRendering(){return this.transitionState>0}get latitudeErrorCorrectionRadians(){return this._verticalPerspectiveProjection.latitudeErrorCorrectionRadians}get currentProjection(){return this.useGlobeRendering?this._verticalPerspectiveProjection:this._mercatorProjection}get name(){return"globe"}get useSubdivision(){return this.currentProjection.useSubdivision}get shaderVariantName(){return this.currentProjection.shaderVariantName}get shaderDefine(){return this.currentProjection.shaderDefine}get shaderPreludeCode(){return this.currentProjection.shaderPreludeCode}get vertexShaderPreludeCode(){return this.currentProjection.vertexShaderPreludeCode}get subdivisionGranularity(){return this.currentProjection.subdivisionGranularity}get useGlobeControls(){return this.transitionState>0}destroy(){this._mercatorProjection.destroy(),this._verticalPerspectiveProjection.destroy()}updateGPUdependent(r){this._mercatorProjection.updateGPUdependent(r),this._verticalPerspectiveProjection.updateGPUdependent(r)}getMeshFromTileID(r,h,x,w,A){return this.currentProjection.getMeshFromTileID(r,h,x,w,A)}setProjection(r){this._transitionable.setValue("type",r?.type||"mercator")}updateTransitions(r){this._transitioning=this._transitionable.transitioned(r,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()||this.currentProjection.hasTransition()}recalculate(r){this.properties=this._transitioning.possiblyEvaluate(r)}setErrorQueryLatitudeDegrees(r){this._verticalPerspectiveProjection.setErrorQueryLatitudeDegrees(r),this._mercatorProjection.setErrorQueryLatitudeDegrees(r)}}function nc(M){let r=Yc(M.worldSize,M.center.lat);return 2*Math.PI*r}function hs(M,r,h,x,w){let A=1/(1<<w),k=r/t.$*A+x*A,j=t.bn((M/t.$*A+h*A)*Math.PI*2+Math.PI,2*Math.PI),q=2*Math.atan(Math.exp(Math.PI-k*Math.PI*2))-.5*Math.PI,J=Math.cos(q),ne=new Float64Array(3);return ne[0]=Math.sin(j)*J,ne[1]=Math.sin(q),ne[2]=Math.cos(j)*J,ne}function Ns(M){return function(r,h){let x=Math.cos(h),w=new Float64Array(3);return w[0]=Math.sin(r)*x,w[1]=Math.sin(h),w[2]=Math.cos(r)*x,w}(M.lng*Math.PI/180,M.lat*Math.PI/180)}function Yc(M,r){return M/(2*Math.PI)/Math.cos(r*Math.PI/180)}function Jc(M){let r=Math.asin(M[1])/Math.PI*180,h=Math.sqrt(M[0]*M[0]+M[2]*M[2]);if(h>1e-6){let x=M[0]/h,w=Math.acos(M[2]/h),A=(x>0?w:-w)/Math.PI*180;return new t.S(t.aN(A,-180,180),r)}return new t.S(0,r)}function sr(M){return Math.cos(M*Math.PI/180)}function Ds(M,r){let h=sr(M),x=sr(r);return t.aj(x/h)}function en(M,r){let h=M.rotate(r.bearingInRadians),x=r.zoom+Ds(r.center.lat,0),w=t.bj(1/sr(r.center.lat),1/sr(Math.min(Math.abs(r.center.lat),60)),t.bm(x,7,3,0,1)),A=360/nc({worldSize:r.worldSize,center:{lat:r.center.lat}});return new t.S(r.center.lng-h.x*A*w,t.ag(r.center.lat+h.y*A,-85.051129,t.ah))}function au(M){let r=.5*M,h=Math.sin(r),x=Math.cos(r);return Math.log(h+x)-Math.log(x-h)}function Qc(M,r,h,x){let w=M.lat+h*x;if(Math.abs(h)>1){let A=(Math.sign(M.lat+h)!==Math.sign(M.lat)?-Math.abs(M.lat):Math.abs(M.lat))*Math.PI/180,k=Math.abs(M.lat+h)*Math.PI/180,j=au(A+x*(k-A)),q=au(A),J=au(k);return new t.S(M.lng+r*((j-q)/(J-q)),w)}return new t.S(M.lng+r*x,w)}class Dp{constructor(r){this._cachePrevious=new Map,this._cache=new Map,this._hadAnyChanges=!1,this._boundingVolumeFactory=r}swapBuffers(){if(!this._hadAnyChanges)return;let r=this._cachePrevious;this._cachePrevious=this._cache,this._cache=r,this._cache.clear(),this._hadAnyChanges=!1}getTileBoundingVolume(r,h,x,w){let A=`${r.z}_${r.x}_${r.y}_${w?.terrain?"t":""}`,k=this._cache.get(A);if(k)return k;let j=this._cachePrevious.get(A);if(j)return this._cache.set(A,j),j;let q=this._boundingVolumeFactory(r,h,x,w);return this._cache.set(A,q),this._hadAnyChanges=!0,q}}class Dl{constructor(r,h,x,w){this.min=x,this.max=w,this.points=r,this.planes=h}static fromAabb(r,h){let x=[];for(let w=0;w<8;w++)x.push([1&~w?r[0]:h[0],(w>>1&1)==1?h[1]:r[1],(w>>2&1)==1?h[2]:r[2]]);return new Dl(x,[[-1,0,0,h[0]],[1,0,0,-r[0]],[0,-1,0,h[1]],[0,1,0,-r[1]],[0,0,-1,h[2]],[0,0,1,-r[2]]],r,h)}static fromCenterSizeAngles(r,h,x){let w=t.bq([],x[0],x[1],x[2]),A=t.br([],[h[0],0,0],w),k=t.br([],[0,h[1],0],w),j=t.br([],[0,0,h[2]],w),q=[...r],J=[...r];for(let pe=0;pe<8;pe++)for(let ue=0;ue<3;ue++){let ge=r[ue]+A[ue]*(1&~pe?-1:1)+k[ue]*((pe>>1&1)==1?1:-1)+j[ue]*((pe>>2&1)==1?1:-1);q[ue]=Math.min(q[ue],ge),J[ue]=Math.max(J[ue],ge)}let ne=[];for(let pe=0;pe<8;pe++){let ue=[...r];t.aR(ue,ue,t.aQ([],A,1&~pe?-1:1)),t.aR(ue,ue,t.aQ([],k,(pe>>1&1)==1?1:-1)),t.aR(ue,ue,t.aQ([],j,(pe>>2&1)==1?1:-1)),ne.push(ue)}return new Dl(ne,[[...A,-t.aW(A,ne[0])],[...k,-t.aW(k,ne[0])],[...j,-t.aW(j,ne[0])],[-A[0],-A[1],-A[2],-t.aW(A,ne[7])],[-k[0],-k[1],-k[2],-t.aW(k,ne[7])],[-j[0],-j[1],-j[2],-t.aW(j,ne[7])]],q,J)}intersectsFrustum(r){let h=!0,x=this.points.length,w=this.planes.length,A=r.planes.length,k=r.points.length;for(let j=0;j<A;j++){let q=r.planes[j],J=0;for(let ne=0;ne<x;ne++){let pe=this.points[ne];q[0]*pe[0]+q[1]*pe[1]+q[2]*pe[2]+q[3]>=0&&J++}if(J===0)return 0;J<x&&(h=!1)}if(h)return 2;for(let j=0;j<w;j++){let q=this.planes[j],J=0;for(let ne=0;ne<k;ne++){let pe=r.points[ne];q[0]*pe[0]+q[1]*pe[1]+q[2]*pe[2]+q[3]>=0&&J++}if(J===0)return 0}return 1}intersectsPlane(r){let h=this.points.length,x=0;for(let w=0;w<h;w++){let A=this.points[w];r[0]*A[0]+r[1]*A[1]+r[2]*A[2]+r[3]>=0&&x++}return x===h?2:x===0?0:1}}function La(M,r,h){let x=M-r;return x<0?-x:Math.max(0,x-h)}function eh(M,r,h,x,w){let A=M-h,k;return k=A<0?Math.min(-A,1+A-w):A>1?Math.min(Math.max(A-w,0),1-A):0,Math.max(k,La(r,x,w))}class Dh{constructor(){this._boundingVolumeCache=new Dp(this._computeTileBoundingVolume)}prepareNextFrame(){this._boundingVolumeCache.swapBuffers()}distanceToTile2d(r,h,x,w){let A=1<<x.z,k=1/A,j=x.x/A,q=x.y/A,J=2;return J=Math.min(J,eh(r,h,j,q,k)),J=Math.min(J,eh(r,h,j+.5,-q-k,k)),J=Math.min(J,eh(r,h,j+.5,2-q-k,k)),J}getWrap(r,h,x){let w=1<<h.z,A=1/w,k=h.x/w,j=La(r.x,k,A),q=La(r.x,k-1,A),J=La(r.x,k+1,A),ne=Math.min(j,q,J);return ne===J?1:ne===q?-1:0}allowVariableZoom(r,h){return di(r,h)>4}allowWorldCopies(){return!1}getTileBoundingVolume(r,h,x,w){return this._boundingVolumeCache.getTileBoundingVolume(r,h,x,w)}_computeTileBoundingVolume(r,h,x,w){var A,k;let j=x,q=x;if(w?.terrain){let J=new t.Z(r.z,h,r.z,r.x,r.y),ne=w.terrain.getMinMaxElevation(J);j=(A=ne.minElevation)!==null&&A!==void 0?A:x,q=(k=ne.maxElevation)!==null&&k!==void 0?k:x}if(j/=t.bt,q/=t.bt,j+=1,q+=1,r.z<=0)return Dl.fromAabb([-q,-q,-q],[q,q,q]);if(r.z===1)return Dl.fromAabb([r.x===0?-q:0,r.y===0?0:-q,-q],[r.x===0?0:q,r.y===0?q:0,q]);{let J=[hs(0,0,r.x,r.y,r.z),hs(t.$,0,r.x,r.y,r.z),hs(t.$,t.$,r.x,r.y,r.z),hs(0,t.$,r.x,r.y,r.z)],ne=[];for(let Jt of J)ne.push(t.aQ([],Jt,q));if(q!==j)for(let Jt of J)ne.push(t.aQ([],Jt,j));r.y===0&&ne.push([0,1,0]),r.y===(1<<r.z)-1&&ne.push([0,-1,0]);let pe=[1,1,1],ue=[-1,-1,-1];for(let Jt of ne)for(let si=0;si<3;si++)pe[si]=Math.min(pe[si],Jt[si]),ue[si]=Math.max(ue[si],Jt[si]);let ge=hs(t.$/2,t.$/2,r.x,r.y,r.z),Ee=t.aV([],[0,1,0],ge);t.aU(Ee,Ee);let tt=t.aV([],ge,Ee);t.aU(tt,tt);let Xe=t.aV([],J[2],J[1]);t.aU(Xe,Xe);let et=t.aV([],J[0],J[3]);t.aU(et,et),ne.push(t.aQ([],ge,q)),r.y>=(1<<r.z)/2&&ne.push(t.aQ([],hs(t.$/2,0,r.x,r.y,r.z),q)),r.y<(1<<r.z)/2&&ne.push(t.aQ([],hs(t.$/2,t.$,r.x,r.y,r.z),q));let Se=Ri(ge,ne),Be=Ri(tt,ne),ft=[-ge[0],-ge[1],-ge[2],Se.max],dt=[ge[0],ge[1],ge[2],-Se.min],xe=[-tt[0],-tt[1],-tt[2],Be.max],pt=[tt[0],tt[1],tt[2],-Be.min],zt=[...Xe,0],ei=[...et,0],Kt=[];return r.y===0?Kt.push(t.bs(ei,zt,ft),t.bs(ei,zt,dt)):Kt.push(t.bs(xe,zt,ft),t.bs(xe,zt,dt),t.bs(xe,ei,ft),t.bs(xe,ei,dt)),r.y===(1<<r.z)-1?Kt.push(t.bs(ei,zt,ft),t.bs(ei,zt,dt)):Kt.push(t.bs(pt,zt,ft),t.bs(pt,zt,dt),t.bs(pt,ei,ft),t.bs(pt,ei,dt)),new Dl(Kt,[ft,dt,xe,pt,zt,ei],pe,ue)}}}function Ri(M,r){let h=1/0,x=-1/0;for(let w of r){let A=t.aW(M,w);h=Math.min(h,A),x=Math.max(x,A)}return{min:h,max:x}}class br{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(r){this._helper.setMinZoom(r)}setMaxZoom(r){this._helper.setMaxZoom(r)}setMinPitch(r){this._helper.setMinPitch(r)}setMaxPitch(r){this._helper.setMaxPitch(r)}setRenderWorldCopies(r){this._helper.setRenderWorldCopies(r)}setBearing(r){this._helper.setBearing(r)}setPitch(r){this._helper.setPitch(r)}setRoll(r){this._helper.setRoll(r)}setFov(r){this._helper.setFov(r)}setZoom(r){this._helper.setZoom(r)}setCenter(r){this._helper.setCenter(r)}setElevation(r){this._helper.setElevation(r)}setMinElevationForCurrentTile(r){this._helper.setMinElevationForCurrentTile(r)}setPadding(r){this._helper.setPadding(r)}interpolatePadding(r,h,x){return this._helper.interpolatePadding(r,h,x)}isPaddingEqual(r){return this._helper.isPaddingEqual(r)}resize(r,h){this._helper.resize(r,h)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(r){this._helper.setMaxBounds(r)}overrideNearFarZ(r,h){this._helper.overrideNearFarZ(r,h)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(r){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),r)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(r){}constructor(){this._cachedClippingPlane=t.bu(),this._projectionMatrix=t.b8(),this._globeViewProjMatrix32f=t.b7(),this._globeViewProjMatrixNoCorrection=t.b8(),this._globeViewProjMatrixNoCorrectionInverted=t.b8(),this._globeProjMatrixInverted=t.b8(),this._cameraPosition=t.bo(),this._globeLatitudeErrorCorrectionRadians=0,this._helper=new vc({calcMatrices:()=>{this._calcMatrices()},getConstrained:(r,h)=>this.getConstrained(r,h)}),this._coveringTilesDetailsProvider=new Dh}clone(){let r=new br;return r.apply(this),r}apply(r,h){this._globeLatitudeErrorCorrectionRadians=h||0,this._helper.apply(r)}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._globeViewProjMatrixNoCorrection}get inverseProjectionMatrix(){return this._globeProjMatrixInverted}get cameraPosition(){let r=t.bo();return r[0]=this._cameraPosition[0],r[1]=this._cameraPosition[1],r[2]=this._cameraPosition[2],r}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}getProjectionData(r){let{overscaledTileID:h,applyGlobeMatrix:x}=r,w=this._helper.getMercatorTileCoordinates(h);return{mainMatrix:this._globeViewProjMatrix32f,tileMercatorCoords:w,clippingPlane:this._cachedClippingPlane,projectionTransition:x?1:0,fallbackMatrix:this._globeViewProjMatrix32f}}_computeClippingPlane(r){let h=this.pitchInRadians,x=this.cameraToCenterDistance/r,w=Math.sin(h)*x,A=Math.cos(h)*x+1,k=1/Math.sqrt(w*w+A*A)*1,j=-w,q=A,J=Math.sqrt(j*j+q*q);j/=J,q/=J;let ne=[0,j,q];t.bv(ne,ne,[0,0,0],-this.bearingInRadians),t.bw(ne,ne,[0,0,0],-1*this.center.lat*Math.PI/180),t.bx(ne,ne,[0,0,0],this.center.lng*Math.PI/180);let pe=1/t.aY(ne);return t.aQ(ne,ne,pe),[...ne,-k*pe]}isLocationOccluded(r){return!this.isSurfacePointVisible(Ns(r))}transformLightDirection(r){let h=this._helper._center.lng*Math.PI/180,x=this._helper._center.lat*Math.PI/180,w=Math.cos(x),A=[Math.sin(h)*w,Math.sin(x),Math.cos(h)*w],k=[A[2],0,-A[0]],j=[0,0,0];t.aV(j,k,A),t.aU(k,k),t.aU(j,j);let q=[0,0,0];return t.aU(q,[k[0]*r[0]+j[0]*r[1]+A[0]*r[2],k[1]*r[0]+j[1]*r[1]+A[1]*r[2],k[2]*r[0]+j[2]*r[1]+A[2]*r[2]]),q}getPixelScale(){return 1/Math.cos(this._helper._center.lat*Math.PI/180)}getCircleRadiusCorrection(){return Math.cos(this._helper._center.lat*Math.PI/180)}getPitchedTextCorrection(r,h,x){let w=function(j,q,J){let ne=1/(1<<J.z);return new t.a0(j/t.$*ne+J.x*ne,q/t.$*ne+J.y*ne)}(r,h,x.canonical),A=(k=w.y,[t.bn(w.x*Math.PI*2+Math.PI,2*Math.PI),2*Math.atan(Math.exp(Math.PI-k*Math.PI*2))-.5*Math.PI]);var k;return this.getCircleRadiusCorrection()/Math.cos(A[1])}projectTileCoordinates(r,h,x,w){let A=x.canonical,k=hs(r,h,A.x,A.y,A.z),j=1+(w?w(r,h):0)/t.bt,q=[k[0]*j,k[1]*j,k[2]*j,1];t.av(q,q,this._globeViewProjMatrixNoCorrection);let J=this._cachedClippingPlane,ne=J[0]*k[0]+J[1]*k[1]+J[2]*k[2]+J[3]<0;return{point:new t.P(q[0]/q[3],q[1]/q[3]),signedDistanceFromCamera:q[3],isOccluded:ne}}_calcMatrices(){if(!this._helper._width||!this._helper._height)return;let r=Yc(this.worldSize,this.center.lat),h=t.b9(),x=t.b9();this._helper.autoCalculateNearFarZ&&(this._helper._nearZ=.5,this._helper._farZ=this.cameraToCenterDistance+2*r),t.b3(h,this.fovInRadians,this.width/this.height,this._helper._nearZ,this._helper._farZ);let w=this.centerOffset;h[8]=2*-w.x/this._helper._width,h[9]=2*w.y/this._helper._height,this._projectionMatrix=t.b4(h),this._globeProjMatrixInverted=t.b9(),t.ap(this._globeProjMatrixInverted,h),t.M(h,h,[0,0,-this.cameraToCenterDistance]),t.b5(h,h,this.rollInRadians),t.b6(h,h,-this.pitchInRadians),t.b5(h,h,this.bearingInRadians),t.M(h,h,[0,0,-r]);let A=t.bo();A[0]=r,A[1]=r,A[2]=r,t.b6(x,h,this.center.lat*Math.PI/180),t.by(x,x,-this.center.lng*Math.PI/180),t.N(x,x,A),this._globeViewProjMatrixNoCorrection=x,t.b6(h,h,this.center.lat*Math.PI/180-this._globeLatitudeErrorCorrectionRadians),t.by(h,h,-this.center.lng*Math.PI/180),t.N(h,h,A),this._globeViewProjMatrix32f=new Float32Array(h),this._globeViewProjMatrixNoCorrectionInverted=t.b9(),t.ap(this._globeViewProjMatrixNoCorrectionInverted,x);let k=t.bo();this._cameraPosition=t.bo(),this._cameraPosition[2]=this.cameraToCenterDistance/r,t.bv(this._cameraPosition,this._cameraPosition,k,-this.rollInRadians),t.bw(this._cameraPosition,this._cameraPosition,k,this.pitchInRadians),t.bv(this._cameraPosition,this._cameraPosition,k,-this.bearingInRadians),t.aR(this._cameraPosition,this._cameraPosition,[0,0,1]),t.bw(this._cameraPosition,this._cameraPosition,k,-this.center.lat*Math.PI/180),t.bx(this._cameraPosition,this._cameraPosition,k,this.center.lng*Math.PI/180),this._cachedClippingPlane=this._computeClippingPlane(r);let j=t.b4(this._globeViewProjMatrixNoCorrectionInverted);t.N(j,j,[1,1,-1]),this._cachedFrustum=Xs.fromInvProjectionMatrix(j,1,0,this._cachedClippingPlane,!0)}calculateFogMatrix(r){t.w("calculateFogMatrix is not supported on globe projection.");let h=t.b9();return t.af(h),h}getVisibleUnwrappedCoordinates(r){return[new t.b1(0,r)]}getCameraFrustum(){return this._cachedFrustum}getClippingPlane(){return this._cachedClippingPlane}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(r){r&&t.w("terrain is not fully supported on vertical perspective projection."),this._helper.recalculateZoomAndCenter(0)}maxPitchScaleFactor(){return 1}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(r,h){if(!this._globeViewProjMatrixNoCorrection)return 1;let x=Ns(r);t.aQ(x,x,1+h/t.bt);let w=t.bu();return t.av(w,[x[0],x[1],x[2],1],this._globeViewProjMatrixNoCorrection),w[2]/w[3]}populateCache(r){}getBounds(){let r=.5*this.width,h=.5*this.height,x=[new t.P(0,0),new t.P(r,0),new t.P(this.width,0),new t.P(this.width,h),new t.P(this.width,this.height),new t.P(r,this.height),new t.P(0,this.height),new t.P(0,h)],w=[];for(let pe of x)w.push(this.unprojectScreenPoint(pe));let A=0,k=0,j=0,q=0,J=this.center;for(let pe of w){let ue=t.bz(J.lng,pe.lng),ge=t.bz(J.lat,pe.lat);ue<k&&(k=ue),ue>A&&(A=ue),ge<q&&(q=ge),ge>j&&(j=ge)}let ne=[J.lng+k,J.lat+q,J.lng+A,J.lat+j];return this.isSurfacePointOnScreen([0,1,0])&&(ne[3]=90,ne[0]=-180,ne[2]=180),this.isSurfacePointOnScreen([0,-1,0])&&(ne[1]=-90,ne[0]=-180,ne[2]=180),new hr(ne)}getConstrained(r,h){let x=t.ag(r.lat,-85.051129,t.ah),w=t.ag(+h,this.minZoom+Ds(0,x),this.maxZoom);return{center:new t.S(r.lng,x),zoom:w}}calculateCenterFromCameraLngLatAlt(r,h,x,w){return this._helper.calculateCenterFromCameraLngLatAlt(r,h,x,w)}setLocationAtPoint(r,h){let x=Ns(this.unprojectScreenPoint(h)),w=Ns(r),A=t.bo();t.bA(A);let k=t.bo();t.bx(k,x,A,-this.center.lng*Math.PI/180),t.bw(k,k,A,this.center.lat*Math.PI/180);let j=w[0]*w[0]+w[2]*w[2],q=k[0]*k[0];if(j<q)return;let J=Math.sqrt(j-q),ne=-J,pe=t.bB(w[0],w[2],k[0],J),ue=t.bB(w[0],w[2],k[0],ne),ge=t.bo();t.bx(ge,w,A,-pe);let Ee=t.bB(ge[1],ge[2],k[1],k[2]),tt=t.bo();t.bx(tt,w,A,-ue);let Xe=t.bB(tt[1],tt[2],k[1],k[2]),et=.5*Math.PI,Se=Ee>=-et&&Ee<=et,Be=Xe>=-et&&Xe<=et,ft,dt;if(Se&&Be){let ei=this.center.lng*Math.PI/180,Kt=this.center.lat*Math.PI/180;t.bC(pe,ei)+t.bC(Ee,Kt)<t.bC(ue,ei)+t.bC(Xe,Kt)?(ft=pe,dt=Ee):(ft=ue,dt=Xe)}else if(Se)ft=pe,dt=Ee;else{if(!Be)return;ft=ue,dt=Xe}let xe=ft/Math.PI*180,pt=dt/Math.PI*180,zt=this.center.lat;this.setCenter(new t.S(xe,t.ag(pt,-90,90))),this.setZoom(this.zoom+Ds(zt,this.center.lat))}locationToScreenPoint(r,h){let x=Ns(r);if(h){let w=h.getElevationForLngLatZoom(r,this._helper._tileZoom);t.aQ(x,x,1+w/t.bt)}return this._projectSurfacePointToScreen(x)}_projectSurfacePointToScreen(r){let h=t.bu();return t.av(h,[...r,1],this._globeViewProjMatrixNoCorrection),h[0]/=h[3],h[1]/=h[3],new t.P((.5*h[0]+.5)*this.width,(.5*-h[1]+.5)*this.height)}screenPointToMercatorCoordinate(r,h){if(h){let x=h.pointCoordinate(r);if(x)return x}return t.a0.fromLngLat(this.unprojectScreenPoint(r))}screenPointToLocation(r,h){var x;return(x=this.screenPointToMercatorCoordinate(r,h))===null||x===void 0?void 0:x.toLngLat()}isPointOnMapSurface(r,h){let x=this._cameraPosition,w=this.getRayDirectionFromPixel(r);return!!this.rayPlanetIntersection(x,w)}getRayDirectionFromPixel(r){let h=t.bu();h[0]=r.x/this.width*2-1,h[1]=-1*(r.y/this.height*2-1),h[2]=1,h[3]=1,t.av(h,h,this._globeViewProjMatrixNoCorrectionInverted),h[0]/=h[3],h[1]/=h[3],h[2]/=h[3];let x=t.bo();x[0]=h[0]-this._cameraPosition[0],x[1]=h[1]-this._cameraPosition[1],x[2]=h[2]-this._cameraPosition[2];let w=t.bo();return t.aU(w,x),w}isSurfacePointVisible(r){let h=this._cachedClippingPlane;return h[0]*r[0]+h[1]*r[1]+h[2]*r[2]+h[3]>=0}isSurfacePointOnScreen(r){if(!this.isSurfacePointVisible(r))return!1;let h=t.bu();return t.av(h,[...r,1],this._globeViewProjMatrixNoCorrection),h[0]/=h[3],h[1]/=h[3],h[2]/=h[3],h[0]>-1&&h[0]<1&&h[1]>-1&&h[1]<1&&h[2]>-1&&h[2]<1}rayPlanetIntersection(r,h){let x=t.aW(r,h),w=t.bo(),A=t.bo();t.aQ(A,h,x),t.aT(w,r,A);let k=1-t.aW(w,w);if(k<0)return null;let j=t.aW(r,r)-1,q=-x+(x<0?1:-1)*Math.sqrt(k),J=j/q,ne=q;return{tMin:Math.min(J,ne),tMax:Math.max(J,ne)}}unprojectScreenPoint(r){let h=this._cameraPosition,x=this.getRayDirectionFromPixel(r),w=this.rayPlanetIntersection(h,x);if(w){let ne=t.bo();t.aR(ne,h,[x[0]*w.tMin,x[1]*w.tMin,x[2]*w.tMin]);let pe=t.bo();return t.aU(pe,ne),Jc(pe)}let A=this._cachedClippingPlane,k=A[0]*x[0]+A[1]*x[1]+A[2]*x[2],j=-t.b0(A,h)/k,q=t.bo();if(j>0)t.aR(q,h,[x[0]*j,x[1]*j,x[2]*j]);else{let ne=t.bo();t.aR(ne,h,[2*x[0],2*x[1],2*x[2]]);let pe=t.b0(this._cachedClippingPlane,ne);t.aT(q,ne,[this._cachedClippingPlane[0]*pe,this._cachedClippingPlane[1]*pe,this._cachedClippingPlane[2]*pe])}let J=function(ne){let pe=t.bo();return pe[0]=ne[0]*-ne[3],pe[1]=ne[1]*-ne[3],pe[2]=ne[2]*-ne[3],{center:pe,radius:Math.sqrt(1-ne[3]*ne[3])}}(A);return Jc(function(ne,pe,ue){let ge=t.bo();t.aT(ge,ue,ne);let Ee=t.bo();return t.bp(Ee,ne,ge,pe/t.a_(ge)),Ee}(J.center,J.radius,q))}getMatrixForModel(r,h){let x=t.S.convert(r),w=1/t.bt,A=t.b8();return t.by(A,A,x.lng/180*Math.PI),t.b6(A,A,-x.lat/180*Math.PI),t.M(A,A,[0,0,1+h/t.bt]),t.b6(A,A,.5*Math.PI),t.N(A,A,[w,w,w]),A}getProjectionDataForCustomLayer(r=!0){let h=this.getProjectionData({overscaledTileID:new t.Z(0,0,0,0,0),applyGlobeMatrix:r});return h.tileMercatorCoords=[0,0,1,1],h}getFastPathSimpleProjectionMatrix(r){}}class Xn{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(r){this._helper.setMinZoom(r)}setMaxZoom(r){this._helper.setMaxZoom(r)}setMinPitch(r){this._helper.setMinPitch(r)}setMaxPitch(r){this._helper.setMaxPitch(r)}setRenderWorldCopies(r){this._helper.setRenderWorldCopies(r)}setBearing(r){this._helper.setBearing(r)}setPitch(r){this._helper.setPitch(r)}setRoll(r){this._helper.setRoll(r)}setFov(r){this._helper.setFov(r)}setZoom(r){this._helper.setZoom(r)}setCenter(r){this._helper.setCenter(r)}setElevation(r){this._helper.setElevation(r)}setMinElevationForCurrentTile(r){this._helper.setMinElevationForCurrentTile(r)}setPadding(r){this._helper.setPadding(r)}interpolatePadding(r,h,x){return this._helper.interpolatePadding(r,h,x)}isPaddingEqual(r){return this._helper.isPaddingEqual(r)}resize(r,h,x=!0){this._helper.resize(r,h,x)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(r){this._helper.setMaxBounds(r)}overrideNearFarZ(r,h){this._helper.overrideNearFarZ(r,h)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(r){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),r)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}get isGlobeRendering(){return this._globeness>0}setTransitionState(r,h){this._globeness=r,this._globeLatitudeErrorCorrectionRadians=h,this._calcMatrices(),this._verticalPerspectiveTransform.getCoveringTilesDetailsProvider().prepareNextFrame(),this._mercatorTransform.getCoveringTilesDetailsProvider().prepareNextFrame()}get currentTransform(){return this.isGlobeRendering?this._verticalPerspectiveTransform:this._mercatorTransform}constructor(){this._globeLatitudeErrorCorrectionRadians=0,this._globeness=1,this._helper=new vc({calcMatrices:()=>{this._calcMatrices()},getConstrained:(r,h)=>this.getConstrained(r,h)}),this._globeness=1,this._mercatorTransform=new wn,this._verticalPerspectiveTransform=new br}clone(){let r=new Xn;return r._globeness=this._globeness,r._globeLatitudeErrorCorrectionRadians=this._globeLatitudeErrorCorrectionRadians,r.apply(this),r}apply(r){this._helper.apply(r),this._mercatorTransform.apply(this),this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians)}get projectionMatrix(){return this.currentTransform.projectionMatrix}get modelViewProjectionMatrix(){return this.currentTransform.modelViewProjectionMatrix}get inverseProjectionMatrix(){return this.currentTransform.inverseProjectionMatrix}get cameraPosition(){return this.currentTransform.cameraPosition}getProjectionData(r){let h=this._mercatorTransform.getProjectionData(r),x=this._verticalPerspectiveTransform.getProjectionData(r);return{mainMatrix:this.isGlobeRendering?x.mainMatrix:h.mainMatrix,clippingPlane:x.clippingPlane,tileMercatorCoords:x.tileMercatorCoords,projectionTransition:r.applyGlobeMatrix?this._globeness:0,fallbackMatrix:h.fallbackMatrix}}isLocationOccluded(r){return this.currentTransform.isLocationOccluded(r)}transformLightDirection(r){return this.currentTransform.transformLightDirection(r)}getPixelScale(){return t.bj(this._mercatorTransform.getPixelScale(),this._verticalPerspectiveTransform.getPixelScale(),this._globeness)}getCircleRadiusCorrection(){return t.bj(this._mercatorTransform.getCircleRadiusCorrection(),this._verticalPerspectiveTransform.getCircleRadiusCorrection(),this._globeness)}getPitchedTextCorrection(r,h,x){let w=this._mercatorTransform.getPitchedTextCorrection(r,h,x),A=this._verticalPerspectiveTransform.getPitchedTextCorrection(r,h,x);return t.bj(w,A,this._globeness)}projectTileCoordinates(r,h,x,w){return this.currentTransform.projectTileCoordinates(r,h,x,w)}_calcMatrices(){this._helper._width&&this._helper._height&&(this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians),this._helper._nearZ=this._verticalPerspectiveTransform.nearZ,this._helper._farZ=this._verticalPerspectiveTransform.farZ,this._mercatorTransform.apply(this,!0,this.isGlobeRendering),this._helper._nearZ=this._mercatorTransform.nearZ,this._helper._farZ=this._mercatorTransform.farZ)}calculateFogMatrix(r){return this.currentTransform.calculateFogMatrix(r)}getVisibleUnwrappedCoordinates(r){return this.currentTransform.getVisibleUnwrappedCoordinates(r)}getCameraFrustum(){return this.currentTransform.getCameraFrustum()}getClippingPlane(){return this.currentTransform.getClippingPlane()}getCoveringTilesDetailsProvider(){return this.currentTransform.getCoveringTilesDetailsProvider()}recalculateZoomAndCenter(r){this._mercatorTransform.recalculateZoomAndCenter(r),this._verticalPerspectiveTransform.recalculateZoomAndCenter(r)}maxPitchScaleFactor(){return this._mercatorTransform.maxPitchScaleFactor()}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(r,h){return this.currentTransform.lngLatToCameraDepth(r,h)}populateCache(r){this._mercatorTransform.populateCache(r),this._verticalPerspectiveTransform.populateCache(r)}getBounds(){return this.currentTransform.getBounds()}getConstrained(r,h){return this.currentTransform.getConstrained(r,h)}calculateCenterFromCameraLngLatAlt(r,h,x,w){return this._helper.calculateCenterFromCameraLngLatAlt(r,h,x,w)}setLocationAtPoint(r,h){if(!this.isGlobeRendering)return this._mercatorTransform.setLocationAtPoint(r,h),void this.apply(this._mercatorTransform);this._verticalPerspectiveTransform.setLocationAtPoint(r,h),this.apply(this._verticalPerspectiveTransform)}locationToScreenPoint(r,h){return this.currentTransform.locationToScreenPoint(r,h)}screenPointToMercatorCoordinate(r,h){return this.currentTransform.screenPointToMercatorCoordinate(r,h)}screenPointToLocation(r,h){return this.currentTransform.screenPointToLocation(r,h)}isPointOnMapSurface(r,h){return this.currentTransform.isPointOnMapSurface(r,h)}getRayDirectionFromPixel(r){return this._verticalPerspectiveTransform.getRayDirectionFromPixel(r)}getMatrixForModel(r,h){return this.currentTransform.getMatrixForModel(r,h)}getProjectionDataForCustomLayer(r=!0){let h=this._mercatorTransform.getProjectionDataForCustomLayer(r);if(!this.isGlobeRendering)return h;let x=this._verticalPerspectiveTransform.getProjectionDataForCustomLayer(r);return x.fallbackMatrix=h.mainMatrix,x}getFastPathSimpleProjectionMatrix(r){return this.currentTransform.getFastPathSimpleProjectionMatrix(r)}}class Do{get useGlobeControls(){return!0}handlePanInertia(r,h){let x=en(r,h);return Math.abs(x.lng-h.center.lng)>180&&(x.lng=h.center.lng+179.5*Math.sign(x.lng-h.center.lng)),{easingCenter:x,easingOffset:new t.P(0,0)}}handleMapControlsRollPitchBearingZoom(r,h){let x=r.around,w=h.screenPointToLocation(x);r.bearingDelta&&h.setBearing(h.bearing+r.bearingDelta),r.pitchDelta&&h.setPitch(h.pitch+r.pitchDelta),r.rollDelta&&h.setRoll(h.roll+r.rollDelta);let A=h.zoom;r.zoomDelta&&h.setZoom(h.zoom+r.zoomDelta);let k=h.zoom-A;if(k===0)return;let j=t.bz(h.center.lng,w.lng),q=j/(Math.abs(j/180)+1),J=t.bz(h.center.lat,w.lat),ne=h.getRayDirectionFromPixel(x),pe=h.cameraPosition,ue=-1*t.aW(pe,ne),ge=t.bo();t.aR(ge,pe,[ne[0]*ue,ne[1]*ue,ne[2]*ue]);let Ee=t.aY(ge)-1,tt=Math.exp(.5*-Math.max(Ee-.3,0)),Xe=Yc(h.worldSize,h.center.lat)/Math.min(h.width,h.height),et=t.bm(Xe,.9,.5,1,.25),Se=(1-t.ae(-k))*Math.min(tt,et),Be=h.center.lat,ft=h.zoom,dt=new t.S(h.center.lng+q*Se,t.ag(h.center.lat+J*Se,-85.051129,t.ah));h.setLocationAtPoint(w,x);let xe=h.center,pt=t.bm(Math.abs(j),45,85,0,1),zt=t.bm(Xe,.75,.35,0,1),ei=Math.pow(Math.max(pt,zt),.25),Kt=t.bz(xe.lng,dt.lng),Jt=t.bz(xe.lat,dt.lat);h.setCenter(new t.S(xe.lng+Kt*ei,xe.lat+Jt*ei).wrap()),h.setZoom(ft+Ds(Be,h.center.lat))}handleMapControlsPan(r,h,x){if(!r.panDelta)return;let w=h.center.lat,A=h.zoom;h.setCenter(en(r.panDelta,h).wrap()),h.setZoom(A+Ds(w,h.center.lat))}cameraForBoxAndBearing(r,h,x,w,A){let k=cs(r,h,x,w,A),j=h.left/A.width*2-1,q=(A.width-h.right)/A.width*2-1,J=h.top/A.height*-2+1,ne=(A.height-h.bottom)/A.height*-2+1,pe=t.bz(x.getWest(),x.getEast())<0,ue=pe?x.getEast():x.getWest(),ge=pe?x.getWest():x.getEast(),Ee=Math.max(x.getNorth(),x.getSouth()),tt=Math.min(x.getNorth(),x.getSouth()),Xe=ue+.5*t.bz(ue,ge),et=Ee+.5*t.bz(Ee,tt),Se=A.clone();Se.setCenter(k.center),Se.setBearing(k.bearing),Se.setPitch(0),Se.setRoll(0),Se.setZoom(k.zoom);let Be=Se.modelViewProjectionMatrix,ft=[Ns(x.getNorthWest()),Ns(x.getNorthEast()),Ns(x.getSouthWest()),Ns(x.getSouthEast()),Ns(new t.S(ge,et)),Ns(new t.S(ue,et)),Ns(new t.S(Xe,Ee)),Ns(new t.S(Xe,tt))],dt=Ns(k.center),xe=Number.POSITIVE_INFINITY;for(let pt of ft)j<0&&(xe=Do.getLesserNonNegativeNonNull(xe,Do.solveVectorScale(pt,dt,Be,"x",j))),q>0&&(xe=Do.getLesserNonNegativeNonNull(xe,Do.solveVectorScale(pt,dt,Be,"x",q))),J>0&&(xe=Do.getLesserNonNegativeNonNull(xe,Do.solveVectorScale(pt,dt,Be,"y",J))),ne<0&&(xe=Do.getLesserNonNegativeNonNull(xe,Do.solveVectorScale(pt,dt,Be,"y",ne)));if(Number.isFinite(xe)&&xe!==0)return k.zoom=Se.zoom+t.aj(xe),k;Ps()}handleJumpToCenterZoom(r,h){let x=r.center.lat,w=r.getConstrained(h.center?t.S.convert(h.center):r.center,r.zoom).center;r.setCenter(w.wrap());let A=h.zoom!==void 0?+h.zoom:r.zoom+Ds(x,w.lat);r.zoom!==A&&r.setZoom(A)}handleEaseTo(r,h){let x=r.zoom,w=r.center,A=r.padding,k={roll:r.roll,pitch:r.pitch,bearing:r.bearing},j={roll:h.roll===void 0?r.roll:h.roll,pitch:h.pitch===void 0?r.pitch:h.pitch,bearing:h.bearing===void 0?r.bearing:h.bearing},q=h.zoom!==void 0,J=!r.isPaddingEqual(h.padding),ne=!1,pe=h.center?t.S.convert(h.center):w,ue=r.getConstrained(pe,x).center;Al(r,ue);let ge=r.clone();ge.setCenter(ue),ge.setZoom(q?+h.zoom:x+Ds(w.lat,pe.lat)),ge.setBearing(h.bearing);let Ee=new t.P(t.ag(r.centerPoint.x+h.offsetAsPoint.x,0,r.width),t.ag(r.centerPoint.y+h.offsetAsPoint.y,0,r.height));ge.setLocationAtPoint(ue,Ee);let tt=(h.offset&&h.offsetAsPoint.mag())>0?ge.center:ue,Xe=q?+h.zoom:x+Ds(w.lat,tt.lat),et=x+Ds(w.lat,0),Se=Xe+Ds(tt.lat,0),Be=t.bz(w.lng,tt.lng),ft=t.bz(w.lat,tt.lat),dt=t.ae(Se-et);return ne=Xe!==x,{easeFunc:xe=>{if(t.bd(k,j)||gs({startEulerAngles:k,endEulerAngles:j,tr:r,k:xe,useSlerp:k.roll!=j.roll}),J&&r.interpolatePadding(A,h.padding,xe),h.around)t.w("Easing around a point is not supported under globe projection."),r.setLocationAtPoint(h.around,h.aroundPoint);else{let pt=Se>et?Math.min(2,dt):Math.max(.5,dt),zt=Math.pow(pt,1-xe),ei=Qc(w,Be,ft,xe*zt);r.setCenter(ei.wrap())}if(ne){let pt=t.C.number(et,Se,xe)+Ds(0,r.center.lat);r.setZoom(pt)}},isZooming:ne,elevationCenter:tt}}handleFlyTo(r,h){let x=h.zoom!==void 0,w=r.center,A=r.zoom,k=r.padding,j=!r.isPaddingEqual(h.padding),q=r.getConstrained(t.S.convert(h.center||h.locationAtOffset),A).center,J=x?+h.zoom:r.zoom+Ds(r.center.lat,q.lat),ne=r.clone();ne.setCenter(q),ne.setZoom(J),ne.setBearing(h.bearing);let pe=new t.P(t.ag(r.centerPoint.x+h.offsetAsPoint.x,0,r.width),t.ag(r.centerPoint.y+h.offsetAsPoint.y,0,r.height));ne.setLocationAtPoint(q,pe);let ue=ne.center;Al(r,ue);let ge=function(ft,dt,xe){let pt=Ns(dt),zt=Ns(xe),ei=t.aW(pt,zt),Kt=Math.acos(ei),Jt=nc(ft);return Kt/(2*Math.PI)*Jt}(r,w,ue),Ee=A+Ds(w.lat,0),tt=J+Ds(ue.lat,0),Xe=t.ae(tt-Ee),et;if(typeof h.minZoom=="number"){let ft=+h.minZoom+Ds(ue.lat,0),dt=Math.min(ft,Ee,tt)+Ds(0,ue.lat),xe=r.getConstrained(ue,dt).zoom+Ds(ue.lat,0);et=t.ae(xe-Ee)}let Se=t.bz(w.lng,ue.lng),Be=t.bz(w.lat,ue.lat);return{easeFunc:(ft,dt,xe,pt)=>{let zt=Qc(w,Se,Be,xe);j&&r.interpolatePadding(k,h.padding,ft);let ei=ft===1?ue:zt;r.setCenter(ei.wrap());let Kt=Ee+t.aj(dt);r.setZoom(ft===1?J:Kt+Ds(0,ei.lat))},scaleOfZoom:Xe,targetCenter:ue,scaleOfMinZoom:et,pixelPathLength:ge}}static solveVectorScale(r,h,x,w,A){let k=w==="x"?[x[0],x[4],x[8],x[12]]:[x[1],x[5],x[9],x[13]],j=[x[3],x[7],x[11],x[15]],q=r[0]*k[0]+r[1]*k[1]+r[2]*k[2],J=r[0]*j[0]+r[1]*j[1]+r[2]*j[2],ne=h[0]*k[0]+h[1]*k[1]+h[2]*k[2],pe=h[0]*j[0]+h[1]*j[1]+h[2]*j[2];return ne+A*J===q+A*pe||j[3]*(q-ne)+k[3]*(pe-J)+q*pe==ne*J?null:(ne+k[3]-A*pe-A*j[3])/(ne-q-A*pe+A*J)}static getLesserNonNegativeNonNull(r,h){return h!==null&&h>=0&&h<r?h:r}}class bc{constructor(r){this._globe=r,this._mercatorCameraHelper=new Ed,this._verticalPerspectiveCameraHelper=new Do}get useGlobeControls(){return this._globe.useGlobeRendering}get currentHelper(){return this.useGlobeControls?this._verticalPerspectiveCameraHelper:this._mercatorCameraHelper}handlePanInertia(r,h){return this.currentHelper.handlePanInertia(r,h)}handleMapControlsRollPitchBearingZoom(r,h){return this.currentHelper.handleMapControlsRollPitchBearingZoom(r,h)}handleMapControlsPan(r,h,x){this.currentHelper.handleMapControlsPan(r,h,x)}cameraForBoxAndBearing(r,h,x,w,A){return this.currentHelper.cameraForBoxAndBearing(r,h,x,w,A)}handleJumpToCenterZoom(r,h){this.currentHelper.handleJumpToCenterZoom(r,h)}handleEaseTo(r,h){return this.currentHelper.handleEaseTo(r,h)}handleFlyTo(r,h){return this.currentHelper.handleFlyTo(r,h)}}let dr=(M,r)=>t.y(M,r&&r.filter(h=>h.identifier!=="source.canvas")),Rl=t.bD();class lu extends t.E{constructor(r,h={}){super(),this._rtlPluginLoaded=()=>{for(let x in this.sourceCaches){let w=this.sourceCaches[x].getSource().type;w!=="vector"&&w!=="geojson"||this.sourceCaches[x].reload()}},this.map=r,this.dispatcher=new jr(Lr(),r._getMapId()),this.dispatcher.registerMessageHandler("GG",(x,w)=>this.getGlyphs(x,w)),this.dispatcher.registerMessageHandler("GI",(x,w)=>this.getImages(x,w)),this.imageManager=new Aa,this.imageManager.setEventedParent(this),this.glyphManager=new No(r._requestManager,h.localIdeographFontFamily),this.lineAtlas=new $a(256,512),this.crossTileSymbolIndex=new al,this._spritesImagesIds={},this._layers={},this._order=[],this.sourceCaches={},this.zoomHistory=new t.bE,this._loaded=!1,this._availableImages=[],this._globalState={},this._resetUpdates(),this.dispatcher.broadcast("SR",t.bF()),Hs().on(fs,this._rtlPluginLoaded),this.on("data",x=>{if(x.dataType!=="source"||x.sourceDataType!=="metadata")return;let w=this.sourceCaches[x.sourceId];if(!w)return;let A=w.getSource();if(A&&A.vectorLayerIds)for(let k in this._layers){let j=this._layers[k];j.source===A.id&&this._validateLayer(j)}})}setGlobalStateProperty(r,h){var x,w,A;this._checkLoaded();let k=h===null?(A=(w=(x=this.stylesheet.state)===null||x===void 0?void 0:x[r])===null||w===void 0?void 0:w.default)!==null&&A!==void 0?A:null:h;if(t.bG(k,this._globalState[r]))return this;this._globalState[r]=k;let j=this._findGlobalStateAffectedSources([r]);for(let q in this.sourceCaches)j.has(q)&&(this._reloadSource(q),this._changed=!0)}getGlobalState(){return this._globalState}setGlobalState(r){this._checkLoaded();let h=[];for(let w in r)!t.bG(this._globalState[w],r[w].default)&&(h.push(w),this._globalState[w]=r[w].default);let x=this._findGlobalStateAffectedSources(h);for(let w in this.sourceCaches)x.has(w)&&(this._reloadSource(w),this._changed=!0)}_findGlobalStateAffectedSources(r){if(r.length===0)return new Set;let h=new Set;for(let x in this._layers){let w=this._layers[x],A=w.getLayoutAffectingGlobalStateRefs();for(let k of r)A.has(k)&&h.add(w.source)}return h}loadURL(r,h={},x){this.fire(new t.l("dataloading",{dataType:"style"})),h.validate=typeof h.validate!="boolean"||h.validate;let w=this.map._requestManager.transformRequest(r,"Style");this._loadStyleRequest=new AbortController;let A=this._loadStyleRequest;t.j(w,this._loadStyleRequest).then(k=>{this._loadStyleRequest=null,this._load(k.data,h,x)}).catch(k=>{this._loadStyleRequest=null,k&&!A.signal.aborted&&this.fire(new t.k(k))})}loadJSON(r,h={},x){this.fire(new t.l("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,an.frameAsync(this._frameRequest).then(()=>{this._frameRequest=null,h.validate=h.validate!==!1,this._load(r,h,x)}).catch(()=>{})}loadEmpty(){this.fire(new t.l("dataloading",{dataType:"style"})),this._load(Rl,{validate:!1})}_load(r,h,x){var w,A,k;let j=h.transformStyle?h.transformStyle(x,r):r;if(!h.validate||!dr(this,t.z(j))){this._loaded=!0,this.stylesheet=j;for(let q in j.sources)this.addSource(q,j.sources[q],{validate:!1});j.sprite?this._loadSprite(j.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(j.glyphs),this._createLayers(),this.light=new ss(this.stylesheet.light),this._setProjectionInternal(((w=this.stylesheet.projection)===null||w===void 0?void 0:w.type)||"mercator"),this.sky=new dl(this.stylesheet.sky),this.map.setTerrain((A=this.stylesheet.terrain)!==null&&A!==void 0?A:null),this.setGlobalState((k=this.stylesheet.state)!==null&&k!==void 0?k:null),this.fire(new t.l("data",{dataType:"style"})),this.fire(new t.l("style.load"))}}_createLayers(){let r=t.bH(this.stylesheet.layers);this.dispatcher.broadcast("SL",r),this._order=r.map(h=>h.id),this._layers={},this._serializedLayers=null;for(let h of r){let x=t.bI(h);x.setEventedParent(this,{layer:{id:h.id}}),this._layers[h.id]=x}}_loadSprite(r,h=!1,x=void 0){let w;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,function(A,k,j,q){return t._(this,void 0,void 0,function*(){let J=Br(A),ne=j>1?"@2x":"",pe={},ue={};for(let{id:ge,url:Ee}of J){let tt=k.transformRequest(os(Ee,ne,".json"),"SpriteJSON");pe[ge]=t.j(tt,q);let Xe=k.transformRequest(os(Ee,ne,".png"),"SpriteImage");ue[ge]=qo.getImage(Xe,q)}return yield Promise.all([...Object.values(pe),...Object.values(ue)]),function(ge,Ee){return t._(this,void 0,void 0,function*(){let tt={};for(let Xe in ge){tt[Xe]={};let et=an.getImageCanvasContext((yield Ee[Xe]).data),Se=(yield ge[Xe]).data;for(let Be in Se){let{width:ft,height:dt,x:xe,y:pt,sdf:zt,pixelRatio:ei,stretchX:Kt,stretchY:Jt,content:si,textFitWidth:Xi,textFitHeight:Ki}=Se[Be];tt[Xe][Be]={data:null,pixelRatio:ei,sdf:zt,stretchX:Kt,stretchY:Jt,content:si,textFitWidth:Xi,textFitHeight:Ki,spriteData:{width:ft,height:dt,x:xe,y:pt,context:et}}}}return tt})}(pe,ue)})}(r,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then(A=>{if(this._spriteRequest=null,A)for(let k in A){this._spritesImagesIds[k]=[];let j=this._spritesImagesIds[k]?this._spritesImagesIds[k].filter(q=>!(q in A)):[];for(let q of j)this.imageManager.removeImage(q),this._changedImages[q]=!0;for(let q in A[k]){let J=k==="default"?q:`${k}:${q}`;this._spritesImagesIds[k].push(J),J in this.imageManager.images?this.imageManager.updateImage(J,A[k][q],!1):this.imageManager.addImage(J,A[k][q]),h&&(this._changedImages[J]=!0)}}}).catch(A=>{this._spriteRequest=null,w=A,this.fire(new t.k(w))}).finally(()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),h&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new t.l("data",{dataType:"style"})),x&&x(w)})}_unloadSprite(){for(let r of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(r),this._changedImages[r]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new t.l("data",{dataType:"style"}))}_validateLayer(r){let h=this.sourceCaches[r.source];if(!h)return;let x=r.sourceLayer;if(!x)return;let w=h.getSource();(w.type==="geojson"||w.vectorLayerIds&&w.vectorLayerIds.indexOf(x)===-1)&&this.fire(new t.k(new Error(`Source layer "${x}" does not exist on source "${w.id}" as specified by style layer "${r.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(let r in this.sourceCaches)if(!this.sourceCaches[r].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(r,h=!1){let x=this._serializedAllLayers();if(!r||r.length===0)return Object.values(h?t.bJ(x):x);let w=[];for(let A of r)if(x[A]){let k=h?t.bJ(x[A]):x[A];w.push(k)}return w}_serializedAllLayers(){let r=this._serializedLayers;if(r)return r;r=this._serializedLayers={};let h=Object.keys(this._layers);for(let x of h){let w=this._layers[x];w.type!=="custom"&&(r[x]=w.serialize())}return r}hasTransitions(){var r,h,x;if(!((r=this.light)===null||r===void 0)&&r.hasTransition()||!((h=this.sky)===null||h===void 0)&&h.hasTransition()||!((x=this.projection)===null||x===void 0)&&x.hasTransition())return!0;for(let w in this.sourceCaches)if(this.sourceCaches[w].hasTransition())return!0;for(let w in this._layers)if(this._layers[w].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(r){if(!this._loaded)return;let h=this._changed;if(h){let w=Object.keys(this._updatedLayers),A=Object.keys(this._removedLayers);(w.length||A.length)&&this._updateWorkerLayers(w,A);for(let k in this._updatedSources){let j=this._updatedSources[k];if(j==="reload")this._reloadSource(k);else{if(j!=="clear")throw new Error(`Invalid action ${j}`);this._clearSource(k)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(let k in this._updatedPaintProps)this._layers[k].updateTransitions(r);this.light.updateTransitions(r),this.sky.updateTransitions(r),this._resetUpdates()}let x={};for(let w in this.sourceCaches){let A=this.sourceCaches[w];x[w]=A.used,A.used=!1}for(let w of this._order){let A=this._layers[w];A.recalculate(r,this._availableImages),!A.isHidden(r.zoom)&&A.source&&(this.sourceCaches[A.source].used=!0)}for(let w in x){let A=this.sourceCaches[w];!!x[w]!=!!A.used&&A.fire(new t.l("data",{sourceDataType:"visibility",dataType:"source",sourceId:w}))}this.light.recalculate(r),this.sky.recalculate(r),this.projection.recalculate(r),this.z=r.zoom,h&&this.fire(new t.l("data",{dataType:"style"}))}_updateTilesForChangedImages(){let r=Object.keys(this._changedImages);if(r.length){for(let h in this.sourceCaches)this.sourceCaches[h].reloadTilesForDependencies(["icons","patterns"],r);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(let r in this.sourceCaches)this.sourceCaches[r].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(r,h){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(r,!1),removedIds:h})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(r,h={}){var x;this._checkLoaded();let w=this.serialize();if(r=h.transformStyle?h.transformStyle(w,r):r,((x=h.validate)===null||x===void 0||x)&&dr(this,t.z(r)))return!1;(r=t.bJ(r)).layers=t.bH(r.layers);let A=t.bK(w,r),k=this._getOperationsToPerform(A);if(k.unimplemented.length>0)throw new Error(`Unimplemented: ${k.unimplemented.join(", ")}.`);if(k.operations.length===0)return!1;for(let j of k.operations)j();return this.stylesheet=r,this._serializedLayers=null,!0}_getOperationsToPerform(r){let h=[],x=[];for(let w of r)switch(w.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":case"setRoll":continue;case"addLayer":h.push(()=>this.addLayer.apply(this,w.args));break;case"removeLayer":h.push(()=>this.removeLayer.apply(this,w.args));break;case"setPaintProperty":h.push(()=>this.setPaintProperty.apply(this,w.args));break;case"setLayoutProperty":h.push(()=>this.setLayoutProperty.apply(this,w.args));break;case"setFilter":h.push(()=>this.setFilter.apply(this,w.args));break;case"addSource":h.push(()=>this.addSource.apply(this,w.args));break;case"removeSource":h.push(()=>this.removeSource.apply(this,w.args));break;case"setLayerZoomRange":h.push(()=>this.setLayerZoomRange.apply(this,w.args));break;case"setLight":h.push(()=>this.setLight.apply(this,w.args));break;case"setGeoJSONSourceData":h.push(()=>this.setGeoJSONSourceData.apply(this,w.args));break;case"setGlyphs":h.push(()=>this.setGlyphs.apply(this,w.args));break;case"setSprite":h.push(()=>this.setSprite.apply(this,w.args));break;case"setTerrain":h.push(()=>this.map.setTerrain.apply(this,w.args));break;case"setSky":h.push(()=>this.setSky.apply(this,w.args));break;case"setProjection":this.setProjection.apply(this,w.args);break;case"setGlobalState":h.push(()=>this.setGlobalState.apply(this,w.args));break;case"setTransition":h.push(()=>{});break;default:x.push(w.command)}return{operations:h,unimplemented:x}}addImage(r,h){if(this.getImage(r))return this.fire(new t.k(new Error(`An image named "${r}" already exists.`)));this.imageManager.addImage(r,h),this._afterImageUpdated(r)}updateImage(r,h){this.imageManager.updateImage(r,h)}getImage(r){return this.imageManager.getImage(r)}removeImage(r){if(!this.getImage(r))return this.fire(new t.k(new Error(`An image named "${r}" does not exist.`)));this.imageManager.removeImage(r),this._afterImageUpdated(r)}_afterImageUpdated(r){this._availableImages=this.imageManager.listImages(),this._changedImages[r]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new t.l("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(r,h,x={}){if(this._checkLoaded(),this.sourceCaches[r]!==void 0)throw new Error(`Source "${r}" already exists.`);if(!h.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(h).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(h.type)>=0&&this._validate(t.z.source,`sources.${r}`,h,null,x))return;this.map&&this.map._collectResourceTiming&&(h.collectResourceTiming=!0);let w=this.sourceCaches[r]=new wi(r,h,this.dispatcher);w.style=this,w.setEventedParent(this,()=>({isSourceLoaded:w.loaded(),source:w.serialize(),sourceId:r})),w.onAdd(this.map),this._changed=!0}removeSource(r){if(this._checkLoaded(),this.sourceCaches[r]===void 0)throw new Error("There is no source with this ID");for(let x in this._layers)if(this._layers[x].source===r)return this.fire(new t.k(new Error(`Source "${r}" cannot be removed while layer "${x}" is using it.`)));let h=this.sourceCaches[r];delete this.sourceCaches[r],delete this._updatedSources[r],h.fire(new t.l("data",{sourceDataType:"metadata",dataType:"source",sourceId:r})),h.setEventedParent(null),h.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(r,h){if(this._checkLoaded(),this.sourceCaches[r]===void 0)throw new Error(`There is no source with this ID=${r}`);let x=this.sourceCaches[r].getSource();if(x.type!=="geojson")throw new Error(`geojsonSource.type is ${x.type}, which is !== 'geojson`);x.setData(h),this._changed=!0}getSource(r){return this.sourceCaches[r]&&this.sourceCaches[r].getSource()}addLayer(r,h,x={}){this._checkLoaded();let w=r.id;if(this.getLayer(w))return void this.fire(new t.k(new Error(`Layer "${w}" already exists on this map.`)));let A;if(r.type==="custom"){if(dr(this,t.bL(r)))return;A=t.bI(r)}else{if("source"in r&&typeof r.source=="object"&&(this.addSource(w,r.source),r=t.bJ(r),r=t.e(r,{source:w})),this._validate(t.z.layer,`layers.${w}`,r,{arrayIndex:-1},x))return;A=t.bI(r),this._validateLayer(A),A.setEventedParent(this,{layer:{id:w}})}let k=h?this._order.indexOf(h):this._order.length;if(h&&k===-1)this.fire(new t.k(new Error(`Cannot add layer "${w}" before non-existing layer "${h}".`)));else{if(this._order.splice(k,0,w),this._layerOrderChanged=!0,this._layers[w]=A,this._removedLayers[w]&&A.source&&A.type!=="custom"){let j=this._removedLayers[w];delete this._removedLayers[w],j.type!==A.type?this._updatedSources[A.source]="clear":(this._updatedSources[A.source]="reload",this.sourceCaches[A.source].pause())}this._updateLayer(A),A.onAdd&&A.onAdd(this.map)}}moveLayer(r,h){if(this._checkLoaded(),this._changed=!0,!this._layers[r])return void this.fire(new t.k(new Error(`The layer '${r}' does not exist in the map's style and cannot be moved.`)));if(r===h)return;let x=this._order.indexOf(r);this._order.splice(x,1);let w=h?this._order.indexOf(h):this._order.length;h&&w===-1?this.fire(new t.k(new Error(`Cannot move layer "${r}" before non-existing layer "${h}".`))):(this._order.splice(w,0,r),this._layerOrderChanged=!0)}removeLayer(r){this._checkLoaded();let h=this._layers[r];if(!h)return void this.fire(new t.k(new Error(`Cannot remove non-existing layer "${r}".`)));h.setEventedParent(null);let x=this._order.indexOf(r);this._order.splice(x,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[r]=h,delete this._layers[r],this._serializedLayers&&delete this._serializedLayers[r],delete this._updatedLayers[r],delete this._updatedPaintProps[r],h.onRemove&&h.onRemove(this.map)}getLayer(r){return this._layers[r]}getLayersOrder(){return[...this._order]}hasLayer(r){return r in this._layers}setLayerZoomRange(r,h,x){this._checkLoaded();let w=this.getLayer(r);w?w.minzoom===h&&w.maxzoom===x||(h!=null&&(w.minzoom=h),x!=null&&(w.maxzoom=x),this._updateLayer(w)):this.fire(new t.k(new Error(`Cannot set the zoom range of non-existing layer "${r}".`)))}setFilter(r,h,x={}){this._checkLoaded();let w=this.getLayer(r);if(w){if(!t.bG(w.filter,h))return h==null?(w.setFilter(void 0),void this._updateLayer(w)):void(this._validate(t.z.filter,`layers.${w.id}.filter`,h,null,x)||(w.setFilter(t.bJ(h)),this._updateLayer(w)))}else this.fire(new t.k(new Error(`Cannot filter non-existing layer "${r}".`)))}getFilter(r){return t.bJ(this.getLayer(r).filter)}setLayoutProperty(r,h,x,w={}){this._checkLoaded();let A=this.getLayer(r);A?t.bG(A.getLayoutProperty(h),x)||(A.setLayoutProperty(h,x,w),this._updateLayer(A)):this.fire(new t.k(new Error(`Cannot style non-existing layer "${r}".`)))}getLayoutProperty(r,h){let x=this.getLayer(r);if(x)return x.getLayoutProperty(h);this.fire(new t.k(new Error(`Cannot get style of non-existing layer "${r}".`)))}setPaintProperty(r,h,x,w={}){this._checkLoaded();let A=this.getLayer(r);A?t.bG(A.getPaintProperty(h),x)||(A.setPaintProperty(h,x,w)&&this._updateLayer(A),this._changed=!0,this._updatedPaintProps[r]=!0,this._serializedLayers=null):this.fire(new t.k(new Error(`Cannot style non-existing layer "${r}".`)))}getPaintProperty(r,h){return this.getLayer(r).getPaintProperty(h)}setFeatureState(r,h){this._checkLoaded();let x=r.source,w=r.sourceLayer,A=this.sourceCaches[x];if(A===void 0)return void this.fire(new t.k(new Error(`The source '${x}' does not exist in the map's style.`)));let k=A.getSource().type;k==="geojson"&&w?this.fire(new t.k(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):k!=="vector"||w?(r.id===void 0&&this.fire(new t.k(new Error("The feature id parameter must be provided."))),A.setFeatureState(w,r.id,h)):this.fire(new t.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(r,h){this._checkLoaded();let x=r.source,w=this.sourceCaches[x];if(w===void 0)return void this.fire(new t.k(new Error(`The source '${x}' does not exist in the map's style.`)));let A=w.getSource().type,k=A==="vector"?r.sourceLayer:void 0;A!=="vector"||k?h&&typeof r.id!="string"&&typeof r.id!="number"?this.fire(new t.k(new Error("A feature id is required to remove its specific state property."))):w.removeFeatureState(k,r.id,h):this.fire(new t.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(r){this._checkLoaded();let h=r.source,x=r.sourceLayer,w=this.sourceCaches[h];if(w!==void 0)return w.getSource().type!=="vector"||x?(r.id===void 0&&this.fire(new t.k(new Error("The feature id parameter must be provided."))),w.getFeatureState(x,r.id)):void this.fire(new t.k(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new t.k(new Error(`The source '${h}' does not exist in the map's style.`)))}getTransition(){return t.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;let r=t.bM(this.sourceCaches,A=>A.serialize()),h=this._serializeByIds(this._order,!0),x=this.map.getTerrain()||void 0,w=this.stylesheet;return t.bN({version:w.version,name:w.name,metadata:w.metadata,light:w.light,sky:w.sky,center:w.center,zoom:w.zoom,bearing:w.bearing,pitch:w.pitch,sprite:w.sprite,glyphs:w.glyphs,transition:w.transition,projection:w.projection,sources:r,layers:h,terrain:x},A=>A!==void 0)}_updateLayer(r){this._updatedLayers[r.id]=!0,r.source&&!this._updatedSources[r.source]&&this.sourceCaches[r.source].getSource().type!=="raster"&&(this._updatedSources[r.source]="reload",this.sourceCaches[r.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(r){let h=k=>this._layers[k].type==="fill-extrusion",x={},w=[];for(let k=this._order.length-1;k>=0;k--){let j=this._order[k];if(h(j)){x[j]=k;for(let q of r){let J=q[j];if(J)for(let ne of J)w.push(ne)}}}w.sort((k,j)=>j.intersectionZ-k.intersectionZ);let A=[];for(let k=this._order.length-1;k>=0;k--){let j=this._order[k];if(h(j))for(let q=w.length-1;q>=0;q--){let J=w[q].feature;if(x[J.layer.id]<k)break;A.push(J),w.pop()}else for(let q of r){let J=q[j];if(J)for(let ne of J)A.push(ne.feature)}}return A}queryRenderedFeatures(r,h,x){h&&h.filter&&this._validate(t.z.filter,"queryRenderedFeatures.filter",h.filter,null,h);let w={};if(h&&h.layers){if(!(Array.isArray(h.layers)||h.layers instanceof Set))return this.fire(new t.k(new Error("parameters.layers must be an Array or a Set of strings"))),[];for(let J of h.layers){let ne=this._layers[J];if(!ne)return this.fire(new t.k(new Error(`The layer '${J}' does not exist in the map's style and cannot be queried for features.`))),[];w[ne.source]=!0}}let A=[];h.availableImages=this._availableImages;let k=this._serializedAllLayers(),j=h.layers instanceof Set?h.layers:Array.isArray(h.layers)?new Set(h.layers):null,q=Object.assign(Object.assign({},h),{layers:j});for(let J in this.sourceCaches)h.layers&&!w[J]||A.push(gr(this.sourceCaches[J],this._layers,k,r,q,x,this.map.terrain?(ne,pe,ue)=>this.map.terrain.getElevation(ne,pe,ue):void 0));return this.placement&&A.push(function(J,ne,pe,ue,ge,Ee,tt){let Xe={},et=Ee.queryRenderedSymbols(ue),Se=[];for(let Be of Object.keys(et).map(Number))Se.push(tt[Be]);Se.sort(yc);for(let Be of Se){let ft=Be.featureIndex.lookupSymbolFeatures(et[Be.bucketInstanceId],ne,Be.bucketIndex,Be.sourceLayerIndex,ge.filter,ge.layers,ge.availableImages,J);for(let dt in ft){let xe=Xe[dt]=Xe[dt]||[],pt=ft[dt];pt.sort((zt,ei)=>{let Kt=Be.featureSortOrder;if(Kt){let Jt=Kt.indexOf(zt.featureIndex);return Kt.indexOf(ei.featureIndex)-Jt}return ei.featureIndex-zt.featureIndex});for(let zt of pt)xe.push(zt)}}return function(Be,ft,dt){for(let xe in Be)for(let pt of Be[xe])Os(pt,dt[ft[xe].source]);return Be}(Xe,J,pe)}(this._layers,k,this.sourceCaches,r,q,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(A)}querySourceFeatures(r,h){h&&h.filter&&this._validate(t.z.filter,"querySourceFeatures.filter",h.filter,null,h);let x=this.sourceCaches[r];return x?function(w,A){let k=w.getRenderableIds().map(J=>w.getTileByID(J)),j=[],q={};for(let J=0;J<k.length;J++){let ne=k[J],pe=ne.tileID.canonical.key;q[pe]||(q[pe]=!0,ne.querySourceFeatures(j,A))}return j}(x,h):[]}getLight(){return this.light.getLight()}setLight(r,h={}){this._checkLoaded();let x=this.light.getLight(),w=!1;for(let k in r)if(!t.bG(r[k],x[k])){w=!0;break}if(!w)return;let A={now:an.now(),transition:t.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(r,h),this.light.updateTransitions(A)}getProjection(){var r;return(r=this.stylesheet)===null||r===void 0?void 0:r.projection}setProjection(r){if(this._checkLoaded(),this.projection){if(this.projection.name===r.type)return;this.projection.destroy(),delete this.projection}this.stylesheet.projection=r,this._setProjectionInternal(r.type)}getSky(){var r;return(r=this.stylesheet)===null||r===void 0?void 0:r.sky}setSky(r,h={}){this._checkLoaded();let x=this.getSky(),w=!1;if(!r&&!x)return;if(r&&!x)w=!0;else if(!r&&x)w=!0;else for(let k in r)if(!t.bG(r[k],x[k])){w=!0;break}if(!w)return;let A={now:an.now(),transition:t.e({duration:300,delay:0},this.stylesheet.transition)};this.stylesheet.sky=r,this.sky.setSky(r,h),this.sky.updateTransitions(A)}_setProjectionInternal(r){let h=function(x){if(Array.isArray(x)){let w=new Ah({type:x});return{projection:w,transform:new Xn,cameraHelper:new bc(w)}}switch(x){case"mercator":return{projection:new su,transform:new wn,cameraHelper:new Ed};case"globe":{let w=new Ah({type:["interpolate",["linear"],["zoom"],11,"vertical-perspective",12,"mercator"]});return{projection:w,transform:new Xn,cameraHelper:new bc(w)}}case"vertical-perspective":return{projection:new Pp,transform:new br,cameraHelper:new Do};default:return t.w(`Unknown projection name: ${x}. Falling back to mercator projection.`),{projection:new su,transform:new wn,cameraHelper:new Ed}}}(r);this.projection=h.projection,this.map.migrateProjection(h.transform,h.cameraHelper);for(let x in this.sourceCaches)this.sourceCaches[x].reload()}_validate(r,h,x,w,A={}){return(!A||A.validate!==!1)&&dr(this,r.call(t.z,t.e({key:h,style:this.serialize(),value:x,styleSpec:t.v},w)))}_remove(r=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),Hs().off(fs,this._rtlPluginLoaded);for(let h in this._layers)this._layers[h].setEventedParent(null);for(let h in this.sourceCaches){let x=this.sourceCaches[h];x.setEventedParent(null),x.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),r&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(r)}_clearSource(r){this.sourceCaches[r].clearTiles()}_reloadSource(r){this.sourceCaches[r].resume(),this.sourceCaches[r].reload()}_updateSources(r){for(let h in this.sourceCaches)this.sourceCaches[h].update(r,this.map.terrain)}_generateCollisionBoxes(){for(let r in this.sourceCaches)this._reloadSource(r)}_updatePlacement(r,h,x,w,A=!1){let k=!1,j=!1,q={};for(let J of this._order){let ne=this._layers[J];if(ne.type!=="symbol")continue;if(!q[ne.source]){let ue=this.sourceCaches[ne.source];q[ne.source]=ue.getRenderableIds(!0).map(ge=>ue.getTileByID(ge)).sort((ge,Ee)=>Ee.tileID.overscaledZ-ge.tileID.overscaledZ||(ge.tileID.isLessThan(Ee.tileID)?-1:1))}let pe=this.crossTileSymbolIndex.addLayer(ne,q[ne.source],r.center.lng);k=k||pe}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((A=A||this._layerOrderChanged||x===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(an.now(),r.zoom))&&(this.pauseablePlacement=new Ml(r,this.map.terrain,this._order,A,h,x,w,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,q),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(an.now()),j=!0),k&&this.pauseablePlacement.placement.setStale()),j||k)for(let J of this._order){let ne=this._layers[J];ne.type==="symbol"&&this.placement.updateLayerOpacities(ne,q[ne.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(an.now())}_releaseSymbolFadeTiles(){for(let r in this.sourceCaches)this.sourceCaches[r].releaseSymbolFadeTiles()}getImages(r,h){return t._(this,void 0,void 0,function*(){let x=yield this.imageManager.getImages(h.icons);this._updateTilesForChangedImages();let w=this.sourceCaches[h.source];return w&&w.setDependencies(h.tileID.key,h.type,h.icons),x})}getGlyphs(r,h){return t._(this,void 0,void 0,function*(){let x=yield this.glyphManager.getGlyphs(h.stacks),w=this.sourceCaches[h.source];return w&&w.setDependencies(h.tileID.key,h.type,[""]),x})}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(r,h={}){this._checkLoaded(),r&&this._validate(t.z.glyphs,"glyphs",r,null,h)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=r,this.glyphManager.entries={},this.glyphManager.setURL(r))}addSprite(r,h,x={},w){this._checkLoaded();let A=[{id:r,url:h}],k=[...Br(this.stylesheet.sprite),...A];this._validate(t.z.sprite,"sprite",k,null,x)||(this.stylesheet.sprite=k,this._loadSprite(A,!0,w))}removeSprite(r){this._checkLoaded();let h=Br(this.stylesheet.sprite);if(h.find(x=>x.id===r)){if(this._spritesImagesIds[r])for(let x of this._spritesImagesIds[r])this.imageManager.removeImage(x),this._changedImages[x]=!0;h.splice(h.findIndex(x=>x.id===r),1),this.stylesheet.sprite=h.length>0?h:void 0,delete this._spritesImagesIds[r],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new t.l("data",{dataType:"style"}))}else this.fire(new t.k(new Error(`Sprite "${r}" doesn't exists on this map.`)))}getSprite(){return Br(this.stylesheet.sprite)}setSprite(r,h={},x){this._checkLoaded(),r&&this._validate(t.z.sprite,"sprite",r,null,h)||(this.stylesheet.sprite=r,r?this._loadSprite(r,!0,x):(this._unloadSprite(),x&&x(null)))}}var Md=t.aI([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class ka{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(r,h,x,w,A,k,j,q,J){this.context=r;let ne=this.boundPaintVertexBuffers.length!==w.length;for(let pe=0;!ne&&pe<w.length;pe++)this.boundPaintVertexBuffers[pe]!==w[pe]&&(ne=!0);!this.vao||this.boundProgram!==h||this.boundLayoutVertexBuffer!==x||ne||this.boundIndexBuffer!==A||this.boundVertexOffset!==k||this.boundDynamicVertexBuffer!==j||this.boundDynamicVertexBuffer2!==q||this.boundDynamicVertexBuffer3!==J?this.freshBind(h,x,w,A,k,j,q,J):(r.bindVertexArray.set(this.vao),j&&j.bind(),A&&A.dynamicDraw&&A.bind(),q&&q.bind(),J&&J.bind())}freshBind(r,h,x,w,A,k,j,q){let J=r.numAttributes,ne=this.context,pe=ne.gl;this.vao&&this.destroy(),this.vao=ne.createVertexArray(),ne.bindVertexArray.set(this.vao),this.boundProgram=r,this.boundLayoutVertexBuffer=h,this.boundPaintVertexBuffers=x,this.boundIndexBuffer=w,this.boundVertexOffset=A,this.boundDynamicVertexBuffer=k,this.boundDynamicVertexBuffer2=j,this.boundDynamicVertexBuffer3=q,h.enableAttributes(pe,r);for(let ue of x)ue.enableAttributes(pe,r);k&&k.enableAttributes(pe,r),j&&j.enableAttributes(pe,r),q&&q.enableAttributes(pe,r),h.bind(),h.setVertexAttribPointers(pe,r,A);for(let ue of x)ue.bind(),ue.setVertexAttribPointers(pe,r,A);k&&(k.bind(),k.setVertexAttribPointers(pe,r,A)),w&&w.bind(),j&&(j.bind(),j.setVertexAttribPointers(pe,r,A)),q&&(q.bind(),q.setVertexAttribPointers(pe,r,A)),ne.currentNumAttributes=J}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}let us=(M,r,h,x,w)=>({u_texture:0,u_ele_delta:M,u_fog_matrix:r,u_fog_color:h?h.properties.get("fog-color"):t.be.white,u_fog_ground_blend:h?h.properties.get("fog-ground-blend"):1,u_fog_ground_blend_opacity:w?0:h?h.calculateFogBlendOpacity(x):0,u_horizon_color:h?h.properties.get("horizon-color"):t.be.white,u_horizon_fog_blend:h?h.properties.get("horizon-fog-blend"):1,u_is_globe_mode:w?1:0}),Cm={mainMatrix:"u_projection_matrix",tileMercatorCoords:"u_projection_tile_mercator_coords",clippingPlane:"u_projection_clipping_plane",projectionTransition:"u_projection_transition",fallbackMatrix:"u_projection_fallback_matrix"};function Rh(M){let r=[];for(let h=0;h<M.length;h++){if(M[h]===null)continue;let x=M[h].split(" ");r.push(x.pop())}return r}class ku{constructor(r,h,x,w,A,k,j,q,J=[]){let ne=r.gl;this.program=ne.createProgram();let pe=Rh(h.staticAttributes),ue=x?x.getBinderAttributes():[],ge=pe.concat(ue),Ee=Ms.prelude.staticUniforms?Rh(Ms.prelude.staticUniforms):[],tt=j.staticUniforms?Rh(j.staticUniforms):[],Xe=h.staticUniforms?Rh(h.staticUniforms):[],et=x?x.getBinderUniforms():[],Se=Ee.concat(tt).concat(Xe).concat(et),Be=[];for(let Kt of Se)Be.indexOf(Kt)<0&&Be.push(Kt);let ft=x?x.defines():[];Bs(ne)&&ft.unshift("#version 300 es"),A&&ft.push("#define OVERDRAW_INSPECTOR;"),k&&ft.push("#define TERRAIN3D;"),q&&ft.push(q),J&&ft.push(...J);let dt=ft.concat(Ms.prelude.fragmentSource,j.fragmentSource,h.fragmentSource).join(`
`),xe=ft.concat(Ms.prelude.vertexSource,j.vertexSource,h.vertexSource).join(`
`);Bs(ne)||(dt=function(Kt){return Kt.replace(/\bin\s/g,"varying ").replace("out highp vec4 fragColor;","").replace(/fragColor/g,"gl_FragColor").replace(/texture\(/g,"texture2D(")}(dt),xe=function(Kt){return Kt.replace(/\bin\s/g,"attribute ").replace(/\bout\s/g,"varying ").replace(/texture\(/g,"texture2D(")}(xe));let pt=ne.createShader(ne.FRAGMENT_SHADER);if(ne.isContextLost())return void(this.failedToCreate=!0);if(ne.shaderSource(pt,dt),ne.compileShader(pt),!ne.getShaderParameter(pt,ne.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${ne.getShaderInfoLog(pt)}`);ne.attachShader(this.program,pt);let zt=ne.createShader(ne.VERTEX_SHADER);if(ne.isContextLost())return void(this.failedToCreate=!0);if(ne.shaderSource(zt,xe),ne.compileShader(zt),!ne.getShaderParameter(zt,ne.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${ne.getShaderInfoLog(zt)}`);ne.attachShader(this.program,zt),this.attributes={};let ei={};this.numAttributes=ge.length;for(let Kt=0;Kt<this.numAttributes;Kt++)ge[Kt]&&(ne.bindAttribLocation(this.program,Kt,ge[Kt]),this.attributes[ge[Kt]]=Kt);if(ne.linkProgram(this.program),!ne.getProgramParameter(this.program,ne.LINK_STATUS))throw new Error(`Program failed to link: ${ne.getProgramInfoLog(this.program)}`);ne.deleteShader(zt),ne.deleteShader(pt);for(let Kt=0;Kt<Be.length;Kt++){let Jt=Be[Kt];if(Jt&&!ei[Jt]){let si=ne.getUniformLocation(this.program,Jt);si&&(ei[Jt]=si)}}this.fixedUniforms=w(r,ei),this.terrainUniforms=((Kt,Jt)=>({u_depth:new t.bO(Kt,Jt.u_depth),u_terrain:new t.bO(Kt,Jt.u_terrain),u_terrain_dim:new t.bf(Kt,Jt.u_terrain_dim),u_terrain_matrix:new t.bQ(Kt,Jt.u_terrain_matrix),u_terrain_unpack:new t.bR(Kt,Jt.u_terrain_unpack),u_terrain_exaggeration:new t.bf(Kt,Jt.u_terrain_exaggeration)}))(r,ei),this.projectionUniforms=((Kt,Jt)=>({u_projection_matrix:new t.bQ(Kt,Jt.u_projection_matrix),u_projection_tile_mercator_coords:new t.bR(Kt,Jt.u_projection_tile_mercator_coords),u_projection_clipping_plane:new t.bR(Kt,Jt.u_projection_clipping_plane),u_projection_transition:new t.bf(Kt,Jt.u_projection_transition),u_projection_fallback_matrix:new t.bQ(Kt,Jt.u_projection_fallback_matrix)}))(r,ei),this.binderUniforms=x?x.getUniforms(r,ei):[]}draw(r,h,x,w,A,k,j,q,J,ne,pe,ue,ge,Ee,tt,Xe,et,Se,Be){let ft=r.gl;if(this.failedToCreate)return;if(r.program.set(this.program),r.setDepthMode(x),r.setStencilMode(w),r.setColorMode(A),r.setCullFace(k),q){r.activeTexture.set(ft.TEXTURE2),ft.bindTexture(ft.TEXTURE_2D,q.depthTexture),r.activeTexture.set(ft.TEXTURE3),ft.bindTexture(ft.TEXTURE_2D,q.texture);for(let xe in this.terrainUniforms)this.terrainUniforms[xe].set(q[xe])}if(J)for(let xe in J)this.projectionUniforms[Cm[xe]].set(J[xe]);if(j)for(let xe in this.fixedUniforms)this.fixedUniforms[xe].set(j[xe]);Xe&&Xe.setUniforms(r,this.binderUniforms,Ee,{zoom:tt});let dt=0;switch(h){case ft.LINES:dt=2;break;case ft.TRIANGLES:dt=3;break;case ft.LINE_STRIP:dt=1}for(let xe of ge.get()){let pt=xe.vaos||(xe.vaos={});(pt[ne]||(pt[ne]=new ka)).bind(r,this,pe,Xe?Xe.getPaintVertexBuffers():[],ue,xe.vertexOffset,et,Se,Be),ft.drawElements(h,xe.primitiveLength*dt,ft.UNSIGNED_SHORT,xe.primitiveOffset*dt*2)}}}function th(M,r,h){let x=1/t.aB(h,1,r.transform.tileZoom),w=Math.pow(2,h.tileID.overscaledZ),A=h.tileSize*Math.pow(2,r.transform.tileZoom)/w,k=A*(h.tileID.canonical.x+h.tileID.wrap*w),j=A*h.tileID.canonical.y;return{u_image:0,u_texsize:h.imageAtlasTexture.size,u_scale:[x,M.fromScale,M.toScale],u_fade:M.t,u_pixel_coord_upper:[k>>16,j>>16],u_pixel_coord_lower:[65535&k,65535&j]}}let zl=(M,r,h,x)=>{let w=M.style.light,A=w.properties.get("position"),k=[A.x,A.y,A.z],j=t.bU();w.properties.get("anchor")==="viewport"&&t.bV(j,M.transform.bearingInRadians),t.bW(k,k,j);let q=M.transform.transformLightDirection(k),J=w.properties.get("color");return{u_lightpos:k,u_lightpos_globe:q,u_lightintensity:w.properties.get("intensity"),u_lightcolor:[J.r,J.g,J.b],u_vertical_gradient:+r,u_opacity:h,u_fill_translate:x}},Ou=(M,r,h,x,w,A,k)=>t.e(zl(M,r,h,x),th(A,M,k),{u_height_factor:-Math.pow(2,w.overscaledZ)/k.tileSize/8}),Ks=(M,r,h,x)=>t.e(th(r,M,h),{u_fill_translate:x}),Vs=(M,r)=>({u_world:M,u_fill_translate:r}),Xa=(M,r,h,x,w)=>t.e(Ks(M,r,h,w),{u_world:x}),Rp=(M,r,h,x,w)=>{let A=M.transform,k,j,q=0;if(h.paint.get("circle-pitch-alignment")==="map"){let J=t.aB(r,1,A.zoom);k=!0,j=[J,J],q=J/(t.$*Math.pow(2,r.tileID.overscaledZ))*2*Math.PI*w}else k=!1,j=A.pixelsToGLUnits;return{u_camera_to_center_distance:A.cameraToCenterDistance,u_scale_with_map:+(h.paint.get("circle-pitch-scale")==="map"),u_pitch_with_map:+k,u_device_pixel_ratio:M.pixelRatio,u_extrude_scale:j,u_globe_extrude_scale:q,u_translate:x}},wc=M=>({u_pixel_extrude_scale:[1/M.width,1/M.height]}),$o=M=>({u_viewport_size:[M.width,M.height]}),Ia=(M,r=1)=>({u_color:M,u_overlay:0,u_overlay_scale:r}),Tn=(M,r,h,x)=>{let w=t.aB(M,1,r)/(t.$*Math.pow(2,M.tileID.overscaledZ))*2*Math.PI*x;return{u_extrude_scale:t.aB(M,1,r),u_intensity:h,u_globe_extrude_scale:w}},Li=(M,r,h,x)=>{let w=t.L();t.bX(w,0,M.width,M.height,0,0,1);let A=M.context.gl;return{u_matrix:w,u_world:[A.drawingBufferWidth,A.drawingBufferHeight],u_image:h,u_color_ramp:x,u_opacity:r.paint.get("heatmap-opacity")}},Tc=(M,r,h)=>{let x=h.paint.get("hillshade-accent-color"),w;switch(h.paint.get("hillshade-method")){case"basic":w=4;break;case"combined":w=1;break;case"igor":w=2;break;case"multidirectional":w=3;break;default:w=0}let A=h.getIlluminationProperties();for(let k=0;k<A.directionRadians.length;k++)h.paint.get("hillshade-illumination-anchor")==="viewport"&&(A.directionRadians[k]+=M.transform.bearingInRadians);return{u_image:0,u_latrange:zh(0,r.tileID),u_exaggeration:h.paint.get("hillshade-exaggeration"),u_altitudes:A.altitudeRadians,u_azimuths:A.directionRadians,u_accent:x,u_method:w,u_highlights:A.highlightColor,u_shadows:A.shadowColor}},hn=(M,r)=>{let h=r.stride,x=t.L();return t.bX(x,0,t.$,-8192,0,0,1),t.M(x,x,[0,-8192,0]),{u_matrix:x,u_image:1,u_dimension:[h,h],u_zoom:M.overscaledZ,u_unpack:r.getUnpackVector()}};function zh(M,r){let h=Math.pow(2,r.canonical.z),x=r.canonical.y;return[new t.a0(0,x/h).toLngLat().lat,new t.a0(0,(x+1)/h).toLngLat().lat]}let Fu=(M,r)=>({u_image:0,u_unpack:r.getUnpackVector(),u_dimension:[r.stride,r.stride],u_elevation_stops:1,u_color_stops:4,u_opacity:M.paint.get("color-relief-opacity")}),ln=(M,r,h,x)=>{let w=M.transform;return{u_translation:Ys(M,r,h),u_ratio:x/t.aB(r,1,w.zoom),u_device_pixel_ratio:M.pixelRatio,u_units_to_pixels:[1/w.pixelsToGLUnits[0],1/w.pixelsToGLUnits[1]]}},zp=(M,r,h,x,w)=>t.e(ln(M,r,h,x),{u_image:0,u_image_height:w}),Ll=(M,r,h,x,w)=>{let A=M.transform,k=Bu(r,A);return{u_translation:Ys(M,r,h),u_texsize:r.imageAtlasTexture.size,u_ratio:x/t.aB(r,1,A.zoom),u_device_pixel_ratio:M.pixelRatio,u_image:0,u_scale:[k,w.fromScale,w.toScale],u_fade:w.t,u_units_to_pixels:[1/A.pixelsToGLUnits[0],1/A.pixelsToGLUnits[1]]}},lf=(M,r,h,x,w,A)=>{let k=M.lineAtlas,j=Bu(r,M.transform),q=h.layout.get("line-cap")==="round",J=k.getDash(w.from,q),ne=k.getDash(w.to,q),pe=J.width*A.fromScale,ue=ne.width*A.toScale;return t.e(ln(M,r,h,x),{u_patternscale_a:[j/pe,-J.height/2],u_patternscale_b:[j/ue,-ne.height/2],u_sdfgamma:k.width/(256*Math.min(pe,ue)*M.pixelRatio)/2,u_image:0,u_tex_y_a:J.y,u_tex_y_b:ne.y,u_mix:A.t})};function Bu(M,r){return 1/t.aB(M,1,r.tileZoom)}function Ys(M,r,h){return t.aC(M.transform,r,h.paint.get("line-translate"),h.paint.get("line-translate-anchor"))}let ws=(M,r,h,x,w)=>{return{u_tl_parent:M,u_scale_parent:r,u_buffer_scale:1,u_fade_t:h.mix,u_opacity:h.opacity*x.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:x.paint.get("raster-brightness-min"),u_brightness_high:x.paint.get("raster-brightness-max"),u_saturation_factor:(k=x.paint.get("raster-saturation"),k>0?1-1/(1.001-k):-k),u_contrast_factor:(A=x.paint.get("raster-contrast"),A>0?1/(1-A):1+A),u_spin_weights:cu(x.paint.get("raster-hue-rotate")),u_coords_top:[w[0].x,w[0].y,w[1].x,w[1].y],u_coords_bottom:[w[3].x,w[3].y,w[2].x,w[2].y]};var A,k};function cu(M){M*=Math.PI/180;let r=Math.sin(M),h=Math.cos(M);return[(2*h+1)/3,(-Math.sqrt(3)*r-h+1)/3,(Math.sqrt(3)*r-h+1)/3]}let Sc=(M,r,h,x,w,A,k,j,q,J,ne,pe,ue)=>{let ge=k.transform;return{u_is_size_zoom_constant:+(M==="constant"||M==="source"),u_is_size_feature_constant:+(M==="constant"||M==="camera"),u_size_t:r?r.uSizeT:0,u_size:r?r.uSize:0,u_camera_to_center_distance:ge.cameraToCenterDistance,u_pitch:ge.pitch/360*2*Math.PI,u_rotate_symbol:+h,u_aspect_ratio:ge.width/ge.height,u_fade_change:k.options.fadeDuration?k.symbolFadeChange:1,u_label_plane_matrix:j,u_coord_matrix:q,u_is_text:+ne,u_pitch_with_map:+x,u_is_along_line:w,u_is_variable_anchor:A,u_texsize:pe,u_texture:0,u_translation:J,u_pitched_scale:ue}},kl=(M,r,h,x,w,A,k,j,q,J,ne,pe,ue,ge)=>{let Ee=k.transform;return t.e(Sc(M,r,h,x,w,A,k,j,q,J,ne,pe,ge),{u_gamma_scale:x?Math.cos(Ee.pitch*Math.PI/180)*Ee.cameraToCenterDistance:1,u_device_pixel_ratio:k.pixelRatio,u_is_halo:1})},hu=(M,r,h,x,w,A,k,j,q,J,ne,pe,ue)=>t.e(kl(M,r,h,x,w,A,k,j,q,J,!0,ne,0,ue),{u_texsize_icon:pe,u_texture_icon:1}),Js=(M,r)=>({u_opacity:M,u_color:r}),Pd=(M,r,h,x,w)=>t.e(function(A,k,j,q){let J=j.imageManager.getPattern(A.from.toString()),ne=j.imageManager.getPattern(A.to.toString()),{width:pe,height:ue}=j.imageManager.getPixelSize(),ge=Math.pow(2,q.tileID.overscaledZ),Ee=q.tileSize*Math.pow(2,j.transform.tileZoom)/ge,tt=Ee*(q.tileID.canonical.x+q.tileID.wrap*ge),Xe=Ee*q.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:J.tl,u_pattern_br_a:J.br,u_pattern_tl_b:ne.tl,u_pattern_br_b:ne.br,u_texsize:[pe,ue],u_mix:k.t,u_pattern_size_a:J.displaySize,u_pattern_size_b:ne.displaySize,u_scale_a:k.fromScale,u_scale_b:k.toScale,u_tile_units_to_pixels:1/t.aB(q,1,j.transform.tileZoom),u_pixel_coord_upper:[tt>>16,Xe>>16],u_pixel_coord_lower:[65535&tt,65535&Xe]}}(h,w,r,x),{u_opacity:M}),Nu=(M,r)=>{},Of={fillExtrusion:(M,r)=>({u_lightpos:new t.bS(M,r.u_lightpos),u_lightpos_globe:new t.bS(M,r.u_lightpos_globe),u_lightintensity:new t.bf(M,r.u_lightintensity),u_lightcolor:new t.bS(M,r.u_lightcolor),u_vertical_gradient:new t.bf(M,r.u_vertical_gradient),u_opacity:new t.bf(M,r.u_opacity),u_fill_translate:new t.bT(M,r.u_fill_translate)}),fillExtrusionPattern:(M,r)=>({u_lightpos:new t.bS(M,r.u_lightpos),u_lightpos_globe:new t.bS(M,r.u_lightpos_globe),u_lightintensity:new t.bf(M,r.u_lightintensity),u_lightcolor:new t.bS(M,r.u_lightcolor),u_vertical_gradient:new t.bf(M,r.u_vertical_gradient),u_height_factor:new t.bf(M,r.u_height_factor),u_opacity:new t.bf(M,r.u_opacity),u_fill_translate:new t.bT(M,r.u_fill_translate),u_image:new t.bO(M,r.u_image),u_texsize:new t.bT(M,r.u_texsize),u_pixel_coord_upper:new t.bT(M,r.u_pixel_coord_upper),u_pixel_coord_lower:new t.bT(M,r.u_pixel_coord_lower),u_scale:new t.bS(M,r.u_scale),u_fade:new t.bf(M,r.u_fade)}),fill:(M,r)=>({u_fill_translate:new t.bT(M,r.u_fill_translate)}),fillPattern:(M,r)=>({u_image:new t.bO(M,r.u_image),u_texsize:new t.bT(M,r.u_texsize),u_pixel_coord_upper:new t.bT(M,r.u_pixel_coord_upper),u_pixel_coord_lower:new t.bT(M,r.u_pixel_coord_lower),u_scale:new t.bS(M,r.u_scale),u_fade:new t.bf(M,r.u_fade),u_fill_translate:new t.bT(M,r.u_fill_translate)}),fillOutline:(M,r)=>({u_world:new t.bT(M,r.u_world),u_fill_translate:new t.bT(M,r.u_fill_translate)}),fillOutlinePattern:(M,r)=>({u_world:new t.bT(M,r.u_world),u_image:new t.bO(M,r.u_image),u_texsize:new t.bT(M,r.u_texsize),u_pixel_coord_upper:new t.bT(M,r.u_pixel_coord_upper),u_pixel_coord_lower:new t.bT(M,r.u_pixel_coord_lower),u_scale:new t.bS(M,r.u_scale),u_fade:new t.bf(M,r.u_fade),u_fill_translate:new t.bT(M,r.u_fill_translate)}),circle:(M,r)=>({u_camera_to_center_distance:new t.bf(M,r.u_camera_to_center_distance),u_scale_with_map:new t.bO(M,r.u_scale_with_map),u_pitch_with_map:new t.bO(M,r.u_pitch_with_map),u_extrude_scale:new t.bT(M,r.u_extrude_scale),u_device_pixel_ratio:new t.bf(M,r.u_device_pixel_ratio),u_globe_extrude_scale:new t.bf(M,r.u_globe_extrude_scale),u_translate:new t.bT(M,r.u_translate)}),collisionBox:(M,r)=>({u_pixel_extrude_scale:new t.bT(M,r.u_pixel_extrude_scale)}),collisionCircle:(M,r)=>({u_viewport_size:new t.bT(M,r.u_viewport_size)}),debug:(M,r)=>({u_color:new t.bP(M,r.u_color),u_overlay:new t.bO(M,r.u_overlay),u_overlay_scale:new t.bf(M,r.u_overlay_scale)}),depth:Nu,clippingMask:Nu,heatmap:(M,r)=>({u_extrude_scale:new t.bf(M,r.u_extrude_scale),u_intensity:new t.bf(M,r.u_intensity),u_globe_extrude_scale:new t.bf(M,r.u_globe_extrude_scale)}),heatmapTexture:(M,r)=>({u_matrix:new t.bQ(M,r.u_matrix),u_world:new t.bT(M,r.u_world),u_image:new t.bO(M,r.u_image),u_color_ramp:new t.bO(M,r.u_color_ramp),u_opacity:new t.bf(M,r.u_opacity)}),hillshade:(M,r)=>({u_image:new t.bO(M,r.u_image),u_latrange:new t.bT(M,r.u_latrange),u_exaggeration:new t.bf(M,r.u_exaggeration),u_altitudes:new t.bZ(M,r.u_altitudes),u_azimuths:new t.bZ(M,r.u_azimuths),u_accent:new t.bP(M,r.u_accent),u_method:new t.bO(M,r.u_method),u_shadows:new t.bY(M,r.u_shadows),u_highlights:new t.bY(M,r.u_highlights)}),hillshadePrepare:(M,r)=>({u_matrix:new t.bQ(M,r.u_matrix),u_image:new t.bO(M,r.u_image),u_dimension:new t.bT(M,r.u_dimension),u_zoom:new t.bf(M,r.u_zoom),u_unpack:new t.bR(M,r.u_unpack)}),colorRelief:(M,r)=>({u_image:new t.bO(M,r.u_image),u_unpack:new t.bR(M,r.u_unpack),u_dimension:new t.bT(M,r.u_dimension),u_elevation_stops:new t.bO(M,r.u_elevation_stops),u_color_stops:new t.bO(M,r.u_color_stops),u_opacity:new t.bf(M,r.u_opacity)}),line:(M,r)=>({u_translation:new t.bT(M,r.u_translation),u_ratio:new t.bf(M,r.u_ratio),u_device_pixel_ratio:new t.bf(M,r.u_device_pixel_ratio),u_units_to_pixels:new t.bT(M,r.u_units_to_pixels)}),lineGradient:(M,r)=>({u_translation:new t.bT(M,r.u_translation),u_ratio:new t.bf(M,r.u_ratio),u_device_pixel_ratio:new t.bf(M,r.u_device_pixel_ratio),u_units_to_pixels:new t.bT(M,r.u_units_to_pixels),u_image:new t.bO(M,r.u_image),u_image_height:new t.bf(M,r.u_image_height)}),linePattern:(M,r)=>({u_translation:new t.bT(M,r.u_translation),u_texsize:new t.bT(M,r.u_texsize),u_ratio:new t.bf(M,r.u_ratio),u_device_pixel_ratio:new t.bf(M,r.u_device_pixel_ratio),u_image:new t.bO(M,r.u_image),u_units_to_pixels:new t.bT(M,r.u_units_to_pixels),u_scale:new t.bS(M,r.u_scale),u_fade:new t.bf(M,r.u_fade)}),lineSDF:(M,r)=>({u_translation:new t.bT(M,r.u_translation),u_ratio:new t.bf(M,r.u_ratio),u_device_pixel_ratio:new t.bf(M,r.u_device_pixel_ratio),u_units_to_pixels:new t.bT(M,r.u_units_to_pixels),u_patternscale_a:new t.bT(M,r.u_patternscale_a),u_patternscale_b:new t.bT(M,r.u_patternscale_b),u_sdfgamma:new t.bf(M,r.u_sdfgamma),u_image:new t.bO(M,r.u_image),u_tex_y_a:new t.bf(M,r.u_tex_y_a),u_tex_y_b:new t.bf(M,r.u_tex_y_b),u_mix:new t.bf(M,r.u_mix)}),raster:(M,r)=>({u_tl_parent:new t.bT(M,r.u_tl_parent),u_scale_parent:new t.bf(M,r.u_scale_parent),u_buffer_scale:new t.bf(M,r.u_buffer_scale),u_fade_t:new t.bf(M,r.u_fade_t),u_opacity:new t.bf(M,r.u_opacity),u_image0:new t.bO(M,r.u_image0),u_image1:new t.bO(M,r.u_image1),u_brightness_low:new t.bf(M,r.u_brightness_low),u_brightness_high:new t.bf(M,r.u_brightness_high),u_saturation_factor:new t.bf(M,r.u_saturation_factor),u_contrast_factor:new t.bf(M,r.u_contrast_factor),u_spin_weights:new t.bS(M,r.u_spin_weights),u_coords_top:new t.bR(M,r.u_coords_top),u_coords_bottom:new t.bR(M,r.u_coords_bottom)}),symbolIcon:(M,r)=>({u_is_size_zoom_constant:new t.bO(M,r.u_is_size_zoom_constant),u_is_size_feature_constant:new t.bO(M,r.u_is_size_feature_constant),u_size_t:new t.bf(M,r.u_size_t),u_size:new t.bf(M,r.u_size),u_camera_to_center_distance:new t.bf(M,r.u_camera_to_center_distance),u_pitch:new t.bf(M,r.u_pitch),u_rotate_symbol:new t.bO(M,r.u_rotate_symbol),u_aspect_ratio:new t.bf(M,r.u_aspect_ratio),u_fade_change:new t.bf(M,r.u_fade_change),u_label_plane_matrix:new t.bQ(M,r.u_label_plane_matrix),u_coord_matrix:new t.bQ(M,r.u_coord_matrix),u_is_text:new t.bO(M,r.u_is_text),u_pitch_with_map:new t.bO(M,r.u_pitch_with_map),u_is_along_line:new t.bO(M,r.u_is_along_line),u_is_variable_anchor:new t.bO(M,r.u_is_variable_anchor),u_texsize:new t.bT(M,r.u_texsize),u_texture:new t.bO(M,r.u_texture),u_translation:new t.bT(M,r.u_translation),u_pitched_scale:new t.bf(M,r.u_pitched_scale)}),symbolSDF:(M,r)=>({u_is_size_zoom_constant:new t.bO(M,r.u_is_size_zoom_constant),u_is_size_feature_constant:new t.bO(M,r.u_is_size_feature_constant),u_size_t:new t.bf(M,r.u_size_t),u_size:new t.bf(M,r.u_size),u_camera_to_center_distance:new t.bf(M,r.u_camera_to_center_distance),u_pitch:new t.bf(M,r.u_pitch),u_rotate_symbol:new t.bO(M,r.u_rotate_symbol),u_aspect_ratio:new t.bf(M,r.u_aspect_ratio),u_fade_change:new t.bf(M,r.u_fade_change),u_label_plane_matrix:new t.bQ(M,r.u_label_plane_matrix),u_coord_matrix:new t.bQ(M,r.u_coord_matrix),u_is_text:new t.bO(M,r.u_is_text),u_pitch_with_map:new t.bO(M,r.u_pitch_with_map),u_is_along_line:new t.bO(M,r.u_is_along_line),u_is_variable_anchor:new t.bO(M,r.u_is_variable_anchor),u_texsize:new t.bT(M,r.u_texsize),u_texture:new t.bO(M,r.u_texture),u_gamma_scale:new t.bf(M,r.u_gamma_scale),u_device_pixel_ratio:new t.bf(M,r.u_device_pixel_ratio),u_is_halo:new t.bO(M,r.u_is_halo),u_translation:new t.bT(M,r.u_translation),u_pitched_scale:new t.bf(M,r.u_pitched_scale)}),symbolTextAndIcon:(M,r)=>({u_is_size_zoom_constant:new t.bO(M,r.u_is_size_zoom_constant),u_is_size_feature_constant:new t.bO(M,r.u_is_size_feature_constant),u_size_t:new t.bf(M,r.u_size_t),u_size:new t.bf(M,r.u_size),u_camera_to_center_distance:new t.bf(M,r.u_camera_to_center_distance),u_pitch:new t.bf(M,r.u_pitch),u_rotate_symbol:new t.bO(M,r.u_rotate_symbol),u_aspect_ratio:new t.bf(M,r.u_aspect_ratio),u_fade_change:new t.bf(M,r.u_fade_change),u_label_plane_matrix:new t.bQ(M,r.u_label_plane_matrix),u_coord_matrix:new t.bQ(M,r.u_coord_matrix),u_is_text:new t.bO(M,r.u_is_text),u_pitch_with_map:new t.bO(M,r.u_pitch_with_map),u_is_along_line:new t.bO(M,r.u_is_along_line),u_is_variable_anchor:new t.bO(M,r.u_is_variable_anchor),u_texsize:new t.bT(M,r.u_texsize),u_texsize_icon:new t.bT(M,r.u_texsize_icon),u_texture:new t.bO(M,r.u_texture),u_texture_icon:new t.bO(M,r.u_texture_icon),u_gamma_scale:new t.bf(M,r.u_gamma_scale),u_device_pixel_ratio:new t.bf(M,r.u_device_pixel_ratio),u_is_halo:new t.bO(M,r.u_is_halo),u_translation:new t.bT(M,r.u_translation),u_pitched_scale:new t.bf(M,r.u_pitched_scale)}),background:(M,r)=>({u_opacity:new t.bf(M,r.u_opacity),u_color:new t.bP(M,r.u_color)}),backgroundPattern:(M,r)=>({u_opacity:new t.bf(M,r.u_opacity),u_image:new t.bO(M,r.u_image),u_pattern_tl_a:new t.bT(M,r.u_pattern_tl_a),u_pattern_br_a:new t.bT(M,r.u_pattern_br_a),u_pattern_tl_b:new t.bT(M,r.u_pattern_tl_b),u_pattern_br_b:new t.bT(M,r.u_pattern_br_b),u_texsize:new t.bT(M,r.u_texsize),u_mix:new t.bf(M,r.u_mix),u_pattern_size_a:new t.bT(M,r.u_pattern_size_a),u_pattern_size_b:new t.bT(M,r.u_pattern_size_b),u_scale_a:new t.bf(M,r.u_scale_a),u_scale_b:new t.bf(M,r.u_scale_b),u_pixel_coord_upper:new t.bT(M,r.u_pixel_coord_upper),u_pixel_coord_lower:new t.bT(M,r.u_pixel_coord_lower),u_tile_units_to_pixels:new t.bf(M,r.u_tile_units_to_pixels)}),terrain:(M,r)=>({u_texture:new t.bO(M,r.u_texture),u_ele_delta:new t.bf(M,r.u_ele_delta),u_fog_matrix:new t.bQ(M,r.u_fog_matrix),u_fog_color:new t.bP(M,r.u_fog_color),u_fog_ground_blend:new t.bf(M,r.u_fog_ground_blend),u_fog_ground_blend_opacity:new t.bf(M,r.u_fog_ground_blend_opacity),u_horizon_color:new t.bP(M,r.u_horizon_color),u_horizon_fog_blend:new t.bf(M,r.u_horizon_fog_blend),u_is_globe_mode:new t.bf(M,r.u_is_globe_mode)}),terrainDepth:(M,r)=>({u_ele_delta:new t.bf(M,r.u_ele_delta)}),terrainCoords:(M,r)=>({u_texture:new t.bO(M,r.u_texture),u_terrain_coords_id:new t.bf(M,r.u_terrain_coords_id),u_ele_delta:new t.bf(M,r.u_ele_delta)}),projectionErrorMeasurement:(M,r)=>({u_input:new t.bf(M,r.u_input),u_output_expected:new t.bf(M,r.u_output_expected)}),atmosphere:(M,r)=>({u_sun_pos:new t.bS(M,r.u_sun_pos),u_atmosphere_blend:new t.bf(M,r.u_atmosphere_blend),u_globe_position:new t.bS(M,r.u_globe_position),u_globe_radius:new t.bf(M,r.u_globe_radius),u_inv_proj_matrix:new t.bQ(M,r.u_inv_proj_matrix)}),sky:(M,r)=>({u_sky_color:new t.bP(M,r.u_sky_color),u_horizon_color:new t.bP(M,r.u_horizon_color),u_horizon:new t.bT(M,r.u_horizon),u_horizon_normal:new t.bT(M,r.u_horizon_normal),u_sky_horizon_blend:new t.bf(M,r.u_sky_horizon_blend),u_sky_blend:new t.bf(M,r.u_sky_blend)})};class Ic{constructor(r,h,x){this.context=r;let w=r.gl;this.buffer=w.createBuffer(),this.dynamicDraw=!!x,this.context.unbindVAO(),r.bindElementBuffer.set(this.buffer),w.bufferData(w.ELEMENT_ARRAY_BUFFER,h.arrayBuffer,this.dynamicDraw?w.DYNAMIC_DRAW:w.STATIC_DRAW),this.dynamicDraw||delete h.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(r){let h=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),h.bufferSubData(h.ELEMENT_ARRAY_BUFFER,0,r.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}let Lp={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Ol{constructor(r,h,x,w){this.length=h.length,this.attributes=x,this.itemSize=h.bytesPerElement,this.dynamicDraw=w,this.context=r;let A=r.gl;this.buffer=A.createBuffer(),r.bindVertexBuffer.set(this.buffer),A.bufferData(A.ARRAY_BUFFER,h.arrayBuffer,this.dynamicDraw?A.DYNAMIC_DRAW:A.STATIC_DRAW),this.dynamicDraw||delete h.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(r){if(r.length!==this.length)throw new Error(`Length of new data is ${r.length}, which doesn't match current length of ${this.length}`);let h=this.context.gl;this.bind(),h.bufferSubData(h.ARRAY_BUFFER,0,r.arrayBuffer)}enableAttributes(r,h){for(let x=0;x<this.attributes.length;x++){let w=h.attributes[this.attributes[x].name];w!==void 0&&r.enableVertexAttribArray(w)}}setVertexAttribPointers(r,h,x){for(let w=0;w<this.attributes.length;w++){let A=this.attributes[w],k=h.attributes[A.name];k!==void 0&&r.vertexAttribPointer(k,A.components,r[Lp[A.type]],!1,this.itemSize,A.offset+this.itemSize*(x||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Xr{constructor(r){this.gl=r.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(r){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class rc extends Xr{getDefault(){return t.be.transparent}set(r){let h=this.current;(r.r!==h.r||r.g!==h.g||r.b!==h.b||r.a!==h.a||this.dirty)&&(this.gl.clearColor(r.r,r.g,r.b,r.a),this.current=r,this.dirty=!1)}}class ih extends Xr{getDefault(){return 1}set(r){(r!==this.current||this.dirty)&&(this.gl.clearDepth(r),this.current=r,this.dirty=!1)}}class cf extends Xr{getDefault(){return 0}set(r){(r!==this.current||this.dirty)&&(this.gl.clearStencil(r),this.current=r,this.dirty=!1)}}class kp extends Xr{getDefault(){return[!0,!0,!0,!0]}set(r){let h=this.current;(r[0]!==h[0]||r[1]!==h[1]||r[2]!==h[2]||r[3]!==h[3]||this.dirty)&&(this.gl.colorMask(r[0],r[1],r[2],r[3]),this.current=r,this.dirty=!1)}}class Op extends Xr{getDefault(){return!0}set(r){(r!==this.current||this.dirty)&&(this.gl.depthMask(r),this.current=r,this.dirty=!1)}}class Ff extends Xr{getDefault(){return 255}set(r){(r!==this.current||this.dirty)&&(this.gl.stencilMask(r),this.current=r,this.dirty=!1)}}class Vu extends Xr{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(r){let h=this.current;(r.func!==h.func||r.ref!==h.ref||r.mask!==h.mask||this.dirty)&&(this.gl.stencilFunc(r.func,r.ref,r.mask),this.current=r,this.dirty=!1)}}class Lh extends Xr{getDefault(){let r=this.gl;return[r.KEEP,r.KEEP,r.KEEP]}set(r){let h=this.current;(r[0]!==h[0]||r[1]!==h[1]||r[2]!==h[2]||this.dirty)&&(this.gl.stencilOp(r[0],r[1],r[2]),this.current=r,this.dirty=!1)}}class Cc extends Xr{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;let h=this.gl;r?h.enable(h.STENCIL_TEST):h.disable(h.STENCIL_TEST),this.current=r,this.dirty=!1}}class Bf extends Xr{getDefault(){return[0,1]}set(r){let h=this.current;(r[0]!==h[0]||r[1]!==h[1]||this.dirty)&&(this.gl.depthRange(r[0],r[1]),this.current=r,this.dirty=!1)}}class Nf extends Xr{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;let h=this.gl;r?h.enable(h.DEPTH_TEST):h.disable(h.DEPTH_TEST),this.current=r,this.dirty=!1}}class nh extends Xr{getDefault(){return this.gl.LESS}set(r){(r!==this.current||this.dirty)&&(this.gl.depthFunc(r),this.current=r,this.dirty=!1)}}class Ad extends Xr{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;let h=this.gl;r?h.enable(h.BLEND):h.disable(h.BLEND),this.current=r,this.dirty=!1}}class Fp extends Xr{getDefault(){let r=this.gl;return[r.ONE,r.ZERO]}set(r){let h=this.current;(r[0]!==h[0]||r[1]!==h[1]||this.dirty)&&(this.gl.blendFunc(r[0],r[1]),this.current=r,this.dirty=!1)}}class Fl extends Xr{getDefault(){return t.be.transparent}set(r){let h=this.current;(r.r!==h.r||r.g!==h.g||r.b!==h.b||r.a!==h.a||this.dirty)&&(this.gl.blendColor(r.r,r.g,r.b,r.a),this.current=r,this.dirty=!1)}}class uu extends Xr{getDefault(){return this.gl.FUNC_ADD}set(r){(r!==this.current||this.dirty)&&(this.gl.blendEquation(r),this.current=r,this.dirty=!1)}}class rh extends Xr{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;let h=this.gl;r?h.enable(h.CULL_FACE):h.disable(h.CULL_FACE),this.current=r,this.dirty=!1}}class Uu extends Xr{getDefault(){return this.gl.BACK}set(r){(r!==this.current||this.dirty)&&(this.gl.cullFace(r),this.current=r,this.dirty=!1)}}class du extends Xr{getDefault(){return this.gl.CCW}set(r){(r!==this.current||this.dirty)&&(this.gl.frontFace(r),this.current=r,this.dirty=!1)}}class Ka extends Xr{getDefault(){return null}set(r){(r!==this.current||this.dirty)&&(this.gl.useProgram(r),this.current=r,this.dirty=!1)}}class Ec extends Xr{getDefault(){return this.gl.TEXTURE0}set(r){(r!==this.current||this.dirty)&&(this.gl.activeTexture(r),this.current=r,this.dirty=!1)}}class xi extends Xr{getDefault(){let r=this.gl;return[0,0,r.drawingBufferWidth,r.drawingBufferHeight]}set(r){let h=this.current;(r[0]!==h[0]||r[1]!==h[1]||r[2]!==h[2]||r[3]!==h[3]||this.dirty)&&(this.gl.viewport(r[0],r[1],r[2],r[3]),this.current=r,this.dirty=!1)}}class kh extends Xr{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;let h=this.gl;h.bindFramebuffer(h.FRAMEBUFFER,r),this.current=r,this.dirty=!1}}class Ya extends Xr{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;let h=this.gl;h.bindRenderbuffer(h.RENDERBUFFER,r),this.current=r,this.dirty=!1}}class Dd extends Xr{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;let h=this.gl;h.bindTexture(h.TEXTURE_2D,r),this.current=r,this.dirty=!1}}class Bp extends Xr{getDefault(){return null}set(r){if(r===this.current&&!this.dirty)return;let h=this.gl;h.bindBuffer(h.ARRAY_BUFFER,r),this.current=r,this.dirty=!1}}class oh extends Xr{getDefault(){return null}set(r){let h=this.gl;h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,r),this.current=r,this.dirty=!1}}class sa extends Xr{getDefault(){return null}set(r){var h;if(r===this.current&&!this.dirty)return;let x=this.gl;Bs(x)?x.bindVertexArray(r):(h=x.getExtension("OES_vertex_array_object"))===null||h===void 0||h.bindVertexArrayOES(r),this.current=r,this.dirty=!1}}class sh extends Xr{getDefault(){return 4}set(r){if(r===this.current&&!this.dirty)return;let h=this.gl;h.pixelStorei(h.UNPACK_ALIGNMENT,r),this.current=r,this.dirty=!1}}class oc extends Xr{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;let h=this.gl;h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r),this.current=r,this.dirty=!1}}class ah extends Xr{getDefault(){return!1}set(r){if(r===this.current&&!this.dirty)return;let h=this.gl;h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,r),this.current=r,this.dirty=!1}}class Bl extends Xr{constructor(r,h){super(r),this.context=r,this.parent=h}getDefault(){return null}}class pu extends Bl{setDirty(){this.dirty=!0}set(r){if(r===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let h=this.gl;h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,r,0),this.current=r,this.dirty=!1}}class Wn extends Bl{set(r){if(r===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let h=this.gl;h.framebufferRenderbuffer(h.FRAMEBUFFER,h.DEPTH_ATTACHMENT,h.RENDERBUFFER,r),this.current=r,this.dirty=!1}}class Oh extends Bl{set(r){if(r===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let h=this.gl;h.framebufferRenderbuffer(h.FRAMEBUFFER,h.DEPTH_STENCIL_ATTACHMENT,h.RENDERBUFFER,r),this.current=r,this.dirty=!1}}let hf="Framebuffer is not complete";class Np{constructor(r,h,x,w,A){this.context=r,this.width=h,this.height=x;let k=r.gl,j=this.framebuffer=k.createFramebuffer();if(this.colorAttachment=new pu(r,j),w)this.depthAttachment=A?new Oh(r,j):new Wn(r,j);else if(A)throw new Error("Stencil cannot be set without depth");if(k.checkFramebufferStatus(k.FRAMEBUFFER)!==k.FRAMEBUFFER_COMPLETE)throw new Error(hf)}destroy(){let r=this.context.gl,h=this.colorAttachment.get();if(h&&r.deleteTexture(h),this.depthAttachment){let x=this.depthAttachment.get();x&&r.deleteRenderbuffer(x)}r.deleteFramebuffer(this.framebuffer)}}class Dr{constructor(r){var h,x;if(this.gl=r,this.clearColor=new rc(this),this.clearDepth=new ih(this),this.clearStencil=new cf(this),this.colorMask=new kp(this),this.depthMask=new Op(this),this.stencilMask=new Ff(this),this.stencilFunc=new Vu(this),this.stencilOp=new Lh(this),this.stencilTest=new Cc(this),this.depthRange=new Bf(this),this.depthTest=new Nf(this),this.depthFunc=new nh(this),this.blend=new Ad(this),this.blendFunc=new Fp(this),this.blendColor=new Fl(this),this.blendEquation=new uu(this),this.cullFace=new rh(this),this.cullFaceSide=new Uu(this),this.frontFace=new du(this),this.program=new Ka(this),this.activeTexture=new Ec(this),this.viewport=new xi(this),this.bindFramebuffer=new kh(this),this.bindRenderbuffer=new Ya(this),this.bindTexture=new Dd(this),this.bindVertexBuffer=new Bp(this),this.bindElementBuffer=new oh(this),this.bindVertexArray=new sa(this),this.pixelStoreUnpack=new sh(this),this.pixelStoreUnpackPremultiplyAlpha=new oc(this),this.pixelStoreUnpackFlipY=new ah(this),this.extTextureFilterAnisotropic=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=r.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),Bs(r)){this.HALF_FLOAT=r.HALF_FLOAT;let w=r.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(h=r.RGBA16F)!==null&&h!==void 0?h:w?.RGBA16F_EXT,this.RGB16F=(x=r.RGB16F)!==null&&x!==void 0?x:w?.RGB16F_EXT,r.getExtension("EXT_color_buffer_float")}else{r.getExtension("EXT_color_buffer_half_float"),r.getExtension("OES_texture_half_float_linear");let w=r.getExtension("OES_texture_half_float");this.HALF_FLOAT=w?.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(r,h){return new Ic(this,r,h)}createVertexBuffer(r,h,x){return new Ol(this,r,h,x)}createRenderbuffer(r,h,x){let w=this.gl,A=w.createRenderbuffer();return this.bindRenderbuffer.set(A),w.renderbufferStorage(w.RENDERBUFFER,r,h,x),this.bindRenderbuffer.set(null),A}createFramebuffer(r,h,x,w){return new Np(this,r,h,x,w)}clear({color:r,depth:h,stencil:x}){let w=this.gl,A=0;r&&(A|=w.COLOR_BUFFER_BIT,this.clearColor.set(r),this.colorMask.set([!0,!0,!0,!0])),h!==void 0&&(A|=w.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(h),this.depthMask.set(!0)),x!==void 0&&(A|=w.STENCIL_BUFFER_BIT,this.clearStencil.set(x),this.stencilMask.set(255)),w.clear(A)}setCullFace(r){r.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(r.mode),this.frontFace.set(r.frontFace))}setDepthMode(r){r.func!==this.gl.ALWAYS||r.mask?(this.depthTest.set(!0),this.depthFunc.set(r.func),this.depthMask.set(r.mask),this.depthRange.set(r.range)):this.depthTest.set(!1)}setStencilMode(r){r.test.func!==this.gl.ALWAYS||r.mask?(this.stencilTest.set(!0),this.stencilMask.set(r.mask),this.stencilOp.set([r.fail,r.depthFail,r.pass]),this.stencilFunc.set({func:r.test.func,ref:r.ref,mask:r.test.mask})):this.stencilTest.set(!1)}setColorMode(r){t.bG(r.blendFunction,Cr.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(r.blendFunction),this.blendColor.set(r.blendColor)),this.colorMask.set(r.mask)}createVertexArray(){var r;return Bs(this.gl)?this.gl.createVertexArray():(r=this.gl.getExtension("OES_vertex_array_object"))===null||r===void 0?void 0:r.createVertexArrayOES()}deleteVertexArray(r){var h;return Bs(this.gl)?this.gl.deleteVertexArray(r):(h=this.gl.getExtension("OES_vertex_array_object"))===null||h===void 0?void 0:h.deleteVertexArrayOES(r)}unbindVAO(){this.bindVertexArray.set(null)}}let lh;function uo(M,r,h,x,w){let A=M.context,k=M.transform,j=A.gl,q=M.useProgram("collisionBox"),J=[],ne=0,pe=0;for(let et=0;et<x.length;et++){let Se=x[et],Be=r.getTile(Se).getBucket(h);if(!Be)continue;let ft=w?Be.textCollisionBox:Be.iconCollisionBox,dt=Be.collisionCircleArray;dt.length>0&&(J.push({circleArray:dt,circleOffset:pe,coord:Se}),ne+=dt.length/4,pe=ne),ft&&q.draw(A,j.LINES,Tr.disabled,Fn.disabled,M.colorModeForRenderPass(),or.disabled,wc(M.transform),M.style.map.terrain&&M.style.map.terrain.getTerrainData(Se),k.getProjectionData({overscaledTileID:Se,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),h.id,ft.layoutVertexBuffer,ft.indexBuffer,ft.segments,null,M.transform.zoom,null,null,ft.collisionVertexBuffer)}if(!w||!J.length)return;let ue=M.useProgram("collisionCircle"),ge=new t.b_;ge.resize(4*ne),ge._trim();let Ee=0;for(let et of J)for(let Se=0;Se<et.circleArray.length/4;Se++){let Be=4*Se,ft=et.circleArray[Be+0],dt=et.circleArray[Be+1],xe=et.circleArray[Be+2],pt=et.circleArray[Be+3];ge.emplace(Ee++,ft,dt,xe,pt,0),ge.emplace(Ee++,ft,dt,xe,pt,1),ge.emplace(Ee++,ft,dt,xe,pt,2),ge.emplace(Ee++,ft,dt,xe,pt,3)}(!lh||lh.length<2*ne)&&(lh=function(et){let Se=2*et,Be=new t.c0;Be.resize(Se),Be._trim();for(let ft=0;ft<Se;ft++){let dt=6*ft;Be.uint16[dt+0]=4*ft+0,Be.uint16[dt+1]=4*ft+1,Be.uint16[dt+2]=4*ft+2,Be.uint16[dt+3]=4*ft+2,Be.uint16[dt+4]=4*ft+3,Be.uint16[dt+5]=4*ft+0}return Be}(ne));let tt=A.createIndexBuffer(lh,!0),Xe=A.createVertexBuffer(ge,t.b$.members,!0);for(let et of J){let Se=$o(M.transform);ue.draw(A,j.TRIANGLES,Tr.disabled,Fn.disabled,M.colorModeForRenderPass(),or.disabled,Se,M.style.map.terrain&&M.style.map.terrain.getTerrainData(et.coord),null,h.id,Xe,tt,t.aL.simpleSegment(0,2*et.circleOffset,et.circleArray.length,et.circleArray.length/2),null,M.transform.zoom,null,null,null)}Xe.destroy(),tt.destroy()}let Vf=t.af(new Float32Array(16));function Rd(M,r,h,x,w,A){let{horizontalAlign:k,verticalAlign:j}=t.aG(M);return new t.P((-(k-.5)*r/w+x[0])*A,(-(j-.5)*h/w+x[1])*A)}function Em(M,r,h,x,w,A){let k=r.tileAnchorPoint.add(new t.P(r.translation[0],r.translation[1]));if(r.pitchWithMap){let j=x.mult(A);h||(j=j.rotate(-w));let q=k.add(j);return je(q.x,q.y,r.pitchedLabelPlaneMatrix,r.getElevation).point}if(h){let j=Bt(r.tileAnchorPoint.x+1,r.tileAnchorPoint.y,r).point.sub(M),q=Math.atan(j.y/j.x)+(j.x<0?Math.PI:0);return M.add(x.rotate(q))}return M.add(x)}function Uf(M,r,h,x,w,A,k,j,q,J,ne,pe){let ue=M.text.placedSymbolArray,ge=M.text.dynamicLayoutVertexArray,Ee=M.icon.dynamicLayoutVertexArray,tt={};ge.clear();for(let Xe=0;Xe<ue.length;Xe++){let et=ue.get(Xe),Se=et.hidden||!et.crossTileID||M.allowVerticalPlacement&&!et.placedOrientation?null:x[et.crossTileID];if(Se){let Be=new t.P(et.anchorX,et.anchorY),ft={getElevation:pe,width:w.width,height:w.height,pitchedLabelPlaneMatrix:A,pitchWithMap:h,transform:w,tileAnchorPoint:Be,translation:J,unwrappedTileID:ne},dt=h?Ni(Be.x,Be.y,ft):Bt(Be.x,Be.y,ft),xe=We(w.cameraToCenterDistance,dt.signedDistanceFromCamera),pt=t.ao(M.textSizeData,j,et)*xe/t.aA;h&&(pt*=M.tilePixelRatio/k);let{width:zt,height:ei,anchor:Kt,textOffset:Jt,textBoxScale:si}=Se,Xi=Rd(Kt,zt,ei,Jt,si,pt),Ki=w.getPitchedTextCorrection(Be.x+J[0],Be.y+J[1],ne),Pi=Em(dt.point,ft,r,Xi,-w.bearingInRadians,Ki),yn=M.allowVerticalPlacement&&et.placedOrientation===t.an.vertical?Math.PI/2:0;for(let xr=0;xr<et.numGlyphs;xr++)t.au(ge,Pi,yn);q&&et.associatedIconIndex>=0&&(tt[et.associatedIconIndex]={shiftedAnchor:Pi,angle:yn})}else yr(et.numGlyphs,ge)}if(q){Ee.clear();let Xe=M.icon.placedSymbolArray;for(let et=0;et<Xe.length;et++){let Se=Xe.get(et);if(Se.hidden)yr(Se.numGlyphs,Ee);else{let Be=tt[et];if(Be)for(let ft=0;ft<Se.numGlyphs;ft++)t.au(Ee,Be.shiftedAnchor,Be.angle);else yr(Se.numGlyphs,Ee)}}M.icon.dynamicLayoutVertexBuffer.updateData(Ee)}M.text.dynamicLayoutVertexBuffer.updateData(ge)}function jf(M,r,h){return h.iconsInText&&r?"symbolTextAndIcon":M?"symbolSDF":"symbolIcon"}function zd(M,r,h,x,w,A,k,j,q,J,ne,pe,ue){let ge=M.context,Ee=ge.gl,tt=M.transform,Xe=j==="map",et=q==="map",Se=j!=="viewport"&&h.layout.get("symbol-placement")!=="point",Be=Xe&&!et&&!Se,ft=!h.layout.get("symbol-sort-key").isConstant(),dt=!1,xe=M.getDepthModeForSublayer(0,Tr.ReadOnly),pt=h._unevaluatedLayout.hasValue("text-variable-anchor")||h._unevaluatedLayout.hasValue("text-variable-anchor-offset"),zt=[],ei=tt.getCircleRadiusCorrection();for(let Kt of x){let Jt=r.getTile(Kt),si=Jt.getBucket(h);if(!si)continue;let Xi=w?si.text:si.icon;if(!Xi||!Xi.segments.get().length||!Xi.hasVisibleVertices)continue;let Ki=Xi.programConfigurations.get(h.id),Pi=w||si.sdfIcons,yn=w?si.textSizeData:si.iconSizeData,xr=et||tt.pitch!==0,Kr=M.useProgram(jf(Pi,w,si),Ki),Ho=t.am(yn,tt.zoom),Eo=M.style.map.terrain&&M.style.map.terrain.getTerrainData(Kt),Go,vo,Yr,Mo,ps=[0,0],lr=null;if(w)vo=Jt.glyphAtlasTexture,Yr=Ee.LINEAR,Go=Jt.glyphAtlasTexture.size,si.iconsInText&&(ps=Jt.imageAtlasTexture.size,lr=Jt.imageAtlasTexture,Mo=xr||M.options.rotating||M.options.zooming||yn.kind==="composite"||yn.kind==="camera"?Ee.LINEAR:Ee.NEAREST);else{let So=h.layout.get("icon-size").constantOr(0)!==1||si.iconsNeedLinear;vo=Jt.imageAtlasTexture,Yr=Pi||M.options.rotating||M.options.zooming||So||xr?Ee.LINEAR:Ee.NEAREST,Go=Jt.imageAtlasTexture.size}let aa=t.aB(Jt,1,M.transform.zoom),Rs=fe(Xe,M.transform,aa),Rr=t.L();t.ap(Rr,Rs);let Kn=Ae(et,Xe,M.transform,aa),Ac=t.aC(tt,Jt,A,k),la=tt.getProjectionData({overscaledTileID:Kt,applyGlobeMatrix:!ue,applyTerrainMatrix:!0}),qh=pt&&si.hasTextData(),uc=h.layout.get("icon-text-fit")!=="none"&&qh&&si.hasIconData();if(Se){let So=M.style.map.terrain?(ca,ts)=>M.style.map.terrain.getElevation(Kt,ca,ts):null,io=h.layout.get("text-rotation-alignment")==="map";ct(si,M,w,Rs,Rr,et,J,io,Kt.toUnwrapped(),tt.width,tt.height,Ac,So)}let dc=w&&pt||uc,Ca=Se||dc?Vf:et?Rs:M.transform.clipSpaceToPixelsMatrix,Fa=Pi&&h.paint.get(w?"text-halo-width":"icon-halo-width").constantOr(1)!==0,Dc;Dc=Pi?si.iconsInText?hu(yn.kind,Ho,Be,et,Se,dc,M,Ca,Kn,Ac,Go,ps,ei):kl(yn.kind,Ho,Be,et,Se,dc,M,Ca,Kn,Ac,w,Go,0,ei):Sc(yn.kind,Ho,Be,et,Se,dc,M,Ca,Kn,Ac,w,Go,ei);let vh={program:Kr,buffers:Xi,uniformValues:Dc,projectionData:la,atlasTexture:vo,atlasTextureIcon:lr,atlasInterpolation:Yr,atlasInterpolationIcon:Mo,isSDF:Pi,hasHalo:Fa};if(ft&&si.canOverlap){dt=!0;let So=Xi.segments.get();for(let io of So)zt.push({segments:new t.aL([io]),sortKey:io.sortKey,state:vh,terrainData:Eo})}else zt.push({segments:Xi.segments,sortKey:0,state:vh,terrainData:Eo})}dt&&zt.sort((Kt,Jt)=>Kt.sortKey-Jt.sortKey);for(let Kt of zt){let Jt=Kt.state;if(ge.activeTexture.set(Ee.TEXTURE0),Jt.atlasTexture.bind(Jt.atlasInterpolation,Ee.CLAMP_TO_EDGE),Jt.atlasTextureIcon&&(ge.activeTexture.set(Ee.TEXTURE1),Jt.atlasTextureIcon&&Jt.atlasTextureIcon.bind(Jt.atlasInterpolationIcon,Ee.CLAMP_TO_EDGE)),Jt.isSDF){let si=Jt.uniformValues;Jt.hasHalo&&(si.u_is_halo=1,Vp(Jt.buffers,Kt.segments,h,M,Jt.program,xe,ne,pe,si,Jt.projectionData,Kt.terrainData)),si.u_is_halo=0}Vp(Jt.buffers,Kt.segments,h,M,Jt.program,xe,ne,pe,Jt.uniformValues,Jt.projectionData,Kt.terrainData)}}function Vp(M,r,h,x,w,A,k,j,q,J,ne){let pe=x.context;w.draw(pe,pe.gl.TRIANGLES,A,k,j,or.backCCW,q,ne,J,h.id,M.layoutVertexBuffer,M.indexBuffer,r,h.paint,x.transform.zoom,M.programConfigurations.get(h.id),M.dynamicLayoutVertexBuffer,M.opacityVertexBuffer)}function Ld(M,r,h,x,w){let A=M.context,k=A.gl,j=Fn.disabled,q=new Cr([k.ONE,k.ONE],t.be.transparent,[!0,!0,!0,!0]),J=r.getBucket(h);if(!J)return;let ne=x.key,pe=h.heatmapFbos.get(ne);pe||(pe=Fh(A,r.tileSize,r.tileSize),h.heatmapFbos.set(ne,pe)),A.bindFramebuffer.set(pe.framebuffer),A.viewport.set([0,0,r.tileSize,r.tileSize]),A.clear({color:t.be.transparent});let ue=J.programConfigurations.get(h.id),ge=M.useProgram("heatmap",ue,!w),Ee=M.transform.getProjectionData({overscaledTileID:r.tileID,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),tt=M.style.map.terrain.getTerrainData(x);ge.draw(A,k.TRIANGLES,Tr.disabled,j,q,or.disabled,Tn(r,M.transform.zoom,h.paint.get("heatmap-intensity"),1),tt,Ee,h.id,J.layoutVertexBuffer,J.indexBuffer,J.segments,h.paint,M.transform.zoom,ue)}function ju(M,r,h,x,w){let A=M.context,k=A.gl,j=M.transform;A.setColorMode(M.colorModeForRenderPass());let q=Gu(A,r),J=h.key,ne=r.heatmapFbos.get(J);if(!ne)return;A.activeTexture.set(k.TEXTURE0),k.bindTexture(k.TEXTURE_2D,ne.colorAttachment.get()),A.activeTexture.set(k.TEXTURE1),q.bind(k.LINEAR,k.CLAMP_TO_EDGE);let pe=j.getProjectionData({overscaledTileID:h,applyTerrainMatrix:w,applyGlobeMatrix:!x});M.useProgram("heatmapTexture").draw(A,k.TRIANGLES,Tr.disabled,Fn.disabled,M.colorModeForRenderPass(),or.disabled,Li(M,r,0,1),null,pe,r.id,M.rasterBoundsBuffer,M.quadTriangleIndexBuffer,M.rasterBoundsSegments,r.paint,j.zoom),ne.destroy(),r.heatmapFbos.delete(J)}function Fh(M,r,h){var x,w;let A=M.gl,k=A.createTexture();A.bindTexture(A.TEXTURE_2D,k),A.texParameteri(A.TEXTURE_2D,A.TEXTURE_WRAP_S,A.CLAMP_TO_EDGE),A.texParameteri(A.TEXTURE_2D,A.TEXTURE_WRAP_T,A.CLAMP_TO_EDGE),A.texParameteri(A.TEXTURE_2D,A.TEXTURE_MIN_FILTER,A.LINEAR),A.texParameteri(A.TEXTURE_2D,A.TEXTURE_MAG_FILTER,A.LINEAR);let j=(x=M.HALF_FLOAT)!==null&&x!==void 0?x:A.UNSIGNED_BYTE,q=(w=M.RGBA16F)!==null&&w!==void 0?w:A.RGBA;A.texImage2D(A.TEXTURE_2D,0,q,r,h,0,A.RGBA,j,null);let J=M.createFramebuffer(r,h,!1,!1);return J.colorAttachment.set(k),J}function Gu(M,r){return r.colorRampTexture||(r.colorRampTexture=new t.T(M,r.colorRamp,M.gl.RGBA)),r.colorRampTexture}function ch(M,r,h,x,w){if(!h||!x||!x.imageAtlas)return;let A=x.imageAtlas.patternPositions,k=A[h.to.toString()],j=A[h.from.toString()];if(!k&&j&&(k=j),!j&&k&&(j=k),!k||!j){let q=w.getPaintProperty(r);k=A[q],j=A[q]}k&&j&&M.setConstantPatternPositions(k,j)}function fu(M,r,h,x,w,A,k,j){let q=M.context.gl,J="fill-pattern",ne=h.paint.get(J),pe=ne&&ne.constantOr(1),ue=h.getCrossfadeParameters(),ge,Ee,tt,Xe,et,Se=M.transform,Be=h.paint.get("fill-translate"),ft=h.paint.get("fill-translate-anchor");k?(Ee=pe&&!h.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",ge=q.LINES):(Ee=pe?"fillPattern":"fill",ge=q.TRIANGLES);let dt=ne.constantOr(null);for(let xe of x){let pt=r.getTile(xe);if(pe&&!pt.patternsLoaded())continue;let zt=pt.getBucket(h);if(!zt)continue;let ei=zt.programConfigurations.get(h.id),Kt=M.useProgram(Ee,ei),Jt=M.style.map.terrain&&M.style.map.terrain.getTerrainData(xe);pe&&(M.context.activeTexture.set(q.TEXTURE0),pt.imageAtlasTexture.bind(q.LINEAR,q.CLAMP_TO_EDGE),ei.updatePaintBuffers(ue)),ch(ei,J,dt,pt,h);let si=Se.getProjectionData({overscaledTileID:xe,applyGlobeMatrix:!j,applyTerrainMatrix:!0}),Xi=t.aC(Se,pt,Be,ft);if(k){Xe=zt.indexBuffer2,et=zt.segments2;let Pi=[q.drawingBufferWidth,q.drawingBufferHeight];tt=Ee==="fillOutlinePattern"&&pe?Xa(M,ue,pt,Pi,Xi):Vs(Pi,Xi)}else Xe=zt.indexBuffer,et=zt.segments,tt=pe?Ks(M,ue,pt,Xi):{u_fill_translate:Xi};let Ki=M.stencilModeForClipping(xe);Kt.draw(M.context,ge,w,Ki,A,or.backCCW,tt,Jt,si,h.id,zt.layoutVertexBuffer,Xe,et,h.paint,M.transform.zoom,ei)}}function mu(M,r,h,x,w,A,k,j){let q=M.context,J=q.gl,ne="fill-extrusion-pattern",pe=h.paint.get(ne),ue=pe.constantOr(1),ge=h.getCrossfadeParameters(),Ee=h.paint.get("fill-extrusion-opacity"),tt=pe.constantOr(null),Xe=M.transform;for(let et of x){let Se=r.getTile(et),Be=Se.getBucket(h);if(!Be)continue;let ft=M.style.map.terrain&&M.style.map.terrain.getTerrainData(et),dt=Be.programConfigurations.get(h.id),xe=M.useProgram(ue?"fillExtrusionPattern":"fillExtrusion",dt);ue&&(M.context.activeTexture.set(J.TEXTURE0),Se.imageAtlasTexture.bind(J.LINEAR,J.CLAMP_TO_EDGE),dt.updatePaintBuffers(ge));let pt=Xe.getProjectionData({overscaledTileID:et,applyGlobeMatrix:!j,applyTerrainMatrix:!0});ch(dt,ne,tt,Se,h);let zt=t.aC(Xe,Se,h.paint.get("fill-extrusion-translate"),h.paint.get("fill-extrusion-translate-anchor")),ei=h.paint.get("fill-extrusion-vertical-gradient"),Kt=ue?Ou(M,ei,Ee,zt,et,ge,Se):zl(M,ei,Ee,zt);xe.draw(q,q.gl.TRIANGLES,w,A,k,or.backCCW,Kt,ft,pt,h.id,Be.layoutVertexBuffer,Be.indexBuffer,Be.segments,h.paint,M.transform.zoom,dt,M.style.map.terrain&&Be.centroidVertexBuffer)}}function sc(M,r,h,x,w,A,k,j,q){var J;let ne=M.style.projection,pe=M.context,ue=M.transform,ge=pe.gl,Ee=[`#define NUM_ILLUMINATION_SOURCES ${h.paint.get("hillshade-highlight-color").values.length}`],tt=M.useProgram("hillshade",null,!1,Ee),Xe=!M.options.moving;for(let et of x){let Se=r.getTile(et),Be=Se.fbo;if(!Be)continue;let ft=ne.getMeshFromTileID(pe,et.canonical,j,!0,"raster"),dt=(J=M.style.map.terrain)===null||J===void 0?void 0:J.getTerrainData(et);pe.activeTexture.set(ge.TEXTURE0),ge.bindTexture(ge.TEXTURE_2D,Be.colorAttachment.get());let xe=ue.getProjectionData({overscaledTileID:et,aligned:Xe,applyGlobeMatrix:!q,applyTerrainMatrix:!0});tt.draw(pe,ge.TRIANGLES,A,w[et.overscaledZ],k,or.backCCW,Tc(M,Se,h),dt,xe,h.id,ft.vertexBuffer,ft.indexBuffer,ft.segments)}}function hh(M,r,h,x,w,A,k,j,q){var J;let ne=M.style.projection,pe=M.context,ue=M.transform,ge=pe.gl,Ee=M.useProgram("colorRelief"),tt=!M.options.moving,Xe=!0;for(let et of x){let Se=r.getTile(et),Be=Se.dem;if(Xe){let ei=ge.getParameter(ge.MAX_TEXTURE_SIZE),{elevationTexture:Kt,colorTexture:Jt}=h.getColorRampTextures(pe,ei,Be.getUnpackVector());pe.activeTexture.set(ge.TEXTURE1),Kt.bind(ge.NEAREST,ge.CLAMP_TO_EDGE),pe.activeTexture.set(ge.TEXTURE4),Jt.bind(ge.LINEAR,ge.CLAMP_TO_EDGE),Xe=!1}if(!Be||!Be.data)continue;let ft=Be.stride,dt=Be.getPixels();if(pe.activeTexture.set(ge.TEXTURE0),pe.pixelStoreUnpackPremultiplyAlpha.set(!1),Se.demTexture=Se.demTexture||M.getTileTexture(ft),Se.demTexture){let ei=Se.demTexture;ei.update(dt,{premultiply:!1}),ei.bind(ge.LINEAR,ge.CLAMP_TO_EDGE)}else Se.demTexture=new t.T(pe,dt,ge.RGBA,{premultiply:!1}),Se.demTexture.bind(ge.LINEAR,ge.CLAMP_TO_EDGE);let xe=ne.getMeshFromTileID(pe,et.canonical,j,!0,"raster"),pt=(J=M.style.map.terrain)===null||J===void 0?void 0:J.getTerrainData(et),zt=ue.getProjectionData({overscaledTileID:et,aligned:tt,applyGlobeMatrix:!q,applyTerrainMatrix:!0});Ee.draw(pe,ge.TRIANGLES,A,w[et.overscaledZ],k,or.backCCW,Fu(h,Se.dem),pt,zt,h.id,xe.vertexBuffer,xe.indexBuffer,xe.segments)}}let Zu=[new t.P(0,0),new t.P(t.$,0),new t.P(t.$,t.$),new t.P(0,t.$)];function ac(M,r,h,x,w,A,k,j,q=!1,J=!1){let ne=x[x.length-1].overscaledZ,pe=M.context,ue=pe.gl,ge=M.useProgram("raster"),Ee=M.transform,tt=M.style.projection,Xe=M.colorModeForRenderPass(),et=!M.options.moving;for(let Se of x){let Be=M.getDepthModeForSublayer(Se.overscaledZ-ne,h.paint.get("raster-opacity")===1?Tr.ReadWrite:Tr.ReadOnly,ue.LESS),ft=r.getTile(Se);ft.registerFadeDuration(h.paint.get("raster-fade-duration"));let dt=r.findLoadedParent(Se,0),xe=r.findLoadedSibling(Se),pt=qu(ft,dt||xe||null,r,h,M.transform,M.style.map.terrain),zt,ei,Kt=h.paint.get("raster-resampling")==="nearest"?ue.NEAREST:ue.LINEAR;pe.activeTexture.set(ue.TEXTURE0),ft.texture.bind(Kt,ue.CLAMP_TO_EDGE,ue.LINEAR_MIPMAP_NEAREST),pe.activeTexture.set(ue.TEXTURE1),dt?(dt.texture.bind(Kt,ue.CLAMP_TO_EDGE,ue.LINEAR_MIPMAP_NEAREST),zt=Math.pow(2,dt.tileID.overscaledZ-ft.tileID.overscaledZ),ei=[ft.tileID.canonical.x*zt%1,ft.tileID.canonical.y*zt%1]):ft.texture.bind(Kt,ue.CLAMP_TO_EDGE,ue.LINEAR_MIPMAP_NEAREST),ft.texture.useMipmap&&pe.extTextureFilterAnisotropic&&M.transform.pitch>20&&ue.texParameterf(ue.TEXTURE_2D,pe.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,pe.extTextureFilterAnisotropicMax);let Jt=M.style.map.terrain&&M.style.map.terrain.getTerrainData(Se),si=Ee.getProjectionData({overscaledTileID:Se,aligned:et,applyGlobeMatrix:!J,applyTerrainMatrix:!0}),Xi=ws(ei||[0,0],zt||1,pt,h,j),Ki=tt.getMeshFromTileID(pe,Se.canonical,A,k,"raster");ge.draw(pe,ue.TRIANGLES,Be,w?w[Se.overscaledZ]:Fn.disabled,Xe,q?or.frontCCW:or.backCCW,Xi,Jt,si,h.id,Ki.vertexBuffer,Ki.indexBuffer,Ki.segments)}}function qu(M,r,h,x,w,A){let k=x.paint.get("raster-fade-duration");if(!A&&k>0){let j=an.now(),q=(j-M.timeAdded)/k,J=r?(j-r.timeAdded)/k:-1,ne=h.getSource(),pe=di(w,{tileSize:ne.tileSize,roundZoom:ne.roundZoom}),ue=!r||Math.abs(r.tileID.overscaledZ-pe)>Math.abs(M.tileID.overscaledZ-pe),ge=ue&&M.refreshedUponExpiration?1:t.ag(ue?q:1-J,0,1);return M.refreshedUponExpiration&&q>=1&&(M.refreshedUponExpiration=!1),r?{opacity:1,mix:1-ge}:{opacity:ge,mix:0}}return{opacity:1,mix:0}}let kd=new t.be(1,0,0,1),$u=new t.be(0,1,0,1),Up=new t.be(0,0,1,1),jp=new t.be(1,0,1,1),Od=new t.be(0,1,1,1);function uh(M,r,h,x){Bd(M,0,r+h/2,M.transform.width,h,x)}function Fd(M,r,h,x){Bd(M,r-h/2,0,h,M.transform.height,x)}function Bd(M,r,h,x,w,A){let k=M.context,j=k.gl;j.enable(j.SCISSOR_TEST),j.scissor(r*M.pixelRatio,h*M.pixelRatio,x*M.pixelRatio,w*M.pixelRatio),k.clear({color:A}),j.disable(j.SCISSOR_TEST)}function uf(M,r,h){let x=M.context,w=x.gl,A=M.useProgram("debug"),k=Tr.disabled,j=Fn.disabled,q=M.colorModeForRenderPass(),J="$debug",ne=M.style.map.terrain&&M.style.map.terrain.getTerrainData(h);x.activeTexture.set(w.TEXTURE0);let pe=r.getTileByID(h.key).latestRawTileData,ue=Math.floor((pe&&pe.byteLength||0)/1024),ge=r.getTile(h).tileSize,Ee=512/Math.min(ge,512)*(h.overscaledZ/M.transform.zoom)*.5,tt=h.canonical.toString();h.overscaledZ!==h.canonical.z&&(tt+=` => ${h.overscaledZ}`),function(et,Se){et.initDebugOverlayCanvas();let Be=et.debugOverlayCanvas,ft=et.context.gl,dt=et.debugOverlayCanvas.getContext("2d");dt.clearRect(0,0,Be.width,Be.height),dt.shadowColor="white",dt.shadowBlur=2,dt.lineWidth=1.5,dt.strokeStyle="white",dt.textBaseline="top",dt.font="bold 36px Open Sans, sans-serif",dt.fillText(Se,5,5),dt.strokeText(Se,5,5),et.debugOverlayTexture.update(Be),et.debugOverlayTexture.bind(ft.LINEAR,ft.CLAMP_TO_EDGE)}(M,`${tt} ${ue}kB`);let Xe=M.transform.getProjectionData({overscaledTileID:h,applyGlobeMatrix:!0,applyTerrainMatrix:!0});A.draw(x,w.TRIANGLES,k,j,Cr.alphaBlended,or.disabled,Ia(t.be.transparent,Ee),null,Xe,J,M.debugBuffer,M.quadTriangleIndexBuffer,M.debugSegments),A.draw(x,w.LINE_STRIP,k,j,q,or.disabled,Ia(t.be.red),ne,Xe,J,M.debugBuffer,M.tileBorderIndexBuffer,M.debugSegments)}function Ro(M,r,h,x){let{isRenderingGlobe:w}=x,A=M.context,k=A.gl,j=M.transform,q=M.colorModeForRenderPass(),J=M.getDepthModeFor3D(),ne=M.useProgram("terrain");A.bindFramebuffer.set(null),A.viewport.set([0,0,M.width,M.height]);for(let pe of h){let ue=r.getTerrainMesh(pe.tileID),ge=M.renderToTexture.getTexture(pe),Ee=r.getTerrainData(pe.tileID);A.activeTexture.set(k.TEXTURE0),k.bindTexture(k.TEXTURE_2D,ge.texture);let tt=r.getMeshFrameDelta(j.zoom),Xe=j.calculateFogMatrix(pe.tileID.toUnwrapped()),et=us(tt,Xe,M.style.sky,j.pitch,w),Se=j.getProjectionData({overscaledTileID:pe.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});ne.draw(A,k.TRIANGLES,J,Fn.disabled,q,or.backCCW,et,Ee,Se,"terrain",ue.vertexBuffer,ue.indexBuffer,ue.segments)}}function dh(M,r){if(!r.mesh){let h=new t.aK;h.emplaceBack(-1,-1),h.emplaceBack(1,-1),h.emplaceBack(1,1),h.emplaceBack(-1,1);let x=new t.aM;x.emplaceBack(0,1,2),x.emplaceBack(0,2,3),r.mesh=new ec(M.createVertexBuffer(h,Ta.members),M.createIndexBuffer(x),t.aL.simpleSegment(0,0,h.length,x.length))}return r.mesh}class Nl{constructor(r,h){this.context=new Dr(r),this.transform=h,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:t.af(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=wi.maxUnderzooming+wi.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new al}resize(r,h,x){if(this.width=Math.floor(r*x),this.height=Math.floor(h*x),this.pixelRatio=x,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(let w of this.style._order)this.style._layers[w].resize()}setup(){let r=this.context,h=new t.aK;h.emplaceBack(0,0),h.emplaceBack(t.$,0),h.emplaceBack(0,t.$),h.emplaceBack(t.$,t.$),this.tileExtentBuffer=r.createVertexBuffer(h,Ta.members),this.tileExtentSegments=t.aL.simpleSegment(0,0,4,2);let x=new t.aK;x.emplaceBack(0,0),x.emplaceBack(t.$,0),x.emplaceBack(0,t.$),x.emplaceBack(t.$,t.$),this.debugBuffer=r.createVertexBuffer(x,Ta.members),this.debugSegments=t.aL.simpleSegment(0,0,4,5);let w=new t.c5;w.emplaceBack(0,0,0,0),w.emplaceBack(t.$,0,t.$,0),w.emplaceBack(0,t.$,0,t.$),w.emplaceBack(t.$,t.$,t.$,t.$),this.rasterBoundsBuffer=r.createVertexBuffer(w,Md.members),this.rasterBoundsSegments=t.aL.simpleSegment(0,0,4,2);let A=new t.aK;A.emplaceBack(0,0),A.emplaceBack(t.$,0),A.emplaceBack(0,t.$),A.emplaceBack(t.$,t.$),this.rasterBoundsBufferPosOnly=r.createVertexBuffer(A,Ta.members),this.rasterBoundsSegmentsPosOnly=t.aL.simpleSegment(0,0,4,5);let k=new t.aK;k.emplaceBack(0,0),k.emplaceBack(1,0),k.emplaceBack(0,1),k.emplaceBack(1,1),this.viewportBuffer=r.createVertexBuffer(k,Ta.members),this.viewportSegments=t.aL.simpleSegment(0,0,4,2);let j=new t.c6;j.emplaceBack(0),j.emplaceBack(1),j.emplaceBack(3),j.emplaceBack(2),j.emplaceBack(0),this.tileBorderIndexBuffer=r.createIndexBuffer(j);let q=new t.aM;q.emplaceBack(1,0,2),q.emplaceBack(1,2,3),this.quadTriangleIndexBuffer=r.createIndexBuffer(q);let J=this.context.gl;this.stencilClearMode=new Fn({func:J.ALWAYS,mask:0},0,255,J.ZERO,J.ZERO,J.ZERO),this.tileExtentMesh=new ec(this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}clearStencil(){let r=this.context,h=r.gl;this.nextStencilID=1,this.currentStencilSource=void 0;let x=t.L();t.bX(x,0,this.width,this.height,0,0,1),t.N(x,x,[h.drawingBufferWidth,h.drawingBufferHeight,0]);let w={mainMatrix:x,tileMercatorCoords:[0,0,1,1],clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:x};this.useProgram("clippingMask",null,!0).draw(r,h.TRIANGLES,Tr.disabled,this.stencilClearMode,Cr.disabled,or.disabled,null,null,w,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(r,h,x){if(this.currentStencilSource===r.source||!r.isTileClipped()||!h||!h.length)return;this.currentStencilSource=r.source,this.nextStencilID+h.length>256&&this.clearStencil();let w=this.context;w.setColorMode(Cr.disabled),w.setDepthMode(Tr.disabled);let A={};for(let k of h)A[k.key]=this.nextStencilID++;this._renderTileMasks(A,h,x,!0),this._renderTileMasks(A,h,x,!1),this._tileClippingMaskIDs=A}_renderTileMasks(r,h,x,w){let A=this.context,k=A.gl,j=this.style.projection,q=this.transform,J=this.useProgram("clippingMask");for(let ne of h){let pe=r[ne.key],ue=this.style.map.terrain&&this.style.map.terrain.getTerrainData(ne),ge=j.getMeshFromTileID(this.context,ne.canonical,w,!0,"stencil"),Ee=q.getProjectionData({overscaledTileID:ne,applyGlobeMatrix:!x,applyTerrainMatrix:!0});J.draw(A,k.TRIANGLES,Tr.disabled,new Fn({func:k.ALWAYS,mask:0},pe,255,k.KEEP,k.KEEP,k.REPLACE),Cr.disabled,x?or.disabled:or.backCCW,null,ue,Ee,"$clipping",ge.vertexBuffer,ge.indexBuffer,ge.segments)}}_renderTilesDepthBuffer(){let r=this.context,h=r.gl,x=this.style.projection,w=this.transform,A=this.useProgram("depth"),k=this.getDepthModeFor3D(),j=li(w,{tileSize:w.tileSize});for(let q of j){let J=this.style.map.terrain&&this.style.map.terrain.getTerrainData(q),ne=x.getMeshFromTileID(this.context,q.canonical,!0,!0,"raster"),pe=w.getProjectionData({overscaledTileID:q,applyGlobeMatrix:!0,applyTerrainMatrix:!0});A.draw(r,h.TRIANGLES,k,Fn.disabled,Cr.disabled,or.backCCW,null,J,pe,"$clipping",ne.vertexBuffer,ne.indexBuffer,ne.segments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();let r=this.nextStencilID++,h=this.context.gl;return new Fn({func:h.NOTEQUAL,mask:255},r,255,h.KEEP,h.KEEP,h.REPLACE)}stencilModeForClipping(r){let h=this.context.gl;return new Fn({func:h.EQUAL,mask:255},this._tileClippingMaskIDs[r.key],0,h.KEEP,h.KEEP,h.REPLACE)}getStencilConfigForOverlapAndUpdateStencilID(r){let h=this.context.gl,x=r.sort((k,j)=>j.overscaledZ-k.overscaledZ),w=x[x.length-1].overscaledZ,A=x[0].overscaledZ-w+1;if(A>1){this.currentStencilSource=void 0,this.nextStencilID+A>256&&this.clearStencil();let k={};for(let j=0;j<A;j++)k[j+w]=new Fn({func:h.GEQUAL,mask:255},j+this.nextStencilID,255,h.KEEP,h.KEEP,h.REPLACE);return this.nextStencilID+=A,[k,x]}return[{[w]:Fn.disabled},x]}stencilConfigForOverlapTwoPass(r){let h=this.context.gl,x=r.sort((k,j)=>j.overscaledZ-k.overscaledZ),w=x[x.length-1].overscaledZ,A=x[0].overscaledZ-w+1;if(this.clearStencil(),A>1){let k={},j={};for(let q=0;q<A;q++)k[q+w]=new Fn({func:h.GREATER,mask:255},A+1+q,255,h.KEEP,h.KEEP,h.REPLACE),j[q+w]=new Fn({func:h.GREATER,mask:255},1+q,255,h.KEEP,h.KEEP,h.REPLACE);return this.nextStencilID=2*A+1,[k,j,x]}return this.nextStencilID=3,[{[w]:new Fn({func:h.GREATER,mask:255},2,255,h.KEEP,h.KEEP,h.REPLACE)},{[w]:new Fn({func:h.GREATER,mask:255},1,255,h.KEEP,h.KEEP,h.REPLACE)},x]}colorModeForRenderPass(){let r=this.context.gl;return this._showOverdrawInspector?new Cr([r.CONSTANT_COLOR,r.ONE],new t.be(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Cr.unblended:Cr.alphaBlended}getDepthModeForSublayer(r,h,x){if(!this.opaquePassEnabledForLayer())return Tr.disabled;let w=1-((1+this.currentLayer)*this.numSublayers+r)*this.depthEpsilon;return new Tr(x||this.context.gl.LEQUAL,h,[w,w])}getDepthModeFor3D(){return new Tr(this.context.gl.LEQUAL,Tr.ReadWrite,this.depthRangeFor3D)}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(r,h){var x,w;this.style=r,this.options=h,this.lineAtlas=r.lineAtlas,this.imageManager=r.imageManager,this.glyphManager=r.glyphManager,this.symbolFadeChange=r.placement.symbolFadeChange(an.now()),this.imageManager.beginFrame();let A=this.style._order,k=this.style.sourceCaches,j={},q={},J={},ne={isRenderingToTexture:!1,isRenderingGlobe:((x=r.projection)===null||x===void 0?void 0:x.transitionState)>0};for(let ue in k){let ge=k[ue];ge.used&&ge.prepare(this.context),j[ue]=ge.getVisibleCoordinates(!1),q[ue]=j[ue].slice().reverse(),J[ue]=ge.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let ue=0;ue<A.length;ue++)if(this.style._layers[A[ue]].is3D()){this.opaquePassCutoff=ue;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(let ue of A){let ge=this.style._layers[ue];if(!ge.hasOffscreenPass()||ge.isHidden(this.transform.zoom))continue;let Ee=q[ge.source];(ge.type==="custom"||Ee.length)&&this.renderLayer(this,k[ge.source],ge,Ee,ne)}if((w=this.style.projection)===null||w===void 0||w.updateGPUdependent({context:this.context,useProgram:ue=>this.useProgram(ue)}),this.context.viewport.set([0,0,this.width,this.height]),this.context.bindFramebuffer.set(null),this.context.clear({color:h.showOverdrawInspector?t.be.black:t.be.transparent,depth:1}),this.clearStencil(),this.style.sky&&function(ue,ge){let Ee=ue.context,tt=Ee.gl,Xe=((xe,pt,zt)=>{let ei=Math.cos(pt.rollInRadians),Kt=Math.sin(pt.rollInRadians),Jt=Fe(pt),si=pt.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}).projectionTransition;return{u_sky_color:xe.properties.get("sky-color"),u_horizon_color:xe.properties.get("horizon-color"),u_horizon:[(pt.width/2-Jt*Kt)*zt,(pt.height/2+Jt*ei)*zt],u_horizon_normal:[-Kt,ei],u_sky_horizon_blend:xe.properties.get("sky-horizon-blend")*pt.height/2*zt,u_sky_blend:si}})(ge,ue.style.map.transform,ue.pixelRatio),et=new Tr(tt.LEQUAL,Tr.ReadWrite,[0,1]),Se=Fn.disabled,Be=ue.colorModeForRenderPass(),ft=ue.useProgram("sky"),dt=dh(Ee,ge);ft.draw(Ee,tt.TRIANGLES,et,Se,Be,or.disabled,Xe,null,void 0,"sky",dt.vertexBuffer,dt.indexBuffer,dt.segments)}(this,this.style.sky),this._showOverdrawInspector=h.showOverdrawInspector,this.depthRangeFor3D=[0,1-(r._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=A.length-1;this.currentLayer>=0;this.currentLayer--){let ue=this.style._layers[A[this.currentLayer]],ge=k[ue.source],Ee=j[ue.source];this._renderTileClippingMasks(ue,Ee,!1),this.renderLayer(this,ge,ue,Ee,ne)}this.renderPass="translucent";let pe=!1;for(this.currentLayer=0;this.currentLayer<A.length;this.currentLayer++){let ue=this.style._layers[A[this.currentLayer]],ge=k[ue.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(ue,ne))continue;this.opaquePassEnabledForLayer()||pe||(pe=!0,ne.isRenderingGlobe&&!this.style.map.terrain&&this._renderTilesDepthBuffer());let Ee=(ue.type==="symbol"?J:q)[ue.source];this._renderTileClippingMasks(ue,j[ue.source],!!this.renderToTexture),this.renderLayer(this,ge,ue,Ee,ne)}if(ne.isRenderingGlobe&&function(ue,ge,Ee){let tt=ue.context,Xe=tt.gl,et=ue.useProgram("atmosphere"),Se=new Tr(Xe.LEQUAL,Tr.ReadOnly,[0,1]),Be=ue.transform,ft=function(si,Xi){let Ki=si.properties.get("position"),Pi=[-Ki.x,-Ki.y,-Ki.z],yn=t.af(new Float64Array(16));return si.properties.get("anchor")==="map"&&(t.b5(yn,yn,Xi.rollInRadians),t.b6(yn,yn,-Xi.pitchInRadians),t.b5(yn,yn,Xi.bearingInRadians),t.b6(yn,yn,Xi.center.lat*Math.PI/180),t.by(yn,yn,-Xi.center.lng*Math.PI/180)),t.c4(Pi,Pi,yn),Pi}(Ee,ue.transform),dt=Be.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),xe=ge.properties.get("atmosphere-blend")*dt.projectionTransition;if(xe===0)return;let pt=Yc(Be.worldSize,Be.center.lat),zt=Be.inverseProjectionMatrix,ei=new Float64Array(4);ei[3]=1,t.av(ei,ei,Be.modelViewProjectionMatrix),ei[0]/=ei[3],ei[1]/=ei[3],ei[2]/=ei[3],ei[3]=1,t.av(ei,ei,zt),ei[0]/=ei[3],ei[1]/=ei[3],ei[2]/=ei[3],ei[3]=1;let Kt=((si,Xi,Ki,Pi,yn)=>({u_sun_pos:si,u_atmosphere_blend:Xi,u_globe_position:Ki,u_globe_radius:Pi,u_inv_proj_matrix:yn}))(ft,xe,[ei[0],ei[1],ei[2]],pt,zt),Jt=dh(tt,ge);et.draw(tt,Xe.TRIANGLES,Se,Fn.disabled,Cr.alphaBlended,or.disabled,Kt,null,null,"atmosphere",Jt.vertexBuffer,Jt.indexBuffer,Jt.segments)}(this,this.style.sky,this.style.light),this.options.showTileBoundaries){let ue=function(ge,Ee){let tt=null,Xe=Object.values(ge._layers).flatMap(ft=>ft.source&&!ft.isHidden(Ee)?[ge.sourceCaches[ft.source]]:[]),et=Xe.filter(ft=>ft.getSource().type==="vector"),Se=Xe.filter(ft=>ft.getSource().type!=="vector"),Be=ft=>{(!tt||tt.getSource().maxzoom<ft.getSource().maxzoom)&&(tt=ft)};return et.forEach(ft=>Be(ft)),tt||Se.forEach(ft=>Be(ft)),tt}(this.style,this.transform.zoom);ue&&function(ge,Ee,tt){for(let Xe=0;Xe<tt.length;Xe++)uf(ge,Ee,tt[Xe])}(this,ue,ue.getVisibleCoordinates())}this.options.showPadding&&function(ue){let ge=ue.transform.padding;uh(ue,ue.transform.height-(ge.top||0),3,kd),uh(ue,ge.bottom||0,3,$u),Fd(ue,ge.left||0,3,Up),Fd(ue,ue.transform.width-(ge.right||0),3,jp);let Ee=ue.transform.centerPoint;(function(tt,Xe,et,Se){Bd(tt,Xe-1,et-10,2,20,Se),Bd(tt,Xe-10,et-1,20,2,Se)})(ue,Ee.x,ue.transform.height-Ee.y,Od)}(this),this.context.setDefault()}maybeDrawDepthAndCoords(r){if(!this.style||!this.style.map||!this.style.map.terrain)return;let h=this.terrainFacilitator.matrix,x=this.transform.modelViewProjectionMatrix,w=this.terrainFacilitator.dirty;w||(w=r?!t.c7(h,x):!t.c8(h,x)),w||(w=this.style.map.terrain.sourceCache.anyTilesAfterTime(this.terrainFacilitator.renderTime)),w&&(t.c9(h,x),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(A,k){let j=A.context,q=j.gl,J=A.transform,ne=Cr.unblended,pe=new Tr(q.LEQUAL,Tr.ReadWrite,[0,1]),ue=k.sourceCache.getRenderableTiles(),ge=A.useProgram("terrainDepth");j.bindFramebuffer.set(k.getFramebuffer("depth").framebuffer),j.viewport.set([0,0,A.width/devicePixelRatio,A.height/devicePixelRatio]),j.clear({color:t.be.transparent,depth:1});for(let Ee of ue){let tt=k.getTerrainMesh(Ee.tileID),Xe=k.getTerrainData(Ee.tileID),et=J.getProjectionData({overscaledTileID:Ee.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0}),Se={u_ele_delta:k.getMeshFrameDelta(J.zoom)};ge.draw(j,q.TRIANGLES,pe,Fn.disabled,ne,or.backCCW,Se,Xe,et,"terrain",tt.vertexBuffer,tt.indexBuffer,tt.segments)}j.bindFramebuffer.set(null),j.viewport.set([0,0,A.width,A.height])}(this,this.style.map.terrain),function(A,k){let j=A.context,q=j.gl,J=A.transform,ne=Cr.unblended,pe=new Tr(q.LEQUAL,Tr.ReadWrite,[0,1]),ue=k.getCoordsTexture(),ge=k.sourceCache.getRenderableTiles(),Ee=A.useProgram("terrainCoords");j.bindFramebuffer.set(k.getFramebuffer("coords").framebuffer),j.viewport.set([0,0,A.width/devicePixelRatio,A.height/devicePixelRatio]),j.clear({color:t.be.transparent,depth:1}),k.coordsIndex=[];for(let tt of ge){let Xe=k.getTerrainMesh(tt.tileID),et=k.getTerrainData(tt.tileID);j.activeTexture.set(q.TEXTURE0),q.bindTexture(q.TEXTURE_2D,ue.texture);let Se={u_terrain_coords_id:(255-k.coordsIndex.length)/255,u_texture:0,u_ele_delta:k.getMeshFrameDelta(J.zoom)},Be=J.getProjectionData({overscaledTileID:tt.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});Ee.draw(j,q.TRIANGLES,pe,Fn.disabled,ne,or.backCCW,Se,et,Be,"terrain",Xe.vertexBuffer,Xe.indexBuffer,Xe.segments),k.coordsIndex.push(tt.tileID.key)}j.bindFramebuffer.set(null),j.viewport.set([0,0,A.width,A.height])}(this,this.style.map.terrain))}renderLayer(r,h,x,w,A){x.isHidden(this.transform.zoom)||(x.type==="background"||x.type==="custom"||(w||[]).length)&&(this.id=x.id,t.ca(x)?function(k,j,q,J,ne,pe){if(k.renderPass!=="translucent")return;let{isRenderingToTexture:ue}=pe,ge=Fn.disabled,Ee=k.colorModeForRenderPass();(q._unevaluatedLayout.hasValue("text-variable-anchor")||q._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&function(tt,Xe,et,Se,Be,ft,dt,xe,pt){let zt=Xe.transform,ei=Xe.style.map.terrain,Kt=Be==="map",Jt=ft==="map";for(let si of tt){let Xi=Se.getTile(si),Ki=Xi.getBucket(et);if(!Ki||!Ki.text||!Ki.text.segments.get().length)continue;let Pi=t.am(Ki.textSizeData,zt.zoom),yn=t.aB(Xi,1,Xe.transform.zoom),xr=fe(Kt,Xe.transform,yn),Kr=et.layout.get("icon-text-fit")!=="none"&&Ki.hasIconData();if(Pi){let Ho=Math.pow(2,zt.zoom-Xi.tileID.overscaledZ),Eo=ei?(Go,vo)=>ei.getElevation(si,Go,vo):null;Uf(Ki,Kt,Jt,pt,zt,xr,Ho,Pi,Kr,t.aC(zt,Xi,dt,xe),si.toUnwrapped(),Eo)}}}(J,k,q,j,q.layout.get("text-rotation-alignment"),q.layout.get("text-pitch-alignment"),q.paint.get("text-translate"),q.paint.get("text-translate-anchor"),ne),q.paint.get("icon-opacity").constantOr(1)!==0&&zd(k,j,q,J,!1,q.paint.get("icon-translate"),q.paint.get("icon-translate-anchor"),q.layout.get("icon-rotation-alignment"),q.layout.get("icon-pitch-alignment"),q.layout.get("icon-keep-upright"),ge,Ee,ue),q.paint.get("text-opacity").constantOr(1)!==0&&zd(k,j,q,J,!0,q.paint.get("text-translate"),q.paint.get("text-translate-anchor"),q.layout.get("text-rotation-alignment"),q.layout.get("text-pitch-alignment"),q.layout.get("text-keep-upright"),ge,Ee,ue),j.map.showCollisionBoxes&&(uo(k,j,q,J,!0),uo(k,j,q,J,!1))}(r,h,x,w,this.style.placement.variableOffsets,A):t.cb(x)?function(k,j,q,J,ne){if(k.renderPass!=="translucent")return;let{isRenderingToTexture:pe}=ne,ue=q.paint.get("circle-opacity"),ge=q.paint.get("circle-stroke-width"),Ee=q.paint.get("circle-stroke-opacity"),tt=!q.layout.get("circle-sort-key").isConstant();if(ue.constantOr(1)===0&&(ge.constantOr(1)===0||Ee.constantOr(1)===0))return;let Xe=k.context,et=Xe.gl,Se=k.transform,Be=k.getDepthModeForSublayer(0,Tr.ReadOnly),ft=Fn.disabled,dt=k.colorModeForRenderPass(),xe=[],pt=Se.getCircleRadiusCorrection();for(let zt=0;zt<J.length;zt++){let ei=J[zt],Kt=j.getTile(ei),Jt=Kt.getBucket(q);if(!Jt)continue;let si=q.paint.get("circle-translate"),Xi=q.paint.get("circle-translate-anchor"),Ki=t.aC(Se,Kt,si,Xi),Pi=Jt.programConfigurations.get(q.id),yn=k.useProgram("circle",Pi),xr=Jt.layoutVertexBuffer,Kr=Jt.indexBuffer,Ho=k.style.map.terrain&&k.style.map.terrain.getTerrainData(ei),Eo={programConfiguration:Pi,program:yn,layoutVertexBuffer:xr,indexBuffer:Kr,uniformValues:Rp(k,Kt,q,Ki,pt),terrainData:Ho,projectionData:Se.getProjectionData({overscaledTileID:ei,applyGlobeMatrix:!pe,applyTerrainMatrix:!0})};if(tt){let Go=Jt.segments.get();for(let vo of Go)xe.push({segments:new t.aL([vo]),sortKey:vo.sortKey,state:Eo})}else xe.push({segments:Jt.segments,sortKey:0,state:Eo})}tt&&xe.sort((zt,ei)=>zt.sortKey-ei.sortKey);for(let zt of xe){let{programConfiguration:ei,program:Kt,layoutVertexBuffer:Jt,indexBuffer:si,uniformValues:Xi,terrainData:Ki,projectionData:Pi}=zt.state;Kt.draw(Xe,et.TRIANGLES,Be,ft,dt,or.backCCW,Xi,Ki,Pi,q.id,Jt,si,zt.segments,q.paint,k.transform.zoom,ei)}}(r,h,x,w,A):t.cc(x)?function(k,j,q,J,ne){if(q.paint.get("heatmap-opacity")===0)return;let pe=k.context,{isRenderingToTexture:ue,isRenderingGlobe:ge}=ne;if(k.style.map.terrain){for(let Ee of J){let tt=j.getTile(Ee);j.hasRenderableParent(Ee)||(k.renderPass==="offscreen"?Ld(k,tt,q,Ee,ge):k.renderPass==="translucent"&&ju(k,q,Ee,ue,ge))}pe.viewport.set([0,0,k.width,k.height])}else k.renderPass==="offscreen"?function(Ee,tt,Xe,et){let Se=Ee.context,Be=Se.gl,ft=Ee.transform,dt=Fn.disabled,xe=new Cr([Be.ONE,Be.ONE],t.be.transparent,[!0,!0,!0,!0]);(function(pt,zt,ei){let Kt=pt.gl;pt.activeTexture.set(Kt.TEXTURE1),pt.viewport.set([0,0,zt.width/4,zt.height/4]);let Jt=ei.heatmapFbos.get(t.c1);Jt?(Kt.bindTexture(Kt.TEXTURE_2D,Jt.colorAttachment.get()),pt.bindFramebuffer.set(Jt.framebuffer)):(Jt=Fh(pt,zt.width/4,zt.height/4),ei.heatmapFbos.set(t.c1,Jt))})(Se,Ee,Xe),Se.clear({color:t.be.transparent});for(let pt=0;pt<et.length;pt++){let zt=et[pt];if(tt.hasRenderableParent(zt))continue;let ei=tt.getTile(zt),Kt=ei.getBucket(Xe);if(!Kt)continue;let Jt=Kt.programConfigurations.get(Xe.id),si=Ee.useProgram("heatmap",Jt),Xi=ft.getProjectionData({overscaledTileID:zt,applyGlobeMatrix:!0,applyTerrainMatrix:!1}),Ki=ft.getCircleRadiusCorrection();si.draw(Se,Be.TRIANGLES,Tr.disabled,dt,xe,or.backCCW,Tn(ei,ft.zoom,Xe.paint.get("heatmap-intensity"),Ki),null,Xi,Xe.id,Kt.layoutVertexBuffer,Kt.indexBuffer,Kt.segments,Xe.paint,ft.zoom,Jt)}Se.viewport.set([0,0,Ee.width,Ee.height])}(k,j,q,J):k.renderPass==="translucent"&&function(Ee,tt){let Xe=Ee.context,et=Xe.gl;Xe.setColorMode(Ee.colorModeForRenderPass());let Se=tt.heatmapFbos.get(t.c1);Se&&(Xe.activeTexture.set(et.TEXTURE0),et.bindTexture(et.TEXTURE_2D,Se.colorAttachment.get()),Xe.activeTexture.set(et.TEXTURE1),Gu(Xe,tt).bind(et.LINEAR,et.CLAMP_TO_EDGE),Ee.useProgram("heatmapTexture").draw(Xe,et.TRIANGLES,Tr.disabled,Fn.disabled,Ee.colorModeForRenderPass(),or.disabled,Li(Ee,tt,0,1),null,null,tt.id,Ee.viewportBuffer,Ee.quadTriangleIndexBuffer,Ee.viewportSegments,tt.paint,Ee.transform.zoom))}(k,q)}(r,h,x,w,A):t.cd(x)?function(k,j,q,J,ne){if(k.renderPass!=="translucent")return;let{isRenderingToTexture:pe}=ne,ue=q.paint.get("line-opacity"),ge=q.paint.get("line-width");if(ue.constantOr(1)===0||ge.constantOr(1)===0)return;let Ee=k.getDepthModeForSublayer(0,Tr.ReadOnly),tt=k.colorModeForRenderPass(),Xe=q.paint.get("line-dasharray"),et=q.paint.get("line-pattern"),Se=et.constantOr(1),Be=q.paint.get("line-gradient"),ft=q.getCrossfadeParameters(),dt=Se?"linePattern":Xe?"lineSDF":Be?"lineGradient":"line",xe=k.context,pt=xe.gl,zt=k.transform,ei=!0;for(let Kt of J){let Jt=j.getTile(Kt);if(Se&&!Jt.patternsLoaded())continue;let si=Jt.getBucket(q);if(!si)continue;let Xi=si.programConfigurations.get(q.id),Ki=k.context.program.get(),Pi=k.useProgram(dt,Xi),yn=ei||Pi.program!==Ki,xr=k.style.map.terrain&&k.style.map.terrain.getTerrainData(Kt),Kr=et.constantOr(null);if(Kr&&Jt.imageAtlas){let Yr=Jt.imageAtlas,Mo=Yr.patternPositions[Kr.to.toString()],ps=Yr.patternPositions[Kr.from.toString()];Mo&&ps&&Xi.setConstantPatternPositions(Mo,ps)}let Ho=zt.getProjectionData({overscaledTileID:Kt,applyGlobeMatrix:!pe,applyTerrainMatrix:!0}),Eo=zt.getPixelScale(),Go=Se?Ll(k,Jt,q,Eo,ft):Xe?lf(k,Jt,q,Eo,Xe,ft):Be?zp(k,Jt,q,Eo,si.lineClipsArray.length):ln(k,Jt,q,Eo);if(Se)xe.activeTexture.set(pt.TEXTURE0),Jt.imageAtlasTexture.bind(pt.LINEAR,pt.CLAMP_TO_EDGE),Xi.updatePaintBuffers(ft);else if(Xe&&(yn||k.lineAtlas.dirty))xe.activeTexture.set(pt.TEXTURE0),k.lineAtlas.bind(xe);else if(Be){let Yr=si.gradients[q.id],Mo=Yr.texture;if(q.gradientVersion!==Yr.version){let ps=256;if(q.stepInterpolant){let lr=j.getSource().maxzoom,aa=Kt.canonical.z===lr?Math.ceil(1<<k.transform.maxZoom-Kt.canonical.z):1;ps=t.ag(t.c2(si.maxLineLength/t.$*1024*aa),256,xe.maxTextureSize)}Yr.gradient=t.c3({expression:q.gradientExpression(),evaluationKey:"lineProgress",resolution:ps,image:Yr.gradient||void 0,clips:si.lineClipsArray}),Yr.texture?Yr.texture.update(Yr.gradient):Yr.texture=new t.T(xe,Yr.gradient,pt.RGBA),Yr.version=q.gradientVersion,Mo=Yr.texture}xe.activeTexture.set(pt.TEXTURE0),Mo.bind(q.stepInterpolant?pt.NEAREST:pt.LINEAR,pt.CLAMP_TO_EDGE)}let vo=k.stencilModeForClipping(Kt);Pi.draw(xe,pt.TRIANGLES,Ee,vo,tt,or.disabled,Go,xr,Ho,q.id,si.layoutVertexBuffer,si.indexBuffer,si.segments,q.paint,k.transform.zoom,Xi,si.layoutVertexBuffer2),ei=!1}}(r,h,x,w,A):t.ce(x)?function(k,j,q,J,ne){let pe=q.paint.get("fill-color"),ue=q.paint.get("fill-opacity");if(ue.constantOr(1)===0)return;let{isRenderingToTexture:ge}=ne,Ee=k.colorModeForRenderPass(),tt=q.paint.get("fill-pattern"),Xe=k.opaquePassEnabledForLayer()&&!tt.constantOr(1)&&pe.constantOr(t.be.transparent).a===1&&ue.constantOr(0)===1?"opaque":"translucent";if(k.renderPass===Xe){let et=k.getDepthModeForSublayer(1,k.renderPass==="opaque"?Tr.ReadWrite:Tr.ReadOnly);fu(k,j,q,J,et,Ee,!1,ge)}if(k.renderPass==="translucent"&&q.paint.get("fill-antialias")){let et=k.getDepthModeForSublayer(q.getPaintProperty("fill-outline-color")?2:0,Tr.ReadOnly);fu(k,j,q,J,et,Ee,!0,ge)}}(r,h,x,w,A):t.cf(x)?function(k,j,q,J,ne){let pe=q.paint.get("fill-extrusion-opacity");if(pe===0)return;let{isRenderingToTexture:ue}=ne;if(k.renderPass==="translucent"){let ge=new Tr(k.context.gl.LEQUAL,Tr.ReadWrite,k.depthRangeFor3D);if(pe!==1||q.paint.get("fill-extrusion-pattern").constantOr(1))mu(k,j,q,J,ge,Fn.disabled,Cr.disabled,ue),mu(k,j,q,J,ge,k.stencilModeFor3D(),k.colorModeForRenderPass(),ue);else{let Ee=k.colorModeForRenderPass();mu(k,j,q,J,ge,Fn.disabled,Ee,ue)}}}(r,h,x,w,A):t.cg(x)?function(k,j,q,J,ne){if(k.renderPass!=="offscreen"&&k.renderPass!=="translucent")return;let{isRenderingToTexture:pe}=ne,ue=k.context,ge=k.style.projection.useSubdivision,Ee=k.getDepthModeForSublayer(0,Tr.ReadOnly),tt=k.colorModeForRenderPass();if(k.renderPass==="offscreen")(function(Xe,et,Se,Be,ft,dt,xe){let pt=Xe.context,zt=pt.gl;for(let ei of Se){let Kt=et.getTile(ei),Jt=Kt.dem;if(!Jt||!Jt.data||!Kt.needsHillshadePrepare)continue;let si=Jt.dim,Xi=Jt.stride,Ki=Jt.getPixels();if(pt.activeTexture.set(zt.TEXTURE1),pt.pixelStoreUnpackPremultiplyAlpha.set(!1),Kt.demTexture=Kt.demTexture||Xe.getTileTexture(Xi),Kt.demTexture){let yn=Kt.demTexture;yn.update(Ki,{premultiply:!1}),yn.bind(zt.NEAREST,zt.CLAMP_TO_EDGE)}else Kt.demTexture=new t.T(pt,Ki,zt.RGBA,{premultiply:!1}),Kt.demTexture.bind(zt.NEAREST,zt.CLAMP_TO_EDGE);pt.activeTexture.set(zt.TEXTURE0);let Pi=Kt.fbo;if(!Pi){let yn=new t.T(pt,{width:si,height:si,data:null},zt.RGBA);yn.bind(zt.LINEAR,zt.CLAMP_TO_EDGE),Pi=Kt.fbo=pt.createFramebuffer(si,si,!0,!1),Pi.colorAttachment.set(yn.texture)}pt.bindFramebuffer.set(Pi.framebuffer),pt.viewport.set([0,0,si,si]),Xe.useProgram("hillshadePrepare").draw(pt,zt.TRIANGLES,ft,dt,xe,or.disabled,hn(Kt.tileID,Jt),null,null,Be.id,Xe.rasterBoundsBuffer,Xe.quadTriangleIndexBuffer,Xe.rasterBoundsSegments),Kt.needsHillshadePrepare=!1}})(k,j,J,q,Ee,Fn.disabled,tt),ue.viewport.set([0,0,k.width,k.height]);else if(k.renderPass==="translucent")if(ge){let[Xe,et,Se]=k.stencilConfigForOverlapTwoPass(J);sc(k,j,q,Se,Xe,Ee,tt,!1,pe),sc(k,j,q,Se,et,Ee,tt,!0,pe)}else{let[Xe,et]=k.getStencilConfigForOverlapAndUpdateStencilID(J);sc(k,j,q,et,Xe,Ee,tt,!1,pe)}}(r,h,x,w,A):t.ch(x)?function(k,j,q,J,ne){if(k.renderPass!=="translucent"||!J.length)return;let{isRenderingToTexture:pe}=ne,ue=k.style.projection.useSubdivision,ge=k.getDepthModeForSublayer(0,Tr.ReadOnly),Ee=k.colorModeForRenderPass();if(ue){let[tt,Xe,et]=k.stencilConfigForOverlapTwoPass(J);hh(k,j,q,et,tt,ge,Ee,!1,pe),hh(k,j,q,et,Xe,ge,Ee,!0,pe)}else{let[tt,Xe]=k.getStencilConfigForOverlapAndUpdateStencilID(J);hh(k,j,q,Xe,tt,ge,Ee,!1,pe)}}(r,h,x,w,A):t.ci(x)?function(k,j,q,J,ne){if(k.renderPass!=="translucent"||q.paint.get("raster-opacity")===0||!J.length)return;let{isRenderingToTexture:pe}=ne,ue=j.getSource(),ge=k.style.projection.useSubdivision;if(ue instanceof Vo)ac(k,j,q,J,null,!1,!1,ue.tileCoords,ue.flippedWindingOrder,pe);else if(ge){let[Ee,tt,Xe]=k.stencilConfigForOverlapTwoPass(J);ac(k,j,q,Xe,Ee,!1,!0,Zu,!1,pe),ac(k,j,q,Xe,tt,!0,!0,Zu,!1,pe)}else{let[Ee,tt]=k.getStencilConfigForOverlapAndUpdateStencilID(J);ac(k,j,q,tt,Ee,!1,!0,Zu,!1,pe)}}(r,h,x,w,A):t.cj(x)?function(k,j,q,J,ne){let pe=q.paint.get("background-color"),ue=q.paint.get("background-opacity");if(ue===0)return;let{isRenderingToTexture:ge}=ne,Ee=k.context,tt=Ee.gl,Xe=k.style.projection,et=k.transform,Se=et.tileSize,Be=q.paint.get("background-pattern");if(k.isPatternMissing(Be))return;let ft=!Be&&pe.a===1&&ue===1&&k.opaquePassEnabledForLayer()?"opaque":"translucent";if(k.renderPass!==ft)return;let dt=Fn.disabled,xe=k.getDepthModeForSublayer(0,ft==="opaque"?Tr.ReadWrite:Tr.ReadOnly),pt=k.colorModeForRenderPass(),zt=k.useProgram(Be?"backgroundPattern":"background"),ei=J||li(et,{tileSize:Se,terrain:k.style.map.terrain});Be&&(Ee.activeTexture.set(tt.TEXTURE0),k.imageManager.bind(k.context));let Kt=q.getCrossfadeParameters();for(let Jt of ei){let si=et.getProjectionData({overscaledTileID:Jt,applyGlobeMatrix:!ge,applyTerrainMatrix:!0}),Xi=Be?Pd(ue,k,Be,{tileID:Jt,tileSize:Se},Kt):Js(ue,pe),Ki=k.style.map.terrain&&k.style.map.terrain.getTerrainData(Jt),Pi=Xe.getMeshFromTileID(Ee,Jt.canonical,!1,!0,"raster");zt.draw(Ee,tt.TRIANGLES,xe,dt,pt,or.backCCW,Xi,Ki,si,q.id,Pi.vertexBuffer,Pi.indexBuffer,Pi.segments)}}(r,0,x,w,A):t.ck(x)&&function(k,j,q,J){let{isRenderingGlobe:ne}=J,pe=k.context,ue=q.implementation,ge=k.style.projection,Ee=k.transform,tt=Ee.getProjectionDataForCustomLayer(ne),Xe={farZ:Ee.farZ,nearZ:Ee.nearZ,fov:Ee.fov*Math.PI/180,modelViewProjectionMatrix:Ee.modelViewProjectionMatrix,projectionMatrix:Ee.projectionMatrix,shaderData:{variantName:ge.shaderVariantName,vertexShaderPrelude:`const float PI = 3.141592653589793;
uniform mat4 u_projection_matrix;
${ge.shaderPreludeCode.vertexSource}`,define:ge.shaderDefine},defaultProjectionData:tt},et=ue.renderingMode?ue.renderingMode:"2d";if(k.renderPass==="offscreen"){let Se=ue.prerender;Se&&(k.setCustomLayerDefaults(),pe.setColorMode(k.colorModeForRenderPass()),Se.call(ue,pe.gl,Xe),pe.setDirty(),k.setBaseState())}else if(k.renderPass==="translucent"){k.setCustomLayerDefaults(),pe.setColorMode(k.colorModeForRenderPass()),pe.setStencilMode(Fn.disabled);let Se=et==="3d"?k.getDepthModeFor3D():k.getDepthModeForSublayer(0,Tr.ReadOnly);pe.setDepthMode(Se),ue.render(pe.gl,Xe),pe.setDirty(),k.setBaseState(),pe.bindFramebuffer.set(null)}}(r,0,x,A))}saveTileTexture(r){let h=this._tileTextures[r.size[0]];h?h.push(r):this._tileTextures[r.size[0]]=[r]}getTileTexture(r){let h=this._tileTextures[r];return h&&h.length>0?h.pop():null}isPatternMissing(r){if(!r)return!1;if(!r.from||!r.to)return!0;let h=this.imageManager.getPattern(r.from.toString()),x=this.imageManager.getPattern(r.to.toString());return!h||!x}useProgram(r,h,x=!1,w=[]){this.cache=this.cache||{};let A=!!this.style.map.terrain,k=this.style.projection,j=x?Ms.projectionMercator:k.shaderPreludeCode,q=x?tc:k.shaderDefine,J=r+(h?h.cacheKey:"")+`/${x?Id:k.shaderVariantName}`+(this._showOverdrawInspector?"/overdraw":"")+(A?"/terrain":"")+(w?`/${w.join("/")}`:"");return this.cache[J]||(this.cache[J]=new ku(this.context,Ms[r],h,Of[r],this._showOverdrawInspector,A,j,q,w)),this.cache[J]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){let r=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(r.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new t.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}overLimit(){let{drawingBufferWidth:r,drawingBufferHeight:h}=this.context.gl;return this.width!==r||this.height!==h}}function Wu(M,r){let h,x=!1,w=null,A=null,k=()=>{w=null,x&&(M.apply(A,h),w=setTimeout(k,r),x=!1)};return(...j)=>(x=!0,A=this,h=j,w||k(),w)}class Nd{constructor(r){this._getCurrentHash=()=>{let h=window.location.hash.replace("#","");if(this._hashName){let x;return h.split("&").map(w=>w.split("=")).forEach(w=>{w[0]===this._hashName&&(x=w)}),(x&&x[1]||"").split("/")}return h.split("/")},this._onHashChange=()=>{let h=this._getCurrentHash();if(!this._isValidHash(h))return!1;let x=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(h[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+h[2],+h[1]],zoom:+h[0],bearing:x,pitch:+(h[4]||0)}),!0},this._updateHashUnthrottled=()=>{let h=window.location.href.replace(/(#.*)?$/,this.getHashString());window.history.replaceState(window.history.state,null,h)},this._removeHash=()=>{let h=this._getCurrentHash();if(h.length===0)return;let x=h.join("/"),w=x;w.split("&").length>0&&(w=w.split("&")[0]),this._hashName&&(w=`${this._hashName}=${x}`);let A=window.location.hash.replace(w,"");A.startsWith("#&")?A=A.slice(0,1)+A.slice(2):A==="#"&&(A="");let k=window.location.href.replace(/(#.+)?$/,A);k=k.replace("&&","&"),window.history.replaceState(window.history.state,null,k)},this._updateHash=Wu(this._updateHashUnthrottled,300),this._hashName=r&&encodeURIComponent(r)}addTo(r){return this._map=r,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),this._removeHash(),delete this._map,this}getHashString(r){let h=this._map.getCenter(),x=Math.round(100*this._map.getZoom())/100,w=Math.ceil((x*Math.LN2+Math.log(512/360/.5))/Math.LN10),A=Math.pow(10,w),k=Math.round(h.lng*A)/A,j=Math.round(h.lat*A)/A,q=this._map.getBearing(),J=this._map.getPitch(),ne="";if(ne+=r?`/${k}/${j}/${x}`:`${x}/${j}/${k}`,(q||J)&&(ne+="/"+Math.round(10*q)/10),J&&(ne+=`/${Math.round(J)}`),this._hashName){let pe=this._hashName,ue=!1,ge=window.location.hash.slice(1).split("&").map(Ee=>{let tt=Ee.split("=")[0];return tt===pe?(ue=!0,`${tt}=${ne}`):Ee}).filter(Ee=>Ee);return ue||ge.push(`${pe}=${ne}`),`#${ge.join("&")}`}return`#${ne}`}_isValidHash(r){if(r.length<3||r.some(isNaN))return!1;try{new t.S(+r[2],+r[1])}catch{return!1}let h=+r[0],x=+(r[3]||0),w=+(r[4]||0);return h>=this._map.getMinZoom()&&h<=this._map.getMaxZoom()&&x>=-180&&x<=180&&w>=this._map.getMinPitch()&&w<=this._map.getMaxPitch()}}let ph={linearity:.3,easing:t.cl(0,0,.3,1)},Bh=t.e({deceleration:2500,maxSpeed:1400},ph),Vd=t.e({deceleration:20,maxSpeed:1400},ph),_u=t.e({deceleration:1e3,maxSpeed:360},ph),Ud=t.e({deceleration:1e3,maxSpeed:90},ph),Gp=t.e({deceleration:1e3,maxSpeed:360},ph);class gu{constructor(r){this._map=r,this.clear()}clear(){this._inertiaBuffer=[]}record(r){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:an.now(),settings:r})}_drainInertiaBuffer(){let r=this._inertiaBuffer,h=an.now();for(;r.length>0&&h-r[0].time>160;)r.shift()}_onMoveEnd(r){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;let h={zoom:0,bearing:0,pitch:0,roll:0,pan:new t.P(0,0),pinchAround:void 0,around:void 0};for(let{settings:A}of this._inertiaBuffer)h.zoom+=A.zoomDelta||0,h.bearing+=A.bearingDelta||0,h.pitch+=A.pitchDelta||0,h.roll+=A.rollDelta||0,A.panDelta&&h.pan._add(A.panDelta),A.around&&(h.around=A.around),A.pinchAround&&(h.pinchAround=A.pinchAround);let x=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,w={};if(h.pan.mag()){let A=cc(h.pan.mag(),x,t.e({},Bh,r||{})),k=h.pan.mult(A.amount/h.pan.mag()),j=this._map.cameraHelper.handlePanInertia(k,this._map.transform);w.center=j.easingCenter,w.offset=j.easingOffset,lc(w,A)}if(h.zoom){let A=cc(h.zoom,x,Vd);w.zoom=this._map.transform.zoom+A.amount,lc(w,A)}if(h.bearing){let A=cc(h.bearing,x,_u);w.bearing=this._map.transform.bearing+t.ag(A.amount,-179,179),lc(w,A)}if(h.pitch){let A=cc(h.pitch,x,Ud);w.pitch=this._map.transform.pitch+A.amount,lc(w,A)}if(h.roll){let A=cc(h.roll,x,Gp);w.roll=this._map.transform.roll+t.ag(A.amount,-179,179),lc(w,A)}if(w.zoom||w.bearing){let A=h.pinchAround===void 0?h.around:h.pinchAround;w.around=A?this._map.unproject(A):this._map.getCenter()}return this.clear(),t.e(w,{noMoveStart:!0})}}function lc(M,r){(!M.duration||M.duration<r.duration)&&(M.duration=r.duration,M.easing=r.easing)}function cc(M,r,h){let{maxSpeed:x,linearity:w,deceleration:A}=h,k=t.ag(M*w/(r/1e3),-x,x),j=Math.abs(k)/(A*w);return{easing:h.easing,duration:1e3*j,amount:k*(j/2)}}class Ja extends t.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(r,h,x,w={}){x=x instanceof MouseEvent?x:new MouseEvent(r,x);let A=Dt.mousePos(h.getCanvas(),x),k=h.unproject(A);super(r,t.e({point:A,lngLat:k,originalEvent:x},w)),this._defaultPrevented=!1,this.target=h}}class es extends t.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(r,h,x){let w=r==="touchend"?x.changedTouches:x.touches,A=Dt.touchPos(h.getCanvasContainer(),w),k=A.map(q=>h.unproject(q)),j=A.reduce((q,J,ne,pe)=>q.add(J.div(pe.length)),new t.P(0,0));super(r,{points:A,point:j,lngLats:k,lngLat:h.unproject(j),originalEvent:x}),this._defaultPrevented=!1}}class yu extends t.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(r,h,x){super(r,{originalEvent:x}),this._defaultPrevented=!1}}class jd{constructor(r,h){this._map=r,this._clickTolerance=h.clickTolerance}reset(){delete this._mousedownPos}wheel(r){return this._firePreventable(new yu(r.type,this._map,r))}mousedown(r,h){return this._mousedownPos=h,this._firePreventable(new Ja(r.type,this._map,r))}mouseup(r){this._map.fire(new Ja(r.type,this._map,r))}click(r,h){this._mousedownPos&&this._mousedownPos.dist(h)>=this._clickTolerance||this._map.fire(new Ja(r.type,this._map,r))}dblclick(r){return this._firePreventable(new Ja(r.type,this._map,r))}mouseover(r){this._map.fire(new Ja(r.type,this._map,r))}mouseout(r){this._map.fire(new Ja(r.type,this._map,r))}touchstart(r){return this._firePreventable(new es(r.type,this._map,r))}touchmove(r){this._map.fire(new es(r.type,this._map,r))}touchend(r){this._map.fire(new es(r.type,this._map,r))}touchcancel(r){this._map.fire(new es(r.type,this._map,r))}_firePreventable(r){if(this._map.fire(r),r.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Gd{constructor(r){this._map=r}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(r){this._map.fire(new Ja(r.type,this._map,r))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Ja("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(r){this._delayContextMenu?this._contextMenuEvent=r:this._ignoreContextMenu||this._map.fire(new Ja(r.type,this._map,r)),this._map.listens("contextmenu")&&r.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class fh{constructor(r){this._map=r}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(r){return this.transform.screenPointToLocation(t.P.convert(r),this._map.terrain)}}class Hu{constructor(r,h){this._map=r,this._tr=new fh(r),this._el=r.getCanvasContainer(),this._container=r.getContainer(),this._clickTolerance=h.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(r,h){this.isEnabled()&&r.shiftKey&&r.button===0&&(Dt.disableDrag(),this._startPos=this._lastPos=h,this._active=!0)}mousemoveWindow(r,h){if(!this._active)return;let x=h;if(this._lastPos.equals(x)||!this._box&&x.dist(this._startPos)<this._clickTolerance)return;let w=this._startPos;this._lastPos=x,this._box||(this._box=Dt.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",r));let A=Math.min(w.x,x.x),k=Math.max(w.x,x.x),j=Math.min(w.y,x.y),q=Math.max(w.y,x.y);Dt.setTransform(this._box,`translate(${A}px,${j}px)`),this._box.style.width=k-A+"px",this._box.style.height=q-j+"px"}mouseupWindow(r,h){if(!this._active||r.button!==0)return;let x=this._startPos,w=h;if(this.reset(),Dt.suppressClick(),x.x!==w.x||x.y!==w.y)return this._map.fire(new t.l("boxzoomend",{originalEvent:r})),{cameraAnimation:A=>A.fitScreenCoordinates(x,w,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",r)}keydown(r){this._active&&r.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",r))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(Dt.remove(this._box),this._box=null),Dt.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(r,h){return this._map.fire(new t.l(r,{originalEvent:h}))}}function Xu(M,r){if(M.length!==r.length)throw new Error(`The number of touches and points are not equal - touches ${M.length}, points ${r.length}`);let h={};for(let x=0;x<M.length;x++)h[M[x].identifier]=r[x];return h}class Zd{constructor(r){this.reset(),this.numTouches=r.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(r,h,x){(this.centroid||x.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=r.timeStamp),x.length===this.numTouches&&(this.centroid=function(w){let A=new t.P(0,0);for(let k of w)A._add(k);return A.div(w.length)}(h),this.touches=Xu(x,h)))}touchmove(r,h,x){if(this.aborted||!this.centroid)return;let w=Xu(x,h);for(let A in this.touches){let k=w[A];(!k||k.dist(this.touches[A])>30)&&(this.aborted=!0)}}touchend(r,h,x){if((!this.centroid||r.timeStamp-this.startTime>500)&&(this.aborted=!0),x.length===0){let w=!this.aborted&&this.centroid;if(this.reset(),w)return w}}}class Ku{constructor(r){this.singleTap=new Zd(r),this.numTaps=r.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(r,h,x){this.singleTap.touchstart(r,h,x)}touchmove(r,h,x){this.singleTap.touchmove(r,h,x)}touchend(r,h,x){let w=this.singleTap.touchend(r,h,x);if(w){let A=r.timeStamp-this.lastTime<500,k=!this.lastTap||this.lastTap.dist(w)<30;if(A&&k||this.reset(),this.count++,this.lastTime=r.timeStamp,this.lastTap=w,this.count===this.numTaps)return this.reset(),w}}}class xu{constructor(r){this._tr=new fh(r),this._zoomIn=new Ku({numTouches:1,numTaps:2}),this._zoomOut=new Ku({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(r,h,x){this._zoomIn.touchstart(r,h,x),this._zoomOut.touchstart(r,h,x)}touchmove(r,h,x){this._zoomIn.touchmove(r,h,x),this._zoomOut.touchmove(r,h,x)}touchend(r,h,x){let w=this._zoomIn.touchend(r,h,x),A=this._zoomOut.touchend(r,h,x),k=this._tr;return w?(this._active=!0,r.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:j=>j.easeTo({duration:300,zoom:k.zoom+1,around:k.unproject(w)},{originalEvent:r})}):A?(this._active=!0,r.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:j=>j.easeTo({duration:300,zoom:k.zoom-1,around:k.unproject(A)},{originalEvent:r})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Mc{constructor(r){this._enabled=!!r.enable,this._moveStateManager=r.moveStateManager,this._clickTolerance=r.clickTolerance||1,this._moveFunction=r.move,this._activateOnStart=!!r.activateOnStart,r.assignEvents(this),this.reset()}reset(r){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(r)}_move(...r){let h=this._moveFunction(...r);if(h.bearingDelta||h.pitchDelta||h.rollDelta||h.around||h.panDelta)return this._active=!0,h}dragStart(r,h){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(r)&&(this._moveStateManager.startMove(r),this._lastPoint=Array.isArray(h)?h[0]:h,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(r,h){if(!this.isEnabled())return;let x=this._lastPoint;if(!x)return;if(r.preventDefault(),!this._moveStateManager.isValidMoveEvent(r))return void this.reset(r);let w=Array.isArray(h)?h[0]:h;return!this._moved&&w.dist(x)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=w,this._move(x,w))}dragEnd(r){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(r)&&(this._moved&&Dt.suppressClick(),this.reset(r))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}let Oa=0,Vl=2,Nh={[Oa]:1,[Vl]:2};class Qa{constructor(r){this._correctEvent=r.checkCorrectEvent}startMove(r){let h=Dt.mouseButton(r);this._eventButton=h}endMove(r){delete this._eventButton}isValidStartEvent(r){return this._correctEvent(r)}isValidMoveEvent(r){return!function(h,x){let w=Nh[x];return h.buttons===void 0||(h.buttons&w)!==w}(r,this._eventButton)}isValidEndEvent(r){return Dt.mouseButton(r)===this._eventButton}}class Yu{constructor(){this._firstTouch=void 0}_isOneFingerTouch(r){return r.targetTouches.length===1}_isSameTouchEvent(r){return r.targetTouches[0].identifier===this._firstTouch}startMove(r){this._firstTouch=r.targetTouches[0].identifier}endMove(r){delete this._firstTouch}isValidStartEvent(r){return this._isOneFingerTouch(r)}isValidMoveEvent(r){return this._isOneFingerTouch(r)&&this._isSameTouchEvent(r)}isValidEndEvent(r){return this._isOneFingerTouch(r)&&this._isSameTouchEvent(r)}}class Gf{constructor(r=new Qa({checkCorrectEvent:()=>!0}),h=new Yu){this.mouseMoveStateManager=r,this.oneFingerTouchMoveStateManager=h}_executeRelevantHandler(r,h,x){return r instanceof MouseEvent?h(r):typeof TouchEvent<"u"&&r instanceof TouchEvent?x(r):void 0}startMove(r){this._executeRelevantHandler(r,h=>this.mouseMoveStateManager.startMove(h),h=>this.oneFingerTouchMoveStateManager.startMove(h))}endMove(r){this._executeRelevantHandler(r,h=>this.mouseMoveStateManager.endMove(h),h=>this.oneFingerTouchMoveStateManager.endMove(h))}isValidStartEvent(r){return this._executeRelevantHandler(r,h=>this.mouseMoveStateManager.isValidStartEvent(h),h=>this.oneFingerTouchMoveStateManager.isValidStartEvent(h))}isValidMoveEvent(r){return this._executeRelevantHandler(r,h=>this.mouseMoveStateManager.isValidMoveEvent(h),h=>this.oneFingerTouchMoveStateManager.isValidMoveEvent(h))}isValidEndEvent(r){return this._executeRelevantHandler(r,h=>this.mouseMoveStateManager.isValidEndEvent(h),h=>this.oneFingerTouchMoveStateManager.isValidEndEvent(h))}}let qd=M=>{M.mousedown=M.dragStart,M.mousemoveWindow=M.dragMove,M.mouseup=M.dragEnd,M.contextmenu=r=>{r.preventDefault()}};class Mm{constructor(r,h){this._clickTolerance=r.clickTolerance||1,this._map=h,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new t.P(0,0)}_shouldBePrevented(r){return r<(this._map.cooperativeGestures.isEnabled()?2:1)}touchstart(r,h,x){return this._calculateTransform(r,h,x)}touchmove(r,h,x){if(this._active){if(!this._shouldBePrevented(x.length))return r.preventDefault(),this._calculateTransform(r,h,x);this._map.cooperativeGestures.notifyGestureBlocked("touch_pan",r)}}touchend(r,h,x){this._calculateTransform(r,h,x),this._active&&this._shouldBePrevented(x.length)&&this.reset()}touchcancel(){this.reset()}_calculateTransform(r,h,x){x.length>0&&(this._active=!0);let w=Xu(x,h),A=new t.P(0,0),k=new t.P(0,0),j=0;for(let J in w){let ne=w[J],pe=this._touches[J];pe&&(A._add(ne),k._add(ne.sub(pe)),j++,w[J]=ne)}if(this._touches=w,this._shouldBePrevented(j)||!k.mag())return;let q=k.div(j);return this._sum._add(q),this._sum.mag()<this._clickTolerance?void 0:{around:A.div(j),panDelta:q}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class df{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(r,h,x){this._firstTwoTouches||x.length<2||(this._firstTwoTouches=[x[0].identifier,x[1].identifier],this._start([h[0],h[1]]))}touchmove(r,h,x){if(!this._firstTwoTouches)return;r.preventDefault();let[w,A]=this._firstTwoTouches,k=vu(x,h,w),j=vu(x,h,A);if(!k||!j)return;let q=this._aroundCenter?null:k.add(j).div(2);return this._move([k,j],q,r)}touchend(r,h,x){if(!this._firstTwoTouches)return;let[w,A]=this._firstTwoTouches,k=vu(x,h,w),j=vu(x,h,A);k&&j||(this._active&&Dt.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(r){this._enabled=!0,this._aroundCenter=!!r&&r.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function vu(M,r,h){for(let x=0;x<M.length;x++)if(M[x].identifier===h)return r[x]}function Pc(M,r){return Math.log(M/r)/Math.LN2}class hc extends df{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(r){this._startDistance=this._distance=r[0].dist(r[1])}_move(r,h){let x=this._distance;if(this._distance=r[0].dist(r[1]),this._active||!(Math.abs(Pc(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Pc(this._distance,x),pinchAround:h}}}function sn(M,r){return 180*M.angleWith(r)/Math.PI}class Zp extends df{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(r){this._startVector=this._vector=r[0].sub(r[1]),this._minDiameter=r[0].dist(r[1])}_move(r,h,x){let w=this._vector;if(this._vector=r[0].sub(r[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:sn(this._vector,w),pinchAround:h}}_isBelowThreshold(r){this._minDiameter=Math.min(this._minDiameter,r.mag());let h=25/(Math.PI*this._minDiameter)*360,x=sn(r,this._startVector);return Math.abs(x)<h}}function Ju(M){return Math.abs(M.y)>Math.abs(M.x)}class $d extends df{constructor(r){super(),this._currentTouchCount=0,this._map=r}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(r,h,x){super.touchstart(r,h,x),this._currentTouchCount=x.length}_start(r){this._lastPoints=r,Ju(r[0].sub(r[1]))&&(this._valid=!1)}_move(r,h,x){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;let w=r[0].sub(this._lastPoints[0]),A=r[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(w,A,x.timeStamp),this._valid?(this._lastPoints=r,this._active=!0,{pitchDelta:(w.y+A.y)/2*-.5}):void 0}gestureBeginsVertically(r,h,x){if(this._valid!==void 0)return this._valid;let w=r.mag()>=2,A=h.mag()>=2;if(!w&&!A)return;if(!w||!A)return this._firstMove===void 0&&(this._firstMove=x),x-this._firstMove<100&&void 0;let k=r.y>0==h.y>0;return Ju(r)&&Ju(h)&&k}}let Vh={panStep:100,bearingStep:15,pitchStep:10};class gl{constructor(r){this._tr=new fh(r);let h=Vh;this._panStep=h.panStep,this._bearingStep=h.bearingStep,this._pitchStep=h.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(r){if(r.altKey||r.ctrlKey||r.metaKey)return;let h=0,x=0,w=0,A=0,k=0;switch(r.keyCode){case 61:case 107:case 171:case 187:h=1;break;case 189:case 109:case 173:h=-1;break;case 37:r.shiftKey?x=-1:(r.preventDefault(),A=-1);break;case 39:r.shiftKey?x=1:(r.preventDefault(),A=1);break;case 38:r.shiftKey?w=1:(r.preventDefault(),k=-1);break;case 40:r.shiftKey?w=-1:(r.preventDefault(),k=1);break;default:return}return this._rotationDisabled&&(x=0,w=0),{cameraAnimation:j=>{let q=this._tr;j.easeTo({duration:300,easeId:"keyboardHandler",easing:qp,zoom:h?Math.round(q.zoom)+h*(r.shiftKey?2:1):q.zoom,bearing:q.bearing+x*this._bearingStep,pitch:q.pitch+w*this._pitchStep,offset:[-A*this._panStep,-k*this._panStep],center:q.center},{originalEvent:r})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function qp(M){return M*(2-M)}let ar=4.000244140625,Wd=1/450;class Hd{constructor(r,h){this._onTimeout=x=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(x)},this._map=r,this._tr=new fh(r),this._triggerRenderFrame=h,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Wd}setZoomRate(r){this._defaultZoomRate=r}setWheelZoomRate(r){this._wheelZoomRate=r}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(r){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!r&&r.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}_shouldBePrevented(r){return!!this._map.cooperativeGestures.isEnabled()&&!(r.ctrlKey||this._map.cooperativeGestures.isBypassed(r))}wheel(r){if(!this.isEnabled())return;if(this._shouldBePrevented(r))return void this._map.cooperativeGestures.notifyGestureBlocked("wheel_zoom",r);let h=r.deltaMode===WheelEvent.DOM_DELTA_LINE?40*r.deltaY:r.deltaY,x=an.now(),w=x-(this._lastWheelEventTime||0);this._lastWheelEventTime=x,h!==0&&h%ar==0?this._type="wheel":h!==0&&Math.abs(h)<4?this._type="trackpad":w>400?(this._type=null,this._lastValue=h,this._timeout=setTimeout(this._onTimeout,40,r)):this._type||(this._type=Math.abs(w*h)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,h+=this._lastValue)),r.shiftKey&&h&&(h/=4),this._type&&(this._lastWheelEvent=r,this._delta-=h,this._active||this._start(r)),r.preventDefault()}_start(r){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);let h=Dt.mousePos(this._map.getCanvas(),r),x=this._tr;this._aroundPoint=this._aroundCenter?x.transform.locationToScreenPoint(t.S.convert(x.center)):h,this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;let r=this._tr.transform;if(typeof this._lastExpectedZoom=="number"){let j=r.zoom-this._lastExpectedZoom;typeof this._startZoom=="number"&&(this._startZoom+=j),typeof this._targetZoom=="number"&&(this._targetZoom+=j)}if(this._delta!==0){let j=this._type==="wheel"&&Math.abs(this._delta)>ar?this._wheelZoomRate:this._defaultZoomRate,q=2/(1+Math.exp(-Math.abs(this._delta*j)));this._delta<0&&q!==0&&(q=1/q);let J=typeof this._targetZoom!="number"?r.scale:t.ae(this._targetZoom);this._targetZoom=r.getConstrained(r.getCameraLngLat(),t.aj(J*q)).zoom,this._type==="wheel"&&(this._startZoom=r.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}let h=typeof this._targetZoom!="number"?r.zoom:this._targetZoom,x=this._startZoom,w=this._easing,A,k=!1;if(this._type==="wheel"&&x&&w){let j=an.now()-this._lastWheelEventTime,q=Math.min((j+5)/200,1),J=w(q);A=t.C.number(x,h,J),q<1?this._frameId||(this._frameId=!0):k=!0}else A=h,k=!0;return this._active=!0,k&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._lastExpectedZoom,delete this._finishTimeout},200)),this._lastExpectedZoom=A,{noInertia:!0,needsRenderFrame:!k,zoomDelta:A-r.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(r){let h=t.cn;if(this._prevEase){let x=this._prevEase,w=(an.now()-x.start)/x.duration,A=x.easing(w+.01)-x.easing(w),k=.27/Math.sqrt(A*A+1e-4)*.01,j=Math.sqrt(.0729-k*k);h=t.cl(k,j,.25,1)}return this._prevEase={start:an.now(),duration:r,easing:h},h}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,delete this._lastExpectedZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class Xd{constructor(r,h){this._clickZoom=r,this._tapZoom=h}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class pf{constructor(r){this._tr=new fh(r),this.reset()}reset(){this._active=!1}dblclick(r,h){return r.preventDefault(),{cameraAnimation:x=>{x.easeTo({duration:300,zoom:this._tr.zoom+(r.shiftKey?-1:1),around:this._tr.unproject(h)},{originalEvent:r})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class $p{constructor(){this._tap=new Ku({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(r,h,x){if(!this._swipePoint)if(this._tapTime){let w=h[0],A=r.timeStamp-this._tapTime<500,k=this._tapPoint.dist(w)<30;A&&k?x.length>0&&(this._swipePoint=w,this._swipeTouch=x[0].identifier):this.reset()}else this._tap.touchstart(r,h,x)}touchmove(r,h,x){if(this._tapTime){if(this._swipePoint){if(x[0].identifier!==this._swipeTouch)return;let w=h[0],A=w.y-this._swipePoint.y;return this._swipePoint=w,r.preventDefault(),this._active=!0,{zoomDelta:A/128}}}else this._tap.touchmove(r,h,x)}touchend(r,h,x){if(this._tapTime)this._swipePoint&&x.length===0&&this.reset();else{let w=this._tap.touchend(r,h,x);w&&(this._tapTime=r.timeStamp,this._tapPoint=w)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Qu{constructor(r,h,x){this._el=r,this._mousePan=h,this._touchPan=x}enable(r){this._inertiaOptions=r||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Kd{constructor(r,h,x,w){this._pitchWithRotate=r.pitchWithRotate,this._rollEnabled=r.rollEnabled,this._mouseRotate=h,this._mousePitch=x,this._mouseRoll=w}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable(),this._rollEnabled&&this._mouseRoll.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable(),this._mouseRoll.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())&&(!this._rollEnabled||this._mouseRoll.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()||this._mouseRoll.isActive()}}class ed{constructor(r,h,x,w){this._el=r,this._touchZoom=h,this._touchRotate=x,this._tapDragZoom=w,this._rotationDisabled=!1,this._enabled=!0}enable(r){this._touchZoom.enable(r),this._rotationDisabled||this._touchRotate.enable(r),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class Uh{constructor(r,h){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=r,this._options=h,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;let r=this._map.getCanvasContainer();r.classList.add("maplibregl-cooperative-gestures"),this._container=Dt.create("div","maplibregl-cooperative-gesture-screen",r);let h=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(h=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));let x=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),w=document.createElement("div");w.className="maplibregl-desktop-message",w.textContent=h,this._container.appendChild(w);let A=document.createElement("div");A.className="maplibregl-mobile-message",A.textContent=x,this._container.appendChild(A),this._container.setAttribute("aria-hidden","true")}_destroyUI(){this._container&&(Dt.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destroyUI()}isEnabled(){return this._enabled}isBypassed(r){return r[this._bypassKey]}notifyGestureBlocked(r,h){this._enabled&&(this._map.fire(new t.l("cooperativegestureprevented",{gestureType:r,originalEvent:h})),this._container.classList.add("maplibregl-show"),setTimeout(()=>{this._container.classList.remove("maplibregl-show")},100))}}let td=M=>M.zoom||M.drag||M.roll||M.pitch||M.rotate;class Pm extends t.l{}function Yd(M){return M.panDelta&&M.panDelta.mag()||M.zoomDelta||M.bearingDelta||M.pitchDelta||M.rollDelta}class jh{constructor(r,h){this.handleWindowEvent=w=>{this.handleEvent(w,`${w.type}Window`)},this.handleEvent=(w,A)=>{if(w.type==="blur")return void this.stop(!0);this._updatingCamera=!0;let k=w.type==="renderFrame"?void 0:w,j={needsRenderFrame:!1},q={},J={};for(let{handlerName:ue,handler:ge,allowed:Ee}of this._handlers){if(!ge.isEnabled())continue;let tt;if(this._blockedByActive(J,Ee,ue))ge.reset();else if(ge[A||w.type]){if(t.co(w,A||w.type)){let Xe=Dt.mousePos(this._map.getCanvas(),w);tt=ge[A||w.type](w,Xe)}else if(t.cp(w,A||w.type)){let Xe=this._getMapTouches(w.touches),et=Dt.touchPos(this._map.getCanvas(),Xe);tt=ge[A||w.type](w,et,Xe)}else t.cq(A||w.type)||(tt=ge[A||w.type](w));this.mergeHandlerResult(j,q,tt,ue,k),tt&&tt.needsRenderFrame&&this._triggerRenderFrame()}(tt||ge.isActive())&&(J[ue]=ge)}let ne={};for(let ue in this._previousActiveHandlers)J[ue]||(ne[ue]=k);this._previousActiveHandlers=J,(Object.keys(ne).length||Yd(j))&&(this._changes.push([j,q,ne]),this._triggerRenderFrame()),(Object.keys(J).length||Yd(j))&&this._map._stop(!0),this._updatingCamera=!1;let{cameraAnimation:pe}=j;pe&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],pe(this._map))},this._map=r,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new gu(r),this._bearingSnap=h.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(h);let x=this._el;this._listeners=[[x,"touchstart",{passive:!0}],[x,"touchmove",{passive:!1}],[x,"touchend",void 0],[x,"touchcancel",void 0],[x,"mousedown",void 0],[x,"mousemove",void 0],[x,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[x,"mouseover",void 0],[x,"mouseout",void 0],[x,"dblclick",void 0],[x,"click",void 0],[x,"keydown",{capture:!1}],[x,"keyup",void 0],[x,"wheel",{passive:!1}],[x,"contextmenu",void 0],[window,"blur",void 0]];for(let[w,A,k]of this._listeners)Dt.addEventListener(w,A,w===document?this.handleWindowEvent:this.handleEvent,k)}destroy(){for(let[r,h,x]of this._listeners)Dt.removeEventListener(r,h,r===document?this.handleWindowEvent:this.handleEvent,x)}_addDefaultHandlers(r){let h=this._map,x=h.getCanvasContainer();this._add("mapEvent",new jd(h,r));let w=h.boxZoom=new Hu(h,r);this._add("boxZoom",w),r.interactive&&r.boxZoom&&w.enable();let A=h.cooperativeGestures=new Uh(h,r.cooperativeGestures);this._add("cooperativeGestures",A),r.cooperativeGestures&&A.enable();let k=new xu(h),j=new pf(h);h.doubleClickZoom=new Xd(j,k),this._add("tapZoom",k),this._add("clickZoom",j),r.interactive&&r.doubleClickZoom&&h.doubleClickZoom.enable();let q=new $p;this._add("tapDragZoom",q);let J=h.touchPitch=new $d(h);this._add("touchPitch",J),r.interactive&&r.touchPitch&&h.touchPitch.enable(r.touchPitch);let ne=()=>h.project(h.getCenter()),pe=function({enable:ft,clickTolerance:dt,aroundCenter:xe=!0,minPixelCenterThreshold:pt=100,rotateDegreesPerPixelMoved:zt=.8},ei){let Kt=new Qa({checkCorrectEvent:Jt=>Dt.mouseButton(Jt)===0&&Jt.ctrlKey||Dt.mouseButton(Jt)===2&&!Jt.ctrlKey});return new Mc({clickTolerance:dt,move:(Jt,si)=>{let Xi=ei();if(xe&&Math.abs(Xi.y-Jt.y)>pt)return{bearingDelta:t.cm(new t.P(Jt.x,si.y),si,Xi)};let Ki=(si.x-Jt.x)*zt;return xe&&si.y<Xi.y&&(Ki=-Ki),{bearingDelta:Ki}},moveStateManager:Kt,enable:ft,assignEvents:qd})}(r,ne),ue=function({enable:ft,clickTolerance:dt,pitchDegreesPerPixelMoved:xe=-.5}){let pt=new Qa({checkCorrectEvent:zt=>Dt.mouseButton(zt)===0&&zt.ctrlKey||Dt.mouseButton(zt)===2});return new Mc({clickTolerance:dt,move:(zt,ei)=>({pitchDelta:(ei.y-zt.y)*xe}),moveStateManager:pt,enable:ft,assignEvents:qd})}(r),ge=function({enable:ft,clickTolerance:dt,rollDegreesPerPixelMoved:xe=.3},pt){let zt=new Qa({checkCorrectEvent:ei=>Dt.mouseButton(ei)===2&&ei.ctrlKey});return new Mc({clickTolerance:dt,move:(ei,Kt)=>{let Jt=pt(),si=(Kt.x-ei.x)*xe;return Kt.y<Jt.y&&(si=-si),{rollDelta:si}},moveStateManager:zt,enable:ft,assignEvents:qd})}(r,ne);h.dragRotate=new Kd(r,pe,ue,ge),this._add("mouseRotate",pe,["mousePitch"]),this._add("mousePitch",ue,["mouseRotate","mouseRoll"]),this._add("mouseRoll",ge,["mousePitch"]),r.interactive&&r.dragRotate&&h.dragRotate.enable();let Ee=function({enable:ft,clickTolerance:dt}){let xe=new Qa({checkCorrectEvent:pt=>Dt.mouseButton(pt)===0&&!pt.ctrlKey});return new Mc({clickTolerance:dt,move:(pt,zt)=>({around:zt,panDelta:zt.sub(pt)}),activateOnStart:!0,moveStateManager:xe,enable:ft,assignEvents:qd})}(r),tt=new Mm(r,h);h.dragPan=new Qu(x,Ee,tt),this._add("mousePan",Ee),this._add("touchPan",tt,["touchZoom","touchRotate"]),r.interactive&&r.dragPan&&h.dragPan.enable(r.dragPan);let Xe=new Zp,et=new hc;h.touchZoomRotate=new ed(x,et,Xe,q),this._add("touchRotate",Xe,["touchPan","touchZoom"]),this._add("touchZoom",et,["touchPan","touchRotate"]),r.interactive&&r.touchZoomRotate&&h.touchZoomRotate.enable(r.touchZoomRotate);let Se=h.scrollZoom=new Hd(h,()=>this._triggerRenderFrame());this._add("scrollZoom",Se,["mousePan"]),r.interactive&&r.scrollZoom&&h.scrollZoom.enable(r.scrollZoom);let Be=h.keyboard=new gl(h);this._add("keyboard",Be),r.interactive&&r.keyboard&&h.keyboard.enable(),this._add("blockableMapEvent",new Gd(h))}_add(r,h,x){this._handlers.push({handlerName:r,handler:h,allowed:x}),this._handlersById[r]=h}stop(r){if(!this._updatingCamera){for(let{handler:h}of this._handlers)h.reset();this._inertia.clear(),this._fireEvents({},{},r),this._changes=[]}}isActive(){for(let{handler:r}of this._handlers)if(r.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!td(this._eventsInProgress)||this.isZooming()}_blockedByActive(r,h,x){for(let w in r)if(w!==x&&(!h||h.indexOf(w)<0))return!0;return!1}_getMapTouches(r){let h=[];for(let x of r)this._el.contains(x.target)&&h.push(x);return h}mergeHandlerResult(r,h,x,w,A){if(!x)return;t.e(r,x);let k={handlerName:w,originalEvent:x.originalEvent||A};x.zoomDelta!==void 0&&(h.zoom=k),x.panDelta!==void 0&&(h.drag=k),x.rollDelta!==void 0&&(h.roll=k),x.pitchDelta!==void 0&&(h.pitch=k),x.bearingDelta!==void 0&&(h.rotate=k)}_applyChanges(){let r={},h={},x={};for(let[w,A,k]of this._changes)w.panDelta&&(r.panDelta=(r.panDelta||new t.P(0,0))._add(w.panDelta)),w.zoomDelta&&(r.zoomDelta=(r.zoomDelta||0)+w.zoomDelta),w.bearingDelta&&(r.bearingDelta=(r.bearingDelta||0)+w.bearingDelta),w.pitchDelta&&(r.pitchDelta=(r.pitchDelta||0)+w.pitchDelta),w.rollDelta&&(r.rollDelta=(r.rollDelta||0)+w.rollDelta),w.around!==void 0&&(r.around=w.around),w.pinchAround!==void 0&&(r.pinchAround=w.pinchAround),w.noInertia&&(r.noInertia=w.noInertia),t.e(h,A),t.e(x,k);this._updateMapTransform(r,h,x),this._changes=[]}_updateMapTransform(r,h,x){let w=this._map,A=w._getTransformForUpdate(),k=w.terrain;if(!(Yd(r)||k&&this._terrainMovement))return this._fireEvents(h,x,!0);w._stop(!0);let{panDelta:j,zoomDelta:q,bearingDelta:J,pitchDelta:ne,rollDelta:pe,around:ue,pinchAround:ge}=r;ge!==void 0&&(ue=ge),ue=ue||w.transform.centerPoint,k&&!A.isPointOnMapSurface(ue)&&(ue=A.centerPoint);let Ee={panDelta:j,zoomDelta:q,rollDelta:pe,pitchDelta:ne,bearingDelta:J,around:ue};this._map.cameraHelper.useGlobeControls&&!A.isPointOnMapSurface(ue)&&(ue=A.centerPoint);let tt=ue.distSqr(A.centerPoint)<.01?A.center:A.screenPointToLocation(j?ue.sub(j):ue);k?(this._map.cameraHelper.handleMapControlsRollPitchBearingZoom(Ee,A),this._terrainMovement||!h.drag&&!h.zoom?h.drag&&this._terrainMovement?A.setCenter(A.screenPointToLocation(A.centerPoint.sub(j))):this._map.cameraHelper.handleMapControlsPan(Ee,A,tt):(this._terrainMovement=!0,this._map._elevationFreeze=!0,this._map.cameraHelper.handleMapControlsPan(Ee,A,tt))):(this._map.cameraHelper.handleMapControlsRollPitchBearingZoom(Ee,A),this._map.cameraHelper.handleMapControlsPan(Ee,A,tt)),w._applyUpdatedTransform(A),this._map._update(),r.noInertia||this._inertia.record(r),this._fireEvents(h,x,!0)}_fireEvents(r,h,x){let w=td(this._eventsInProgress),A=td(r),k={};for(let pe in r){let{originalEvent:ue}=r[pe];this._eventsInProgress[pe]||(k[`${pe}start`]=ue),this._eventsInProgress[pe]=r[pe]}!w&&A&&this._fireEvent("movestart",A.originalEvent);for(let pe in k)this._fireEvent(pe,k[pe]);A&&this._fireEvent("move",A.originalEvent);for(let pe in r){let{originalEvent:ue}=r[pe];this._fireEvent(pe,ue)}let j={},q;for(let pe in this._eventsInProgress){let{handlerName:ue,originalEvent:ge}=this._eventsInProgress[pe];this._handlersById[ue].isActive()||(delete this._eventsInProgress[pe],q=h[ue]||ge,j[`${pe}end`]=q)}for(let pe in j)this._fireEvent(pe,j[pe]);let J=td(this._eventsInProgress),ne=(w||A)&&!J;if(ne&&this._terrainMovement){this._map._elevationFreeze=!1,this._terrainMovement=!1;let pe=this._map._getTransformForUpdate();this._map.getCenterClampedToGround()&&pe.recalculateZoomAndCenter(this._map.terrain),this._map._applyUpdatedTransform(pe)}if(x&&ne){this._updatingCamera=!0;let pe=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),ue=ge=>ge!==0&&-this._bearingSnap<ge&&ge<this._bearingSnap;!pe||!pe.essential&&an.prefersReducedMotion?(this._map.fire(new t.l("moveend",{originalEvent:q})),ue(this._map.getBearing())&&this._map.resetNorth()):(ue(pe.bearing||this._map.getBearing())&&(pe.bearing=0),pe.freezeElevation=!0,this._map.easeTo(pe,{originalEvent:q})),this._updatingCamera=!1}}_fireEvent(r,h){this._map.fire(new t.l(r,h?{originalEvent:h}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(r=>{delete this._frameId,this.handleEvent(new Pm("renderFrame",{timeStamp:r})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class jo extends t.E{constructor(r,h,x){super(),this._renderFrameCallback=()=>{let w=Math.min((an.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(w)),w<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=r,this._bearingSnap=x.bearingSnap,this.cameraHelper=h,this.on("moveend",()=>{delete this._requestedCameraState})}migrateProjection(r,h){r.apply(this.transform),this.transform=r,this.cameraHelper=h}getCenter(){return new t.S(this.transform.center.lng,this.transform.center.lat)}setCenter(r,h){return this.jumpTo({center:r},h)}getCenterElevation(){return this.transform.elevation}setCenterElevation(r,h){return this.jumpTo({elevation:r},h),this}getCenterClampedToGround(){return this._centerClampedToGround}setCenterClampedToGround(r){this._centerClampedToGround=r}panBy(r,h,x){return r=t.P.convert(r).mult(-1),this.panTo(this.transform.center,t.e({offset:r},h),x)}panTo(r,h,x){return this.easeTo(t.e({center:r},h),x)}getZoom(){return this.transform.zoom}setZoom(r,h){return this.jumpTo({zoom:r},h),this}zoomTo(r,h,x){return this.easeTo(t.e({zoom:r},h),x)}zoomIn(r,h){return this.zoomTo(this.getZoom()+1,r,h),this}zoomOut(r,h){return this.zoomTo(this.getZoom()-1,r,h),this}getVerticalFieldOfView(){return this.transform.fov}setVerticalFieldOfView(r,h){return r!=this.transform.fov&&(this.transform.setFov(r),this.fire(new t.l("movestart",h)).fire(new t.l("move",h)).fire(new t.l("moveend",h))),this}getBearing(){return this.transform.bearing}setBearing(r,h){return this.jumpTo({bearing:r},h),this}getPadding(){return this.transform.padding}setPadding(r,h){return this.jumpTo({padding:r},h),this}rotateTo(r,h,x){return this.easeTo(t.e({bearing:r},h),x)}resetNorth(r,h){return this.rotateTo(0,t.e({duration:1e3},r),h),this}resetNorthPitch(r,h){return this.easeTo(t.e({bearing:0,pitch:0,roll:0,duration:1e3},r),h),this}snapToNorth(r,h){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(r,h):this}getPitch(){return this.transform.pitch}setPitch(r,h){return this.jumpTo({pitch:r},h),this}getRoll(){return this.transform.roll}setRoll(r,h){return this.jumpTo({roll:r},h),this}cameraForBounds(r,h){r=hr.convert(r).adjustAntiMeridian();let x=h&&h.bearing||0;return this._cameraForBoxAndBearing(r.getNorthWest(),r.getSouthEast(),x,h)}_cameraForBoxAndBearing(r,h,x,w){let A={top:0,bottom:0,right:0,left:0};if(typeof(w=t.e({padding:A,offset:[0,0],maxZoom:this.transform.maxZoom},w)).padding=="number"){let J=w.padding;w.padding={top:J,bottom:J,right:J,left:J}}let k=t.e(A,w.padding);w.padding=k;let j=this.transform,q=new hr(r,h);return this.cameraHelper.cameraForBoxAndBearing(w,k,q,x,j)}fitBounds(r,h,x){return this._fitInternal(this.cameraForBounds(r,h),h,x)}fitScreenCoordinates(r,h,x,w,A){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.screenPointToLocation(t.P.convert(r)),this.transform.screenPointToLocation(t.P.convert(h)),x,w),w,A)}_fitInternal(r,h,x){return r?(delete(h=t.e(r,h)).padding,h.linear?this.easeTo(h,x):this.flyTo(h,x)):this}jumpTo(r,h){this.stop();let x=this._getTransformForUpdate(),w=!1,A=!1,k=!1,j=x.zoom;this.cameraHelper.handleJumpToCenterZoom(x,r);let q=x.zoom!==j;return"elevation"in r&&x.elevation!==+r.elevation&&x.setElevation(+r.elevation),"bearing"in r&&x.bearing!==+r.bearing&&(w=!0,x.setBearing(+r.bearing)),"pitch"in r&&x.pitch!==+r.pitch&&(A=!0,x.setPitch(+r.pitch)),"roll"in r&&x.roll!==+r.roll&&(k=!0,x.setRoll(+r.roll)),r.padding==null||x.isPaddingEqual(r.padding)||x.setPadding(r.padding),this._applyUpdatedTransform(x),this.fire(new t.l("movestart",h)).fire(new t.l("move",h)),q&&this.fire(new t.l("zoomstart",h)).fire(new t.l("zoom",h)).fire(new t.l("zoomend",h)),w&&this.fire(new t.l("rotatestart",h)).fire(new t.l("rotate",h)).fire(new t.l("rotateend",h)),A&&this.fire(new t.l("pitchstart",h)).fire(new t.l("pitch",h)).fire(new t.l("pitchend",h)),k&&this.fire(new t.l("rollstart",h)).fire(new t.l("roll",h)).fire(new t.l("rollend",h)),this.fire(new t.l("moveend",h))}calculateCameraOptionsFromTo(r,h,x,w=0){let A=t.a0.fromLngLat(r,h),k=t.a0.fromLngLat(x,w),j=k.x-A.x,q=k.y-A.y,J=k.z-A.z,ne=Math.hypot(j,q,J);if(ne===0)throw new Error("Can't calculate camera options with same From and To");let pe=Math.hypot(j,q),ue=t.aj(this.transform.cameraToCenterDistance/ne/this.transform.tileSize),ge=180*Math.atan2(j,-q)/Math.PI,Ee=180*Math.acos(pe/ne)/Math.PI;return Ee=J<0?90-Ee:90+Ee,{center:k.toLngLat(),elevation:w,zoom:ue,pitch:Ee,bearing:ge}}calculateCameraOptionsFromCameraLngLatAltRotation(r,h,x,w,A){let k=this.transform.calculateCenterFromCameraLngLatAlt(r,h,x,w);return{center:k.center,elevation:k.elevation,zoom:k.zoom,bearing:x,pitch:w,roll:A}}easeTo(r,h){this._stop(!1,r.easeId),((r=t.e({offset:[0,0],duration:500,easing:t.cn},r)).animate===!1||!r.essential&&an.prefersReducedMotion)&&(r.duration=0);let x=this._getTransformForUpdate(),w=this.getBearing(),A=x.pitch,k=x.roll,j="bearing"in r?this._normalizeBearing(r.bearing,w):w,q="pitch"in r?+r.pitch:A,J="roll"in r?this._normalizeBearing(r.roll,k):k,ne="padding"in r?r.padding:x.padding,pe=t.P.convert(r.offset),ue,ge;r.around&&(ue=t.S.convert(r.around),ge=x.locationToScreenPoint(ue));let Ee={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching,rolling:this._rolling},tt=this.cameraHelper.handleEaseTo(x,{bearing:j,pitch:q,roll:J,padding:ne,around:ue,aroundPoint:ge,offsetAsPoint:pe,offset:r.offset,zoom:r.zoom,center:r.center});return this._rotating=this._rotating||w!==j,this._pitching=this._pitching||q!==A,this._rolling=this._rolling||J!==k,this._padding=!x.isPaddingEqual(ne),this._zooming=this._zooming||tt.isZooming,this._easeId=r.easeId,this._prepareEase(h,r.noMoveStart,Ee),this.terrain&&this._prepareElevation(tt.elevationCenter),this._ease(Xe=>{tt.easeFunc(Xe),this.terrain&&!r.freezeElevation&&this._updateElevation(Xe),this._applyUpdatedTransform(x),this._fireMoveEvents(h)},Xe=>{this.terrain&&r.freezeElevation&&this._finalizeElevation(),this._afterEase(h,Xe)},r),this}_prepareEase(r,h,x={}){this._moving=!0,h||x.moving||this.fire(new t.l("movestart",r)),this._zooming&&!x.zooming&&this.fire(new t.l("zoomstart",r)),this._rotating&&!x.rotating&&this.fire(new t.l("rotatestart",r)),this._pitching&&!x.pitching&&this.fire(new t.l("pitchstart",r)),this._rolling&&!x.rolling&&this.fire(new t.l("rollstart",r))}_prepareElevation(r){this._elevationCenter=r,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(r,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(r){this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom));let h=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(r<1&&h!==this._elevationTarget){let x=this._elevationTarget-this._elevationStart;this._elevationStart+=r*(x-(h-(x*r+this._elevationStart))/(1-r)),this._elevationTarget=h}this.transform.setElevation(t.C.number(this._elevationStart,this._elevationTarget,r))}_finalizeElevation(){this._elevationFreeze=!1,this.getCenterClampedToGround()&&this.transform.recalculateZoomAndCenter(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate||this.terrain?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_elevateCameraIfInsideTerrain(r){if(!this.terrain&&r.elevation>=0&&r.pitch<=90)return{};let h=r.getCameraLngLat(),x=r.getCameraAltitude(),w=this.terrain?this.terrain.getElevationForLngLatZoom(h,r.zoom):0;if(x<w){let A=this.calculateCameraOptionsFromTo(h,w,r.center,r.elevation);return{pitch:A.pitch,zoom:A.zoom}}return{}}_applyUpdatedTransform(r){let h=[];if(h.push(w=>this._elevateCameraIfInsideTerrain(w)),this.transformCameraUpdate&&h.push(w=>this.transformCameraUpdate(w)),!h.length)return;let x=r.clone();for(let w of h){let A=x.clone(),{center:k,zoom:j,roll:q,pitch:J,bearing:ne,elevation:pe}=w(A);k&&A.setCenter(k),pe!==void 0&&A.setElevation(pe),j!==void 0&&A.setZoom(j),q!==void 0&&A.setRoll(q),J!==void 0&&A.setPitch(J),ne!==void 0&&A.setBearing(ne),x.apply(A)}this.transform.apply(x)}_fireMoveEvents(r){this.fire(new t.l("move",r)),this._zooming&&this.fire(new t.l("zoom",r)),this._rotating&&this.fire(new t.l("rotate",r)),this._pitching&&this.fire(new t.l("pitch",r)),this._rolling&&this.fire(new t.l("roll",r))}_afterEase(r,h){if(this._easeId&&h&&this._easeId===h)return;delete this._easeId;let x=this._zooming,w=this._rotating,A=this._pitching,k=this._rolling;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._rolling=!1,this._padding=!1,x&&this.fire(new t.l("zoomend",r)),w&&this.fire(new t.l("rotateend",r)),A&&this.fire(new t.l("pitchend",r)),k&&this.fire(new t.l("rollend",r)),this.fire(new t.l("moveend",r))}flyTo(r,h){if(!r.essential&&an.prefersReducedMotion){let si=t.Q(r,["center","zoom","bearing","pitch","roll","elevation"]);return this.jumpTo(si,h)}this.stop(),r=t.e({offset:[0,0],speed:1.2,curve:1.42,easing:t.cn},r);let x=this._getTransformForUpdate(),w=x.bearing,A=x.pitch,k=x.roll,j=x.padding,q="bearing"in r?this._normalizeBearing(r.bearing,w):w,J="pitch"in r?+r.pitch:A,ne="roll"in r?this._normalizeBearing(r.roll,k):k,pe="padding"in r?r.padding:x.padding,ue=t.P.convert(r.offset),ge=x.centerPoint.add(ue),Ee=x.screenPointToLocation(ge),tt=this.cameraHelper.handleFlyTo(x,{bearing:q,pitch:J,roll:ne,padding:pe,locationAtOffset:Ee,offsetAsPoint:ue,center:r.center,minZoom:r.minZoom,zoom:r.zoom}),Xe=r.curve,et=Math.max(x.width,x.height),Se=et/tt.scaleOfZoom,Be=tt.pixelPathLength;typeof tt.scaleOfMinZoom=="number"&&(Xe=Math.sqrt(et/tt.scaleOfMinZoom/Be*2));let ft=Xe*Xe;function dt(si){let Xi=(Se*Se-et*et+(si?-1:1)*ft*ft*Be*Be)/(2*(si?Se:et)*ft*Be);return Math.log(Math.sqrt(Xi*Xi+1)-Xi)}function xe(si){return(Math.exp(si)-Math.exp(-si))/2}function pt(si){return(Math.exp(si)+Math.exp(-si))/2}let zt=dt(!1),ei=function(si){return pt(zt)/pt(zt+Xe*si)},Kt=function(si){return et*((pt(zt)*(xe(Xi=zt+Xe*si)/pt(Xi))-xe(zt))/ft)/Be;var Xi},Jt=(dt(!0)-zt)/Xe;if(Math.abs(Be)<2e-6||!isFinite(Jt)){if(Math.abs(et-Se)<1e-6)return this.easeTo(r,h);let si=Se<et?-1:1;Jt=Math.abs(Math.log(Se/et))/Xe,Kt=()=>0,ei=Xi=>Math.exp(si*Xe*Xi)}return r.duration="duration"in r?+r.duration:1e3*Jt/("screenSpeed"in r?+r.screenSpeed/Xe:+r.speed),r.maxDuration&&r.duration>r.maxDuration&&(r.duration=0),this._zooming=!0,this._rotating=w!==q,this._pitching=J!==A,this._rolling=ne!==k,this._padding=!x.isPaddingEqual(pe),this._prepareEase(h,!1),this.terrain&&this._prepareElevation(tt.targetCenter),this._ease(si=>{let Xi=si*Jt,Ki=1/ei(Xi),Pi=Kt(Xi);this._rotating&&x.setBearing(t.C.number(w,q,si)),this._pitching&&x.setPitch(t.C.number(A,J,si)),this._rolling&&x.setRoll(t.C.number(k,ne,si)),this._padding&&(x.interpolatePadding(j,pe,si),ge=x.centerPoint.add(ue)),tt.easeFunc(si,Ki,Pi,ge),this.terrain&&!r.freezeElevation&&this._updateElevation(si),this._applyUpdatedTransform(x),this._fireMoveEvents(h)},()=>{this.terrain&&r.freezeElevation&&this._finalizeElevation(),this._afterEase(h)},r),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(r,h){var x;if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){let w=this._onEaseEnd;delete this._onEaseEnd,w.call(this,h)}return r||(x=this.handlers)===null||x===void 0||x.stop(!1),this}_ease(r,h,x){x.animate===!1||x.duration===0?(r(1),h()):(this._easeStart=an.now(),this._easeOptions=x,this._onEaseFrame=r,this._onEaseEnd=h,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(r,h){r=t.aN(r,-180,180);let x=Math.abs(r-h);return Math.abs(r-360-h)<x&&(r-=360),Math.abs(r+360-h)<x&&(r+=360),r}queryTerrainElevation(r){return this.terrain?this.terrain.getElevationForLngLatZoom(t.S.convert(r),this.transform.tileZoom):null}}let Gh={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class mh{constructor(r=Gh){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=h=>{!h||h.sourceDataType!=="metadata"&&h.sourceDataType!=="visibility"&&h.dataType!=="style"&&h.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=r}getDefaultPosition(){return"bottom-right"}onAdd(r){return this._map=r,this._compact=this.options.compact,this._container=Dt.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=Dt.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=Dt.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){Dt.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(r,h){let x=this._map._getUIString(`AttributionControl.${h}`);r.title=x,r.setAttribute("aria-label",x)}_updateAttributions(){if(!this._map.style)return;let r=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?r=r.concat(this.options.customAttribution.map(w=>typeof w!="string"?"":w)):typeof this.options.customAttribution=="string"&&r.push(this.options.customAttribution)),this._map.style.stylesheet){let w=this._map.style.stylesheet;this.styleOwner=w.owner,this.styleId=w.id}let h=this._map.style.sourceCaches;for(let w in h){let A=h[w];if(A.used||A.usedForTerrain){let k=A.getSource();k.attribution&&r.indexOf(k.attribution)<0&&r.push(k.attribution)}}r=r.filter(w=>String(w).trim()),r.sort((w,A)=>w.length-A.length),r=r.filter((w,A)=>{for(let k=A+1;k<r.length;k++)if(r[k].indexOf(w)>=0)return!1;return!0});let x=r.join(" | ");x!==this._attribHTML&&(this._attribHTML=x,r.length?(this._innerContainer.innerHTML=Dt.sanitize(x),this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class _h{constructor(r={}){this._updateCompact=()=>{let h=this._container.children;if(h.length){let x=h[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&x.classList.add("maplibregl-compact"):x.classList.remove("maplibregl-compact")}},this.options=r}getDefaultPosition(){return"bottom-left"}onAdd(r){this._map=r,this._compact=this.options&&this.options.compact,this._container=Dt.create("div","maplibregl-ctrl");let h=Dt.create("a","maplibregl-ctrl-logo");return h.target="_blank",h.rel="noopener nofollow",h.href="https://maplibre.org/",h.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),h.setAttribute("rel","noopener nofollow"),this._container.appendChild(h),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){Dt.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class bu{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(r){let h=++this._id;return this._queue.push({callback:r,id:h,cancelled:!1}),h}remove(r){let h=this._currentlyRunning,x=h?this._queue.concat(h):this._queue;for(let w of x)if(w.id===r)return void(w.cancelled=!0)}run(r=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");let h=this._currentlyRunning=this._queue;this._queue=[];for(let x of h)if(!x.cancelled&&(x.callback(r),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var id=t.aI([{name:"a_pos3d",type:"Int16",components:3}]);class Jd extends t.E{constructor(r){super(),this._lastTilesetChange=an.now(),this.sourceCache=r,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.deltaZoom=1,this.tileSize=r._source.tileSize*2**this.deltaZoom,r.usedForTerrain=!0,r.tileSize=this.tileSize}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null}update(r,h){this.sourceCache.update(r,h),this._renderableTilesKeys=[];let x={};for(let w of li(r,{tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:h,calculateTileZoom:this.sourceCache._source.calculateTileZoom}))x[w.key]=!0,this._renderableTilesKeys.push(w.key),this._tiles[w.key]||(w.terrainRttPosMatrix32f=new Float64Array(16),t.bX(w.terrainRttPosMatrix32f,0,t.$,t.$,0,0,1),this._tiles[w.key]=new Ha(w,this.tileSize),this._lastTilesetChange=an.now());for(let w in this._tiles)x[w]||delete this._tiles[w]}freeRtt(r){for(let h in this._tiles){let x=this._tiles[h];(!r||x.tileID.equals(r)||x.tileID.isChildOf(r)||r.isChildOf(x.tileID))&&(x.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map(r=>this.getTileByID(r))}getTileByID(r){return this._tiles[r]}getTerrainCoords(r,h){return h?this._getTerrainCoordsForTileRanges(r,h):this._getTerrainCoordsForRegularTile(r)}_getTerrainCoordsForRegularTile(r){let h={};for(let x of this._renderableTilesKeys){let w=this._tiles[x].tileID,A=r.clone(),k=t.b9();if(w.canonical.equals(r.canonical))t.bX(k,0,t.$,t.$,0,0,1);else if(w.canonical.isChildOf(r.canonical)){let j=w.canonical.z-r.canonical.z,q=w.canonical.x-(w.canonical.x>>j<<j),J=w.canonical.y-(w.canonical.y>>j<<j),ne=t.$>>j;t.bX(k,0,ne,ne,0,0,1),t.M(k,k,[-q*ne,-J*ne,0])}else{if(!r.canonical.isChildOf(w.canonical))continue;{let j=r.canonical.z-w.canonical.z,q=r.canonical.x-(r.canonical.x>>j<<j),J=r.canonical.y-(r.canonical.y>>j<<j),ne=t.$>>j;t.bX(k,0,t.$,t.$,0,0,1),t.M(k,k,[q*ne,J*ne,0]),t.N(k,k,[1/2**j,1/2**j,0])}}A.terrainRttPosMatrix32f=new Float32Array(k),h[x]=A}return h}_getTerrainCoordsForTileRanges(r,h){let x={};for(let w of this._renderableTilesKeys){let A=this._tiles[w].tileID;if(!this._isWithinTileRanges(A,h))continue;let k=r.clone(),j=t.b9();if(A.canonical.z===r.canonical.z){let q=r.canonical.x-A.canonical.x,J=r.canonical.y-A.canonical.y;t.bX(j,0,t.$,t.$,0,0,1),t.M(j,j,[q*t.$,J*t.$,0])}else if(A.canonical.z>r.canonical.z){let q=A.canonical.z-r.canonical.z,J=A.canonical.x-(A.canonical.x>>q<<q),ne=A.canonical.y-(A.canonical.y>>q<<q),pe=r.canonical.x-(A.canonical.x>>q),ue=r.canonical.y-(A.canonical.y>>q),ge=t.$>>q;t.bX(j,0,ge,ge,0,0,1),t.M(j,j,[-J*ge+pe*t.$,-ne*ge+ue*t.$,0])}else{let q=r.canonical.z-A.canonical.z,J=r.canonical.x-(r.canonical.x>>q<<q),ne=r.canonical.y-(r.canonical.y>>q<<q),pe=(r.canonical.x>>q)-A.canonical.x,ue=(r.canonical.y>>q)-A.canonical.y,ge=t.$<<q;t.bX(j,0,ge,ge,0,0,1),t.M(j,j,[J*t.$+pe*ge,ne*t.$+ue*ge,0])}k.terrainRttPosMatrix32f=new Float32Array(j),x[w]=k}return x}getSourceTile(r,h){let x=this.sourceCache._source,w=r.overscaledZ-this.deltaZoom;if(w>x.maxzoom&&(w=x.maxzoom),w<x.minzoom)return null;this._sourceTileCache[r.key]||(this._sourceTileCache[r.key]=r.scaledTo(w).key);let A=this.sourceCache.getTileByID(this._sourceTileCache[r.key]);if((!A||!A.dem)&&h)for(;w>=x.minzoom&&(!A||!A.dem);)A=this.sourceCache.getTileByID(r.scaledTo(w--).key);return A}anyTilesAfterTime(r=Date.now()){return this._lastTilesetChange>=r}_isWithinTileRanges(r,h){return h[r.canonical.z]&&r.canonical.x>=h[r.canonical.z].minTileX&&r.canonical.x<=h[r.canonical.z].maxTileX&&r.canonical.y>=h[r.canonical.z].minTileY&&r.canonical.y<=h[r.canonical.z].maxTileY}}class yl{constructor(r,h,x){this._meshCache={},this.painter=r,this.sourceCache=new Jd(h),this.options=x,this.exaggeration=typeof x.exaggeration=="number"?x.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(r,h,x,w=t.$){var A;if(!(h>=0&&h<w&&x>=0&&x<w))return 0;let k=this.getTerrainData(r),j=(A=k.tile)===null||A===void 0?void 0:A.dem;if(!j)return 0;let q=t.cr([],[h/w*t.$,x/w*t.$],k.u_terrain_matrix),J=[q[0]*j.dim,q[1]*j.dim],ne=Math.floor(J[0]),pe=Math.floor(J[1]),ue=J[0]-ne,ge=J[1]-pe;return j.get(ne,pe)*(1-ue)*(1-ge)+j.get(ne+1,pe)*ue*(1-ge)+j.get(ne,pe+1)*(1-ue)*ge+j.get(ne+1,pe+1)*ue*ge}getElevationForLngLatZoom(r,h){if(!t.cs(h,r.wrap()))return 0;let{tileID:x,mercatorX:w,mercatorY:A}=this._getOverscaledTileIDFromLngLatZoom(r,h);return this.getElevation(x,w%t.$,A%t.$,t.$)}getElevation(r,h,x,w=t.$){return this.getDEMElevation(r,h,x,w)*this.exaggeration}getTerrainData(r){if(!this._emptyDemTexture){let w=this.painter.context,A=new t.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new t.T(w,A,w.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new t.T(w,new t.R({width:1,height:1}),w.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(w.gl.NEAREST,w.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=t.af([])}let h=this.sourceCache.getSourceTile(r,!0);if(h&&h.dem&&(!h.demTexture||h.needsTerrainPrepare)){let w=this.painter.context;h.demTexture=this.painter.getTileTexture(h.dem.stride),h.demTexture?h.demTexture.update(h.dem.getPixels(),{premultiply:!1}):h.demTexture=new t.T(w,h.dem.getPixels(),w.gl.RGBA,{premultiply:!1}),h.demTexture.bind(w.gl.NEAREST,w.gl.CLAMP_TO_EDGE),h.needsTerrainPrepare=!1}let x=h&&h+h.tileID.key+r.key;if(x&&!this._demMatrixCache[x]){let w=this.sourceCache.sourceCache._source.maxzoom,A=r.canonical.z-h.tileID.canonical.z;r.overscaledZ>r.canonical.z&&(r.canonical.z>=w?A=r.canonical.z-w:t.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));let k=r.canonical.x-(r.canonical.x>>A<<A),j=r.canonical.y-(r.canonical.y>>A<<A),q=t.ct(new Float64Array(16),[1/(t.$<<A),1/(t.$<<A),0]);t.M(q,q,[k*t.$,j*t.$,0]),this._demMatrixCache[r.key]={matrix:q,coord:r}}return{u_depth:2,u_terrain:3,u_terrain_dim:h&&h.dem&&h.dem.dim||1,u_terrain_matrix:x?this._demMatrixCache[r.key].matrix:this._emptyDemMatrix,u_terrain_unpack:h&&h.dem&&h.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(h&&h.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:h}}getFramebuffer(r){let h=this.painter,x=h.width/devicePixelRatio,w=h.height/devicePixelRatio;return!this._fbo||this._fbo.width===x&&this._fbo.height===w||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new t.T(h.context,{width:x,height:w,data:null},h.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(h.context.gl.NEAREST,h.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new t.T(h.context,{width:x,height:w,data:null},h.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(h.context.gl.NEAREST,h.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=h.context.createFramebuffer(x,w,!0,!1),this._fbo.depthAttachment.set(h.context.createRenderbuffer(h.context.gl.DEPTH_COMPONENT16,x,w))),this._fbo.colorAttachment.set(r==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){let r=this.painter.context;if(this._coordsTexture)return this._coordsTexture;let h=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let A=0,k=0;A<this._coordsTextureSize;A++)for(let j=0;j<this._coordsTextureSize;j++,k+=4)h[k+0]=255&j,h[k+1]=255&A,h[k+2]=j>>8<<4|A>>8,h[k+3]=0;let x=new t.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(h.buffer)),w=new t.T(r,x,r.gl.RGBA,{premultiply:!1});return w.bind(r.gl.NEAREST,r.gl.CLAMP_TO_EDGE),this._coordsTexture=w,w}pointCoordinate(r){this.painter.maybeDrawDepthAndCoords(!0);let h=new Uint8Array(4),x=this.painter.context,w=x.gl,A=Math.round(r.x*this.painter.pixelRatio/devicePixelRatio),k=Math.round(r.y*this.painter.pixelRatio/devicePixelRatio),j=Math.round(this.painter.height/devicePixelRatio);x.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),w.readPixels(A,j-k-1,1,1,w.RGBA,w.UNSIGNED_BYTE,h),x.bindFramebuffer.set(null);let q=h[0]+(h[2]>>4<<8),J=h[1]+((15&h[2])<<8),ne=this.coordsIndex[255-h[3]],pe=ne&&this.sourceCache.getTileByID(ne);if(!pe)return null;let ue=this._coordsTextureSize,ge=(1<<pe.tileID.canonical.z)*ue;return new t.a0((pe.tileID.canonical.x*ue+q)/ge+pe.tileID.wrap,(pe.tileID.canonical.y*ue+J)/ge,this.getElevation(pe.tileID,q,J,ue))}depthAtPoint(r){let h=new Uint8Array(4),x=this.painter.context,w=x.gl;return x.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),w.readPixels(r.x,this.painter.height/devicePixelRatio-r.y-1,1,1,w.RGBA,w.UNSIGNED_BYTE,h),x.bindFramebuffer.set(null),(h[0]/16777216+h[1]/65536+h[2]/256+h[3])/256}getTerrainMesh(r){var h;let x=((h=this.painter.style.projection)===null||h===void 0?void 0:h.transitionState)>0,w=x&&r.canonical.y===0,A=x&&r.canonical.y===(1<<r.canonical.z)-1,k=`m_${w?"n":""}_${A?"s":""}`;if(this._meshCache[k])return this._meshCache[k];let j=this.painter.context,q=new t.cu,J=new t.aM,ne=this.meshSize,pe=t.$/ne,ue=ne*ne;for(let pt=0;pt<=ne;pt++)for(let zt=0;zt<=ne;zt++)q.emplaceBack(zt*pe,pt*pe,0);for(let pt=0;pt<ue;pt+=ne+1)for(let zt=0;zt<ne;zt++)J.emplaceBack(zt+pt,ne+zt+pt+1,ne+zt+pt+2),J.emplaceBack(zt+pt,ne+zt+pt+2,zt+pt+1);let ge=q.length,Ee=ge+(ne+1),tt=(ne+1)*ne,Xe=w?t.bg:0,et=w?0:1,Se=A?t.bh:t.$,Be=A?0:1;for(let pt=0;pt<=ne;pt++)q.emplaceBack(pt*pe,Xe,et);for(let pt=0;pt<=ne;pt++)q.emplaceBack(pt*pe,Se,Be);for(let pt=0;pt<ne;pt++)J.emplaceBack(tt+pt,Ee+pt,Ee+pt+1),J.emplaceBack(tt+pt,Ee+pt+1,tt+pt+1),J.emplaceBack(0+pt,ge+pt+1,ge+pt),J.emplaceBack(0+pt,0+pt+1,ge+pt+1);let ft=q.length,dt=ft+2*(ne+1);for(let pt of[0,1])for(let zt=0;zt<=ne;zt++)for(let ei of[0,1])q.emplaceBack(pt*t.$,zt*pe,ei);for(let pt=0;pt<2*ne;pt+=2)J.emplaceBack(ft+pt,ft+pt+1,ft+pt+3),J.emplaceBack(ft+pt,ft+pt+3,ft+pt+2),J.emplaceBack(dt+pt,dt+pt+3,dt+pt+1),J.emplaceBack(dt+pt,dt+pt+2,dt+pt+3);let xe=new ec(j.createVertexBuffer(q,id.members),j.createIndexBuffer(J),t.aL.simpleSegment(0,0,q.length,J.length));return this._meshCache[k]=xe,xe}getMeshFrameDelta(r){return 2*Math.PI*t.bt/Math.pow(2,Math.max(r,0))/5}getMinTileElevationForLngLatZoom(r,h){var x;let{tileID:w}=this._getOverscaledTileIDFromLngLatZoom(r,h);return(x=this.getMinMaxElevation(w).minElevation)!==null&&x!==void 0?x:0}getMinMaxElevation(r){let h=this.getTerrainData(r).tile,x={minElevation:null,maxElevation:null};return h&&h.dem&&(x.minElevation=h.dem.min*this.exaggeration,x.maxElevation=h.dem.max*this.exaggeration),x}_getOverscaledTileIDFromLngLatZoom(r,h){let x=t.a0.fromLngLat(r.wrap()),w=(1<<h)*t.$,A=x.x*w,k=x.y*w,j=Math.floor(A/t.$),q=Math.floor(k/t.$);return{tileID:new t.Z(h,0,h,j,q),mercatorX:A,mercatorY:k}}}class nd{constructor(r,h,x){this._context=r,this._size=h,this._tileSize=x,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(let r of this._objects)r.texture.destroy(),r.fbo.destroy()}_createObject(r){let h=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),x=new t.T(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return x.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),this._context.extTextureFilterAnisotropic&&this._context.gl.texParameterf(this._context.gl.TEXTURE_2D,this._context.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._context.extTextureFilterAnisotropicMax),h.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),h.colorAttachment.set(x.texture),{id:r,fbo:h,texture:x,stamp:-1,inUse:!1}}getObjectForId(r){return this._objects[r]}useObject(r){r.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter(h=>r.id!==h),this._recentlyUsed.push(r.id)}stampObject(r){r.stamp=++this._stamp}getOrCreateFreeObject(){for(let h of this._recentlyUsed)if(!this._objects[h].inUse)return this._objects[h];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");let r=this._createObject(this._objects.length);return this._objects.push(r),r}freeObject(r){r.inUse=!1}freeAllObjects(){for(let r of this._objects)this.freeObject(r)}isFull(){return!(this._objects.length<this._size)&&this._objects.some(r=>!r.inUse)===!1}}let pn={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0,"color-relief":!0};class jn{constructor(r,h){this.painter=r,this.terrain=h,this.pool=new nd(r.context,30,h.sourceCache.tileSize*h.qualityFactor)}destruct(){this.pool.destruct()}getTexture(r){return this.pool.getObjectForId(r.rtt[this._stacks.length-1].id).texture}prepareForRender(r,h){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.sourceCache.getRenderableTiles(),this._renderableLayerIds=r._order.filter(x=>!r._layers[x].isHidden(h)),this._coordsAscending={};for(let x in r.sourceCaches){this._coordsAscending[x]={};let w=r.sourceCaches[x].getVisibleCoordinates(),A=r.sourceCaches[x].getSource(),k=A instanceof Vo?A.terrainTileRanges:null;for(let j of w){let q=this.terrain.sourceCache.getTerrainCoords(j,k);for(let J in q)this._coordsAscending[x][J]||(this._coordsAscending[x][J]=[]),this._coordsAscending[x][J].push(q[J])}}this._coordsAscendingStr={};for(let x of r._order){let w=r._layers[x],A=w.source;if(pn[w.type]&&!this._coordsAscendingStr[A]){this._coordsAscendingStr[A]={};for(let k in this._coordsAscending[A])this._coordsAscendingStr[A][k]=this._coordsAscending[A][k].map(j=>j.key).sort().join()}}for(let x of this._renderableTiles)for(let w in this._coordsAscendingStr){let A=this._coordsAscendingStr[w][x.tileID.key];A&&A!==x.rttCoords[w]&&(x.rtt=[])}}renderLayer(r,h){if(r.isHidden(this.painter.transform.zoom))return!1;let x=Object.assign(Object.assign({},h),{isRenderingToTexture:!0}),w=r.type,A=this.painter,k=this._renderableLayerIds[this._renderableLayerIds.length-1]===r.id;if(pn[w]&&(this._prevType&&pn[this._prevType]||this._stacks.push([]),this._prevType=w,this._stacks[this._stacks.length-1].push(r.id),!k))return!0;if(pn[this._prevType]||pn[w]&&k){this._prevType=w;let j=this._stacks.length-1,q=this._stacks[j]||[];for(let J of this._renderableTiles){if(this.pool.isFull()&&(Ro(this.painter,this.terrain,this._rttTiles,x),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(J),J.rtt[j]){let pe=this.pool.getObjectForId(J.rtt[j].id);if(pe.stamp===J.rtt[j].stamp){this.pool.useObject(pe);continue}}let ne=this.pool.getOrCreateFreeObject();this.pool.useObject(ne),this.pool.stampObject(ne),J.rtt[j]={id:ne.id,stamp:ne.stamp},A.context.bindFramebuffer.set(ne.fbo.framebuffer),A.context.clear({color:t.be.transparent,stencil:0}),A.currentStencilSource=void 0;for(let pe=0;pe<q.length;pe++){let ue=A.style._layers[q[pe]],ge=ue.source?this._coordsAscending[ue.source][J.tileID.key]:[J.tileID];A.context.viewport.set([0,0,ne.fbo.width,ne.fbo.height]),A._renderTileClippingMasks(ue,ge,!0),A.renderLayer(A,A.style.sourceCaches[ue.source],ue,ge,x),ue.source&&(J.rttCoords[ue.source]=this._coordsAscendingStr[ue.source][J.tileID.key])}}return Ro(this.painter,this.terrain,this._rttTiles,x),this._rttTiles=[],this.pool.freeAllObjects(),pn[w]}return!1}}let gh={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","Map.Title":"Map","Marker.Title":"Map marker","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","Popup.Close":"Close popup","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","GlobeControl.Enable":"Enable globe","GlobeControl.Disable":"Disable globe","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use \u2318 + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},wu=at,Ei={hash:!1,interactive:!0,bearingSnap:7,attributionControl:Gh,maplibreLogo:!1,refreshExpiredTiles:!0,canvasContextAttributes:{antialias:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,desynchronized:!1,contextType:void 0},scrollZoom:!0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,trackResize:!0,center:[0,0],elevation:0,zoom:0,bearing:0,pitch:0,roll:0,renderWorldCopies:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:t.a.MAX_TILE_CACHE_ZOOM_LEVELS,transformRequest:null,transformCameraUpdate:null,fadeDuration:300,crossSourceCollisions:!0,clickTolerance:3,localIdeographFontFamily:"sans-serif",pitchWithRotate:!0,rollEnabled:!1,validateStyle:!0,maxCanvasSize:[4096,4096],cancelPendingTileRequestsWhileZooming:!0,centerClampedToGround:!0},Qs={showCompass:!0,showZoom:!0,visualizePitch:!1,visualizeRoll:!0};class Zh{constructor(r,h,x=!1){this.mousedown=A=>{this.startMove(A,Dt.mousePos(this.element,A)),Dt.addEventListener(window,"mousemove",this.mousemove),Dt.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=A=>{this.move(A,Dt.mousePos(this.element,A))},this.mouseup=A=>{this._rotatePitchHanlder.dragEnd(A),this.offTemp()},this.touchstart=A=>{A.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Dt.touchPos(this.element,A.targetTouches)[0],this.startMove(A,this._startPos),Dt.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),Dt.addEventListener(window,"touchend",this.touchend))},this.touchmove=A=>{A.targetTouches.length!==1?this.reset():(this._lastPos=Dt.touchPos(this.element,A.targetTouches)[0],this.move(A,this._lastPos))},this.touchend=A=>{A.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this._rotatePitchHanlder.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10,this.element=h;let w=new Gf;this._rotatePitchHanlder=new Mc({clickTolerance:3,move:(A,k)=>{let j=h.getBoundingClientRect(),q=new t.P((j.bottom-j.top)/2,(j.right-j.left)/2);return{bearingDelta:t.cm(new t.P(A.x,k.y),k,q),pitchDelta:x?-.5*(k.y-A.y):void 0}},moveStateManager:w,enable:!0,assignEvents:()=>{}}),this.map=r,Dt.addEventListener(h,"mousedown",this.mousedown),Dt.addEventListener(h,"touchstart",this.touchstart,{passive:!1}),Dt.addEventListener(h,"touchcancel",this.reset)}startMove(r,h){this._rotatePitchHanlder.dragStart(r,h),Dt.disableDrag()}move(r,h){let x=this.map,{bearingDelta:w,pitchDelta:A}=this._rotatePitchHanlder.dragMove(r,h)||{};w&&x.setBearing(x.getBearing()+w),A&&x.setPitch(x.getPitch()+A)}off(){let r=this.element;Dt.removeEventListener(r,"mousedown",this.mousedown),Dt.removeEventListener(r,"touchstart",this.touchstart,{passive:!1}),Dt.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),Dt.removeEventListener(window,"touchend",this.touchend),Dt.removeEventListener(r,"touchcancel",this.reset),this.offTemp()}offTemp(){Dt.enableDrag(),Dt.removeEventListener(window,"mousemove",this.mousemove),Dt.removeEventListener(window,"mouseup",this.mouseup),Dt.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),Dt.removeEventListener(window,"touchend",this.touchend)}}let ds;function yh(M,r,h,x=!1){if(x||!h.getCoveringTilesDetailsProvider().allowWorldCopies())return M?.wrap();let w=new t.S(M.lng,M.lat);if(M=new t.S(M.lng,M.lat),r){let A=new t.S(M.lng-360,M.lat),k=new t.S(M.lng+360,M.lat),j=h.locationToScreenPoint(M).distSqr(r);h.locationToScreenPoint(A).distSqr(r)<j?M=A:h.locationToScreenPoint(k).distSqr(r)<j&&(M=k)}for(;Math.abs(M.lng-h.center.lng)>180;){let A=h.locationToScreenPoint(M);if(A.x>=0&&A.y>=0&&A.x<=h.width&&A.y<=h.height)break;M.lng>h.center.lng?M.lng-=360:M.lng+=360}return M.lng!==w.lng&&h.isPointOnMapSurface(h.locationToScreenPoint(M))?M:w}let tn={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function Wo(M,r,h){let x=M.classList;for(let w in tn)x.remove(`maplibregl-${h}-anchor-${w}`);x.add(`maplibregl-${h}-anchor-${r}`)}class ys extends t.E{constructor(r){if(super(),this._onKeyPress=h=>{let x=h.code,w=h.charCode||h.keyCode;x!=="Space"&&x!=="Enter"&&w!==32&&w!==13||this.togglePopup()},this._onMapClick=h=>{let x=h.originalEvent.target,w=this._element;this._popup&&(x===w||w.contains(x))&&this.togglePopup()},this._update=h=>{if(!this._map)return;let x=this._map.loaded()&&!this._map.isMoving();(h?.type==="terrain"||h?.type==="render"&&!x)&&this._map.once("render",this._update),this._lngLat=yh(this._lngLat,this._flatPos,this._map.transform),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationToScreenPoint(this._lngLat)._add(this._offset));let w="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?w=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(w=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let A="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?A="rotateX(0deg)":this._pitchAlignment==="map"&&(A=`rotateX(${this._map.getPitch()}deg)`),this._subpixelPositioning||h&&h.type!=="moveend"||(this._pos=this._pos.round()),Dt.setTransform(this._element,`${tn[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${A} ${w}`),an.frameAsync(new AbortController).then(()=>{this._updateOpacity(h&&h.type==="moveend")}).catch(()=>{})},this._onMove=h=>{if(!this._isDragging){let x=this._clickTolerance||this._map._clickTolerance;this._isDragging=h.point.dist(this._pointerdownPos)>=x}this._isDragging&&(this._pos=h.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new t.l("dragstart"))),this.fire(new t.l("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new t.l("dragend")),this._state="inactive"},this._addDragHandler=h=>{this._element.contains(h.originalEvent.target)&&(h.preventDefault(),this._positionDelta=h.point.sub(this._pos).add(this._offset),this._pointerdownPos=h.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=r&&r.anchor||"center",this._color=r&&r.color||"#3FB1CE",this._scale=r&&r.scale||1,this._draggable=r&&r.draggable||!1,this._clickTolerance=r&&r.clickTolerance||0,this._subpixelPositioning=r&&r.subpixelPositioning||!1,this._isDragging=!1,this._state="inactive",this._rotation=r&&r.rotation||0,this._rotationAlignment=r&&r.rotationAlignment||"auto",this._pitchAlignment=r&&r.pitchAlignment&&r.pitchAlignment!=="auto"?r.pitchAlignment:this._rotationAlignment,this.setOpacity(r?.opacity,r?.opacityWhenCovered),r&&r.element)this._element=r.element,this._offset=t.P.convert(r&&r.offset||[0,0]);else{this._defaultMarker=!0,this._element=Dt.create("div");let h=Dt.createNS("http://www.w3.org/2000/svg","svg"),x=41,w=27;h.setAttributeNS(null,"display","block"),h.setAttributeNS(null,"height",`${x}px`),h.setAttributeNS(null,"width",`${w}px`),h.setAttributeNS(null,"viewBox",`0 0 ${w} ${x}`);let A=Dt.createNS("http://www.w3.org/2000/svg","g");A.setAttributeNS(null,"stroke","none"),A.setAttributeNS(null,"stroke-width","1"),A.setAttributeNS(null,"fill","none"),A.setAttributeNS(null,"fill-rule","evenodd");let k=Dt.createNS("http://www.w3.org/2000/svg","g");k.setAttributeNS(null,"fill-rule","nonzero");let j=Dt.createNS("http://www.w3.org/2000/svg","g");j.setAttributeNS(null,"transform","translate(3.0, 29.0)"),j.setAttributeNS(null,"fill","#000000");let q=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(let et of q){let Se=Dt.createNS("http://www.w3.org/2000/svg","ellipse");Se.setAttributeNS(null,"opacity","0.04"),Se.setAttributeNS(null,"cx","10.5"),Se.setAttributeNS(null,"cy","5.80029008"),Se.setAttributeNS(null,"rx",et.rx),Se.setAttributeNS(null,"ry",et.ry),j.appendChild(Se)}let J=Dt.createNS("http://www.w3.org/2000/svg","g");J.setAttributeNS(null,"fill",this._color);let ne=Dt.createNS("http://www.w3.org/2000/svg","path");ne.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),J.appendChild(ne);let pe=Dt.createNS("http://www.w3.org/2000/svg","g");pe.setAttributeNS(null,"opacity","0.25"),pe.setAttributeNS(null,"fill","#000000");let ue=Dt.createNS("http://www.w3.org/2000/svg","path");ue.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),pe.appendChild(ue);let ge=Dt.createNS("http://www.w3.org/2000/svg","g");ge.setAttributeNS(null,"transform","translate(6.0, 7.0)"),ge.setAttributeNS(null,"fill","#FFFFFF");let Ee=Dt.createNS("http://www.w3.org/2000/svg","g");Ee.setAttributeNS(null,"transform","translate(8.0, 8.0)");let tt=Dt.createNS("http://www.w3.org/2000/svg","circle");tt.setAttributeNS(null,"fill","#000000"),tt.setAttributeNS(null,"opacity","0.25"),tt.setAttributeNS(null,"cx","5.5"),tt.setAttributeNS(null,"cy","5.5"),tt.setAttributeNS(null,"r","5.4999962");let Xe=Dt.createNS("http://www.w3.org/2000/svg","circle");Xe.setAttributeNS(null,"fill","#FFFFFF"),Xe.setAttributeNS(null,"cx","5.5"),Xe.setAttributeNS(null,"cy","5.5"),Xe.setAttributeNS(null,"r","5.4999962"),Ee.appendChild(tt),Ee.appendChild(Xe),k.appendChild(j),k.appendChild(J),k.appendChild(pe),k.appendChild(ge),k.appendChild(Ee),h.appendChild(k),h.setAttributeNS(null,"height",x*this._scale+"px"),h.setAttributeNS(null,"width",w*this._scale+"px"),this._element.appendChild(h),this._offset=t.P.convert(r&&r.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",h=>{h.preventDefault()}),this._element.addEventListener("mousedown",h=>{h.preventDefault()}),Wo(this._element,this._anchor,"marker"),r&&r.className)for(let h of r.className.split(" "))this._element.classList.add(h);this._popup=null}addTo(r){return this.remove(),this._map=r,this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label",r._getUIString("Marker.Title")),r.getCanvasContainer().appendChild(this._element),r.on("move",this._update),r.on("moveend",this._update),r.on("terrain",this._update),r.on("projectiontransition",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("terrain",this._update),this._map.off("projectiontransition",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),Dt.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(r){return this._lngLat=t.S.convert(r),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(r){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),r){if(!("offset"in r.options)){let w=Math.abs(13.5)/Math.SQRT2;r.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[w,-1*(38.1-13.5+w)],"bottom-right":[-w,-1*(38.1-13.5+w)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=r,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}setSubpixelPositioning(r){return this._subpixelPositioning=r,this}getPopup(){return this._popup}togglePopup(){let r=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:r?(r.isOpen()?r.remove():(r.setLngLat(this._lngLat),r.addTo(this._map)),this):this}_updateOpacity(r=!1){var h,x;let w=(h=this._map)===null||h===void 0?void 0:h.terrain,A=this._map.transform.isLocationOccluded(this._lngLat);if(!w||A){let ge=A?this._opacityWhenCovered:this._opacity;return void(this._element.style.opacity!==ge&&(this._element.style.opacity=ge))}if(r)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout(()=>{this._opacityTimeout=null},100)}let k=this._map,j=k.terrain.depthAtPoint(this._pos),q=k.terrain.getElevationForLngLatZoom(this._lngLat,k.transform.tileZoom);if(k.transform.lngLatToCameraDepth(this._lngLat,q)-j<.006)return void(this._element.style.opacity=this._opacity);let J=-this._offset.y/k.transform.pixelsPerMeter,ne=Math.sin(k.getPitch()*Math.PI/180)*J,pe=k.terrain.depthAtPoint(new t.P(this._pos.x,this._pos.y-this._offset.y)),ue=k.transform.lngLatToCameraDepth(this._lngLat,q+ne)-pe>.006;!((x=this._popup)===null||x===void 0)&&x.isOpen()&&ue&&this._popup.remove(),this._element.style.opacity=ue?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(r){return this._offset=t.P.convert(r),this._update(),this}addClassName(r){this._element.classList.add(r)}removeClassName(r){this._element.classList.remove(r)}toggleClassName(r){return this._element.classList.toggle(r)}setDraggable(r){return this._draggable=!!r,this._map&&(r?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(r){return this._rotation=r||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(r){return this._rotationAlignment=r||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(r){return this._pitchAlignment=r&&r!=="auto"?r:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(r,h){return(this._opacity===void 0||r===void 0&&h===void 0)&&(this._opacity="1",this._opacityWhenCovered="0.2"),r!==void 0&&(this._opacity=r),h!==void 0&&(this._opacityWhenCovered=h),this._map&&this._updateOpacity(!0),this}}let ff={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0},Ul=0,xh=!1,mf={maxWidth:100,unit:"metric"};function Qd(M,r,h){let x=h&&h.maxWidth||100,w=M._container.clientHeight/2,A=M._container.clientWidth/2,k=M.unproject([A-x/2,w]),j=M.unproject([A+x/2,w]),q=Math.round(M.project(j).x-M.project(k).x),J=Math.min(x,q,M._container.clientWidth),ne=k.distanceTo(j);if(h&&h.unit==="imperial"){let pe=3.2808*ne;pe>5280?Tu(r,J,pe/5280,M._getUIString("ScaleControl.Miles")):Tu(r,J,pe,M._getUIString("ScaleControl.Feet"))}else h&&h.unit==="nautical"?Tu(r,J,ne/1852,M._getUIString("ScaleControl.NauticalMiles")):ne>=1e3?Tu(r,J,ne/1e3,M._getUIString("ScaleControl.Kilometers")):Tu(r,J,ne,M._getUIString("ScaleControl.Meters"))}function Tu(M,r,h,x){let w=function(A){let k=Math.pow(10,`${Math.floor(A)}`.length-1),j=A/k;return j=j>=10?10:j>=5?5:j>=3?3:j>=2?2:j>=1?1:function(q){let J=Math.pow(10,Math.ceil(-Math.log(q)/Math.LN10));return Math.round(q*J)/J}(j),k*j}(h);M.style.width=r*(w/h)+"px",M.innerHTML=`${w}&nbsp;${x}`}let ep={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1,locationOccludedOpacity:void 0},tp=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function rd(M){if(M){if(typeof M=="number"){let r=Math.round(Math.abs(M)/Math.SQRT2);return{center:new t.P(0,0),top:new t.P(0,M),"top-left":new t.P(r,r),"top-right":new t.P(-r,r),bottom:new t.P(0,-M),"bottom-left":new t.P(r,-r),"bottom-right":new t.P(-r,-r),left:new t.P(M,0),right:new t.P(-M,0)}}if(M instanceof t.P||Array.isArray(M)){let r=t.P.convert(M);return{center:r,top:r,"top-left":r,"top-right":r,bottom:r,"bottom-left":r,"bottom-right":r,left:r,right:r}}return{center:t.P.convert(M.center||[0,0]),top:t.P.convert(M.top||[0,0]),"top-left":t.P.convert(M["top-left"]||[0,0]),"top-right":t.P.convert(M["top-right"]||[0,0]),bottom:t.P.convert(M.bottom||[0,0]),"bottom-left":t.P.convert(M["bottom-left"]||[0,0]),"bottom-right":t.P.convert(M["bottom-right"]||[0,0]),left:t.P.convert(M.left||[0,0]),right:t.P.convert(M.right||[0,0])}}return rd(new t.P(0,0))}let ip=at;O.AJAXError=t.cy,O.Event=t.l,O.Evented=t.E,O.LngLat=t.S,O.MercatorCoordinate=t.a0,O.Point=t.P,O.addProtocol=t.cz,O.config=t.a,O.removeProtocol=t.cA,O.AttributionControl=mh,O.BoxZoomHandler=Hu,O.CanvasSource=Wa,O.CooperativeGesturesHandler=Uh,O.DoubleClickZoomHandler=Xd,O.DragPanHandler=Qu,O.DragRotateHandler=Kd,O.EdgeInsets=Uo,O.FullscreenControl=class extends t.E{constructor(M={}){super(),this._onFullscreenChange=()=>{var r;let h=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((r=h?.shadowRoot)===null||r===void 0)&&r.fullscreenElement;)h=h.shadowRoot.fullscreenElement;h===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,M&&M.container&&(M.container instanceof HTMLElement?this._container=M.container:t.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(M){return this._map=M,this._container||(this._container=this._map.getContainer()),this._controlContainer=Dt.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){Dt.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){let M=this._fullscreenButton=Dt.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);Dt.create("span","maplibregl-ctrl-icon",M).setAttribute("aria-hidden","true"),M.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){let M=this._getTitle();this._fullscreenButton.setAttribute("aria-label",M),this._fullscreenButton.title=M}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new t.l("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new t.l("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},O.GeoJSONSource=Fs,O.GeolocateControl=class extends t.E{constructor(M){super(),this._onSuccess=r=>{if(this._map){if(this._isOutOfMapMaxBounds(r))return this._setErrorState(),this.fire(new t.l("outofmaxbounds",r)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=r,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(r),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(r),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new t.l("geolocate",r)),this._finish()}},this._updateCamera=r=>{let h=new t.S(r.coords.longitude,r.coords.latitude),x=r.coords.accuracy,w=this._map.getBearing(),A=t.e({bearing:w},this.options.fitBoundsOptions),k=hr.fromLngLat(h,x);this._map.fitBounds(k,A,{geolocateSource:!0})},this._updateMarker=r=>{if(r){let h=new t.S(r.coords.longitude,r.coords.latitude);this._accuracyCircleMarker.setLngLat(h).addTo(this._map),this._userLocationDotMarker.setLngLat(h).addTo(this._map),this._accuracy=r.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onZoom=()=>{this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()},this._onError=r=>{if(this._map){if(r.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;let h=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=h,this._geolocateButton.setAttribute("aria-label",h),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(r.code===3&&xh)return;this.options.trackUserLocation&&this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new t.l("error",r)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=()=>{this._map&&(this._container.addEventListener("contextmenu",r=>r.preventDefault()),this._geolocateButton=Dt.create("button","maplibregl-ctrl-geolocate",this._container),Dt.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",this._geolocateButton.disabled=!0)},this._finishSetupUI=r=>{if(this._map){if(r===!1){t.w("Geolocation support is not available so the GeolocateControl will be disabled.");let h=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=h,this._geolocateButton.setAttribute("aria-label",h)}else{let h=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.disabled=!1,this._geolocateButton.title=h,this._geolocateButton.setAttribute("aria-label",h)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=Dt.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new ys({element:this._dotElement}),this._circleElement=Dt.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new ys({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",()=>this.trigger()),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",h=>{h.geolocateSource||this._watchState!=="ACTIVE_LOCK"||h.originalEvent&&h.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new t.l("trackuserlocationend")),this.fire(new t.l("userlocationlostfocus")))})}},this.options=t.e({},ff,M)}onAdd(M){return this._map=M,this._container=Dt.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),function(){return t._(this,arguments,void 0,function*(r=!1){if(ds!==void 0&&!r)return ds;if(window.navigator.permissions===void 0)return ds=!!window.navigator.geolocation,ds;try{ds=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{ds=!!window.navigator.geolocation}return ds})}().then(r=>this._finishSetupUI(r)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),Dt.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,Ul=0,xh=!1}_isOutOfMapMaxBounds(M){let r=this._map.getMaxBounds(),h=M.coords;return r&&(h.longitude<r.getWest()||h.longitude>r.getEast()||h.latitude<r.getSouth()||h.latitude>r.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadius(){let M=this._map.getBounds(),r=M.getSouthEast(),h=M.getNorthEast(),x=r.distanceTo(h),w=Math.ceil(this._accuracy/(x/this._map._container.clientHeight)*2);this._circleElement.style.width=`${w}px`,this._circleElement.style.height=`${w}px`}trigger(){if(!this._setup)return t.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new t.l("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Ul--,xh=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new t.l("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new t.l("trackuserlocationstart")),this.fire(new t.l("userlocationfocus"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let M;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Ul++,Ul>1?(M={maximumAge:6e5,timeout:0},xh=!0):(M=this.options.positionOptions,xh=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,M)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},O.GlobeControl=class{constructor(){this._toggleProjection=()=>{var M;let r=(M=this._map.getProjection())===null||M===void 0?void 0:M.type;this._map.setProjection(r!=="mercator"&&r?{type:"mercator"}:{type:"globe"}),this._updateGlobeIcon()},this._updateGlobeIcon=()=>{var M;this._globeButton.classList.remove("maplibregl-ctrl-globe"),this._globeButton.classList.remove("maplibregl-ctrl-globe-enabled"),((M=this._map.getProjection())===null||M===void 0?void 0:M.type)==="globe"?(this._globeButton.classList.add("maplibregl-ctrl-globe-enabled"),this._globeButton.title=this._map._getUIString("GlobeControl.Disable")):(this._globeButton.classList.add("maplibregl-ctrl-globe"),this._globeButton.title=this._map._getUIString("GlobeControl.Enable"))}}onAdd(M){return this._map=M,this._container=Dt.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._globeButton=Dt.create("button","maplibregl-ctrl-globe",this._container),Dt.create("span","maplibregl-ctrl-icon",this._globeButton).setAttribute("aria-hidden","true"),this._globeButton.type="button",this._globeButton.addEventListener("click",this._toggleProjection),this._updateGlobeIcon(),this._map.on("styledata",this._updateGlobeIcon),this._container}onRemove(){Dt.remove(this._container),this._map.off("styledata",this._updateGlobeIcon),this._globeButton.removeEventListener("click",this._toggleProjection),this._map=void 0}},O.Hash=Nd,O.ImageSource=Vo,O.KeyboardHandler=gl,O.LngLatBounds=hr,O.LogoControl=_h,O.Map=class extends jo{constructor(M){var r,h;t.cv.mark(t.cw.create);let x=Object.assign(Object.assign(Object.assign({},Ei),M),{canvasContextAttributes:Object.assign(Object.assign({},Ei.canvasContextAttributes),M.canvasContextAttributes)});if(x.minZoom!=null&&x.maxZoom!=null&&x.minZoom>x.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(x.minPitch!=null&&x.maxPitch!=null&&x.minPitch>x.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(x.minPitch!=null&&x.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(x.maxPitch!=null&&x.maxPitch>180)throw new Error("maxPitch must be less than or equal to 180");let w=new wn,A=new Ed;if(x.minZoom!==void 0&&w.setMinZoom(x.minZoom),x.maxZoom!==void 0&&w.setMaxZoom(x.maxZoom),x.minPitch!==void 0&&w.setMinPitch(x.minPitch),x.maxPitch!==void 0&&w.setMaxPitch(x.maxPitch),x.renderWorldCopies!==void 0&&w.setRenderWorldCopies(x.renderWorldCopies),super(w,A,{bearingSnap:x.bearingSnap}),this._idleTriggered=!1,this._crossFadingFactor=1,this._renderTaskQueue=new bu,this._controls=[],this._mapId=t.a6(),this._contextLost=j=>{j.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.fire(new t.l("webglcontextlost",{originalEvent:j}))},this._contextRestored=j=>{this._setupPainter(),this.resize(),this._update(),this.fire(new t.l("webglcontextrestored",{originalEvent:j}))},this._onMapScroll=j=>{if(j.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=x.interactive,this._maxTileCacheSize=x.maxTileCacheSize,this._maxTileCacheZoomLevels=x.maxTileCacheZoomLevels,this._canvasContextAttributes=Object.assign({},x.canvasContextAttributes),this._trackResize=x.trackResize===!0,this._bearingSnap=x.bearingSnap,this._centerClampedToGround=x.centerClampedToGround,this._refreshExpiredTiles=x.refreshExpiredTiles===!0,this._fadeDuration=x.fadeDuration,this._crossSourceCollisions=x.crossSourceCollisions===!0,this._collectResourceTiming=x.collectResourceTiming===!0,this._locale=Object.assign(Object.assign({},gh),x.locale),this._clickTolerance=x.clickTolerance,this._overridePixelRatio=x.pixelRatio,this._maxCanvasSize=x.maxCanvasSize,this.transformCameraUpdate=x.transformCameraUpdate,this.cancelPendingTileRequestsWhileZooming=x.cancelPendingTileRequestsWhileZooming===!0,this._imageQueueHandle=qo.addThrottleControl(()=>this.isMoving()),this._requestManager=new to(x.transformRequest),typeof x.container=="string"){if(this._container=document.getElementById(x.container),!this._container)throw new Error(`Container '${x.container}' not found.`)}else{if(!(x.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=x.container}if(x.maxBounds&&this.setMaxBounds(x.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this.on("terrain",()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)}),this.once("idle",()=>{this._idleTriggered=!0}),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let j=!1,q=Wu(J=>{this._trackResize&&!this._removed&&(this.resize(J),this.redraw())},50);this._resizeObserver=new ResizeObserver(J=>{j?q(J):j=!0}),this._resizeObserver.observe(this._container)}this.handlers=new jh(this,x),this._hash=x.hash&&new Nd(typeof x.hash=="string"&&x.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:x.center,elevation:x.elevation,zoom:x.zoom,bearing:x.bearing,pitch:x.pitch,roll:x.roll}),x.bounds&&(this.resize(),this.fitBounds(x.bounds,t.e({},x.fitBoundsOptions,{duration:0}))));let k=typeof x.style=="string"||((h=(r=x.style)===null||r===void 0?void 0:r.projection)===null||h===void 0?void 0:h.type)!=="globe";this.resize(null,k),this._localIdeographFontFamily=x.localIdeographFontFamily,this._validateStyle=x.validateStyle,x.style&&this.setStyle(x.style,{localIdeographFontFamily:x.localIdeographFontFamily}),x.attributionControl&&this.addControl(new mh(typeof x.attributionControl=="boolean"?void 0:x.attributionControl)),x.maplibreLogo&&this.addControl(new _h,x.logoPosition),this.on("style.load",()=>{if(k||this._resizeTransform(),this.transform.unmodified){let j=t.Q(this.style.stylesheet,["center","zoom","bearing","pitch","roll"]);this.jumpTo(j)}}),this.on("data",j=>{this._update(j.dataType==="style"),this.fire(new t.l(`${j.dataType}data`,j))}),this.on("dataloading",j=>{this.fire(new t.l(`${j.dataType}dataloading`,j))}),this.on("dataabort",j=>{this.fire(new t.l("sourcedataabort",j))})}_getMapId(){return this._mapId}setGlobalStateProperty(M,r){return this.style.setGlobalStateProperty(M,r),this._update(!0)}getGlobalState(){return this.style.getGlobalState()}addControl(M,r){if(r===void 0&&(r=M.getDefaultPosition?M.getDefaultPosition():"top-right"),!M||!M.onAdd)return this.fire(new t.k(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));let h=M.onAdd(this);this._controls.push(M);let x=this._controlPositions[r];return r.indexOf("bottom")!==-1?x.insertBefore(h,x.firstChild):x.appendChild(h),this}removeControl(M){if(!M||!M.onRemove)return this.fire(new t.k(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));let r=this._controls.indexOf(M);return r>-1&&this._controls.splice(r,1),M.onRemove(this),this}hasControl(M){return this._controls.indexOf(M)>-1}calculateCameraOptionsFromTo(M,r,h,x){return x==null&&this.terrain&&(x=this.terrain.getElevationForLngLatZoom(h,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(M,r,h,x)}resize(M,r=!0){let[h,x]=this._containerDimensions(),w=this._getClampedPixelRatio(h,x);if(this._resizeCanvas(h,x,w),this.painter.resize(h,x,w),this.painter.overLimit()){let k=this.painter.context.gl;this._maxCanvasSize=[k.drawingBufferWidth,k.drawingBufferHeight];let j=this._getClampedPixelRatio(h,x);this._resizeCanvas(h,x,j),this.painter.resize(h,x,j)}this._resizeTransform(r);let A=!this._moving;return A&&(this.stop(),this.fire(new t.l("movestart",M)).fire(new t.l("move",M))),this.fire(new t.l("resize",M)),A&&this.fire(new t.l("moveend",M)),this}_resizeTransform(M=!0){var r;let[h,x]=this._containerDimensions();this.transform.resize(h,x,M),(r=this._requestedCameraState)===null||r===void 0||r.resize(h,x,M)}_getClampedPixelRatio(M,r){let{0:h,1:x}=this._maxCanvasSize,w=this.getPixelRatio(),A=M*w,k=r*w;return Math.min(A>h?h/A:1,k>x?x/k:1)*w}getPixelRatio(){var M;return(M=this._overridePixelRatio)!==null&&M!==void 0?M:devicePixelRatio}setPixelRatio(M){this._overridePixelRatio=M,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(M){return this.transform.setMaxBounds(hr.convert(M)),this._update()}setMinZoom(M){if((M=M??-2)>=-2&&M<=this.transform.maxZoom)return this.transform.setMinZoom(M),this._update(),this.getZoom()<M&&this.setZoom(M),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(M){if((M=M??22)>=this.transform.minZoom)return this.transform.setMaxZoom(M),this._update(),this.getZoom()>M&&this.setZoom(M),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(M){if((M=M??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(M>=0&&M<=this.transform.maxPitch)return this.transform.setMinPitch(M),this._update(),this.getPitch()<M&&this.setPitch(M),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(M){if((M=M??60)>180)throw new Error("maxPitch must be less than or equal to 180");if(M>=this.transform.minPitch)return this.transform.setMaxPitch(M),this._update(),this.getPitch()>M&&this.setPitch(M),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(M){return this.transform.setRenderWorldCopies(M),this._update()}project(M){return this.transform.locationToScreenPoint(t.S.convert(M),this.style&&this.terrain)}unproject(M){return this.transform.screenPointToLocation(t.P.convert(M),this.terrain)}isMoving(){var M;return this._moving||((M=this.handlers)===null||M===void 0?void 0:M.isMoving())}isZooming(){var M;return this._zooming||((M=this.handlers)===null||M===void 0?void 0:M.isZooming())}isRotating(){var M;return this._rotating||((M=this.handlers)===null||M===void 0?void 0:M.isRotating())}_createDelegatedListener(M,r,h){if(M==="mouseenter"||M==="mouseover"){let x=!1;return{layers:r,listener:h,delegates:{mousemove:A=>{let k=r.filter(q=>this.getLayer(q)),j=k.length!==0?this.queryRenderedFeatures(A.point,{layers:k}):[];j.length?x||(x=!0,h.call(this,new Ja(M,this,A.originalEvent,{features:j}))):x=!1},mouseout:()=>{x=!1}}}}if(M==="mouseleave"||M==="mouseout"){let x=!1;return{layers:r,listener:h,delegates:{mousemove:k=>{let j=r.filter(q=>this.getLayer(q));(j.length!==0?this.queryRenderedFeatures(k.point,{layers:j}):[]).length?x=!0:x&&(x=!1,h.call(this,new Ja(M,this,k.originalEvent)))},mouseout:k=>{x&&(x=!1,h.call(this,new Ja(M,this,k.originalEvent)))}}}}{let x=w=>{let A=r.filter(j=>this.getLayer(j)),k=A.length!==0?this.queryRenderedFeatures(w.point,{layers:A}):[];k.length&&(w.features=k,h.call(this,w),delete w.features)};return{layers:r,listener:h,delegates:{[M]:x}}}}_saveDelegatedListener(M,r){this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[M]=this._delegatedListeners[M]||[],this._delegatedListeners[M].push(r)}_removeDelegatedListener(M,r,h){if(!this._delegatedListeners||!this._delegatedListeners[M])return;let x=this._delegatedListeners[M];for(let w=0;w<x.length;w++){let A=x[w];if(A.listener===h&&A.layers.length===r.length&&A.layers.every(k=>r.includes(k))){for(let k in A.delegates)this.off(k,A.delegates[k]);return void x.splice(w,1)}}}on(M,r,h){if(h===void 0)return super.on(M,r);let x=typeof r=="string"?[r]:r,w=this._createDelegatedListener(M,x,h);this._saveDelegatedListener(M,w);for(let A in w.delegates)this.on(A,w.delegates[A]);return{unsubscribe:()=>{this._removeDelegatedListener(M,x,h)}}}once(M,r,h){if(h===void 0)return super.once(M,r);let x=typeof r=="string"?[r]:r,w=this._createDelegatedListener(M,x,h);for(let A in w.delegates){let k=w.delegates[A];w.delegates[A]=(...j)=>{this._removeDelegatedListener(M,x,h),k(...j)}}this._saveDelegatedListener(M,w);for(let A in w.delegates)this.once(A,w.delegates[A]);return this}off(M,r,h){return h===void 0?super.off(M,r):(this._removeDelegatedListener(M,typeof r=="string"?[r]:r,h),this)}queryRenderedFeatures(M,r){if(!this.style)return[];let h,x=M instanceof t.P||Array.isArray(M),w=x?M:[[0,0],[this.transform.width,this.transform.height]];if(r=r||(x?{}:M)||{},w instanceof t.P||typeof w[0]=="number")h=[t.P.convert(w)];else{let A=t.P.convert(w[0]),k=t.P.convert(w[1]);h=[A,new t.P(k.x,A.y),k,new t.P(A.x,k.y),A]}return this.style.queryRenderedFeatures(h,r,this.transform)}querySourceFeatures(M,r){return this.style.querySourceFeatures(M,r)}setStyle(M,r){return(r=t.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},r)).diff!==!1&&r.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&M?(this._diffStyle(M,r),this):(this._localIdeographFontFamily=r.localIdeographFontFamily,this._updateStyle(M,r))}setTransformRequest(M){return this._requestManager.setTransformRequest(M),this}_getUIString(M){let r=this._locale[M];if(r==null)throw new Error(`Missing UI string '${M}'`);return r}_updateStyle(M,r){var h,x;if(r.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",()=>this._updateStyle(M,r));let w=this.style&&r.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!M)),M?(this.style=new lu(this,r||{}),this.style.setEventedParent(this,{style:this.style}),typeof M=="string"?this.style.loadURL(M,r,w):this.style.loadJSON(M,r,w),this):((x=(h=this.style)===null||h===void 0?void 0:h.projection)===null||x===void 0||x.destroy(),delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new lu(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(M,r){if(typeof M=="string"){let h=this._requestManager.transformRequest(M,"Style");t.j(h,new AbortController).then(x=>{this._updateDiff(x.data,r)}).catch(x=>{x&&this.fire(new t.k(x))})}else typeof M=="object"&&this._updateDiff(M,r)}_updateDiff(M,r){try{this.style.setState(M,r)&&this._update(!0)}catch(h){t.w(`Unable to perform style diff: ${h.message||h.error||h}.  Rebuilding the style from scratch.`),this._updateStyle(M,r)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():t.w("There is no style added to the map.")}addSource(M,r){return this._lazyInitEmptyStyle(),this.style.addSource(M,r),this._update(!0)}isSourceLoaded(M){let r=this.style&&this.style.sourceCaches[M];if(r!==void 0)return r.loaded();this.fire(new t.k(new Error(`There is no source with ID '${M}'`)))}setTerrain(M){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),M){let r=this.style.sourceCaches[M.source];if(!r)throw new Error(`cannot load terrain, because there exists no source with ID: ${M.source}`);this.terrain===null&&r.reload();for(let h in this.style._layers){let x=this.style._layers[h];x.type==="hillshade"&&x.source===M.source&&t.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality."),x.type==="color-relief"&&x.source===M.source&&t.w("You are using the same source for a color-relief layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new yl(this.painter,r,M),this.painter.renderToTexture=new jn(this.painter,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._terrainDataCallback=h=>{var x;h.dataType==="style"?this.terrain.sourceCache.freeRtt():h.dataType==="source"&&h.tile&&(h.sourceId!==M.source||this._elevationFreeze||(this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))),((x=h.source)===null||x===void 0?void 0:x.type)==="image"?this.terrain.sourceCache.freeRtt():this.terrain.sourceCache.freeRtt(h.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0);return this.fire(new t.l("terrain",{terrain:M})),this}getTerrain(){var M,r;return(r=(M=this.terrain)===null||M===void 0?void 0:M.options)!==null&&r!==void 0?r:null}areTilesLoaded(){let M=this.style&&this.style.sourceCaches;for(let r in M){let h=M[r]._tiles;for(let x in h){let w=h[x];if(w.state!=="loaded"&&w.state!=="errored")return!1}}return!0}removeSource(M){return this.style.removeSource(M),this._update(!0)}getSource(M){return this.style.getSource(M)}setSourceTileLodParams(M,r,h){if(h){let x=this.getSource(h);if(!x)throw new Error(`There is no source with ID "${h}", cannot set LOD parameters`);x.calculateTileZoom=Xt(Math.max(1,M),Math.max(1,r))}else for(let x in this.style.sourceCaches)this.style.sourceCaches[x].getSource().calculateTileZoom=Xt(Math.max(1,M),Math.max(1,r));return this._update(!0),this}refreshTiles(M,r){let h=this.style.sourceCaches[M];if(!h)throw new Error(`There is no source cache with ID "${M}", cannot refresh tile`);r===void 0?h.reload(!0):h.refreshTiles(r.map(x=>new t.a3(x.z,x.x,x.y)))}addImage(M,r,h={}){let{pixelRatio:x=1,sdf:w=!1,stretchX:A,stretchY:k,content:j,textFitWidth:q,textFitHeight:J}=h;if(this._lazyInitEmptyStyle(),!(r instanceof HTMLImageElement||t.b(r))){if(r.width===void 0||r.height===void 0)return this.fire(new t.k(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{let{width:ne,height:pe,data:ue}=r,ge=r;return this.style.addImage(M,{data:new t.R({width:ne,height:pe},new Uint8Array(ue)),pixelRatio:x,stretchX:A,stretchY:k,content:j,textFitWidth:q,textFitHeight:J,sdf:w,version:0,userImage:ge}),ge.onAdd&&ge.onAdd(this,M),this}}{let{width:ne,height:pe,data:ue}=an.getImageData(r);this.style.addImage(M,{data:new t.R({width:ne,height:pe},ue),pixelRatio:x,stretchX:A,stretchY:k,content:j,textFitWidth:q,textFitHeight:J,sdf:w,version:0})}}updateImage(M,r){let h=this.style.getImage(M);if(!h)return this.fire(new t.k(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));let x=r instanceof HTMLImageElement||t.b(r)?an.getImageData(r):r,{width:w,height:A,data:k}=x;if(w===void 0||A===void 0)return this.fire(new t.k(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(w!==h.data.width||A!==h.data.height)return this.fire(new t.k(new Error("The width and height of the updated image must be that same as the previous version of the image")));let j=!(r instanceof HTMLImageElement||t.b(r));return h.data.replace(k,j),this.style.updateImage(M,h),this}getImage(M){return this.style.getImage(M)}hasImage(M){return M?!!this.style.getImage(M):(this.fire(new t.k(new Error("Missing required image id"))),!1)}removeImage(M){this.style.removeImage(M)}loadImage(M){return qo.getImage(this._requestManager.transformRequest(M,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(M,r){return this._lazyInitEmptyStyle(),this.style.addLayer(M,r),this._update(!0)}moveLayer(M,r){return this.style.moveLayer(M,r),this._update(!0)}removeLayer(M){return this.style.removeLayer(M),this._update(!0)}getLayer(M){return this.style.getLayer(M)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(M,r,h){return this.style.setLayerZoomRange(M,r,h),this._update(!0)}setFilter(M,r,h={}){return this.style.setFilter(M,r,h),this._update(!0)}getFilter(M){return this.style.getFilter(M)}setPaintProperty(M,r,h,x={}){return this.style.setPaintProperty(M,r,h,x),this._update(!0)}getPaintProperty(M,r){return this.style.getPaintProperty(M,r)}setLayoutProperty(M,r,h,x={}){return this.style.setLayoutProperty(M,r,h,x),this._update(!0)}getLayoutProperty(M,r){return this.style.getLayoutProperty(M,r)}setGlyphs(M,r={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(M,r),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(M,r,h={}){return this._lazyInitEmptyStyle(),this.style.addSprite(M,r,h,x=>{x||this._update(!0)}),this}removeSprite(M){return this._lazyInitEmptyStyle(),this.style.removeSprite(M),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(M,r={}){return this._lazyInitEmptyStyle(),this.style.setSprite(M,r,h=>{h||this._update(!0)}),this}setLight(M,r={}){return this._lazyInitEmptyStyle(),this.style.setLight(M,r),this._update(!0)}getLight(){return this.style.getLight()}setSky(M,r={}){return this._lazyInitEmptyStyle(),this.style.setSky(M,r),this._update(!0)}getSky(){return this.style.getSky()}setFeatureState(M,r){return this.style.setFeatureState(M,r),this._update()}removeFeatureState(M,r){return this.style.removeFeatureState(M,r),this._update()}getFeatureState(M){return this.style.getFeatureState(M)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let M=0,r=0;return this._container&&(M=this._container.clientWidth||400,r=this._container.clientHeight||300),[M,r]}_setupContainer(){let M=this._container;M.classList.add("maplibregl-map");let r=this._canvasContainer=Dt.create("div","maplibregl-canvas-container",M);this._interactive&&r.classList.add("maplibregl-interactive"),this._canvas=Dt.create("canvas","maplibregl-canvas",r),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex",this._interactive?"0":"-1"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region");let h=this._containerDimensions(),x=this._getClampedPixelRatio(h[0],h[1]);this._resizeCanvas(h[0],h[1],x);let w=this._controlContainer=Dt.create("div","maplibregl-control-container",M),A=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(k=>{A[k]=Dt.create("div",`maplibregl-ctrl-${k} `,w)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(M,r,h){this._canvas.width=Math.floor(h*M),this._canvas.height=Math.floor(h*r),this._canvas.style.width=`${M}px`,this._canvas.style.height=`${r}px`}_setupPainter(){let M=Object.assign(Object.assign({},this._canvasContextAttributes),{alpha:!0,depth:!0,stencil:!0,premultipliedAlpha:!0}),r=null;this._canvas.addEventListener("webglcontextcreationerror",x=>{r={requestedAttributes:M},x&&(r.statusMessage=x.statusMessage,r.type=x.type)},{once:!0});let h=null;if(h=this._canvasContextAttributes.contextType?this._canvas.getContext(this._canvasContextAttributes.contextType,M):this._canvas.getContext("webgl2",M)||this._canvas.getContext("webgl",M),!h){let x="Failed to initialize WebGL";throw r?(r.message=x,new Error(JSON.stringify(r))):new Error(x)}this.painter=new Nl(h,this.transform),Wi.testSupport(h)}migrateProjection(M,r){super.migrateProjection(M,r),this.painter.transform=M,this.fire(new t.l("projectiontransition",{newProjection:this.style.projection.name}))}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(M){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||M,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(M){return this._update(),this._renderTaskQueue.add(M)}_cancelRenderFrame(M){this._renderTaskQueue.remove(M)}_render(M){var r,h,x,w,A;let k=this._idleTriggered?this._fadeDuration:0,j=((r=this.style.projection)===null||r===void 0?void 0:r.transitionState)>0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(M),this._removed)return;let q=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;let pe=this.transform.zoom,ue=an.now();this.style.zoomHistory.update(pe,ue);let ge=new t.F(pe,{now:ue,fadeDuration:k,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition(),globalState:this.style.getGlobalState()}),Ee=ge.crossFadingFactor();Ee===1&&Ee===this._crossFadingFactor||(q=!0,this._crossFadingFactor=Ee),this.style.update(ge)}let J=((h=this.style.projection)===null||h===void 0?void 0:h.transitionState)>0!==j;(x=this.style.projection)===null||x===void 0||x.setErrorQueryLatitudeDegrees(this.transform.center.lat),this.transform.setTransitionState((w=this.style.projection)===null||w===void 0?void 0:w.transitionState,(A=this.style.projection)===null||A===void 0?void 0:A.latitudeErrorCorrectionRadians),this.style&&(this._sourcesDirty||J)&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.sourceCache.update(this.transform,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),!this._elevationFreeze&&this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0)),this._placementDirty=this.style&&this.style._updatePlacement(this.transform,this.showCollisionBoxes,k,this._crossSourceCollisions,J),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:k,showPadding:this.showPadding}),this.fire(new t.l("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,t.cv.mark(t.cw.load),this.fire(new t.l("load"))),this.style&&(this.style.hasTransitions()||q)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();let ne=this._sourcesDirty||this._styleDirty||this._placementDirty;return ne||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new t.l("idle")),!this._loaded||this._fullyLoaded||ne||(this._fullyLoaded=!0,t.cv.mark(t.cw.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var M;this._hash&&this._hash.remove();for(let h of this._controls)h.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),qo.removeThrottleControl(this._imageQueueHandle),(M=this._resizeObserver)===null||M===void 0||M.disconnect();let r=this.painter.context.gl.getExtension("WEBGL_lose_context");r?.loseContext&&r.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),Dt.remove(this._canvasContainer),Dt.remove(this._controlContainer),this._container.removeEventListener("scroll",this._onMapScroll,!1),this._container.classList.remove("maplibregl-map"),t.cv.clearMetrics(),this._removed=!0,this.fire(new t.l("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,an.frame(this._frameRequest,M=>{t.cv.frame(M),this._frameRequest=null;try{this._render(M)}catch(r){if(!t.cx(r)&&!function(h){return h.message===hf}(r))throw r}},()=>{}))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(M){this._showTileBoundaries!==M&&(this._showTileBoundaries=M,this._update())}get showPadding(){return!!this._showPadding}set showPadding(M){this._showPadding!==M&&(this._showPadding=M,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(M){this._showCollisionBoxes!==M&&(this._showCollisionBoxes=M,M?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(M){this._showOverdrawInspector!==M&&(this._showOverdrawInspector=M,this._update())}get repaint(){return!!this._repaint}set repaint(M){this._repaint!==M&&(this._repaint=M,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(M){this._vertices=M,this._update()}get version(){return wu}getCameraTargetElevation(){return this.transform.elevation}getProjection(){return this.style.getProjection()}setProjection(M){return this._lazyInitEmptyStyle(),this.style.setProjection(M),this._update(!0)}},O.MapMouseEvent=Ja,O.MapTouchEvent=es,O.MapWheelEvent=yu,O.Marker=ys,O.NavigationControl=class{constructor(M){this._updateZoomButtons=()=>{let r=this._map.getZoom(),h=r===this._map.getMaxZoom(),x=r===this._map.getMinZoom();this._zoomInButton.disabled=h,this._zoomOutButton.disabled=x,this._zoomInButton.setAttribute("aria-disabled",h.toString()),this._zoomOutButton.setAttribute("aria-disabled",x.toString())},this._rotateCompassArrow=()=>{this._compassIcon.style.transform=this.options.visualizePitch&&this.options.visualizeRoll?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateZ(${-this._map.transform.roll}deg) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizeRoll?`rotate(${-this._map.transform.bearing-this._map.transform.roll}deg)`:`rotate(${-this._map.transform.bearing}deg)`},this._setButtonTitle=(r,h)=>{let x=this._map._getUIString(`NavigationControl.${h}`);r.title=x,r.setAttribute("aria-label",x)},this.options=t.e({},Qs,M),this._container=Dt.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",r=>r.preventDefault()),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",r=>this._map.zoomIn({},{originalEvent:r})),Dt.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",r=>this._map.zoomOut({},{originalEvent:r})),Dt.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",r=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:r}):this._map.resetNorth({},{originalEvent:r})}),this._compassIcon=Dt.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(M){return this._map=M,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.on("roll",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Zh(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){Dt.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.off("roll",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(M,r){let h=Dt.create("button",M,this._container);return h.type="button",h.addEventListener("click",r),h}},O.Popup=class extends t.E{constructor(M){super(),this._updateOpacity=()=>{this.options.locationOccludedOpacity!==void 0&&(this._container.style.opacity=this._map.transform.isLocationOccluded(this.getLngLat())?`${this.options.locationOccludedOpacity}`:void 0)},this.remove=()=>(this._content&&Dt.remove(this._content),this._container&&(Dt.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new t.l("close"))),this),this._onMouseUp=r=>{this._update(r.point)},this._onMouseMove=r=>{this._update(r.point)},this._onDrag=r=>{this._update(r.point)},this._update=r=>{if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=Dt.create("div","maplibregl-popup",this._map.getContainer()),this._tip=Dt.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(let k of this.options.className.split(" "))this._container.classList.add(k);this._closeButton&&this._closeButton.setAttribute("aria-label",this._map._getUIString("Popup.Close")),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=yh(this._lngLat,this._flatPos,this._map.transform,this._trackPointer),this._trackPointer&&!r)return;let h=this._flatPos=this._pos=this._trackPointer&&r?r:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&r?r:this._map.transform.locationToScreenPoint(this._lngLat));let x=this.options.anchor,w=rd(this.options.offset);if(!x){let k=this._container.offsetWidth,j=this._container.offsetHeight,q;q=h.y+w.bottom.y<j?["top"]:h.y>this._map.transform.height-j?["bottom"]:[],h.x<k/2?q.push("left"):h.x>this._map.transform.width-k/2&&q.push("right"),x=q.length===0?"bottom":q.join("-")}let A=h.add(w[x]);this.options.subpixelPositioning||(A=A.round()),Dt.setTransform(this._container,`${tn[x]} translate(${A.x}px,${A.y}px)`),Wo(this._container,x,"popup"),this._updateOpacity()},this._onClose=()=>{this.remove()},this.options=t.e(Object.create(ep),M)}addTo(M){return this._map&&this.remove(),this._map=M,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new t.l("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(M){return this._lngLat=t.S.convert(M),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(M){return this.setDOMContent(document.createTextNode(M))}setHTML(M){let r=document.createDocumentFragment(),h=document.createElement("body"),x;for(h.innerHTML=M;x=h.firstChild,x;)r.appendChild(x);return this.setDOMContent(r)}getMaxWidth(){var M;return(M=this._container)===null||M===void 0?void 0:M.style.maxWidth}setMaxWidth(M){return this.options.maxWidth=M,this._update(),this}setDOMContent(M){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=Dt.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(M),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(M){return this._container&&this._container.classList.add(M),this}removeClassName(M){return this._container&&this._container.classList.remove(M),this}setOffset(M){return this.options.offset=M,this._update(),this}toggleClassName(M){if(this._container)return this._container.classList.toggle(M)}setSubpixelPositioning(M){this.options.subpixelPositioning=M}_createCloseButton(){this.options.closeButton&&(this._closeButton=Dt.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;let M=this._container.querySelector(tp);M&&M.focus()}},O.RasterDEMTileSource=Jo,O.RasterTileSource=Cs,O.ScaleControl=class{constructor(M){this._onMove=()=>{Qd(this._map,this._container,this.options)},this.setUnit=r=>{this.options.unit=r,Qd(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},mf),M)}getDefaultPosition(){return"bottom-left"}onAdd(M){return this._map=M,this._container=Dt.create("div","maplibregl-ctrl maplibregl-ctrl-scale",M.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){Dt.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},O.ScrollZoomHandler=Hd,O.Style=lu,O.TerrainControl=class{constructor(M){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=M}onAdd(M){return this._map=M,this._container=Dt.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=Dt.create("button","maplibregl-ctrl-terrain",this._container),Dt.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){Dt.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},O.TwoFingersTouchPitchHandler=$d,O.TwoFingersTouchRotateHandler=Zp,O.TwoFingersTouchZoomHandler=hc,O.TwoFingersTouchZoomRotateHandler=ed,O.VectorTileSource=ra,O.VideoSource=ba,O.addSourceType=(M,r)=>t._(void 0,void 0,void 0,function*(){if(fl(M))throw new Error(`A source type called "${M}" already exists.`);((h,x)=>{pl[h]=x})(M,r)}),O.clearPrewarmedResources=function(){let M=Da;M&&(M.isPreloaded()&&M.numActive()===1?(M.release(Mr),Da=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},O.createTileMesh=za,O.getMaxParallelImageRequests=function(){return t.a.MAX_PARALLEL_IMAGE_REQUESTS},O.getRTLTextPluginStatus=function(){return Hs().getRTLTextPluginStatus()},O.getVersion=function(){return ip},O.getWorkerCount=function(){return as.workerCount},O.getWorkerUrl=function(){return t.a.WORKER_URL},O.importScriptInWorkers=function(M){return Co().broadcast("IS",M)},O.prewarm=function(){Lr().acquire(Mr)},O.setMaxParallelImageRequests=function(M){t.a.MAX_PARALLEL_IMAGE_REQUESTS=M},O.setRTLTextPlugin=function(M,r){return Hs().setRTLTextPlugin(M,r)},O.setWorkerCount=function(M){as.workerCount=M},O.setWorkerUrl=function(M){t.a.WORKER_URL=M}});var Y=oe;return Y})});var Tw=Pb((uv,dv)=>{(function(oe,Ht){typeof uv=="object"&&typeof dv<"u"?dv.exports=Ht():typeof define=="function"&&define.amd?define(Ht):(oe=typeof globalThis<"u"?globalThis:oe||self,oe.mapboxgl=Ht())})(uv,function(){"use strict";var oe,Ht,P;function Y(t,at){if(!oe)oe=at;else if(!Ht)Ht=at;else{var yi="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+oe+")(sharedChunk); ("+Ht+")(sharedChunk); self.onerror = null;",Cn={};oe(Cn),P=at(Cn),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(P.workerUrl=window.URL.createObjectURL(new Blob([yi],{type:"text/javascript"})))}}Y(["exports"],function(t){var at=1e-6,yi=typeof Float32Array<"u"?Float32Array:Array;function Cn(o,e){var n=e[0],l=e[1],c=e[2],m=e[3],_=n*m-c*l;return _?(o[0]=m*(_=1/_),o[1]=-l*_,o[2]=-c*_,o[3]=n*_,o):null}function _r(){var o=new yi(9);return yi!=Float32Array&&(o[1]=0,o[2]=0,o[3]=0,o[5]=0,o[6]=0,o[7]=0),o[0]=1,o[4]=1,o[8]=1,o}function an(o,e){var n=e[0],l=e[1],c=e[2],m=e[3],_=e[4],b=e[5],I=e[6],E=e[7],L=e[8];return o[0]=_*L-b*E,o[1]=c*E-l*L,o[2]=l*b-c*_,o[3]=b*I-m*L,o[4]=n*L-c*I,o[5]=c*m-n*b,o[6]=m*E-_*I,o[7]=l*I-n*E,o[8]=n*_-l*m,o}function Dt(o,e,n){var l=e[0],c=e[1],m=e[2],_=e[3],b=e[4],I=e[5],E=e[6],L=e[7],F=e[8],V=n[0],W=n[1],H=n[2],ee=n[3],le=n[4],de=n[5],Ce=n[6],we=n[7],ie=n[8];return o[0]=V*l+W*_+H*E,o[1]=V*c+W*b+H*L,o[2]=V*m+W*I+H*F,o[3]=ee*l+le*_+de*E,o[4]=ee*c+le*b+de*L,o[5]=ee*m+le*I+de*F,o[6]=Ce*l+we*_+ie*E,o[7]=Ce*c+we*b+ie*L,o[8]=Ce*m+we*I+ie*F,o}function Wi(){var o=new yi(16);return yi!=Float32Array&&(o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=0,o[12]=0,o[13]=0,o[14]=0),o[0]=1,o[5]=1,o[10]=1,o[15]=1,o}function on(o){return o[0]=1,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=1,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=1,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}function vn(o,e){var n=e[0],l=e[1],c=e[2],m=e[3],_=e[4],b=e[5],I=e[6],E=e[7],L=e[8],F=e[9],V=e[10],W=e[11],H=e[12],ee=e[13],le=e[14],de=e[15],Ce=n*b-l*_,we=n*I-c*_,ie=n*E-m*_,me=l*I-c*b,Ie=l*E-m*b,ze=c*E-m*I,Je=L*ee-F*H,st=L*le-V*H,ut=L*de-W*H,xt=F*le-V*ee,Ft=F*de-W*ee,ri=V*de-W*le,$t=Ce*ri-we*Ft+ie*xt+me*ut-Ie*st+ze*Je;return $t?(o[0]=(b*ri-I*Ft+E*xt)*($t=1/$t),o[1]=(c*Ft-l*ri-m*xt)*$t,o[2]=(ee*ze-le*Ie+de*me)*$t,o[3]=(V*Ie-F*ze-W*me)*$t,o[4]=(I*ut-_*ri-E*st)*$t,o[5]=(n*ri-c*ut+m*st)*$t,o[6]=(le*ie-H*ze-de*we)*$t,o[7]=(L*ze-V*ie+W*we)*$t,o[8]=(_*Ft-b*ut+E*Je)*$t,o[9]=(l*ut-n*Ft-m*Je)*$t,o[10]=(H*Ie-ee*ie+de*Ce)*$t,o[11]=(F*ie-L*Ie-W*Ce)*$t,o[12]=(b*st-_*xt-I*Je)*$t,o[13]=(n*xt-l*st+c*Je)*$t,o[14]=(ee*we-H*me-le*Ce)*$t,o[15]=(L*me-F*we+V*Ce)*$t,o):null}function gn(o,e,n){var l=e[0],c=e[1],m=e[2],_=e[3],b=e[4],I=e[5],E=e[6],L=e[7],F=e[8],V=e[9],W=e[10],H=e[11],ee=e[12],le=e[13],de=e[14],Ce=e[15],we=n[0],ie=n[1],me=n[2],Ie=n[3];return o[0]=we*l+ie*b+me*F+Ie*ee,o[1]=we*c+ie*I+me*V+Ie*le,o[2]=we*m+ie*E+me*W+Ie*de,o[3]=we*_+ie*L+me*H+Ie*Ce,o[4]=(we=n[4])*l+(ie=n[5])*b+(me=n[6])*F+(Ie=n[7])*ee,o[5]=we*c+ie*I+me*V+Ie*le,o[6]=we*m+ie*E+me*W+Ie*de,o[7]=we*_+ie*L+me*H+Ie*Ce,o[8]=(we=n[8])*l+(ie=n[9])*b+(me=n[10])*F+(Ie=n[11])*ee,o[9]=we*c+ie*I+me*V+Ie*le,o[10]=we*m+ie*E+me*W+Ie*de,o[11]=we*_+ie*L+me*H+Ie*Ce,o[12]=(we=n[12])*l+(ie=n[13])*b+(me=n[14])*F+(Ie=n[15])*ee,o[13]=we*c+ie*I+me*V+Ie*le,o[14]=we*m+ie*E+me*W+Ie*de,o[15]=we*_+ie*L+me*H+Ie*Ce,o}function vr(o,e,n){var l,c,m,_,b,I,E,L,F,V,W,H,ee=n[0],le=n[1],de=n[2];return e===o?(o[12]=e[0]*ee+e[4]*le+e[8]*de+e[12],o[13]=e[1]*ee+e[5]*le+e[9]*de+e[13],o[14]=e[2]*ee+e[6]*le+e[10]*de+e[14],o[15]=e[3]*ee+e[7]*le+e[11]*de+e[15]):(c=e[1],m=e[2],_=e[3],b=e[4],I=e[5],E=e[6],L=e[7],F=e[8],V=e[9],W=e[10],H=e[11],o[0]=l=e[0],o[1]=c,o[2]=m,o[3]=_,o[4]=b,o[5]=I,o[6]=E,o[7]=L,o[8]=F,o[9]=V,o[10]=W,o[11]=H,o[12]=l*ee+b*le+F*de+e[12],o[13]=c*ee+I*le+V*de+e[13],o[14]=m*ee+E*le+W*de+e[14],o[15]=_*ee+L*le+H*de+e[15]),o}function Bo(o,e,n){var l=n[0],c=n[1],m=n[2];return o[0]=e[0]*l,o[1]=e[1]*l,o[2]=e[2]*l,o[3]=e[3]*l,o[4]=e[4]*c,o[5]=e[5]*c,o[6]=e[6]*c,o[7]=e[7]*c,o[8]=e[8]*m,o[9]=e[9]*m,o[10]=e[10]*m,o[11]=e[11]*m,o[12]=e[12],o[13]=e[13],o[14]=e[14],o[15]=e[15],o}function qo(o,e,n){var l=Math.sin(n),c=Math.cos(n),m=e[4],_=e[5],b=e[6],I=e[7],E=e[8],L=e[9],F=e[10],V=e[11];return e!==o&&(o[0]=e[0],o[1]=e[1],o[2]=e[2],o[3]=e[3],o[12]=e[12],o[13]=e[13],o[14]=e[14],o[15]=e[15]),o[4]=m*c+E*l,o[5]=_*c+L*l,o[6]=b*c+F*l,o[7]=I*c+V*l,o[8]=E*c-m*l,o[9]=L*c-_*l,o[10]=F*c-b*l,o[11]=V*c-I*l,o}function to(o,e,n){var l=Math.sin(n),c=Math.cos(n),m=e[0],_=e[1],b=e[2],I=e[3],E=e[8],L=e[9],F=e[10],V=e[11];return e!==o&&(o[4]=e[4],o[5]=e[5],o[6]=e[6],o[7]=e[7],o[12]=e[12],o[13]=e[13],o[14]=e[14],o[15]=e[15]),o[0]=m*c-E*l,o[1]=_*c-L*l,o[2]=b*c-F*l,o[3]=I*c-V*l,o[8]=m*l+E*c,o[9]=_*l+L*c,o[10]=b*l+F*c,o[11]=I*l+V*c,o}function Br(o,e,n){var l=Math.sin(n),c=Math.cos(n),m=e[0],_=e[1],b=e[2],I=e[3],E=e[4],L=e[5],F=e[6],V=e[7];return e!==o&&(o[8]=e[8],o[9]=e[9],o[10]=e[10],o[11]=e[11],o[12]=e[12],o[13]=e[13],o[14]=e[14],o[15]=e[15]),o[0]=m*c+E*l,o[1]=_*c+L*l,o[2]=b*c+F*l,o[3]=I*c+V*l,o[4]=E*c-m*l,o[5]=L*c-_*l,o[6]=F*c-b*l,o[7]=V*c-I*l,o}function os(o,e){return o[0]=e[0],o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=e[1],o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=e[2],o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}function ga(o,e,n){var l,c,m,_=n[0],b=n[1],I=n[2],E=Math.hypot(_,b,I);return E<at?null:(_*=E=1/E,b*=E,I*=E,l=Math.sin(e),c=Math.cos(e),o[0]=_*_*(m=1-c)+c,o[1]=b*_*m+I*l,o[2]=I*_*m-b*l,o[3]=0,o[4]=_*b*m-I*l,o[5]=b*b*m+c,o[6]=I*b*m+_*l,o[7]=0,o[8]=_*I*m+b*l,o[9]=b*I*m-_*l,o[10]=I*I*m+c,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o)}function Aa(o,e){var n=e[0],l=e[1],c=e[2],m=e[3],_=n+n,b=l+l,I=c+c,E=n*_,L=l*_,F=l*b,V=c*_,W=c*b,H=c*I,ee=m*_,le=m*b,de=m*I;return o[0]=1-F-H,o[1]=L+de,o[2]=V-le,o[3]=0,o[4]=L-de,o[5]=1-E-H,o[6]=W+ee,o[7]=0,o[8]=V+le,o[9]=W-ee,o[10]=1-E-F,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o}Math.hypot||(Math.hypot=function(){for(var o=0,e=arguments.length;e--;)o+=arguments[e]*arguments[e];return Math.sqrt(o)});var Ql=gn;function Io(){var o=new yi(3);return yi!=Float32Array&&(o[0]=0,o[1]=0,o[2]=0),o}function qa(o){var e=new yi(3);return e[0]=o[0],e[1]=o[1],e[2]=o[2],e}function No(o){return Math.hypot(o[0],o[1],o[2])}function Ur(o,e,n){var l=new yi(3);return l[0]=o,l[1]=e,l[2]=n,l}function ho(o,e,n){return o[0]=e[0]+n[0],o[1]=e[1]+n[1],o[2]=e[2]+n[2],o}function ss(o,e,n){return o[0]=e[0]-n[0],o[1]=e[1]-n[1],o[2]=e[2]-n[2],o}function ya(o,e,n){return o[0]=e[0]*n[0],o[1]=e[1]*n[1],o[2]=e[2]*n[2],o}function dl(o,e,n){return o[0]=Math.min(e[0],n[0]),o[1]=Math.min(e[1],n[1]),o[2]=Math.min(e[2],n[2]),o}function $a(o,e,n){return o[0]=Math.max(e[0],n[0]),o[1]=Math.max(e[1],n[1]),o[2]=Math.max(e[2],n[2]),o}function Mr(o,e,n){return o[0]=e[0]*n,o[1]=e[1]*n,o[2]=e[2]*n,o}function as(o,e,n,l){return o[0]=e[0]+n[0]*l,o[1]=e[1]+n[1]*l,o[2]=e[2]+n[2]*l,o}function Hr(o,e){var n=e[0]-o[0],l=e[1]-o[1],c=e[2]-o[2];return n*n+l*l+c*c}function Da(o){var e=o[0],n=o[1],l=o[2];return e*e+n*n+l*l}function xa(o,e){return o[0]=-e[0],o[1]=-e[1],o[2]=-e[2],o}function Lr(o,e){var n=e[0],l=e[1],c=e[2],m=n*n+l*l+c*c;return m>0&&(m=1/Math.sqrt(m)),o[0]=e[0]*m,o[1]=e[1]*m,o[2]=e[2]*m,o}function jr(o,e){return o[0]*e[0]+o[1]*e[1]+o[2]*e[2]}function Co(o,e,n){var l=e[0],c=e[1],m=e[2],_=n[0],b=n[1],I=n[2];return o[0]=c*I-m*b,o[1]=m*_-l*I,o[2]=l*b-c*_,o}function $c(o,e,n,l){var c=e[0],m=e[1],_=e[2];return o[0]=c+l*(n[0]-c),o[1]=m+l*(n[1]-m),o[2]=_+l*(n[2]-_),o}function gr(o,e,n){var l=e[0],c=e[1],m=e[2],_=n[3]*l+n[7]*c+n[11]*m+n[15];return o[0]=(n[0]*l+n[4]*c+n[8]*m+n[12])/(_=_||1),o[1]=(n[1]*l+n[5]*c+n[9]*m+n[13])/_,o[2]=(n[2]*l+n[6]*c+n[10]*m+n[14])/_,o}function yc(o,e,n){var l=e[0],c=e[1],m=e[2];return o[0]=l*n[0]+c*n[3]+m*n[6],o[1]=l*n[1]+c*n[4]+m*n[7],o[2]=l*n[2]+c*n[5]+m*n[8],o}function Os(o,e,n){var l=n[0],c=n[1],m=n[2],_=e[0],b=e[1],I=e[2],E=c*I-m*b,L=m*_-l*I,F=l*b-c*_,V=c*F-m*L,W=m*E-l*F,H=l*L-c*E,ee=2*n[3];return L*=ee,F*=ee,W*=2,H*=2,o[0]=_+(E*=ee)+(V*=2),o[1]=b+L+W,o[2]=I+F+H,o}function va(o,e){return o[0]===e[0]&&o[1]===e[1]&&o[2]===e[2]}var hr=ss,Cl=ya,ra=No;function Cs(){var o=new yi(4);return yi!=Float32Array&&(o[0]=0,o[1]=0,o[2]=0,o[3]=0),o}function Jo(o,e,n){return o[0]=e[0]*n,o[1]=e[1]*n,o[2]=e[2]*n,o[3]=e[3]*n,o}function Fs(o,e){var n=e[0],l=e[1],c=e[2],m=e[3],_=n*n+l*l+c*c+m*m;return _>0&&(_=1/Math.sqrt(_)),o[0]=n*_,o[1]=l*_,o[2]=c*_,o[3]=m*_,o}function Vo(o,e,n){var l=e[0],c=e[1],m=e[2],_=e[3];return o[0]=n[0]*l+n[4]*c+n[8]*m+n[12]*_,o[1]=n[1]*l+n[5]*c+n[9]*m+n[13]*_,o[2]=n[2]*l+n[6]*c+n[10]*m+n[14]*_,o[3]=n[3]*l+n[7]*c+n[11]*m+n[15]*_,o}function ba(){var o=new yi(4);return yi!=Float32Array&&(o[0]=0,o[1]=0,o[2]=0),o[3]=1,o}function Wa(o){return o[0]=0,o[1]=0,o[2]=0,o[3]=1,o}function pl(o,e,n){n*=.5;var l=e[0],c=e[1],m=e[2],_=e[3],b=Math.sin(n),I=Math.cos(n);return o[0]=l*I+_*b,o[1]=c*I+m*b,o[2]=m*I-c*b,o[3]=_*I-l*b,o}function fl(o,e,n){n*=.5;var l=e[0],c=e[1],m=e[2],_=e[3],b=Math.sin(n),I=Math.cos(n);return o[0]=l*I-m*b,o[1]=c*I+_*b,o[2]=m*I+l*b,o[3]=_*I-c*b,o}Io(),Cs();var fs,Ws,ml,Hs,Ha,sl=Fs,El=(fs=Io(),Ws=Ur(1,0,0),ml=Ur(0,1,0),function(o,e,n){var l=jr(e,n);return l<-.999999?(Co(fs,Ws,e),ra(fs)<1e-6&&Co(fs,ml,e),Lr(fs,fs),function(c,m,_){_*=.5;var b=Math.sin(_);c[0]=b*m[0],c[1]=b*m[1],c[2]=b*m[2],c[3]=Math.cos(_)}(o,fs,Math.PI),o):l>.999999?(o[0]=0,o[1]=0,o[2]=0,o[3]=1,o):(Co(fs,e,n),o[0]=fs[0],o[1]=fs[1],o[2]=fs[2],o[3]=1+l,sl(o,o))});function ms(){var o=new yi(2);return yi!=Float32Array&&(o[0]=0,o[1]=0),o}function Vt(o,e){var n=new yi(2);return n[0]=o,n[1]=e,n}function Le(o,e,n){return o[0]=e[0]+n[0],o[1]=e[1]+n[1],o}function Fe(o,e,n){return o[0]=e[0]-n[0],o[1]=e[1]-n[1],o}function He(o,e,n){return o[0]=e[0]*n,o[1]=e[1]*n,o}function mt(o){return Math.hypot(o[0],o[1])}function St(o,e){var n=e[0],l=e[1],c=n*n+l*l;return c>0&&(c=1/Math.sqrt(c)),o[0]=e[0]*c,o[1]=e[1]*c,o}function Tt(o,e){return o[0]*e[0]+o[1]*e[1]}function Xt(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}ba(),ba(),_r(),ms();var Lt,di,li=function(){if(Ha)return Hs;function o(e,n,l,c){this.cx=3*e,this.bx=3*(l-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*n,this.by=3*(c-n)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=n,this.p2x=l,this.p2y=c}return Ha=1,Hs=o,o.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,n){if(n===void 0&&(n=1e-6),e<0)return 0;if(e>1)return 1;for(var l=e,c=0;c<8;c++){var m=this.sampleCurveX(l)-e;if(Math.abs(m)<n)return l;var _=this.sampleCurveDerivativeX(l);if(Math.abs(_)<1e-6)break;l-=m/_}var b=0,I=1;for(l=e,c=0;c<20&&(m=this.sampleCurveX(l),!(Math.abs(m-e)<n));c++)e>m?b=l:I=l,l=.5*(I-b)+b;return l},solve:function(e,n){return this.sampleCurveY(this.solveCurveX(e,n))}},Hs}(),Zt=Xt(li);function wi(){if(di)return Lt;function o(e,n){this.x=e,this.y=n}return di=1,Lt=o,o.prototype={clone:function(){return new o(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,n){return this.clone()._rotateAround(e,n)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var n=e.x-this.x,l=e.y-this.y;return n*n+l*l},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,n){return Math.atan2(this.x*n-this.y*e,this.x*e+this.y*n)},_matMult:function(e){var n=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=n,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var n=Math.cos(e),l=Math.sin(e),c=l*this.x+n*this.y;return this.x=n*this.x-l*this.y,this.y=c,this},_rotateAround:function(e,n){var l=Math.cos(e),c=Math.sin(e),m=n.y+c*(this.x-n.x)+l*(this.y-n.y);return this.x=n.x+l*(this.x-n.x)-c*(this.y-n.y),this.y=m,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},o.convert=function(e){return e instanceof o?e:Array.isArray(e)?new o(e[0],e[1]):e},Lt}var Ue=Xt(wi());function Qi(o,e){if(Array.isArray(o)){if(!Array.isArray(e)||o.length!==e.length)return!1;for(let n=0;n<o.length;n++)if(!Qi(o[n],e[n]))return!1;return!0}if(typeof o=="object"&&o!==null&&e!==null){if(typeof e!="object"||Object.keys(o).length!==Object.keys(e).length)return!1;for(let n in o)if(!Qi(o[n],e[n]))return!1;return!0}return o===e}let $n=Math.PI/180,ht=180/Math.PI;function te(o){return o*$n}function fe(o){return o*ht}let Ae=[[0,0],[1,0],[1,1],[0,1]];function qe(o){if(o<=0)return 0;if(o>=1)return 1;let e=o*o,n=e*o;return 4*(o<.5?n:3*(o-e)+n-.75)}function je(o,e,n,l){let c=new Zt(o,e,n,l);return function(m){return c.solve(m)}}let We=je(.25,.1,.25,1);function rt(o,e,n){return Math.min(n,Math.max(e,o))}function ct(o,e,n){return(n=rt((n-o)/(e-o),0,1))*n*(3-2*n)}function nt(o,e,n){let l=n-e,c=((o-e)%l+l)%l+e;return c===e?n:c}function Ot(o,e,n){if(!o.length)return n(null,[]);let l=o.length,c=new Array(o.length),m=null;o.forEach((_,b)=>{e(_,(I,E)=>{I&&(m=I),c[b]=E,--l==0&&n(m,c)})})}function wt(o,...e){for(let n of e)for(let l in n)o[l]=n[l];return o}let _i=1;function Ii(){return _i++}function Bt(o){return o<=1?1:Math.pow(2,Math.ceil(Math.log(o)/Math.LN2))}function Di(o,e){o.forEach(n=>{e[n]&&(e[n]=e[n].bind(e))})}function Ni(o,e,n){let l={};for(let c in o)l[c]=e.call(this,o[c],c,o);return l}function dn(o,e,n){let l={};for(let c in o)e.call(this,o[c],c,o)&&(l[c]=o[c]);return l}function An(o){return Array.isArray(o)?o.map(An):typeof o=="object"&&o?Ni(o,An):o}let kr={};function Hi(o){kr[o]||(typeof console<"u"&&console.warn(o),kr[o]=!0)}function yr(o,e,n){return(n.y-o.y)*(e.x-o.x)>(e.y-o.y)*(n.x-o.x)}function Jn(o){let e=0;for(let n,l,c=0,m=o.length,_=m-1;c<m;_=c++)n=o[c],l=o[_],e+=(l.x-n.x)*(n.y+l.y);return e}function Un([o,e,n]){let l=te(e+90),c=te(n);return{x:o*Math.cos(l)*Math.sin(c),y:o*Math.sin(l)*Math.sin(c),z:o*Math.cos(c),azimuthal:e,polar:n}}function Ar(o){return(typeof self<"u"||o!==void 0)&&typeof WorkerGlobalScope<"u"&&(o!==void 0?o:self)instanceof WorkerGlobalScope}function go(o){let e={};if(o.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(n,l,c,m)=>{let _=c||m;return e[l]=!_||_.toLowerCase(),""}),e["max-age"]){let n=parseInt(e["max-age"],10);isNaN(n)?delete e["max-age"]:e["max-age"]=n}return e}let yo=null;function Qo(o,e){return[o[4*e],o[4*e+1],o[4*e+2],o[4*e+3]]}function To(o,e,n,l){for(;e<n;){let c=e+n>>1;o[c]<l?e=c+1:n=c}return e}function xo(o,e,n,l){for(;e<n;){let c=e+n>>1;o[c]<=l?e=c+1:n=c}return e}function oa(o){return o>0?1/(1.001-o):1+o}function Es(o){return o>0?1-1/(1.001-o):-o}function _s(o,e,n){return(o-e.min)*(n.max-n.min)/(e.max-e.min)+n.min}let ls={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!ls.API_URL)return null;try{let o=new URL(ls.API_URL);return o.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":o.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function wa(o){return ls.API_URL_REGEX.test(o)}function Eh(o){return ls.API_SPRITE_REGEX.test(o)}let Ru,ou,Wc,zu,Mh,Hc;function af(){return Ru==null&&(Ru=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),Ru}let Ml={now:()=>zu!==void 0?zu:performance.now(),setNow(o){zu=o},restoreNow(){zu=void 0},frame(o){let e=requestAnimationFrame(o);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(o,e=0){let{width:n,height:l}=o;Mh||(Mh=document.createElement("canvas"));let c=Mh.getContext("2d",{willReadFrequently:!0});if(!c)throw new Error("failed to create canvas 2d context");return(n>Mh.width||l>Mh.height)&&(Mh.width=n,Mh.height=l),c.clearRect(-e,-e,n+2*e,l+2*e),c.drawImage(o,0,0,n,l),c.getImageData(-e,-e,n+2*e,l+2*e)},resolveURL:o=>(ou||(ou=document.createElement("a")),ou.href=o,ou.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Wc==null&&(Wc=window.matchMedia("(prefers-reduced-motion: reduce)")),Wc.matches)},hasCanvasFingerprintNoise(){if(Hc!==void 0)return Hc;if(!af())return Hc=!1,!1;let o=new OffscreenCanvas(85,1),e=o.getContext("2d",{willReadFrequently:!0}),n=0;for(let c=0;c<o.width;++c)e.fillStyle=`rgba(${n++},${n++},${n++}, 255)`,e.fillRect(c,0,1,1);let l=e.getImageData(0,0,o.width,o.height);n=0;for(let c=0;c<l.data.length;++c)if(c%4!=3&&n++!==l.data[c])return Hc=!0,!0;return Hc=!1,!1}};function Ph(o,e){let n=o.indexOf("?");if(n<0)return`${o}?${new URLSearchParams(e).toString()}`;let l=new URLSearchParams(o.slice(n));for(let c in e)l.set(c,e[c]);return`${o.slice(0,n)}?${l.toString()}`}function Ra(o,e={persistentParams:[]}){let n=o.indexOf("?");if(n<0)return o;let l=new URLSearchParams,c=new URLSearchParams(o.slice(n));for(let _ of e.persistentParams){let b=c.get(_);b&&l.set(_,b)}let m=l.toString();return`${o.slice(0,n)}${m.length>0?`?${m}`:""}`}let _l="mapbox-tiles",xc=500,al=50,Pl=["language","worldview","jobid"],Ms,Ir;function ec(){try{return caches}catch{}}function Ta(){let o=ec();o&&Ms==null&&(Ms=o.open(_l))}let tc=1/0,Id={supported:!1,testSupport:function(o){!Al&&Uo&&(Pr?Cd(o):su=o)}},su,Uo,Al=!1,Pr=!1,vc=typeof self<"u"?self:{};function Cd(o){let e=o.createTexture();o.bindTexture(o.TEXTURE_2D,e);try{if(o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,Uo),o.isContextLost())return;Id.supported=!0}catch{}o.deleteTexture(e),Al=!0}vc.document&&(Uo=vc.document.createElement("img"),Uo.onload=function(){su&&Cd(su),su=null,Pr=!0},Uo.onerror=function(){Al=!0,su=null},Uo.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");let Lu={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(Lu);class Xs extends Error{constructor(e,n,l){n===401&&wa(l)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=n,this.url=l}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}let wn=Ar()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,Ps=function(o,e){if(!(/^file:/.test(n=o.url)||/^file:/.test(wn())&&!/^\w+:/.test(n))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(l,c){let m=new AbortController,_=new Request(l.url,{method:l.method||"GET",body:l.body,credentials:l.credentials,headers:l.headers,referrer:wn(),referrerPolicy:l.referrerPolicy,signal:m.signal}),b=!1,I=!1,E=(L=_.url).indexOf("sku=")>0&&wa(L);var L;l.type==="json"&&_.headers.set("Accept","application/json");let F=(W,H,ee)=>{if(I)return;if(W&&W.message!=="SecurityError"&&Hi(W.toString()),H&&ee)return V(H);let le=Date.now();fetch(_).then(de=>{if(de.ok){let Ce=E?de.clone():null;return V(de,Ce,le)}return c(new Xs(de.statusText,de.status,l.url))}).catch(de=>{de.name!=="AbortError"&&c(new Error(`${de.message} ${l.url}`))})},V=(W,H,ee)=>{(l.type==="arrayBuffer"?W.arrayBuffer():l.type==="json"?W.json():W.text()).then(le=>{I||(H&&ee&&function(de,Ce,we){if(Ta(),Ms==null)return;let ie=go(Ce.headers.get("Cache-Control")||"");if(ie["no-store"])return;let me={status:Ce.status,statusText:Ce.statusText,headers:new Headers};Ce.headers.forEach((Je,st)=>me.headers.set(st,Je)),ie["max-age"]&&me.headers.set("Expires",new Date(we+1e3*ie["max-age"]).toUTCString());let Ie=me.headers.get("Expires");if(!Ie||new Date(Ie).getTime()-we<42e4)return;let ze=Ra(de.url,{persistentParams:Pl});if(Ce.status===206){let Je=de.headers.get("Range");if(!Je)return;me.status=200,ze=Ph(ze,{range:Je})}(function(Je,st){if(Ir===void 0)try{new Response(new ReadableStream),Ir=!0}catch{Ir=!1}Ir?st(Je.body):Je.blob().then(st).catch(ut=>Hi(ut.message))})(Ce,Je=>{let st=new Response((ut=Ce.status)!==200&&ut!==404&&[101,103,204,205,304].includes(ut)?null:Je,me);var ut;Ta(),Ms?.then(xt=>xt.put(ze,st)).catch(xt=>Hi(xt.message))})}(_,H,ee),b=!0,c(null,le,W.headers.get("Cache-Control"),W.headers.get("Expires")))}).catch(le=>{I||c(new Error(le.message))})};return E?function(W,H){if(Ta(),Ms==null)return H(null);Ms.then(ee=>{let le=Ra(W.url,{persistentParams:Pl}),de=W.headers.get("Range");de&&(le=Ph(le,{range:de})),ee.match(le).then(Ce=>{let we=function(ie){if(!ie)return!1;let me=new Date(ie.headers.get("Expires")||0),Ie=go(ie.headers.get("Cache-Control")||"");return Number(me)>Date.now()&&!Ie["no-cache"]}(Ce);ee.delete(le).catch(H),we&&ee.put(le,Ce.clone()).catch(H),H(null,Ce,we)}).catch(H)}).catch(H)}(_,F):F(null,null),{cancel:()=>{I=!0,b||m.abort()}}}(o,e);if(Ar(self)&&self.worker.actor)return self.worker.actor.send("getResource",o,e,void 0,!0)}var n;return function(l,c){let m=new XMLHttpRequest;m.open(l.method||"GET",l.url,!0),l.type==="arrayBuffer"&&(m.responseType="arraybuffer");for(let _ in l.headers)m.setRequestHeader(_,l.headers[_]);return l.type==="json"&&(m.responseType="text",m.setRequestHeader("Accept","application/json")),m.withCredentials=l.credentials==="include",m.onerror=()=>{c(new Error(m.statusText))},m.onload=()=>{if((m.status>=200&&m.status<300||m.status===0)&&m.response!==null){let _=m.response;if(l.type==="json")try{_=JSON.parse(m.response)}catch(b){return c(b)}c(null,_,m.getResponseHeader("Cache-Control"),m.getResponseHeader("Expires"))}else c(new Xs(m.statusText,m.status,l.url))},m.send(l.body),{cancel:()=>m.abort()}}(o,e)},gs=function(o,e){return Ps(wt(o,{type:"arrayBuffer"}),e)};function cs(o){let e=document.createElement("a");return e.href=o,e.protocol===location.protocol&&e.host===location.host}let Ed="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=",Cr,As;Cr=[],As=0;let or=function(o,e){if(Id.supported&&(o.headers||(o.headers={}),o.headers.accept="image/webp,*/*"),As>=ls.MAX_PARALLEL_IMAGE_REQUESTS){let m={requestParameters:o,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return Cr.push(m),m}As++;let n=!1,l=()=>{if(!n)for(n=!0,As--;Cr.length&&As<ls.MAX_PARALLEL_IMAGE_REQUESTS;){let m=Cr.shift(),{requestParameters:_,callback:b,cancelled:I}=m;I||(m.cancel=or(_,b).cancel)}},c=gs(o,(m,_,b,I)=>{l(),m?e(m):_&&(self.createImageBitmap?function(E,L){let F=new Blob([new Uint8Array(E)],{type:"image/png"});createImageBitmap(F).then(V=>{L(null,V)}).catch(V=>{L(new Error(`Could not load image because of ${V.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(_,(E,L)=>e(E,L,b,I)):function(E,L){let F=new Image;F.onload=()=>{L(null,F),URL.revokeObjectURL(F.src),F.onload=null,requestAnimationFrame(()=>{F.src=Ed})},F.onerror=()=>L(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));let V=new Blob([new Uint8Array(E)],{type:"image/png"});F.src=E.byteLength?URL.createObjectURL(V):Ed}(_,(E,L)=>e(E,L,b,I)))});return{cancel:()=>{c.cancel(),l()}}};var Tr,Xc,Fn,ic={exports:{}},Bs={exports:{}},Kc={exports:{}},ll=function(){if(Fn)return ic.exports;Fn=1;var o=(Tr||(Tr=1,Bs.exports=function(n,l){var c,m,_,b,I,E,L,F;for(m=n.length-(c=3&n.length),_=l,I=3432918353,E=461845907,F=0;F<m;)L=255&n.charCodeAt(F)|(255&n.charCodeAt(++F))<<8|(255&n.charCodeAt(++F))<<16|(255&n.charCodeAt(++F))<<24,++F,_=27492+(65535&(b=5*(65535&(_=(_^=L=(65535&(L=(L=(65535&L)*I+(((L>>>16)*I&65535)<<16)&4294967295)<<15|L>>>17))*E+(((L>>>16)*E&65535)<<16)&4294967295)<<13|_>>>19))+((5*(_>>>16)&65535)<<16)&4294967295))+((58964+(b>>>16)&65535)<<16);switch(L=0,c){case 3:L^=(255&n.charCodeAt(F+2))<<16;case 2:L^=(255&n.charCodeAt(F+1))<<8;case 1:_^=L=(65535&(L=(L=(65535&(L^=255&n.charCodeAt(F)))*I+(((L>>>16)*I&65535)<<16)&4294967295)<<15|L>>>17))*E+(((L>>>16)*E&65535)<<16)&4294967295}return _^=n.length,_=2246822507*(65535&(_^=_>>>16))+((2246822507*(_>>>16)&65535)<<16)&4294967295,_=3266489909*(65535&(_^=_>>>13))+((3266489909*(_>>>16)&65535)<<16)&4294967295,(_^=_>>>16)>>>0}),Bs.exports),e=(Xc||(Xc=1,Kc.exports=function(n,l){for(var c,m=n.length,_=l^m,b=0;m>=4;)c=1540483477*(65535&(c=255&n.charCodeAt(b)|(255&n.charCodeAt(++b))<<8|(255&n.charCodeAt(++b))<<16|(255&n.charCodeAt(++b))<<24))+((1540483477*(c>>>16)&65535)<<16),_=1540483477*(65535&_)+((1540483477*(_>>>16)&65535)<<16)^(c=1540483477*(65535&(c^=c>>>24))+((1540483477*(c>>>16)&65535)<<16)),m-=4,++b;switch(m){case 3:_^=(255&n.charCodeAt(b+2))<<16;case 2:_^=(255&n.charCodeAt(b+1))<<8;case 1:_=1540483477*(65535&(_^=255&n.charCodeAt(b)))+((1540483477*(_>>>16)&65535)<<16)}return _=1540483477*(65535&(_^=_>>>13))+((1540483477*(_>>>16)&65535)<<16),(_^=_>>>15)>>>0}),Kc.exports);return ic.exports=o,ic.exports.murmur3=o,ic.exports.murmur2=e,ic.exports}(),za=Xt(ll);class Sa{constructor(e,...n){wt(this,n[0]||{}),this.type=e}}class Pp extends Sa{constructor(e,n={}){super("error",wt({error:e},n))}}function Ap(o,e,n){n[o]&&n[o].indexOf(e)!==-1||(n[o]=n[o]||[],n[o].push(e))}function Ah(o,e,n){if(n&&n[o]){let l=n[o].indexOf(e);l!==-1&&n[o].splice(l,1)}}class nc{on(e,n){return this._listeners=this._listeners||{},Ap(e,n,this._listeners),this}off(e,n){return Ah(e,n,this._listeners),Ah(e,n,this._oneTimeListeners),this}once(e,n){return n?(this._oneTimeListeners=this._oneTimeListeners||{},Ap(e,n,this._oneTimeListeners),this):new Promise(l=>{this.once(e,l)})}fire(e,n){let l=typeof e=="string"?new Sa(e,n):e,c=l.type;if(this.listens(c)){l.target=this;let m=this._listeners&&this._listeners[c]?this._listeners[c].slice():[];for(let I of m)I.call(this,l);let _=this._oneTimeListeners&&this._oneTimeListeners[c]?this._oneTimeListeners[c].slice():[];for(let I of _)Ah(c,I,this._oneTimeListeners),I.call(this,l);let b=this._eventedParent;b&&(wt(l,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),b.fire(l))}else l instanceof Pp&&console.error(l.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,n){return this._eventedParent=e,this._eventedParentData=n,this}}class hs{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new hs(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){let[n,l]=e.split("");return new hs({name:n,iconsetId:l})}static isEqual(e,n){return e.name===n.name&&e.iconsetId===n.iconsetId}toString(){return hs.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Ns,Yc={},Jc=function(){if(Ns)return Yc;Ns=1;var o={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(m){return(m=Math.round(m))<0?0:m>255?255:m}function n(m){return e(m[m.length-1]==="%"?parseFloat(m)/100*255:parseInt(m))}function l(m){return(_=m[m.length-1]==="%"?parseFloat(m)/100:parseFloat(m))<0?0:_>1?1:_;var _}function c(m,_,b){return b<0?b+=1:b>1&&(b-=1),6*b<1?m+(_-m)*b*6:2*b<1?_:3*b<2?m+(_-m)*(2/3-b)*6:m}try{Yc.parseCSSColor=function(m){var _,b=m.replace(/ /g,"").toLowerCase();if(b in o)return o[b].slice();if(b[0]==="#")return b.length===4?(_=parseInt(b.substr(1),16))>=0&&_<=4095?[(3840&_)>>4|(3840&_)>>8,240&_|(240&_)>>4,15&_|(15&_)<<4,1]:null:b.length===7&&(_=parseInt(b.substr(1),16))>=0&&_<=16777215?[(16711680&_)>>16,(65280&_)>>8,255&_,1]:null;var I=b.indexOf("("),E=b.indexOf(")");if(I!==-1&&E+1===b.length){var L=b.substr(0,I),F=b.substr(I+1,E-(I+1)).split(","),V=1;switch(L){case"rgba":if(F.length!==4)return null;V=l(F.pop());case"rgb":return F.length!==3?null:[n(F[0]),n(F[1]),n(F[2]),V];case"hsla":if(F.length!==4)return null;V=l(F.pop());case"hsl":if(F.length!==3)return null;var W=(parseFloat(F[0])%360+360)%360/360,H=l(F[1]),ee=l(F[2]),le=ee<=.5?ee*(H+1):ee+H-ee*H,de=2*ee-le;return[e(255*c(de,le,W+1/3)),e(255*c(de,le,W)),e(255*c(de,le,W-1/3)),V];default:return null}}return null}}catch{}return Yc}();class sr{constructor(e,n,l,c=1){this.r=e,this.g=n,this.b=l,this.a=c}static parse(e){if(!e)return;if(e instanceof sr)return e;if(typeof e!="string")return;let n=Jc.parseCSSColor(e);return n?new sr(n[0]/255*n[3],n[1]/255*n[3],n[2]/255*n[3],n[3]):void 0}toStringPremultipliedAlpha(){let[e,n,l,c]=this.a===0?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(e)},${Math.round(n)},${Math.round(l)},${c})`}toString(){let[e,n,l,c]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*n)},${Math.round(255*l)},${c})`}toRenderColor(e){let{r:n,g:l,b:c,a:m}=this;return new Ds(e,n,l,c,m)}clone(){return new sr(this.r,this.g,this.b,this.a)}}class Ds{constructor(e,n,l,c,m){if(e){let _=e.image.height,b=_*_;n=m===0?0:n/m*(_-1),l=m===0?0:l/m*(_-1),c=m===0?0:c/m*(_-1);let I=Math.floor(n),E=Math.floor(l),L=Math.floor(c),F=Math.ceil(n),V=Math.ceil(l),W=Math.ceil(c),H=n-I,ee=l-E,le=c-L,de=e.image.data,Ce=4*(I+E*b+L*_),we=4*(I+E*b+W*_),ie=4*(I+V*b+L*_),me=4*(I+V*b+W*_),Ie=4*(F+E*b+L*_),ze=4*(F+E*b+W*_),Je=4*(F+V*b+L*_),st=4*(F+V*b+W*_);if(Ce<0||st>=de.length)throw new Error("out of range");this.r=en(en(en(de[Ce],de[we],le),en(de[ie],de[me],le),ee),en(en(de[Ie],de[ze],le),en(de[Je],de[st],le),ee),H)/255*m,this.g=en(en(en(de[Ce+1],de[we+1],le),en(de[ie+1],de[me+1],le),ee),en(en(de[Ie+1],de[ze+1],le),en(de[Je+1],de[st+1],le),ee),H)/255*m,this.b=en(en(en(de[Ce+2],de[we+2],le),en(de[ie+2],de[me+2],le),ee),en(en(de[Ie+2],de[ze+2],le),en(de[Je+2],de[st+2],le),ee),H)/255*m,this.a=m}else this.r=n,this.g=l,this.b=c,this.a=m}toArray(){let{r:e,g:n,b:l,a:c}=this;return c===0?[0,0,0,0]:[255*e/c,255*n/c,255*l/c,c]}toHslaArray(){if(this.a===0)return[0,0,0,0];let{r:e,g:n,b:l,a:c}=this,m=Math.min(Math.max(e/c,0),1),_=Math.min(Math.max(n/c,0),1),b=Math.min(Math.max(l/c,0),1),I=Math.min(m,_,b),E=Math.max(m,_,b),L=(I+E)/2;if(I===E)return[0,0,100*L,c];let F=E-I,V=L>.5?F/(2-E-I):F/(E+I),W=0;return E===m?W=(_-b)/F+(_<b?6:0):E===_?W=(b-m)/F+2:E===b&&(W=(m-_)/F+4),W*=60,[Math.min(Math.max(W,0),360),Math.min(Math.max(100*V,0),100),Math.min(Math.max(100*L,0),100),c]}toArray01(){let{r:e,g:n,b:l,a:c}=this;return c===0?[0,0,0,0]:[e/c,n/c,l/c,c]}toArray01Scaled(e){let{r:n,g:l,b:c,a:m}=this;return m===0?[0,0,0]:[n/m*e,l/m*e,c/m*e]}toArray01PremultipliedAlpha(){let{r:e,g:n,b:l,a:c}=this;return[e,n,l,c]}toArray01Linear(){let{r:e,g:n,b:l,a:c}=this;return c===0?[0,0,0,0]:[Math.pow(e/c,2.2),Math.pow(n/c,2.2),Math.pow(l/c,2.2),c]}}function en(o,e,n){return o*(1-n)+e*n}function au(o,e,n){return o.map((l,c)=>en(l,e[c],n))}function Qc(o){return o*o*o*o*o}sr.black=new sr(0,0,0,1),sr.white=new sr(1,1,1,1),sr.transparent=new sr(0,0,0,0),sr.red=new sr(1,0,0,1),sr.blue=new sr(0,0,1,1);var Dp=Object.freeze({__proto__:null,array:au,color:function(o,e,n){return new sr(en(o.r,e.r,n),en(o.g,e.g,n),en(o.b,e.b,n),en(o.a,e.a,n))},easeIn:Qc,number:en});function Dl(o,...e){for(let n of e)for(let l in n)o[l]=n[l];return o}class La extends Error{constructor(e,n){super(n),this.message=n,this.key=e}}class eh{constructor(e,n=[]){this.parent=e,this.bindings={};for(let[l,c]of n)this.bindings[l]=c}concat(e){return new eh(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}let Dh={kind:"null"},Ri={kind:"number"},br={kind:"string"},Xn={kind:"boolean"},Do={kind:"color"},bc={kind:"object"},dr={kind:"value"},Rl={kind:"collator"},lu={kind:"formatted"},Md={kind:"resolvedImage"};function ka(o,e){return{kind:"array",itemType:o,N:e}}function us(o){if(o.kind==="array"){let e=us(o.itemType);return typeof o.N=="number"?`array<${e}, ${o.N}>`:o.itemType.kind==="value"?"array":`array<${e}>`}return o.kind}let Cm=[Dh,Ri,br,Xn,Do,lu,bc,ka(dr),Md];function Rh(o,e){if(e.kind==="error")return null;if(o.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Rh(o.itemType,e.itemType))&&(typeof o.N!="number"||o.N===e.N))return null}else{if(o.kind===e.kind)return null;if(o.kind==="value"){for(let n of Cm)if(!Rh(n,e))return null}}return`Expected ${us(o)} but found ${us(e)} instead.`}function ku(o,e){return e.some(n=>n.kind===o.kind)}function th(o,e){return e.some(n=>n==="null"?o===null:n==="array"?Array.isArray(o):n==="object"?o&&!Array.isArray(o)&&typeof o=="object":n===typeof o)}class zl{constructor(e,n,l){this.sensitivity=e?n?"variant":"case":n?"accent":"base",this.locale=l,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,n){return this.collator.compare(e,n)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Ou{constructor(e,n,l,c,m){this.text=e.normalize?e.normalize():e,this.image=n,this.scale=l,this.fontStack=c,this.textColor=m}}class Ks{constructor(e){this.sections=e}static fromString(e){return new Ks([new Ou(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||!!e.image&&e.image.hasPrimary())}static factory(e){return e instanceof Ks?e:Ks.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){let e=["format"];for(let n of this.sections){if(n.image){let c=n.image.getPrimary().id.toString();e.push(["image",c]);continue}e.push(n.text);let l={};n.fontStack&&(l["text-font"]=["literal",n.fontStack.split(",")]),n.scale&&(l["font-scale"]=n.scale),n.textColor&&(l["text-color"]=["rgba"].concat(n.textColor.toRenderColor(null).toArray())),e.push(l)}return e}}class Vs{constructor(e,n={}){if(this.id=hs.from(e),this.options=Object.assign({},n),n.transform){let{a:l,b:c,c:m,d:_,e:b,f:I}=n.transform;this.options.transform=new DOMMatrix([l,c,m,_,b,I])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){let{a:e,b:n,c:l,d:c,e:m,f:_}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:n,c:l,d:c,e:m,f:_}})}static parse(e){let n,l,c,m;try{({name:n,iconsetId:l,params:c,transform:m}=JSON.parse(e)||{})}catch{return null}if(!n)return null;let{a:_,b,c:I,d:E,e:L,f:F}=m||{};return new Vs({name:n,iconsetId:l},{params:c,transform:new DOMMatrix([_,b,I,E,L,F])})}scaleSelf(e,n){return this.options.transform.scaleSelf(e,n),this}}class Xa{constructor(e,n,l,c,m=!1){this.primaryId=hs.from(e),this.primaryOptions=n,l&&(this.secondaryId=hs.from(l)),this.secondaryOptions=c,this.available=m}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new Vs(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new Vs(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?Xa.build({name:e}):e}static build(e,n,l,c){return!e||typeof e=="object"&&!("name"in e)?null:new Xa(e,l,n,c)}}function Rp(o,e,n,l){return typeof o=="number"&&o>=0&&o<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof n=="number"&&n>=0&&n<=255?l===void 0||typeof l=="number"&&l>=0&&l<=1?null:`Invalid rgba value [${[o,e,n,l].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof l=="number"?[o,e,n,l]:[o,e,n]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function wc(o){if(o===null||typeof o=="string"||typeof o=="boolean"||typeof o=="number"||o instanceof sr||o instanceof zl||o instanceof Ks||o instanceof Xa)return!0;if(Array.isArray(o)){for(let e of o)if(!wc(e))return!1;return!0}if(typeof o=="object"){for(let e in o)if(!wc(o[e]))return!1;return!0}return!1}function $o(o){if(o===null)return Dh;if(typeof o=="string")return br;if(typeof o=="boolean")return Xn;if(typeof o=="number")return Ri;if(o instanceof sr)return Do;if(o instanceof zl)return Rl;if(o instanceof Ks)return lu;if(o instanceof Xa)return Md;if(Array.isArray(o)){let e=o.length,n;for(let l of o){let c=$o(l);if(n){if(n===c)continue;n=dr;break}n=c}return ka(n||dr,e)}return bc}function Ia(o){let e=typeof o;return o===null?"":e==="string"||e==="number"||e==="boolean"?String(o):o instanceof sr?o.toStringPremultipliedAlpha():o instanceof Ks||o instanceof Xa?o.toString():JSON.stringify(o)}class Tn{constructor(e,n){this.type=e,this.value=n}static parse(e,n){if(e.length!==2)return n.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!wc(e[1]))return n.error("invalid value");let l=e[1],c=$o(l),m=n.expectedType;return c.kind!=="array"||c.N!==0||!m||m.kind!=="array"||typeof m.N=="number"&&m.N!==0||(c=m),new Tn(c,l)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof sr?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof Ks?this.value.serialize():this.value}}class Li{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}let Tc={string:br,number:Ri,boolean:Xn,object:bc};class hn{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let l,c=1,m=e[0];if(m==="array"){let b,I;if(e.length>2){let E=e[1];if(typeof E!="string"||!(E in Tc)||E==="object")return n.error('The item type argument of "array" must be one of string, number, boolean',1);b=Tc[E],c++}else b=dr;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return n.error('The length argument to "array" must be a positive integer literal',2);I=e[2],c++}l=ka(b,I)}else l=Tc[m];let _=[];for(;c<e.length;c++){let b=n.parse(e[c],c,dr);if(!b)return null;_.push(b)}return new hn(l,_)}evaluate(e){for(let n=0;n<this.args.length;n++){let l=this.args[n].evaluate(e);if(!Rh(this.type,$o(l)))return l;if(n===this.args.length-1)throw new Li(`The expression ${JSON.stringify(this.args[n].serialize())} evaluated to ${us($o(l))} but was expected to be of type ${us(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){let e=this.type,n=[e.kind];if(e.kind==="array"){let l=e.itemType;if(l.kind==="string"||l.kind==="number"||l.kind==="boolean"){n.push(l.kind);let c=e.N;(typeof c=="number"||this.args.length>1)&&n.push(c)}}return n.concat(this.args.map(l=>l.serialize()))}}class zh{constructor(e){this.type=lu,this.sections=e}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let l=e[1];if(!Array.isArray(l)&&typeof l=="object")return n.error("First argument must be an image or text section.");let c=[],m=!1;for(let _=1;_<=e.length-1;++_){let b=e[_];if(m&&typeof b=="object"&&!Array.isArray(b)){m=!1;let I=null;if(b["font-scale"]&&(I=n.parseObjectValue(b["font-scale"],_,"font-scale",Ri),!I))return null;let E=null;if(b["text-font"]&&(E=n.parseObjectValue(b["text-font"],_,"text-font",ka(br)),!E))return null;let L=null;if(b["text-color"]&&(L=n.parseObjectValue(b["text-color"],_,"text-color",Do),!L))return null;let F=c[c.length-1];F.scale=I,F.font=E,F.textColor=L}else{let I=n.parse(e[_],_,dr);if(!I)return null;let E=I.type.kind;if(E!=="string"&&E!=="value"&&E!=="null"&&E!=="resolvedImage")return n.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");m=!0,c.push({content:I,scale:null,font:null,textColor:null})}}return new zh(c)}evaluate(e){return new Ks(this.sections.map(n=>{let l=n.content.evaluate(e);return $o(l)===Md?new Ou("",l,null,null,null):new Ou(Ia(l),null,n.scale?n.scale.evaluate(e):null,n.font?n.font.evaluate(e).join(","):null,n.textColor?n.textColor.evaluate(e):null)}))}eachChild(e){for(let n of this.sections)e(n.content),n.scale&&e(n.scale),n.font&&e(n.font),n.textColor&&e(n.textColor)}outputDefined(){return!1}serialize(){let e=["format"];for(let n of this.sections){e.push(n.content.serialize());let l={};n.scale&&(l["font-scale"]=n.scale.serialize()),n.font&&(l["text-font"]=n.font.serialize()),n.textColor&&(l["text-color"]=n.textColor.serialize()),e.push(l)}return e}}class Fu{constructor(e,n,l,c){this._imageWarnHistory={},this.type=Md,this.namePrimary=e,this.nameSecondary=n,l&&(this.paramsPrimary=l.params,this.iconsetIdPrimary=l.iconset?l.iconset.id:void 0),c&&(this.paramsSecondary=c.params,this.iconsetIdSecondary=c.iconset?c.iconset.id:void 0)}static parse(e,n){if(e.length<2)return n.error("Expected two or more arguments.");let l=1,c=[];function m(){if(l<e.length){let b=n.parse(e[l],l++,br);return b?(c.push({image:b,options:{}}),!0):(n.error(c.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function _(){if(l<e.length){let I=e[l];if((b=I)===null||typeof b!="object"||Array.isArray(b))return!0;let E=I.params,L=I.iconset,F=n.concat(l);if(!E&&!L)return l++,!0;if(E){if(typeof E!="object"||E.constructor!==Object)return F.error('Image options "params" should be an object'),!1;let V={},W=F.concat(void 0,"params");for(let H in E){if(!H)return W.error("Image parameter name should be non-empty"),!1;let ee=W.concat(void 0,H).parse(E[H],void 0,Do,void 0,{typeAnnotation:"coerce"});if(!ee)return!1;V[H]=ee}c[c.length-1].options.params=V}if(L){if(typeof L!="object"||L.constructor!==Object)return F.error('Image options "iconset" should be an object'),!1;if(!L.id)return F.error('Image options "iconset" should have an "id" property'),!1;c[c.length-1].options.iconset=L}return l++,!0}var b;return!0}for(let b=0;b<2;b++)if(!m()||!_())return;return new Fu(c[0].image,c[1]?c[1].image:void 0,c[0].options,c[1]?c[1].options:void 0)}evaluateParams(e,n){let l={};if(n){for(let c in n)if(n[c])try{l[c]=n[c].evaluate(e)}catch{continue}if(Object.keys(l).length!==0)return{params:l}}}evaluate(e){let n={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},l=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,c=Xa.build(n,l,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(c&&e.availableImages){let m=c.getPrimary().id;if(c.available=e.availableImages.some(_=>hs.isEqual(_,m)),c.available){let _=c.getSecondary()?c.getSecondary().id:null;_&&(c.available=e.availableImages.some(b=>hs.isEqual(b,_)))}}return c}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(let n in this.paramsPrimary)this.paramsPrimary[n]&&e(this.paramsPrimary[n]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(let n in this.paramsSecondary)this.paramsSecondary[n]&&e(this.paramsSecondary[n])}outputDefined(){return!1}serializeOptions(e,n){let l={};if(n&&(l.iconset={id:n}),e){l.params={};for(let c in e)e[c]&&(l.params[c]=e[c].serialize())}return Object.keys(l).length>0?l:void 0}serialize(){let e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){let n=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);n&&e.push(n)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){let n=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);n&&e.push(n)}return e}}function ln(o){return o instanceof Number?"number":o instanceof String?"string":o instanceof Boolean?"boolean":Array.isArray(o)?"array":o===null?"null":typeof o}let zp={"to-boolean":Xn,"to-color":Do,"to-number":Ri,"to-string":br};class Ll{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let l=e[0],c=[],m=Dh;if(l==="to-array"){if(!Array.isArray(e[1]))return null;let _=e[1].length;if(n.expectedType){if(n.expectedType.kind!=="array")return n.error(`Expected ${n.expectedType.kind} but found array.`);m=ka(n.expectedType.itemType,_)}else{if(!(_>0&&wc(e[1][0])))return null;m=ka($o(e[1][0]),_)}for(let b=0;b<_;b++){let I=e[1][b],E;if(ln(I)==="array")E=n.parse(I,void 0,m.itemType);else{let L=ln(I);if(L!==m.itemType.kind)return n.error(`Expected ${m.itemType.kind} but found ${L}.`);E=n.registry.literal.parse(["literal",I===void 0?null:I],n)}if(!E)return null;c.push(E)}}else{if((l==="to-boolean"||l==="to-string")&&e.length!==2)return n.error("Expected one argument.");m=zp[l];for(let _=1;_<e.length;_++){let b=n.parse(e[_],_,dr);if(!b)return null;c.push(b)}}return new Ll(m,c)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let n,l;for(let c of this.args){if(n=c.evaluate(e),l=null,n instanceof sr)return n;if(typeof n=="string"){let m=e.parseColor(n);if(m)return m}else if(Array.isArray(n)&&(l=n.length<3||n.length>4?`Invalid rbga value ${JSON.stringify(n)}: expected an array containing either three or four numeric values.`:Rp(n[0],n[1],n[2],n[3]),!l))return new sr(n[0]/255,n[1]/255,n[2]/255,n[3])}throw new Li(l||`Could not parse color from value '${typeof n=="string"?n:String(JSON.stringify(n))}'`)}if(this.type.kind==="number"){let n=null;for(let l of this.args){if(n=l.evaluate(e),n===null)return 0;let c=Number(n);if(!isNaN(c))return c}throw new Li(`Could not convert ${JSON.stringify(n)} to number.`)}return this.type.kind==="formatted"?Ks.fromString(Ia(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Xa.build(Ia(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(n=>n.evaluate(e)):Ia(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new zh([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new Fu(this.args[0]).serialize();let e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(n=>{e.push(n.serialize())}),e}}let lf=["Unknown","Point","LineString","Polygon"];class Bu{constructor(e,n){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=n}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?lf[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){let e=this.featureDistanceData.center,n=this.featureDistanceData.scale,{x:l,y:c}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(l*n-e[0])+this.featureDistanceData.bearing[1]*(c*n-e[1])}return 0}parseColor(e){let n=this._parseColorCache[e];return n||(n=this._parseColorCache[e]=sr.parse(e)),n}getConfig(e){return this.options?this.options.get(e):null}}class Ys{constructor(e,n,l,c,m){this.name=e,this.type=n,this._evaluate=l,this.args=c,this._overloadIndex=m}evaluate(e){if(!this._evaluate){let n=Ys.definitions[this.name];this._evaluate=Array.isArray(n)?n[2]:n.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,n){let l=e[0],c=Ys.definitions[l];if(!c)return n.error(`Unknown expression "${l}". If you wanted a literal array, use ["literal", [...]].`,0);let m=Array.isArray(c)?c[0]:c.type,_=Array.isArray(c)?[[c[1],c[2]]]:c.overloads,b=[],I=null,E=-1;for(let[L,F]of _){if(Array.isArray(L)&&L.length!==e.length-1)continue;b.push(L),E++,I=new Up(n.registry,n.path,null,n.scope,void 0,n._scope,n.options);let V=[],W=!1;for(let H=1;H<e.length;H++){let ee=e[H],le=Array.isArray(L)?L[H-1]:L.type,de=I.parse(ee,1+V.length,le);if(!de){W=!0;break}V.push(de)}if(!W)if(Array.isArray(L)&&L.length!==V.length)I.error(`Expected ${L.length} arguments, but found ${V.length} instead.`);else{for(let H=0;H<V.length;H++){let ee=Array.isArray(L)?L[H]:L.type,le=V[H];I.concat(H+1).checkSubtype(ee,le.type)}if(I.errors.length===0)return new Ys(l,m,F,V,E)}}if(b.length===1)n.errors.push(...I.errors);else{let L=(b.length?b:_.map(([V])=>V)).map(ws).join(" | "),F=[];for(let V=1;V<e.length;V++){let W=n.parse(e[V],1+F.length);if(!W)return null;F.push(us(W.type))}n.error(`Expected arguments of type ${L}, but found (${F.join(", ")}) instead.`)}return null}static register(e,n){Ys.definitions=n;for(let l in n)e[l]=Ys}}function ws(o){return Array.isArray(o)?`(${o.map(us).join(", ")})`:`(${us(o.type)}...)`}class cu{constructor(e,n,l){this.type=Rl,this.locale=l,this.caseSensitive=e,this.diacriticSensitive=n}static parse(e,n){if(e.length!==2)return n.error("Expected one argument.");let l=e[1];if(typeof l!="object"||Array.isArray(l))return n.error("Collator options argument must be an object.");let c=l["case-sensitive"]===void 0?n.parse(!1,1,Xn):n.parseObjectValue(l["case-sensitive"],1,"case-sensitive",Xn);if(!c)return null;let m=l["diacritic-sensitive"]===void 0?n.parse(!1,1,Xn):n.parseObjectValue(l["diacritic-sensitive"],1,"diacritic-sensitive",Xn);if(!m)return null;let _=null;return l.locale&&(_=n.parseObjectValue(l.locale,1,"locale",br),!_)?null:new cu(c,m,_)}evaluate(e){return new zl(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){let e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function Sc(o,e,n=0,l=o.length-1,c=hu){for(;l>n;){if(l-n>600){let I=l-n+1,E=e-n+1,L=Math.log(I),F=.5*Math.exp(2*L/3),V=.5*Math.sqrt(L*F*(I-F)/I)*(E-I/2<0?-1:1);Sc(o,e,Math.max(n,Math.floor(e-E*F/I+V)),Math.min(l,Math.floor(e+(I-E)*F/I+V)),c)}let m=o[e],_=n,b=l;for(kl(o,n,e),c(o[l],m)>0&&kl(o,n,l);_<b;){for(kl(o,_,b),_++,b--;c(o[_],m)<0;)_++;for(;c(o[b],m)>0;)b--}c(o[n],m)===0?kl(o,n,b):(b++,kl(o,b,l)),b<=e&&(n=b+1),e<=b&&(l=b-1)}}function kl(o,e,n){let l=o[e];o[e]=o[n],o[n]=l}function hu(o,e){return o<e?-1:o>e?1:0}function Js(o){let e=0;for(let n,l,c=0,m=o.length,_=m-1;c<m;_=c++)n=o[c],l=o[_],e+=(l.x-n.x)*(n.y+l.y);return e}function Pd(o,e){o[0]=Math.min(o[0],e[0]),o[1]=Math.min(o[1],e[1]),o[2]=Math.max(o[2],e[0]),o[3]=Math.max(o[3],e[1])}function Nu(o,e){return!(o[0]<=e[0]||o[2]>=e[2]||o[1]<=e[1]||o[3]>=e[3])}function Of(o,e,n){let l=o[0]-e[0],c=o[1]-e[1],m=o[0]-n[0],_=o[1]-n[1];return l*_-m*c==0&&l*m<=0&&c*_<=0}function Ic(o,e,n=!1){let l=!1;for(let b=0,I=e.length;b<I;b++){let E=e[b];for(let L=0,F=E.length,V=F-1;L<F;V=L++){let W=E[V],H=E[L];if(Of(o,W,H))return n;(m=W)[1]>(c=o)[1]!=(_=H)[1]>c[1]&&c[0]<(_[0]-m[0])*(c[1]-m[1])/(_[1]-m[1])+m[0]&&(l=!l)}}var c,m,_;return l}function Lp(o,e,n,l){let c=l[0]-n[0],m=l[1]-n[1],_=(o[0]-n[0])*m-c*(o[1]-n[1]),b=(e[0]-n[0])*m-c*(e[1]-n[1]);return _>0&&b<0||_<0&&b>0}function Ol(o,e,n,l){return(c=[l[0]-n[0],l[1]-n[1]])[0]*(m=[e[0]-o[0],e[1]-o[1]])[1]-c[1]*m[0]!=0&&!(!Lp(o,e,n,l)||!Lp(n,l,o,e));var c,m}function Xr(o){let e=new Ue(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),n=new Ue(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let l of o[0])e.x>l.x&&(e.x=l.x),e.y>l.y&&(e.y=l.y),n.x<l.x&&(n.x=l.x),n.y<l.y&&(n.y=l.y);return{min:e,max:n}}let rc=8192;function ih(o,e){let n=(180+o[0])/360,l=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+o[1]*Math.PI/360)))/360,c=Math.pow(2,e.z);return[Math.round(n*c*rc),Math.round(l*c*rc)]}function cf(o,e){for(let n=0;n<e.length;n++)if(Ic(o,e[n]))return!0;return!1}function kp(o,e,n){for(let l of n)for(let c=0,m=l.length,_=m-1;c<m;_=c++)if(Ol(o,e,l[_],l[c]))return!0;return!1}function Op(o,e){for(let n=0;n<o.length;++n)if(!Ic(o[n],e))return!1;for(let n=0;n<o.length-1;++n)if(kp(o[n],o[n+1],e))return!1;return!0}function Ff(o,e){for(let n=0;n<e.length;n++)if(Op(o,e[n]))return!0;return!1}function Vu(o,e,n){let l=[];for(let c=0;c<o.length;c++){let m=[];for(let _=0;_<o[c].length;_++){let b=ih(o[c][_],n);Pd(e,b),m.push(b)}l.push(m)}return l}function Lh(o,e,n){let l=[];for(let c=0;c<o.length;c++){let m=Vu(o[c],e,n);l.push(m)}return l}function Cc(o,e,n,l){if(o[0]<n[0]||o[0]>n[2]){let c=.5*l,m=o[0]-n[0]>c?-l:n[0]-o[0]>c?l:0;m===0&&(m=o[0]-n[2]>c?-l:n[2]-o[0]>c?l:0),o[0]+=m}Pd(e,o)}function Bf(o,e,n,l){let c=Math.pow(2,l.z)*rc,m=[l.x*rc,l.y*rc],_=[];if(!o)return _;for(let b of o)for(let I of b){let E=[I.x+m[0],I.y+m[1]];Cc(E,e,n,c),_.push(E)}return _}function Nf(o,e,n,l){let c=Math.pow(2,l.z)*rc,m=[l.x*rc,l.y*rc],_=[];if(!o)return _;for(let I of o){let E=[];for(let L of I){let F=[L.x+m[0],L.y+m[1]];Pd(e,F),E.push(F)}_.push(E)}if(e[2]-e[0]<=c/2){(b=e)[0]=b[1]=1/0,b[2]=b[3]=-1/0;for(let I of _)for(let E of I)Cc(E,e,n,c)}var b;return _}class nh{constructor(e,n){this.type=Xn,this.geojson=e,this.geometries=n}static parse(e,n){if(e.length!==2)return n.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(wc(e[1])){let l=e[1];if(l.type==="FeatureCollection")for(let c=0;c<l.features.length;++c){let m=l.features[c].geometry.type;if(m==="Polygon"||m==="MultiPolygon")return new nh(l,l.features[c].geometry)}else if(l.type==="Feature"){let c=l.geometry.type;if(c==="Polygon"||c==="MultiPolygon")return new nh(l,l.geometry)}else if(l.type==="Polygon"||l.type==="MultiPolygon")return new nh(l,l)}return n.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(n,l){let c=[1/0,1/0,-1/0,-1/0],m=[1/0,1/0,-1/0,-1/0],_=n.canonicalID();if(!_)return!1;if(l.type==="Polygon"){let b=Vu(l.coordinates,m,_),I=Bf(n.geometry(),c,m,_);if(!Nu(c,m))return!1;for(let E of I)if(!Ic(E,b))return!1}if(l.type==="MultiPolygon"){let b=Lh(l.coordinates,m,_),I=Bf(n.geometry(),c,m,_);if(!Nu(c,m))return!1;for(let E of I)if(!cf(E,b))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(n,l){let c=[1/0,1/0,-1/0,-1/0],m=[1/0,1/0,-1/0,-1/0],_=n.canonicalID();if(!_)return!1;if(l.type==="Polygon"){let b=Vu(l.coordinates,m,_),I=Nf(n.geometry(),c,m,_);if(!Nu(c,m))return!1;for(let E of I)if(!Op(E,b))return!1}if(l.type==="MultiPolygon"){let b=Lh(l.coordinates,m,_),I=Nf(n.geometry(),c,m,_);if(!Nu(c,m))return!1;for(let E of I)if(!Ff(E,b))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}let Ad={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},Fp=1/298.257223563,Fl=Fp*(2-Fp),uu=Math.PI/180;class rh{static fromTile(e,n,l){let c=Math.PI*(1-2*(e+.5)/Math.pow(2,n)),m=Math.atan(.5*(Math.exp(c)-Math.exp(-c)))/uu;return new rh(m,l)}static get units(){return Ad}constructor(e,n){if(e===void 0)throw new Error("No latitude given.");if(n&&!Ad[n])throw new Error(`Unknown unit ${n}. Use one of: ${Object.keys(Ad).join(", ")}`);let l=6378.137*uu*(n?Ad[n]:1),c=Math.cos(e*uu),m=1/(1-Fl*(1-c*c)),_=Math.sqrt(m);this.kx=l*_*c,this.ky=l*_*m*(1-Fl)}distance(e,n){let l=Ka(e[0]-n[0])*this.kx,c=(e[1]-n[1])*this.ky;return Math.sqrt(l*l+c*c)}bearing(e,n){let l=Ka(n[0]-e[0])*this.kx;return Math.atan2(l,(n[1]-e[1])*this.ky)/uu}destination(e,n,l){let c=l*uu;return this.offset(e,Math.sin(c)*n,Math.cos(c)*n)}offset(e,n,l){return[e[0]+n/this.kx,e[1]+l/this.ky]}lineDistance(e){let n=0;for(let l=0;l<e.length-1;l++)n+=this.distance(e[l],e[l+1]);return n}area(e){let n=0;for(let l=0;l<e.length;l++){let c=e[l];for(let m=0,_=c.length,b=_-1;m<_;b=m++)n+=Ka(c[m][0]-c[b][0])*(c[m][1]+c[b][1])*(l?-1:1)}return Math.abs(n)/2*this.kx*this.ky}along(e,n){let l=0;if(n<=0)return e[0];for(let c=0;c<e.length-1;c++){let m=e[c],_=e[c+1],b=this.distance(m,_);if(l+=b,l>n)return du(m,_,(n-(l-b))/b)}return e[e.length-1]}pointToSegmentDistance(e,n,l){let[c,m]=n,_=Ka(l[0]-c)*this.kx,b=(l[1]-m)*this.ky;if(_!==0||b!==0){let I=(Ka(e[0]-c)*this.kx*_+(e[1]-m)*this.ky*b)/(_*_+b*b);I>1?(c=l[0],m=l[1]):I>0&&(c+=_/this.kx*I,m+=b/this.ky*I)}return _=Ka(e[0]-c)*this.kx,b=(e[1]-m)*this.ky,Math.sqrt(_*_+b*b)}pointOnLine(e,n){let l=1/0,c=e[0][0],m=e[0][1],_=0,b=0;for(let I=0;I<e.length-1;I++){let E=e[I][0],L=e[I][1],F=Ka(e[I+1][0]-E)*this.kx,V=(e[I+1][1]-L)*this.ky,W=0;F===0&&V===0||(W=(Ka(n[0]-E)*this.kx*F+(n[1]-L)*this.ky*V)/(F*F+V*V),W>1?(E=e[I+1][0],L=e[I+1][1]):W>0&&(E+=F/this.kx*W,L+=V/this.ky*W)),F=Ka(n[0]-E)*this.kx,V=(n[1]-L)*this.ky;let H=F*F+V*V;H<l&&(l=H,c=E,m=L,_=I,b=W)}return{point:[c,m],index:_,t:Math.max(0,Math.min(1,b))}}lineSlice(e,n,l){let c=this.pointOnLine(l,e),m=this.pointOnLine(l,n);if(c.index>m.index||c.index===m.index&&c.t>m.t){let E=c;c=m,m=E}let _=[c.point],b=c.index+1,I=m.index;!Uu(l[b],_[0])&&b<=I&&_.push(l[b]);for(let E=b+1;E<=I;E++)_.push(l[E]);return Uu(l[I],m.point)||_.push(m.point),_}lineSliceAlong(e,n,l){let c=0,m=[];for(let _=0;_<l.length-1;_++){let b=l[_],I=l[_+1],E=this.distance(b,I);if(c+=E,c>e&&m.length===0&&m.push(du(b,I,(e-(c-E))/E)),c>=n)return m.push(du(b,I,(n-(c-E))/E)),m;c>e&&m.push(I)}return m}bufferPoint(e,n){let l=n/this.ky,c=n/this.kx;return[e[0]-c,e[1]-l,e[0]+c,e[1]+l]}bufferBBox(e,n){let l=n/this.ky,c=n/this.kx;return[e[0]-c,e[1]-l,e[2]+c,e[3]+l]}insideBBox(e,n){return Ka(e[0]-n[0])>=0&&Ka(e[0]-n[2])<=0&&e[1]>=n[1]&&e[1]<=n[3]}}function Uu(o,e){return o[0]===e[0]&&o[1]===e[1]}function du(o,e,n){let l=Ka(e[0]-o[0]);return[o[0]+l*n,o[1]+(e[1]-o[1])*n]}function Ka(o){for(;o<-180;)o+=360;for(;o>180;)o-=360;return o}class Ec{constructor(e=[],n=(l,c)=>l<c?-1:l>c?1:0){if(this.data=e,this.length=this.data.length,this.compare=n,this.length>0)for(let l=(this.length>>1)-1;l>=0;l--)this._down(l)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;let e=this.data[0],n=this.data.pop();return--this.length>0&&(this.data[0]=n,this._down(0)),e}peek(){return this.data[0]}_up(e){let{data:n,compare:l}=this,c=n[e];for(;e>0;){let m=e-1>>1,_=n[m];if(l(c,_)>=0)break;n[e]=_,e=m}n[e]=c}_down(e){let{data:n,compare:l}=this,c=this.length>>1,m=n[e];for(;e<c;){let _=1+(e<<1),b=_+1;if(b<this.length&&l(n[b],n[_])<0&&(_=b),l(n[_],m)>=0)break;n[e]=n[_],e=_}n[e]=m}}var xi=8192;function kh(o,e){return e.dist-o.dist}let Ya=100,Dd=50;function Bp(o){let e=[1/0,1/0,-1/0,-1/0];if(e.length!==o.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==o[n])return!1;return!0}function oh(o){return o[1]-o[0]+1}function sa(o,e){let n=o[1]>=o[0]&&o[1]<e;return n||console.warn("Distance Expression: Index is out of range"),n}function sh(o,e){if(o[0]>o[1])return[null,null];let n=oh(o);if(e){if(n===2)return[o,null];let l=Math.floor(n/2);return[[o[0],o[0]+l],[o[0]+l,o[1]]]}{if(n===1)return[o,null];let l=Math.floor(n/2)-1;return[[o[0],o[0]+l],[o[0]+l+1,o[1]]]}}function oc(o,e){let n=[1/0,1/0,-1/0,-1/0];if(!sa(e,o.length))return n;for(let l=e[0];l<=e[1];++l)Pd(n,o[l]);return n}function ah(o){let e=[1/0,1/0,-1/0,-1/0];for(let n=0;n<o.length;++n)for(let l=0;l<o[n].length;++l)Pd(e,o[n][l]);return e}function Bl(o,e,n){if(Bp(o)||Bp(e))return NaN;let l=0,c=0;return o[2]<e[0]&&(l=e[0]-o[2]),o[0]>e[2]&&(l=o[0]-e[2]),o[1]>e[3]&&(c=o[1]-e[3]),o[3]<e[1]&&(c=e[1]-o[3]),n.distance([0,0],[l,c])}function pu(o){return 360*o-180}function Wn(o){return 360/Math.PI*Math.atan(Math.exp((180-360*o)*Math.PI/180))-90}function Oh(o,e){let n=Math.pow(2,e.z),l=(o.y/xi+e.y)/n;return[pu((o.x/xi+e.x)/n),Wn(l)]}function hf(o,e){let n=[];for(let l=0;l<o.length;++l)n.push(Oh(o[l],e));return n}function Np(o,e,n){let l=n.pointOnLine(e,o).point;return n.distance(o,l)}function Dr(o,e,n,l,c){let m=n.slice(l[0],l[1]+1),_=1/0;for(let b=e[0];b<=e[1];++b)if((_=Math.min(_,Np(o[b],m,c)))===0)return 0;return _}function lh(o,e,n,l,c){let m=Math.min(c.pointToSegmentDistance(o,n,l),c.pointToSegmentDistance(e,n,l)),_=Math.min(c.pointToSegmentDistance(n,o,e),c.pointToSegmentDistance(l,o,e));return Math.min(m,_)}function uo(o,e,n,l,c){if(!sa(e,o.length)||!sa(l,n.length))return NaN;let m=1/0;for(let _=e[0];_<e[1];++_)for(let b=l[0];b<l[1];++b){if(Ol(o[_],o[_+1],n[b],n[b+1]))return 0;m=Math.min(m,lh(o[_],o[_+1],n[b],n[b+1],c))}return m}function Vf(o,e,n,l,c){if(!sa(e,o.length)||!sa(l,n.length))return NaN;let m=1/0;for(let _=e[0];_<=e[1];++_)for(let b=l[0];b<=l[1];++b)if((m=Math.min(m,c.distance(o[_],n[b])))===0)return m;return m}function Rd(o,e,n){if(Ic(o,e,!0))return 0;let l=1/0;for(let c of e){let m=c.length;if(m<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(c[0]!==c[m-1]&&(l=Math.min(l,n.pointToSegmentDistance(o,c[m-1],c[0])))===0||(l=Math.min(l,Np(o,c,n)))===0)return l}return l}function Em(o,e,n,l){if(!sa(e,o.length))return NaN;for(let m=e[0];m<=e[1];++m)if(Ic(o[m],n,!0))return 0;let c=1/0;for(let m=e[0];m<e[1];++m)for(let _ of n)for(let b=0,I=_.length,E=I-1;b<I;E=b++){if(Ol(o[m],o[m+1],_[E],_[b]))return 0;c=Math.min(c,lh(o[m],o[m+1],_[E],_[b],l))}return c}function Uf(o,e){for(let n of o)for(let l=0;l<=n.length-1;++l)if(Ic(n[l],e,!0))return!0;return!1}function jf(o,e,n,l=1/0){let c=ah(o),m=ah(e);if(l!==1/0&&Bl(c,m,n)>=l)return l;if(Nu(c,m)){if(Uf(o,e))return 0}else if(Uf(e,o))return 0;let _=l;for(let b of o)for(let I=0,E=b.length,L=E-1;I<E;L=I++)for(let F of e)for(let V=0,W=F.length,H=W-1;V<W;H=V++){if(Ol(b[L],b[I],F[H],F[V]))return 0;_=Math.min(_,lh(b[L],b[I],F[H],F[V],n))}return _}function zd(o,e,n,l,c,m,_){if(m===null||_===null)return;let b=Bl(oc(l,m),oc(c,_),n);b<e&&o.push({dist:b,range1:m,range2:_})}function Vp(o,e,n,l,c=1/0){let m=Math.min(l.distance(o[0],n[0][0]),c);if(m===0)return m;let _=new Ec([{dist:0,range1:[0,o.length-1],range2:[0,0]}],kh),b=e?Dd:Ya,I=ah(n);for(;_.length;){let E=_.pop();if(E.dist>=m)continue;let L=E.range1;if(oh(L)<=b){if(!sa(L,o.length))return NaN;if(e){let F=Em(o,L,n,l);if((m=Math.min(m,F))===0)return m}else for(let F=L[0];F<=L[1];++F){let V=Rd(o[F],n,l);if((m=Math.min(m,V))===0)return m}}else{let F=sh(L,e);if(F[0]!==null){let V=Bl(oc(o,F[0]),I,l);V<m&&_.push({dist:V,range1:F[0],range2:[0,0]})}if(F[1]!==null){let V=Bl(oc(o,F[1]),I,l);V<m&&_.push({dist:V,range1:F[1],range2:[0,0]})}}}return m}function Ld(o,e,n,l,c,m=1/0){let _=Math.min(m,c.distance(o[0],n[0]));if(_===0)return _;let b=new Ec([{dist:0,range1:[0,o.length-1],range2:[0,n.length-1]}],kh),I=e?Dd:Ya,E=l?Dd:Ya;for(;b.length;){let L=b.pop();if(L.dist>=_)continue;let F=L.range1,V=L.range2;if(oh(F)<=I&&oh(V)<=E){if(!sa(F,o.length)||!sa(V,n.length))return NaN;if(e&&l?_=Math.min(_,uo(o,F,n,V,c)):e||l?e&&!l?_=Math.min(_,Dr(n,V,o,F,c)):!e&&l&&(_=Math.min(_,Dr(o,F,n,V,c))):_=Math.min(_,Vf(o,F,n,V,c)),_===0)return _}else{let W=sh(F,e),H=sh(V,l);zd(b,_,c,o,n,W[0],H[0]),zd(b,_,c,o,n,W[0],H[1]),zd(b,_,c,o,n,W[1],H[0]),zd(b,_,c,o,n,W[1],H[1])}}return _}function ju(o,e,n,l,c=1/0){let m=c,_=oc(o,[0,o.length-1]);for(let b of n)if(!(m!==1/0&&Bl(_,oc(b,[0,b.length-1]),l)>=m)&&(m=Math.min(m,Ld(o,e,b,!0,l,m)),m===0))return m;return m}function Fh(o,e,n,l,c=1/0){let m=c,_=oc(o,[0,o.length-1]);for(let b of n){if(m!==1/0&&Bl(_,ah(b),l)>=m)continue;let I=Vp(o,e,b,l,m);if(isNaN(I))return I;if((m=Math.min(m,I))===0)return m}return m}function Gu(o){return o==="Point"||o==="MultiPoint"||o==="LineString"||o==="MultiLineString"||o==="Polygon"||o==="MultiPolygon"}class ch{constructor(e,n){this.type=Ri,this.geojson=e,this.geometries=n}static parse(e,n){if(e.length!==2)return n.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(wc(e[1])){let l=e[1];if(l.type==="FeatureCollection"){for(let c=0;c<l.features.length;++c)if(Gu(l.features[c].geometry.type))return new ch(l,l.features[c].geometry)}else if(l.type==="Feature"){if(Gu(l.geometry.type))return new ch(l,l.geometry)}else if(Gu(l.type))return new ch(l,l)}return n.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){let n=e.geometry(),l=e.canonicalID();if(n!=null&&l!=null){if(e.geometryType()==="Point")return function(c,m,_){let b=[];for(let E of c)for(let L of E)b.push(Oh(L,m));let I=new rh(b[0][1],"meters");return _.type==="Point"||_.type==="MultiPoint"||_.type==="LineString"?Ld(b,!1,_.type==="Point"?[_.coordinates]:_.coordinates,_.type==="LineString",I):_.type==="MultiLineString"?ju(b,!1,_.coordinates,I):_.type==="Polygon"||_.type==="MultiPolygon"?Fh(b,!1,_.type==="Polygon"?[_.coordinates]:_.coordinates,I):null}(n,l,this.geometries);if(e.geometryType()==="LineString")return function(c,m,_){let b=[];for(let E of c){let L=[];for(let F of E)L.push(Oh(F,m));b.push(L)}let I=new rh(b[0][0][1],"meters");if(_.type==="Point"||_.type==="MultiPoint"||_.type==="LineString")return ju(_.type==="Point"?[_.coordinates]:_.coordinates,_.type==="LineString",b,I);if(_.type==="MultiLineString"){let E=1/0;for(let L=0;L<_.coordinates.length;L++){let F=ju(_.coordinates[L],!0,b,I,E);if(isNaN(F))return F;if((E=Math.min(E,F))===0)return E}return E}if(_.type==="Polygon"||_.type==="MultiPolygon"){let E=1/0;for(let L=0;L<b.length;L++){let F=Fh(b[L],!0,_.type==="Polygon"?[_.coordinates]:_.coordinates,I,E);if(isNaN(F))return F;if((E=Math.min(E,F))===0)return E}return E}return null}(n,l,this.geometries);if(e.geometryType()==="Polygon")return function(c,m,_){let b=[];for(let E of function(L,F){let V=L.length;if(V<=1)return[L];let W=[],H,ee;for(let le=0;le<V;le++){let de=Js(L[le]);de!==0&&(L[le].area=Math.abs(de),ee===void 0&&(ee=de<0),ee===de<0?(H&&W.push(H),H=[L[le]]):H.push(L[le]))}return H&&W.push(H),W}(c)){let L=[];for(let F=0;F<E.length;++F)L.push(hf(E[F],m));b.push(L)}let I=new rh(b[0][0][0][1],"meters");if(_.type==="Point"||_.type==="MultiPoint"||_.type==="LineString")return Fh(_.type==="Point"?[_.coordinates]:_.coordinates,_.type==="LineString",b,I);if(_.type==="MultiLineString"){let E=1/0;for(let L=0;L<_.coordinates.length;L++){let F=Fh(_.coordinates[L],!0,b,I,E);if(isNaN(F))return F;if((E=Math.min(E,F))===0)return E}return E}return _.type==="Polygon"||_.type==="MultiPolygon"?function(E,L,F){let V=1/0;for(let W of E)for(let H of L){let ee=jf(W,H,F,V);if(isNaN(ee))return ee;if((V=Math.min(V,ee))===0)return V}return V}(_.type==="Polygon"?[_.coordinates]:_.coordinates,b,I):null}(n,l,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function fu(o,e){switch(o){case"string":return Ia(e);case"number":return+e;case"boolean":return!!e;case"color":return sr.parse(e);case"formatted":return Ks.fromString(Ia(e));case"resolvedImage":return Xa.build(Ia(e))}return e}function mu(o,e,n,l){return l!==void 0&&(o=l*Math.round(o/l)),e!==void 0&&o<e&&(o=e),n!==void 0&&o>n&&(o=n),o}class sc{constructor(e,n,l){this.type=e,this.key=n,this.scope=l}static parse(e,n){let l=n.expectedType;if(l==null&&(l=dr),e.length<2||e.length>3)return n.error("Invalid number of arguments for 'config' expression.");let c=n.parse(e[1],1);if(!(c instanceof Tn))return n.error("Key name of 'config' expression must be a string literal.");if(e.length>=3){let m=n.parse(e[2],2);return m instanceof Tn?new sc(l,Ia(c.value),Ia(m.value)):n.error("Scope of 'config' expression must be a string literal.")}return new sc(l,Ia(c.value))}evaluate(e){let n=[this.key,this.scope,e.scope].filter(Boolean).join(""),l=e.getConfig(n);if(!l)return null;let{type:c,value:m,values:_,minValue:b,maxValue:I,stepValue:E}=l,L=l.default.evaluate(e),F=L;if(m){let V=e.scope;e.scope=(V||"").split("").slice(1).join(""),F=m.evaluate(e),e.scope=V}return c&&(F=fu(c,F)),F===void 0||b===void 0&&I===void 0&&E===void 0||(typeof F=="number"?F=mu(F,b,I,E):Array.isArray(F)&&(F=F.map(V=>typeof V=="number"?mu(V,b,I,E):V))),m!==void 0&&F!==void 0&&_&&!_.includes(F)&&(F=L,c&&(F=fu(c,F))),(c&&c!==this.type||F!==void 0&&$o(F)!==this.type)&&(F=fu(this.type.kind,F)),F}eachChild(){}outputDefined(){return!1}serialize(){let e=["config",this.key];return this.scope&&e.concat(this.key),e}}function hh(o){if(o instanceof Ys&&(o.name==="get"&&o.args.length===1||o.name==="feature-state"||o.name==="has"&&o.args.length===1||o.name==="properties"||o.name==="geometry-type"||o.name==="id"||/^filter-/.test(o.name))||o instanceof nh||o instanceof ch)return!1;let e=!0;return o.eachChild(n=>{e&&!hh(n)&&(e=!1)}),e}function Zu(o){if(o instanceof Ys&&o.name==="feature-state")return!1;let e=!0;return o.eachChild(n=>{e&&!Zu(n)&&(e=!1)}),e}function ac(o){if(o instanceof sc)return new Set([o.key]);let e=new Set;return o.eachChild(n=>{e=new Set([...e,...ac(n)])}),e}function qu(o,e){if(o instanceof Ys&&e.indexOf(o.name)>=0)return!1;let n=!0;return o.eachChild(l=>{n&&!qu(l,e)&&(n=!1)}),n}class kd{constructor(e,n){this.type=n.type,this.name=e,this.boundExpression=n}static parse(e,n){if(e.length!==2||typeof e[1]!="string")return n.error("'var' expression requires exactly one string literal argument.");let l=e[1];return n.scope.has(l)?new kd(l,n.scope.get(l)):n.error(`Unknown variable "${l}". Make sure "${l}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class $u{constructor(e,n=[],l,c=new eh,m=[],_,b){this.registry=e,this.path=n,this.key=n.map(I=>typeof I=="string"?`['${I}']`:`[${I}]`).join(""),this.scope=c,this.errors=m,this.expectedType=l,this._scope=_,this.options=b}parse(e,n,l,c,m={}){return n||l?this.concat(n,null,l,c)._parse(e,m):this._parse(e,m)}parseObjectValue(e,n,l,c,m,_={}){return this.concat(n,l,c,m)._parse(e,_)}_parse(e,n){function l(c,m,_){return _==="assert"?new hn(m,[c]):_==="coerce"?new Ll(m,[c]):c}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');let c=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(c){let m=c.parse(e,this);if(!m)return null;if(this.expectedType){let _=this.expectedType,b=m.type;if(_.kind!=="string"&&_.kind!=="number"&&_.kind!=="boolean"&&_.kind!=="object"&&_.kind!=="array"||b.kind!=="value")if(_.kind!=="color"&&_.kind!=="formatted"&&_.kind!=="resolvedImage"||b.kind!=="value"&&b.kind!=="string"){if(this.checkSubtype(_,b))return null}else m=l(m,_,n.typeAnnotation||"coerce");else m=l(m,_,n.typeAnnotation||"assert")}if(!(m instanceof Tn)&&m.type.kind!=="resolvedImage"&&jp(m)){let _=new Bu(this._scope,this.options);try{m=new Tn(m.type,m.evaluate(_))}catch(b){return this.error(b.message),null}}return m}return Ll.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,n,l,c){let m=typeof e=="number"?this.path.concat(e):this.path;m=typeof n=="string"?m.concat(n):m;let _=c?this.scope.concat(c):this.scope;return new $u(this.registry,m,l||null,_,this.errors,this._scope,this.options)}error(e,...n){let l=`${this.key}${n.map(c=>`[${c}]`).join("")}`;this.errors.push(new La(l,e))}checkSubtype(e,n){let l=Rh(e,n);return l&&this.error(l),l}}var Up=$u;function jp(o){if(o instanceof kd)return jp(o.boundExpression);if(o instanceof Ys&&o.name==="error"||o instanceof cu||o instanceof nh||o instanceof ch||o instanceof sc)return!1;let e=o instanceof Ll||o instanceof hn,n=!0;return o.eachChild(l=>{n=e?n&&jp(l):n&&l instanceof Tn}),!!n&&hh(o)&&qu(o,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Od(o,e){let n=o.length-1,l,c,m=0,_=n,b=0;for(;m<=_;)if(b=Math.floor((m+_)/2),l=o[b],c=o[b+1],l<=e){if(b===n||e<c)return b;m=b+1}else{if(!(l>e))throw new Li("Input is not a number.");_=b-1}return 0}class uh{constructor(e,n,l){this.type=e,this.input=n,this.labels=[],this.outputs=[];for(let[c,m]of l)this.labels.push(c),this.outputs.push(m)}static parse(e,n){if(e.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return n.error("Expected an even number of arguments.");let l=n.parse(e[1],1,Ri);if(!l)return null;let c=[],m=null;n.expectedType&&n.expectedType.kind!=="value"&&(m=n.expectedType);for(let _=1;_<e.length;_+=2){let b=_===1?-1/0:e[_],I=e[_+1],E=_,L=_+1;if(typeof b!="number")return n.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',E);if(c.length&&c[c.length-1][0]>=b)return n.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',E);let F=n.parse(I,L,m);if(!F)return null;m=m||F.type,c.push([b,F])}return new uh(m,l,c)}evaluate(e){let n=this.labels,l=this.outputs;if(n.length===1)return l[0].evaluate(e);let c=this.input.evaluate(e);if(c<=n[0])return l[0].evaluate(e);let m=n.length;return c>=n[m-1]?l[m-1].evaluate(e):l[Od(n,c)].evaluate(e)}eachChild(e){e(this.input);for(let n of this.outputs)e(n)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e=["step",this.input.serialize()];for(let n=0;n<this.labels.length;n++)n>0&&e.push(this.labels[n]),e.push(this.outputs[n].serialize());return e}}let Fd=.95047,Bd=1.08883,uf=4/29,Ro=6/29,dh=3*Ro*Ro,Nl=Ro*Ro*Ro,Wu=Math.PI/180,Nd=180/Math.PI;function ph(o){return o>Nl?Math.pow(o,1/3):o/dh+uf}function Bh(o){return o>Ro?o*o*o:dh*(o-uf)}function Vd(o){return 255*(o<=.0031308?12.92*o:1.055*Math.pow(o,1/2.4)-.055)}function _u(o){return(o/=255)<=.04045?o/12.92:Math.pow((o+.055)/1.055,2.4)}function Ud(o){let e=_u(o.r),n=_u(o.g),l=_u(o.b),c=ph((.4124564*e+.3575761*n+.1804375*l)/Fd),m=ph((.2126729*e+.7151522*n+.072175*l)/1);return{l:116*m-16,a:500*(c-m),b:200*(m-ph((.0193339*e+.119192*n+.9503041*l)/Bd)),alpha:o.a}}function Gp(o){let e=(o.l+16)/116,n=isNaN(o.a)?e:e+o.a/500,l=isNaN(o.b)?e:e-o.b/200;return e=1*Bh(e),n=Fd*Bh(n),l=Bd*Bh(l),new sr(Vd(3.2404542*n-1.5371385*e-.4985314*l),Vd(-.969266*n+1.8760108*e+.041556*l),Vd(.0556434*n-.2040259*e+1.0572252*l),o.alpha)}function gu(o,e,n){let l=e-o;return o+n*(l>180||l<-180?l-360*Math.round(l/360):l)}let lc={forward:Ud,reverse:Gp,interpolate:function(o,e,n){return{l:en(o.l,e.l,n),a:en(o.a,e.a,n),b:en(o.b,e.b,n),alpha:en(o.alpha,e.alpha,n)}}},cc={forward:function(o){let{l:e,a:n,b:l}=Ud(o),c=Math.atan2(l,n)*Nd;return{h:c<0?c+360:c,c:Math.sqrt(n*n+l*l),l:e,alpha:o.a}},reverse:function(o){let e=o.h*Wu,n=o.c;return Gp({l:o.l,a:Math.cos(e)*n,b:Math.sin(e)*n,alpha:o.alpha})},interpolate:function(o,e,n){return{h:gu(o.h,e.h,n),c:en(o.c,e.c,n),l:en(o.l,e.l,n),alpha:en(o.alpha,e.alpha,n)}}};var Ja=Object.freeze({__proto__:null,hcl:cc,lab:lc});class es{constructor(e,n,l,c,m){this.type=e,this.operator=n,this.interpolation=l,this.input=c,this.labels=[],this.outputs=[];for(let[_,b]of m)this.labels.push(_),this.outputs.push(b)}static interpolationFactor(e,n,l,c){let m=0;if(e.name==="exponential")m=yu(n,e.base,l,c);else if(e.name==="linear")m=yu(n,1,l,c);else if(e.name==="cubic-bezier"){let _=e.controlPoints;m=new Zt(_[0],_[1],_[2],_[3]).solve(yu(n,1,l,c))}return m}static parse(e,n){let[l,c,m,..._]=e;if(!Array.isArray(c)||c.length===0)return n.error("Expected an interpolation type expression.",1);if(c[0]==="linear")c={name:"linear"};else if(c[0]==="exponential"){let E=c[1];if(typeof E!="number")return n.error("Exponential interpolation requires a numeric base.",1,1);c={name:"exponential",base:E}}else{if(c[0]!=="cubic-bezier")return n.error(`Unknown interpolation type ${String(c[0])}`,1,0);{let E=c.slice(1);if(E.length!==4||E.some(L=>typeof L!="number"||L<0||L>1))return n.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);c={name:"cubic-bezier",controlPoints:E}}}if(e.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return n.error("Expected an even number of arguments.");if(m=n.parse(m,2,Ri),!m)return null;let b=[],I=null;l==="interpolate-hcl"||l==="interpolate-lab"?I=Do:n.expectedType&&n.expectedType.kind!=="value"&&(I=n.expectedType);for(let E=0;E<_.length;E+=2){let L=_[E],F=_[E+1],V=E+3,W=E+4;if(typeof L!="number")return n.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',V);if(b.length&&b[b.length-1][0]>=L)return n.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',V);let H=n.parse(F,W,I);if(!H)return null;I=I||H.type,b.push([L,H])}return I.kind==="number"||I.kind==="color"||I.kind==="array"&&I.itemType.kind==="number"&&typeof I.N=="number"?new es(I,l,c,m,b):n.error(`Type ${us(I)} is not interpolatable.`)}evaluate(e){let n=this.labels,l=this.outputs;if(n.length===1)return l[0].evaluate(e);let c=this.input.evaluate(e);if(c<=n[0])return l[0].evaluate(e);let m=n.length;if(c>=n[m-1])return l[m-1].evaluate(e);let _=Od(n,c),b=es.interpolationFactor(this.interpolation,c,n[_],n[_+1]),I=l[_].evaluate(e),E=l[_+1].evaluate(e);return this.operator==="interpolate"?Dp[this.type.kind.toLowerCase()](I,E,b):this.operator==="interpolate-hcl"?cc.reverse(cc.interpolate(cc.forward(I),cc.forward(E),b)):lc.reverse(lc.interpolate(lc.forward(I),lc.forward(E),b))}eachChild(e){e(this.input);for(let n of this.outputs)e(n)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];let n=[this.operator,e,this.input.serialize()];for(let l=0;l<this.labels.length;l++)n.push(this.labels[l],this.outputs[l].serialize());return n}}function yu(o,e,n,l){let c=l-n,m=o-n;return c===0?0:e===1?m/c:(Math.pow(e,m)-1)/(Math.pow(e,c)-1)}class jd{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expectected at least one argument.");let l=null,c=n.expectedType;c&&c.kind!=="value"&&(l=c);let m=[];for(let b of e.slice(1)){let I=n.parse(b,1+m.length,l,void 0,{typeAnnotation:"omit"});if(!I)return null;l=l||I.type,m.push(I)}let _=c&&m.some(b=>Rh(c,b.type));return new jd(_?dr:l,m)}evaluate(e){let n,l=null,c=0;for(let m of this.args){if(c++,l=m.evaluate(e),l&&l instanceof Xa&&!l.available&&(n||(n=l),l=null,c===this.args.length))return n;if(l!==null)break}return l}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){let e=["coalesce"];return this.eachChild(n=>{e.push(n.serialize())}),e}}class Gd{constructor(e,n){this.type=n.type,this.bindings=[].concat(e),this.result=n}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(let n of this.bindings)e(n[1]);e(this.result)}static parse(e,n){if(e.length<4)return n.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);let l=[];for(let m=1;m<e.length-1;m+=2){let _=e[m];if(typeof _!="string")return n.error(`Expected string, but found ${typeof _} instead.`,m);if(/[^a-zA-Z0-9_]/.test(_))return n.error("Variable names must contain only alphanumeric characters or '_'.",m);let b=n.parse(e[m+1],m+1);if(!b)return null;l.push([_,b])}let c=n.parse(e[e.length-1],e.length-1,n.expectedType,l);return c?new Gd(l,c):null}outputDefined(){return this.result.outputDefined()}serialize(){let e=["let"];for(let[n,l]of this.bindings)e.push(n,l.serialize());return e.push(this.result.serialize()),e}}class fh{constructor(e,n,l){this.type=e,this.index=n,this.input=l}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let l=n.parse(e[1],1,Ri),c=n.parse(e[2],2,ka(n.expectedType||dr));return l&&c?new fh(c.type.itemType,l,c):null}evaluate(e){let n=this.index.evaluate(e),l=this.input.evaluate(e);if(n<0)throw new Li(`Array index out of bounds: ${n} < 0.`);if(n>=l.length)throw new Li(`Array index out of bounds: ${n} > ${l.length-1}.`);if(n!==Math.floor(n))throw new Li(`Array index must be an integer, but found ${n} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return l[n]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Hu{constructor(e,n,l){this.type=e,this.index=n,this.input=l}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let l=n.parse(e[1],1,Ri),c=n.parse(e[2],2,ka(n.expectedType||dr));return l&&c?new Hu(c.type.itemType,l,c):null}evaluate(e){let n=this.index.evaluate(e),l=this.input.evaluate(e);if(n<0)throw new Li(`Array index out of bounds: ${n} < 0.`);if(n>l.length-1)throw new Li(`Array index out of bounds: ${n} > ${l.length-1}.`);if(n===Math.floor(n))return l[n];let c=Math.floor(n),m=Math.ceil(n),_=l[c],b=l[m];if(typeof _!="number"||typeof b!="number")throw new Li(`Cannot interpolate between non-number values at index ${n}.`);let I=n-c;return _*(1-I)+b*I}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class Xu{constructor(e,n){this.type=Xn,this.needle=e,this.haystack=n}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let l=n.parse(e[1],1,dr),c=n.parse(e[2],2,dr);return l&&c?ku(l.type,[Xn,br,Ri,Dh,dr])?new Xu(l,c):n.error(`Expected first argument to be of type boolean, string, number or null, but found ${us(l.type)} instead`):null}evaluate(e){let n=this.needle.evaluate(e),l=this.haystack.evaluate(e);if(l==null)return!1;if(!th(n,["boolean","string","number","null"]))throw new Li(`Expected first argument to be of type boolean, string, number or null, but found ${us($o(n))} instead.`);if(!th(l,["string","array"]))throw new Li(`Expected second argument to be of type array or string, but found ${us($o(l))} instead.`);return l.indexOf(n)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Zd{constructor(e,n,l){this.type=Ri,this.needle=e,this.haystack=n,this.fromIndex=l}static parse(e,n){if(e.length<=2||e.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);let l=n.parse(e[1],1,dr),c=n.parse(e[2],2,dr);if(!l||!c)return null;if(!ku(l.type,[Xn,br,Ri,Dh,dr]))return n.error(`Expected first argument to be of type boolean, string, number or null, but found ${us(l.type)} instead`);if(e.length===4){let m=n.parse(e[3],3,Ri);return m?new Zd(l,c,m):null}return new Zd(l,c)}evaluate(e){let n=this.needle.evaluate(e),l=this.haystack.evaluate(e);if(!th(n,["boolean","string","number","null"]))throw new Li(`Expected first argument to be of type boolean, string, number or null, but found ${us($o(n))} instead.`);if(!th(l,["string","array"]))throw new Li(`Expected second argument to be of type array or string, but found ${us($o(l))} instead.`);if(this.fromIndex){let c=this.fromIndex.evaluate(e);return l.indexOf(n,c)}return l.indexOf(n)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){let e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Ku{constructor(e,n,l,c,m,_){this.inputType=e,this.type=n,this.input=l,this.cases=c,this.outputs=m,this.otherwise=_}static parse(e,n){if(e.length<5)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return n.error("Expected an even number of arguments.");let l,c;n.expectedType&&n.expectedType.kind!=="value"&&(c=n.expectedType);let m={},_=[];for(let E=2;E<e.length-1;E+=2){let L=e[E],F=e[E+1];Array.isArray(L)||(L=[L]);let V=n.concat(E);if(L.length===0)return V.error("Expected at least one branch label.");for(let H of L){if(typeof H!="number"&&typeof H!="string")return V.error("Branch labels must be numbers or strings.");if(typeof H=="number"&&Math.abs(H)>Number.MAX_SAFE_INTEGER)return V.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof H=="number"&&Math.floor(H)!==H)return V.error("Numeric branch labels must be integer values.");if(l){if(V.checkSubtype(l,$o(H)))return null}else l=$o(H);if(m[String(H)]!==void 0)return V.error("Branch labels must be unique.");m[String(H)]=_.length}let W=n.parse(F,E,c);if(!W)return null;c=c||W.type,_.push(W)}let b=n.parse(e[1],1,dr);if(!b)return null;let I=n.parse(e[e.length-1],e.length-1,c);return I?b.type.kind!=="value"&&n.concat(1).checkSubtype(l,b.type)?null:new Ku(l,c,b,m,_,I):null}evaluate(e){let n=this.input.evaluate(e);return($o(n)===this.inputType&&this.outputs[this.cases[n]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){let e=["match",this.input.serialize()],n=Object.keys(this.cases).sort(),l=[],c={};for(let _ of n){let b=c[this.cases[_]];b===void 0?(c[this.cases[_]]=l.length,l.push([this.cases[_],[_]])):l[b][1].push(_)}let m=_=>this.inputType.kind==="number"?Number(_):_;for(let[_,b]of l)e.push(b.length===1?m(b[0]):b.map(m)),e.push(this.outputs[_].serialize());return e.push(this.otherwise.serialize()),e}}class xu{constructor(e,n,l){this.type=e,this.branches=n,this.otherwise=l}static parse(e,n){if(e.length<4)return n.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return n.error("Expected an odd number of arguments.");let l;n.expectedType&&n.expectedType.kind!=="value"&&(l=n.expectedType);let c=[];for(let _=1;_<e.length-1;_+=2){let b=n.parse(e[_],_,Xn);if(!b)return null;let I=n.parse(e[_+1],_+1,l);if(!I)return null;c.push([b,I]),l=l||I.type}let m=n.parse(e[e.length-1],e.length-1,l);return m?new xu(l,c,m):null}evaluate(e){for(let[n,l]of this.branches)if(n.evaluate(e))return l.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(let[n,l]of this.branches)e(n),e(l);e(this.otherwise)}outputDefined(){return this.branches.every(([e,n])=>n.outputDefined())&&this.otherwise.outputDefined()}serialize(){let e=["case"];return this.eachChild(n=>{e.push(n.serialize())}),e}}class Mc{constructor(e,n,l,c){this.type=e,this.input=n,this.beginIndex=l,this.endIndex=c}static parse(e,n){if(e.length<=2||e.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);let l=n.parse(e[1],1,dr),c=n.parse(e[2],2,Ri);if(!l||!c)return null;if(!ku(l.type,[ka(dr),br,dr]))return n.error(`Expected first argument to be of type array or string, but found ${us(l.type)} instead`);if(e.length===4){let m=n.parse(e[3],3,Ri);return m?new Mc(l.type,l,c,m):null}return new Mc(l.type,l,c)}evaluate(e){let n=this.input.evaluate(e),l=this.beginIndex.evaluate(e);if(!th(n,["string","array"]))throw new Li(`Expected first argument to be of type array or string, but found ${us($o(n))} instead.`);if(this.endIndex){let c=this.endIndex.evaluate(e);return n.slice(l,c)}return n.slice(l)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){let e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function Oa(o,e){return o==="=="||o==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function Vl(o,e,n,l){return l.compare(e,n)===0}function Nh(o,e,n){let l=o!=="=="&&o!=="!=";return class ww{constructor(m,_,b){this.type=Xn,this.lhs=m,this.rhs=_,this.collator=b,this.hasUntypedArgument=m.type.kind==="value"||_.type.kind==="value"}static parse(m,_){if(m.length!==3&&m.length!==4)return _.error("Expected two or three arguments.");let b=m[0],I=_.parse(m[1],1,dr);if(!I)return null;if(!Oa(b,I.type))return _.concat(1).error(`"${b}" comparisons are not supported for type '${us(I.type)}'.`);let E=_.parse(m[2],2,dr);if(!E)return null;if(!Oa(b,E.type))return _.concat(2).error(`"${b}" comparisons are not supported for type '${us(E.type)}'.`);if(I.type.kind!==E.type.kind&&I.type.kind!=="value"&&E.type.kind!=="value")return _.error(`Cannot compare types '${us(I.type)}' and '${us(E.type)}'.`);l&&(I.type.kind==="value"&&E.type.kind!=="value"?I=new hn(E.type,[I]):I.type.kind!=="value"&&E.type.kind==="value"&&(E=new hn(I.type,[E])));let L=null;if(m.length===4){if(I.type.kind!=="string"&&E.type.kind!=="string"&&I.type.kind!=="value"&&E.type.kind!=="value")return _.error("Cannot use collator to compare non-string types.");if(L=_.parse(m[3],3,Rl),!L)return null}return new ww(I,E,L)}evaluate(m){let _=this.lhs.evaluate(m),b=this.rhs.evaluate(m);if(l&&this.hasUntypedArgument){let I=$o(_),E=$o(b);if(I.kind!==E.kind||I.kind!=="string"&&I.kind!=="number")throw new Li(`Expected arguments for "${o}" to be (string, string) or (number, number), but found (${I.kind}, ${E.kind}) instead.`)}if(this.collator&&!l&&this.hasUntypedArgument){let I=$o(_),E=$o(b);if(I.kind!=="string"||E.kind!=="string")return e(m,_,b)}return this.collator?n(m,_,b,this.collator.evaluate(m)):e(m,_,b)}eachChild(m){m(this.lhs),m(this.rhs),this.collator&&m(this.collator)}outputDefined(){return!0}serialize(){let m=[o];return this.eachChild(_=>{m.push(_.serialize())}),m}}}let Qa=Nh("==",function(o,e,n){return e===n},Vl),Yu=Nh("!=",function(o,e,n){return e!==n},function(o,e,n,l){return!Vl(0,e,n,l)}),Gf=Nh("<",function(o,e,n){return e<n},function(o,e,n,l){return l.compare(e,n)<0}),qd=Nh(">",function(o,e,n){return e>n},function(o,e,n,l){return l.compare(e,n)>0}),Mm=Nh("<=",function(o,e,n){return e<=n},function(o,e,n,l){return l.compare(e,n)<=0}),df=Nh(">=",function(o,e,n){return e>=n},function(o,e,n,l){return l.compare(e,n)>=0});class vu{constructor(e,n,l,c,m,_){this.type=br,this.number=e,this.locale=n,this.currency=l,this.unit=c,this.minFractionDigits=m,this.maxFractionDigits=_}static parse(e,n){if(e.length!==3)return n.error("Expected two arguments.");let l=n.parse(e[1],1,Ri);if(!l)return null;let c=e[2];if(typeof c!="object"||Array.isArray(c))return n.error("NumberFormat options argument must be an object.");let m=null;if(c.locale&&(m=n.parseObjectValue(c.locale,2,"locale",br),!m))return null;let _=null;if(c.currency&&(_=n.parseObjectValue(c.currency,2,"currency",br),!_))return null;let b=null;if(c.unit&&(b=n.parseObjectValue(c.unit,2,"unit",br),!b))return null;let I=null;if(c["min-fraction-digits"]&&(I=n.parseObjectValue(c["min-fraction-digits"],2,"min-fraction-digits",Ri),!I))return null;let E=null;return c["max-fraction-digits"]&&(E=n.parseObjectValue(c["max-fraction-digits"],2,"max-fraction-digits",Ri),!E)?null:new vu(l,m,_,b,I,E)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){let e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Pc{constructor(e){this.type=Ri,this.input=e}static parse(e,n){if(e.length!==2)return n.error(`Expected 1 argument, but found ${e.length-1} instead.`);let l=n.parse(e[1],1);return l?l.type.kind!=="array"&&l.type.kind!=="string"&&l.type.kind!=="value"?n.error(`Expected argument of type string or array, but found ${us(l.type)} instead.`):new Pc(l):null}evaluate(e){let n=this.input.evaluate(e);if(typeof n=="string"||Array.isArray(n))return n.length;throw new Li(`Expected value to be of type string or array, but found ${us($o(n))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){let e=["length"];return this.eachChild(n=>{e.push(n.serialize())}),e}}function hc(o){return function(){o=1831565813+(o|=0)|0;let e=Math.imul(o^o>>>15,1|o);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}let sn={"==":Qa,"!=":Yu,">":qd,"<":Gf,">=":df,"<=":Mm,array:hn,at:fh,"at-interpolated":Hu,boolean:hn,case:xu,coalesce:jd,collator:cu,format:zh,image:Fu,in:Xu,"index-of":Zd,interpolate:es,"interpolate-hcl":es,"interpolate-lab":es,length:Pc,let:Gd,literal:Tn,match:Ku,number:hn,"number-format":vu,object:hn,slice:Mc,step:uh,string:hn,"to-boolean":Ll,"to-color":Ll,"to-number":Ll,"to-string":Ll,var:kd,within:nh,distance:ch,config:sc};function Zp(o,[e,n,l,c]){e=e.evaluate(o),n=n.evaluate(o),l=l.evaluate(o);let m=c?c.evaluate(o):1,_=Rp(e,n,l,m);if(_)throw new Li(_);return new sr(e/255*m,n/255*m,l/255*m,m)}function Ju(o,[e,n,l,c]){e=e.evaluate(o),n=n.evaluate(o),l=l.evaluate(o);let m=c?c.evaluate(o):1,_=function(E,L,F,V){return typeof E=="number"&&E>=0&&E<=360?typeof L=="number"&&L>=0&&L<=100&&typeof F=="number"&&F>=0&&F<=100?V===void 0||typeof V=="number"&&V>=0&&V<=1?null:`Invalid hsla value [${[E,L,F,V].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof V=="number"?[E,L,F,V]:[E,L,F]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof V=="number"?[E,L,F,V]:[E,L,F]).join(", ")}]: 'h' must be between 0 and 360.`}(e,n,l,m);if(_)throw new Li(_);let b=`hsla(${e}, ${n}%, ${l}%, ${m})`,I=sr.parse(b);if(!I)throw new Li(`Failed to parse HSLA color: ${b}`);return I}function $d(o,e){return o in e}function Vh(o,e){let n=e[o];return n===void 0?null:n}function gl(o){return{type:o}}function qp(o){return{result:"success",value:o}}function ar(o){return{result:"error",value:o}}function Wd(o,e){return!!o&&!!o.parameters&&o.parameters.indexOf(e)>-1}function Hd(o){return o["property-type"]==="data-driven"}function Xd(o){return Wd(o.expression,"measure-light")}function pf(o){return Wd(o.expression,"zoom")}function $p(o){return!!o.expression&&o.expression.interpolated}function Qu(o){return typeof o=="object"&&o!==null&&!Array.isArray(o)}function Kd(o){return o}function ed(o,e){let n=e.type==="color",l=o.stops&&typeof o.stops[0][0]=="object",c=l||!(l||o.property!==void 0),m=o.type||($p(e)?"exponential":"interval");if(n&&((o=Dl({},o)).stops&&(o.stops=o.stops.map(E=>[E[0],sr.parse(E[1])])),o.default=sr.parse(o.default?o.default:e.default)),o.colorSpace&&o.colorSpace!=="rgb"&&!Ja[o.colorSpace])throw new Error(`Unknown color space: ${o.colorSpace}`);let _,b,I;if(m==="exponential")_=Yd;else if(m==="interval")_=Pm;else if(m==="categorical"){_=td,b=Object.create(null);for(let E of o.stops)b[E[0]]=E[1];I=typeof o.stops[0][0]}else{if(m!=="identity")throw new Error(`Unknown function type "${m}"`);_=jh}if(l){let E={},L=[];for(let W=0;W<o.stops.length;W++){let H=o.stops[W],ee=H[0].zoom;E[ee]===void 0&&(E[ee]={zoom:ee,type:o.type,property:o.property,default:o.default,stops:[]},L.push(ee)),E[ee].stops.push([H[0].value,H[1]])}let F=[];for(let W of L)F.push([E[W].zoom,ed(E[W],e)]);let V={name:"linear"};return{kind:"composite",interpolationType:V,interpolationFactor:es.interpolationFactor.bind(void 0,V),zoomStops:F.map(W=>W[0]),evaluate:({zoom:W},H)=>Yd({stops:F,base:o.base},e,W).evaluate(W,H)}}if(c){let E=m==="exponential"?{name:"exponential",base:o.base!==void 0?o.base:1}:null;return{kind:"camera",interpolationType:E,interpolationFactor:es.interpolationFactor.bind(void 0,E),zoomStops:o.stops.map(L=>L[0]),evaluate:({zoom:L})=>_(o,e,L,b,I)}}return{kind:"source",evaluate(E,L){let F=L&&L.properties?L.properties[o.property]:void 0;return F===void 0?Uh(o.default,e.default):_(o,e,F,b,I)}}}function Uh(o,e,n){return o!==void 0?o:e!==void 0?e:n!==void 0?n:void 0}function td(o,e,n,l,c){return Uh(typeof n===c?l[n]:void 0,o.default,e.default)}function Pm(o,e,n){if(ln(n)!=="number")return Uh(o.default,e.default);let l=o.stops.length;if(l===1||n<=o.stops[0][0])return o.stops[0][1];if(n>=o.stops[l-1][0])return o.stops[l-1][1];let c=Od(o.stops.map(m=>m[0]),n);return o.stops[c][1]}function Yd(o,e,n){let l=o.base!==void 0?o.base:1;if(ln(n)!=="number")return Uh(o.default,e.default);let c=o.stops.length;if(c===1||n<=o.stops[0][0])return o.stops[0][1];if(n>=o.stops[c-1][0])return o.stops[c-1][1];let m=Od(o.stops.map(L=>L[0]),n),_=function(L,F,V,W){let H=W-V,ee=L-V;return H===0?0:F===1?ee/H:(Math.pow(F,ee)-1)/(Math.pow(F,H)-1)}(n,l,o.stops[m][0],o.stops[m+1][0]),b=o.stops[m][1],I=o.stops[m+1][1],E=Dp[e.type]||Kd;if(o.colorSpace&&o.colorSpace!=="rgb"){let L=Ja[o.colorSpace];E=(F,V)=>L.reverse(L.interpolate(L.forward(F),L.forward(V),_))}return typeof b.evaluate=="function"?{evaluate(...L){let F=b.evaluate.apply(void 0,L),V=I.evaluate.apply(void 0,L);if(F!==void 0&&V!==void 0)return E(F,V,_)}}:E(b,I,_)}function jh(o,e,n){return e.type==="color"?n=sr.parse(n):e.type==="formatted"?n=Ks.fromString(n.toString()):e.type==="resolvedImage"?n=Xa.build(n.toString()):ln(n)===e.type||e.type==="enum"&&e.values[n]||(n=void 0),Uh(n,o.default,e.default)}Ys.register(sn,{error:[{kind:"error"},[br],(o,[e])=>{throw new Li(e.evaluate(o))}],typeof:[br,[dr],(o,[e])=>us($o(e.evaluate(o)))],"to-rgba":[ka(Ri,4),[Do],(o,[e])=>e.evaluate(o).toRenderColor(null).toArray()],"to-hsla":[ka(Ri,4),[Do],(o,[e])=>e.evaluate(o).toRenderColor(null).toHslaArray()],rgb:[Do,[Ri,Ri,Ri],Zp],rgba:[Do,[Ri,Ri,Ri,Ri],Zp],hsl:[Do,[Ri,Ri,Ri],Ju],hsla:[Do,[Ri,Ri,Ri,Ri],Ju],has:{type:Xn,overloads:[[[br],(o,[e])=>$d(e.evaluate(o),o.properties())],[[br,bc],(o,[e,n])=>$d(e.evaluate(o),n.evaluate(o))]]},get:{type:dr,overloads:[[[br],(o,[e])=>Vh(e.evaluate(o),o.properties())],[[br,bc],(o,[e,n])=>Vh(e.evaluate(o),n.evaluate(o))]]},"feature-state":[dr,[br],(o,[e])=>Vh(e.evaluate(o),o.featureState||{})],properties:[bc,[],o=>o.properties()],"geometry-type":[br,[],o=>o.geometryType()],id:[dr,[],o=>o.id()],zoom:[Ri,[],o=>o.globals.zoom],pitch:[Ri,[],o=>o.globals.pitch||0],"distance-from-center":[Ri,[],o=>o.distanceFromCenter()],"measure-light":[Ri,[br],(o,[e])=>o.measureLight(e.evaluate(o))],"heatmap-density":[Ri,[],o=>o.globals.heatmapDensity||0],"line-progress":[Ri,[],o=>o.globals.lineProgress||0],"raster-value":[Ri,[],o=>o.globals.rasterValue||0],"raster-particle-speed":[Ri,[],o=>o.globals.rasterParticleSpeed||0],"sky-radial-progress":[Ri,[],o=>o.globals.skyRadialProgress||0],accumulated:[dr,[],o=>o.globals.accumulated===void 0?null:o.globals.accumulated],"+":[Ri,gl(Ri),(o,e)=>{let n=0;for(let l of e)n+=l.evaluate(o);return n}],"*":[Ri,gl(Ri),(o,e)=>{let n=1;for(let l of e)n*=l.evaluate(o);return n}],"-":{type:Ri,overloads:[[[Ri,Ri],(o,[e,n])=>e.evaluate(o)-n.evaluate(o)],[[Ri],(o,[e])=>-e.evaluate(o)]]},"/":[Ri,[Ri,Ri],(o,[e,n])=>e.evaluate(o)/n.evaluate(o)],"%":[Ri,[Ri,Ri],(o,[e,n])=>e.evaluate(o)%n.evaluate(o)],ln2:[Ri,[],()=>Math.LN2],pi:[Ri,[],()=>Math.PI],e:[Ri,[],()=>Math.E],"^":[Ri,[Ri,Ri],(o,[e,n])=>Math.pow(e.evaluate(o),n.evaluate(o))],sqrt:[Ri,[Ri],(o,[e])=>Math.sqrt(e.evaluate(o))],log10:[Ri,[Ri],(o,[e])=>Math.log(e.evaluate(o))/Math.LN10],ln:[Ri,[Ri],(o,[e])=>Math.log(e.evaluate(o))],log2:[Ri,[Ri],(o,[e])=>Math.log(e.evaluate(o))/Math.LN2],sin:[Ri,[Ri],(o,[e])=>Math.sin(e.evaluate(o))],cos:[Ri,[Ri],(o,[e])=>Math.cos(e.evaluate(o))],tan:[Ri,[Ri],(o,[e])=>Math.tan(e.evaluate(o))],asin:[Ri,[Ri],(o,[e])=>Math.asin(e.evaluate(o))],acos:[Ri,[Ri],(o,[e])=>Math.acos(e.evaluate(o))],atan:[Ri,[Ri],(o,[e])=>Math.atan(e.evaluate(o))],min:[Ri,gl(Ri),(o,e)=>Math.min(...e.map(n=>n.evaluate(o)))],max:[Ri,gl(Ri),(o,e)=>Math.max(...e.map(n=>n.evaluate(o)))],abs:[Ri,[Ri],(o,[e])=>Math.abs(e.evaluate(o))],round:[Ri,[Ri],(o,[e])=>{let n=e.evaluate(o);return n<0?-Math.round(-n):Math.round(n)}],floor:[Ri,[Ri],(o,[e])=>Math.floor(e.evaluate(o))],ceil:[Ri,[Ri],(o,[e])=>Math.ceil(e.evaluate(o))],"filter-==":[Xn,[br,dr],(o,[e,n])=>o.properties()[e.value]===n.value],"filter-id-==":[Xn,[dr],(o,[e])=>o.id()===e.value],"filter-type-==":[Xn,[br],(o,[e])=>o.geometryType()===e.value],"filter-<":[Xn,[br,dr],(o,[e,n])=>{let l=o.properties()[e.value],c=n.value;return typeof l==typeof c&&l<c}],"filter-id-<":[Xn,[dr],(o,[e])=>{let n=o.id(),l=e.value;return typeof n==typeof l&&n<l}],"filter->":[Xn,[br,dr],(o,[e,n])=>{let l=o.properties()[e.value],c=n.value;return typeof l==typeof c&&l>c}],"filter-id->":[Xn,[dr],(o,[e])=>{let n=o.id(),l=e.value;return typeof n==typeof l&&n>l}],"filter-<=":[Xn,[br,dr],(o,[e,n])=>{let l=o.properties()[e.value],c=n.value;return typeof l==typeof c&&l<=c}],"filter-id-<=":[Xn,[dr],(o,[e])=>{let n=o.id(),l=e.value;return typeof n==typeof l&&n<=l}],"filter->=":[Xn,[br,dr],(o,[e,n])=>{let l=o.properties()[e.value],c=n.value;return typeof l==typeof c&&l>=c}],"filter-id->=":[Xn,[dr],(o,[e])=>{let n=o.id(),l=e.value;return typeof n==typeof l&&n>=l}],"filter-has":[Xn,[dr],(o,[e])=>e.value in o.properties()],"filter-has-id":[Xn,[],o=>o.id()!==null&&o.id()!==void 0],"filter-type-in":[Xn,[ka(br)],(o,[e])=>e.value.indexOf(o.geometryType())>=0],"filter-id-in":[Xn,[ka(dr)],(o,[e])=>e.value.indexOf(o.id())>=0],"filter-in-small":[Xn,[br,ka(dr)],(o,[e,n])=>n.value.indexOf(o.properties()[e.value])>=0],"filter-in-large":[Xn,[br,ka(dr)],(o,[e,n])=>function(l,c,m,_){for(;m<=_;){let b=m+_>>1;if(c[b]===l)return!0;c[b]>l?_=b-1:m=b+1}return!1}(o.properties()[e.value],n.value,0,n.value.length-1)],all:{type:Xn,overloads:[[[Xn,Xn],(o,[e,n])=>e.evaluate(o)&&n.evaluate(o)],[gl(Xn),(o,e)=>{for(let n of e)if(!n.evaluate(o))return!1;return!0}]]},any:{type:Xn,overloads:[[[Xn,Xn],(o,[e,n])=>e.evaluate(o)||n.evaluate(o)],[gl(Xn),(o,e)=>{for(let n of e)if(n.evaluate(o))return!0;return!1}]]},"!":[Xn,[Xn],(o,[e])=>!e.evaluate(o)],"is-supported-script":[Xn,[br],(o,[e])=>{let n=o.globals&&o.globals.isSupportedScript;return!n||n(e.evaluate(o))}],upcase:[br,[br],(o,[e])=>e.evaluate(o).toUpperCase()],downcase:[br,[br],(o,[e])=>e.evaluate(o).toLowerCase()],concat:[br,gl(dr),(o,e)=>e.map(n=>Ia(n.evaluate(o))).join("")],"resolved-locale":[br,[Rl],(o,[e])=>e.evaluate(o).resolvedLocale()],random:[Ri,[Ri,Ri,dr],(o,e)=>{let[n,l,c]=e.map(_=>_.evaluate(o));if(n>l||n===l)return n;let m;if(typeof c=="string")m=function(_){let b=0;if(_.length===0)return b;for(let I=0;I<_.length;I++)b=(b<<5)-b+_.charCodeAt(I),b|=0;return b}(c);else{if(typeof c!="number")throw new Li(`Invalid seed input: ${c}`);m=c}return n+hc(m)()*(l-n)}]});class jo{constructor(e,n,l,c){this.expression=e,this._warningHistory={},this._evaluator=new Bu(l,c),this._defaultValue=n?function(m){return m.type==="color"&&(Qu(m.default)||Array.isArray(m.default))?new sr(0,0,0,0):m.type==="color"?sr.parse(m.default)||null:m.default===void 0?null:m.default}(n):null,this._enumValues=n&&n.type==="enum"?n.values:null,this.configDependencies=ac(e)}evaluateWithoutErrorHandling(e,n,l,c,m,_,b,I){return this._evaluator.globals=e,this._evaluator.feature=n,this._evaluator.featureState=l,this._evaluator.canonical=c||null,this._evaluator.availableImages=m||null,this._evaluator.formattedSection=_,this._evaluator.featureTileCoord=b||null,this._evaluator.featureDistanceData=I||null,this.expression.evaluate(this._evaluator)}evaluate(e,n,l,c,m,_,b,I){this._evaluator.globals=e,this._evaluator.feature=n||null,this._evaluator.featureState=l||null,this._evaluator.canonical=c||null,this._evaluator.availableImages=m||null,this._evaluator.formattedSection=_||null,this._evaluator.featureTileCoord=b||null,this._evaluator.featureDistanceData=I||null;try{let E=this.expression.evaluate(this._evaluator);if(E==null||typeof E=="number"&&E!=E)return this._defaultValue;if(this._enumValues&&!(E in this._enumValues))throw new Li(`Expected value to be one of ${Object.keys(this._enumValues).map(L=>JSON.stringify(L)).join(", ")}, but found ${JSON.stringify(E)} instead.`);return E}catch(E){return this._warningHistory[E.message]||(this._warningHistory[E.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${E.message}`)),this._defaultValue}}}function Gh(o){return Array.isArray(o)&&o.length>0&&typeof o[0]=="string"&&o[0]in sn}function mh(o,e,n,l){let c=new Up(sn,[],e?function(_){let b={color:Do,string:br,number:Ri,enum:br,boolean:Xn,formatted:lu,resolvedImage:Md};return _.type==="array"?ka(b[_.value]||dr,_.length):b[_.type]}(e):void 0,void 0,void 0,n,l),m=c.parse(o,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return m?qp(new jo(m,e,n,l)):ar(c.errors)}class _h{constructor(e,n,l,c){this.kind=e,this._styleExpression=n,this.isLightConstant=l,this.isLineProgressConstant=c,this.isStateDependent=e!=="constant"&&!Zu(n.expression),this.configDependencies=ac(n.expression)}evaluateWithoutErrorHandling(e,n,l,c,m,_){return this._styleExpression.evaluateWithoutErrorHandling(e,n,l,c,m,_)}evaluate(e,n,l,c,m,_){return this._styleExpression.evaluate(e,n,l,c,m,_)}}class bu{constructor(e,n,l,c,m,_){this.kind=e,this.zoomStops=l,this._styleExpression=n,this.isStateDependent=e!=="camera"&&!Zu(n.expression),this.isLightConstant=m,this.isLineProgressConstant=_,this.configDependencies=ac(n.expression),this.interpolationType=c}evaluateWithoutErrorHandling(e,n,l,c,m,_){return this._styleExpression.evaluateWithoutErrorHandling(e,n,l,c,m,_)}evaluate(e,n,l,c,m,_){return this._styleExpression.evaluate(e,n,l,c,m,_)}interpolationFactor(e,n,l){return this.interpolationType?es.interpolationFactor(this.interpolationType,e,n,l):0}}function id(o,e,n,l){if((o=mh(o,e,n,l)).result==="error")return o;let c=o.value.expression,m=hh(c);if(!m&&!Hd(e))return ar([new La("","data expressions not supported")]);let _=qu(c,["zoom","pitch","distance-from-center"]);if(!_&&!pf(e))return ar([new La("","zoom expressions not supported")]);let b=qu(c,["measure-light"]);if(!b&&!Xd(e))return ar([new La("","measure-light expression not supported")]);let I=qu(c,["line-progress"]);if(!I&&!function(F){return Wd(F.expression,"line-progress")}(e))return ar([new La("","line-progress expression not supported")]);let E=e.expression&&e.expression.relaxZoomRestriction,L=yl(c);return L||_||E?L instanceof La?ar([L]):L instanceof es&&!$p(e)?ar([new La("",'"interpolate" expressions cannot be used with this property')]):qp(L?new bu(m&&I?"camera":"composite",o.value,L.labels,L instanceof es?L.interpolation:void 0,b,I):new _h(m&&I?"constant":"source",o.value,b,I)):ar([new La("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class Jd{constructor(e,n){this._parameters=e,this._specification=n,Dl(this,ed(this._parameters,this._specification))}static deserialize(e){return new Jd(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function yl(o){let e=null;if(o instanceof Gd)e=yl(o.result);else if(o instanceof jd){for(let n of o.args)if(e=yl(n),e)break}else(o instanceof uh||o instanceof es)&&o.input instanceof Ys&&o.input.name==="zoom"&&(e=o);return e instanceof La||o.eachChild(n=>{let l=yl(n);l instanceof La?e=l:e&&l&&e!==l&&(e=new La("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var nd,pn,jn=function(){if(pn)return nd;pn=1,nd=e;var o=3;function e(n,l,c){var m=this.cells=[];if(n instanceof ArrayBuffer){this.arrayBuffer=n;var _=new Int32Array(this.arrayBuffer);n=_[0],this.d=(l=_[1])+2*(c=_[2]);for(var b=0;b<this.d*this.d;b++){var I=_[o+b],E=_[o+b+1];m.push(I===E?null:_.subarray(I,E))}var L=_[o+m.length+1];this.keys=_.subarray(_[o+m.length],L),this.bboxes=_.subarray(L),this.insert=this._insertReadonly}else{this.d=l+2*c;for(var F=0;F<this.d*this.d;F++)m.push([]);this.keys=[],this.bboxes=[]}this.n=l,this.extent=n,this.padding=c,this.scale=l/n,this.uid=0;var V=c/l*n;this.min=-V,this.max=n+V}return e.prototype.insert=function(n,l,c,m,_){this._forEachCell(l,c,m,_,this._insertCell,this.uid++),this.keys.push(n),this.bboxes.push(l),this.bboxes.push(c),this.bboxes.push(m),this.bboxes.push(_)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(n,l,c,m,_,b){this.cells[_].push(b)},e.prototype.query=function(n,l,c,m,_){var b=this.min,I=this.max;if(n<=b&&l<=b&&I<=c&&I<=m&&!_)return Array.prototype.slice.call(this.keys);var E=[];return this._forEachCell(n,l,c,m,this._queryCell,E,{},_),E},e.prototype._queryCell=function(n,l,c,m,_,b,I,E){var L=this.cells[_];if(L!==null)for(var F=this.keys,V=this.bboxes,W=0;W<L.length;W++){var H=L[W];if(I[H]===void 0){var ee=4*H;(E?E(V[ee+0],V[ee+1],V[ee+2],V[ee+3]):n<=V[ee+2]&&l<=V[ee+3]&&c>=V[ee+0]&&m>=V[ee+1])?(I[H]=!0,b.push(F[H])):I[H]=!1}}},e.prototype._forEachCell=function(n,l,c,m,_,b,I,E){for(var L=this._convertToCellCoord(n),F=this._convertToCellCoord(l),V=this._convertToCellCoord(c),W=this._convertToCellCoord(m),H=L;H<=V;H++)for(var ee=F;ee<=W;ee++){var le=this.d*ee+H;if((!E||E(this._convertFromCellCoord(H),this._convertFromCellCoord(ee),this._convertFromCellCoord(H+1),this._convertFromCellCoord(ee+1)))&&_.call(this,n,l,c,m,le,b,I,E))return}},e.prototype._convertFromCellCoord=function(n){return(n-this.padding)/this.scale},e.prototype._convertToCellCoord=function(n){return Math.max(0,Math.min(this.d-1,Math.floor(n*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var n=this.cells,l=o+this.cells.length+1+1,c=0,m=0;m<this.cells.length;m++)c+=this.cells[m].length;var _=new Int32Array(l+c+this.keys.length+this.bboxes.length);_[0]=this.extent,_[1]=this.n,_[2]=this.padding;for(var b=l,I=0;I<n.length;I++){var E=n[I];_[o+I]=b,_.set(E,b),b+=E.length}return _[o+n.length]=b,_.set(this.keys,b),_[o+n.length+1]=b+=this.keys.length,_.set(this.bboxes,b),b+=this.bboxes.length,_.buffer},nd}(),gh=Xt(jn);let wu={};function Ei(o,e,n={}){Object.defineProperty(o,"_classRegistryKey",{value:e,writable:!1}),wu[e]={klass:o,omit:n.omit||[]}}Ei(Object,"Object"),gh.serialize=function(o,e){let n=o.toArrayBuffer();return e&&e.add(n),{buffer:n}},gh.deserialize=function(o){return new gh(o.buffer)},Object.defineProperty(gh,"name",{value:"Grid"}),Ei(gh,"Grid"),typeof DOMMatrix<"u"&&Ei(DOMMatrix,"DOMMatrix"),Ei(sr,"Color"),Ei(Error,"Error"),Ei(Ks,"Formatted"),Ei(Ou,"FormattedSection"),Ei(Xs,"AJAXError"),Ei(Xa,"ResolvedImage"),Ei(Jd,"StylePropertyFunction"),Ei(jo,"StyleExpression",{omit:["_evaluator"]}),Ei(hs,"ImageId"),Ei(Vs,"ImageVariant"),Ei(bu,"ZoomDependentExpression"),Ei(_h,"ZoomConstantExpression"),Ei(Ys,"CompoundExpression",{omit:["_evaluate"]});for(let o in sn)wu[sn[o]._classRegistryKey]||Ei(sn[o],`Expression${o}`);function Qs(o){return o&&typeof ArrayBuffer<"u"&&(o instanceof ArrayBuffer||o.constructor&&o.constructor.name==="ArrayBuffer")}function Zh(o){return self.ImageBitmap&&o instanceof ImageBitmap}function ds(o,e){if(o==null||typeof o=="boolean"||typeof o=="number"||typeof o=="string"||o instanceof Boolean||o instanceof Number||o instanceof String||o instanceof Date||o instanceof RegExp)return o;if(Qs(o)||Zh(o))return e&&e.add(o),o;if(ArrayBuffer.isView(o))return e&&e.add(o.buffer),o;if(o instanceof ImageData)return e&&e.add(o.data.buffer),o;if(Array.isArray(o)){let n=[];for(let l of o)n.push(ds(l,e));return n}if(o instanceof Map){let n={$name:"Map",entries:[]};for(let[l,c]of o.entries())n.entries.push(ds(l),ds(c,e));return n}if(o instanceof Set){let n={$name:"Set"},l=0;for(let c of o.values())n[++l]=ds(c);return n}if(o instanceof DOMMatrix){let n={$name:"DOMMatrix"},l=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(let c of l)n[c]=o[c];return n}if(typeof o=="bigint")return{$name:"BigInt",value:o.toString()};if(typeof o=="object"){let n=o.constructor,l=n._classRegistryKey;if(!l)throw new Error(`Can't serialize object of unregistered class "${n.name}".`);let c=n.serialize?n.serialize(o,e):{};if(!n.serialize){for(let m in o)o.hasOwnProperty(m)&&(wu[l].omit.indexOf(m)>=0||(c[m]=ds(o[m],e)));o instanceof Error&&(c.message=o.message)}if(c.$name)throw new Error("$name property is reserved for worker serialization logic.");return l!=="Object"&&(c.$name=l),c}throw new Error("can't serialize object of type "+typeof o)}function yh(o){if(o==null||typeof o=="boolean"||typeof o=="number"||typeof o=="string"||o instanceof Boolean||o instanceof Number||o instanceof String||o instanceof Date||o instanceof RegExp||Qs(o)||Zh(o)||ArrayBuffer.isView(o)||o instanceof ImageData)return o;if(Array.isArray(o))return o.map(yh);if(typeof o=="object"){let e=o.$name||"Object";if(e==="Map"){let c=o.entries||[],m=new Map;for(let _=0;_<c.length;_+=2)m.set(yh(c[_]),yh(c[_+1]));return m}if(e==="Set"){let c=new Set;for(let m of Object.keys(o))m!=="$name"&&c.add(yh(o[m]));return c}if(e==="DOMMatrix"){let c;return c=o.is2D?[o.a,o.b,o.c,o.d,o.e,o.f]:[o.m11,o.m12,o.m13,o.m14,o.m21,o.m22,o.m23,o.m24,o.m31,o.m32,o.m33,o.m34,o.m41,o.m42,o.m43,o.m44],new DOMMatrix(c)}if(e==="BigInt")return BigInt(o.value);let{klass:n}=wu[e];if(!n)throw new Error(`Can't deserialize unregistered class "${e}".`);if(n.deserialize)return n.deserialize(o);let l=Object.create(n.prototype);for(let c of Object.keys(o))c!=="$name"&&(l[c]=yh(o[c]));return l}throw new Error("can't deserialize object of type "+typeof o)}let tn={"Latin-1 Supplement":o=>o>=128&&o<=255,Arabic:o=>o>=1536&&o<=1791,"Arabic Supplement":o=>o>=1872&&o<=1919,"Arabic Extended-A":o=>o>=2208&&o<=2303,"Hangul Jamo":o=>o>=4352&&o<=4607,"Unified Canadian Aboriginal Syllabics":o=>o>=5120&&o<=5759,Khmer:o=>o>=6016&&o<=6143,"Unified Canadian Aboriginal Syllabics Extended":o=>o>=6320&&o<=6399,"General Punctuation":o=>o>=8192&&o<=8303,"Letterlike Symbols":o=>o>=8448&&o<=8527,"Number Forms":o=>o>=8528&&o<=8591,"Miscellaneous Technical":o=>o>=8960&&o<=9215,"Control Pictures":o=>o>=9216&&o<=9279,"Optical Character Recognition":o=>o>=9280&&o<=9311,"Enclosed Alphanumerics":o=>o>=9312&&o<=9471,"Geometric Shapes":o=>o>=9632&&o<=9727,"Miscellaneous Symbols":o=>o>=9728&&o<=9983,"Miscellaneous Symbols and Arrows":o=>o>=11008&&o<=11263,"CJK Radicals Supplement":o=>o>=11904&&o<=12031,"Kangxi Radicals":o=>o>=12032&&o<=12255,"Ideographic Description Characters":o=>o>=12272&&o<=12287,"CJK Symbols and Punctuation":o=>o>=12288&&o<=12351,Hiragana:o=>o>=12352&&o<=12447,Katakana:o=>o>=12448&&o<=12543,Bopomofo:o=>o>=12544&&o<=12591,"Hangul Compatibility Jamo":o=>o>=12592&&o<=12687,Kanbun:o=>o>=12688&&o<=12703,"Bopomofo Extended":o=>o>=12704&&o<=12735,"CJK Strokes":o=>o>=12736&&o<=12783,"Katakana Phonetic Extensions":o=>o>=12784&&o<=12799,"Enclosed CJK Letters and Months":o=>o>=12800&&o<=13055,"CJK Compatibility":o=>o>=13056&&o<=13311,"CJK Unified Ideographs Extension A":o=>o>=13312&&o<=19903,"Yijing Hexagram Symbols":o=>o>=19904&&o<=19967,"CJK Unified Ideographs":o=>o>=19968&&o<=40959,"Yi Syllables":o=>o>=40960&&o<=42127,"Yi Radicals":o=>o>=42128&&o<=42191,"Hangul Jamo Extended-A":o=>o>=43360&&o<=43391,"Hangul Syllables":o=>o>=44032&&o<=55215,"Hangul Jamo Extended-B":o=>o>=55216&&o<=55295,"Private Use Area":o=>o>=57344&&o<=63743,"CJK Compatibility Ideographs":o=>o>=63744&&o<=64255,"Arabic Presentation Forms-A":o=>o>=64336&&o<=65023,"Vertical Forms":o=>o>=65040&&o<=65055,"CJK Compatibility Forms":o=>o>=65072&&o<=65103,"Small Form Variants":o=>o>=65104&&o<=65135,"Arabic Presentation Forms-B":o=>o>=65136&&o<=65279,"Halfwidth and Fullwidth Forms":o=>o>=65280&&o<=65519,Osage:o=>o>=66736&&o<=66815,"CJK Unified Ideographs Extension B":o=>o>=131072&&o<=173791};function Wo(o){for(let e of o)if(Ul(e.charCodeAt(0)))return!0;return!1}function ys(o){for(let e of o)if(!ff(e.charCodeAt(0)))return!1;return!0}function ff(o){return!(tn.Arabic(o)||tn["Arabic Supplement"](o)||tn["Arabic Extended-A"](o)||tn["Arabic Presentation Forms-A"](o)||tn["Arabic Presentation Forms-B"](o))}function Ul(o){return!(o!==746&&o!==747&&(o<4352||!(tn["Bopomofo Extended"](o)||tn.Bopomofo(o)||tn["CJK Compatibility Forms"](o)&&!(o>=65097&&o<=65103)||tn["CJK Compatibility Ideographs"](o)||tn["CJK Compatibility"](o)||tn["CJK Radicals Supplement"](o)||tn["CJK Strokes"](o)||!(!tn["CJK Symbols and Punctuation"](o)||o>=12296&&o<=12305||o>=12308&&o<=12319||o===12336)||tn["CJK Unified Ideographs Extension A"](o)||tn["CJK Unified Ideographs"](o)||tn["Enclosed CJK Letters and Months"](o)||tn["Hangul Compatibility Jamo"](o)||tn["Hangul Jamo Extended-A"](o)||tn["Hangul Jamo Extended-B"](o)||tn["Hangul Jamo"](o)||tn["Hangul Syllables"](o)||tn.Hiragana(o)||tn["Ideographic Description Characters"](o)||tn.Kanbun(o)||tn["Kangxi Radicals"](o)||tn["Katakana Phonetic Extensions"](o)||tn.Katakana(o)&&o!==12540||!(!tn["Halfwidth and Fullwidth Forms"](o)||o===65288||o===65289||o===65293||o>=65306&&o<=65310||o===65339||o===65341||o===65343||o>=65371&&o<=65503||o===65507||o>=65512&&o<=65519)||!(!tn["Small Form Variants"](o)||o>=65112&&o<=65118||o>=65123&&o<=65126)||tn["Unified Canadian Aboriginal Syllabics"](o)||tn["Unified Canadian Aboriginal Syllabics Extended"](o)||tn["Vertical Forms"](o)||tn["Yijing Hexagram Symbols"](o)||tn["Yi Syllables"](o)||tn["Yi Radicals"](o))))}function xh(o){return!(Ul(o)||function(e){return!!(tn["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||tn["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||tn["Letterlike Symbols"](e)||tn["Number Forms"](e)||tn["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||tn["Control Pictures"](e)&&e!==9251||tn["Optical Character Recognition"](e)||tn["Enclosed Alphanumerics"](e)||tn["Geometric Shapes"](e)||tn["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||tn["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||tn["CJK Symbols and Punctuation"](e)||tn.Katakana(e)||tn["Private Use Area"](e)||tn["CJK Compatibility Forms"](e)||tn["Small Form Variants"](e)||tn["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(o))}function mf(o){return tn.Arabic(o)||tn["Arabic Supplement"](o)||tn["Arabic Extended-A"](o)||tn["Arabic Presentation Forms-A"](o)||tn["Arabic Presentation Forms-B"](o)}function Qd(o){return o>=1424&&o<=2303||tn["Arabic Presentation Forms-A"](o)||tn["Arabic Presentation Forms-B"](o)}function Tu(o,e){return!(!e&&Qd(o)||o>=2304&&o<=3583||o>=3840&&o<=4255||tn.Khmer(o))}function ep(o){for(let e of o)if(Qd(e.charCodeAt(0)))return!0;return!1}let tp="deferred",rd="loading",ip="loaded",M=null,r="unavailable",h=null,x=function(o){o&&typeof o=="string"&&o.indexOf("NetworkError")>-1&&(r="error"),M&&M(o)};function w(){A.fire(new Sa("pluginStateChange",{pluginStatus:r,pluginURL:h}))}let A=new nc,k=function(){return r},j=function(){if(r!==tp||!h)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");r=rd,w(),h&&gs({url:h},o=>{o?x(o):(r=ip,w())})},q={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>r===ip||q.applyArabicShaping!=null,isLoading:()=>r===rd,setState(o){r=o.pluginStatus,h=o.pluginURL},isParsed:()=>q.applyArabicShaping!=null&&q.processBidirectionalText!=null&&q.processStyledBidirectionalText!=null,getPluginURL:()=>h};class J{constructor(e,n){this.zoom=e,n?(this.now=n.now,this.fadeDuration=n.fadeDuration,this.transition=n.transition,this.pitch=n.pitch,this.brightness=n.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(n,l){for(let c of n)if(!Tu(c.charCodeAt(0),l))return!1;return!0}(e,q.isLoaded())}}class ne{constructor(e,n,l,c){this.property=e,this.value=n,this.expression=function(m,_,b,I){if(Qu(m))return new Jd(m,_);if(Gh(m)||Array.isArray(m)&&m.length>0){let E=id(m,_,b,I);if(E.result==="error")throw new Error(E.value.map(L=>`${L.key}: ${L.message}`).join(", "));return E.value}{let E=m;return typeof m=="string"&&_.type==="color"&&(E=sr.parse(m)),{kind:"constant",configDependencies:new Set,evaluate:()=>E}}}(n===void 0?e.specification.default:n,e.specification,l,c)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,n,l){return this.property.possiblyEvaluate(this,e,n,l)}}class pe{constructor(e,n,l){this.property=e,this.value=new ne(e,void 0,n,l)}transitioned(e,n){return new ge(this.property,this.value,n,wt({},e.transition,this.transition),e.now)}untransitioned(){return new ge(this.property,this.value,null,{},0)}}class ue{constructor(e,n,l){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=n,this._options=l,this.configDependencies=new Set}getValue(e){return An(this._values[e].value.value)}setValue(e,n){this._values.hasOwnProperty(e)||(this._values[e]=new pe(this._values[e].property,this._scope,this._options)),this._values[e].value=new ne(this._values[e].property,n===null?void 0:An(n),this._scope,this._options),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]))}setTransitionOrValue(e,n){n&&(this._options=n);let l=this._properties.properties;if(e)for(let c in e){let m=e[c];if(c.endsWith("-transition")){let _=c.slice(0,-11);l[_]&&this.setTransition(_,m)}else l.hasOwnProperty(c)&&this.setValue(c,m)}}getTransition(e){return An(this._values[e].transition)}setTransition(e,n){this._values.hasOwnProperty(e)||(this._values[e]=new pe(this._values[e].property)),this._values[e].transition=An(n)||void 0}serialize(){let e={};for(let n of Object.keys(this._values)){let l=this.getValue(n);l!==void 0&&(e[n]=l);let c=this.getTransition(n);c!==void 0&&(e[`${n}-transition`]=c)}return e}transitioned(e,n){let l=new Ee(this._properties);for(let c of Object.keys(this._values))l._values[c]=this._values[c].transitioned(e,n._values[c]);return l}untransitioned(){let e=new Ee(this._properties);for(let n of Object.keys(this._values))e._values[n]=this._values[n].untransitioned();return e}}class ge{constructor(e,n,l,c,m){let _=c.delay||0,b=c.duration||0;m=m||0,this.property=e,this.value=n,this.begin=m+_,this.end=this.begin+b,e.specification.transition&&(c.delay||c.duration)&&(this.prior=l)}possiblyEvaluate(e,n,l){let c=e.now||0,m=this.value.possiblyEvaluate(e,n,l),_=this.prior;if(_){if(c>this.end)return this.prior=null,m;if(this.value.isDataDriven())return this.prior=null,m;if(c<this.begin)return _.possiblyEvaluate(e,n,l);{let b=(c-this.begin)/(this.end-this.begin);return this.property.interpolate(_.possiblyEvaluate(e,n,l),m,qe(b))}}return m}}class Ee{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,n,l){let c=new et(this._properties);for(let m of Object.keys(this._values))c._values[m]=this._values[m].possiblyEvaluate(e,n,l);return c}hasTransition(){for(let e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class tt{constructor(e,n,l){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=n,this._options=l,this.configDependencies=new Set}getValue(e){return An(this._values[e].value)}setValue(e,n){this._values[e]=new ne(this._values[e].property,n===null?void 0:An(n),this._scope,this._options),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]))}serialize(){let e={};for(let n of Object.keys(this._values)){let l=this.getValue(n);l!==void 0&&(e[n]=l)}return e}possiblyEvaluate(e,n,l){let c=new et(this._properties);for(let m of Object.keys(this._values))c._values[m]=this._values[m].possiblyEvaluate(e,n,l);return c}}class Xe{constructor(e,n,l){this.property=e,this.value=n,this.parameters=l}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,n,l,c){return this.property.evaluate(this.value,this.parameters,e,n,l,c)}}class et{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class Se{constructor(e){this.specification=e}possiblyEvaluate(e,n){return e.expression.evaluate(n)}interpolate(e,n,l){let c=Dp[this.specification.type];return c?c(e,n,l):e}}class Be{constructor(e,n){this.specification=e,this.overrides=n}possiblyEvaluate(e,n,l,c){return new Xe(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(n,null,{},l,c)}:e.expression,n)}interpolate(e,n,l){if(e.value.kind!=="constant"||n.value.kind!=="constant")return e;if(e.value.value===void 0||n.value.value===void 0)return new Xe(this,{kind:"constant",value:void 0},e.parameters);let c=Dp[this.specification.type];return c?new Xe(this,{kind:"constant",value:c(e.value.value,n.value.value,l)},e.parameters):e}evaluate(e,n,l,c,m,_){return e.kind==="constant"?e.value:e.evaluate(n,l,c,m,_)}}class ft{constructor(e){this.specification=e}possiblyEvaluate(e,n,l,c){return!!e.expression.evaluate(n,null,{},l,c)}interpolate(){return!1}}class dt{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];let n=new J(0,{});for(let l in e){let c=e[l];c.specification.overridable&&this.overridableProperties.push(l);let m=this.defaultPropertyValues[l]=new ne(c,void 0),_=this.defaultTransitionablePropertyValues[l]=new pe(c);this.defaultTransitioningPropertyValues[l]=_.untransitioned(),this.defaultPossiblyEvaluatedValues[l]=m.possiblyEvaluate(n)}}}Ei(Be,"DataDrivenProperty"),Ei(Se,"DataConstantProperty"),Ei(ft,"ColorRampProperty");var xe=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","expression":{}},"buildingFeaturesetId":{"type":"string","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"transition":true},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"transition":true},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-wall-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"transition":true},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white"},"sky-atmosphere-color":{"type":"color","default":"white"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function pt(o){return o instanceof Number||o instanceof String||o instanceof Boolean?o.valueOf():o}function zt(o){if(Array.isArray(o))return o.map(zt);if(o instanceof Object&&!(o instanceof Number||o instanceof String||o instanceof Boolean)){let e={};for(let n in o)e[n]=zt(o[n]);return e}return pt(o)}function ei(o){if(o===!0||o===!1)return!0;if(!Array.isArray(o)||o.length===0)return!1;switch(o[0]){case"has":return o.length>=2&&o[1]!=="$id"&&o[1]!=="$type";case"in":return o.length>=3&&(typeof o[1]!="string"||Array.isArray(o[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return o.length!==3||Array.isArray(o[1])||Array.isArray(o[2]);case"any":case"all":for(let e of o.slice(1))if(!ei(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function Kt(o,e="",n=null,l="fill"){if(o==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};ei(o)||(o=xr(o));let c=o,m=!0;try{m=function(L){if(!Xi(L))return L;let F=zt(L);return si(F),F=Jt(F),F}(c)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(c,null,2)}
        `)}let _=null,b=null;if(l!=="background"&&l!=="sky"&&l!=="slot"){b=xe[`filter_${l}`];let L=mh(m,b,e,n);if(L.result==="error")throw new Error(L.value.map(F=>`${F.key}: ${F.message}`).join(", "));_=(F,V,W)=>L.value.evaluate(F,V,{},W)}let I=null,E=null;if(m!==c){let L=mh(c,b,e,n);if(L.result==="error")throw new Error(L.value.map(F=>`${F.key}: ${F.message}`).join(", "));I=(F,V,W,H,ee)=>L.value.evaluate(F,V,{},W,void 0,void 0,H,ee),E=!hh(L.value.expression)}return{filter:_,dynamicFilter:I||void 0,needGeometry:yn(m),needFeature:!!E}}function Jt(o){if(!Array.isArray(o))return o;let e=function(n){if(Ki.has(n[0])){for(let l=1;l<n.length;l++)if(Xi(n[l]))return!0}return n}(o);return e===!0?e:e.map(n=>Jt(n))}function si(o){let e=!1,n=[];if(o[0]==="case"){for(let l=1;l<o.length-1;l+=2)e=e||Xi(o[l]),n.push(o[l+1]);n.push(o[o.length-1])}else if(o[0]==="match"){e=e||Xi(o[1]);for(let l=2;l<o.length-1;l+=2)n.push(o[l+1]);n.push(o[o.length-1])}else if(o[0]==="step"){e=e||Xi(o[1]);for(let l=1;l<o.length-1;l+=2)n.push(o[l+1])}e&&(o.length=0,o.push("any",...n));for(let l=1;l<o.length;l++)si(o[l])}function Xi(o){if(!Array.isArray(o))return!1;if((e=o[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let n=1;n<o.length;n++)if(Xi(o[n]))return!0;return!1}let Ki=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Pi(o,e){return o<e?-1:o>e?1:0}function yn(o){if(!Array.isArray(o))return!1;if(o[0]==="within"||o[0]==="distance")return!0;for(let e=1;e<o.length;e++)if(yn(o[e]))return!0;return!1}function xr(o){if(!o)return!0;let e=o[0];return o.length<=1?e!=="any":e==="=="?Kr(o[1],o[2],"=="):e==="!="?Go(Kr(o[1],o[2],"==")):e==="<"||e===">"||e==="<="||e===">="?Kr(o[1],o[2],e):e==="any"?(n=o.slice(1),["any"].concat(n.map(xr))):e==="all"?["all"].concat(o.slice(1).map(xr)):e==="none"?["all"].concat(o.slice(1).map(xr).map(Go)):e==="in"?Ho(o[1],o.slice(2)):e==="!in"?Go(Ho(o[1],o.slice(2))):e==="has"?Eo(o[1]):e!=="!has"||Go(Eo(o[1]));var n}function Kr(o,e,n){switch(o){case"$type":return[`filter-type-${n}`,e];case"$id":return[`filter-id-${n}`,e];default:return[`filter-${n}`,o,e]}}function Ho(o,e){if(e.length===0)return!1;switch(o){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(n=>typeof n!=typeof e[0])?["filter-in-large",o,["literal",e.sort(Pi)]]:["filter-in-small",o,["literal",e]]}}function Eo(o){switch(o){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",o]}}function Go(o){return["!",o]}let vo="";function Yr(o,e){return e?`${o}${vo}${e}`:o}let Mo="-transition",ps=new Set(["fill","line","background","hillshade","raster"]);class lr extends nc{constructor(e,n,l,c,m){if(super(),this.id=e.id,this.fqid=Yr(this.id,l),this.type=e.type,this.scope=l,this.lut=c,this.options=m,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;let _=mh(this.filter,xe[`filter_${e.type}`]);_.result!=="error"&&(this.configDependencies=new Set([...this.configDependencies,..._.value.configDependencies]))}if(e.slot&&(this.slot=e.slot),n.layout&&(this._unevaluatedLayout=new tt(n.layout,this.scope,m),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),n.paint){this._transitionablePaint=new ue(n.paint,this.scope,m);for(let _ in e.paint)this.setPaintProperty(_,e.paint[_]);for(let _ in e.layout)this.setLayoutProperty(_,e.layout[_]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new et(n.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&ps.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,n){if(this.type==="custom"&&e==="visibility")return void(this.visibility=n);let l=this._unevaluatedLayout;l._properties.properties[e]&&(l.setValue(e,n),this.configDependencies=new Set([...this.configDependencies,...l.configDependencies]),e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(Mo)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,n){let l=this._transitionablePaint,c=l._properties.properties;if(e.endsWith(Mo)){let F=e.slice(0,-11);return c[F]&&l.setTransition(F,n||void 0),!1}if(!c[e])return!1;let m=l._values[e],_=m.value.isDataDriven(),b=m.value;l.setValue(e,n),this.configDependencies=new Set([...this.configDependencies,...l.configDependencies]),this._handleSpecialPaintPropertyUpdate(e);let I=l._values[e].value,E=I.isDataDriven(),L=e.endsWith("pattern")||e==="line-dasharray";return E||_||L||this._handleOverridablePaintPropertyUpdate(e,b,I)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,n,l){return null}_handleOverridablePaintPropertyUpdate(e,n,l){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,n){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,n)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,n)}serialize(){return dn({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,n)=>!(e===void 0||n==="layout"&&!Object.keys(e).length||n==="paint"&&!Object.keys(e).length))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(let e in this.paint._values){let n=this.paint.get(e);if(n instanceof Xe&&Hd(n.property.specification)&&(n.value.kind==="source"||n.value.kind==="composite")&&n.value.isStateDependent)return!0}return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=Kt(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,n,l,c,m,_,b,I,E){}}let aa={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Rs{constructor(e,n){this._structArray=e,this._pos1=n*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Rr{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,n){return e._trim(),n&&(e.isTransferred=!0,n.add(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){let n=Object.create(this.prototype);return n.arrayBuffer=e.arrayBuffer,n.length=e.length,n.capacity=e.arrayBuffer.byteLength/n.bytesPerElement,n._refreshViews(),n}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);let n=this.uint8;this._refreshViews(),n&&this.uint8.set(n)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Kn(o,e=1){let n=0,l=0;return{members:o.map(c=>{let m=aa[c.type].BYTES_PER_ELEMENT,_=n=Ac(n,Math.max(e,m)),b=c.components||1;return l=Math.max(l,m),n+=m*b,{name:c.name,type:c.type,components:b,offset:_}}),size:Ac(n,Math.max(l,e)),alignment:e}}function Ac(o,e){return Math.ceil(o/e)*e}class la extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n){let l=this.length;return this.resize(l+1),this.emplace(l,e,n)}emplace(e,n,l){let c=2*e;return this.int16[c+0]=n,this.int16[c+1]=l,e}}la.prototype.bytesPerElement=4,Ei(la,"StructArrayLayout2i4");class qh extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,l){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,l)}emplace(e,n,l,c){let m=3*e;return this.int16[m+0]=n,this.int16[m+1]=l,this.int16[m+2]=c,e}}qh.prototype.bytesPerElement=6,Ei(qh,"StructArrayLayout3i6");class uc extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,l,c){let m=this.length;return this.resize(m+1),this.emplace(m,e,n,l,c)}emplace(e,n,l,c,m){let _=4*e;return this.int16[_+0]=n,this.int16[_+1]=l,this.int16[_+2]=c,this.int16[_+3]=m,e}}uc.prototype.bytesPerElement=8,Ei(uc,"StructArrayLayout4i8");class dc extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.float32[1*e+0]=n,e}}dc.prototype.bytesPerElement=4,Ei(dc,"StructArrayLayout1f4");class Ca extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,l){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,l)}emplace(e,n,l,c){let m=4*e,_=2*e;return this.int16[m+0]=n,this.int16[m+1]=l,this.float32[_+1]=c,e}}Ca.prototype.bytesPerElement=8,Ei(Ca,"StructArrayLayout2i1f8");class Fa extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,l){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,l)}emplace(e,n,l,c){let m=4*e;return this.int16[m+0]=n,this.int16[m+1]=l,this.int16[m+2]=c,e}}Fa.prototype.bytesPerElement=8,Ei(Fa,"StructArrayLayout3i8");class Dc extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m){let _=this.length;return this.resize(_+1),this.emplace(_,e,n,l,c,m)}emplace(e,n,l,c,m,_){let b=5*e;return this.int16[b+0]=n,this.int16[b+1]=l,this.int16[b+2]=c,this.int16[b+3]=m,this.int16[b+4]=_,e}}Dc.prototype.bytesPerElement=10,Ei(Dc,"StructArrayLayout5i10");class vh extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m,_,b){let I=this.length;return this.resize(I+1),this.emplace(I,e,n,l,c,m,_,b)}emplace(e,n,l,c,m,_,b,I){let E=6*e,L=12*e,F=3*e;return this.int16[E+0]=n,this.int16[E+1]=l,this.uint8[L+4]=c,this.uint8[L+5]=m,this.uint8[L+6]=_,this.uint8[L+7]=b,this.float32[F+2]=I,e}}vh.prototype.bytesPerElement=12,Ei(vh,"StructArrayLayout2i4ub1f12");class So extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,l){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,l)}emplace(e,n,l,c){let m=3*e;return this.float32[m+0]=n,this.float32[m+1]=l,this.float32[m+2]=c,e}}So.prototype.bytesPerElement=12,Ei(So,"StructArrayLayout3f12");class io extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m){let _=this.length;return this.resize(_+1),this.emplace(_,e,n,l,c,m)}emplace(e,n,l,c,m,_){let b=6*e,I=3*e;return this.uint16[b+0]=n,this.uint16[b+1]=l,this.uint16[b+2]=c,this.uint16[b+3]=m,this.float32[I+2]=_,e}}io.prototype.bytesPerElement=12,Ei(io,"StructArrayLayout4ui1f12");class ca extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,l,c){let m=this.length;return this.resize(m+1),this.emplace(m,e,n,l,c)}emplace(e,n,l,c,m){let _=4*e;return this.uint16[_+0]=n,this.uint16[_+1]=l,this.uint16[_+2]=c,this.uint16[_+3]=m,e}}ca.prototype.bytesPerElement=8,Ei(ca,"StructArrayLayout4ui8");class ts extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m,_){let b=this.length;return this.resize(b+1),this.emplace(b,e,n,l,c,m,_)}emplace(e,n,l,c,m,_,b){let I=6*e;return this.int16[I+0]=n,this.int16[I+1]=l,this.int16[I+2]=c,this.int16[I+3]=m,this.int16[I+4]=_,this.int16[I+5]=b,e}}ts.prototype.bytesPerElement=12,Ei(ts,"StructArrayLayout6i12");class Su extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m,_,b,I,E,L,F,V){let W=this.length;return this.resize(W+1),this.emplace(W,e,n,l,c,m,_,b,I,E,L,F,V)}emplace(e,n,l,c,m,_,b,I,E,L,F,V,W){let H=12*e;return this.int16[H+0]=n,this.int16[H+1]=l,this.int16[H+2]=c,this.int16[H+3]=m,this.uint16[H+4]=_,this.uint16[H+5]=b,this.uint16[H+6]=I,this.uint16[H+7]=E,this.int16[H+8]=L,this.int16[H+9]=F,this.int16[H+10]=V,this.int16[H+11]=W,e}}Su.prototype.bytesPerElement=24,Ei(Su,"StructArrayLayout4i4ui4i24");class el extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m,_){let b=this.length;return this.resize(b+1),this.emplace(b,e,n,l,c,m,_)}emplace(e,n,l,c,m,_,b){let I=10*e,E=5*e;return this.int16[I+0]=n,this.int16[I+1]=l,this.int16[I+2]=c,this.float32[E+2]=m,this.float32[E+3]=_,this.float32[E+4]=b,e}}el.prototype.bytesPerElement=20,Ei(el,"StructArrayLayout3i3f20");class jl extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,l,c){let m=this.length;return this.resize(m+1),this.emplace(m,e,n,l,c)}emplace(e,n,l,c,m){let _=4*e;return this.float32[_+0]=n,this.float32[_+1]=l,this.float32[_+2]=c,this.float32[_+3]=m,e}}jl.prototype.bytesPerElement=16,Ei(jl,"StructArrayLayout4f16");class Iu extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint32[1*e+0]=n,e}}Iu.prototype.bytesPerElement=4,Ei(Iu,"StructArrayLayout1ul4");class xl extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n){let l=this.length;return this.resize(l+1),this.emplace(l,e,n)}emplace(e,n,l){let c=2*e;return this.uint16[c+0]=n,this.uint16[c+1]=l,e}}xl.prototype.bytesPerElement=4,Ei(xl,"StructArrayLayout2ui4");class pc extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m,_,b,I,E,L,F,V,W){let H=this.length;return this.resize(H+1),this.emplace(H,e,n,l,c,m,_,b,I,E,L,F,V,W)}emplace(e,n,l,c,m,_,b,I,E,L,F,V,W,H){let ee=20*e,le=10*e;return this.int16[ee+0]=n,this.int16[ee+1]=l,this.int16[ee+2]=c,this.int16[ee+3]=m,this.int16[ee+4]=_,this.float32[le+3]=b,this.float32[le+4]=I,this.float32[le+5]=E,this.float32[le+6]=L,this.int16[ee+14]=F,this.uint32[le+8]=V,this.uint16[ee+18]=W,this.uint16[ee+19]=H,e}}pc.prototype.bytesPerElement=40,Ei(pc,"StructArrayLayout5i4f1i1ul2ui40");class Us extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m,_,b){let I=this.length;return this.resize(I+1),this.emplace(I,e,n,l,c,m,_,b)}emplace(e,n,l,c,m,_,b,I){let E=8*e;return this.int16[E+0]=n,this.int16[E+1]=l,this.int16[E+2]=c,this.int16[E+4]=m,this.int16[E+5]=_,this.int16[E+6]=b,this.int16[E+7]=I,e}}Us.prototype.bytesPerElement=16,Ei(Us,"StructArrayLayout3i2i2i16");class vl extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m){let _=this.length;return this.resize(_+1),this.emplace(_,e,n,l,c,m)}emplace(e,n,l,c,m,_){let b=4*e,I=8*e;return this.float32[b+0]=n,this.float32[b+1]=l,this.float32[b+2]=c,this.int16[I+6]=m,this.int16[I+7]=_,e}}vl.prototype.bytesPerElement=16,Ei(vl,"StructArrayLayout2f1f2i16");class np extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m,_){let b=this.length;return this.resize(b+1),this.emplace(b,e,n,l,c,m,_)}emplace(e,n,l,c,m,_,b){let I=20*e,E=5*e;return this.uint8[I+0]=n,this.uint8[I+1]=l,this.float32[E+1]=c,this.float32[E+2]=m,this.float32[E+3]=_,this.float32[E+4]=b,e}}np.prototype.bytesPerElement=20,Ei(np,"StructArrayLayout2ub4f20");class zo extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,l){let c=this.length;return this.resize(c+1),this.emplace(c,e,n,l)}emplace(e,n,l,c){let m=3*e;return this.uint16[m+0]=n,this.uint16[m+1]=l,this.uint16[m+2]=c,e}}zo.prototype.bytesPerElement=6,Ei(zo,"StructArrayLayout3ui6");class rp extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m,_,b,I,E,L,F,V,W,H,ee,le,de,Ce,we,ie,me){let Ie=this.length;return this.resize(Ie+1),this.emplace(Ie,e,n,l,c,m,_,b,I,E,L,F,V,W,H,ee,le,de,Ce,we,ie,me)}emplace(e,n,l,c,m,_,b,I,E,L,F,V,W,H,ee,le,de,Ce,we,ie,me,Ie){let ze=30*e,Je=15*e,st=60*e;return this.int16[ze+0]=n,this.int16[ze+1]=l,this.int16[ze+2]=c,this.float32[Je+2]=m,this.float32[Je+3]=_,this.uint16[ze+8]=b,this.uint16[ze+9]=I,this.uint32[Je+5]=E,this.uint32[Je+6]=L,this.uint32[Je+7]=F,this.uint16[ze+16]=V,this.uint16[ze+17]=W,this.uint16[ze+18]=H,this.float32[Je+10]=ee,this.float32[Je+11]=le,this.uint8[st+48]=de,this.uint8[st+49]=Ce,this.uint8[st+50]=we,this.uint32[Je+13]=ie,this.int16[ze+28]=me,this.uint8[st+58]=Ie,e}}rp.prototype.bytesPerElement=60,Ei(rp,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class op extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m,_,b,I,E,L,F,V,W,H,ee,le,de,Ce,we,ie,me,Ie,ze,Je,st,ut,xt,Ft,ri,$t,Qt,hi,Rt){let Yt=this.length;return this.resize(Yt+1),this.emplace(Yt,e,n,l,c,m,_,b,I,E,L,F,V,W,H,ee,le,de,Ce,we,ie,me,Ie,ze,Je,st,ut,xt,Ft,ri,$t,Qt,hi,Rt)}emplace(e,n,l,c,m,_,b,I,E,L,F,V,W,H,ee,le,de,Ce,we,ie,me,Ie,ze,Je,st,ut,xt,Ft,ri,$t,Qt,hi,Rt,Yt){let Et=20*e,kt=40*e,pi=80*e;return this.float32[Et+0]=n,this.float32[Et+1]=l,this.int16[kt+4]=c,this.int16[kt+5]=m,this.int16[kt+6]=_,this.int16[kt+7]=b,this.int16[kt+8]=I,this.int16[kt+9]=E,this.int16[kt+10]=L,this.int16[kt+11]=F,this.int16[kt+12]=V,this.uint16[kt+13]=W,this.uint16[kt+14]=H,this.uint16[kt+15]=ee,this.uint16[kt+16]=le,this.uint16[kt+17]=de,this.uint16[kt+18]=Ce,this.uint16[kt+19]=we,this.uint16[kt+20]=ie,this.uint16[kt+21]=me,this.uint16[kt+22]=Ie,this.uint16[kt+23]=ze,this.uint16[kt+24]=Je,this.uint16[kt+25]=st,this.uint16[kt+26]=ut,this.uint16[kt+27]=xt,this.uint32[Et+14]=Ft,this.float32[Et+15]=ri,this.float32[Et+16]=$t,this.float32[Et+17]=Qt,this.float32[Et+18]=hi,this.uint8[pi+76]=Rt,this.uint16[kt+39]=Yt,e}}op.prototype.bytesPerElement=80,Ei(op,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class Gl extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m){let _=this.length;return this.resize(_+1),this.emplace(_,e,n,l,c,m)}emplace(e,n,l,c,m,_){let b=5*e;return this.float32[b+0]=n,this.float32[b+1]=l,this.float32[b+2]=c,this.float32[b+3]=m,this.float32[b+4]=_,e}}Gl.prototype.bytesPerElement=20,Ei(Gl,"StructArrayLayout5f20");class Wp extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m,_,b){let I=this.length;return this.resize(I+1),this.emplace(I,e,n,l,c,m,_,b)}emplace(e,n,l,c,m,_,b,I){let E=7*e;return this.float32[E+0]=n,this.float32[E+1]=l,this.float32[E+2]=c,this.float32[E+3]=m,this.float32[E+4]=_,this.float32[E+5]=b,this.float32[E+6]=I,e}}Wp.prototype.bytesPerElement=28,Ei(Wp,"StructArrayLayout7f28");class Cu extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m,_,b,I,E,L,F){let V=this.length;return this.resize(V+1),this.emplace(V,e,n,l,c,m,_,b,I,E,L,F)}emplace(e,n,l,c,m,_,b,I,E,L,F,V){let W=11*e;return this.float32[W+0]=n,this.float32[W+1]=l,this.float32[W+2]=c,this.float32[W+3]=m,this.float32[W+4]=_,this.float32[W+5]=b,this.float32[W+6]=I,this.float32[W+7]=E,this.float32[W+8]=L,this.float32[W+9]=F,this.float32[W+10]=V,e}}Cu.prototype.bytesPerElement=44,Ei(Cu,"StructArrayLayout11f44");class $h extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m,_,b,I,E){let L=this.length;return this.resize(L+1),this.emplace(L,e,n,l,c,m,_,b,I,E)}emplace(e,n,l,c,m,_,b,I,E,L){let F=9*e;return this.float32[F+0]=n,this.float32[F+1]=l,this.float32[F+2]=c,this.float32[F+3]=m,this.float32[F+4]=_,this.float32[F+5]=b,this.float32[F+6]=I,this.float32[F+7]=E,this.float32[F+8]=L,e}}$h.prototype.bytesPerElement=36,Ei($h,"StructArrayLayout9f36");class od extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n){let l=this.length;return this.resize(l+1),this.emplace(l,e,n)}emplace(e,n,l){let c=2*e;return this.float32[c+0]=n,this.float32[c+1]=l,e}}od.prototype.bytesPerElement=8,Ei(od,"StructArrayLayout2f8");class Am extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,l,c){let m=this.length;return this.resize(m+1),this.emplace(m,e,n,l,c)}emplace(e,n,l,c,m){let _=6*e;return this.uint32[3*e+0]=n,this.uint16[_+2]=l,this.uint16[_+3]=c,this.uint16[_+4]=m,e}}Am.prototype.bytesPerElement=12,Ei(Am,"StructArrayLayout1ul3ui12");class sp extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint16[1*e+0]=n,e}}sp.prototype.bytesPerElement=2,Ei(sp,"StructArrayLayout1ui2");class ap extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m,_,b,I,E,L,F,V,W,H,ee,le){let de=this.length;return this.resize(de+1),this.emplace(de,e,n,l,c,m,_,b,I,E,L,F,V,W,H,ee,le)}emplace(e,n,l,c,m,_,b,I,E,L,F,V,W,H,ee,le,de){let Ce=16*e;return this.float32[Ce+0]=n,this.float32[Ce+1]=l,this.float32[Ce+2]=c,this.float32[Ce+3]=m,this.float32[Ce+4]=_,this.float32[Ce+5]=b,this.float32[Ce+6]=I,this.float32[Ce+7]=E,this.float32[Ce+8]=L,this.float32[Ce+9]=F,this.float32[Ce+10]=V,this.float32[Ce+11]=W,this.float32[Ce+12]=H,this.float32[Ce+13]=ee,this.float32[Ce+14]=le,this.float32[Ce+15]=de,e}}ap.prototype.bytesPerElement=64,Ei(ap,"StructArrayLayout16f64");class _f extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,l,c,m,_,b){let I=this.length;return this.resize(I+1),this.emplace(I,e,n,l,c,m,_,b)}emplace(e,n,l,c,m,_,b,I){let E=10*e,L=5*e;return this.uint16[E+0]=n,this.uint16[E+1]=l,this.uint16[E+2]=c,this.uint16[E+3]=m,this.float32[L+2]=_,this.float32[L+3]=b,this.float32[L+4]=I,e}}_f.prototype.bytesPerElement=20,Ei(_f,"StructArrayLayout4ui3f20");class Zf extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.int16[1*e+0]=n,e}}Zf.prototype.bytesPerElement=2,Ei(Zf,"StructArrayLayout1i2");class qf extends Rr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint8[1*e+0]=n,e}}qf.prototype.bytesPerElement=1,Ei(qf,"StructArrayLayout1ub1");class $f extends Rs{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}$f.prototype.size=40;class Wf extends pc{get(e){return new $f(this,e)}}Ei(Wf,"CollisionBoxArray");class Hf extends Rs{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}Hf.prototype.size=60;class Dm extends rp{get(e){return new Hf(this,e)}}Ei(Dm,"PlacedSymbolArray");class Rm extends Rs{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}Rm.prototype.size=80;class lp extends op{get(e){return new Rm(this,e)}}Ei(lp,"SymbolInstanceArray");class zm extends dc{getoffsetX(e){return this.float32[1*e+0]}}Ei(zm,"GlyphOffsetArray");class Hp extends la{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}Ei(Hp,"SymbolLineVertexArray");class gf extends Rs{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}gf.prototype.size=12;class yf extends Am{get(e){return new gf(this,e)}}Ei(yf,"FeatureIndexArray");class Lm extends xl{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}Ei(Lm,"FillExtrusionCentroidArray");class km extends Rs{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}km.prototype.size=6;class c_ extends qh{get(e){return new km(this,e)}}Ei(c_,"FillExtrusionWallArray");let sg=Kn([{name:"a_pos",components:2,type:"Int16"}],4),h_=Kn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class bo{constructor(e=[]){this.segments=e}_prepareSegment(e,n,l,c){let m=this.segments[this.segments.length-1];return e>bo.MAX_VERTEX_ARRAY_LENGTH&&Hi(`Max vertices per segment is ${bo.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!m||m.vertexLength+e>bo.MAX_VERTEX_ARRAY_LENGTH||m.sortKey!==c)&&(m={vertexOffset:n,primitiveOffset:l,vertexLength:0,primitiveLength:0},c!==void 0&&(m.sortKey=c),this.segments.push(m)),m}prepareSegment(e,n,l,c){return this._prepareSegment(e,n.length,l.length,c)}get(){return this.segments}destroy(){for(let e of this.segments)for(let n in e.vaos)e.vaos[n].destroy()}static simpleSegment(e,n,l,c){return new bo([{vertexOffset:e,primitiveOffset:n,vertexLength:l,primitiveLength:c,vaos:{},sortKey:0}])}}function Om(o,e){return 256*(o=rt(Math.floor(o),0,255))+rt(Math.floor(e),0,255)}bo.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Ei(bo,"SegmentVector");let ag=Kn([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),sd=Kn([{name:"a_pattern_b",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),u_=Kn([{name:"a_dash",components:4,type:"Uint16"}]);class ad{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,n,l,c){this.ids.push(Xp(e)),this.positions.push(n,l,c)}eachPosition(e,n){let l=Xp(e),c=0,m=this.ids.length-1;for(;c<m;){let _=c+m>>1;this.ids[_]>=l?m=_:c=_+1}for(;this.ids[c]===l;)n(this.positions[3*c],this.positions[3*c+1],this.positions[3*c+2]),c++}static serialize(e,n){let l=new Float64Array(e.ids),c=new Uint32Array(e.positions);return Ba(l,c,0,l.length-1),n&&(n.add(l.buffer),n.add(c.buffer)),{ids:l,positions:c}}static deserialize(e){let n=new ad,l;n.ids=e.ids,n.positions=e.positions;for(let c of n.ids)c!==l&&n.uniqueIds.push(c),l=c;return n.indexed=!0,n}}function Xp(o){let e=+o;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:za(String(o))}function Ba(o,e,n,l){for(;n<l;){let c=o[n+l>>1],m=n-1,_=l+1;for(;;){do m++;while(o[m]<c);do _--;while(o[_]>c);if(m>=_)break;Kp(o,m,_),Kp(e,3*m,3*_),Kp(e,3*m+1,3*_+1),Kp(e,3*m+2,3*_+2)}_-n<l-_?(Ba(o,e,n,_),n=_+1):(Ba(o,e,_+1,l),l=_)}}function Kp(o,e,n){let l=o[e];o[e]=o[n],o[n]=l}Ei(ad,"FeaturePositionMap");class Rc{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,n){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,n),this.initialized=!0),!!this.location}set(e,n,l){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Xf extends Rc{constructor(e){super(e),this.current=0}set(e,n,l){this.fetchUniformLocation(e,n)&&this.current!==l&&(this.current=l,this.gl.uniform1i(this.location,l))}}class is extends Rc{constructor(e){super(e),this.current=0}set(e,n,l){this.fetchUniformLocation(e,n)&&this.current!==l&&(this.current=l,this.gl.uniform1f(this.location,l))}}class bh extends Rc{constructor(e){super(e),this.current=[0,0]}set(e,n,l){this.fetchUniformLocation(e,n)&&(l[0]===this.current[0]&&l[1]===this.current[1]||(this.current=l,this.gl.uniform2f(this.location,l[0],l[1])))}}class xf extends Rc{constructor(e){super(e),this.current=[0,0,0]}set(e,n,l){this.fetchUniformLocation(e,n)&&(l[0]===this.current[0]&&l[1]===this.current[1]&&l[2]===this.current[2]||(this.current=l,this.gl.uniform3f(this.location,l[0],l[1],l[2])))}}class vf extends Rc{constructor(e){super(e),this.current=[0,0,0,0]}set(e,n,l){this.fetchUniformLocation(e,n)&&(l[0]===this.current[0]&&l[1]===this.current[1]&&l[2]===this.current[2]&&l[3]===this.current[3]||(this.current=l,this.gl.uniform4f(this.location,l[0],l[1],l[2],l[3])))}}class d_ extends Rc{constructor(e){super(e),this.current=sr.transparent.toRenderColor(null)}set(e,n,l){this.fetchUniformLocation(e,n)&&(l.r===this.current.r&&l.g===this.current.g&&l.b===this.current.b&&l.a===this.current.a||(this.current=l,this.gl.uniform4f(this.location,l.r,l.g,l.b,l.a)))}}let Fm=new Float32Array(16);class Yp extends Rc{constructor(e){super(e),this.current=Fm}set(e,n,l){if(this.fetchUniformLocation(e,n)){if(l[12]!==this.current[12]||l[0]!==this.current[0])return this.current=l,void this.gl.uniformMatrix4fv(this.location,!1,l);for(let c=1;c<16;c++)if(l[c]!==this.current[c]){this.current=l,this.gl.uniformMatrix4fv(this.location,!1,l);break}}}}let Bm=new Float32Array(9),Nm=new Float32Array(4);class zc extends Rc{constructor(e){super(e),this.current=Nm}set(e,n,l){if(this.fetchUniformLocation(e,n)){for(let c=0;c<4;c++)if(l[c]!==this.current[c]){this.current=l,this.gl.uniformMatrix2fv(this.location,!1,l);break}}}}function bf(o){return[Om(255*o.r,255*o.g),Om(255*o.b,255*o.a)]}class cp{constructor(e,n,l,c){this.value=e,this.uniformNames=n.map(m=>`u_${m}`),this.type=l,this.context=c}setUniform(e,n,l,c,m){let _=c.constantOr(this.value);n.set(e,m,_ instanceof sr?_.toRenderColor(this.lutExpression&&this.lutExpression.value==="none"?null:this.context.lut):_)}getBinding(e,n){return this.type==="color"?new d_(e):new is(e)}}class ld{constructor(e,n){this.uniformNames=n.map(l=>`u_${l}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,n){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=n?n.tl.concat(n.br):this.pattern}setUniform(e,n,l,c,m){let _=null;m!=="u_pattern"&&m!=="u_dash"||(_=this.pattern),m==="u_pattern_b"&&(_=this.patternTransition),m==="u_pixel_ratio"&&(_=this.pixelRatio),_&&n.set(e,m,_)}getBinding(e,n){return n==="u_pattern"||n==="u_pattern_b"||n==="u_dash"?new vf(e):new is(e)}}class Wh{constructor(e,n,l,c){this.expression=e,this.type=l,this.maxValue=0,this.paintVertexAttributes=n.map(m=>({name:`a_${m}`,type:"Float32",components:l==="color"?2:1,offset:0})),this.paintVertexArray=new c}populatePaintArray(e,n,l,c,m,_,b){let I=this.paintVertexArray.length,E=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new J(0,{brightness:_}),n,{},m,c,b):this.expression.kind==="constant"&&this.expression.value,L=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new J(0,{brightness:_}),n,{},m,c,b):this.lutExpression.value)==="none";this.paintVertexArray.resize(e),this._setPaintValue(I,e,E,L?null:this.context.lut)}updatePaintArray(e,n,l,c,m,_,b){let I=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:b},l,c,void 0,m):this.expression.kind==="constant"&&this.expression.value,E=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new J(0,{brightness:b}),l,c,void 0,m):this.lutExpression.value)==="none";this._setPaintValue(e,n,I,E?null:this.context.lut)}_setPaintValue(e,n,l,c){if(this.type==="color"){let m=bf(l.toRenderColor(c));for(let _=e;_<n;_++)this.paintVertexArray.emplace(_,m[0],m[1])}else{for(let m=e;m<n;m++)this.paintVertexArray.emplace(m,l);this.maxValue=Math.max(this.maxValue,Math.abs(l))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class tl{constructor(e,n,l,c,m,_){this.expression=e,this.uniformNames=n.map(b=>`u_${b}_t`),this.type=l,this.useIntegerZoom=c,this.context=m,this.maxValue=0,this.paintVertexAttributes=n.map(b=>({name:`a_${b}`,type:"Float32",components:l==="color"?4:2,offset:0})),this.paintVertexArray=new _}populatePaintArray(e,n,l,c,m,_,b){let I=this.expression.evaluate(new J(this.context.zoom,{brightness:_}),n,{},m,c,b),E=this.expression.evaluate(new J(this.context.zoom+1,{brightness:_}),n,{},m,c,b),L=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new J(0,{brightness:_}),n,{},m,c,b):this.lutExpression.value)==="none",F=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(F,e,I,E,L?null:this.context.lut)}updatePaintArray(e,n,l,c,m,_,b){let I=this.expression.evaluate({zoom:this.context.zoom,brightness:b},l,c,void 0,m),E=this.expression.evaluate({zoom:this.context.zoom+1,brightness:b},l,c,void 0,m),L=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new J(0,{brightness:b}),l,c,void 0,m):this.lutExpression.value)==="none";this._setPaintValue(e,n,I,E,L?null:this.context.lut)}_setPaintValue(e,n,l,c,m){if(this.type==="color"){let _=bf(l.toRenderColor(m)),b=bf(l.toRenderColor(m));for(let I=e;I<n;I++)this.paintVertexArray.emplace(I,_[0],_[1],b[0],b[1])}else{for(let _=e;_<n;_++)this.paintVertexArray.emplace(_,l,c);this.maxValue=Math.max(this.maxValue,Math.abs(l),Math.abs(c))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,n,l,c,m){let _=this.useIntegerZoom?Math.floor(l.zoom):l.zoom,b=rt(this.expression.interpolationFactor(_,this.context.zoom,this.context.zoom+1),0,1);n.set(e,m,b)}getBinding(e,n){return new is(e)}}class bl{constructor(e,n,l,c,m){this.expression=e,this.layerId=m,this.paintVertexAttributes=(l==="array"?u_:ag).members;for(let _=0;_<n.length;++_);this.paintVertexArray=new c,this.paintTransitionVertexArray=new io}populatePaintArray(e,n,l,c){let m=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(m,e,n.patterns&&n.patterns[this.layerId],l)}updatePaintArray(e,n,l,c,m,_,b){this._setPaintValues(e,n,l.patterns&&l.patterns[this.layerId],_)}_setPaintValues(e,n,l,c){if(!c||!l)return;let m=c[l[0]],_=c[l[1]];if(m){if(m){let{tl:b,br:I,pixelRatio:E}=m;for(let L=e;L<n;L++)this.paintVertexArray.emplace(L,b[0],b[1],I[0],I[1],E)}if(_){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);let{tl:b,br:I,pixelRatio:E}=_;for(let L=e;L<n;L++)this.paintTransitionVertexArray.emplace(L,b[0],b[1],I[0],I[1],E)}}}upload(e){let n=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,n)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,sd.members,n))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class cd{constructor(e,n,l=()=>!0){this.binders={},this._buffers=[],this.context=n;let c=[];for(let m in e.paint._values){let _=e.paint.get(m);if(m.endsWith("-use-theme")||!l(m)||!(_ instanceof Xe&&Hd(_.property.specification)))continue;let b=i(m,e.type),I=_.value,E=_.property.specification.type,L=!!_.property.useIntegerZoom,F=m==="line-dasharray"||m.endsWith("pattern"),V=e.paint.get(`${m}-use-theme`),W=m==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||V&&V.value.kind!=="constant";if(I.kind!=="constant"||W)if(I.kind==="source"||W||F){let H=g(m,E,"source");this.binders[m]=F?new bl(I,b,E,H,e.id):new Wh(I,b,E,H),c.push(`/a_${m}`)}else{let H=g(m,E,"composite");this.binders[m]=new tl(I,b,E,L,n,H),c.push(`/z_${m}`)}else this.binders[m]=F?new ld(I.value,b):new cp(I.value,b,E,n),c.push(`/u_${m}`);V&&(this.binders[m].lutExpression=V.value)}this.cacheKey=c.sort().join("")}getMaxValue(e){let n=this.binders[e];return n instanceof Wh||n instanceof tl?n.maxValue:0}populatePaintArrays(e,n,l,c,m,_,b){for(let I in this.binders){let E=this.binders[I];E.context=this.context,(E instanceof Wh||E instanceof tl||E instanceof bl)&&E.populatePaintArray(e,n,l,c,m,_,b)}}setConstantPatternPositions(e,n){for(let l in this.binders){let c=this.binders[l];c instanceof ld&&c.setConstantPatternPositions(e,n)}}getPatternTransitionVertexBuffer(e){let n=this.binders[e];return n instanceof bl?n.paintTransitionVertexBuffer:null}updatePaintArrays(e,n,l,c,m,_,b,I,E){let L=!1,F=Object.keys(e),V=F.length!==0&&!I,W=V?F:n.uniqueIds;this.context.lut=m.lut;for(let H in this.binders){let ee=this.binders[H];if(ee.context=this.context,(ee instanceof Wh||ee instanceof tl||ee instanceof bl)&&ee.expression&&ee.expression.kind&&ee.expression.kind!=="constant"&&(ee.expression.isStateDependent===!0||ee.expression.isLightConstant===!1)){let le=m.paint.get(H);ee.expression=le.value;for(let de of W){let Ce=e[de.toString()];n.eachPosition(de,(we,ie,me)=>{let Ie=c.feature(we);ee.updatePaintArray(ie,me,Ie,Ce,_,b,E)})}if(!V)for(let de of l.uniqueIds){let Ce=e[de.toString()];l.eachPosition(de,(we,ie,me)=>{let Ie=c.feature(we);ee.updatePaintArray(ie,me,Ie,Ce,_,b,E)})}L=!0}}return L}defines(){let e=[];for(let n in this.binders){let l=this.binders[n];(l instanceof cp||l instanceof ld)&&e.push(...l.uniformNames.map(c=>`#define HAS_UNIFORM_${c}`))}return e}getBinderAttributes(){let e=[];for(let n in this.binders){let l=this.binders[n];if(l instanceof Wh||l instanceof tl||l instanceof bl)for(let c=0;c<l.paintVertexAttributes.length;c++)e.push(l.paintVertexAttributes[c].name);if(l instanceof bl)for(let c=0;c<sd.members.length;c++)e.push(sd.members[c].name)}return e}getBinderUniforms(){let e=[];for(let n in this.binders){let l=this.binders[n];if(l instanceof cp||l instanceof ld||l instanceof tl)for(let c of l.uniformNames)e.push(c)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){let n=[];for(let l in this.binders){let c=this.binders[l];if(c instanceof cp||c instanceof ld||c instanceof tl)for(let m of c.uniformNames)n.push({name:m,property:l,binding:c.getBinding(e,m)})}return n}setUniforms(e,n,l,c,m){for(let{name:_,property:b,binding:I}of l)this.binders[b].setUniform(e,I,m,c.get(b),_)}updatePaintBuffers(){this._buffers=[];for(let e in this.binders){let n=this.binders[e];(n instanceof Wh||n instanceof tl||n instanceof bl)&&n.paintVertexBuffer&&this._buffers.push(n.paintVertexBuffer),n instanceof bl&&n.paintTransitionVertexBuffer&&this._buffers.push(n.paintTransitionVertexBuffer)}}upload(e){for(let n in this.binders){let l=this.binders[n];(l instanceof Wh||l instanceof tl||l instanceof bl)&&l.upload(e)}this.updatePaintBuffers()}destroy(){for(let e in this.binders){let n=this.binders[e];(n instanceof Wh||n instanceof tl||n instanceof bl)&&n.destroy()}}}class hp{constructor(e,n,l=()=>!0){this.programConfigurations={};for(let c of e)this.programConfigurations[c.id]=new cd(c,n,l);this.needsUpload=!1,this._featureMap=new ad,this._featureMapWithoutIds=new ad,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,n,l,c,m,_,b,I){for(let E in this.programConfigurations)this.programConfigurations[E].populatePaintArrays(e,n,c,m,_,b,I);n.id!==void 0?this._featureMap.add(n.id,l,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,l,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,n,l,c,m,_,b){for(let I of l)this.needsUpload=this.programConfigurations[I.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,n,I,c,m,_,b||0)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(let n in this.programConfigurations)this.programConfigurations[n].upload(e);this.needsUpload=!1}}destroy(){for(let e in this.programConfigurations)this.programConfigurations[e].destroy()}}let p={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"]};function i(o,e){return p[o]||[o.replace(`${e}-`,"").replace(/-/g,"_")]}let a={"line-pattern":{source:io,composite:io},"fill-pattern":{source:io,composite:io},"fill-extrusion-pattern":{source:io,composite:io},"line-dasharray":{source:ca,composite:ca}},f={color:{source:od,composite:jl},number:{source:dc,composite:od}};function g(o,e,n){let l=a[o];return l&&l[n]||f[e][n]}Ei(cp,"ConstantBinder"),Ei(ld,"PatternConstantBinder"),Ei(Wh,"SourceExpressionBinder"),Ei(bl,"PatternCompositeBinder"),Ei(tl,"CompositeExpressionBinder"),Ei(cd,"ProgramConfiguration",{omit:["_buffers"]}),Ei(hp,"ProgramConfigurationSet");let v=xi/Math.PI/2,S=5,C=6,z=16383,N=64,U=[N,32,16],$=-v,Z=v;function X(o,e,n,l=v){return n=te(n),[o*Math.sin(n)*l,-e*l,o*Math.cos(n)*l]}function se(o,e,n){return X(Math.cos(te(o)),Math.sin(te(o)),e,n)}let re=63710088e-1,he=2*Math.PI*re;class ae{constructor(e,n){if(isNaN(e)||isNaN(n))throw new Error(`Invalid LngLat object: (${e}, ${n})`);if(this.lng=+e,this.lat=+n,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new ae(nt(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){let n=Math.PI/180,l=this.lat*n,c=e.lat*n,m=Math.sin(l)*Math.sin(c)+Math.cos(l)*Math.cos(c)*Math.cos((e.lng-this.lng)*n);return re*Math.acos(Math.min(m,1))}toBounds(e=0){let n=360*e/40075017,l=n/Math.cos(Math.PI/180*this.lat);return new be({lng:this.lng-l,lat:this.lat-n},{lng:this.lng+l,lat:this.lat+n})}toEcef(e){return se(this.lat,this.lng,v+e*v/re)}static convert(e){if(e instanceof ae)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new ae(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new ae(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class be{constructor(e,n){if(e)if(n)this.setSouthWest(e).setNorthEast(n);else if(e.length===4){let l=e;this.setSouthWest([l[0],l[1]]).setNorthEast([l[2],l[3]])}else{let l=e;this.setSouthWest(l[0]).setNorthEast(l[1])}}setNorthEast(e){return this._ne=e instanceof ae?new ae(e.lng,e.lat):ae.convert(e),this}setSouthWest(e){return this._sw=e instanceof ae?new ae(e.lng,e.lat):ae.convert(e),this}extend(e){let n=this._sw,l=this._ne,c,m;if(e instanceof ae)c=e,m=e;else{if(!(e instanceof be))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(be.convert(e)):this.extend(ae.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(ae.convert(e)):this;if(c=e._sw,m=e._ne,!c||!m)return this}return n||l?(n.lng=Math.min(c.lng,n.lng),n.lat=Math.min(c.lat,n.lat),l.lng=Math.max(m.lng,l.lng),l.lat=Math.max(m.lat,l.lat)):(this._sw=new ae(c.lng,c.lat),this._ne=new ae(m.lng,m.lat)),this}getCenter(){return new ae((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new ae(this.getWest(),this.getNorth())}getSouthEast(){return new ae(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){let{lng:n,lat:l}=ae.convert(e),c=this._sw.lng<=n&&n<=this._ne.lng;return this._sw.lng>this._ne.lng&&(c=this._sw.lng>=n&&n>=this._ne.lng),this._sw.lat<=l&&l<=this._ne.lat&&c}static convert(e){if(e)return e instanceof be?e:new be(e)}}let Pe=0,Re=25.5;function Ge(o){return he*Math.cos(o*Math.PI/180)}function Ne(o){return(180+o)/360}function Ve(o){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+o*Math.PI/360)))/360}function Oe(o,e){return o/Ge(e)}function Ke(o){return 360*o-180}function Qe(o){return 360/Math.PI*Math.atan(Math.exp((180-360*o)*Math.PI/180))-90}function It(o,e){return o*Ge(Qe(e))}let gt=85.051129;function jt(o){return Math.cos(te(rt(o,-gt,gt)))}function Ut(o,e){let n=rt(e,Pe,Re),l=Math.pow(2,n);return jt(o)*he/(512*l)}function fi(o){return 1/Math.cos(o*Math.PI/180)}function vt(o,e=0){let n=Math.exp(Math.PI*(1-(o.y+e/xi)/(1<<o.z)*2));return 80150034*n/(n*n+1)/xi/(1<<o.z)}class Ct{constructor(e,n,l=0){this.x=+e,this.y=+n,this.z=+l}static fromLngLat(e,n=0){let l=ae.convert(e);return new Ct(Ne(l.lng),Ve(l.lat),Oe(n,l.lat))}toLngLat(){return new ae(Ke(this.x),Qe(this.y))}toAltitude(){return It(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/he*fi(Qe(this.y))}}function _t(o,e,n,l,c,m,_,b,I){let E=(e+l)/2,L=(n+c)/2,F=new Ue(E,L);b(F),function(V,W,H,ee,le,de){let Ce=H-le,we=ee-de;return Math.abs((ee-W)*Ce-(H-V)*we)/Math.hypot(Ce,we)}(F.x,F.y,m.x,m.y,_.x,_.y)>=I?(_t(o,e,n,E,L,m,F,b,I),_t(o,E,L,l,c,F,_,b,I)):o.push(_)}function qt(o,e,n){let l=o[0],c=l.x,m=l.y;e(l);let _=[l];for(let b=1;b<o.length;b++){let I=o[b],{x:E,y:L}=I;e(I),_t(_,c,m,E,L,l,I,e,n),c=E,m=L,l=I}return _}function Pt(o,e,n,l){if(l(e,n)){let c=e.add(n)._mult(.5);Pt(o,e,c,l),Pt(o,c,n,l)}else o.push(n)}function ti(o,e){let n=o[0],l=[n];for(let c=1;c<o.length;c++){let m=o[c];Pt(l,n,m,e),n=m}return l}let Gt=Math.pow(2,14)-1,ii=-Gt-1;function oi(o,e){let n=Math.round(o.x*e),l=Math.round(o.y*e);return o.x=rt(n,ii,Gt),o.y=rt(l,ii,Gt),(n<o.x||n>o.x+1||l<o.y||l>o.y+1)&&Hi("Geometry exceeds allowed extent, reduce your vector tile buffer size"),o}function ki(o,e,n){let l=o.loadGeometry(),c=o.extent,m=xi/c;if(e&&n&&n.projection.isReprojectedInTileSpace){let _=1<<e.z,{scale:b,x:I,y:E,projection:L}=n,F=V=>{let W=Ke((e.x+V.x/c)/_),H=Qe((e.y+V.y/c)/_),ee=L.project(W,H);V.x=(ee.x*b-I)*c,V.y=(ee.y*b-E)*c};for(let V=0;V<l.length;V++)if(o.type!==1)l[V]=qt(l[V],F,1);else{let W=[];for(let H of l[V])H.x<0||H.x>=c||H.y<0||H.y>=c||(F(H),W.push(H));l[V]=W}}for(let _ of l)for(let b of _)oi(b,m);return l}function ji(o,e){return{type:o.type,id:o.id,properties:o.properties,geometry:e?ki(o):[]}}function zi(o,e,n,l,c){o.emplaceBack(2*e+(l+1)/2,2*n+(c+1)/2)}function $i(o,e,n){o.emplaceBack(e.x,e.y,e.z,n[0]*16384,n[1]*16384,n[2]*16384)}class Oi{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new la,this.indexArray=new zo,this.segments=new bo,this.programConfigurations=new hp(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id)}updateFootprints(e,n){}populate(e,n,l,c){let m=this.layers[0],_=[],b=null;m.type==="circle"&&(b=m.layout.get("circle-sort-key"));for(let{feature:E,id:L,index:F,sourceLayerIndex:V}of e){let W=this.layers[0]._featureFilter.needGeometry,H=ji(E,W);if(!this.layers[0]._featureFilter.filter(new J(this.zoom),H,l))continue;let ee=b?b.evaluate(H,{},l):void 0,le={id:L,properties:E.properties,type:E.type,sourceLayerIndex:V,index:F,geometry:W?H.geometry:ki(E,l,c),patterns:{},sortKey:ee};_.push(le)}b&&_.sort((E,L)=>E.sortKey-L.sortKey);let I=null;c.projection.name==="globe"&&(this.globeExtVertexArray=new ts,I=c.projection);for(let E of _){let{geometry:L,index:F,sourceLayerIndex:V}=E,W=e[F].feature;this.addFeature(E,L,F,n.availableImages,l,I,n.brightness),n.featureIndex.insert(W,L,F,V,this.index)}}update(e,n,l,c,m,_,b){this.programConfigurations.updatePaintArrays(e,n,m,l,c,_,b)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,sg.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,h_.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(e,n,l,c,m,_,b){for(let I of n)for(let E of I){let L=E.x,F=E.y;if(L<0||L>=xi||F<0||F>=xi)continue;if(_){let H=_.projectTilePoint(L,F,m),ee=_.upVector(m,L,F),le=this.globeExtVertexArray;$i(le,H,ee),$i(le,H,ee),$i(le,H,ee),$i(le,H,ee)}let V=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),W=V.vertexLength;zi(this.layoutVertexArray,L,F,-1,-1),zi(this.layoutVertexArray,L,F,1,-1),zi(this.layoutVertexArray,L,F,1,1),zi(this.layoutVertexArray,L,F,-1,1),this.indexArray.emplaceBack(W,W+1,W+2),this.indexArray.emplaceBack(W,W+2,W+3),V.vertexLength+=4,V.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,l,{},c,m,b)}}function nn(o,e){for(let n=0;n<o.length;n++)if(Or(e,o[n]))return!0;for(let n=0;n<e.length;n++)if(Or(o,e[n]))return!0;return!!zr(o,e)}function xn(o,e,n){return!!Or(o,e)||!!En(e,o,n)}function Bn(o,e){if(o.length===1)return pr(e,o[0]);for(let n=0;n<e.length;n++){let l=e[n];for(let c=0;c<l.length;c++)if(Or(o,l[c]))return!0}for(let n=0;n<o.length;n++)if(pr(e,o[n]))return!0;for(let n=0;n<e.length;n++)if(zr(o,e[n]))return!0;return!1}function Er(o,e,n){if(o.length>1){if(zr(o,e))return!0;for(let l=0;l<e.length;l++)if(En(e[l],o,n))return!0}for(let l=0;l<o.length;l++)if(En(o[l],e,n))return!0;return!1}function zr(o,e){if(o.length===0||e.length===0)return!1;for(let n=0;n<o.length-1;n++){let l=o[n],c=o[n+1];for(let m=0;m<e.length-1;m++)if(Gn(l,c,e[m],e[m+1]))return!0}return!1}function Gn(o,e,n,l){return yr(o,n,l)!==yr(e,n,l)&&yr(o,e,n)!==yr(o,e,l)}function po(o,e,n){return(o.x-n.x)*(e.y-n.y)-(o.y-n.y)*(e.x-n.x)}function no(o,e,n,l){let c=po(o,e,l),m=po(o,e,n);if(Math.sign(c)===Math.sign(m))return;let _=po(n,l,o),b=_+m-c;return Math.sign(_)!==Math.sign(b)?[_/(_-b),m/(m-c)]:void 0}function En(o,e,n){let l=n*n;if(e.length===1)return o.distSqr(e[0])<l;for(let c=1;c<e.length;c++)if(cr(o,e[c-1],e[c])<l)return!0;return!1}function cr(o,e,n){let l=e.distSqr(n);if(l===0)return o.distSqr(e);let c=((o.x-e.x)*(n.x-e.x)+(o.y-e.y)*(n.y-e.y))/l;return o.distSqr(c<0?e:c>1?n:n.sub(e)._mult(c)._add(e))}function pr(o,e){let n,l,c,m=!1;for(let _=0;_<o.length;_++){n=o[_];for(let b=0,I=n.length-1;b<n.length;I=b++)l=n[b],c=n[I],l.y>e.y!=c.y>e.y&&e.x<(c.x-l.x)*(e.y-l.y)/(c.y-l.y)+l.x&&(m=!m)}return m}function Or(o,e){let n=!1;for(let l=0,c=o.length-1;l<o.length;c=l++){let m=o[l],_=o[c];m.y>e.y!=_.y>e.y&&e.x<(_.x-m.x)*(e.y-m.y)/(_.y-m.y)+m.x&&(n=!n)}return n}function xs(o,e,n,l,c){for(let _ of o)if(e<=_.x&&n<=_.y&&l>=_.x&&c>=_.y)return!0;let m=[new Ue(e,n),new Ue(e,c),new Ue(l,c),new Ue(l,n)];if(o.length>2){for(let _ of m)if(Or(o,_))return!0}for(let _=0;_<o.length-1;_++)if(Lo(o[_],o[_+1],m))return!0;return!1}function Lo(o,e,n){let l=n[0],c=n[2];if(o.x<l.x&&e.x<l.x||o.x>c.x&&e.x>c.x||o.y<l.y&&e.y<l.y||o.y>c.y&&e.y>c.y)return!1;let m=yr(o,e,n[0]);return m!==yr(o,e,n[1])||m!==yr(o,e,n[2])||m!==yr(o,e,n[3])}function ko(o,e,n,l,c,m){let _=e.y-o.y,b=o.x-e.x;if(m=m||0){let I=_*_+b*b;if(I===0)return!0;let E=Math.sqrt(I);_/=E,b/=E}return!((n.x-o.x)*_+(n.y-o.y)*b-m<0||(l.x-o.x)*_+(l.y-o.y)*b-m<0||(c.x-o.x)*_+(c.y-o.y)*b-m<0)}function ro(o,e,n,l,c,m,_){return!(ko(o,e,l,c,m,_)||ko(e,n,l,c,m,_)||ko(n,o,l,c,m,_)||ko(l,c,o,e,n,_)||ko(c,m,o,e,n,_)||ko(m,l,o,e,n,_))}function Dn(o,e,n){let l=e.paint.get(o).value;return l.kind==="constant"?l.value:n.programConfigurations.get(e.id).getMaxValue(o)}function oo(o){return Math.sqrt(o[0]*o[0]+o[1]*o[1])}function fr(o,e,n,l,c){if(!e[0]&&!e[1])return o;let m=Ue.convert(e)._mult(c);n==="viewport"&&m._rotate(-l);let _=[];for(let b=0;b<o.length;b++)_.push(o[b].sub(m));return _}function so(o,e,n,l){let c=Ue.convert(o)._mult(l);return e==="viewport"&&c._rotate(-n),c}let Sr,fo;function js(o,e,n){var l=2*Math.PI*6378137/256/Math.pow(2,n);return[o*l-2*Math.PI*6378137/2,e*l-2*Math.PI*6378137/2]}Ei(Oi,"CircleBucket",{omit:["layers"]});class Gr{constructor(e,n,l){this.z=e,this.x=n,this.y=l,this.key=ha(0,e,e,n,l)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,n){let l=function(m,_,b){var I=js(256*m,256*(_=Math.pow(2,b)-_-1),b),E=js(256*(m+1),256*(_+1),b);return I[0]+","+I[1]+","+E[0]+","+E[1]}(this.x,this.y,this.z),c=function(m,_,b){let I,E="";for(let L=m;L>0;L--)I=1<<L-1,E+=(_&I?1:0)+(b&I?2:0);return E}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(n==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",c).replace("{bbox-epsg-3857}",l)}toString(){return`${this.z}/${this.x}/${this.y}`}}class ea{constructor(e,n){this.wrap=e,this.canonical=n,this.key=ha(e,n.z,n.z,n.x,n.y)}}class Xo{constructor(e,n,l,c,m){this.overscaledZ=e,this.wrap=n,this.canonical=new Gr(l,+c,+m),this.key=n===0&&e===l?this.canonical.key:ha(n,e,l,c,m)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){let n=this.canonical.z-e;return e>this.canonical.z?new Xo(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Xo(e,this.wrap,e,this.canonical.x>>n,this.canonical.y>>n)}calculateScaledKey(e,n=!0){if(this.overscaledZ===e&&n)return this.key;if(e>this.canonical.z)return ha(this.wrap*+n,e,this.canonical.z,this.canonical.x,this.canonical.y);{let l=this.canonical.z-e;return ha(this.wrap*+n,e,e,this.canonical.x>>l,this.canonical.y>>l)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;let n=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>n&&e.canonical.y===this.canonical.y>>n}children(e){if(this.overscaledZ>=e)return[new Xo(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];let n=this.canonical.z+1,l=2*this.canonical.x,c=2*this.canonical.y;return[new Xo(n,this.wrap,n,l,c),new Xo(n,this.wrap,n,l+1,c),new Xo(n,this.wrap,n,l,c+1),new Xo(n,this.wrap,n,l+1,c+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new Xo(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new Xo(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new ea(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function ha(o,e,n,l,c){let m=1<<Math.min(n,22),_=m*(c%m)+l%m;return o&&n<22&&(_+=m*m*((o<0?-2*o-1:2*o)%(1<<2*(22-n)))),16*(32*_+n)+(e-n)}let wh=[o=>{let e=o.canonical.x-1,n=o.wrap;return e<0&&(e=(1<<o.canonical.z)-1,n--),new Xo(o.overscaledZ,n,o.canonical.z,e,o.canonical.y)},o=>{let e=o.canonical.x+1,n=o.wrap;return e===1<<o.canonical.z&&(e=0,n++),new Xo(o.overscaledZ,n,o.canonical.z,e,o.canonical.y)},o=>new Xo(o.overscaledZ,o.wrap,o.canonical.z,o.canonical.x,(o.canonical.y===0?1<<o.canonical.z:o.canonical.y)-1),o=>new Xo(o.overscaledZ,o.wrap,o.canonical.z,o.canonical.x,o.canonical.y===(1<<o.canonical.z)-1?0:o.canonical.y+1)];Ei(Gr,"CanonicalTileID"),Ei(Xo,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});let Lc=Kn([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Zl}=Lc,fc=Kn([{name:"a_pos_3",components:3,type:"Int16"}]);var Hh=Kn([{name:"a_pos",type:"Int16",components:2}]);class Xh{constructor(e,n){this.pos=e,this.dir=n}intersectsPlane(e,n,l){let c=Tt(n,this.dir);if(Math.abs(c)<1e-6)return!1;let m=((e[0]-this.pos[0])*n[0]+(e[1]-this.pos[1])*n[1])/c;return l[0]=this.pos[0]+this.dir[0]*m,l[1]=this.pos[1]+this.dir[1]*m,!0}}class Th{constructor(e,n){this.pos=e,this.dir=n}intersectsPlane(e,n,l){let c=jr(n,this.dir);if(Math.abs(c)<1e-6)return!1;let m=((e[0]-this.pos[0])*n[0]+(e[1]-this.pos[1])*n[1]+(e[2]-this.pos[2])*n[2])/c;return l[0]=this.pos[0]+this.dir[0]*m,l[1]=this.pos[1]+this.dir[1]*m,l[2]=this.pos[2]+this.dir[2]*m,!0}closestPointOnSphere(e,n,l){if(function(W,H){var ee=W[0],le=W[1],de=W[2],Ce=H[0],we=H[1],ie=H[2];return Math.abs(ee-Ce)<=at*Math.max(1,Math.abs(ee),Math.abs(Ce))&&Math.abs(le-we)<=at*Math.max(1,Math.abs(le),Math.abs(we))&&Math.abs(de-ie)<=at*Math.max(1,Math.abs(de),Math.abs(ie))}(this.pos,e)||n===0)return l[0]=l[1]=l[2]=0,!1;let[c,m,_]=this.dir,b=this.pos[0]-e[0],I=this.pos[1]-e[1],E=this.pos[2]-e[2],L=c*c+m*m+_*_,F=2*(b*c+I*m+E*_),V=F*F-4*L*(b*b+I*I+E*E-n*n);if(V<0){let W=Math.max(-F/2,0),H=b+c*W,ee=I+m*W,le=E+_*W,de=Math.hypot(H,ee,le);return l[0]=H*n/de,l[1]=ee*n/de,l[2]=le*n/de,!1}{let W=(-F-Math.sqrt(V))/(2*L);if(W<0){let H=Math.hypot(b,I,E);return l[0]=b*n/H,l[1]=I*n/H,l[2]=E*n/H,!1}return l[0]=b+c*W,l[1]=I+m*W,l[2]=E+_*W,!0}}}class up{constructor(e,n,l,c,m){this.TL=e,this.TR=n,this.BR=l,this.BL=c,this.horizon=m}static fromInvProjectionMatrix(e,n,l){let c=[-1,1,1],m=[1,1,1],_=[1,-1,1],b=[-1,-1,1],I=gr(c,c,e),E=gr(m,m,e),L=gr(_,_,e),F=gr(b,b,e);return new up(I,E,L,F,n/l)}}function dp(o,e,n){let l=1/0,c=-1/0,m=[];for(let _ of o){hr(m,_,e);let b=jr(m,n);l=Math.min(l,b),c=Math.max(c,b)}return[l,c]}function Kf(o,e){let n=!0;for(let l=0;l<o.planes.length;l++){let c=o.planes[l],m=0;for(let _=0;_<e.length;_++)m+=jr(c,e[_])+c[3]>=0;if(m===0)return 0;m!==e.length&&(n=!1)}return n?2:1}function hd(o,e){for(let n of o.projections){let l=dp(e,o.points[0],n.axis);if(n.projection[1]<l[0]||n.projection[0]>l[1])return 0}return 1}function wf(o,e){let n=0,l=[0,0,0,0];for(let _=0;_<o.length;_++)l[0]=o[_][0],l[1]=o[_][1],l[2]=o[_][2],l[3]=1,(c=l)[0]*(m=e)[0]+c[1]*m[1]+c[2]*m[2]+c[3]*m[3]>=0&&n++;var c,m;return n}class pp{constructor(e,n){this.points=e||new Array(8).fill([0,0,0]),this.planes=n||new Array(6).fill([0,0,0,0]),this.bounds=Jr.fromPoints(this.points),this.projections=[],this.frustumEdges=[hr([],this.points[2],this.points[3]),hr([],this.points[0],this.points[3]),hr([],this.points[4],this.points[0]),hr([],this.points[5],this.points[1]),hr([],this.points[6],this.points[2]),hr([],this.points[7],this.points[3])];for(let l of this.frustumEdges){let c=[0,-l[2],l[1]],m=[l[2],0,-l[0]];this.projections.push({axis:c,projection:dp(this.points,this.points[0],c)}),this.projections.push({axis:m,projection:dp(this.points,this.points[0],m)})}}static fromInvProjectionMatrix(e,n,l,c){let m=Math.pow(2,l),_=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(E=>{let L=Vo([],E,e),F=1/L[3]/n*m;return(V=L)[0]=(W=L)[0]*(H=[F,F,c?1/L[3]:F,F])[0],V[1]=W[1]*H[1],V[2]=W[2]*H[2],V[3]=W[3]*H[3],V;var V,W,H}),b=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(E=>{let L=Lr([],Co([],hr([],_[E[0]],_[E[1]]),hr([],_[E[2]],_[E[1]]))),F=-jr(L,_[E[1]]);return L.concat(F)}),I=[];for(let E=0;E<_.length;E++)I.push([_[E][0],_[E][1],_[E][2]]);return new pp(I,b)}intersectsPrecise(e,n,l){for(let c=0;c<n.length;c++)if(!wf(e,n[c]))return 0;for(let c=0;c<this.planes.length;c++)if(!wf(e,this.planes[c]))return 0;for(let c of l)for(let m of this.frustumEdges){let _=Co([],c,m),b=No(_);if(b===0)continue;Mr(_,_,1/b);let I=dp(this.points,this.points[0],_),E=dp(e,this.points[0],_);if(I[0]>E[1]||E[0]>I[1])return 0}return 1}containsPoint(e){for(let n of this.planes){let l=n[3];if(jr([n[0],n[1],n[2]],e)+l<0)return!1}return!0}}class Jr{static fromPoints(e){let n=[1/0,1/0,1/0],l=[-1/0,-1/0,-1/0];for(let c of e)dl(n,n,c),$a(l,l,c);return new Jr(n,l)}static fromTileIdAndHeight(e,n,l){let c=1<<e.canonical.z,m=e.canonical.x,_=e.canonical.y;return new Jr([m/c,_/c,n],[(m+1)/c,(_+1)/c,l])}static applyTransform(e,n){let l=e.getCorners();for(let c=0;c<l.length;++c)gr(l[c],l[c],n);return Jr.fromPoints(l)}static applyTransformFast(e,n){let l=[n[12],n[13],n[14]],c=[...l];for(let m=0;m<3;m++)for(let _=0;_<3;_++){let b=n[4*_+m],I=b*e.min[_],E=b*e.max[_];l[m]+=Math.min(I,E),c[m]+=Math.max(I,E)}return new Jr(l,c)}static projectAabbCorners(e,n){let l=e.getCorners();for(let c=0;c<l.length;++c)gr(l[c],l[c],n);return l}constructor(e,n){this.min=e,this.max=n,this.center=Mr([],ho([],this.min,this.max),.5)}quadrant(e){let n=[e%2==0,e<2],l=qa(this.min),c=qa(this.max);for(let m=0;m<n.length;m++)l[m]=n[m]?this.min[m]:this.center[m],c[m]=n[m]?this.center[m]:this.max[m];return c[2]=this.max[2],new Jr(l,c)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){let e=this.min,n=this.max;return[[e[0],e[1],e[2]],[n[0],e[1],e[2]],[n[0],n[1],e[2]],[e[0],n[1],e[2]],[e[0],e[1],n[2]],[n[0],e[1],n[2]],[n[0],n[1],n[2]],[e[0],n[1],n[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?Kf(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?Kf(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,n){return n||this.intersects(e)?hd(e,this.getCorners()):0}intersectsPreciseFlat(e,n){return n||this.intersectsFlat(e)?hd(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let n=0;n<3;++n)if(this.min[n]>e.max[n]||e.min[n]>this.max[n])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],e.min[n]),this.max[n]=Math.max(this.max[n],e.max[n])}encapsulatePoint(e){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],e[n]),this.max[n]=Math.max(this.max[n],e[n])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}function vs(o){return o*v/re}Ei(Jr,"Aabb");let Tf=[new Jr([$,$,$],[Z,Z,Z]),new Jr([$,$,$],[0,0,Z]),new Jr([0,$,$],[Z,0,Z]),new Jr([$,0,$],[0,Z,Z]),new Jr([0,0,$],[Z,Z,Z])];function py(o,e,n,l=!0){let c=Mr([],o._camera.position,o.worldSize),m=[e,n,1,1];Vo(m,m,o.pixelMatrixInverse),Jo(m,m,1/m[3]);let _=Lr([],hr([],m,c)),b=o.globeMatrix,I=[b[12],b[13],b[14]],E=hr([],I,c),L=No(E),F=Lr([],E),V=o.worldSize/(2*Math.PI),W=jr(F,_),H=Math.asin(V/L);if(H<Math.acos(W)){if(!l)return null;let ut=[],xt=[];Mr(ut,_,L/W),Lr(xt,hr(xt,ut,E)),Lr(_,ho(_,E,Mr(_,xt,Math.tan(H)*L)))}let ee=[];new Th(c,_).closestPointOnSphere(I,V,ee);let le=Lr([],Qo(b,0)),de=Lr([],Qo(b,1)),Ce=Lr([],Qo(b,2)),we=jr(le,ee),ie=jr(de,ee),me=jr(Ce,ee),Ie=fe(Math.asin(-ie/V)),ze=fe(Math.atan2(we,me));ze=o.center.lng+function(ut,xt){let Ft=(xt-ut+180)%360-180;return Ft<-180?Ft+360:Ft}(o.center.lng,ze);let Je=Ne(ze),st=rt(Ve(Ie),0,1);return new Ct(Je,st)}class fy{constructor(e,n,l){this.a=hr([],e,l),this.b=hr([],n,l),this.center=l;let c=Lr([],this.a),m=Lr([],this.b);this.angle=Math.acos(jr(c,m))}}function ud(o,e){if(o.angle===0)return null;let n;return n=o.a[e]===0?1/o.angle*.5*Math.PI:1/o.angle*Math.atan(o.b[e]/o.a[e]/Math.sin(o.angle)-1/Math.tan(o.angle)),n<0||n>1?null:function(l,c,m,_){let b=Math.sin(m);return l*(Math.sin((1-_)*m)/b)+c*(Math.sin(_*m)/b)}(o.a[e],o.b[e],o.angle,rt(n,0,1))+o.center[e]}function Kh(o){if(o.z<=1)return Tf[o.z+2*o.y+o.x];let e=Um(Vm(o));return Jr.fromPoints(e)}function fp(o,e,n){return Mr(o,o,1-n),as(o,o,e,n)}function my(o,e,n){for(let l of o)gr(l,l,e),Mr(l,l,n)}function _y(o,e,n,l){let c=e/o.worldSize,m=o.globeMatrix;if(n.z<=1){let st=Kh(n).getCorners();return my(st,m,c),Jr.fromPoints(st)}let _=Vm(n,l),b=Um(_,v+vs(o._tileCoverLift));my(b,m,c);let I=Number.MAX_VALUE,E=[-I,-I,-I],L=[I,I,I];if(_.contains(o.center)){for(let xt of b)dl(L,L,xt),$a(E,E,xt);E[2]=0;let st=o.point,ut=[st.x*c,st.y*c,0];return dl(L,L,ut),$a(E,E,ut),new Jr(L,E)}if(o._tileCoverLift>0){for(let st of b)dl(L,L,st),$a(E,E,st);return new Jr(L,E)}let F=[m[12]*c,m[13]*c,m[14]*c],V=_.getCenter(),W=rt(o.center.lat,-gt,gt),H=rt(V.lat,-gt,gt),ee=Ne(o.center.lng),le=Ve(W),de=ee-Ne(V.lng),Ce=le-Ve(H);de>.5?de-=1:de<-.5&&(de+=1);let we=0;Math.abs(de)>Math.abs(Ce)?we=de>=0?1:3:(we=Ce>=0?0:2,as(F,F,[m[4]*c,m[5]*c,m[6]*c],-Math.sin(te(Ce>=0?_.getSouth():_.getNorth()))*v));let ie=b[we],me=b[(we+1)%4],Ie=new fy(ie,me,F),ze=[ud(Ie,0)||ie[0],ud(Ie,1)||ie[1],ud(Ie,2)||ie[2]],Je=mp(o.zoom);if(Je>0){let st=function({x:xt,y:Ft,z:ri},$t,Qt,hi,Rt){let Yt=1/(1<<ri),Et=xt*Yt,kt=Et+Yt,pi=Ft*Yt,mi=pi+Yt,qi=0,Bi=(Et+kt)/2-hi;return Bi>.5?qi=-1:Bi<-.5&&(qi=1),Et=((Et+qi)*$t-(hi*=$t))*Qt+hi,kt=((kt+qi)*$t-hi)*Qt+hi,pi=(pi*$t-(Rt*=$t))*Qt+Rt,mi=(mi*$t-Rt)*Qt+Rt,[[Et,mi,0],[kt,mi,0],[kt,pi,0],[Et,pi,0]]}(n,e,o._pixelsPerMercatorPixel,ee,le);for(let xt=0;xt<b.length;xt++)fp(b[xt],st[xt],Je);let ut=ho([],st[we],st[(we+1)%4]);Mr(ut,ut,.5),fp(ze,ut,Je)}for(let st of b)dl(L,L,st),$a(E,E,st);return L[2]=Math.min(ie[2],me[2]),dl(L,L,ze),$a(E,E,ze),new Jr(L,E)}function Vm({x:o,y:e,z:n},l=!1){let c=1/(1<<n),m=new ae(Ke(o*c),e===(1<<n)-1&&l?-90:Qe((e+1)*c)),_=new ae(Ke((o+1)*c),e===0&&l?90:Qe(e*c));return new be(m,_)}function Um(o,e=v){let n=te(o.getNorth()),l=te(o.getSouth()),c=Math.cos(n),m=Math.cos(l),_=Math.sin(n),b=Math.sin(l),I=o.getWest(),E=o.getEast();return[X(m,b,I,e),X(m,b,E,e),X(c,_,E,e),X(c,_,I,e)]}function Yf(o,e,n,l){let c=1<<n.z,m=(o/xi+n.x)/c;return se(Qe((e/xi+n.y)/c),Ke(m),l)}function Jp({min:o,max:e}){return z/Math.max(e[0]-o[0],e[1]-o[1],e[2]-o[2])}let Sf=new Float64Array(16);function If(o){let e=Jp(o),n=os(Sf,[e,e,e]);return vr(n,n,xa([],o.min))}function Jf(o){let e=(l=o.min,(n=Sf)[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=l[0],n[13]=l[1],n[14]=l[2],n[15]=1,n);var n,l;let c=1/Jp(o);return Bo(e,e,[c,c,c])}function lg(o){let e=xi/(2*Math.PI);return o/(2*Math.PI)/e}function gy(o,e){return xi/(512*Math.pow(2,o))*Jp(Kh(e))}function cg(o,e,n,l,c){let m=lg(n),_=[o,e,-n/(2*Math.PI)],b=on(new Float64Array(16));return vr(b,b,_),Bo(b,b,[m,m,m]),qo(b,b,te(-c)),to(b,b,te(-l)),b}function mp(o){return ct(S,C,o)}function yy(o,e){let n=se(e.lat,e.lng),l=function(H){let ee=se(H._center.lat,H._center.lng),le=Co([],Ur(0,1,0),ee),de=ga([],-H.angle,ee);le=gr(le,le,de),ga(de,-H._pitch,le);let Ce=Lr([],ee);return Mr(Ce,Ce,vs(H.cameraToCenterDistance/H.pixelsPerMeter)),gr(Ce,Ce,de),ho([],ee,Ce)}(o);return _=(c=ss([],l,n))[0],b=c[1],I=c[2],E=(m=n)[0],L=m[1],F=m[2],W=(V=Math.sqrt(_*_+b*b+I*I)*Math.sqrt(E*E+L*L+F*F))&&jr(c,m)/V,Math.acos(Math.min(Math.max(W,-1),1));var c,m,_,b,I,E,L,F,V,W}function p_(o,e){return yy(o,e)>Math.PI/2*1.01}let hg=te(85),ug=Math.cos(hg),dg=Math.sin(hg),X0=Wi(),pg=o=>{let e=[];return o.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),o.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function xy(o,e,n,l,c,m,_,b,I){if(m&&o.queryGeometry.isAboveHorizon)return!1;m&&(I*=o.pixelToTileUnitsFactor);let E=o.tileID.canonical,L=n.projection.upVectorScale(E,n.center.lat,n.worldSize).metersToTile;for(let F of e)for(let V of F){let W=V.add(b),H=c&&n.elevation?n.elevation.exaggeration()*c.getElevationAt(W.x,W.y,!0):0,ee=n.projection.projectTilePoint(W.x,W.y,E);if(H>0){let we=n.projection.upVector(E,W.x,W.y);ee.x+=we[0]*L*H,ee.y+=we[1]*L*H,ee.z+=we[2]*L*H}let le=m?W:K0(ee.x,ee.y,ee.z,l),de=m?o.tilespaceRays.map(we=>J0(we,H)):o.queryGeometry.screenGeometry,Ce=Vo([],[ee.x,ee.y,ee.z,1],l);if(!_&&m?I*=Ce[3]/n.cameraToCenterDistance:_&&!m&&(I*=n.cameraToCenterDistance/Ce[3]),m){let we=Qe((V.y/xi+E.y)/(1<<E.z));I/=n.projection.pixelsPerMeter(we,1)/Oe(1,we)}if(xn(de,le,I))return!0}return!1}function K0(o,e,n,l){let c=Vo([],[o,e,n,1],l);return new Ue(c[0]/c[3],c[1]/c[3])}let vy=Ur(0,0,0),Y0=Ur(0,0,1);function J0(o,e){let n=Io();return vy[2]=e,o.intersectsPlane(vy,Y0,n),new Ue(n[0],n[1])}class fg extends Oi{}let mg,dd,_p,_g;function f_(o,{width:e,height:n},l,c){if(c){if(c instanceof Uint8ClampedArray)c=new Uint8Array(c.buffer);else if(c.length!==e*n*l)throw new RangeError("mismatched image size")}else c=new Uint8Array(e*n*l);return o.width=e,o.height=n,o.data=c,o}function by(o,e,n){let{width:l,height:c}=e;l===o.width&&c===o.height||(gg(o,e,{x:0,y:0},{x:0,y:0},{width:Math.min(o.width,l),height:Math.min(o.height,c)},n,null),o.width=l,o.height=c,o.data=e.data)}function gg(o,e,n,l,c,m,_,b){if(c.width===0||c.height===0)return e;if(c.width>o.width||c.height>o.height||n.x>o.width-c.width||n.y>o.height-c.height)throw new RangeError("out of range source coordinates for image copy");if(c.width>e.width||c.height>e.height||l.x>e.width-c.width||l.y>e.height-c.height)throw new RangeError("out of range destination coordinates for image copy");let I=o.data,E=e.data,L=m===4&&b;for(let F=0;F<c.height;F++){let V=((n.y+F)*o.width+n.x)*m,W=((l.y+F)*e.width+l.x)*m;if(L)for(let H=0;H<c.width;H++){let ee=V+H*m+3,le=W+H*m;E[le+0]=255,E[le+1]=255,E[le+2]=255,E[le+3]=I[ee]}else if(_)for(let H=0;H<c.width;H++){let ee=V+H*m,le=W+H*m,de=I[ee+3],Ce=new sr(I[ee+0]/255*de,I[ee+1]/255*de,I[ee+2]/255*de,de).toRenderColor(_).toArray();E[le+0]=Ce[0],E[le+1]=Ce[1],E[le+2]=Ce[2],E[le+3]=Ce[3]}else for(let H=0;H<c.width*m;H++)E[W+H]=I[V+H]}return e}Ei(fg,"HeatmapBucket",{omit:["layers"]});class Eu{constructor(e,n){f_(this,e,1,n)}resize(e){by(this,new Eu(e),1)}clone(){return new Eu({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,n,l,c,m){gg(e,n,l,c,m,1,null)}}class ua{constructor(e,n){f_(this,e,4,n)}resize(e){by(this,new ua(e),4)}replace(e,n){n?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new ua({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,n,l,c,m,_,b){gg(e,n,l,c,m,4,_,b)}}class wy{constructor(e,n){this.width=e.width,this.height=e.height,this.data=n instanceof Uint8Array?new Float32Array(n.buffer):n}}function Cf(o){let e={},n=o.resolution||256,l=o.clips?o.clips.length:1,c=o.image||new ua({width:n,height:l}),m=(_,b,I)=>{e[o.evaluationKey]=I;let E=o.expression.evaluate(e);E&&(c.data[_+b+0]=Math.floor(255*E.r/E.a),c.data[_+b+1]=Math.floor(255*E.g/E.a),c.data[_+b+2]=Math.floor(255*E.b/E.a),c.data[_+b+3]=Math.floor(255*E.a))};if(o.clips)for(let _=0,b=0;_<l;++_,b+=4*n)for(let I=0,E=0;I<n;I++,E+=4){let L=I/(n-1),{start:F,end:V}=o.clips[_];m(b,E,F*(1-L)+V*L)}else for(let _=0,b=0;_<n;_++,b+=4)m(0,b,_/(n-1));return c}Ei(Eu,"AlphaImage"),Ei(ua,"RGBAImage");let yg=Kn([{name:"a_pos",components:2,type:"Int16"}],4),Qf=Kn([{name:"a_road_z_offset",components:1,type:"Float32"}],4),Ty=Kn([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),Sy=Kn([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function Ef(o,e,n=2){let l=e&&e.length,c=l?e[0]*n:o.length,m=xg(o,0,c,n,!0),_=[];if(!m||m.next===m.prev)return _;let b,I,E;if(l&&(m=function(L,F,V,W){let H=[];for(let ee=0,le=F.length;ee<le;ee++){let de=xg(L,F[ee]*W,ee<le-1?F[ee+1]*W:L.length,W,!1);de===de.next&&(de.steiner=!0),H.push(bg(de))}H.sort(ix);for(let ee=0;ee<H.length;ee++)V=nx(H[ee],V);return V}(o,e,m,n)),o.length>80*n){b=1/0,I=1/0;let L=-1/0,F=-1/0;for(let V=n;V<c;V+=n){let W=o[V],H=o[V+1];W<b&&(b=W),H<I&&(I=H),W>L&&(L=W),H>F&&(F=H)}E=Math.max(L-b,F-I),E=E!==0?32767/E:0}return em(m,_,n,b,I,E,0),_}function xg(o,e,n,l,c){let m;if(c===function(_,b,I,E){let L=0;for(let F=b,V=I-E;F<I;F+=E)L+=(_[V]-_[F])*(_[F+1]+_[V+1]),V=F;return L}(o,e,n,l)>0)for(let _=e;_<n;_+=l)m=m_(_/l|0,o[_],o[_+1],m);else for(let _=n-l;_>=e;_-=l)m=m_(_/l|0,o[_],o[_+1],m);return m&&Mf(m,m.next)&&(nm(m),m=m.next),m}function pd(o,e){if(!o)return o;e||(e=o);let n,l=o;do if(n=!1,l.steiner||!Mf(l,l.next)&&Gs(l.prev,l,l.next)!==0)l=l.next;else{if(nm(l),l=e=l.prev,l===l.next)break;n=!0}while(n||l!==e);return e}function em(o,e,n,l,c,m,_){if(!o)return;!_&&m&&function(I,E,L,F){let V=I;do V.z===0&&(V.z=vg(V.x,V.y,E,L,F)),V.prevZ=V.prev,V.nextZ=V.next,V=V.next;while(V!==I);V.prevZ.nextZ=null,V.prevZ=null,function(W){let H,ee=1;do{let le,de=W;W=null;let Ce=null;for(H=0;de;){H++;let we=de,ie=0;for(let Ie=0;Ie<ee&&(ie++,we=we.nextZ,we);Ie++);let me=ee;for(;ie>0||me>0&&we;)ie!==0&&(me===0||!we||de.z<=we.z)?(le=de,de=de.nextZ,ie--):(le=we,we=we.nextZ,me--),Ce?Ce.nextZ=le:W=le,le.prevZ=Ce,Ce=le;de=we}Ce.nextZ=null,ee*=2}while(H>1)}(V)}(o,l,c,m);let b=o;for(;o.prev!==o.next;){let I=o.prev,E=o.next;if(m?ex(o,l,c,m):Q0(o))e.push(I.i,o.i,E.i),nm(o),o=E.next,b=E.next;else if((o=E)===b){_?_===1?em(o=Iy(pd(o),e),e,n,l,c,m,2):_===2&&tx(o,e,n,l,c,m):em(pd(o),e,n,l,c,m,1);break}}}function Q0(o){let e=o.prev,n=o,l=o.next;if(Gs(e,n,l)>=0)return!1;let c=e.x,m=n.x,_=l.x,b=e.y,I=n.y,E=l.y,L=Math.min(c,m,_),F=Math.min(b,I,E),V=Math.max(c,m,_),W=Math.max(b,I,E),H=l.next;for(;H!==e;){if(H.x>=L&&H.x<=V&&H.y>=F&&H.y<=W&&tm(c,b,m,I,_,E,H.x,H.y)&&Gs(H.prev,H,H.next)>=0)return!1;H=H.next}return!0}function ex(o,e,n,l){let c=o.prev,m=o,_=o.next;if(Gs(c,m,_)>=0)return!1;let b=c.x,I=m.x,E=_.x,L=c.y,F=m.y,V=_.y,W=Math.min(b,I,E),H=Math.min(L,F,V),ee=Math.max(b,I,E),le=Math.max(L,F,V),de=vg(W,H,e,n,l),Ce=vg(ee,le,e,n,l),we=o.prevZ,ie=o.nextZ;for(;we&&we.z>=de&&ie&&ie.z<=Ce;){if(we.x>=W&&we.x<=ee&&we.y>=H&&we.y<=le&&we!==c&&we!==_&&tm(b,L,I,F,E,V,we.x,we.y)&&Gs(we.prev,we,we.next)>=0||(we=we.prevZ,ie.x>=W&&ie.x<=ee&&ie.y>=H&&ie.y<=le&&ie!==c&&ie!==_&&tm(b,L,I,F,E,V,ie.x,ie.y)&&Gs(ie.prev,ie,ie.next)>=0))return!1;ie=ie.nextZ}for(;we&&we.z>=de;){if(we.x>=W&&we.x<=ee&&we.y>=H&&we.y<=le&&we!==c&&we!==_&&tm(b,L,I,F,E,V,we.x,we.y)&&Gs(we.prev,we,we.next)>=0)return!1;we=we.prevZ}for(;ie&&ie.z<=Ce;){if(ie.x>=W&&ie.x<=ee&&ie.y>=H&&ie.y<=le&&ie!==c&&ie!==_&&tm(b,L,I,F,E,V,ie.x,ie.y)&&Gs(ie.prev,ie,ie.next)>=0)return!1;ie=ie.nextZ}return!0}function Iy(o,e){let n=o;do{let l=n.prev,c=n.next.next;!Mf(l,c)&&wg(l,n,n.next,c)&&yp(l,c)&&yp(c,l)&&(e.push(l.i,n.i,c.i),nm(n),nm(n.next),n=o=c),n=n.next}while(n!==o);return pd(n)}function tx(o,e,n,l,c,m){let _=o;do{let b=_.next.next;for(;b!==_.prev;){if(_.i!==b.i&&Cy(_,b)){let I=Tg(_,b);return _=pd(_,_.next),I=pd(I,I.next),em(_,e,n,l,c,m,0),void em(I,e,n,l,c,m,0)}b=b.next}_=_.next}while(_!==o)}function ix(o,e){let n=o.x-e.x;return n===0&&(n=o.y-e.y,n===0)&&(n=(o.next.y-o.y)/(o.next.x-o.x)-(e.next.y-e.y)/(e.next.x-e.x)),n}function nx(o,e){let n=function(c,m){let _=m,b=c.x,I=c.y,E,L=-1/0;if(Mf(c,_))return _;do{if(Mf(c,_.next))return _.next;if(I<=_.y&&I>=_.next.y&&_.next.y!==_.y){let ee=_.x+(I-_.y)*(_.next.x-_.x)/(_.next.y-_.y);if(ee<=b&&ee>L&&(L=ee,E=_.x<_.next.x?_:_.next,ee===b))return E}_=_.next}while(_!==m);if(!E)return null;let F=E,V=E.x,W=E.y,H=1/0;_=E;do{if(b>=_.x&&_.x>=V&&b!==_.x&&gp(I<W?b:L,I,V,W,I<W?L:b,I,_.x,_.y)){let ee=Math.abs(I-_.y)/(b-_.x);yp(_,c)&&(ee<H||ee===H&&(_.x>E.x||_.x===E.x&&rx(E,_)))&&(E=_,H=ee)}_=_.next}while(_!==F);return E}(o,e);if(!n)return e;let l=Tg(n,o);return pd(l,l.next),pd(n,n.next)}function rx(o,e){return Gs(o.prev,o,e.prev)<0&&Gs(e.next,o,o.next)<0}function vg(o,e,n,l,c){return(o=1431655765&((o=858993459&((o=252645135&((o=16711935&((o=(o-n)*c|0)|o<<8))|o<<4))|o<<2))|o<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-l)*c|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function bg(o){let e=o,n=o;do(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next;while(e!==o);return n}function gp(o,e,n,l,c,m,_,b){return(c-_)*(e-b)>=(o-_)*(m-b)&&(o-_)*(l-b)>=(n-_)*(e-b)&&(n-_)*(m-b)>=(c-_)*(l-b)}function tm(o,e,n,l,c,m,_,b){return!(o===_&&e===b)&&gp(o,e,n,l,c,m,_,b)}function Cy(o,e){return o.next.i!==e.i&&o.prev.i!==e.i&&!function(n,l){let c=n;do{if(c.i!==n.i&&c.next.i!==n.i&&c.i!==l.i&&c.next.i!==l.i&&wg(c,c.next,n,l))return!0;c=c.next}while(c!==n);return!1}(o,e)&&(yp(o,e)&&yp(e,o)&&function(n,l){let c=n,m=!1,_=(n.x+l.x)/2,b=(n.y+l.y)/2;do c.y>b!=c.next.y>b&&c.next.y!==c.y&&_<(c.next.x-c.x)*(b-c.y)/(c.next.y-c.y)+c.x&&(m=!m),c=c.next;while(c!==n);return m}(o,e)&&(Gs(o.prev,o,e.prev)||Gs(o,e.prev,e))||Mf(o,e)&&Gs(o.prev,o,o.next)>0&&Gs(e.prev,e,e.next)>0)}function Gs(o,e,n){return(e.y-o.y)*(n.x-e.x)-(e.x-o.x)*(n.y-e.y)}function Mf(o,e){return o.x===e.x&&o.y===e.y}function wg(o,e,n,l){let c=jm(Gs(o,e,n)),m=jm(Gs(o,e,l)),_=jm(Gs(n,l,o)),b=jm(Gs(n,l,e));return c!==m&&_!==b||!(c!==0||!im(o,n,e))||!(m!==0||!im(o,l,e))||!(_!==0||!im(n,o,l))||!(b!==0||!im(n,e,l))}function im(o,e,n){return e.x<=Math.max(o.x,n.x)&&e.x>=Math.min(o.x,n.x)&&e.y<=Math.max(o.y,n.y)&&e.y>=Math.min(o.y,n.y)}function jm(o){return o>0?1:o<0?-1:0}function yp(o,e){return Gs(o.prev,o,o.next)<0?Gs(o,e,o.next)>=0&&Gs(o,o.prev,e)>=0:Gs(o,e,o.prev)<0||Gs(o,o.next,e)<0}function Tg(o,e){let n=mc(o.i,o.x,o.y),l=mc(e.i,e.x,e.y),c=o.next,m=e.prev;return o.next=e,e.prev=o,n.next=c,c.prev=n,l.next=n,n.prev=l,m.next=l,l.prev=m,l}function m_(o,e,n,l){let c=mc(o,e,n);return l?(c.next=l.next,c.prev=l,l.next.prev=c,l.next=c):(c.prev=c,c.next=c),c}function nm(o){o.next.prev=o.prev,o.prev.next=o.next,o.prevZ&&(o.prevZ.nextZ=o.nextZ),o.nextZ&&(o.nextZ.prevZ=o.prevZ)}function mc(o,e,n){return{i:o,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function xp(o,e){let n=o.length;if(n<=1)return[o];let l=[],c,m;for(let _=0;_<n;_++){let b=Jn(o[_]);b!==0&&(o[_].area=Math.abs(b),m===void 0&&(m=b<0),m===b<0?(c&&l.push(c),c=[o[_]]):c.push(o[_]))}if(c&&l.push(c),e>1)for(let _=0;_<l.length;_++)l[_].length<=e||(Sc(l[_],e,1,l[_].length-1,Pf),l[_]=l[_].slice(0,e));return l}function Pf(o,e){return e.area-o.area}function Sg(o,e,n=1){if(!o)return null;let l=typeof o=="string"?Xa.from(o).getPrimary():o.getPrimary(),c=typeof o=="string"?null:o.getSecondary();for(let m of[l,c]){if(!m)continue;let _=m.id.toString();e.has(_)||e.set(_,[]),m.scaleSelf(n),e.get(_).push(m)}return{primary:l.toString(),secondary:c?c.toString():null}}function __(o,e,n,l){let c=l.patternDependencies,m=!1;for(let _ of e){let b=_.paint.get(`${o}-pattern`);b.isConstant()||(m=!0),Sg(b.constantOr(null),c,n)&&(m=!0)}return m}function g_(o,e,n,l,c,m){let _=m.patternDependencies;for(let b of e){let I=b.paint.get(`${o}-pattern`).value;if(I.kind!=="constant"){let E=I.evaluate({zoom:l},n,{},m.availableImages);E=E&&E.name?E.name:E;let L=Sg(E,_,c);if(!L)continue;let{primary:F,secondary:V}=L;F&&(n.patterns[b.id]=[F,V].filter(Boolean))}}return n}var y_,Ey,x_,vp,v_,Ig,Cg,Gm={};function My(){if(Ey)return y_;Ey=1;var o=wi();function e(c,m,_,b,I){this.properties={},this.extent=_,this.type=0,this._pbf=c,this._geometry=-1,this._keys=b,this._values=I,c.readFields(n,this,m)}function n(c,m,_){c==1?m.id=_.readVarint():c==2?function(b,I){for(var E=b.readVarint()+b.pos;b.pos<E;){var L=I._keys[b.readVarint()],F=I._values[b.readVarint()];I.properties[L]=F}}(_,m):c==3?m.type=_.readVarint():c==4&&(m._geometry=_.pos)}function l(c){for(var m,_,b=0,I=0,E=c.length,L=E-1;I<E;L=I++)b+=((_=c[L]).x-(m=c[I]).x)*(m.y+_.y);return b}return y_=e,e.types=["Unknown","Point","LineString","Polygon"],e.prototype.loadGeometry=function(){var c=this._pbf;c.pos=this._geometry;for(var m,_=c.readVarint()+c.pos,b=1,I=0,E=0,L=0,F=[];c.pos<_;){if(I<=0){var V=c.readVarint();b=7&V,I=V>>3}if(I--,b===1||b===2)E+=c.readSVarint(),L+=c.readSVarint(),b===1&&(m&&F.push(m),m=[]),m.push(new o(E,L));else{if(b!==7)throw new Error("unknown command "+b);m&&m.push(m[0].clone())}}return m&&F.push(m),F},e.prototype.bbox=function(){var c=this._pbf;c.pos=this._geometry;for(var m=c.readVarint()+c.pos,_=1,b=0,I=0,E=0,L=1/0,F=-1/0,V=1/0,W=-1/0;c.pos<m;){if(b<=0){var H=c.readVarint();_=7&H,b=H>>3}if(b--,_===1||_===2)(I+=c.readSVarint())<L&&(L=I),I>F&&(F=I),(E+=c.readSVarint())<V&&(V=E),E>W&&(W=E);else if(_!==7)throw new Error("unknown command "+_)}return[L,V,F,W]},e.prototype.toGeoJSON=function(c,m,_){var b,I,E=this.extent*Math.pow(2,_),L=this.extent*c,F=this.extent*m,V=this.loadGeometry(),W=e.types[this.type];function H(de){for(var Ce=0;Ce<de.length;Ce++){var we=de[Ce];de[Ce]=[360*(we.x+L)/E-180,360/Math.PI*Math.atan(Math.exp((180-360*(we.y+F)/E)*Math.PI/180))-90]}}switch(this.type){case 1:var ee=[];for(b=0;b<V.length;b++)ee[b]=V[b][0];H(V=ee);break;case 2:for(b=0;b<V.length;b++)H(V[b]);break;case 3:for(V=function(de){var Ce=de.length;if(Ce<=1)return[de];for(var we,ie,me=[],Ie=0;Ie<Ce;Ie++){var ze=l(de[Ie]);ze!==0&&(ie===void 0&&(ie=ze<0),ie===ze<0?(we&&me.push(we),we=[de[Ie]]):we.push(de[Ie]))}return we&&me.push(we),me}(V),b=0;b<V.length;b++)for(I=0;I<V[b].length;I++)H(V[b][I])}V.length===1?V=V[0]:W="Multi"+W;var le={type:"Feature",geometry:{type:W,coordinates:V},properties:this.properties};return"id"in this&&(le.id=this.id),le},y_}function Py(){if(vp)return x_;vp=1;var o=My();function e(l,c){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=l,this._keys=[],this._values=[],this._features=[],l.readFields(n,this,c),this.length=this._features.length}function n(l,c,m){l===15?c.version=m.readVarint():l===1?c.name=m.readString():l===5?c.extent=m.readVarint():l===2?c._features.push(m.pos):l===3?c._keys.push(m.readString()):l===4&&c._values.push(function(_){for(var b=null,I=_.readVarint()+_.pos;_.pos<I;){var E=_.readVarint()>>3;b=E===1?_.readString():E===2?_.readFloat():E===3?_.readDouble():E===4?_.readVarint64():E===5?_.readVarint():E===6?_.readSVarint():E===7?_.readBoolean():null}return b}(m))}return x_=e,e.prototype.feature=function(l){if(l<0||l>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[l];var c=this._pbf.readVarint()+this._pbf.pos;return new o(this._pbf,c,this.extent,this._keys,this._values)},x_}function Eg(){return Cg||(Cg=1,Gm.VectorTile=function(){if(Ig)return v_;Ig=1;var o=Py();function e(n,l,c){if(n===3){var m=new o(c,c.readVarint()+c.pos);m.length&&(l[m.name]=m)}}return v_=function(n,l){this.layers=n.readFields(e,{},l)},v_}(),Gm.VectorTileFeature=My(),Gm.VectorTileLayer=Py()),Gm}var bp=Eg();let fd="3d_elevation_id",Mg="level";class b_{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,n){return this._valid&&e(n(this._geometry)),this}require(e,n,l){return this.get(e,!0,n,l)}optional(e,n,l){return this.get(e,!1,n,l)}success(){return this._valid}get(e,n,l,c){let m=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&m!==void 0&&!Number.isNaN(m)?l(c?c(m):m):n&&(this._valid=!1),this}}class Zm{constructor(e,n){this.featureFunc=e,this.vertexFunc=n}parseFeature(e,n,l){return this.featureFunc(e,n,l)}parseVertex(e,n,l){return this.vertexFunc(e,n,l)}}let w_=new Zm((o,e,n)=>o.reset(e).require(fd,l=>{n.id=l}).optional("fixed_height_relative",l=>{n.constantHeight=l},Af.decodeRelativeHeight).geometry(l=>{n.bounds=l},Xr).success(),(o,e,n)=>o.reset(e).require(fd,l=>{n.id=l}).require("elevation_idx",l=>{n.idx=l}).require("extent",l=>{n.extent=l}).require("height_relative",l=>{n.height=l},Af.decodeRelativeHeight).geometry(l=>{n.position=l},Af.getPoint).success()),ox=new Zm((o,e,n)=>o.reset(e).require(fd,l=>{n.id=l}).optional("fixed_height",l=>{n.constantHeight=l},Af.decodeMetricHeight).geometry(l=>{n.bounds=l},Xr).success(),(o,e,n)=>o.reset(e).require(fd,l=>{n.id=l}).require("elevation_idx",l=>{n.idx=l}).require("extent",l=>{n.extent=l}).require("height",l=>{n.height=l},Af.decodeMetricHeight).geometry(l=>{n.position=l},Af.getPoint).success());class Af{static getPoint(e){return Vt(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static parse(e){let n=[],l=[],c=e.length,m=new b_;for(let b=0;b<c;b++){let I=e.feature(b),E=I.properties.hasOwnProperty("version")?String(I.properties.version):void 0,L=(_=E)?_==="1.0.1"?ox:void 0:w_;if(L===void 0){Hi(`Unknown elevation feature version number ${E||"(unknown)"}`);continue}let F=I.properties.hasOwnProperty("type")?I.properties.type:void 0;if(F){if(bp.VectorTileFeature.types[I.type]==="Point"&&F==="curve_point"){let V={};L.parseVertex(m,I,V)&&n.push(V)}else if(bp.VectorTileFeature.types[I.type]==="Polygon"&&F==="curve_meta"){let V={};L.parseFeature(m,I,V)&&l.push(V)}}}var _;return{vertices:n,features:l}}}class Ay{constructor(e,n){this.feature=e,this.metersToTile=n,this.index=0}get(){let e=this.feature.vertices[this.index],n=this.feature.vertexProps[this.index].dir,l=n[1],c=-n[0],m=(e.extent+1)*this.metersToTile;return[new Ue(Math.trunc(e.position[0]+l*m),Math.trunc(e.position[1]+c*m)),new Ue(Math.trunc(e.position[0]-l*m),Math.trunc(e.position[1]-c*m))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class Qp{constructor(e,n,l,c,m,_){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=e,this.heightRange={min:l,max:l},this.safeArea=n,this.constantHeight=l,this.constantHeight==null&&(this.constantHeight!=null||c.length!==0)){this.vertices=c,this.edges=m,this.edges=this.edges.filter(b=>{return b.a<this.vertices.length&&b.b<this.vertices.length&&!((I=this.vertices[b.a].position)[0]===(E=this.vertices[b.b].position)[0]&&I[1]===E[1]);var I,E}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(let b of this.vertices)this.vertexProps.push({dir:Vt(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,b.height),this.heightRange.max=Math.max(this.heightRange.max,b.height);for(let b of this.edges){let I=this.vertices[b.a].position,E=this.vertices[b.b].position,L=Fe(ms(),E,I),F=mt(L),V=He(ms(),L,1/F);this.edgeProps.push({vec:L,dir:V,len:F});let W=this.vertexProps[b.a].dir,H=this.vertexProps[b.b].dir;Le(W,W,V),Le(H,H,V)}for(let b of this.vertexProps)b.dir[0]===0&&b.dir[1]===0||St(b.dir,b.dir);this.tessellate(_)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;let n=this.getClosestEdge(e);if(n==null)return 0;let[l,c]=n;return((m,_,b)=>(1-b)*m+b*_)(this.vertices[this.edges[l].a].height,this.vertices[this.edges[l].b].height,c)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let n=0,l=Number.POSITIVE_INFINITY,c=0,m=Vt(e.x,e.y);for(let _=0;_<this.edges.length;_++){let b=this.edges[_],I=this.edgeProps[_].dir,E=new Xh(m,this.edgeProps[_].dir),L=this.vertices[b.a].position,F=this.vertices[b.b].position,V=ms(),W=ms(),H=E.intersectsPlane(L,this.vertexProps[b.a].dir,V),ee=E.intersectsPlane(F,this.vertexProps[b.b].dir,W);if(!H||!ee)continue;let le=Fe(ms(),W,V),de=Fe(ms(),m,V),Ce=Tt(le,le),we=Ce>0?Tt(de,le)/Ce:0,ie=rt(we,0,1),me=Math.abs((we-ie)*this.edgeProps[_].len),Ie=Fe(ms(),m,L),ze=me+Math.abs(Tt(Ie,Vt(I[1],-I[0])));ze<l&&(n=_,l=ze,c=ie)}return[n,c]}tessellate(e){for(let n=this.edges.length-1;n>=0;--n){let l=this.edges[n].a,c=this.edges[n].b,{position:m,height:_,extent:b}=this.vertices[l],{position:I,height:E,extent:L}=this.vertices[c],F=this.vertexProps[l].dir,V=this.vertexProps[c].dir,W=Ur(m[0]/e,m[1]/e,_),H=Ur(I[0]/e,I[1]/e,E),ee=Ur(F[1],-F[0],0);Mr(ee,ee,b);let le=Ur(V[1],-V[0],0);if(Mr(le,le,L),this.distSqLines(Ur(W[0]+.5*ee[0],W[1]+.5*ee[1],W[2]+.5*ee[2]),Ur(H[0]-.5*le[0],H[1]-.5*le[1],H[2]-.5*le[2]),Ur(W[0]-.5*ee[0],W[1]-.5*ee[1],W[2]-.5*ee[2]),Ur(H[0]+.5*le[0],H[1]+.5*le[1],H[2]+.5*le[2]))<=.0025000000000000005)continue;let de=this.vertices.length,Ce=Le(ms(),m,I);this.vertices.push({position:He(Ce,Ce,.5),height:.5*(_+E),extent:.5*(b+L)});let we=Le(ms(),F,V);this.vertexProps.push({dir:St(we,we)}),this.edges.splice(n,1),this.edgeProps.splice(n,1),this.edges.push({a:l,b:de}),this.edges.push({a:de,b:c});let ie=Fe(ms(),this.vertices[de].position,m),me=mt(ie),Ie={vec:ie,dir:He(ms(),ie,1/me),len:me};this.edgeProps.push(Ie),this.edgeProps.push(Ie)}}distSqLines(e,n,l,c){let m=ss(Io(),n,e),_=ss(Io(),c,l),b=ss(Io(),e,l),I=jr(m,m),E=jr(m,_),L=jr(m,b),F=jr(_,_),V=jr(_,b),W=I*F-E*E;if(W===0){let le=jr(b,_)/jr(_,_);return Hr($c(Io(),l,c,le),e)}let H=(E*V-L*F)/W,ee=(I*V-E*L)/W;return Hr($c(Io(),e,n,H),$c(Io(),l,c,ee))}}class Na{static parseFrom(e,n){let l=Af.parse(e);if(!l)return[];let{vertices:c,features:m}=l,_=1/vt(n);m.sort((L,F)=>L.id-F.id),c.sort((L,F)=>L.id-F.id||L.idx-F.idx),c=c.filter((L,F,V)=>F===V.findIndex(W=>W.id===L.id&&W.idx===L.idx));let b=new Array,I=0,E=c.length;for(let L of m){if(L.constantHeight){b.push(new Qp(L.id,L.bounds,L.constantHeight));continue}for(;I!==E&&c[I].id<L.id;)I++;if(I===E||c[I].id!==L.id)continue;let F=new Array,V=new Array,W=I;for(;I!==E&&c[I].id===L.id;){let H=c[I];if(F.push({position:H.position,height:H.height,extent:H.extent}),I!==W&&c[I-1].idx===H.idx-1){let ee=I-W;V.push({a:ee-1,b:ee})}I++}b.push(new Qp(L.id,L.bounds,void 0,F,V,_))}return b}static getElevationFeature(e,n){if(!n)return;let l=+e.properties[fd];return Number.isNaN(l)?void 0:n.find(c=>c.id===l)}}class T_{constructor(e,n){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(n)||(this.zScale=Math.pow(2,n.z-e.z),this.xOffset=(e.x*this.zScale-n.x)*xi,this.yOffset=(e.y*this.zScale-n.y)*xi)}constantElevation(e,n){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,n)}pointElevation(e,n,l){let c=this.constantElevation(n,l);return c??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(n.pointElevation(e),l))}computeBiasedHeight(e,n){return n<=0?e:e+n*ct(0,n,e>=0?e:Math.abs(.5*e))}}Ei(Qp,"ElevationFeature");class Pg{constructor(){this.polygons=new Map}add(e,...n){this.polygons.has(e)?this.polygons.get(e).push(...n):this.polygons.set(e,n)}merge(e){for(let[n,l]of e.polygons)this.add(n,...l)}}class ef{constructor(){this.portals=[]}static evaluate(e){if(e.length===0)return new ef;let n=[];for(let E of e)n.push(...E.portals);if(n.length===0)return new ef;let l=(E,L)=>E<=0&&L<=0||E>=xi&&L>=xi;for(let E of n){let L=E.va,F=E.vb;(l(L.x,F.x)||l(L.y,F.y))&&(E.type="border")}let c=n.filter(E=>E.type!=="unevaluated"),m=n.filter(E=>E.type==="unevaluated");if(m.length===0)return new ef;m.sort((E,L)=>E.hash===L.hash?E.isTunnel===L.isTunnel?0:E.isTunnel?-1:1:E.hash<L.hash?1:-1),n=c.concat(m);let _=c.length,b=_,I=_;do if(b++,b===n.length||n[_].hash!==n[b].hash){if(b-_==2){I<_&&(n[I]=n[_],n[_]=null);let E=n[I],L=n[b-1];E.type=E.isTunnel!==L.isTunnel?"tunnel":"polygon",E.connection={a:E.connection.a,b:L.connection.a},I++}_=b}while(_!==n.length);return n.splice(I),n.sort((E,L)=>E.hash<L.hash?1:-1),{portals:n}}}Ei(ef,"ElevationPortalGraph"),Ei(Pg,"ElevationPolygons");class Ag{constructor(e,n,l){this.outPositions=e,this.outNormals=n,this.outIndices=l,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(e,n,l){let c=e[2];l!=null&&(c*=l);let m=this.getVec3Bits(e)<<96n|this.getVec3Bits(n),_=this.vertexLookup.get(m);if(_!=null)return _;let b=this.outPositions.length;this.vertexLookup.set(m,b);let I=Math.trunc(16384*n[0]),E=Math.trunc(16384*n[1]),L=Math.trunc(16384*n[2]);return this.outPositions.emplaceBack(e[0],e[1],c),this.outNormals.emplaceBack(I,E,L),b}addVertices(e,n,...l){let c=[];for(let m of l){let _=this.addVertex(m,e,n);c.push(_)}return c}addTriangles(e,n,l){if(n&&l){let c=l.length===1,m=Ur(0,0,0);for(let _=0;_<e.length;_+=3){let b=n[e[_+0]],I=n[e[_+1]],E=n[e[_+2]],L=c?l[0]:l[e[_+1]],F=c?l[0]:l[e[_+2]],V=this.addVertex(Ur(b.x,b.y,c?l[0]:l[e[_+0]]),m),W=this.addVertex(Ur(I.x,I.y,L),m),H=this.addVertex(Ur(E.x,E.y,F),m);this.outIndices.emplaceBack(V,W,H)}}else for(let c=0;c<e.length;c+=3)this.outIndices.emplaceBack(e[c+0],e[c+1],e[c+2])}addQuad(e,n){let l=this.addVertices(n,void 0,...e.map(I=>Ur(I.coord.x,I.coord.y,I.height))),[c,m,_,b]=l;this.addTriangles([c,m,_,_,b,c])}getBits(e){return this.view.setFloat32(0,e),BigInt(this.view.getUint32(0))}getVec3Bits(e){return this.getBits(e[0])<<64n|this.getBits(e[1])<<32n|this.getBits(e[2])}}class kc{constructor(e){this.unevaluatedPortals=new ef,this.portalPolygons=new Pg,this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new Ca,this.vertexNormals=new Fa,this.indexArray=new zo,this.tileToMeters=vt(e)}addVertices(e,n){let l=this.unevalVertices.length;for(let c=0;c<e.length;c++)this.unevalVertices.push(e[c]),this.unevalHeights.push(n[c]);return l}addTriangles(e,n,l){let c=l?this.unevalTunnelTriangles:this.unevalTriangles;for(let m of e)c.push(m+n)}addRenderableRing(e,n,l,c,m){let _=[new Ue(m.min.x,m.min.y),new Ue(m.max.x,m.min.y),new Ue(m.max.x,m.max.y),new Ue(m.min.x,m.max.y)];for(let b=0;b<l-1;b++){let I=n+b,E=I+1,L=this.unevalVertices[I],F=this.unevalVertices[E];if(!(L.x>=m.min.x&&L.x<=m.max.x&&L.y>=m.min.y&&L.y<=m.max.y||F.x>=m.min.x&&F.x<=m.max.x&&F.y>=m.min.y&&F.y<=m.max.y||Lo(L,F,_))||this.isOnBorder(L.x,F.x)||this.isOnBorder(L.y,F.y))continue;let V=kc.computeEdgeHash(this.unevalVertices[I],this.unevalVertices[E]),W,H=this.vertexHashLookup.get(kc.computePosHash(L));H!=null?W=H.next:(H=this.vertexHashLookup.get(kc.computePosHash(F)),W=H!=null?H.prev:V),this.unevalEdges.push({polygonIdx:e,a:I,b:E,hash:V,portalHash:W,isTunnel:c,type:"unevaluated"})}}addPortalCandidates(e,n,l,c,m){if(n.length===0)return;this.portalPolygons.add(e,{geometry:n,zLevel:m});let _=n[0];this.vertexHashLookup.clear();let b=kc.computeEdgeHash(_[_.length-2],_[_.length-1]);for(let I=0;I<_.length-1;I++){let E=_[I+0],L=_[I+1],F=Vt(L.x-E.x,L.y-E.y),V=mt(F);if(V===0)continue;let W="unevaluated",H=c.pointElevation(E),ee=c.pointElevation(L);Math.abs(H)<.01&&Math.abs(ee)<.01?W="entrance":(this.isOnBorder(E.x,L.x)||this.isOnBorder(E.y,L.y))&&(W="border");let le=kc.computeEdgeHash(E,L);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:E,vb:L,vab:F,length:V,hash:le,isTunnel:l,type:W});let de=kc.computePosHash(E);this.vertexHashLookup.set(de,{prev:b,next:le}),b=le}}construct(e){if(this.unevalVertices.length===0)return;let n=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),l=F=>{F.primitiveLength=this.indexArray.length-F.primitiveOffset},c=new Ag(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);let m=n(),_=n(),b=n(),I=(F,V)=>{F.sort((H,ee)=>H.type===V&&ee.type!==V?-1:H.type!==V&&ee.type===V?1:0);let W=F.findIndex(H=>H.type!==V);return W>=0?W:F.length},E=0;this.unevalEdges.length>0&&(E=I(this.unevalEdges,"none"),this.constructBridgeStructures(c,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:E},this.tileToMeters));let L=n();if(this.unevalEdges.length>0){let F=this.unevalEdges.splice(E),V=I(F,"tunnel")+E;this.unevalEdges.push(...F),this.constructTunnelStructures(c,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:E},{min:E,max:V})}l(b),c.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),l(L),c.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),l(_),c.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),l(m),this.maskSegments=bo.simpleSegment(0,L.primitiveOffset,0,L.primitiveLength),this.depthSegments=bo.simpleSegment(0,_.primitiveOffset,0,_.primitiveLength),this.renderableSegments=bo.simpleSegment(0,b.primitiveOffset,0,b.primitiveLength),this.shadowCasterSegments=bo.simpleSegment(0,m.primitiveOffset,0,m.primitiveLength)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,Ty.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,Sy.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableSegments.destroy(),this.shadowCasterSegments.destroy())}computeVertexConnections(e,n,l,c,m){let _=new Map;for(let b=c;b<m;b++){let I=l[b],E=I.a,L=I.b,F=kc.computePosHash(e[E]),V=kc.computePosHash(e[L]);_.has(F)||_.set(F,{}),_.has(V)||_.set(V,{});let W=_.get(F),H=_.get(V);n[E]<=0&&n[L]<=0||(W.to=L,H.from=E)}return _}constructBridgeStructures(e,n,l,c,m,_){let b=this.computeVertexConnections(n,l,c,m.min,m.max),I=1/_,E=.5*I,L=V=>Ur(n[V].x,n[V].y,l[V]*I),F=V=>{let W=b.get(kc.computePosHash(n[V])),H=W.from,ee=W.to;if(!H||!ee)return;let le=L(H),de=L(V),Ce=L(ee),we=Ur(0,0,0);if(!va(le,de)){let me=hr(Io(),de,le);ho(we,we,Lr(me,me))}if(!va(Ce,de)){let me=hr(Io(),Ce,de);ho(we,we,Lr(me,me))}let ie=ra(we);return ie>0?Mr(we,we,1/ie):void 0};for(let V=m.min;V<m.max;V++){let W=c[V],H=this.prepareEdgePoints(n,l,W,(ui,bn)=>ui>bn);if(H==null)continue;let ee=H[0],le=H[1],de=Ur(ee.coord.x,ee.coord.y,I*ee.height),Ce=Ur(le.coord.x,le.coord.y,I*le.height);if(va(de,Ce))continue;let we=hr(Io(),Ce,de);Lr(we,we);let ie=ui=>Lr(ui,ui),me=F(W.a)||we,Ie=F(W.b)||we,ze=ie(Ur(me[1],-me[0],0)),Je=ie(Ur(Ie[1],-Ie[0],0)),st=ie(Co(Io(),ze,me)),ut=ie(Co(Io(),Je,Ie)),xt=Io(),Ft=[ho(Io(),de,Mr(xt,hr(xt,ze,st),E)),ho(Io(),de,Mr(xt,ho(xt,ze,st),E)),ho(Io(),de,Mr(xt,st,E)),de],ri=[ho(Io(),Ce,Mr(xt,hr(xt,Je,ut),E)),ho(Io(),Ce,Mr(xt,ho(xt,Je,ut),E)),ho(Io(),Ce,Mr(xt,ut,E)),Ce],[$t,Qt]=e.addVertices(ze,_,Ft[0],Ft[1]),[hi,Rt]=e.addVertices(Je,_,ri[0],ri[1]);e.addTriangles([$t,Qt,hi,Qt,Rt,hi]);let[Yt,Et]=e.addVertices(st,_,Ft[1],Ft[2]),[kt,pi]=e.addVertices(ut,_,ri[1],ri[2]);e.addTriangles([Yt,Et,kt,Et,pi,kt]);let[mi,qi]=e.addVertices(xa(ze,ze),_,Ft[2],Ft[3]),[Bi,Ti]=e.addVertices(xa(Je,Je),_,ri[2],ri[3]);e.addTriangles([mi,qi,Bi,qi,Ti,Bi])}}constructTunnelStructures(e,n,l,c,m,_){let b=I=>Lr(I,I);for(let I=m.min;I<m.max;I++){let E=this.prepareEdgePoints(n,l,c[I],(W,H)=>W<H);if(E==null)continue;let[L,F]=E,V=b(Ur(F.coord.y-L.coord.y,-(F.coord.x-L.coord.x),0));e.addQuad([L,F,{coord:F.coord,height:c[I].isTunnel?-.1:0},{coord:L.coord,height:c[I].isTunnel?-.1:0}],V)}for(let I=_.min;I<_.max;I++){let E=c[I],L=n[E.a],F=n[E.b],V=b(Ur(F.y-L.y,-(F.x-L.x),0));e.addQuad([{coord:F,height:0},{coord:L,height:0},{coord:L,height:l[E.a]+4},{coord:F,height:l[E.b]+4}],V),e.addQuad([{coord:L,height:0},{coord:F,height:0},{coord:F,height:l[E.b]+4},{coord:L,height:l[E.a]+4}],V)}}prepareEdgePoints(e,n,l,c){let m=n[l.a],_=n[l.b],b=c(m,0),I=c(_,0);if(b&&I)return[{coord:e[l.a],height:m},{coord:e[l.b],height:_}];if(!b&&!I)return;let E=e[l.a].clone(),L=e[l.b].clone();if(b){if(!I){let F=_/(_-m);L.x=en(L.x,E.x,F),L.y=en(L.y,E.y,F),_=en(_,m,F)}}else{let F=m/(m-_);E.x=en(E.x,L.x,F),E.y=en(E.y,L.y,F),m=en(m,_,F)}return[{coord:E,height:m},{coord:L,height:_}]}prepareEdges(e,n){if(n.length===0)return;n.sort((b,I)=>b.hash===I.hash?I.polygonIdx-b.polygonIdx:I.hash>b.hash?1:-1);let l=0,c=0,m=0,_=n[l].polygonIdx;do c++,(c===n.length||n[l].hash!==n[c].hash)&&((c-l==1||n[c-1].polygonIdx!==_)&&(m<l&&(n[m]=n[l],n[l]=null),n[m].type="none",m++),l=c,l!==n.length&&(_=n[l].polygonIdx));while(l!==n.length);if(n.splice(m),n.length!==0&&e.length!==0){n.sort((E,L)=>E.portalHash<L.portalHash?1:-1);let b=0,I=0;for(;b!==n.length&&I!==e.length;){let E=n[b],L=e[I];E.portalHash>L.hash?b++:L.hash>E.portalHash?I++:(E.type=L.type,b++)}}}isOnBorder(e,n){return e<=0&&n<=0||e>=xi&&n>=xi}static computeEdgeHash(e,n){return(e.y===n.y&&e.x>n.x||e.y>n.y)&&([e,n]=[n,e]),BigInt(kc.computePosHash(e))<<32n|BigInt(kc.computePosHash(n))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var Dg,Rg={exports:{}},Dy=(Dg||(Dg=1,function(o,e){(function(n){function l(Me,ke){return Me>ke?1:Me<ke?-1:0}var c=function(Me,ke){Me===void 0&&(Me=l),ke===void 0&&(ke=!1),this._compare=Me,this._root=null,this._size=0,this._noDuplicates=!!ke},m={size:{configurable:!0}};function _(Me,ke,Nt,vi,Ci){var Si=Ci-vi;if(Si>0){var Gi=vi+Math.floor(Si/2),un={key:ke[Gi],data:Nt[Gi],parent:Me};return un.left=_(un,ke,Nt,vi,Gi),un.right=_(un,ke,Nt,Gi+1,Ci),un}return null}function b(Me,ke,Nt,vi,Ci){if(!(Nt>=vi)){for(var Si=Me[Nt+vi>>1],Gi=Nt-1,un=vi+1;;){do Gi++;while(Ci(Me[Gi],Si)<0);do un--;while(Ci(Me[un],Si)>0);if(Gi>=un)break;var ir=Me[Gi];Me[Gi]=Me[un],Me[un]=ir,ir=ke[Gi],ke[Gi]=ke[un],ke[un]=ir}b(Me,ke,Nt,un,Ci),b(Me,ke,un+1,vi,Ci)}}c.prototype.rotateLeft=function(Me){var ke=Me.right;ke&&(Me.right=ke.left,ke.left&&(ke.left.parent=Me),ke.parent=Me.parent),Me.parent?Me===Me.parent.left?Me.parent.left=ke:Me.parent.right=ke:this._root=ke,ke&&(ke.left=Me),Me.parent=ke},c.prototype.rotateRight=function(Me){var ke=Me.left;ke&&(Me.left=ke.right,ke.right&&(ke.right.parent=Me),ke.parent=Me.parent),Me.parent?Me===Me.parent.left?Me.parent.left=ke:Me.parent.right=ke:this._root=ke,ke&&(ke.right=Me),Me.parent=ke},c.prototype._splay=function(Me){for(;Me.parent;){var ke=Me.parent;ke.parent?ke.left===Me&&ke.parent.left===ke?(this.rotateRight(ke.parent),this.rotateRight(ke)):ke.right===Me&&ke.parent.right===ke?(this.rotateLeft(ke.parent),this.rotateLeft(ke)):ke.left===Me&&ke.parent.right===ke?(this.rotateRight(ke),this.rotateLeft(ke)):(this.rotateLeft(ke),this.rotateRight(ke)):ke.left===Me?this.rotateRight(ke):this.rotateLeft(ke)}},c.prototype.splay=function(Me){for(var ke,Nt,vi,Ci,Si;Me.parent;)(Nt=(ke=Me.parent).parent)&&Nt.parent?((vi=Nt.parent).left===Nt?vi.left=Me:vi.right=Me,Me.parent=vi):(Me.parent=null,this._root=Me),Ci=Me.left,Si=Me.right,Me===ke.left?(Nt&&(Nt.left===ke?(ke.right?(Nt.left=ke.right,Nt.left.parent=Nt):Nt.left=null,ke.right=Nt,Nt.parent=ke):(Ci?(Nt.right=Ci,Ci.parent=Nt):Nt.right=null,Me.left=Nt,Nt.parent=Me)),Si?(ke.left=Si,Si.parent=ke):ke.left=null,Me.right=ke,ke.parent=Me):(Nt&&(Nt.right===ke?(ke.left?(Nt.right=ke.left,Nt.right.parent=Nt):Nt.right=null,ke.left=Nt,Nt.parent=ke):(Si?(Nt.left=Si,Si.parent=Nt):Nt.left=null,Me.right=Nt,Nt.parent=Me)),Ci?(ke.right=Ci,Ci.parent=ke):ke.right=null,Me.left=ke,ke.parent=Me)},c.prototype.replace=function(Me,ke){Me.parent?Me===Me.parent.left?Me.parent.left=ke:Me.parent.right=ke:this._root=ke,ke&&(ke.parent=Me.parent)},c.prototype.minNode=function(Me){if(Me===void 0&&(Me=this._root),Me)for(;Me.left;)Me=Me.left;return Me},c.prototype.maxNode=function(Me){if(Me===void 0&&(Me=this._root),Me)for(;Me.right;)Me=Me.right;return Me},c.prototype.insert=function(Me,ke){var Nt=this._root,vi=null,Ci=this._compare;if(this._noDuplicates)for(;Nt;){if(vi=Nt,Ci(Nt.key,Me)===0)return;Nt=Ci(Nt.key,Me)<0?Nt.right:Nt.left}else for(;Nt;)vi=Nt,Nt=Ci(Nt.key,Me)<0?Nt.right:Nt.left;return Nt={key:Me,data:ke,left:null,right:null,parent:vi},vi?Ci(vi.key,Nt.key)<0?vi.right=Nt:vi.left=Nt:this._root=Nt,this.splay(Nt),this._size++,Nt},c.prototype.find=function(Me){for(var ke=this._root,Nt=this._compare;ke;){var vi=Nt(ke.key,Me);if(vi<0)ke=ke.right;else{if(!(vi>0))return ke;ke=ke.left}}return null},c.prototype.contains=function(Me){for(var ke=this._root,Nt=this._compare;ke;){var vi=Nt(Me,ke.key);if(vi===0)return!0;ke=vi<0?ke.left:ke.right}return!1},c.prototype.remove=function(Me){var ke=this.find(Me);if(!ke)return!1;if(this.splay(ke),ke.left)if(ke.right){var Nt=this.minNode(ke.right);Nt.parent!==ke&&(this.replace(Nt,Nt.right),Nt.right=ke.right,Nt.right.parent=Nt),this.replace(ke,Nt),Nt.left=ke.left,Nt.left.parent=Nt}else this.replace(ke,ke.left);else this.replace(ke,ke.right);return this._size--,!0},c.prototype.removeNode=function(Me){if(!Me)return!1;if(this.splay(Me),Me.left)if(Me.right){var ke=this.minNode(Me.right);ke.parent!==Me&&(this.replace(ke,ke.right),ke.right=Me.right,ke.right.parent=ke),this.replace(Me,ke),ke.left=Me.left,ke.left.parent=ke}else this.replace(Me,Me.left);else this.replace(Me,Me.right);return this._size--,!0},c.prototype.erase=function(Me){var ke=this.find(Me);if(ke){this.splay(ke);var Nt=ke.left,vi=ke.right,Ci=null;Nt&&(Nt.parent=null,Ci=this.maxNode(Nt),this.splay(Ci),this._root=Ci),vi&&(Nt?Ci.right=vi:this._root=vi,vi.parent=Ci),this._size--}},c.prototype.pop=function(){var Me=this._root,ke=null;if(Me){for(;Me.left;)Me=Me.left;ke={key:Me.key,data:Me.data},this.remove(Me.key)}return ke},c.prototype.next=function(Me){var ke=Me;if(ke)if(ke.right)for(ke=ke.right;ke&&ke.left;)ke=ke.left;else for(ke=Me.parent;ke&&ke.right===Me;)Me=ke,ke=ke.parent;return ke},c.prototype.prev=function(Me){var ke=Me;if(ke)if(ke.left)for(ke=ke.left;ke&&ke.right;)ke=ke.right;else for(ke=Me.parent;ke&&ke.left===Me;)Me=ke,ke=ke.parent;return ke},c.prototype.forEach=function(Me){for(var ke=this._root,Nt=[],vi=!1,Ci=0;!vi;)ke?(Nt.push(ke),ke=ke.left):Nt.length>0?(Me(ke=Nt.pop(),Ci++),ke=ke.right):vi=!0;return this},c.prototype.range=function(Me,ke,Nt,vi){for(var Ci=[],Si=this._compare,Gi=this._root;Ci.length!==0||Gi;)if(Gi)Ci.push(Gi),Gi=Gi.left;else{if(Si((Gi=Ci.pop()).key,ke)>0)break;if(Si(Gi.key,Me)>=0&&Nt.call(vi,Gi))return this;Gi=Gi.right}return this},c.prototype.keys=function(){for(var Me=this._root,ke=[],Nt=[],vi=!1;!vi;)Me?(ke.push(Me),Me=Me.left):ke.length>0?(Me=ke.pop(),Nt.push(Me.key),Me=Me.right):vi=!0;return Nt},c.prototype.values=function(){for(var Me=this._root,ke=[],Nt=[],vi=!1;!vi;)Me?(ke.push(Me),Me=Me.left):ke.length>0?(Me=ke.pop(),Nt.push(Me.data),Me=Me.right):vi=!0;return Nt},c.prototype.at=function(Me){for(var ke=this._root,Nt=[],vi=!1,Ci=0;!vi;)if(ke)Nt.push(ke),ke=ke.left;else if(Nt.length>0){if(ke=Nt.pop(),Ci===Me)return ke;Ci++,ke=ke.right}else vi=!0;return null},c.prototype.load=function(Me,ke,Nt){if(Me===void 0&&(Me=[]),ke===void 0&&(ke=[]),Nt===void 0&&(Nt=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var vi=Me.length;return Nt&&b(Me,ke,0,vi-1,this._compare),this._root=_(null,Me,ke,0,vi),this._size=vi,this},c.prototype.min=function(){var Me=this.minNode(this._root);return Me?Me.key:null},c.prototype.max=function(){var Me=this.maxNode(this._root);return Me?Me.key:null},c.prototype.isEmpty=function(){return this._root===null},m.size.get=function(){return this._size},c.createTree=function(Me,ke,Nt,vi,Ci){return new c(Nt,Ci).load(Me,ke,vi)},Object.defineProperties(c.prototype,m);var I=0,E=1,L=2,F=3,V=0,W=1,H=2,ee=3;function le(Me,ke,Nt){ke===null?(Me.inOut=!1,Me.otherInOut=!0):(Me.isSubject===ke.isSubject?(Me.inOut=!ke.inOut,Me.otherInOut=ke.otherInOut):(Me.inOut=!ke.otherInOut,Me.otherInOut=ke.isVertical()?!ke.inOut:ke.inOut),ke&&(Me.prevInResult=!de(ke,Nt)||ke.isVertical()?ke.prevInResult:ke));var vi=de(Me,Nt);Me.resultTransition=vi?function(Ci,Si){var Gi,un=!Ci.inOut,ir=!Ci.otherInOut;switch(Si){case V:Gi=un&&ir;break;case W:Gi=un||ir;break;case ee:Gi=un^ir;break;case H:Gi=Ci.isSubject?un&&!ir:ir&&!un}return Gi?1:-1}(Me,Nt):0}function de(Me,ke){switch(Me.type){case I:switch(ke){case V:return!Me.otherInOut;case W:return Me.otherInOut;case H:return Me.isSubject&&Me.otherInOut||!Me.isSubject&&!Me.otherInOut;case ee:return!0}break;case L:return ke===V||ke===W;case F:return ke===H;case E:return!1}return!1}var Ce=function(Me,ke,Nt,vi,Ci){this.left=ke,this.point=Me,this.otherEvent=Nt,this.isSubject=vi,this.type=Ci||I,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},we={inResult:{configurable:!0}};function ie(Me,ke){return Me[0]===ke[0]&&Me[1]===ke[1]}Ce.prototype.isBelow=function(Me){var ke=this.point,Nt=this.otherEvent.point;return this.left?(ke[0]-Me[0])*(Nt[1]-Me[1])-(Nt[0]-Me[0])*(ke[1]-Me[1])>0:(Nt[0]-Me[0])*(ke[1]-Me[1])-(ke[0]-Me[0])*(Nt[1]-Me[1])>0},Ce.prototype.isAbove=function(Me){return!this.isBelow(Me)},Ce.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},we.inResult.get=function(){return this.resultTransition!==0},Ce.prototype.clone=function(){var Me=new Ce(this.point,this.left,this.otherEvent,this.isSubject,this.type);return Me.contourId=this.contourId,Me.resultTransition=this.resultTransition,Me.prevInResult=this.prevInResult,Me.isExteriorRing=this.isExteriorRing,Me.inOut=this.inOut,Me.otherInOut=this.otherInOut,Me},Object.defineProperties(Ce.prototype,we);var me=11102230246251565e-32,Ie=134217729,ze=(3+8*me)*me;function Je(Me,ke,Nt,vi,Ci){var Si,Gi,un,ir,nr=ke[0],Ln=vi[0],Nr=0,Qr=0;Ln>nr==Ln>-nr?(Si=nr,nr=ke[++Nr]):(Si=Ln,Ln=vi[++Qr]);var rr=0;if(Nr<Me&&Qr<Nt)for(Ln>nr==Ln>-nr?(un=Si-((Gi=nr+Si)-nr),nr=ke[++Nr]):(un=Si-((Gi=Ln+Si)-Ln),Ln=vi[++Qr]),Si=Gi,un!==0&&(Ci[rr++]=un);Nr<Me&&Qr<Nt;)Ln>nr==Ln>-nr?(un=Si-((Gi=Si+nr)-(ir=Gi-Si))+(nr-ir),nr=ke[++Nr]):(un=Si-((Gi=Si+Ln)-(ir=Gi-Si))+(Ln-ir),Ln=vi[++Qr]),Si=Gi,un!==0&&(Ci[rr++]=un);for(;Nr<Me;)un=Si-((Gi=Si+nr)-(ir=Gi-Si))+(nr-ir),nr=ke[++Nr],Si=Gi,un!==0&&(Ci[rr++]=un);for(;Qr<Nt;)un=Si-((Gi=Si+Ln)-(ir=Gi-Si))+(Ln-ir),Ln=vi[++Qr],Si=Gi,un!==0&&(Ci[rr++]=un);return Si===0&&rr!==0||(Ci[rr++]=Si),rr}function st(Me){return new Float64Array(Me)}var ut=33306690738754716e-32,xt=22204460492503146e-32,Ft=11093356479670487e-47,ri=st(4),$t=st(8),Qt=st(12),hi=st(16),Rt=st(4);function Yt(Me,ke,Nt){var vi=function(Ci,Si,Gi,un,ir,nr){var Ln=(Si-nr)*(Gi-ir),Nr=(Ci-ir)*(un-nr),Qr=Ln-Nr;if(Ln===0||Nr===0||Ln>0!=Nr>0)return Qr;var rr=Math.abs(Ln+Nr);return Math.abs(Qr)>=ut*rr?Qr:-function(Po,lo,Fr,Ko,mo,eo,co){var Vr,Vn,qr,Ao,cn,mr,_o,Zo,wo,Zs,Wr,Ls,Fc,hl,rl,Bc,rf,qs,fa=Po-mo,ul=Fr-mo,Wl=lo-eo,Tl=Ko-eo;ri[0]=(rl=(Zo=fa-(_o=(mr=Ie*fa)-(mr-fa)))*(Zs=Tl-(wo=(mr=Ie*Tl)-(mr-Tl)))-((hl=fa*Tl)-_o*wo-Zo*wo-_o*Zs))-((Wr=rl-(rf=(Zo=Wl-(_o=(mr=Ie*Wl)-(mr-Wl)))*(Zs=ul-(wo=(mr=Ie*ul)-(mr-ul)))-((Bc=Wl*ul)-_o*wo-Zo*wo-_o*Zs)))+(cn=rl-Wr))+(cn-rf),ri[1]=(Fc=hl-((Ls=hl+Wr)-(cn=Ls-hl))+(Wr-cn))-((Wr=Fc-Bc)+(cn=Fc-Wr))+(cn-Bc),ri[2]=Ls-((qs=Ls+Wr)-(cn=qs-Ls))+(Wr-cn),ri[3]=qs;var pm=function(eC,Ib){for(var Cb=Ib[0],Jx=1;Jx<4;Jx++)Cb+=Ib[Jx];return Cb}(0,ri),ay=xt*co;if(pm>=ay||-pm>=ay||(Vr=Po-(fa+(cn=Po-fa))+(cn-mo),qr=Fr-(ul+(cn=Fr-ul))+(cn-mo),Vn=lo-(Wl+(cn=lo-Wl))+(cn-eo),Ao=Ko-(Tl+(cn=Ko-Tl))+(cn-eo),Vr===0&&Vn===0&&qr===0&&Ao===0)||(ay=Ft*co+ze*Math.abs(pm),(pm+=fa*Ao+Tl*Vr-(Wl*qr+ul*Vn))>=ay||-pm>=ay))return pm;Rt[0]=(rl=(Zo=Vr-(_o=(mr=Ie*Vr)-(mr-Vr)))*(Zs=Tl-(wo=(mr=Ie*Tl)-(mr-Tl)))-((hl=Vr*Tl)-_o*wo-Zo*wo-_o*Zs))-((Wr=rl-(rf=(Zo=Vn-(_o=(mr=Ie*Vn)-(mr-Vn)))*(Zs=ul-(wo=(mr=Ie*ul)-(mr-ul)))-((Bc=Vn*ul)-_o*wo-Zo*wo-_o*Zs)))+(cn=rl-Wr))+(cn-rf),Rt[1]=(Fc=hl-((Ls=hl+Wr)-(cn=Ls-hl))+(Wr-cn))-((Wr=Fc-Bc)+(cn=Fc-Wr))+(cn-Bc),Rt[2]=Ls-((qs=Ls+Wr)-(cn=qs-Ls))+(Wr-cn),Rt[3]=qs;var AT=Je(4,ri,4,Rt,$t);Rt[0]=(rl=(Zo=fa-(_o=(mr=Ie*fa)-(mr-fa)))*(Zs=Ao-(wo=(mr=Ie*Ao)-(mr-Ao)))-((hl=fa*Ao)-_o*wo-Zo*wo-_o*Zs))-((Wr=rl-(rf=(Zo=Wl-(_o=(mr=Ie*Wl)-(mr-Wl)))*(Zs=qr-(wo=(mr=Ie*qr)-(mr-qr)))-((Bc=Wl*qr)-_o*wo-Zo*wo-_o*Zs)))+(cn=rl-Wr))+(cn-rf),Rt[1]=(Fc=hl-((Ls=hl+Wr)-(cn=Ls-hl))+(Wr-cn))-((Wr=Fc-Bc)+(cn=Fc-Wr))+(cn-Bc),Rt[2]=Ls-((qs=Ls+Wr)-(cn=qs-Ls))+(Wr-cn),Rt[3]=qs;var DT=Je(AT,$t,4,Rt,Qt);Rt[0]=(rl=(Zo=Vr-(_o=(mr=Ie*Vr)-(mr-Vr)))*(Zs=Ao-(wo=(mr=Ie*Ao)-(mr-Ao)))-((hl=Vr*Ao)-_o*wo-Zo*wo-_o*Zs))-((Wr=rl-(rf=(Zo=Vn-(_o=(mr=Ie*Vn)-(mr-Vn)))*(Zs=qr-(wo=(mr=Ie*qr)-(mr-qr)))-((Bc=Vn*qr)-_o*wo-Zo*wo-_o*Zs)))+(cn=rl-Wr))+(cn-rf),Rt[1]=(Fc=hl-((Ls=hl+Wr)-(cn=Ls-hl))+(Wr-cn))-((Wr=Fc-Bc)+(cn=Fc-Wr))+(cn-Bc),Rt[2]=Ls-((qs=Ls+Wr)-(cn=qs-Ls))+(Wr-cn),Rt[3]=qs;var RT=Je(DT,Qt,4,Rt,hi);return hi[RT-1]}(Ci,Si,Gi,un,ir,nr,rr)}(Me[0],Me[1],ke[0],ke[1],Nt[0],Nt[1]);return vi>0?-1:vi<0?1:0}function Et(Me,ke){var Nt=Me.point,vi=ke.point;return Nt[0]>vi[0]?1:Nt[0]<vi[0]?-1:Nt[1]!==vi[1]?Nt[1]>vi[1]?1:-1:function(Ci,Si,Gi,un){return Ci.left!==Si.left?Ci.left?1:-1:Yt(Gi,Ci.otherEvent.point,Si.otherEvent.point)!==0?Ci.isBelow(Si.otherEvent.point)?-1:1:!Ci.isSubject&&Si.isSubject?1:-1}(Me,ke,Nt)}function kt(Me,ke,Nt){var vi=new Ce(ke,!1,Me,Me.isSubject),Ci=new Ce(ke,!0,Me.otherEvent,Me.isSubject);return ie(Me.point,Me.otherEvent.point)&&console.warn("what is that, a collapsed segment?",Me),vi.contourId=Ci.contourId=Me.contourId,Et(Ci,Me.otherEvent)>0&&(Me.otherEvent.left=!0,Ci.left=!1),Me.otherEvent.otherEvent=Ci,Me.otherEvent=vi,Nt.push(Ci),Nt.push(vi),Nt}function pi(Me,ke){return Me[0]*ke[1]-Me[1]*ke[0]}function mi(Me,ke){return Me[0]*ke[0]+Me[1]*ke[1]}function qi(Me,ke,Nt){var vi=function(ir,nr,Ln,Nr,Qr){var rr=[nr[0]-ir[0],nr[1]-ir[1]],Po=[Nr[0]-Ln[0],Nr[1]-Ln[1]];function lo(mr,_o,Zo){return[mr[0]+_o*Zo[0],mr[1]+_o*Zo[1]]}var Fr=[Ln[0]-ir[0],Ln[1]-ir[1]],Ko=pi(rr,Po),mo=Ko*Ko,eo=mi(rr,rr);if(mo>0){var co=pi(Fr,Po)/Ko;if(co<0||co>1)return null;var Vr=pi(Fr,rr)/Ko;return Vr<0||Vr>1?null:co===0||co===1?[lo(ir,co,rr)]:Vr===0||Vr===1?[lo(Ln,Vr,Po)]:[lo(ir,co,rr)]}if((mo=(Ko=pi(Fr,rr))*Ko)>0)return null;var Vn=mi(rr,Fr)/eo,qr=Vn+mi(rr,Po)/eo,Ao=Math.min(Vn,qr),cn=Math.max(Vn,qr);return Ao<=1&&cn>=0?Ao===1?[lo(ir,Ao>0?Ao:0,rr)]:cn===0?[lo(ir,cn<1?cn:1,rr)]:[lo(ir,Ao>0?Ao:0,rr),lo(ir,cn<1?cn:1,rr)]:null}(Me.point,Me.otherEvent.point,ke.point,ke.otherEvent.point),Ci=vi?vi.length:0;if(Ci===0||Ci===1&&(ie(Me.point,ke.point)||ie(Me.otherEvent.point,ke.otherEvent.point))||Ci===2&&Me.isSubject===ke.isSubject)return 0;if(Ci===1)return ie(Me.point,vi[0])||ie(Me.otherEvent.point,vi[0])||kt(Me,vi[0],Nt),ie(ke.point,vi[0])||ie(ke.otherEvent.point,vi[0])||kt(ke,vi[0],Nt),1;var Si=[],Gi=!1,un=!1;return ie(Me.point,ke.point)?Gi=!0:Et(Me,ke)===1?Si.push(ke,Me):Si.push(Me,ke),ie(Me.otherEvent.point,ke.otherEvent.point)?un=!0:Et(Me.otherEvent,ke.otherEvent)===1?Si.push(ke.otherEvent,Me.otherEvent):Si.push(Me.otherEvent,ke.otherEvent),Gi&&un||Gi?(ke.type=E,Me.type=ke.inOut===Me.inOut?L:F,Gi&&!un&&kt(Si[1].otherEvent,Si[0].point,Nt),2):un?(kt(Si[0],Si[1].point,Nt),3):Si[0]!==Si[3].otherEvent?(kt(Si[0],Si[1].point,Nt),kt(Si[1],Si[2].point,Nt),3):(kt(Si[0],Si[1].point,Nt),kt(Si[3].otherEvent,Si[2].point,Nt),3)}function Bi(Me,ke){if(Me===ke)return 0;if(Yt(Me.point,Me.otherEvent.point,ke.point)!==0||Yt(Me.point,Me.otherEvent.point,ke.otherEvent.point)!==0)return ie(Me.point,ke.point)?Me.isBelow(ke.otherEvent.point)?-1:1:Me.point[0]===ke.point[0]?Me.point[1]<ke.point[1]?-1:1:Et(Me,ke)===1?ke.isAbove(Me.point)?-1:1:Me.isBelow(ke.point)?-1:1;if(Me.isSubject!==ke.isSubject)return Me.isSubject?-1:1;var Nt=Me.point,vi=ke.point;return Nt[0]===vi[0]&&Nt[1]===vi[1]?(Nt=Me.otherEvent.point)[0]===(vi=ke.otherEvent.point)[0]&&Nt[1]===vi[1]?0:Me.contourId>ke.contourId?1:-1:Et(Me,ke)===1?1:-1}var Ti=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function ui(Me,ke,Nt,vi){var Ci,Si=Me+1,Gi=ke[Me].point,un=ke.length;for(Si<un&&(Ci=ke[Si].point);Si<un&&Ci[0]===Gi[0]&&Ci[1]===Gi[1];){if(!Nt[Si])return Si;++Si<un&&(Ci=ke[Si].point)}for(Si=Me-1;Nt[Si]&&Si>vi;)Si--;return Si}Ti.prototype.isExterior=function(){return this.holeOf==null};var bn=Ui,Vi=Ui;function Ui(Me,ke){if(!(this instanceof Ui))return new Ui(Me,ke);if(this.data=Me||[],this.length=this.data.length,this.compare=ke||mn,this.length>0)for(var Nt=(this.length>>1)-1;Nt>=0;Nt--)this._down(Nt)}function mn(Me,ke){return Me<ke?-1:Me>ke?1:0}Ui.prototype={push:function(Me){this.data.push(Me),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var Me=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),Me}},peek:function(){return this.data[0]},_up:function(Me){for(var ke=this.data,Nt=this.compare,vi=ke[Me];Me>0;){var Ci=Me-1>>1,Si=ke[Ci];if(Nt(vi,Si)>=0)break;ke[Me]=Si,Me=Ci}ke[Me]=vi},_down:function(Me){for(var ke=this.data,Nt=this.compare,vi=this.length>>1,Ci=ke[Me];Me<vi;){var Si=1+(Me<<1),Gi=Si+1,un=ke[Si];if(Gi<this.length&&Nt(ke[Gi],un)<0&&(Si=Gi,un=ke[Gi]),Nt(un,Ci)>=0)break;ke[Me]=un,Me=Si}ke[Me]=Ci}},bn.default=Vi;var Pn=Math.max,Rn=Math.min,Zn=0;function kn(Me,ke,Nt,vi,Ci,Si){var Gi,un,ir,nr,Ln,Nr;for(Gi=0,un=Me.length-1;Gi<un;Gi++)if(nr=Me[Gi+1],Ln=new Ce(ir=Me[Gi],!1,void 0,ke),Nr=new Ce(nr,!1,Ln,ke),Ln.otherEvent=Nr,ir[0]!==nr[0]||ir[1]!==nr[1]){Ln.contourId=Nr.contourId=Nt,Si||(Ln.isExteriorRing=!1,Nr.isExteriorRing=!1),Et(Ln,Nr)>0?Nr.left=!0:Ln.left=!0;var Qr=ir[0],rr=ir[1];Ci[0]=Rn(Ci[0],Qr),Ci[1]=Rn(Ci[1],rr),Ci[2]=Pn(Ci[2],Qr),Ci[3]=Pn(Ci[3],rr),vi.push(Ln),vi.push(Nr)}}var zn=[];function $r(Me,ke,Nt){typeof Me[0][0][0]=="number"&&(Me=[Me]),typeof ke[0][0][0]=="number"&&(ke=[ke]);var vi=function(rr,Po,lo){var Fr=null;return rr.length*Po.length==0&&(lo===V?Fr=zn:lo===H?Fr=rr:lo!==W&&lo!==ee||(Fr=rr.length===0?Po:rr)),Fr}(Me,ke,Nt);if(vi)return vi===zn?null:vi;var Ci=[1/0,1/0,-1/0,-1/0],Si=[1/0,1/0,-1/0,-1/0],Gi=function(rr,Po,lo,Fr,Ko){var mo,eo,co,Vr,Vn,qr,Ao=new bn(null,Et);for(co=0,Vr=rr.length;co<Vr;co++)for(Vn=0,qr=(mo=rr[co]).length;Vn<qr;Vn++)(eo=Vn===0)&&Zn++,kn(mo[Vn],!0,Zn,Ao,lo,eo);for(co=0,Vr=Po.length;co<Vr;co++)for(Vn=0,qr=(mo=Po[co]).length;Vn<qr;Vn++)eo=Vn===0,Ko===H&&(eo=!1),eo&&Zn++,kn(mo[Vn],!1,Zn,Ao,Fr,eo);return Ao}(Me,ke,Ci,Si,Nt);if(vi=function(rr,Po,lo,Fr,Ko){var mo=null;return(lo[0]>Fr[2]||Fr[0]>lo[2]||lo[1]>Fr[3]||Fr[1]>lo[3])&&(Ko===V?mo=zn:Ko===H?mo=rr:Ko!==W&&Ko!==ee||(mo=rr.concat(Po))),mo}(Me,ke,Ci,Si,Nt))return vi===zn?null:vi;for(var un=function(rr){var Po,lo,Fr=function(co){var Vr,Vn,qr,Ao,cn=[];for(Vn=0,qr=co.length;Vn<qr;Vn++)((Vr=co[Vn]).left&&Vr.inResult||!Vr.left&&Vr.otherEvent.inResult)&&cn.push(Vr);for(var mr=!1;!mr;)for(mr=!0,Vn=0,qr=cn.length;Vn<qr;Vn++)Vn+1<qr&&Et(cn[Vn],cn[Vn+1])===1&&(Ao=cn[Vn],cn[Vn]=cn[Vn+1],cn[Vn+1]=Ao,mr=!1);for(Vn=0,qr=cn.length;Vn<qr;Vn++)(Vr=cn[Vn]).otherPos=Vn;for(Vn=0,qr=cn.length;Vn<qr;Vn++)(Vr=cn[Vn]).left||(Ao=Vr.otherPos,Vr.otherPos=Vr.otherEvent.otherPos,Vr.otherEvent.otherPos=Ao);return cn}(rr),Ko={},mo=[],eo=function(){if(!Ko[Po]){var co=mo.length,Vr=function(cn,mr,_o){var Zo=new Ti;if(cn.prevInResult!=null){var wo=cn.prevInResult,Zs=wo.outputContourId;if(wo.resultTransition>0){var Wr=mr[Zs];if(Wr.holeOf!=null){var Ls=Wr.holeOf;mr[Ls].holeIds.push(_o),Zo.holeOf=Ls,Zo.depth=mr[Zs].depth}else mr[Zs].holeIds.push(_o),Zo.holeOf=Zs,Zo.depth=mr[Zs].depth+1}else Zo.holeOf=null,Zo.depth=mr[Zs].depth}else Zo.holeOf=null,Zo.depth=0;return Zo}(Fr[Po],mo,co),Vn=function(cn){Ko[cn]=!0,cn<Fr.length&&Fr[cn]&&(Fr[cn].outputContourId=co)},qr=Po,Ao=Po;for(Vr.points.push(Fr[Po].point);Vn(qr),Vn(qr=Fr[qr].otherPos),Vr.points.push(Fr[qr].point),!((qr=ui(qr,Fr,Ko,Ao))==Ao||qr>=Fr.length)&&Fr[qr];);mo.push(Vr)}};for(Po=0,lo=Fr.length;Po<lo;Po++)eo();return mo}(function(rr,Po,lo,Fr,Ko,mo){for(var eo,co,Vr,Vn=new c(Bi),qr=[],Ao=Math.min(Fr[2],Ko[2]);rr.length!==0;){var cn=rr.pop();if(qr.push(cn),mo===V&&cn.point[0]>Ao||mo===H&&cn.point[0]>Fr[2])break;if(cn.left){co=eo=Vn.insert(cn),eo=eo!==(Vr=Vn.minNode())?Vn.prev(eo):null,co=Vn.next(co);var mr=eo?eo.key:null;if(le(cn,mr,mo),co&&qi(cn,co.key,rr)===2&&(le(cn,mr,mo),le(co.key,cn,mo)),eo&&qi(eo.key,cn,rr)===2){var _o=eo;le(mr,(_o=_o!==Vr?Vn.prev(_o):null)?_o.key:null,mo),le(cn,mr,mo)}}else co=eo=Vn.find(cn=cn.otherEvent),eo&&co&&(eo=eo!==Vr?Vn.prev(eo):null,co=Vn.next(co),Vn.remove(cn),co&&eo&&qi(eo.key,co.key,rr))}return qr}(Gi,0,0,Ci,Si,Nt)),ir=[],nr=0;nr<un.length;nr++){var Ln=un[nr];if(Ln.isExterior()){for(var Nr=[Ln.points],Qr=0;Qr<Ln.holeIds.length;Qr++)Nr.push(un[Ln.holeIds[Qr]].points);ir.push(Nr)}}return ir}var ao={UNION:W,DIFFERENCE:H,INTERSECTION:V,XOR:ee};n.diff=function(Me,ke){return $r(Me,ke,H)},n.intersection=function(Me,ke){return $r(Me,ke,V)},n.operations=ao,n.union=function(Me,ke){return $r(Me,ke,W)},n.xor=function(Me,ke){return $r(Me,ke,ee)},Object.defineProperty(n,"__esModule",{value:!0})})(e)}(0,Rg.exports)),Rg.exports);function qm(o,e,n,l){let c=[],m=l===0?(_,b,I,E,L,F)=>{_.push(new Ue(F,I+(F-b)/(E-b)*(L-I)))}:(_,b,I,E,L,F)=>{_.push(new Ue(b+(F-I)/(L-I)*(E-b),F))};for(let _ of o){let b=[];for(let I of _){if(I.length<=2)continue;let E=[];for(let V=0;V<I.length-1;V++){let W=I[V].x,H=I[V].y,ee=I[V+1].x,le=I[V+1].y,de=l===0?W:H,Ce=l===0?ee:le;de<e?Ce>e&&m(E,W,H,ee,le,e):de>n?Ce<n&&m(E,W,H,ee,le,n):E.push(I[V]),Ce<e&&de>=e&&m(E,W,H,ee,le,e),Ce>n&&de<=n&&m(E,W,H,ee,le,n)}let L=I[I.length-1],F=l===0?L.x:L.y;F>=e&&F<=n&&E.push(L),E.length&&(L=E[E.length-1],E[0].x===L.x&&E[0].y===L.y||E.push(E[0]),b.push(E))}b.length&&c.push(b)}return c}function zg(o,e){let n=S_(o),l=S_([e]),c=Dy.intersection(n,l);return c==null?[]:rm(c)}function Lg(o,e){let l=S_(o,65536);for(;e.valid();e.next()){let[c,m]=e.get(),_=c.x*65536,b=c.y*65536,I=m.x*65536,E=m.y*65536,L=I-_,F=E-b,V=Math.hypot(L,F),W=Math.trunc(F/V*3),H=-Math.trunc(L/V*3);l=Dy.diff(l,[[[_,b],[I,E],[I+W,E+H],[_+W,b+H],[_,b]]])}return rm(l,1/65536)}function S_(o,e=1){return[o.map(n=>n.map(l=>[l.x*e,l.y*e]))]}function rm(o,e=1){return o.map(n=>n.map((l,c)=>{let m=l.map(_=>new Ue(_[0]*e,_[1]*e).round());return c>0&&m.reverse(),m}))}class $m{constructor(e,n){this.layoutVertexArray=new la,this.indexArray=new zo,this.lineIndexArray=new xl,this.triangleSegments=new bo,this.lineSegments=new bo,this.programConfigurations=new hp(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,n&&(this.elevatedLayoutVertexArray=new dc)}update(e,n,l,c,m,_,b){this.programConfigurations.updatePaintArrays(e,n,m,l,c,_,b)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,yg.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,Qf.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,n,l,c,m,_){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,n,l,c,m,_)}}class I_{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.bufferData=new $m(e,!1),this.elevationBufferData=new $m(e,!0),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference")}updateFootprints(e,n){}populate(e,n,l,c){this.hasPattern=__("fill",this.layers,this.pixelRatio,n);let m=this.layers[0].layout.get("fill-sort-key"),_=[];for(let{feature:b,id:I,index:E,sourceLayerIndex:L}of e){let F=this.layers[0]._featureFilter.needGeometry,V=ji(b,F);if(!this.layers[0]._featureFilter.filter(new J(this.zoom),V,l))continue;let W=m?m.evaluate(V,{},l,n.availableImages):void 0,H={id:I,properties:b.properties,type:b.type,sourceLayerIndex:L,index:E,geometry:F?V.geometry:ki(b,l,c),patterns:{},sortKey:W};_.push(H)}m&&_.sort((b,I)=>b.sortKey-I.sortKey);for(let b of _){let{geometry:I,index:E,sourceLayerIndex:L}=b;if(this.hasPattern){let F=g_("fill",this.layers,b,this.zoom,this.pixelRatio,n);this.patternFeatures.push(F)}else this.addFeature(b,I,E,l,{},n.availableImages,n.brightness,n.elevationFeatures);n.featureIndex.insert(e[E].feature,I,E,L,this.index)}}update(e,n,l,c,m,_,b){this.bufferData.update(e,n,l,c,m,_,b),this.elevationBufferData.update(e,n,l,c,m,_,b)}addFeatures(e,n,l,c,m,_){for(let b of this.patternFeatures)this.addFeature(b,b.geometry,b.index,n,l,c,_,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,n,l,c,m,_=[],b,I){let E=xp(n,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,E,c,l,I):this.addGeometry(E,this.bufferData),this.bufferData.populatePaintArrays(e,l,m,_,c,b),this.elevationBufferData.populatePaintArrays(e,l,m,_,c,b)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e){this.elevatedStructures&&this.elevatedStructures.construct(e)}addElevatedRoadFeature(e,n,l,c,m){let _=new Array,b=Na.getElevationFeature(e,m);if(b){{let I=this.clipPolygonsToTile(n,1);I.length>0&&_.push({polygons:I,elevationFeature:b,elevationTileID:l})}for(let I of _)if(I.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new kc(I.elevationTileID));let L=I.elevationFeature.isTunnel(),F=0;e.properties.hasOwnProperty(Mg)&&(F=+e.properties[Mg]);for(let V of I.polygons)this.elevatedStructures.addPortalCandidates(I.elevationFeature.id,V,L,I.elevationFeature,F)}I.elevationFeature.constantHeight==null&&(I.polygons=this.prepareElevatedPolygons(I.polygons,I.elevationFeature,I.elevationTileID));let E=new T_(l,I.elevationTileID);this.addElevatedGeometry(I.polygons,E,I.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,c)}}else this.addGeometry(n,this.bufferData)}addElevatedGeometry(e,n,l,c,m){let _={elevation:l,elevationSampler:n,bias:c,index:m},[b,I]=this.addGeometry(e,this.elevationBufferData,_);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:b,max:I}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,b),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,I))}addGeometry(e,n,l){let c=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,_=null;l&&(_=l.elevationSampler.constantElevation(l.elevation,l.bias),_!=null&&(c=_,m=_));let b=(I,E,L)=>{if(l!=null)if(E.push(I),_!=null)n.elevatedLayoutVertexArray.emplaceBack(_),L.push(_);else{let F=l.elevationSampler.pointElevation(I,l.elevation,l.bias);n.elevatedLayoutVertexArray.emplaceBack(F),L.push(F),c=Math.min(c,F),m=Math.max(m,F)}};for(let I of e){let E=0;for(let we of I)E+=we.length;let L=n.triangleSegments.prepareSegment(E,n.layoutVertexArray,n.indexArray),F=L.vertexLength,V=[],W=[],H=[],ee=[],le=[],de=n.layoutVertexArray.length;for(let we of I){if(we.length===0)continue;we!==I[0]&&W.push(V.length/2);let ie=n.lineSegments.prepareSegment(we.length,n.layoutVertexArray,n.lineIndexArray),me=ie.vertexLength;l&&le.push(n.layoutVertexArray.length-de),b(we[0],H,ee),n.layoutVertexArray.emplaceBack(we[0].x,we[0].y),n.lineIndexArray.emplaceBack(me+we.length-1,me),V.push(we[0].x),V.push(we[0].y);for(let Ie=1;Ie<we.length;Ie++)b(we[Ie],H,ee),n.layoutVertexArray.emplaceBack(we[Ie].x,we[Ie].y),n.lineIndexArray.emplaceBack(me+Ie-1,me+Ie),V.push(we[Ie].x),V.push(we[Ie].y);ie.vertexLength+=we.length,ie.primitiveLength+=we.length}let Ce=Ef(V,W);for(let we=0;we<Ce.length;we+=3)n.indexArray.emplaceBack(F+Ce[we],F+Ce[we+1],F+Ce[we+2]);if(Ce.length>0&&l&&this.elevationMode==="hd-road-base"){let we=l.elevation.isTunnel(),ie=l.elevation.safeArea,me=this.elevatedStructures.addVertices(H,ee);this.elevatedStructures.addTriangles(Ce,me,we);let Ie=le.length;if(Ie>0){for(let ze=0;ze<Ie-1;ze++)this.elevatedStructures.addRenderableRing(l.index,le[ze]+me,le[ze+1]-le[ze],we,ie);this.elevatedStructures.addRenderableRing(l.index,le[Ie-1]+me,H.length-le[Ie-1],we,ie)}}L.vertexLength+=E,L.primitiveLength+=Ce.length/3}return[c,m]}prepareElevatedPolygons(e,n,l){let c=1/vt(l),m=[];for(let _ of e){let b=Lg(_,new Ay(n,c));m.push(...b)}return m}clipPolygonsToTile(e,n){let l=-n,c=-n,m=xi+n,_=xi+n,b=0,I=[],E=[];for(;b<e.length;b++){let V=e[b],W=Xr(V);(W.min.x>=l&&W.max.x<=m&&W.min.y>=c&&W.max.y<=_?I:E).push(V)}if(I.length===e.length)return e;let L=[new Ue(l,c),new Ue(m,c),new Ue(m,_),new Ue(l,_),new Ue(l,c)],F=I;for(let V of E)F.push(...zg(V,L));return F}}let C_,Wm,om,E_;Ei(I_,"FillBucket",{omit:["layers","patternFeatures"]}),Ei($m,"FillBufferData"),Ei(kc,"ElevatedStructures");class Hm{constructor(e,n,l,c){if(this.triangleCount=n.length/3,this.min=new Ue(0,0),this.max=new Ue(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;let[m,_]=[e[0].clone(),e[0].clone()];for(let F=1;F<e.length;++F){let V=e[F];m.x=Math.min(m.x,V.x),m.y=Math.min(m.y,V.y),_.x=Math.max(_.x,V.x),_.y=Math.max(_.y,V.y)}if(c){let F=Math.ceil(Math.max(_.x-m.x,_.y-m.y)/c);l=Math.max(l,F)}if(l===0)return;this.min=m,this.max=_;let b=this.max.sub(this.min);b.x=Math.max(b.x,1),b.y=Math.max(b.y,1);let I=Math.max(b.x,b.y)/l;this.cellsX=Math.max(1,Math.ceil(b.x/I)),this.cellsY=Math.max(1,Math.ceil(b.y/I)),this.xScale=1/I,this.yScale=1/I;let E=[];for(let F=0;F<this.triangleCount;F++){let V=e[n[3*F+0]].sub(this.min),W=e[n[3*F+1]].sub(this.min),H=e[n[3*F+2]].sub(this.min),ee=Yh(Math.floor(Math.min(V.x,W.x,H.x)),this.xScale,this.cellsX),le=Yh(Math.floor(Math.max(V.x,W.x,H.x)),this.xScale,this.cellsX),de=Yh(Math.floor(Math.min(V.y,W.y,H.y)),this.yScale,this.cellsY),Ce=Yh(Math.floor(Math.max(V.y,W.y,H.y)),this.yScale,this.cellsY),we=new Ue(0,0),ie=new Ue(0,0),me=new Ue(0,0),Ie=new Ue(0,0);for(let ze=de;ze<=Ce;++ze){we.y=ie.y=ze*I,me.y=Ie.y=(ze+1)*I;for(let Je=ee;Je<=le;++Je)we.x=me.x=Je*I,ie.x=Ie.x=(Je+1)*I,(ro(V,W,H,we,ie,Ie)||ro(V,W,H,we,Ie,me))&&E.push({cellIdx:ze*this.cellsX+Je,triIdx:F})}}if(E.length===0)return;E.sort((F,V)=>F.cellIdx-V.cellIdx||F.triIdx-V.triIdx);let L=0;for(;L<E.length;){let F=E[L].cellIdx,V={start:this.payload.length,len:0};for(;L<E.length&&E[L].cellIdx===F;)++V.len,this.payload.push(E[L++].triIdx);this.cells[F]=V}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,n){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;let l=Yh(e.x-this.min.x,this.xScale,this.cellsX),c=Yh(e.y-this.min.y,this.yScale,this.cellsY),m=this.cells[c*this.cellsX+l];if(m){this._lazyInitLookup();for(let _=0;_<m.len;_++){let b=this.payload[m.start+_],I=Math.floor(b/8),E=1<<b%8;if(!(this.lookup[I]&E)&&(this.lookup[I]|=E,n.push(b),n.length===this.triangleCount))return}}}query(e,n,l){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>n.x||e.y>this.max.y||this.min.y>n.y)return;this._lazyInitLookup();let c=Yh(e.x-this.min.x,this.xScale,this.cellsX),m=Yh(n.x-this.min.x,this.xScale,this.cellsX),_=Yh(e.y-this.min.y,this.yScale,this.cellsY),b=Yh(n.y-this.min.y,this.yScale,this.cellsY);for(let I=_;I<=b;I++)for(let E=c;E<=m;E++){let L=this.cells[I*this.cellsX+E];if(L)for(let F=0;F<L.len;F++){let V=this.payload[L.start+F],W=Math.floor(V/8),H=1<<V%8;if(!(this.lookup[W]&H)&&(this.lookup[W]|=H,l.push(V),l.length===this.triangleCount))return}}}}function Yh(o,e,n){return Math.max(0,Math.min(n-1,Math.floor(o*e)))}Ei(Hm,"TriangleGridIndex");class Ry{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.footprints=[]}updateFootprints(e,n){for(let l of this.footprints)n.push({footprint:l,id:e})}populate(e,n,l,c){let m=[];for(let{feature:_,id:b,index:I,sourceLayerIndex:E}of e){let L=this.layers[0]._featureFilter.needGeometry,F=ji(_,L);if(!this.layers[0]._featureFilter.filter(new J(this.zoom),F,l))continue;let V={id:b,properties:_.properties,type:_.type,sourceLayerIndex:E,index:I,geometry:L?F.geometry:ki(_,l,c),patterns:{}};m.push(V)}for(let _ of m){let{geometry:b,index:I,sourceLayerIndex:E}=_;this.addFeature(_,b,I,l,{},n.availableImages,n.brightness),n.featureIndex.insert(e[I].feature,b,I,E,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,n,l,c,m,_,b){}destroy(){}addFeature(e,n,l,c,m,_=[],b){for(let I of xp(n,2)){let E=[],L=[],F=[],V=new Ue(1/0,1/0),W=new Ue(-1/0,-1/0);for(let le of I)if(le.length!==0){le!==I[0]&&F.push(L.length/2);for(let de=0;de<le.length;de++)L.push(le[de].x),L.push(le[de].y),E.push(le[de]),V.x=Math.min(V.x,le[de].x),V.y=Math.min(V.y,le[de].y),W.x=Math.max(W.x,le[de].x),W.y=Math.max(W.y,le[de].y)}let H=Ef(L,F),ee=new Hm(E,H,8,256);this.footprints.push({vertices:E,indices:H,grid:ee,min:V,max:W})}}}Ei(Ry,"ClipBucket",{omit:["layers"]});let d=Kn([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),s=Kn([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),u=Kn([{name:"a_centroid_pos",components:2,type:"Uint16"}]),y=Kn([{name:"a_join_normal_inside",components:3,type:"Int16"}]),T=Kn([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),D=Kn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:R}=d,B=Number.MAX_SAFE_INTEGER;function G(o,e,n,l){return o.order<e||o.order===B||!(o.clipMask&n)||function(c,m){return m.length!==0&&m.find(_=>_===c)===void 0}(l,o.clipScope)}function K(o,e){return o.x-e.x||o.y-e.y}function Q(o,e){return K(o.min,e.min)===0&&K(o.max,e.max)===0}function ce(o,e){return!(o.min.x>e.max.x||o.max.x<e.min.x||o.min.y>e.max.y||o.max.y<e.min.y)}function _e(o,e){if(o.length!==e.length)return!1;for(let n=0;n<o.length;n++)if(o[n].sourceId!==e[n].sourceId||!Q(o[n],e[n])||o[n].order!==e[n].order||o[n].clipMask!==e[n].clipMask||!Qi(o[n].clipScope,e[n].clipScope))return!1;return!0}function ve(o,e,n){let l=1/xi,c=1/(1<<n.canonical.z),m=(e.x*l+n.canonical.x)*c+n.wrap,_=(e.y*l+n.canonical.y)*c;return{min:new Ue((o.x*l+n.canonical.x)*c+n.wrap,(o.y*l+n.canonical.y)*c),max:new Ue(m,_)}}function Te(o,e,n){let l=1<<n.canonical.z,c=((e.x-n.wrap)*l-n.canonical.x)*xi,m=(e.y*l-n.canonical.y)*xi;return{min:new Ue(((o.x-n.wrap)*l-n.canonical.x)*xi,(o.y*l-n.canonical.y)*xi),max:new Ue(c,m)}}function De(o,e,n,l,c,m,_){let b=o.indices,I=o.vertices,E=[];for(let L=l;L<l+c;L+=3){let F=e[n[L+0]+m],V=e[n[L+1]+m],W=e[n[L+2]+m],H=Math.min(F.x,V.x,W.x),ee=Math.max(F.x,V.x,W.x),le=Math.min(F.y,V.y,W.y),de=Math.max(F.y,V.y,W.y);E.length=0,o.grid.query(new Ue(H,le),new Ue(ee,de),E);for(let Ce=0;Ce<E.length;Ce++){let we=E[Ce];if(ro(I[b[3*we+0]],I[b[3*we+1]],I[b[3*we+2]],F,V,W,_))return!0}}return!1}function Ye(o,e,n,l){if(!o||!n)return!1;let c=o.vertices;if(!e.canonical.equals(l.canonical)||e.wrap!==l.wrap){if(n.vertices.length<o.vertices.length)return Ye(n,l,o,e);let m=e.canonical,_=l.canonical,b=Math.pow(2,_.z-m.z);c=o.vertices.map(I=>new Ue((I.x+m.x*xi)*b-_.x*xi,(I.y+m.y*xi)*b-_.y*xi))}return De(n,c,o.indices,0,o.indices.length,0,0)}function lt(o,e,n,l){let c=Math.pow(2,l.z-n.z);return new Ue((o+n.x*xi)*c-l.x*xi,(e+n.y*xi)*c-l.y*xi)}function Mt(o,e){let n=[];e.grid.queryPoint(o,n);let l=e.indices,c=e.vertices;for(let m=0;m<n.length;m++){let _=n[m];if(Or([c[l[3*_+0]],c[l[3*_+1]],c[l[3*_+2]]],o))return!0}return!1}let yt=[new Ue(0,0),new Ue(xi,0),new Ue(xi,xi),new Ue(0,xi)];function ye(o,e){let n=[],l=[];if(!e||o.length<2)return[o];if(o.length===2)return Lo(o[0],o[1],yt)?[o]:[];for(let c=0;c<o.length+2;c++){let m=o[c%o.length],_=o[(c+1)%o.length],b=Lo(c===0?o[o.length-1]:o[(c-1)%o.length],m,yt),I=Lo(m,_,yt),E=b||I;E&&l.push(m),E&&I||l.length>0&&(l.length>1&&n.push(l),l=[])}return l.length>1&&n.push(l),n}let Ze=bp.VectorTileFeature.types,bt=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],ni=["fill-extrusion-flood-light-ground-radius"],Ai=Math.pow(2,13),ci=Math.pow(2,15)-1,gi=new Ue(0,1),Fi=2147483648;function Mi(o,e,n,l,c,m,_,b){o.emplaceBack((e<<1)+_,(n<<1)+m,(Math.floor(l*Ai)<<1)+c,Math.round(b))}function Zi(o,e,n){o.emplaceBack(e.x*xi,e.y*xi,n?1:0)}function bi(o,e,n,l,c,m){o.emplaceBack(e.x,e.y,(n.x<<1)+l,(n.y<<1)+c,m)}function fn(o,e,n){o.emplaceBack(e.x,e.y,e.z,n[0]*16384,n[1]*16384,n[2]*16384)}class Hn{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class Nn{constructor(){this.centroidXY=new Ue(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Ue(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Ue(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new Ue(this.max.x-this.min.x,this.max.y-this.min.y)}}class Sn{constructor(){this.acc=new Ue(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,n){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=n.x,e.min.y=e.max.y=n.y)}appendEdge(e,n,l){this.accCount++,this.acc._add(n);let c=!!this.borders;n.x<e.min.x?(e.min.x=n.x,c=!0):n.x>e.max.x&&(e.max.x=n.x,c=!0),n.y<e.min.y?(e.min.y=n.y,c=!0):n.y>e.max.y&&(e.max.y=n.y,c=!0),((n.x===0||n.x===xi)&&n.x===l.x)!=((n.y===0||n.y===xi)&&n.y===l.y)&&this.processBorderOverlap(n,l),c&&this.checkBorderIntersection(n,l)}checkBorderIntersection(e,n){n.x<0!=e.x<0&&this.addBorderIntersection(0,en(n.y,e.y,(0-n.x)/(e.x-n.x))),n.x>xi!=e.x>xi&&this.addBorderIntersection(1,en(n.y,e.y,(xi-n.x)/(e.x-n.x))),n.y<0!=e.y<0&&this.addBorderIntersection(2,en(n.x,e.x,(0-n.y)/(e.y-n.y))),n.y>xi!=e.y>xi&&this.addBorderIntersection(3,en(n.x,e.x,(xi-n.y)/(e.y-n.y)))}addBorderIntersection(e,n){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);let l=this.borders[e];n<l[0]&&(l[0]=n),n>l[1]&&(l[1]=n)}processBorderOverlap(e,n){if(e.x===n.x){if(e.y===n.y)return;let l=e.x===0?0:1;this.addBorderIntersection(l,n.y),this.addBorderIntersection(l,e.y)}else{let l=e.y===0?2:3;this.addBorderIntersection(l,n.x),this.addBorderIntersection(l,e.x)}}centroid(){return this.accCount===0?new Ue(0,0):new Ue(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,n)=>e+ +(n[0]!==Number.MAX_VALUE),0):0}}function Zr(o,e){let n=o.add(e)._unit(),l=rt(o.x*n.x+o.y*n.y,-1,1);var c,m,_;return c=Math.acos(l),Math.min(4,Math.max(-4,Math.tan(c)))/4*ci*((m=o).x*(_=e).y-m.y*_.x<0?-1:1)}let zs=[o=>o.x<0,o=>o.x>xi,o=>o.y<0,o=>o.y>xi];function Ea(o,e,n,l){let c=[4];if(l===0)return c;n._mult(l);let m=o.sub(n),_=e.sub(n),b=[o,e,m,_];for(let I=0;I<4;I++)for(let E of b)if(zs[I](E)){c.push(I);break}return c}class il{constructor(e){this.vertexArray=new Dc,this.indexArray=new zo,this.programConfigurations=new hp(e.layers,{zoom:e.zoom,lut:e.lut},n=>ni.includes(n)),this._segments=new bo,this.hiddenByLandmarkVertexArray=new qf,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new bo}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,n,l,c=!1){let m=e.length;if(m>2){let _=Math.max(0,this._segments.get().length-1),b=this._segments._prepareSegment(4*m,this.vertexArray.length,2*this._segmentToGroundQuads[_].length),I;_!==this._segments.get().length-1&&(_++,this._segmentToGroundQuads[_]=[],this._segmentToRegionTriCounts[_]=[0,0,0,0,0]);{let E=e[0],L=e[1];I=Zr(E.sub(e[m-1])._perp()._unit(),L.sub(E)._perp()._unit())}for(let E=0;E<m;E++){let L=E===m-1?0:E+1,F=e[E],V=e[L],W=e[L===m-1?0:L+1],H=V.sub(F)._perp()._unit(),ee=Zr(H,W.sub(V)._perp()._unit()),le=I,de=ee;if(da(F,V,n)||c&&Va(F,n)&&Va(V,n)){I=ee;continue}let Ce=b.vertexLength;bi(this.vertexArray,F,V,1,1,le),bi(this.vertexArray,F,V,1,0,le),bi(this.vertexArray,F,V,0,1,de),bi(this.vertexArray,F,V,0,0,de),b.vertexLength+=4;let we=Ea(F,V,H,l);for(let ie of we)this._segmentToGroundQuads[_].push({id:Ce,region:ie}),this._segmentToRegionTriCounts[_][ie]+=2,b.primitiveLength+=2;I=ee}}}prepareBorderSegments(){if(!this.hasData())return;let e=this._segments.get(),n=e.length;for(let l=0;l<n;l++)this._segmentToGroundQuads[l].sort((c,m)=>c.region-m.region);for(let l=0;l<n;l++){let c=this._segmentToGroundQuads[l],m=e[l],_=this._segmentToRegionTriCounts[l];_.reduce((I,E)=>I+E,0);let b=0;for(let I=0;I<=4;I++){let E=_[I];if(E!==0){let L=this.regionSegments[I];L||(L=this.regionSegments[I]=new bo);let F={vertexOffset:m.vertexOffset,primitiveOffset:m.primitiveOffset+b,vertexLength:m.vertexLength,primitiveLength:E};L.get().push(F)}b+=E}for(let I=0;I<c.length;I++){let E=c[I].id;this.indexArray.emplaceBack(E,E+1,E+3),this.indexArray.emplaceBack(E,E+3,E+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,n,l,c,m,_){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,n,l,c,m,_)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,s.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,n,l,c,m,_,b){this.hasData()&&this.programConfigurations.updatePaintArrays(e,n,l,c,m,_,b)}updateHiddenByLandmark(e){if(!this.hasData())return;let n=e.groundVertexCount+e.groundVertexArrayOffset;if(e.groundVertexCount===0)return;let l=e.flags&Fi?1:0;for(let c=e.groundVertexArrayOffset;c<n;++c)this.hiddenByLandmarkVertexArray.emplace(c,l);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,T.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){let n=this.regionSegments[e];n&&n.destroy()}}}}class ql{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new zo,this.footprintVertices=new la,this.footprintSegments=[],this.layoutVertexArray=new uc,this.centroidVertexArray=new Lm,this.wallVertexArray=new c_,this.indexArray=new zo,this.programConfigurations=new hp(e.layers,{zoom:e.zoom,lut:e.lut},n=>bt.includes(n)),this.segments=new bo,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.groundEffect=new il(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(e,n){}populate(e,n,l,c){this.features=[],this.hasPattern=__("fill-extrusion",this.layers,this.pixelRatio,n),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=vt(l),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(let{feature:m,id:_,index:b,sourceLayerIndex:I}of e){let E=this.layers[0]._featureFilter.needGeometry,L=ji(m,E);if(!this.layers[0]._featureFilter.filter(new J(this.zoom),L,l))continue;let F={id:_,sourceLayerIndex:I,index:b,geometry:E?L.geometry:ki(m,l,c),properties:m.properties,type:m.type,patterns:{}},V=this.layoutVertexArray.length,W=Ze[F.type]==="Polygon";if(this.hasPattern)this.features.push(g_("fill-extrusion",this.layers,F,this.zoom,this.pixelRatio,n));else if(this.wallMode)for(let H of F.geometry)for(let ee of ye(H,W))this.addFeature(F,[ee],b,l,{},n.availableImages,c,n.brightness);else this.addFeature(F,F.geometry,b,l,{},n.availableImages,c,n.brightness);n.featureIndex.insert(m,F.geometry,b,I,this.index,V)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,n,l,c,m,_){for(let b of this.features){let I=Ze[b.type]==="Polygon",{geometry:E}=b;if(this.wallMode)for(let L of E)for(let F of ye(L,I))this.addFeature(b,[F],b.index,n,l,c,m,_);else this.addFeature(b,E,b.index,n,l,c,m,_)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,n,l,c,m,_,b){this.programConfigurations.updatePaintArrays(e,n,m,l,c,_,b),this.groundEffect.update(e,n,m,l,c,_,b)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,R),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,y.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,D.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,u.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,n,l,c,m,_,b,I){let E=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(e,{})/this.tileToMeter,L=[new Ue(0,0),new Ue(xi,xi)],F=b.projection,V=F.name==="globe",W=this.wallMode||Ze[e.type]==="Polygon",H=new Sn;H.centroidDataIndex=this.centroidData.length;let ee=new Nn,le=this.layers[0].paint.get("fill-extrusion-base").evaluate(e,{},c)<=0,de=this.layers[0].paint.get("fill-extrusion-height").evaluate(e,{},c),Ce;if(ee.height=de,ee.vertexArrayOffset=this.layoutVertexArray.length,ee.groundVertexArrayOffset=this.groundEffect.vertexArray.length,V&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new ts),this.wallMode){if(V)return void Hi("Non zero fill-extrusion-line-width is not yet supported on globe.");if(n.length!==1)return;Ce=function(ut){let xt=ut[0].x===ut[ut.length-1].x&&ut[0].y===ut[ut.length-1].y;(function(Ti){let ui=0,bn=Ti.length;for(let Vi=0;Vi<bn;Vi++)ui+=(Ti[(Vi+1)%bn].x-Ti[Vi].x)*(Ti[(Vi+1)%bn].y+Ti[Vi].y);return ui>=0})(ut)||(ut=ut.reverse());let ri={geometry:[],joinNormals:[],indices:[]},$t=[],Qt=[],hi=[],Rt=ut.length;for(;Rt>=2&&ut[Rt-1].equals(ut[Rt-2]);)Rt--;if(Rt<(xt?3:2))return ri;let Yt,Et,kt,pi,mi,qi=0;for(;qi<Rt-1&&ut[qi].equals(ut[qi+1]);)qi++;xt&&(Yt=ut[Rt-2],mi=ut[qi].sub(Yt)._unit()._perp());for(let Ti=qi;Ti<Rt;Ti++){if(kt=Ti===Rt-1?xt?ut[qi+1]:void 0:ut[Ti+1],kt&&ut[Ti].equals(kt))continue;mi&&(pi=mi),Yt&&(Et=Yt),Yt=ut[Ti],mi=kt?kt.sub(Yt)._unit()._perp():pi,pi=pi||mi;let ui=pi.add(mi);ui.x===0&&ui.y===0||ui._unit();let bn=ui.x*mi.x+ui.y*mi.y,Vi=bn!==0?1/bn:1/0,Ui=pi.x*mi.y-pi.y*mi.x>0,mn="miter",Pn=2;mn==="miter"&&Vi>Pn&&(mn="bevel"),mn==="bevel"&&(Vi>100&&(mn="flipbevel"),Vi<Pn&&(mn="miter"));let Rn=(Zn,kn,zn,$r)=>{let ao=new Ue(Zn.x,Zn.y),Me=new Ue(Zn.x,Zn.y);ao.x+=kn.x*$r,ao.y+=kn.y*$r,Me.x-=kn.x*Math.max(zn,1),Me.y-=kn.y*Math.max(zn,1),hi.push(kn),$t.push(ao),Qt.push(Me)};if(mn==="miter")ui._mult(Vi),Rn(Yt,ui,0,0);else if(mn==="flipbevel")ui=mi.mult(-1),Rn(Yt,ui,0,0),Rn(Yt,ui.mult(-1),0,0);else{let Zn=-Math.sqrt(Vi*Vi-1),kn=Ui?Zn:0,zn=Ui?0:Zn;Et&&Rn(Yt,pi,kn,zn),kt&&Rn(Yt,mi,kn,zn)}}ri.geometry=[...$t,...Qt.reverse(),$t[0]],ri.joinNormals=[...hi,...hi.reverse(),hi[hi.length-1]];let Bi=ri.geometry.length-1;for(let Ti=0;Ti<Bi/2;Ti++)if(Ti+1<Bi/2){let ui=Ti,bn=Ti+1,Vi=Bi-1-Ti,Ui=Bi-2-Ti;ui=ui===0?Bi-1:ui-1,bn=bn===0?Bi-1:bn-1,Vi=Vi===0?Bi-1:Vi-1,Ui=Ui===0?Bi-1:Ui-1,ri.indices.push(Vi),ri.indices.push(bn),ri.indices.push(ui),ri.indices.push(Vi),ri.indices.push(Ui),ri.indices.push(bn)}return ri}(n[0]),n=[Ce.geometry]}let we=(ut,xt)=>ut<(xt.length-1)/2||ut===xt.length-1,ie=this.wallMode?[n]:xp(n,500);for(let ut=ie.length-1;ut>=0;ut--){let xt=ie[ut];(xt.length===0||(me=xt[0]).every(Ft=>Ft.x<=0)||me.every(Ft=>Ft.x>=xi)||me.every(Ft=>Ft.y<=0)||me.every(Ft=>Ft.y>=xi))&&ie.splice(ut,1)}var me;let Ie;if(V)Ie=Ma(ie,L,c);else{Ie=[];for(let ut of ie)Ie.push({polygon:ut,bounds:L})}let ze=W?this.edgeRadius:0,Je=ze>0&&this.zoom<17,st=(ut,xt)=>{if(ut.length===0)return!1;let Ft=ut[ut.length-1];return xt.x===Ft.x&&xt.y===Ft.y};for(let{polygon:ut,bounds:xt}of Ie){let Ft=0,ri=0;for(let Rt of ut)W&&!Rt[0].equals(Rt[Rt.length-1])&&Rt.push(Rt[0]),ri+=W?Rt.length-1:Rt.length;let $t=this.segments.prepareSegment((W?5:4)*ri,this.layoutVertexArray,this.indexArray);ee.footprintSegIdx<0&&(ee.footprintSegIdx=this.footprintSegments.length),ee.polygonSegIdx<0&&(ee.polygonSegIdx=this.polygonSegments.length);let Qt={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},hi=new Hn;if(hi.vertexOffset=this.footprintVertices.length,hi.indexOffset=3*this.footprintIndices.length,hi.ringIndices=[],W){let Rt=[],Yt=[];Ft=$t.vertexLength;for(let kt=0;kt<ut.length;kt++){let pi=ut[kt];pi.length&&kt!==0&&Yt.push(Rt.length/2);let mi=[],qi,Bi;qi=pi[1].sub(pi[0])._perp()._unit(),hi.ringIndices.push(pi.length-1);for(let Ti=1;Ti<pi.length;Ti++){let ui=pi[Ti],bn=pi[Ti===pi.length-1?1:Ti+1],Vi=ui.clone();if(ze){Bi=bn.sub(ui)._perp()._unit();let Ui=qi.add(Bi)._unit(),mn=ze*Math.min(4,1/(qi.x*Ui.x+qi.y*Ui.y));Vi.x+=mn*Ui.x,Vi.y+=mn*Ui.y,Vi.x=Math.round(Vi.x),Vi.y=Math.round(Vi.y),qi=Bi}if(!le||ze!==0&&!Je||st(mi,Vi)||mi.push(Vi),Mi(this.layoutVertexArray,Vi.x,Vi.y,0,0,1,1,0),this.wallMode){let Ui=we(Ti,pi);Zi(this.wallVertexArray,Ce.joinNormals[Ti],!Ui)}$t.vertexLength++,this.footprintVertices.emplaceBack(ui.x,ui.y),Rt.push(ui.x,ui.y),V&&fn(this.layoutVertexExtArray,F.projectTilePoint(Vi.x,Vi.y,c),F.upVector(c,Vi.x,Vi.y))}le&&(ze===0||Je)&&(mi.length!==0&&st(mi,mi[0])&&mi.pop(),this.groundEffect.addData(mi,xt,E))}let Et=this.wallMode?Ce.indices:Ef(Rt,Yt);for(let kt=0;kt<Et.length;kt+=3)this.footprintIndices.emplaceBack(hi.vertexOffset+Et[kt+0],hi.vertexOffset+Et[kt+1],hi.vertexOffset+Et[kt+2]),this.indexArray.emplaceBack(Ft+Et[kt],Ft+Et[kt+2],Ft+Et[kt+1]),$t.primitiveLength++;hi.indexCount+=Et.length,hi.vertexCount+=this.footprintVertices.length-hi.vertexOffset}for(let Rt=0;Rt<ut.length;Rt++){let Yt=ut[Rt];H.startRing(ee,Yt[0]);let Et=Yt.length>4&&Ua(Yt[Yt.length-2],Yt[0],Yt[1]),kt=ze?nl(Yt[Yt.length-2],Yt[0],Yt[1],ze):0,pi=[],mi,qi,Bi;qi=Yt[1].sub(Yt[0])._perp()._unit();let Ti=!0;for(let ui=1,bn=0;ui<Yt.length;ui++){let Vi=Yt[ui-1],Ui=Yt[ui],mn=Yt[ui===Yt.length-1?1:ui+1];if(H.appendEdge(ee,Ui,Vi),da(Ui,Vi,xt)){ze&&(qi=mn.sub(Ui)._perp()._unit(),Ti=!Ti);continue}let Pn=Ui.sub(Vi)._perp(),Rn=Pn.x/(Math.abs(Pn.x)+Math.abs(Pn.y)),Zn=Pn.y>0?1:0,kn=Vi.dist(Ui);if(bn+kn>32768&&(bn=0),ze){Bi=mn.sub(Ui)._perp()._unit();let Me=bs(Vi,Ui,mn,$l(qi,Bi),ze);isNaN(Me)&&(Me=0);let ke=Ui.sub(Vi)._unit();Vi=Vi.add(ke.mult(kt))._round(),Ui=Ui.add(ke.mult(-Me))._round(),kt=Me,qi=Bi,le&&this.zoom>=17&&(st(pi,Vi)||pi.push(Vi),st(pi,Ui)||pi.push(Ui))}let zn=$t.vertexLength,$r=Yt.length>4&&Ua(Vi,Ui,mn),ao=wl(bn,Et,Ti);if(Mi(this.layoutVertexArray,Vi.x,Vi.y,Rn,Zn,0,0,ao),Mi(this.layoutVertexArray,Vi.x,Vi.y,Rn,Zn,0,1,ao),this.wallMode){let Me=we(ui-1,Yt),ke=Ce.joinNormals[ui-1];Zi(this.wallVertexArray,ke,Me),Zi(this.wallVertexArray,ke,Me)}if(bn+=kn,ao=wl(bn,$r,!Ti),Et=$r,Mi(this.layoutVertexArray,Ui.x,Ui.y,Rn,Zn,0,0,ao),Mi(this.layoutVertexArray,Ui.x,Ui.y,Rn,Zn,0,1,ao),this.wallMode){let Me=we(ui,Yt),ke=Ce.joinNormals[ui];Zi(this.wallVertexArray,ke,Me),Zi(this.wallVertexArray,ke,Me)}if($t.vertexLength+=4,this.indexArray.emplaceBack(zn+0,zn+1,zn+2),this.indexArray.emplaceBack(zn+1,zn+3,zn+2),$t.primitiveLength+=2,ze){let Me=Ft+(ui===1?Yt.length-2:ui-2),ke=ui===1?Ft:Me+1;if(this.indexArray.emplaceBack(zn+1,Me,zn+3),this.indexArray.emplaceBack(Me,ke,zn+3),$t.primitiveLength+=2,mi===void 0&&(mi=zn),!da(mn,Yt[ui],xt)){let Nt=ui===Yt.length-1?mi:$t.vertexLength;this.indexArray.emplaceBack(zn+2,zn+3,Nt),this.indexArray.emplaceBack(zn+3,Nt+1,Nt),this.indexArray.emplaceBack(zn+3,ke,Nt+1),$t.primitiveLength+=3}Ti=!Ti}if(V){let Me=this.layoutVertexExtArray,ke=F.projectTilePoint(Vi.x,Vi.y,c),Nt=F.projectTilePoint(Ui.x,Ui.y,c),vi=F.upVector(c,Vi.x,Vi.y),Ci=F.upVector(c,Ui.x,Ui.y);fn(Me,ke,vi),fn(Me,ke,vi),fn(Me,Nt,Ci),fn(Me,Nt,Ci)}}W&&(Ft+=Yt.length-1),le&&ze&&this.zoom>=17&&(pi.length!==0&&st(pi,pi[0])&&pi.pop(),this.groundEffect.addData(pi,xt,E,ze>0))}this.footprintSegments.push(hi),Qt.triangleCount=this.indexArray.length-Qt.triangleArrayOffset,this.polygonSegments.push(Qt),++ee.footprintSegLen,++ee.polygonSegLen}if(ee.vertexCount=this.layoutVertexArray.length-ee.vertexArrayOffset,ee.groundVertexCount=this.groundEffect.vertexArray.length-ee.groundVertexArrayOffset,ee.vertexCount!==0){if(ee.centroidXY=H.borders?gi:this.encodeCentroid(H,ee),this.centroidData.push(ee),H.borders){this.featuresOnBorder.push(H);let ut=this.featuresOnBorder.length-1;for(let xt=0;xt<H.borders.length;xt++)H.borders[xt][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[xt].push(ut)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,l,m,_,c,I),this.groundEffect.addPaintPropertiesData(e,l,m,_,c,I),this.maxHeight=Math.max(this.maxHeight,de)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((n,l)=>this.featuresOnBorder[n].borders[e][0]-this.featuresOnBorder[l].borders[e][0])}splitToSubtiles(){let e=[];for(let b=0;b<this.centroidData.length;b++){let I=this.centroidData[b],E=+(I.min.y+I.max.y>xi),L=2*E+(+(I.min.x+I.max.x>xi)^E);for(let F=0;F<I.polygonSegLen;F++){let V=I.polygonSegIdx+F;e.push({centroidIdx:b,subtile:L,polygonSegmentIdx:V,triangleSegmentIdx:this.polygonSegments[V].triangleSegIdx})}}let n=new zo;e.sort((b,I)=>b.triangleSegmentIdx===I.triangleSegmentIdx?b.subtile-I.subtile:b.triangleSegmentIdx-I.triangleSegmentIdx);let l=0,c=0,m=0;for(let b of e){if(b.triangleSegmentIdx!==l)break;m++}let _=e.length;for(;c!==e.length;){l=e[c].triangleSegmentIdx;let b=0,I=c,E=c;for(let L=I;L<m&&e[L].subtile===b;L++)E++;for(;I!==m;){let L=e[I];b=L.subtile;let F=this.centroidData[L.centroidIdx].min.clone(),V=this.centroidData[L.centroidIdx].max.clone(),W={vertexOffset:this.segments.segments[l].vertexOffset,primitiveOffset:n.length,vertexLength:this.segments.segments[l].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let H=I;H<E;H++){let ee=e[H],le=this.polygonSegments[ee.polygonSegmentIdx],de=this.centroidData[ee.centroidIdx].min,Ce=this.centroidData[ee.centroidIdx].max,we=this.indexArray.uint16;for(let ie=le.triangleArrayOffset;ie<le.triangleArrayOffset+le.triangleCount;ie++)n.emplaceBack(we[3*ie],we[3*ie+1],we[3*ie+2]);W.primitiveLength+=le.triangleCount,F.x=Math.min(F.x,de.x),F.y=Math.min(F.y,de.y),V.x=Math.max(V.x,Ce.x),V.y=Math.max(V.y,Ce.y)}W.primitiveLength>0&&this.triangleSubSegments.push({segment:W,min:F,max:V}),I=E;for(let H=I;H<m&&e[H].subtile===e[I].subtile;H++)E++}c=m;for(let L=c;L<_&&e[L].triangleSegmentIdx===e[c].triangleSegmentIdx;L++)m++}n._trim(),this.indexArray=n}getVisibleSegments(e,n,l){let c=new bo;if(this.wallMode){for(let ee of this.triangleSubSegments)c.segments.push(ee.segment);return c}let m=0,_=0,b=1<<e.canonical.z;if(n){let ee=n.getMinMaxForTile(e);ee&&(m=ee.min,_=ee.max)}_+=this.maxHeight;let I=e.toUnwrapped(),E,L=[I.canonical.x/b+I.wrap,I.canonical.y/b],F=[(I.canonical.x+1)/b+I.wrap,(I.canonical.y+1)/b],V=(ee,le,de)=>[ee[0]*(1-de[0])+le[0]*de[0],ee[1]*(1-de[1])+le[1]*de[1]],W=[],H=[];for(let ee of this.triangleSubSegments){W[0]=ee.min.x/xi,W[1]=ee.min.y/xi,H[0]=ee.max.x/xi,H[1]=ee.max.y/xi;let le=V(L,F,W),de=V(L,F,H);if(new Jr([le[0],le[1],m],[de[0],de[1],_]).intersectsPrecise(l)===0){E&&(c.segments.push(E),E=void 0);continue}let Ce=ee.segment;E&&E.vertexOffset!==Ce.vertexOffset&&(c.segments.push(E),E=void 0),E?(E.vertexLength+=Ce.vertexLength,E.primitiveLength+=Ce.primitiveLength):E={vertexOffset:Ce.vertexOffset,primitiveLength:Ce.primitiveLength,vertexLength:Ce.vertexLength,primitiveOffset:Ce.primitiveOffset,sortKey:void 0,vaos:{}}}return E&&c.segments.push(E),c}encodeCentroid(e,n){let l=e.centroid(),c=n.span(),m=Math.min(7,Math.round(c.x*this.tileToMeter/10)),_=Math.min(7,Math.round(c.y*this.tileToMeter/10));return new Ue(rt(l.x,1,xi-1)<<3|m,rt(l.y,1,xi-1)<<3|_)}encodeBorderCentroid(e){if(!e.borders)return new Ue(0,0);let n=e.borders,l=Number.MAX_VALUE;if(n[0][0]!==l||n[1][0]!==l){let c=n[0][0]!==l?0:1;return new Ue(6|(n[0][0]!==l?0:65528),(n[c][0]+n[c][1])/2<<3|6)}{let c=n[2][0]!==l?2:3;return new Ue((n[c][0]+n[c][1])/2<<3|6,6|(n[2][0]!==l?0:65528))}}showCentroid(e){let n=this.centroidData[e.centroidDataIndex];n.flags&=Fi,n.centroidXY.x=0,n.centroidXY.y=0,this.writeCentroidToBuffer(n)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);let n=e.vertexArrayOffset,l=e.vertexCount+e.vertexArrayOffset,c=e.flags&Fi?gi:e.centroidXY,m=this.centroidVertexArray.geta_centroid_pos0(n);if(this.centroidVertexArray.geta_centroid_pos1(n)!==c.y||m!==c.x){for(let _=n;_<l;++_)this.centroidVertexArray.emplace(_,c.x,c.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,n,l){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;let c=n.getReplacementRegionsForTile(e.toUnwrapped());if(_e(this.activeReplacements,c))return;if(this.activeReplacements=c,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(let _ of this.centroidData)_.flags&=2147483647;let m=[];for(let _ of this.activeReplacements){if(_.order<l)continue;let b=Math.max(1,Math.pow(2,_.footprintTileId.canonical.z-e.canonical.z));for(let I of this.centroidData)if(!(I.flags&Fi||_.min.x>I.max.x||I.min.x>_.max.x||_.min.y>I.max.y||I.min.y>_.max.y))for(let E=0;E<I.footprintSegLen;E++){let L=this.footprintSegments[I.footprintSegIdx+E];if(m.length=0,_c(this.footprintVertices,L.vertexOffset,L.vertexCount,_.footprintTileId.canonical,e.canonical,m),De(_.footprint,m,this.footprintIndices.uint16,L.indexOffset,L.indexCount,-L.vertexOffset,-b)){I.flags|=Fi;break}}}for(let _ of this.centroidData)this.writeCentroidToBuffer(_);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,n,l){let c=!1;for(let m=0;m<l.footprintSegLen;m++){let _=this.footprintSegments[l.footprintSegIdx+m],b=0;for(let I of _.ringIndices){for(let E=b,L=I+b-1;E<I+b;L=E++){let F=this.footprintVertices.int16[2*(E+_.vertexOffset)+0],V=this.footprintVertices.int16[2*(E+_.vertexOffset)+1],W=this.footprintVertices.int16[2*(L+_.vertexOffset)+1];V>n!=W>n&&e<(this.footprintVertices.int16[2*(L+_.vertexOffset)+0]-F)*(n-V)/(W-V)+F&&(c=!c)}b=I}}return c}getHeightAtTileCoord(e,n){let l=Number.NEGATIVE_INFINITY,c=!0,m=4*(e+xi)*xi+(n+xi);if(this.partLookup.hasOwnProperty(m)){let _=this.partLookup[m];return _?{height:_.height,hidden:!!(_.flags&Fi)}:void 0}for(let _ of this.centroidData)e>_.max.x||_.min.x>e||n>_.max.y||_.min.y>n||this.footprintContainsPoint(e,n,_)&&_&&_.height>l&&(l=_.height,this.partLookup[m]=_,c=!!(_.flags&Fi));if(l!==Number.NEGATIVE_INFINITY)return{height:l,hidden:c};this.partLookup[m]=void 0}}function $l(o,e){let n=o.add(e)._unit();return o.x*n.x+o.y*n.y}function nl(o,e,n,l){let c=e.sub(o)._perp()._unit(),m=n.sub(e)._perp()._unit();return bs(o,e,n,$l(c,m),l)}function bs(o,e,n,l,c){let m=Math.sqrt(1-l*l);return Math.min(o.dist(e)/3,e.dist(n)/3,c*m/l)}function da(o,e,n){return o.x<n[0].x&&e.x<n[0].x||o.x>n[1].x&&e.x>n[1].x||o.y<n[0].y&&e.y<n[0].y||o.y>n[1].y&&e.y>n[1].y}function Va(o,e){return o.x<e[0].x||o.x>e[1].x||o.y<e[0].y||o.y>e[1].y}function Ua(o,e,n){if(o.x<0||o.x>=xi||e.x<0||e.x>=xi||n.x<0||n.x>=xi)return!1;let l=n.sub(e),c=l.perp(),m=o.sub(e);return(l.x*m.x+l.y*m.y)/Math.sqrt((l.x*l.x+l.y*l.y)*(m.x*m.x+m.y*m.y))>-.866&&c.x*m.x+c.y*m.y<0}function wl(o,e,n){let l=e?2|o:-3&o;return n?1|l:-2&l}function Oc(){let o=Math.PI/32,e=Math.tan(o),n=re;return n*Math.sqrt(1+2*e*e)-n}function Ma(o,e,n){let l=1<<n.z,c=Ke(n.x/l),m=Ke((n.x+1)/l),_=Qe(n.y/l),b=Qe((n.y+1)/l);return function(I,E,L,F,V=0,W){let H=[];if(!I.length||!L||!F)return H;let ee=(Ie,ze)=>{for(let Je of Ie)H.push({polygon:Je,bounds:ze})},le=Math.ceil(Math.log2(L)),de=Math.ceil(Math.log2(F)),Ce=le-de,we=[];for(let Ie=0;Ie<Math.abs(Ce);Ie++)we.push(Ce>0?0:1);for(let Ie=0;Ie<Math.min(le,de);Ie++)we.push(0),we.push(1);let ie=I;if(ie=qm(ie,E[0].y-V,E[1].y+V,1),ie=qm(ie,E[0].x-V,E[1].x+V,0),!ie.length)return H;let me=[];for(we.length?me.push({polygons:ie,bounds:E,depth:0}):ee(ie,E);me.length;){let Ie=me.pop(),ze=Ie.depth,Je=we[ze],st=Ie.bounds[0],ut=Ie.bounds[1],xt=Je===0?st.x:st.y,Ft=Je===0?ut.x:ut.y,ri=W?W(Je,xt,Ft):.5*(xt+Ft),$t=qm(Ie.polygons,xt-V,ri+V,Je),Qt=qm(Ie.polygons,ri-V,Ft+V,Je);if($t.length){let hi=[st,new Ue(Je===0?ri:ut.x,Je===1?ri:ut.y)];we.length>ze+1?me.push({polygons:$t,bounds:hi,depth:ze+1}):ee($t,hi)}if(Qt.length){let hi=[new Ue(Je===0?ri:st.x,Je===1?ri:st.y),ut];we.length>ze+1?me.push({polygons:Qt,bounds:hi,depth:ze+1}):ee(Qt,hi)}}return H}(o,e,Math.ceil((m-c)/11.25),Math.ceil((_-b)/11.25),1,(I,E,L)=>{if(I===0)return .5*(E+L);{let F=Qe((n.y+E/xi)/l);return(Ve(.5*(Qe((n.y+L/xi)/l)+F))*l-n.y)*xi}})}function _c(o,e,n,l,c,m){let _=Math.pow(2,l.z-c.z);for(let b=0;b<n;b++){let I=o.int16[2*(b+e)+0],E=o.int16[2*(b+e)+1];I=(I+c.x*xi)*_-l.x*xi,E=(E+c.y*xi)*_-l.y*xi,m.push(new Ue(I,E))}}let pa,Pa;Ei(ql,"FillExtrusionBucket",{omit:["layers","features"]}),Ei(Nn,"PartData"),Ei(Hn,"FootprintSegment"),Ei(Sn,"BorderCentroidData"),Ei(il,"GroundEffect");class Ts extends Ue{constructor(e,n,l){super(e,n),this.z=l}}class ta extends Ts{constructor(e,n,l,c){super(e,n,l),this.w=c}}function ns(o,e,n,l){let c=n==="x"?"y":"x",m=(l-o[n])/(e[n]-o[n]);o[c]=Math.round(o[c]+(e[c]-o[c])*m),o[n]=l,o.hasOwnProperty("z")&&(o.z=en(o.z,e.z,m)),o.hasOwnProperty("w")&&(o.w=en(o.w,e.w,m))}function Jh(o,e,n,l){let c=n,m=l;for(let _ of["x","y"]){let b=o,I=e;b[_]>=I[_]&&(b=e,I=o),b[_]<c&&I[_]>c&&ns(b,I,_,c),b[_]<m&&I[_]>m&&ns(I,b,_,m)}}function wp(o,e,n,l,c,m){let _=[];for(let b=0;b<o.length;b++){let I=o[b],E,L=_.length,F=0;for(let V=0;V<I.length-1;V++){let W=I[V],H=I[V+1],ee=0,le=F,de,Ce;m&&(ee=Math.hypot(H.x-W.x,H.y-W.y),F+=ee,de=W,Ce=H),W.x<e&&H.x<e||(W.x<e?W=new Ue(e,W.y+(e-W.x)/(H.x-W.x)*(H.y-W.y))._round():H.x<e&&(H=new Ue(e,W.y+(e-W.x)/(H.x-W.x)*(H.y-W.y))._round()),W.y<n&&H.y<n||(W.y<n?W=new Ue(W.x+(n-W.y)/(H.y-W.y)*(H.x-W.x),n)._round():H.y<n&&(H=new Ue(W.x+(n-W.y)/(H.y-W.y)*(H.x-W.x),n)._round()),W.x>=l&&H.x>=l||(W.x>=l?W=new Ue(l,W.y+(l-W.x)/(H.x-W.x)*(H.y-W.y))._round():H.x>=l&&(H=new Ue(l,W.y+(l-W.x)/(H.x-W.x)*(H.y-W.y))._round()),W.y>=c&&H.y>=c||(W.y>=c?W=new Ue(W.x+(c-W.y)/(H.y-W.y)*(H.x-W.x),c)._round():H.y>=c&&(H=new Ue(W.x+(c-W.y)/(H.y-W.y)*(H.x-W.x),c)._round()),E&&W.equals(E[E.length-1])||(E=[W],_.push(E),m&&m.push({progress:{min:le+zy(de,Ce,W)*ee,max:1},parentIndex:b,prevPoint:de,nextPoint:Ce})),E.push(H),m&&(m[m.length-1].progress.max=le+zy(de,Ce,H)*ee,m[m.length-1].nextPoint=Ce)))))}if(m&&F>0)for(let V=L;V<_.length;V++)m[V].progress.min/=F,m[V].progress.max/=F}return _}function Mu(o,e,n,l,c){if(o.length<2)return void l.push(o);let m=[];for(;e.valid();){let[E,L]=e.get();for(let F=0;F<o.length-1;F++){let V=o[F],W=o[F+1],H=no(V,W,E,L);if(H){let[ee]=H,le=new Ue(en(V.x,W.x,ee),en(V.y,W.y,ee));m.push({t:F+ee,distance:0,point:le})}}e.next()}if(m.length===0)return void l.push(o);m.sort((E,L)=>E.t-L.t);let _=0,b=0,I=[];for(l.push(I);_!==o.length;){if(b===m.length){for(;_!==o.length;)I.length!==0&&I[I.length-1].equals(o[_])||I.push(o[_]),_++;break}m[b].t<=_?(I.length!==0&&I[I.length-1].equals(m[b].point)||I.push(m[b].point),Math.trunc(m[b].t),b++):(I.length!==0&&I[I.length-1].equals(o[_])||I.push(o[_]),_++)}}function zy(o,e,n){return o.x!==e.x?(n.x-o.x)/(e.x-o.x):o.y!==e.y?(n.y-o.y)/(e.y-o.y):0}function md(o,e){return o.x*e.x+o.y*e.y}function tf(o,e){if(o.length===1){let n=0,l=e[n++],c;for(;!c||l.equals(c);)if(c=e[n++],!c)return 1/0;for(;n<e.length;n++){let m=e[n],_=o[0],b=c.sub(l),I=m.sub(l),E=_.sub(l),L=md(b,b),F=md(b,I),V=md(I,I),W=md(E,b),H=md(E,I),ee=L*V-F*F,le=(V*W-F*H)/ee,de=(L*H-F*W)/ee,Ce=l.z*(1-le-de)+c.z*le+m.z*de;if(isFinite(Ce))return Ce}return 1/0}{let n=1/0;for(let l of e)n=Math.min(n,l.z);return n}}function Df(o,e,n,l,c,m,_,b){let I=_*c.getElevationAt(o,e,!0,!0),E=m[0]!==0,L=E?m[1]===0?_*(m[0]/7-450):_*function(F,V,W){let H=Math.floor(V[0]/8),ee=Math.floor(V[1]/8),le=10*(V[0]-8*H),de=10*(V[1]-8*ee),Ce=F.getElevationAt(H,ee,!0,!0),we=F.getMeterToDEM(W),ie=Math.floor(.5*(le*we-1)),me=Math.floor(.5*(de*we-1)),Ie=F.tileCoordToPixel(H,ee),ze=2*ie+1,Je=2*me+1,st=function(Qt,hi,Rt,Yt,Et){return[Qt.getElevationAtPixel(hi,Rt,!0),Qt.getElevationAtPixel(hi+Et,Rt,!0),Qt.getElevationAtPixel(hi,Rt+Et,!0),Qt.getElevationAtPixel(hi+Yt,Rt+Et,!0)]}(F,Ie.x-ie,Ie.y-me,ze,Je),ut=Math.abs(st[0]-st[1]),xt=Math.abs(st[2]-st[3]),Ft=Math.abs(st[0]-st[2])+Math.abs(st[1]-st[3]),ri=Math.min(.25,.5*we*(ut+xt)/ze),$t=Math.min(.25,.5*we*Ft/Je);return Ce+Math.max(ri*le,$t*de)}(c,m,b):I;return{base:I+(n===0?-1:n),top:E?Math.max(L+l,I+n+2):I+l}}let sm=Kn([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),am=Kn([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:Ly}=sm,ky=Kn([{name:"a_packed",components:3,type:"Float32"}]),{members:Oy}=ky,Fy=Kn([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:kg}=Fy;class M_{constructor(e,n){this.width=e,this.height=n,this.nextRow=0,this.image=new Eu({width:e,height:n}),this.positions={},this.uploaded=!1}getDash(e,n){let l=this.getKey(e,n);return this.positions[l]}trim(){let e=this.width,n=this.height=Bt(this.nextRow);this.image.resize({width:e,height:n})}getKey(e,n){return e.join(",")+n}getDashRanges(e,n,l){let c=[],m=e.length%2==1?-e[e.length-1]*l:0,_=e[0]*l,b=!0;c.push({left:m,right:_,isDash:b,zeroLength:e[0]===0});let I=e[0];for(let E=1;E<e.length;E++){b=!b;let L=e[E];m=I*l,I+=L,_=I*l,c.push({left:m,right:_,isDash:b,zeroLength:L===0})}return c}addRoundDash(e,n,l){let c=n/2;for(let m=-l;m<=l;m++){let _=this.width*(this.nextRow+l+m),b=0,I=e[b];for(let E=0;E<this.width;E++){E/I.right>1&&(I=e[++b]);let L=Math.abs(E-I.left),F=Math.abs(E-I.right),V=Math.min(L,F),W,H=m/l*(c+1);if(I.isDash){let ee=c-Math.abs(H);W=Math.sqrt(V*V+ee*ee)}else W=c-Math.sqrt(V*V+H*H);this.image.data[_+E]=Math.max(0,Math.min(255,W+128))}}}addRegularDash(e,n){for(let I=e.length-1;I>=0;--I){let E=e[I],L=e[I+1];E.zeroLength?e.splice(I,1):L&&L.isDash===E.isDash&&(L.left=E.left,e.splice(I,1))}let l=e[0],c=e[e.length-1];l.isDash===c.isDash&&(l.left=c.left-this.width,c.right=l.right+this.width);let m=this.width*this.nextRow,_=0,b=e[_];for(let I=0;I<this.width;I++){I/b.right>1&&(b=e[++_]);let E=Math.abs(I-b.left),L=Math.abs(I-b.right),F=Math.min(E,L);this.image.data[m+I]=Math.max(0,Math.min(255,(b.isDash?F:-F)+n+128))}}addDash(e,n){let l=this.getKey(e,n);if(this.positions[l])return this.positions[l];let c=n==="round",m=c?7:0,_=2*m+1;if(this.nextRow+_>this.height)return Hi("LineAtlas out of space"),null;e.length===0&&e.push(1);let b=0;for(let L=0;L<e.length;L++)e[L]<0&&(Hi("Negative value is found in line dasharray, replacing values with 0"),e[L]=0),b+=e[L];if(b!==0){let L=this.width/b,F=this.getDashRanges(e,this.width,L);c?this.addRoundDash(F,L,m):this.addRegularDash(F,n==="square"?.5*L:0)}let I=this.nextRow+m;this.nextRow+=_;let E={tl:[I,m],br:[b,0]};return this.positions[l]=E,E}}Ei(M_,"LineAtlas");let Tp=bp.VectorTileFeature.types,By=Math.cos(Math.PI/180*37.5),Ny=Math.cos(Math.PI/180*5);class Og{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(n=>{this.gradients[n.id]={}}),this.layoutVertexArray=new vh,this.layoutVertexArray2=new So,this.patternVertexArray=new So,this.indexArray=new zo,this.programConfigurations=new hp(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new bo,this.maxLineLength=0,this.zOffsetVertexArray=new So,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:xi/64}updateFootprints(e,n){}populate(e,n,l,c){this.hasPattern=__("line",this.layers,this.pixelRatio,n);let m=this.layers[0].layout.get("line-sort-key");this.tileToMeter=vt(l);let _=this.layers[0].layout.get("line-elevation-reference");if(_==="hd-road-markup")this.elevationType="road";else{let V=this.layers[0].layout.get("line-z-offset"),W=V.isConstant()&&!V.constantOr(0);this.elevationType=_!=="sea"&&_!=="ground"&&W?"none":"offset",this.elevationType==="offset"&&_==="none"&&Hi(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}let b=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&b!==void 0;let I=[];for(let{feature:V,id:W,index:H,sourceLayerIndex:ee}of e){let le=this.layers[0]._featureFilter.needGeometry,de=ji(V,le);if(!this.layers[0]._featureFilter.filter(new J(this.zoom),de,l))continue;let Ce=m?m.evaluate(de,{},l):void 0,we={id:W,properties:V.properties,type:V.type,sourceLayerIndex:ee,index:H,geometry:le?de.geometry:ki(V,l,c),patterns:{},sortKey:Ce};I.push(we)}m&&I.sort((V,W)=>V.sortKey-W.sortKey);let{lineAtlas:E,featureIndex:L}=n,F=this.addConstantDashes(E);for(let V of I){let{geometry:W,index:H,sourceLayerIndex:ee}=V;if(F&&this.addFeatureDashes(V,E),this.hasPattern){let le=g_("line",this.layers,V,this.zoom,this.pixelRatio,n);this.patternFeatures.push(le)}else this.addFeature(V,W,H,l,E.positions,n.availableImages,n.brightness,n.elevationFeatures);L.insert(e[H].feature,W,H,ee,this.index)}}addConstantDashes(e){let n=!1;for(let l of this.layers){let c=l.paint.get("line-dasharray").value,m=l.layout.get("line-cap").value;if(c.kind!=="constant"||m.kind!=="constant")n=!0;else{let _=m.value,b=c.value;if(!b)continue;e.addDash(b,_)}}return n}addFeatureDashes(e,n){let l=this.zoom;for(let c of this.layers){let m=c.paint.get("line-dasharray").value,_=c.layout.get("line-cap").value;if(m.kind==="constant"&&_.kind==="constant")continue;let b,I;if(m.kind==="constant"){if(b=m.value,!b)continue}else b=m.evaluate({zoom:l},e);I=_.kind==="constant"?_.value:_.evaluate({zoom:l},e),n.addDash(b,I),e.patterns[c.id]=[n.getKey(b,I)]}}update(e,n,l,c,m,_,b){this.programConfigurations.updatePaintArrays(e,n,m,l,c,_,b)}addFeatures(e,n,l,c,m,_){for(let b of this.patternFeatures)this.addFeature(b,b.geometry,b.index,n,l,c,_)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,Oy)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,kg)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,am.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Ly),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,n,l,c,m,_,b,I){let E=this.layers[0].layout,L=E.get("line-join").evaluate(e,{}),F=E.get("line-cap").evaluate(e,{}),V=E.get("line-miter-limit"),W=E.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e,this.zOffsetValue=E.get("line-z-offset").value;let H=this.layers[0].paint.get("line-width").value;if(H.kind!=="constant"&&H.isLineProgressConstant===!1&&(this.variableWidthValue=H),this.elevationType==="road"){let ee=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,n,c,I,L,F,V,W)){let[le,de]=this.clipRuntimeLinesToTile(n,1);for(let Ce=0;Ce<le.length;Ce++){let we=le[Ce],ie=de[Ce],me={progress:{min:ie.progress.min,max:ie.progress.max},nextDir:this.computeSegNextDir(ie,we),prevDir:this.computeSegPrevDir(ie,we)};this.addLine(we,e,c,L,F,V,W,me)}this.fillNonElevatedRoadSegment(ee)}}else for(let ee of n)this.addLine(ee,e,c,L,F,V,W);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,l,m,_,c,b)}computeSegNextDir(e,n){return e.nextPoint.sub(n.at(-2)).unit()}computeSegPrevDir(e,n){return n[1].sub(e.prevPoint).unit()}clipLinesToTile(e,n){return wp(e,-n,-n,xi+n,xi+n)}clipRuntimeLinesToTile(e,n){let l=[];return[wp(e,-n,-n,xi+n,xi+n,l),l]}addElevatedRoadFeature(e,n,l,c,m,_,b,I){let E=[],L=Na.getElevationFeature(e,c);if(L){let F=this.clipLinesToTile(n,1),V=this.prepareElevatedLines(F,L,l);for(let W of V)E.push({geometry:W,elevation:L,elevationTileID:l,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(E.length===0)return!1;for(let F of E){let V=this.layoutVertexArray.length;this.addLine(F.geometry,e,l,m,_,b,I);let W=new T_(l,F.elevationTileID);if(F.elevation)for(let H=V;H<this.layoutVertexArray.length;H++){let ee=new Ue(this.layoutVertexArray.int16[6*H]>>1,this.layoutVertexArray.int16[6*H+1]>>1),le=W.pointElevation(ee,F.elevation,.05);this.updateHeightRange(le),this.zOffsetVertexArray.emplaceBack(le,0,0)}else this.fillNonElevatedRoadSegment(V)}return!0}prepareElevatedLines(e,n,l){if(n.constantHeight!=null)return e;let c=[],m=1/vt(l);for(let _ of e)Mu(_,new Ay(n,m),0,c);return c}fillNonElevatedRoadSegment(e){for(let n=e;n<this.layoutVertexArray.length;n++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,n,l,c,m,_,b,I){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;let E=c==="none";this.patternJoinNone=this.hasPattern&&E,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];let L=I&&I.progress.min>0,F=I&&I.progress.max<1;if(this.lineClips){let Je={min:this.lineClips.start,max:this.lineClips.end},st=1;if(I){let Ft=this.lineClips.end-this.lineClips.start;Je=function(ri,$t,Qt){return{min:_s(ri.min,$t,Qt),max:_s(ri.max,$t,Qt)}}(I.progress,{min:0,max:1},Je),Ft>0&&(st=(Je.max-Je.min)/Ft)}let ut=+n.properties.mapbox_clip_feature_len,xt=+n.properties.mapbox_clip_seg_len;if(Number.isNaN(ut)||Number.isNaN(xt)){for(let ri=0;ri<e.length-1;ri++)this.totalDistance+=e[ri].dist(e[ri+1]);let Ft=this.totalDistance/(Je.max-Je.min);this.totalFeatureLength=Number.isFinite(Ft)?Ft:0,this.lineClips.start=Je.min,this.lineClips.end=Je.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=ut,this.distance=xt*st,this.lineClips.start=Je.min,this.lineClips.end=Je.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}let V=Tp[n.type]==="Polygon",W=e.length;for(;W>=2&&e[W-1].equals(e[W-2]);)W--;let H=0;for(;H<W-1&&e[H].equals(e[H+1]);)H++;if(W<(V?3:2))return;c==="bevel"&&(_=1.05);let ee=this.segments.prepareSegment(10*W,this.layoutVertexArray,this.indexArray),le,de,Ce,we,ie,me,Ie,ze;I&&I.prevDir&&(me=I.prevDir.perp()),I&&I.nextDir&&(Ie=I.nextDir.perp()),this.e1=this.e2=-1,V&&(le=e[W-2],ie=e[H].sub(le)._unit()._perp());for(let Je=H;Je<W;Je++){if(Ce=Je===W-1?V?e[H+1]:void 0:e[Je+1],Ce&&e[Je].equals(Ce))continue;ie&&(we=ie),le&&(de=le),le=e[Je],ze=this.evaluateLineProgressFeatures(de?de.dist(le):0),ie=Ce?Ce.sub(le)._unit()._perp():we,we=we||ie;let st=de&&Ce,ut=st?c:V||E?"butt":m,xt=we.x*ie.x+we.y*ie.y;if(E){let Et=function(kt){if(kt.patternJoinNone){let pi=kt.segmentPoints.length/2,mi=kt.lineSoFar-kt.segmentStart;for(let qi=0;qi<pi;++qi){let Bi=kt.segmentPoints[2*qi+1],Ti=Math.round(kt.segmentPoints[2*qi])+.5+.25*Bi;kt.patternVertexArray.emplaceBack(Ti,mi,kt.segmentStart),kt.patternVertexArray.emplaceBack(Ti,mi,kt.segmentStart)}kt.segmentPoints.length=0}kt.e1=kt.e2=-1};if(st&&xt<Ny){this.updateDistance(de,le),this.addCurrentVertex(le,we,1,1,ee,ze),Et(this),this.addCurrentVertex(le,ie,-1,-1,ee,ze);continue}if(de){if(!Ce){this.updateDistance(de,le),this.addCurrentVertex(le,we,1,1,ee,ze),Et(this);continue}ut="miter"}}let Ft=we.add(ie);Ft.x===0&&Ft.y===0||Ft._unit();let ri=Ft.x*ie.x+Ft.y*ie.y,$t=ri!==0?1/ri:1/0,Qt=2*Math.sqrt(2-2*ri),hi=ri<By&&de&&Ce,Rt=we.x*ie.y-we.y*ie.x>0,Yt=this.overscaling<=16?15*xi/(512*this.overscaling):0;if(st&&ut==="round"){if($t<b)ut="miter";else if($t<=2){let Et=Fg(le,-10,xi+10);ut=this.elevationType==="offset"&&(Et||this.hasCrossSlope)?"miter":"fakeround"}}if(ut==="miter"&&$t>_&&(ut="bevel"),ut==="bevel"&&($t>2&&(ut="flipbevel"),$t<_&&(ut="miter")),de&&!(ut==="miter"&&hi)&&this.updateDistance(de,le),ut==="miter")if(hi){let Et=le.dist(de);if(Et>2*Yt){let pi=le.sub(le.sub(de)._mult(Yt/Et)._round());this.updateDistance(de,pi),this.addCurrentVertex(pi,we,0,0,ee,ze),de=pi}this.updateDistance(de,le),Ft._mult($t),this.addCurrentVertex(le,Ft,0,0,ee,ze);let kt=le.dist(Ce);if(kt>2*Yt){let pi=le.add(Ce.sub(le)._mult(Yt/kt)._round());this.updateDistance(le,pi),this.addCurrentVertex(pi,ie,0,0,ee,ze),le=pi}}else Ft._mult($t),this.addCurrentVertex(le,Ft,0,0,ee,ze);else if(ut==="flipbevel"){if($t>100)Ft=ie.mult(-1);else{let Et=$t*we.add(ie).mag()/we.sub(ie).mag();Ft._perp()._mult(Et*(Rt?-1:1))}this.addCurrentVertex(le,Ft,0,0,ee,ze),this.addCurrentVertex(le,Ft.mult(-1),0,0,ee,ze)}else if(ut==="bevel"||ut==="fakeround"){ze!=null&&de&&this.addCurrentVertex(le,Ie||we,-1,-1,ee,ze);let Et=le.dist(de)<=2*Yt&&ut!=="bevel",kt=Ft.mult(Rt?1:-1);kt._mult($t);let pi=ie.mult(Rt?-1:1),mi=we.mult(Rt?-1:1),qi=this.evaluateLineProgressFeatures(this.distance);if(ze==null&&(this.addHalfVertex(le,kt.x,kt.y,!1,!Rt,0,ee,qi),Et||this.addHalfVertex(le,kt.x+2*mi.x,kt.y+2*mi.y,!1,Rt,0,ee,qi)),ut==="fakeround"){let Bi=Math.round(180*Qt/Math.PI/20);this.addHalfVertex(le,mi.x,mi.y,!1,Rt,0,ee,qi);for(let Ti=0;Ti<Bi;Ti++){let ui=Ti/Bi;if(ui!==.5){let Vi=ui-.5;ui+=ui*Vi*(ui-1)*((1.0904+xt*(xt*(3.55645-1.43519*xt)-3.2452))*Vi*Vi+(.848013+xt*(.215638*xt-1.06021)))}let bn=pi.sub(mi)._mult(ui)._add(mi)._unit();this.addHalfVertex(le,bn.x,bn.y,!1,Rt,0,ee,qi)}this.addHalfVertex(le,pi.x,pi.y,!1,Rt,0,ee,qi)}Et||ze!=null||this.addHalfVertex(le,kt.x+2*pi.x,kt.y+2*pi.y,!1,Rt,0,ee,qi),ze!=null&&Ce&&this.addCurrentVertex(le,me||ie,1,1,ee,ze)}else if(ut==="butt")this.addCurrentVertex(le,Ft,0,0,ee,ze);else if(ut==="square"){if(!de){let Et=L?0:-1;this.addCurrentVertex(le,Ft,Et,Et,ee,ze)}if(this.addCurrentVertex(le,Ft,0,0,ee,ze),de){let Et=F?0:1;this.addCurrentVertex(le,Ft,Et,Et,ee,ze)}}else if(ut==="round"){if(de){let Et=!st&&Ie?Ie:we;this.addCurrentVertex(le,Et,0,0,ee,ze),!st&&F||this.addCurrentVertex(le,Et,1,1,ee,ze,!0)}if(Ce){let Et=!st&&me?me:ie;!st&&L||this.addCurrentVertex(le,Et,-1,-1,ee,ze,!0),this.addCurrentVertex(le,Et,0,0,ee,ze)}}}}addVerticesTo(e,n,l,c,m,_,b,I,E,L){let F=(n.w-e.w)/this.tessellationStep|0,V=0,W=this.scaledDistance;if(F>1){this.lineSoFar=e.w;let ee=(n.x-e.x)/F,le=(n.y-e.y)/F,de=(n.z-e.z)/F,Ce=(n.w-e.w)/F;for(let we=1;we<F;++we){e.x+=ee,e.y+=le,e.z+=de,this.lineSoFar+=Ce,V+=Ce;let ie=this.evaluateLineProgressFeatures(this.prevDistance+V);this.scaledDistance=(this.prevDistance+V)/this.totalDistance,this.addHalfVertex(e,l,c,L,!1,b,E,ie),this.addHalfVertex(e,m,_,L,!0,-I,E,ie)}}this.lineSoFar=n.w,this.scaledDistance=W;let H=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(n,l,c,L,!1,b,E,H),this.addHalfVertex(n,m,_,L,!0,-I,E,H)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):Hi(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let n=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(n=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:n}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:n}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:n}}addCurrentVertex(e,n,l,c,m,_,b=!1){let I=n.x+n.y*l,E=n.y-n.x*l,L=n.y*c-n.x,F=-n.y-n.x*c;if(_!=null){let V=this.elevationType==="offset",W=-10,H=xi+10,ee=_.zOffset,le=new ta(e.x,e.y,ee,this.lineSoFar),de=!!V&&Fg(e,W,H),Ce=this.lineSoFar,we=this.distance;if(this.currentVertex)if(de){let ie=this.currentVertexIsOutside,me=this.currentVertex,Ie=new ta(e.x,e.y,ee,this.lineSoFar);if(Jh(me,Ie,W,H),!Fg(Ie,W,H)){if(ie){this.e1=this.e2=-1,this.distance-=me.dist(le),this.lineSoFar=me.w;let ze=this.evaluateLineProgressFeatures(me.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(me,I,E,b,!1,l,m,ze),this.addHalfVertex(me,L,F,b,!0,-c,m,ze),this.prevDistance=this.distance}this.distance=this.prevDistance+me.dist(Ie),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(me,Ie,I,E,L,F,l,c,m,b),this.distance=we,this.scaledDistance=this.distance/this.totalDistance}}else{let ie=this.currentVertex;if(this.currentVertexIsOutside){Jh(ie,le,W,H),this.e1=this.e2=-1,this.distance-=ie.dist(le),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=ie.w;let me=this.evaluateLineProgressFeatures(ie.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(ie,I,E,b,!1,l,m,me),this.addHalfVertex(ie,L,F,b,!0,-c,m,me),this.prevDistance=this.distance,this.distance=we,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(ie,le,I,E,L,F,l,c,m,b)}else de||(this.addHalfVertex(e,I,E,b,!1,l,m,_),this.addHalfVertex(e,L,F,b,!0,-c,m,_));this.currentVertex=le,this.currentVertexIsOutside=de,this.lineSoFar=Ce}else this.addHalfVertex(e,I,E,b,!1,l,m,_),this.addHalfVertex(e,L,F,b,!0,-c,m,_)}addHalfVertex({x:e,y:n},l,c,m,_,b,I,E){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),_||this.segmentPoints.push(this.lineSoFar-this.segmentStart,b)),this.layoutVertexArray.emplaceBack((e<<1)+(m?1:0),(n<<1)+(_?1:0),Math.round(63*l)+128,Math.round(63*c)+128,1+(b===0?0:b<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){let F=en(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,F)}let L=I.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,L),I.primitiveLength++),_?this.e2=L:this.e1=L,E!=null&&this.zOffsetVertexArray.emplaceBack(E.zOffset,E.variableWidth,E.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,n){this.prevDistance=this.distance,this.distance+=e.dist(n),this.updateScaledDistance()}}function Fg(o,e,n){return o.x<e||o.x>n||o.y<e||o.y>n}let Vy,Uy;function jy(o,e,n){return e*(xi/(o.tileSize*Math.pow(2,n-o.tileID.overscaledZ)))}Ei(Og,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});let Gy=(o,e,n)=>(1-n)*o+n*e;function Zy(o,e){return 1/jy(o,1,e.tileZoom)}function qy(o,e,n,l){return o.translatePosMatrix(l||e.tileID.projMatrix,e,n.paint.get("line-translate"),n.paint.get("line-translate-anchor"))}let Qh=o=>{let e=[];Xm(o)&&e.push("RENDER_LINE_DASH"),o.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");let n=o.paint.get("line-trim-offset");n[0]===0&&n[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),o.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");let l=o.layout.get("line-join").constantOr("miter")==="none",c=!!o.paint.get("line-pattern").constantOr(1);return l&&c&&e.push("LINE_JOIN_NONE"),e};function Xm(o){let e=o.paint.get("line-dasharray").value;return e.value||e.kind!=="constant"}let P_,$y=()=>P_||(P_={layout:Vy||(Vy=new dt({"line-cap":new Be(xe.layout_line["line-cap"]),"line-join":new Be(xe.layout_line["line-join"]),"line-miter-limit":new Se(xe.layout_line["line-miter-limit"]),"line-round-limit":new Se(xe.layout_line["line-round-limit"]),"line-sort-key":new Be(xe.layout_line["line-sort-key"]),"line-z-offset":new Be(xe.layout_line["line-z-offset"]),"line-elevation-reference":new Se(xe.layout_line["line-elevation-reference"]),"line-cross-slope":new Se(xe.layout_line["line-cross-slope"]),visibility:new Se(xe.layout_line.visibility),"line-width-unit":new Se(xe.layout_line["line-width-unit"])})),paint:Uy||(Uy=new dt({"line-opacity":new Be(xe.paint_line["line-opacity"]),"line-color":new Be(xe.paint_line["line-color"]),"line-translate":new Se(xe.paint_line["line-translate"]),"line-translate-anchor":new Se(xe.paint_line["line-translate-anchor"]),"line-width":new Be(xe.paint_line["line-width"]),"line-gap-width":new Be(xe.paint_line["line-gap-width"]),"line-offset":new Be(xe.paint_line["line-offset"]),"line-blur":new Be(xe.paint_line["line-blur"]),"line-dasharray":new Be(xe.paint_line["line-dasharray"]),"line-pattern":new Be(xe.paint_line["line-pattern"]),"line-pattern-cross-fade":new Se(xe.paint_line["line-pattern-cross-fade"]),"line-gradient":new ft(xe.paint_line["line-gradient"]),"line-trim-offset":new Se(xe.paint_line["line-trim-offset"]),"line-trim-fade-range":new Se(xe.paint_line["line-trim-fade-range"]),"line-trim-color":new Se(xe.paint_line["line-trim-color"]),"line-emissive-strength":new Se(xe.paint_line["line-emissive-strength"]),"line-border-width":new Be(xe.paint_line["line-border-width"]),"line-border-color":new Be(xe.paint_line["line-border-color"]),"line-occlusion-opacity":new Se(xe.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"})}))},P_);class sx extends Be{possiblyEvaluate(e,n){return n=new J(Math.floor(n.zoom),{now:n.now,fadeDuration:n.fadeDuration,transition:n.transition}),super.possiblyEvaluate(e,n)}evaluate(e,n,l,c){return n=wt({},n,{zoom:Math.floor(n.zoom)}),super.evaluate(e,n,l,c)}}let Km;function cl(o,e){return e>0?e+2*o:o}let Sh=Kn([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Rf=Kn([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),Pu=Kn([{name:"a_projected_pos",components:4,type:"Float32"}],4);Kn([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);let zf=Kn([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),_d=Kn([{name:"a_texb",components:2,type:"Uint16"}]),Pw=Kn([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),Aw=Kn([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);Kn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);let pv=Kn([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Dw=Kn([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Kn([{name:"triangle",components:3,type:"Uint16"}]),Kn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Kn([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),Kn([{type:"Float32",name:"offsetX"}]),Kn([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var ja=24;function Rw(o,e,n){return o.sections.forEach(l=>{l.text=function(c,m,_){let b=m.layout.get("text-transform").evaluate(_,{});return b==="uppercase"?c=c.toLocaleUpperCase():b==="lowercase"&&(c=c.toLocaleLowerCase()),q.applyArabicShaping&&(c=q.applyArabicShaping(c)),c}(l.text,e,n)}),o}let Bg={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42","\u2190":"\u2191","\u2192":"\u2193"};function zw(o){return o==="\uFE36"||o==="\uFE48"||o==="\uFE38"||o==="\uFE44"||o==="\uFE42"||o==="\uFE3E"||o==="\uFE3C"||o==="\uFE3A"||o==="\uFE18"||o==="\uFE40"||o==="\uFE10"||o==="\uFE13"||o==="\uFE14"||o==="\uFF40"||o==="\uFFE3"||o==="\uFE11"||o==="\uFE12"}function Lw(o){return o==="\uFE35"||o==="\uFE47"||o==="\uFE37"||o==="\uFE43"||o==="\uFE41"||o==="\uFE3D"||o==="\uFE3B"||o==="\uFE39"||o==="\uFE17"||o==="\uFE3F"}var fv,ax,mv,lx={};function kw(){return fv||(fv=1,lx.read=function(o,e,n,l,c){var m,_,b=8*c-l-1,I=(1<<b)-1,E=I>>1,L=-7,F=n?c-1:0,V=n?-1:1,W=o[e+F];for(F+=V,m=W&(1<<-L)-1,W>>=-L,L+=b;L>0;m=256*m+o[e+F],F+=V,L-=8);for(_=m&(1<<-L)-1,m>>=-L,L+=l;L>0;_=256*_+o[e+F],F+=V,L-=8);if(m===0)m=1-E;else{if(m===I)return _?NaN:1/0*(W?-1:1);_+=Math.pow(2,l),m-=E}return(W?-1:1)*_*Math.pow(2,m-l)},lx.write=function(o,e,n,l,c,m){var _,b,I,E=8*m-c-1,L=(1<<E)-1,F=L>>1,V=c===23?Math.pow(2,-24)-Math.pow(2,-77):0,W=l?0:m-1,H=l?1:-1,ee=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(b=isNaN(e)?1:0,_=L):(_=Math.floor(Math.log(e)/Math.LN2),e*(I=Math.pow(2,-_))<1&&(_--,I*=2),(e+=_+F>=1?V/I:V*Math.pow(2,1-F))*I>=2&&(_++,I/=2),_+F>=L?(b=0,_=L):_+F>=1?(b=(e*I-1)*Math.pow(2,c),_+=F):(b=e*Math.pow(2,F-1)*Math.pow(2,c),_=0));c>=8;o[n+W]=255&b,W+=H,b/=256,c-=8);for(_=_<<c|b,E+=c;E>0;o[n+W]=255&_,W+=H,_/=256,E-=8);o[n+W-H]|=128*ee}),lx}function _v(){if(mv)return ax;mv=1,ax=e;var o=kw();function e(ie){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(ie)?ie:new Uint8Array(ie||0),this.pos=0,this.type=0,this.length=this.buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var n=4294967296,l=1/n,c=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function m(ie){return ie.type===e.Bytes?ie.readVarint()+ie.pos:ie.pos+1}function _(ie,me,Ie){return Ie?4294967296*me+(ie>>>0):4294967296*(me>>>0)+(ie>>>0)}function b(ie,me,Ie){var ze=me<=16383?1:me<=2097151?2:me<=268435455?3:Math.floor(Math.log(me)/(7*Math.LN2));Ie.realloc(ze);for(var Je=Ie.pos-1;Je>=ie;Je--)Ie.buf[Je+ze]=Ie.buf[Je]}function I(ie,me){for(var Ie=0;Ie<ie.length;Ie++)me.writeVarint(ie[Ie])}function E(ie,me){for(var Ie=0;Ie<ie.length;Ie++)me.writeSVarint(ie[Ie])}function L(ie,me){for(var Ie=0;Ie<ie.length;Ie++)me.writeFloat(ie[Ie])}function F(ie,me){for(var Ie=0;Ie<ie.length;Ie++)me.writeDouble(ie[Ie])}function V(ie,me){for(var Ie=0;Ie<ie.length;Ie++)me.writeBoolean(ie[Ie])}function W(ie,me){for(var Ie=0;Ie<ie.length;Ie++)me.writeFixed32(ie[Ie])}function H(ie,me){for(var Ie=0;Ie<ie.length;Ie++)me.writeSFixed32(ie[Ie])}function ee(ie,me){for(var Ie=0;Ie<ie.length;Ie++)me.writeFixed64(ie[Ie])}function le(ie,me){for(var Ie=0;Ie<ie.length;Ie++)me.writeSFixed64(ie[Ie])}function de(ie,me){return(ie[me]|ie[me+1]<<8|ie[me+2]<<16)+16777216*ie[me+3]}function Ce(ie,me,Ie){ie[Ie]=me,ie[Ie+1]=me>>>8,ie[Ie+2]=me>>>16,ie[Ie+3]=me>>>24}function we(ie,me){return(ie[me]|ie[me+1]<<8|ie[me+2]<<16)+(ie[me+3]<<24)}return e.prototype={destroy:function(){this.buf=null},readFields:function(ie,me,Ie){for(Ie=Ie||this.length;this.pos<Ie;){var ze=this.readVarint(),Je=ze>>3,st=this.pos;this.type=7&ze,ie(Je,me,this),this.pos===st&&this.skip(ze)}return me},readMessage:function(ie,me){return this.readFields(ie,me,this.readVarint()+this.pos)},readFixed32:function(){var ie=de(this.buf,this.pos);return this.pos+=4,ie},readSFixed32:function(){var ie=we(this.buf,this.pos);return this.pos+=4,ie},readFixed64:function(){var ie=de(this.buf,this.pos)+de(this.buf,this.pos+4)*n;return this.pos+=8,ie},readSFixed64:function(){var ie=de(this.buf,this.pos)+we(this.buf,this.pos+4)*n;return this.pos+=8,ie},readFloat:function(){var ie=o.read(this.buf,this.pos,!0,23,4);return this.pos+=4,ie},readDouble:function(){var ie=o.read(this.buf,this.pos,!0,52,8);return this.pos+=8,ie},readVarint:function(ie){var me,Ie,ze=this.buf;return me=127&(Ie=ze[this.pos++]),Ie<128?me:(me|=(127&(Ie=ze[this.pos++]))<<7,Ie<128?me:(me|=(127&(Ie=ze[this.pos++]))<<14,Ie<128?me:(me|=(127&(Ie=ze[this.pos++]))<<21,Ie<128?me:function(Je,st,ut){var xt,Ft,ri=ut.buf;if(xt=(112&(Ft=ri[ut.pos++]))>>4,Ft<128||(xt|=(127&(Ft=ri[ut.pos++]))<<3,Ft<128)||(xt|=(127&(Ft=ri[ut.pos++]))<<10,Ft<128)||(xt|=(127&(Ft=ri[ut.pos++]))<<17,Ft<128)||(xt|=(127&(Ft=ri[ut.pos++]))<<24,Ft<128)||(xt|=(1&(Ft=ri[ut.pos++]))<<31,Ft<128))return _(Je,xt,st);throw new Error("Expected varint not more than 10 bytes")}(me|=(15&(Ie=ze[this.pos]))<<28,ie,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var ie=this.readVarint();return ie%2==1?(ie+1)/-2:ie/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var ie=this.readVarint()+this.pos,me=this.pos;return this.pos=ie,ie-me>=12&&c?function(Ie,ze,Je){return c.decode(Ie.subarray(ze,Je))}(this.buf,me,ie):function(Ie,ze,Je){for(var st="",ut=ze;ut<Je;){var xt,Ft,ri,$t=Ie[ut],Qt=null,hi=$t>239?4:$t>223?3:$t>191?2:1;if(ut+hi>Je)break;hi===1?$t<128&&(Qt=$t):hi===2?(192&(xt=Ie[ut+1]))==128&&(Qt=(31&$t)<<6|63&xt)<=127&&(Qt=null):hi===3?(Ft=Ie[ut+2],(192&(xt=Ie[ut+1]))==128&&(192&Ft)==128&&((Qt=(15&$t)<<12|(63&xt)<<6|63&Ft)<=2047||Qt>=55296&&Qt<=57343)&&(Qt=null)):hi===4&&(Ft=Ie[ut+2],ri=Ie[ut+3],(192&(xt=Ie[ut+1]))==128&&(192&Ft)==128&&(192&ri)==128&&((Qt=(15&$t)<<18|(63&xt)<<12|(63&Ft)<<6|63&ri)<=65535||Qt>=1114112)&&(Qt=null)),Qt===null?(Qt=65533,hi=1):Qt>65535&&(Qt-=65536,st+=String.fromCharCode(Qt>>>10&1023|55296),Qt=56320|1023&Qt),st+=String.fromCharCode(Qt),ut+=hi}return st}(this.buf,me,ie)},readBytes:function(){var ie=this.readVarint()+this.pos,me=this.buf.subarray(this.pos,ie);return this.pos=ie,me},readPackedVarint:function(ie,me){if(this.type!==e.Bytes)return ie.push(this.readVarint(me));var Ie=m(this);for(ie=ie||[];this.pos<Ie;)ie.push(this.readVarint(me));return ie},readPackedSVarint:function(ie){if(this.type!==e.Bytes)return ie.push(this.readSVarint());var me=m(this);for(ie=ie||[];this.pos<me;)ie.push(this.readSVarint());return ie},readPackedBoolean:function(ie){if(this.type!==e.Bytes)return ie.push(this.readBoolean());var me=m(this);for(ie=ie||[];this.pos<me;)ie.push(this.readBoolean());return ie},readPackedFloat:function(ie){if(this.type!==e.Bytes)return ie.push(this.readFloat());var me=m(this);for(ie=ie||[];this.pos<me;)ie.push(this.readFloat());return ie},readPackedDouble:function(ie){if(this.type!==e.Bytes)return ie.push(this.readDouble());var me=m(this);for(ie=ie||[];this.pos<me;)ie.push(this.readDouble());return ie},readPackedFixed32:function(ie){if(this.type!==e.Bytes)return ie.push(this.readFixed32());var me=m(this);for(ie=ie||[];this.pos<me;)ie.push(this.readFixed32());return ie},readPackedSFixed32:function(ie){if(this.type!==e.Bytes)return ie.push(this.readSFixed32());var me=m(this);for(ie=ie||[];this.pos<me;)ie.push(this.readSFixed32());return ie},readPackedFixed64:function(ie){if(this.type!==e.Bytes)return ie.push(this.readFixed64());var me=m(this);for(ie=ie||[];this.pos<me;)ie.push(this.readFixed64());return ie},readPackedSFixed64:function(ie){if(this.type!==e.Bytes)return ie.push(this.readSFixed64());var me=m(this);for(ie=ie||[];this.pos<me;)ie.push(this.readSFixed64());return ie},skip:function(ie){var me=7&ie;if(me===e.Varint)for(;this.buf[this.pos++]>127;);else if(me===e.Bytes)this.pos=this.readVarint()+this.pos;else if(me===e.Fixed32)this.pos+=4;else{if(me!==e.Fixed64)throw new Error("Unimplemented type: "+me);this.pos+=8}},writeTag:function(ie,me){this.writeVarint(ie<<3|me)},realloc:function(ie){for(var me=this.length||16;me<this.pos+ie;)me*=2;if(me!==this.length){var Ie=new Uint8Array(me);Ie.set(this.buf),this.buf=Ie,this.length=me}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(ie){this.realloc(4),Ce(this.buf,ie,this.pos),this.pos+=4},writeSFixed32:function(ie){this.realloc(4),Ce(this.buf,ie,this.pos),this.pos+=4},writeFixed64:function(ie){this.realloc(8),Ce(this.buf,-1&ie,this.pos),Ce(this.buf,Math.floor(ie*l),this.pos+4),this.pos+=8},writeSFixed64:function(ie){this.realloc(8),Ce(this.buf,-1&ie,this.pos),Ce(this.buf,Math.floor(ie*l),this.pos+4),this.pos+=8},writeVarint:function(ie){(ie=+ie||0)>268435455||ie<0?function(me,Ie){var ze,Je;if(me>=0?(ze=me%4294967296|0,Je=me/4294967296|0):(Je=~(-me/4294967296),4294967295^(ze=~(-me%4294967296))?ze=ze+1|0:(ze=0,Je=Je+1|0)),me>=18446744073709552e3||me<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");Ie.realloc(10),function(st,ut,xt){xt.buf[xt.pos++]=127&st|128,st>>>=7,xt.buf[xt.pos++]=127&st|128,st>>>=7,xt.buf[xt.pos++]=127&st|128,st>>>=7,xt.buf[xt.pos++]=127&st|128,xt.buf[xt.pos]=127&(st>>>=7)}(ze,0,Ie),function(st,ut){var xt=(7&st)<<4;ut.buf[ut.pos++]|=xt|((st>>>=3)?128:0),st&&(ut.buf[ut.pos++]=127&st|((st>>>=7)?128:0),st&&(ut.buf[ut.pos++]=127&st|((st>>>=7)?128:0),st&&(ut.buf[ut.pos++]=127&st|((st>>>=7)?128:0),st&&(ut.buf[ut.pos++]=127&st|((st>>>=7)?128:0),st&&(ut.buf[ut.pos++]=127&st)))))}(Je,Ie)}(ie,this):(this.realloc(4),this.buf[this.pos++]=127&ie|(ie>127?128:0),ie<=127||(this.buf[this.pos++]=127&(ie>>>=7)|(ie>127?128:0),ie<=127||(this.buf[this.pos++]=127&(ie>>>=7)|(ie>127?128:0),ie<=127||(this.buf[this.pos++]=ie>>>7&127))))},writeSVarint:function(ie){this.writeVarint(ie<0?2*-ie-1:2*ie)},writeBoolean:function(ie){this.writeVarint(!!ie)},writeString:function(ie){ie=String(ie),this.realloc(4*ie.length),this.pos++;var me=this.pos;this.pos=function(ze,Je,st){for(var ut,xt,Ft=0;Ft<Je.length;Ft++){if((ut=Je.charCodeAt(Ft))>55295&&ut<57344){if(!xt){ut>56319||Ft+1===Je.length?(ze[st++]=239,ze[st++]=191,ze[st++]=189):xt=ut;continue}if(ut<56320){ze[st++]=239,ze[st++]=191,ze[st++]=189,xt=ut;continue}ut=xt-55296<<10|ut-56320|65536,xt=null}else xt&&(ze[st++]=239,ze[st++]=191,ze[st++]=189,xt=null);ut<128?ze[st++]=ut:(ut<2048?ze[st++]=ut>>6|192:(ut<65536?ze[st++]=ut>>12|224:(ze[st++]=ut>>18|240,ze[st++]=ut>>12&63|128),ze[st++]=ut>>6&63|128),ze[st++]=63&ut|128)}return st}(this.buf,ie,this.pos);var Ie=this.pos-me;Ie>=128&&b(me,Ie,this),this.pos=me-1,this.writeVarint(Ie),this.pos+=Ie},writeFloat:function(ie){this.realloc(4),o.write(this.buf,ie,this.pos,!0,23,4),this.pos+=4},writeDouble:function(ie){this.realloc(8),o.write(this.buf,ie,this.pos,!0,52,8),this.pos+=8},writeBytes:function(ie){var me=ie.length;this.writeVarint(me),this.realloc(me);for(var Ie=0;Ie<me;Ie++)this.buf[this.pos++]=ie[Ie]},writeRawMessage:function(ie,me){this.pos++;var Ie=this.pos;ie(me,this);var ze=this.pos-Ie;ze>=128&&b(Ie,ze,this),this.pos=Ie-1,this.writeVarint(ze),this.pos+=ze},writeMessage:function(ie,me,Ie){this.writeTag(ie,e.Bytes),this.writeRawMessage(me,Ie)},writePackedVarint:function(ie,me){me.length&&this.writeMessage(ie,I,me)},writePackedSVarint:function(ie,me){me.length&&this.writeMessage(ie,E,me)},writePackedBoolean:function(ie,me){me.length&&this.writeMessage(ie,V,me)},writePackedFloat:function(ie,me){me.length&&this.writeMessage(ie,L,me)},writePackedDouble:function(ie,me){me.length&&this.writeMessage(ie,F,me)},writePackedFixed32:function(ie,me){me.length&&this.writeMessage(ie,W,me)},writePackedSFixed32:function(ie,me){me.length&&this.writeMessage(ie,H,me)},writePackedFixed64:function(ie,me){me.length&&this.writeMessage(ie,ee,me)},writePackedSFixed64:function(ie,me){me.length&&this.writeMessage(ie,le,me)},writeBytesField:function(ie,me){this.writeTag(ie,e.Bytes),this.writeBytes(me)},writeFixed32Field:function(ie,me){this.writeTag(ie,e.Fixed32),this.writeFixed32(me)},writeSFixed32Field:function(ie,me){this.writeTag(ie,e.Fixed32),this.writeSFixed32(me)},writeFixed64Field:function(ie,me){this.writeTag(ie,e.Fixed64),this.writeFixed64(me)},writeSFixed64Field:function(ie,me){this.writeTag(ie,e.Fixed64),this.writeSFixed64(me)},writeVarintField:function(ie,me){this.writeTag(ie,e.Varint),this.writeVarint(me)},writeSVarintField:function(ie,me){this.writeTag(ie,e.Varint),this.writeSVarint(me)},writeStringField:function(ie,me){this.writeTag(ie,e.Bytes),this.writeString(me)},writeFloatField:function(ie,me){this.writeTag(ie,e.Fixed32),this.writeFloat(me)},writeDoubleField:function(ie,me){this.writeTag(ie,e.Fixed64),this.writeDouble(me)},writeBooleanField:function(ie,me){this.writeVarintField(ie,!!me)}},ax}var Wy=Xt(_v());let cx=3;function Ow(o,e,n){e.glyphs=[],o===1&&n.readMessage(Fw,e)}function Fw(o,e,n){if(o===3){let{id:l,bitmap:c,width:m,height:_,left:b,top:I,advance:E}=n.readMessage(Bw,{});e.glyphs.push({id:l,bitmap:new Eu({width:m+2*cx,height:_+2*cx},c),metrics:{width:m,height:_,left:b,top:I,advance:E}})}else o===4?e.ascender=n.readSVarint():o===5&&(e.descender=n.readSVarint())}function Bw(o,e,n){o===1?e.id=n.readVarint():o===2?e.bitmap=n.readBytes():o===3?e.width=n.readVarint():o===4?e.height=n.readVarint():o===5?e.left=n.readSVarint():o===6?e.top=n.readSVarint():o===7&&(e.advance=n.readVarint())}let gv=cx,Ih={horizontal:1,vertical:2,horizontalOnly:3};class Ng{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,n){let l=new Ng;return l.scale=e||1,l.fontStack=n,l}static forImage(e){let n=new Ng;return n.image=e,n}}class A_{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,n,l){let c=new A_;for(let m=0;m<e.sections.length;m++){let _=e.sections[m];_.image?c.addImageSection(_,l):c.addTextSection(_,n)}return c}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(n,l){let c="";for(let m=0;m<n.length;m++){let _=n.charCodeAt(m+1)||null,b=n.charCodeAt(m-1)||null;c+=!l&&(_&&xh(_)&&!Bg[n[m+1]]||b&&xh(b)&&!Bg[n[m-1]])||!Bg[n[m]]?n[m]:Bg[n[m]]}return c}(this.text,e)}trim(){let e=0;for(let l=0;l<this.text.length&&Hy[this.text.charCodeAt(l)];l++)e++;let n=this.text.length;for(let l=this.text.length-1;l>=0&&l>=e&&Hy[this.text.charCodeAt(l)];l--)n--;this.text=this.text.substring(e,n),this.sectionIndex=this.sectionIndex.slice(e,n)}substring(e,n){let l=new A_;return l.text=this.text.substring(e,n),l.sectionIndex=this.sectionIndex.slice(e,n),l.sections=this.sections,l}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,n)=>Math.max(e,this.sections[n].scale),0)}addTextSection(e,n){this.text+=e.text,this.sections.push(Ng.forText(e.scale,e.fontStack||n));let l=this.sections.length-1;for(let c=0;c<e.text.length;++c)this.sectionIndex.push(l)}addImageSection(e,n){let l=e.image?e.image.getPrimary():null;if(!l)return void Hi("Can't add FormattedSection with an empty image.");l.scaleSelf(n);let c=this.getNextImageSectionCharCode();c?(this.text+=String.fromCodePoint(c),this.sections.push(Ng.forImage(l)),this.sectionIndex.push(this.sections.length-1)):Hi("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function hx(o,e,n,l,c,m,_,b,I,E,L,F,V,W,H,ee=1){let le=A_.fromFeature(o,c,ee);F===Ih.vertical&&le.verticalizePunctuation(V);let de=[],Ce=function(ze,Je,st,ut,xt,Ft){if(!ze)return[];let ri=[],$t=function(Yt,Et,kt,pi,mi,qi){let Bi=0;for(let Ti=0;Ti<Yt.length();Ti++){let ui=Yt.getSection(Ti);Bi+=yv(Yt.getCodePoint(Ti),ui,pi,mi,Et,qi)}return Bi/Math.max(1,Math.ceil(Bi/kt))}(ze,Je,st,ut,xt,Ft),Qt=ze.text.indexOf("\u200B")>=0,hi=0;for(let Yt=0;Yt<ze.length();Yt++){let Et=ze.getSection(Yt),kt=ze.getCodePoint(Yt);if(Hy[kt]||(hi+=yv(kt,Et,ut,xt,Je,Ft)),Yt<ze.length()-1){let pi=!((Rt=kt)<11904||!(tn["Bopomofo Extended"](Rt)||tn.Bopomofo(Rt)||tn["CJK Compatibility Forms"](Rt)||tn["CJK Compatibility Ideographs"](Rt)||tn["CJK Compatibility"](Rt)||tn["CJK Radicals Supplement"](Rt)||tn["CJK Strokes"](Rt)||tn["CJK Symbols and Punctuation"](Rt)||tn["CJK Unified Ideographs Extension A"](Rt)||tn["CJK Unified Ideographs"](Rt)||tn["Enclosed CJK Letters and Months"](Rt)||tn["Halfwidth and Fullwidth Forms"](Rt)||tn.Hiragana(Rt)||tn["Ideographic Description Characters"](Rt)||tn["Kangxi Radicals"](Rt)||tn["Katakana Phonetic Extensions"](Rt)||tn.Katakana(Rt)||tn["Vertical Forms"](Rt)||tn["Yi Radicals"](Rt)||tn["Yi Syllables"](Rt)));(Nw[kt]||pi||Et.image)&&ri.push(vv(Yt+1,hi,$t,ri,Vw(kt,ze.getCodePoint(Yt+1),pi&&Qt),!1))}}var Rt;return bv(vv(ze.length(),hi,$t,ri,0,!0))}(le,E,m,e,l,W),{processBidirectionalText:we,processStyledBidirectionalText:ie}=q;if(we&&le.sections.length===1){let ze=we(le.toString(),Ce);for(let Je of ze){let st=new A_;st.text=Je,st.sections=le.sections;for(let ut=0;ut<Je.length;ut++)st.sectionIndex.push(0);de.push(st)}}else if(ie){let ze=ie(le.text,le.sectionIndex,Ce);for(let Je of ze){let st=new A_;st.text=Je[0],st.sectionIndex=Je[1],st.sections=le.sections,de.push(st)}}else de=function(ze,Je){let st=[],ut=ze.text,xt=0;for(let Ft of Je)st.push(ze.substring(xt,Ft)),xt=Ft;return xt<ut.length&&st.push(ze.substring(xt,ut.length)),st}(le,Ce);let me=[],Ie={positionedLines:me,text:le.toString(),top:L[1],bottom:L[1],left:L[0],right:L[0],writingMode:F,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(ze,Je,st,ut,xt,Ft,ri,$t,Qt,hi,Rt,Yt){let Et=0,kt=0,pi=0,mi=$t==="right"?1:$t==="left"?0:.5,qi=!1;for(let Ui of xt){let mn=Ui.getSections();for(let Pn of mn){if(Pn.image)continue;let Rn=Je[Pn.fontStack];if(Rn&&(qi=Rn.ascender!==void 0&&Rn.descender!==void 0,!qi))break}if(!qi)break}let Bi=0;for(let Ui of xt){Ui.trim();let mn=Ui.getMaxScale(),Pn=(mn-1)*ja,Rn={positionedGlyphs:[],lineOffset:0};ze.positionedLines[Bi]=Rn;let Zn=Rn.positionedGlyphs,kn=0;if(!Ui.length()){kt+=Ft,++Bi;continue}let zn=0,$r=0;for(let Me=0;Me<Ui.length();Me++){let ke=Ui.getSection(Me),Nt=Ui.getSectionIndex(Me),vi=Ui.getCodePoint(Me),Ci=ke.scale,Si=null,Gi=null,un=null,ir=ja,nr=0;Qt===Ih.vertical&&((Ti=vi)===12312||Ti===12313||Ti===12316||Ti===12540||Ti===12448)&&(Qt=Ih.horizontal);let Ln=!(Qt===Ih.horizontal||!Rt&&!Ul(vi)||Rt&&(Hy[vi]||mf(vi)));if(ke.image){let Nr=ut.get(ke.image.toString());if(!Nr)continue;un=ke.image,ze.iconsInText=ze.iconsInText||!0,Gi=Nr.paddedRect;let Qr=Nr.displaySize;Ci=Ci*ja/Yt,Si={width:Qr[0],height:Qr[1],left:0,top:-gv,advance:Ln?Qr[1]:Qr[0],localGlyph:!1},nr=qi?-Si.height*Ci:mn*ja-17-Qr[1]*Ci,ir=Si.advance;let rr=(Ln?Qr[0]:Qr[1])*Ci-ja*mn;rr>0&&rr>kn&&(kn=rr)}else{let Nr=st[ke.fontStack];if(!Nr)continue;Nr[vi]&&(Gi=Nr[vi]);let Qr=Je[ke.fontStack];if(!Qr)continue;let rr=Qr.glyphs[vi];if(!rr)continue;if(Si=rr.metrics,ir=vi!==8203?ja:0,qi){let Po=Qr.ascender!==void 0?Math.abs(Qr.ascender):0,lo=Qr.descender!==void 0?Math.abs(Qr.descender):0,Fr=(Po+lo)*Ci;zn<Fr&&(zn=Fr,$r=(Po-lo)/2*Ci),nr=-Po*Ci}else nr=(mn-Ci)*ja-17}Ln?(ze.verticalizable=!0,Zn.push({glyph:vi,image:un,x:Et,y:kt+nr,vertical:Ln,scale:Ci,localGlyph:Si.localGlyph,fontStack:ke.fontStack,sectionIndex:Nt,metrics:Si,rect:Gi}),Et+=ir*Ci+hi):(Zn.push({glyph:vi,image:un,x:Et,y:kt+nr,vertical:Ln,scale:Ci,localGlyph:Si.localGlyph,fontStack:ke.fontStack,sectionIndex:Nt,metrics:Si,rect:Gi}),Et+=Si.advance*Ci+hi)}Zn.length!==0&&(pi=Math.max(Et-hi,pi),qi?wv(Zn,mi,kn,$r,Ft*mn/2):wv(Zn,mi,kn,0,Ft/2)),Et=0;let ao=Ft*mn+kn;Rn.lineOffset=Math.max(kn,Pn),kt+=ao,++Bi}var Ti;let ui=kt,{horizontalAlign:bn,verticalAlign:Vi}=ux(ri);(function(Ui,mn,Pn,Rn,Zn,kn){let zn=(mn-Pn)*Zn,$r=-kn*Rn;for(let ao of Ui)for(let Me of ao.positionedGlyphs)Me.x+=zn,Me.y+=$r})(ze.positionedLines,mi,bn,Vi,pi,ui),ze.top+=-Vi*ui,ze.bottom=ze.top+ui,ze.left+=-bn*pi,ze.right=ze.left+pi,ze.hasBaseline=qi}(Ie,e,n,l,de,_,b,I,F,E,V,H),!function(ze){for(let Je of ze)if(Je.positionedGlyphs.length!==0)return!1;return!0}(me))return Ie}let Hy={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Nw={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function yv(o,e,n,l,c,m){if(e.image){let _=l.get(e.image.toString());return _?_.displaySize[0]*e.scale*ja/m+c:0}{let _=n[e.fontStack],b=_&&_.glyphs[o];return b?b.metrics.advance*e.scale+c:0}}function xv(o,e,n,l){let c=Math.pow(o-e,2);return l?o<e?c/2:2*c:c+Math.abs(n)*n}function Vw(o,e,n){let l=0;return o===10&&(l-=1e4),n&&(l+=150),o!==40&&o!==65288||(l+=50),e!==41&&e!==65289||(l+=50),l}function vv(o,e,n,l,c,m){let _=null,b=xv(e,n,c,m);for(let I of l){let E=xv(e-I.x,n,c,m)+I.badness;E<=b&&(_=I,b=E)}return{index:o,x:e,priorBreak:_,badness:b}}function bv(o){return o?bv(o.priorBreak).concat(o.index):[]}function ux(o){let e=.5,n=.5;switch(o){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(o){case"bottom":case"bottom-right":case"bottom-left":n=1;break;case"top":case"top-right":case"top-left":n=0}return{horizontalAlign:e,verticalAlign:n}}function wv(o,e,n,l,c){if(!(e||n||l||c))return;let m=o.length-1,_=o[m],b=(_.x+_.metrics.advance*_.scale)*e;for(let I=0;I<=m;I++)o[I].x-=b,o[I].y+=n+l+c}function Tv(o){return o.imagePrimary!==void 0&&o.top!==void 0&&o.bottom!==void 0&&o.left!==void 0&&o.right!==void 0}function Uw(o,e,n,l){let{horizontalAlign:c,verticalAlign:m}=ux(l),_=n[0]-o.displaySize[0]*c,b=n[1]-o.displaySize[1]*m;return{imagePrimary:o,imageSecondary:e,top:b,bottom:b+o.displaySize[1],left:_,right:_+o.displaySize[0]}}function Sv(o,e,n,l,c,m){let _=o.imagePrimary,b;if(_.content){let le=_.content,de=_.pixelRatio||1;b=[le[0]/de,le[1]/de,_.displaySize[0]-le[2]/de,_.displaySize[1]-le[3]/de]}let I=e.left*m,E=e.right*m,L,F,V,W;n==="width"||n==="both"?(W=c[0]+I-l[3],F=c[0]+E+l[1]):(W=c[0]+(I+E-_.displaySize[0])/2,F=W+_.displaySize[0]);let H=e.top*m,ee=e.bottom*m;return n==="height"||n==="both"?(L=c[1]+H-l[0],V=c[1]+ee+l[2]):(L=c[1]+(H+ee-_.displaySize[1])/2,V=L+_.displaySize[1]),{imagePrimary:_,imageSecondary:void 0,top:L,right:F,bottom:V,left:W,collisionPadding:b}}function Iv(o){return!o.imagePrimary.stretchX}function Cv(o){return!o.imagePrimary.stretchY}function Ev(o){return{width:o.right-o.left,height:o.bottom-o.top}}let nf=128;function Mv(o,e){let{expression:n}=e;if(n.kind==="constant")return{kind:"constant",layoutSize:n.evaluate(new J(o+1))};if(n.kind==="source")return{kind:"source"};{let{zoomStops:l,interpolationType:c}=n,m=0;for(;m<l.length&&l[m]<=o;)m++;m=Math.max(0,m-1);let _=m;for(;_<l.length&&l[_]<o+1;)_++;_=Math.min(l.length-1,_);let b=l[m],I=l[_];return n.kind==="composite"?{kind:"composite",minZoom:b,maxZoom:I,interpolationType:c}:{kind:"camera",minZoom:b,maxZoom:I,minSize:n.evaluate(new J(b)),maxSize:n.evaluate(new J(I)),interpolationType:c}}}function dx(o,{uSize:e,uSizeT:n},{lowerSize:l,upperSize:c}){return o.kind==="source"?l/nf:o.kind==="composite"?en(l/nf,c/nf,n):e}function Vg(o,e,n=1){let l=0,c=0;if(o.kind==="constant")c=o.layoutSize*n;else if(o.kind!=="source"){let{interpolationType:m,minZoom:_,maxZoom:b}=o,I=m?rt(es.interpolationFactor(m,e,_,b),0,1):0;o.kind==="camera"?c=en(o.minSize,o.maxSize,I)*n:l=I*n}return{uSizeT:l,uSize:c}}class Lf extends Ue{constructor(e,n,l,c,m){super(e,n),this.angle=c,this.z=l,m!==void 0&&(this.segment=m)}clone(){return new Lf(this.x,this.y,this.z,this.angle,this.segment)}}function Pv(o,e,n,l,c){if(e.segment===void 0)return!0;let m=e,_=e.segment+1,b=0;for(;b>-n/2;){if(_--,_<0)return!1;b-=o[_].dist(m),m=o[_]}b+=o[_].dist(o[_+1]),_++;let I=[],E=0;for(;b<n/2;){let L=o[_],F=o[_+1];if(!F)return!1;let V=o[_-1].angleTo(L)-L.angleTo(F);for(V=Math.abs((V+3*Math.PI)%(2*Math.PI)-Math.PI),I.push({distance:b,angleDelta:V}),E+=V;b-I[0].distance>l;)E-=I.shift().angleDelta;if(E>c)return!1;_++,b+=L.dist(F)}return!0}function Av(o){let e=0;for(let n=0;n<o.length-1;n++)e+=o[n].dist(o[n+1]);return e}function Dv(o,e,n){return o?.6*e*n:0}function Rv(o,e){return Math.max(o?o.right-o.left:0,e?e.right-e.left:0)}function jw(o,e,n,l,c,m){let _=Dv(n,c,m),b=Rv(n,l)*m,I=0,E=Av(o)/2;for(let L=0;L<o.length-1;L++){let F=o[L],V=o[L+1],W=F.dist(V);if(I+W>E){let H=(E-I)/W,ee=en(F.x,V.x,H),le=en(F.y,V.y,H),de=new Lf(ee,le,0,V.angleTo(F),L);return!_||Pv(o,de,b,_,e)?de:void 0}I+=W}}function Gw(o,e,n,l,c,m,_,b,I){let E=Dv(l,m,_),L=Rv(l,c),F=L*_,V=o[0].x===0||o[0].x===I||o[0].y===0||o[0].y===I;return e-F<e/4&&(e=F+e/4),zv(o,V?e/2*b%e:(L/2+2*m)*_*b%e,e,E,n,F,V,!1,I)}function zv(o,e,n,l,c,m,_,b,I){let E=m/2,L=Av(o),F=0,V=e-n,W=[];for(let H=0;H<o.length-1;H++){let ee=o[H],le=o[H+1],de=ee.dist(le),Ce=le.angleTo(ee);for(;V+n<F+de;){V+=n;let we=(V-F)/de,ie=en(ee.x,le.x,we),me=en(ee.y,le.y,we);if(ie>=0&&ie<I&&me>=0&&me<I&&V-E>=0&&V+E<=L){let Ie=new Lf(ie,me,0,Ce,H);l&&!Pv(o,Ie,m,l,c)||W.push(Ie)}}F+=de}return b||W.length||_||(W=zv(o,F/2,n,l,c,m,_,!0,I)),W}function Lv(o){let e=0,n=0;for(let _ of o)e+=_.w*_.h,n=Math.max(n,_.w);o.sort((_,b)=>b.h-_.h);let l=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),n),h:1/0}],c=0,m=0;for(let _ of o)for(let b=l.length-1;b>=0;b--){let I=l[b];if(!(_.w>I.w||_.h>I.h)){if(_.x=I.x,_.y=I.y,m=Math.max(m,_.y+_.h),c=Math.max(c,_.x+_.w),_.w===I.w&&_.h===I.h){let E=l.pop();b<l.length&&(l[b]=E)}else _.h===I.h?(I.x+=_.w,I.w-=_.w):_.w===I.w?(I.y+=_.h,I.h-=_.h):(l.push({x:I.x+_.w,y:I.y,w:I.w-_.w,h:_.h}),I.y+=_.h,I.h-=_.h);break}}return{w:c,h:m,fill:e/(c*m)||0}}Ei(Lf,"Anchor");let Ym=1;class Ug{static getImagePositionScale(e,n,l){if(n&&e&&e.options&&e.options.transform){let c=e.options.transform;return{x:c.a,y:c.d}}return{x:l,y:l}}constructor(e,n,l,c){this.paddedRect=e;let{pixelRatio:m,version:_,stretchX:b,stretchY:I,content:E,sdf:L,usvg:F}=n;this.pixelRatio=m,this.stretchX=b,this.stretchY=I,this.content=E,this.version=_,this.padding=l,this.sdf=L,this.scale=Ug.getImagePositionScale(c,F,m)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function px(o,e,n){let l=Vs.parse(o),c=function(m,_,b=[1,1]){return{x:0,y:0,w:(m.data?m.data.width:m.width*b[0])+2*_,h:(m.data?m.data.height:m.height*b[1])+2*_}}(e,n,[l.options.transform.a,l.options.transform.d]);return{bin:c,imagePosition:new Ug(c,e,n,l),imageVariant:l}}class kv{constructor(e,n,l){let c=new Map,m=new Map;this.haveRenderCallbacks=[];let _=[];this.addImages(e,c,Ym,_),this.addImages(n,m,2,_);let{w:b,h:I}=Lv(_),E=new ua({width:b||1,height:I||1});for(let[L,F]of e.entries()){let V=c.get(L).paddedRect;ua.copy(F.data,E,{x:0,y:0},{x:V.x+Ym,y:V.y+Ym},F.data,l,F.sdf)}for(let[L,F]of n.entries()){let V=m.get(L),W=V.paddedRect,H=V.padding,ee=W.x+H,le=W.y+H,de=F.data.width,Ce=F.data.height;H=H>1?H-1:H,ua.copy(F.data,E,{x:0,y:0},{x:ee,y:le},F.data,l),ua.copy(F.data,E,{x:0,y:Ce-H},{x:ee,y:le-H},{width:de,height:H},l),ua.copy(F.data,E,{x:0,y:0},{x:ee,y:le+Ce},{width:de,height:H},l),ua.copy(F.data,E,{x:de-H,y:0},{x:ee-H,y:le},{width:H,height:Ce},l),ua.copy(F.data,E,{x:0,y:0},{x:ee+de,y:le},{width:H,height:Ce},l),ua.copy(F.data,E,{x:de-H,y:Ce-H},{x:ee-H,y:le-H},{width:H,height:H},l),ua.copy(F.data,E,{x:0,y:Ce-H},{x:ee+de,y:le-H},{width:H,height:H},l),ua.copy(F.data,E,{x:0,y:0},{x:ee+de,y:le+Ce},{width:H,height:H},l),ua.copy(F.data,E,{x:de-H,y:0},{x:ee-H,y:le+Ce},{width:H,height:H},l)}this.lut=l,this.image=E,this.iconPositions=c,this.patternPositions=m}addImages(e,n,l,c){for(let[m,_]of e.entries()){let{bin:b,imagePosition:I,imageVariant:E}=px(m,_,l);n.set(m,I),c.push(b),_.hasRenderCallback&&this.haveRenderCallbacks.push(E.id)}}patchUpdatedImages(e,n,l){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(c=>e.hasImage(c,l)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,l);for(let c of e.getUpdatedImages(l)){for(let m of this.iconPositions.keys()){let _=Vs.parse(m);if(hs.isEqual(_.id,c)){let b=e.getImage(c,l);this.patchUpdatedImage(this.iconPositions.get(m),b,n)}}for(let m of this.patternPositions.keys()){let _=Vs.parse(m);if(hs.isEqual(_.id,c)){let b=e.getImage(c,l);this.patchUpdatedImage(this.patternPositions.get(m),b,n)}}}}patchUpdatedImage(e,n,l){if(!e||!n||e.version===n.version)return;e.version=n.version;let[c,m]=e.tl,_=e.sdf;if(this.lut||_){let b={width:n.data.width,height:n.data.height},I=new ua(b);ua.copy(n.data,I,{x:0,y:0},{x:0,y:0},b,this.lut,_),l.update(I,{position:{x:c,y:m}})}else l.update(n.data,{position:{x:c,y:m}})}}Ei(Ug,"ImagePosition"),Ei(kv,"ImageAtlas");let jg=1e20;function Ov(o,e,n,l,c,m,_,b,I){for(let E=e;E<e+l;E++)Fv(o,n*m+E,m,c,_,b,I);for(let E=n;E<n+c;E++)Fv(o,E*m+e,1,l,_,b,I)}function Fv(o,e,n,l,c,m,_){m[0]=0,_[0]=-jg,_[1]=jg,c[0]=o[e];for(let b=1,I=0,E=0;b<l;b++){c[b]=o[e+b*n];let L=b*b;do{let F=m[I];E=(c[b]-c[F]+L-F*F)/(b-F)/2}while(E<=_[I]&&--I>-1);I++,m[I]=b,_[I]=E,_[I+1]=jg}for(let b=0,I=0;b<l;b++){for(;_[I+1]<b;)I++;let E=m[I],L=b-E;o[e+b*n]=c[E]+L*L}}let Sp=2,fx={none:0,ideographs:1,all:2};class D_{constructor(e,n,l){this.requestManager=e,this.localGlyphMode=n,this.localFontFamily=l,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e,n){this.urls[n]=e}getGlyphs(e,n,l){let c=[],m=this.urls[n]||ls.GLYPHS_URL;for(let _ in e)for(let b of e[_])c.push({stack:_,id:b});Ot(c,({stack:_,id:b},I)=>{let E=this.entries[_];E||(E=this.entries[_]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let L=E.glyphs[b];if(L!==void 0)return void I(null,{stack:_,id:b,glyph:L});if(L=this._tinySDF(E,_,b),L)return E.glyphs[b]=L,void I(null,{stack:_,id:b,glyph:L});let F=Math.floor(b/256);if(256*F>65535)return Hi("glyphs > 65535 not supported"),void I(null,{stack:_,id:b,glyph:L});if(E.ranges[F])return void I(null,{stack:_,id:b,glyph:L});let V=E.requests[F];V||(V=E.requests[F]=[],D_.loadGlyphRange(_,F,m,this.requestManager,(W,H)=>{if(H){E.ascender=H.ascender,E.descender=H.descender;for(let ee in H.glyphs)this._doesCharSupportLocalGlyph(+ee)||(E.glyphs[+ee]=H.glyphs[+ee]);E.ranges[F]=!0}for(let ee of V)ee(W,H);delete E.requests[F]})),V.push((W,H)=>{W?I(W):H&&I(null,{stack:_,id:b,glyph:H.glyphs[b]||null})})},(_,b)=>{if(_)l(_);else if(b){let I={};for(let{stack:E,id:L,glyph:F}of b)I[E]===void 0&&(I[E]={}),I[E].glyphs===void 0&&(I[E].glyphs={}),I[E].glyphs[L]=F&&{id:F.id,bitmap:F.bitmap.clone(),metrics:F.metrics},I[E].ascender=this.entries[E].ascender,I[E].descender=this.entries[E].descender;l(null,I)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==fx.none&&(this.localGlyphMode===fx.all?!!this.localFontFamily:!!this.localFontFamily&&(tn["CJK Unified Ideographs"](e)||tn["Hangul Syllables"](e)||tn.Hiragana(e)||tn.Katakana(e)||tn["CJK Symbols and Punctuation"](e)||tn["CJK Unified Ideographs Extension A"](e)||tn["CJK Unified Ideographs Extension B"](e)||tn.Osage(e)))}_tinySDF(e,n,l){let c=this.localFontFamily;if(!c||!this._doesCharSupportLocalGlyph(l))return;let m=e.tinySDF;if(!m){let ee="400";/bold/i.test(n)?ee="900":/medium/i.test(n)?ee="500":/light/i.test(n)&&(ee="200"),m=e.tinySDF=new D_.TinySDF({fontFamily:c,fontWeight:ee,fontSize:24*Sp,buffer:3*Sp,radius:8*Sp}),m.fontWeight=ee}if(this.localGlyphs[m.fontWeight][l])return this.localGlyphs[m.fontWeight][l];let _=String.fromCodePoint(l),{data:b,width:I,height:E,glyphWidth:L,glyphHeight:F,glyphLeft:V,glyphTop:W,glyphAdvance:H}=m.draw(_);return this.localGlyphs[m.fontWeight][l]={id:l,bitmap:new Eu({width:I,height:E},b),metrics:{width:L/Sp,height:F/Sp,left:V/Sp,top:W/Sp-27,advance:H/Sp,localGlyph:!0}}}}D_.loadGlyphRange=function(o,e,n,l,c){let m=256*e,_=m+255,b=l.transformRequest(l.normalizeGlyphsURL(n).replace("{fontstack}",o).replace("{range}",`${m}-${_}`),Lu.Glyphs);gs(b,(I,E)=>{if(I)c(I);else if(E){let L={},F=function(V){return new Wy(V).readFields(Ow,{})}(E);for(let V of F.glyphs)L[V.id]=V;c(null,{glyphs:L,ascender:F.ascender,descender:F.descender})}})},D_.TinySDF=class{constructor({fontSize:o=24,buffer:e=3,radius:n=8,cutoff:l=.25,fontFamily:c="sans-serif",fontWeight:m="normal",fontStyle:_="normal"}={}){this.buffer=e,this.cutoff=l,this.radius=n;let b=this.size=o+4*e,I=this._createCanvas(b),E=this.ctx=I.getContext("2d",{willReadFrequently:!0});E.font=`${_} ${m} ${o}px ${c}`,E.textBaseline="alphabetic",E.textAlign="left",E.fillStyle="black",this.gridOuter=new Float64Array(b*b),this.gridInner=new Float64Array(b*b),this.f=new Float64Array(b),this.z=new Float64Array(b+1),this.v=new Uint16Array(b)}_createCanvas(o){let e=document.createElement("canvas");return e.width=e.height=o,e}draw(o){let{width:e,actualBoundingBoxAscent:n,actualBoundingBoxDescent:l,actualBoundingBoxLeft:c,actualBoundingBoxRight:m}=this.ctx.measureText(o),_=Math.ceil(n),b=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(m-c))),I=Math.min(this.size-this.buffer,_+Math.ceil(l)),E=b+2*this.buffer,L=I+2*this.buffer,F=Math.max(E*L,0),V=new Uint8ClampedArray(F),W={data:V,width:E,height:L,glyphWidth:b,glyphHeight:I,glyphTop:_,glyphLeft:0,glyphAdvance:e};if(b===0||I===0)return W;let{ctx:H,buffer:ee,gridInner:le,gridOuter:de}=this;H.clearRect(ee,ee,b,I),H.fillText(o,ee,ee+_);let Ce=H.getImageData(ee,ee,b,I);de.fill(jg,0,F),le.fill(0,0,F);for(let we=0;we<I;we++)for(let ie=0;ie<b;ie++){let me=Ce.data[4*(we*b+ie)+3]/255;if(me===0)continue;let Ie=(we+ee)*E+ie+ee;if(me===1)de[Ie]=0,le[Ie]=jg;else{let ze=.5-me;de[Ie]=ze>0?ze*ze:0,le[Ie]=ze<0?ze*ze:0}}Ov(de,0,0,E,L,E,this.f,this.v,this.z),Ov(le,ee,ee,b,I,E,this.f,this.v,this.z);for(let we=0;we<F;we++){let ie=Math.sqrt(de[we])-Math.sqrt(le[we]);V[we]=Math.round(255-255*(ie/this.radius+this.cutoff))}return W}};let lm=Ym;function Bv(o,e){return o+e[1]-e[0]}function Nv(o,e,n,l,c=1){let m=[],_=o.imagePrimary,b=_.pixelRatio,I=_.paddedRect.w-2*lm,E=_.paddedRect.h-2*lm,L=(o.right-o.left)*c,F=(o.bottom-o.top)*c,V=_.stretchX||[[0,I]],W=_.stretchY||[[0,E]],H=V.reduce(Bv,0),ee=W.reduce(Bv,0),le=I-H,de=E-ee,Ce=0,we=H,ie=0,me=ee,Ie=0,ze=le,Je=0,st=de;if(_.content&&l){let xt=_.content;Ce=Xy(V,0,xt[0]),ie=Xy(W,0,xt[1]),we=Xy(V,xt[0],xt[2]),me=Xy(W,xt[1],xt[3]),Ie=xt[0]-Ce,Je=xt[1]-ie,ze=xt[2]-xt[0]-we,st=xt[3]-xt[1]-me}let ut=(xt,Ft,ri,$t)=>{let Qt=Ky(xt.stretch-Ce,we,L,o.left*c),hi=Yy(xt.fixed-Ie,ze,xt.stretch,H),Rt=Ky(Ft.stretch-ie,me,F,o.top*c),Yt=Yy(Ft.fixed-Je,st,Ft.stretch,ee),Et=Ky(ri.stretch-Ce,we,L,o.left*c),kt=Yy(ri.fixed-Ie,ze,ri.stretch,H),pi=Ky($t.stretch-ie,me,F,o.top*c),mi=Yy($t.fixed-Je,st,$t.stretch,ee),qi=new Ue(Qt,Rt),Bi=new Ue(Et,Rt),Ti=new Ue(Et,pi),ui=new Ue(Qt,pi),bn=new Ue(hi/b,Yt/b),Vi=new Ue(kt/b,mi/b),Ui=e*Math.PI/180;if(Ui){let zn=Math.sin(Ui),$r=Math.cos(Ui),ao=[$r,-zn,zn,$r];qi._matMult(ao),Bi._matMult(ao),ui._matMult(ao),Ti._matMult(ao)}let mn=xt.stretch+xt.fixed,Pn=ri.stretch+ri.fixed,Rn=Ft.stretch+Ft.fixed,Zn=$t.stretch+$t.fixed,kn=o.imageSecondary;return{tl:qi,tr:Bi,bl:ui,br:Ti,texPrimary:{x:_.paddedRect.x+lm+mn,y:_.paddedRect.y+lm+Rn,w:Pn-mn,h:Zn-Rn},texSecondary:kn?{x:kn.paddedRect.x+lm+mn,y:kn.paddedRect.y+lm+Rn,w:Pn-mn,h:Zn-Rn}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:bn,pixelOffsetBR:Vi,minFontScaleX:ze/b/L,minFontScaleY:st/b/F,isSDF:n}};if(l&&(_.stretchX||_.stretchY)){let xt=Vv(V,le,H),Ft=Vv(W,de,ee);for(let ri=0;ri<xt.length-1;ri++){let $t=xt[ri],Qt=xt[ri+1];for(let hi=0;hi<Ft.length-1;hi++)m.push(ut($t,Ft[hi],Qt,Ft[hi+1]))}}else m.push(ut({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:I+1},{fixed:0,stretch:E+1}));return m}function Xy(o,e,n){let l=0;for(let c of o)l+=Math.max(e,Math.min(n,c[1]))-Math.max(e,Math.min(n,c[0]));return l}function Vv(o,e,n){let l=[{fixed:-lm,stretch:0}];for(let[c,m]of o){let _=l[l.length-1];l.push({fixed:c-_.stretch,stretch:_.stretch}),l.push({fixed:c-_.stretch,stretch:_.stretch+(m-c)})}return l.push({fixed:e+lm,stretch:n}),l}function Ky(o,e,n,l){return o/e*n+l}function Yy(o,e,n,l){return o-e*n/l}function Zw(o,e,n,l){let c=e+o.positionedLines[l].lineOffset;return l===0?n+c/2:n+(c+(e+o.positionedLines[l-1].lineOffset))/2}function qw(o,e=1,n=!1){let l=1/0,c=1/0,m=-1/0,_=-1/0,b=o[0];for(let W=0;W<b.length;W++){let H=b[W];(!W||H.x<l)&&(l=H.x),(!W||H.y<c)&&(c=H.y),(!W||H.x>m)&&(m=H.x),(!W||H.y>_)&&(_=H.y)}let I=Math.min(m-l,_-c),E=I/2,L=new Ec([],$w);if(I===0)return new Ue(l,c);for(let W=l;W<m;W+=I)for(let H=c;H<_;H+=I)L.push(new R_(W+E,H+E,E,o));let F=function(W){let H=0,ee=0,le=0,de=W[0];for(let Ce=0,we=de.length,ie=we-1;Ce<we;ie=Ce++){let me=de[Ce],Ie=de[ie],ze=me.x*Ie.y-Ie.x*me.y;ee+=(me.x+Ie.x)*ze,le+=(me.y+Ie.y)*ze,H+=3*ze}return new R_(ee/H,le/H,0,W)}(o),V=L.length;for(;L.length;){let W=L.pop();(W.d>F.d||!F.d)&&(F=W,n&&console.log("found best %d after %d probes",Math.round(1e4*W.d)/1e4,V)),W.max-F.d<=e||(E=W.h/2,L.push(new R_(W.p.x-E,W.p.y-E,E,o)),L.push(new R_(W.p.x+E,W.p.y-E,E,o)),L.push(new R_(W.p.x-E,W.p.y+E,E,o)),L.push(new R_(W.p.x+E,W.p.y+E,E,o)),V+=4)}return n&&(console.log(`num probes: ${V}`),console.log(`best distance: ${F.d}`)),F.p}function $w(o,e){return e.max-o.max}class R_{constructor(e,n,l,c){this.p=new Ue(e,n),this.h=l,this.d=function(m,_){let b=!1,I=1/0;for(let E=0;E<_.length;E++){let L=_[E];for(let F=0,V=L.length,W=V-1;F<V;W=F++){let H=L[F],ee=L[W];H.y>m.y!=ee.y>m.y&&m.x<(ee.x-H.x)*(m.y-H.y)/(ee.y-H.y)+H.x&&(b=!b),I=Math.min(I,cr(m,H,ee))}}return(b?1:-1)*Math.sqrt(I)}(this.p,c),this.max=this.d+this.h*Math.SQRT2}}let Ww=Object.keys,mx=Number.POSITIVE_INFINITY,Hw=Math.sqrt(2);function Uv(o,[e,n]){let l=0,c=0;if(n===mx){e<0&&(e=0);let m=e/Hw;switch(o){case"top-right":case"top-left":c=m-7;break;case"bottom-right":case"bottom-left":c=7-m;break;case"bottom":c=7-e;break;case"top":c=e-7}switch(o){case"top-right":case"bottom-right":l=-m;break;case"top-left":case"bottom-left":l=m;break;case"left":l=e;break;case"right":l=-e}}else{switch(e=Math.abs(e),n=Math.abs(n),o){case"top-right":case"top-left":case"top":c=n-7;break;case"bottom-right":case"bottom-left":case"bottom":c=7-n}switch(o){case"top-right":case"bottom-right":case"right":l=-e;break;case"top-left":case"bottom-left":case"left":l=e}}return[l,c]}function Jy(o,e,n,l,c,m,_,b,I){if(!e||!e.usvg)return;let E=Ev(l),L=Ev(c),F=m!=="both"&&m!=="width"||!Iv(l)?1:Math.max(1,L.width/E.width),V=m!=="both"&&m!=="height"||!Cv(l)?1:Math.max(1,L.height/E.height);n.scaleSelf(F,V);let W=n.toString();_.set(W,n),b.set(W,e);let{imagePosition:H}=px(W,e,Ym);I.set(W,H)}function jv(o,e,n,l,c,m,_,b){if(!o)return;let I=function(E,L,F,V,W){if(E.kind==="camera")return E.maxSize;if(E.kind==="composite"){let H=L.possiblyEvaluate(new J(E.maxZoom),F).evaluate(W,{},F),ee=L.possiblyEvaluate(new J(E.minZoom),F).evaluate(W,{},F);return Math.max(H,ee)}return L.possiblyEvaluate(new J(V)).evaluate(W,{},F)}(e,n,l,c,m);return o.scaleSelf(I*b*_)}function Gv(o,e,n,l,c,m,_,b){return{iconPrimary:jv(o.getPrimary(),e,n,l,c,m,_,b),iconSecondary:jv(o.getSecondary(),e,n,l,c,m,_,b)}}function Zv(o,e,n,l){if(!o)return;let c=e.get(n.toString());if(o.imagePrimary=c,l){let m=e.get(l.toString());o.imageSecondary=m}}function Xw(o,e){for(let n in o.horizontal)qv(o.horizontal[n],e);qv(o.vertical,e)}function qv(o,e){if(o){for(let n of o.positionedLines)for(let l of n.positionedGlyphs)if(l.image!==null){let c=l.image.toString();l.rect=e.get(c).paddedRect}}}function _x(o){switch(o){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Kw(o,e,n,l,c,m,_,b,I){let E=gx(m.horizontal)||m.vertical,L=n.get("icon-text-fit-padding").evaluate(l,{},c),F,V=e;return e&&I!=="none"&&(o.allowVerticalPlacement&&m.vertical&&(F=Sv(e,m.vertical,I,L,b,_)),E&&(V=Sv(e,E,I,L,b,_))),{defaultShapedIcon:V,verticallyShapedIcon:F}}function Yw(o,e,n,l,c,m,_,b,I,E,L,F,V,W,H,ee,le,de,Ce,we){let ie=_.textMaxSize.evaluate(e,{},V);ie===void 0?ie=b*_.textScaleFactor:ie*=_.textScaleFactor;let me=o.layers[0].layout,Ie=gx(n.horizontal)||n.vertical,ze=W.name==="globe",Je=ja,st=o.tilePixelRatio*ie/Je,ut=(hi=o.overscaling,o.zoom>18&&hi>2&&(hi>>=1),Math.max(xi/(512*hi),1)*me.get("symbol-spacing")),xt=me.get("text-padding")*o.tilePixelRatio,Ft=me.get("icon-padding")*o.tilePixelRatio,ri=te(me.get("text-max-angle")),$t=me.get("icon-rotation-alignment")==="map"&&we!=="point",Qt=ut/2;var hi;o.hasAnyIconTextFit===!1&&le!=="none"&&(o.hasAnyIconTextFit=!0);let Rt=e.properties?+e.properties[fd]:null,Yt=Rt&&o.elevationFeatureIdToIndex?o.elevationFeatureIdToIndex.get(Rt):65535,Et=(kt,pi,mi)=>{if(pi.x<0||pi.x>=xi||pi.y<0||pi.y>=xi)return;let qi=null;if(ze){let{x:Bi,y:Ti,z:ui}=W.projectTilePoint(pi.x,pi.y,mi);qi={anchor:new Lf(Bi,Ti,ui,0,void 0),up:W.upVector(mi,pi.x,pi.y)}}(function(Bi,Ti,ui,bn,Vi,Ui,mn,Pn,Rn,Zn,kn,zn,$r,ao,Me,ke,Nt,vi,Ci,Si,Gi,un,ir,nr,Ln,Nr,Qr,rr,Po){let lo=Bi.addToLineVertexArray(Ti,bn),Fr,Ko,mo,eo,co,Vr,Vn,qr=0,Ao=0,cn=0,mr=0,_o=-1,Zo=-1,wo={},Zs=za(""),Wr=ui?ui.anchor:Ti,Ls=rr!=="none",Fc=0,hl=0;if(Rn._unevaluatedLayout.getValue("text-radial-offset")===void 0){let qs=Rn.layout.get("text-offset").evaluate(Gi,{},Ln);Fc=qs[0]*ja,hl=qs[1]*ja}else Fc=Rn.layout.get("text-radial-offset").evaluate(Gi,{},Ln)*ja,hl=mx;if(Bi.allowVerticalPlacement&&Vi.vertical){let qs=Vi.vertical;if(Me)Vr=yx(qs),Pn&&(Vn=yx(Pn));else{let fa=Rn.layout.get("text-rotate").evaluate(Gi,{},Ln)+90;mo=Qy(Zn,Wr,Ti,kn,zn,$r,qs,ao,fa,ke),Pn&&(eo=Qy(Zn,Wr,Ti,kn,zn,$r,Pn,vi,fa))}}if(Ui){let qs=Bi.iconSizeData,fa=Rn.layout.get("icon-rotate").evaluate(Gi,{},Ln),ul=Nv(Ui,fa,ir,Ls,un.iconScaleFactor),Wl=Pn?Nv(Pn,fa,ir,Ls,un.iconScaleFactor):void 0;Ko=Qy(Zn,Wr,Ti,kn,zn,$r,Ui,vi,fa,null),qr=4*ul.length;let Tl=null;qs.kind==="source"?(Tl=[nf*Rn.layout.get("icon-size").evaluate(Gi,{},Ln)*un.iconScaleFactor],Tl[0]>cm&&Hi(`${Bi.layerIds[0]}: Value for "icon-size" is >= ${Gg}. Reduce your "icon-size".`)):qs.kind==="composite"&&(Tl=[nf*un.compositeIconSizes[0].evaluate(Gi,{},Ln)*un.iconScaleFactor,nf*un.compositeIconSizes[1].evaluate(Gi,{},Ln)*un.iconScaleFactor],(Tl[0]>cm||Tl[1]>cm)&&Hi(`${Bi.layerIds[0]}: Value for "icon-size" is >= ${Gg}. Reduce your "icon-size".`)),Bi.addSymbols(Bi.icon,ul,Tl,Si,Ci,Gi,void 0,ui,Ti,lo.lineStartIndex,lo.lineLength,-1,nr,Ln,Nr,Qr),_o=Bi.icon.placedSymbolArray.length-1,Wl&&(Ao=4*Wl.length,Bi.addSymbols(Bi.icon,Wl,Tl,Si,Ci,Gi,Ih.vertical,ui,Ti,lo.lineStartIndex,lo.lineLength,-1,nr,Ln,Nr,Qr),Zo=Bi.icon.placedSymbolArray.length-1)}for(let qs in Vi.horizontal){let fa=qs,ul=Vi.horizontal[fa];Fr||(Zs=za(ul.text),Me?co=yx(ul):Fr=Qy(Zn,Wr,Ti,kn,zn,$r,ul,ao,Rn.layout.get("text-rotate").evaluate(Gi,{},Ln),ke));let Wl=ul.positionedLines.length===1;if(cn+=$v(Bi,ui,Ti,ul,mn,Rn,Me,Gi,ke,lo,Vi.vertical?Ih.horizontal:Ih.horizontalOnly,Wl?Ww(Vi.horizontal):[fa],wo,_o,un,nr,Ln,Nr),Wl)break}Vi.vertical&&(mr+=$v(Bi,ui,Ti,Vi.vertical,mn,Rn,Me,Gi,ke,lo,Ih.vertical,["vertical"],wo,Zo,un,nr,Ln,Nr));let rl=-1,Bc=(qs,fa)=>qs?Math.max(qs,fa):fa;rl=Bc(co,rl),rl=Bc(Vr,rl),rl=Bc(Vn,rl);let rf=rl>-1?1:0;Bi.glyphOffsetArray.length>=65535&&Hi("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Gi.sortKey!==void 0&&Bi.addToSortKeyRanges(Bi.symbolInstances.length,Gi.sortKey),Bi.symbolInstances.emplaceBack(Ti.x,Ti.y,Wr.x,Wr.y,Wr.z,wo.right>=0?wo.right:-1,wo.center>=0?wo.center:-1,wo.left>=0?wo.left:-1,wo.vertical>=0?wo.vertical:-1,_o,Zo,Zs,Fr!==void 0?Fr:Bi.collisionBoxArray.length,Fr!==void 0?Fr+1:Bi.collisionBoxArray.length,mo!==void 0?mo:Bi.collisionBoxArray.length,mo!==void 0?mo+1:Bi.collisionBoxArray.length,Ko!==void 0?Ko:Bi.collisionBoxArray.length,Ko!==void 0?Ko+1:Bi.collisionBoxArray.length,eo||Bi.collisionBoxArray.length,eo?eo+1:Bi.collisionBoxArray.length,kn,cn,mr,qr,Ao,rf,0,Fc,hl,rl,0,Ls?1:0,Po)})(o,pi,qi,kt,n,l,m,c,o.layers[0],o.collisionBoxArray,e.index,e.sourceLayerIndex,o.index,xt,Ce,E,0,Ft,$t,de,e,_,L,F,V,H,ee,le,Yt)};if(we==="line")for(let kt of wp(e.geometry,0,0,xi,xi)){let pi=Gw(kt,ut,ri,n.vertical||Ie,l,Je,st,o.overscaling,xi);for(let mi of pi)Ie&&Jw(o,Ie.text,Qt,mi)||Et(kt,mi,V)}else if(we==="line-center"){for(let kt of e.geometry)if(kt.length>1){let pi=jw(kt,ri,n.vertical||Ie,l,Je,st);pi&&Et(kt,pi,V)}}else if(e.type==="Polygon")for(let kt of xp(e.geometry,0)){let pi=qw(kt,16);Et(kt[0],new Lf(pi.x,pi.y,0,0,void 0),V)}else if(e.type==="LineString")for(let kt of e.geometry)Et(kt,new Lf(kt[0].x,kt[0].y,0,0,void 0),V);else if(e.type==="Point")for(let kt of e.geometry)for(let pi of kt)Et([pi],new Lf(pi.x,pi.y,0,0,void 0),V)}let Gg=255,cm=Gg*nf;function $v(o,e,n,l,c,m,_,b,I,E,L,F,V,W,H,ee,le,de){let Ce=function(me,Ie,ze,Je,st,ut,xt,Ft){let ri=[];if(Ie.positionedLines.length===0)return ri;let $t=Je.layout.get("text-rotate").evaluate(ut,{})*Math.PI/180,Qt=function(kt){let pi=kt[0],mi=kt[1],qi=pi*mi;return qi>0?[pi,-mi]:qi<0?[-pi,mi]:pi===0?[mi,pi]:[mi,-pi]}(ze),hi=Math.abs(Ie.top-Ie.bottom);for(let kt of Ie.positionedLines)hi-=kt.lineOffset;let Rt=Ie.positionedLines.length,Yt=hi/Rt,Et=Ie.top-ze[1];for(let kt=0;kt<Rt;++kt){let pi=Ie.positionedLines[kt];Et=Zw(Ie,Yt,Et,kt);for(let mi of pi.positionedGlyphs){if(!mi.rect)continue;let qi=mi.rect||{},Bi=gv+1,Ti=!0,ui=1,bn=0;if(mi.image){let Gi=xt.get(mi.image.toString());if(!Gi)continue;if(Gi.sdf){Hi("SDF images are not supported in formatted text and will be ignored.");continue}Ti=!1,ui=Gi.pixelRatio,Bi=Ym/ui}let Vi=(st||Ft)&&mi.vertical,Ui=mi.metrics.advance*mi.scale/2,mn=mi.metrics,Pn=mi.rect;if(Pn===null)continue;Ft&&Ie.verticalizable&&(bn=mi.image?Ui-mi.metrics.width*mi.scale/2:0);let Rn=st?[mi.x+Ui,mi.y]:[0,0],Zn=[0,0],kn=[0,0],zn=!1;st||(Vi?(kn=[mi.x+Ui+Qt[0],mi.y+Qt[1]-bn],zn=!0):Zn=[mi.x+Ui+ze[0],mi.y+ze[1]-bn]);let $r=Pn.w*mi.scale/(ui*(mi.localGlyph?Sp:1)),ao=Pn.h*mi.scale/(ui*(mi.localGlyph?Sp:1)),Me,ke,Nt,vi;if(Vi){let Gi=mi.y-Et,un=new Ue(-Ui,Ui-Gi),ir=-Math.PI/2,nr=new Ue(...kn);Me=new Ue(-Ui+Zn[0],Zn[1]),Me._rotateAround(ir,un)._add(nr),Me.x+=-Gi+Ui,Me.y-=(mn.left-Bi)*mi.scale;let Ln=mi.image?mn.advance*mi.scale:ja*mi.scale,Nr=String.fromCodePoint(mi.glyph);zw(Nr)?Me.x+=(1-Bi)*mi.scale:Lw(Nr)?Me.x+=Ln-mn.height*mi.scale+(-Bi-1)*mi.scale:Me.x+=mi.image||mn.width+2*Bi===Pn.w&&mn.height+2*Bi===Pn.h?(Ln-ao)/2:(Ln-(mn.height+2*Bi)*mi.scale)/2,ke=new Ue(Me.x,Me.y-$r),Nt=new Ue(Me.x+ao,Me.y),vi=new Ue(Me.x+ao,Me.y-$r)}else{let Gi=(mn.left-Bi)*mi.scale-Ui+Zn[0],un=(-mn.top-Bi)*mi.scale+Zn[1],ir=Gi+$r,nr=un+ao;Me=new Ue(Gi,un),ke=new Ue(ir,un),Nt=new Ue(Gi,nr),vi=new Ue(ir,nr)}if($t){let Gi;Gi=st?new Ue(0,0):zn?new Ue(Qt[0],Qt[1]):new Ue(ze[0],ze[1]),Me._rotateAround($t,Gi),ke._rotateAround($t,Gi),Nt._rotateAround($t,Gi),vi._rotateAround($t,Gi)}let Ci=new Ue(0,0),Si=new Ue(0,0);ri.push({tl:Me,tr:ke,bl:Nt,br:vi,texPrimary:qi,texSecondary:void 0,writingMode:Ie.writingMode,glyphOffset:Rn,sectionIndex:mi.sectionIndex,isSDF:Ti,pixelOffsetTL:Ci,pixelOffsetBR:Si,minFontScaleX:0,minFontScaleY:0})}}return ri}(0,l,I,m,_,b,c,o.allowVerticalPlacement),we=o.textSizeData,ie=null;we.kind==="source"?(ie=[nf*m.layout.get("text-size").evaluate(b,{},le)*H.textScaleFactor],ie[0]>cm&&Hi(`${o.layerIds[0]}: Value for "text-size" is >= ${Gg}. Reduce your "text-size".`)):we.kind==="composite"&&(ie=[nf*H.compositeTextSizes[0].evaluate(b,{},le)*H.textScaleFactor,nf*H.compositeTextSizes[1].evaluate(b,{},le)*H.textScaleFactor],(ie[0]>cm||ie[1]>cm)&&Hi(`${o.layerIds[0]}: Value for "text-size" is >= ${Gg}. Reduce your "text-size".`)),o.addSymbols(o.text,Ce,ie,I,_,b,L,e,n,E.lineStartIndex,E.lineLength,W,ee,le,de,!1);for(let me of F)V[me]=o.text.placedSymbolArray.length-1;return 4*Ce.length}function gx(o){for(let e in o)return o[e];return null}function Qy(o,e,n,l,c,m,_,b,I,E){let L=_.top,F=_.bottom,V=_.left,W=_.right;if(Tv(_)&&_.collisionPadding){let H=_.collisionPadding;V-=H[0],L-=H[1],W+=H[2],F+=H[3]}if(I){let H=new Ue(V,L),ee=new Ue(W,L),le=new Ue(V,F),de=new Ue(W,F),Ce=te(I),we=new Ue(0,0);E&&(we=new Ue(E[0],E[1])),H._rotateAround(Ce,we),ee._rotateAround(Ce,we),le._rotateAround(Ce,we),de._rotateAround(Ce,we),V=Math.min(H.x,ee.x,le.x,de.x),W=Math.max(H.x,ee.x,le.x,de.x),L=Math.min(H.y,ee.y,le.y,de.y),F=Math.max(H.y,ee.y,le.y,de.y)}return o.emplaceBack(e.x,e.y,e.z,n.x,n.y,V,L,W,F,b,l,c,m),o.length-1}function yx(o){Tv(o)&&o.collisionPadding&&(o.top-=o.collisionPadding[1],o.bottom+=o.collisionPadding[3]);let e=o.bottom-o.top;return e>0?Math.max(10,e):null}function Jw(o,e,n,l){let c=o.compareText;if(e in c){let m=c[e];for(let _=m.length-1;_>=0;_--)if(l.dist(m[_])<n)return!0}else c[e]=[];return c[e].push(l),!1}function Wv(o,e){let n=o.fovAboveCenter,l=o.elevation?o.elevation.getMinElevationBelowMSL()*e:0,c=(o._camera.position[2]*o.worldSize-l)/Math.cos(o._pitch),m=Math.sin(n)*c/Math.sin(Math.max(Math.PI/2-o._pitch-n,.01)),_=Math.sin(o._pitch)*m+c,b=c*(1/o._horizonShift);if(!o.elevation||o.elevation.exaggeration()===0){let I=Math.max(o.zoom-17,0);o.isOrthographic&&(I/=10),_*=1+I}return Math.min(1.01*_,b)}function Zg(o,e){if(!e.isReprojectedInTileSpace)return{scale:1<<o.z,x:o.x,y:o.y,x2:o.x+1,y2:o.y+1,projection:e};let n=Math.pow(2,-o.z),l=o.x*n,c=(o.x+1)*n,m=o.y*n,_=(o.y+1)*n,b=Ke(l),I=Ke(c),E=Qe(m),L=Qe(_),F=e.project(b,E),V=e.project(I,E),W=e.project(I,L),H=e.project(b,L),ee=Math.min(F.x,V.x,W.x,H.x),le=Math.min(F.y,V.y,W.y,H.y),de=Math.max(F.x,V.x,W.x,H.x),Ce=Math.max(F.y,V.y,W.y,H.y),we=n/16;function ie(Ie,ze,Je,st,ut,xt){let Ft=(Je+ut)/2,ri=(st+xt)/2,$t=e.project(Ke(Ft),Qe(ri)),Qt=Math.max(0,ee-$t.x,le-$t.y,$t.x-de,$t.y-Ce);ee=Math.min(ee,$t.x),de=Math.max(de,$t.x),le=Math.min(le,$t.y),Ce=Math.max(Ce,$t.y),Qt>we&&(ie(Ie,$t,Je,st,Ft,ri),ie($t,ze,Ft,ri,ut,xt))}ie(F,V,l,m,c,m),ie(V,W,c,m,c,_),ie(W,H,c,_,l,_),ie(H,F,l,_,l,m),ee-=we,le-=we,de+=we,Ce+=we;let me=1/Math.max(de-ee,Ce-le);return{scale:me,x:ee*me,y:le*me,x2:de*me,y2:Ce*me,projection:e}}function Hv(o,{x:e,y:n},l=0){return new Ue(((e-l)*o.scale-o.x)*xi,(n*o.scale-o.y)*xi)}let Qw=on(new Float32Array(16));class hm{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,n){return{x:0,y:0,z:0}}unproject(e,n){return new ae(0,0)}projectTilePoint(e,n,l){return{x:e,y:n,z:0}}locationPoint(e,n,l,c=!0){return e._coordinatePoint(e.locationCoordinate(n,l),c)}pixelsPerMeter(e,n){return Oe(1,e)*n}pixelSpaceConversion(e,n,l){return 1}farthestPixelDistance(e){return Wv(e,e.pixelsPerMeter)}pointCoordinate(e,n,l,c){let m=e.horizonLineFromTop(!1),_=new Ue(n,Math.max(m,l));return e.rayIntersectionCoordinate(e.pointRayIntersection(_,c))}pointCoordinate3D(e,n,l){let c=new Ue(n,l);if(e.elevation)return e.elevation.pointCoordinate(c);{let m=this.pointCoordinate(e,c.x,c.y,0);return[m.x,m.y,m.z]}}isPointAboveHorizon(e,n){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,n.x,n.y);let l=e.horizonLineFromTop();return n.y<l}createInversionMatrix(e,n){return Qw}createTileMatrix(e,n,l){let c,m,_,b=l.canonical,I=on(new Float64Array(16));if(this.isReprojectedInTileSpace){let E=Zg(b,this);c=1,m=E.x+l.wrap*E.scale,_=E.y,Bo(I,I,[c/E.scale,c/E.scale,e.pixelsPerMeter/n])}else c=n/e.zoomScale(b.z),m=(b.x+Math.pow(2,b.z)*l.wrap)*c,_=b.y*c;return vr(I,I,[m,_,0]),Bo(I,I,[c/xi,c/xi,1]),I}upVector(e,n,l){return[0,0,1]}upVectorScale(e,n,l){return{metersToTile:1}}}class e2 extends hm{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];let[n,l]=this.parallels=e.parallels||[29.5,45.5],c=Math.sin(te(n));this.n=(c+Math.sin(te(l)))/2,this.c=1+c*(2*this.n-c),this.r0=Math.sqrt(this.c)/this.n}project(e,n){let{n:l,c,r0:m}=this,_=te(e-this.center[0]),b=te(n),I=Math.sqrt(c-2*l*Math.sin(b))/l;return{x:I*Math.sin(_*l),y:I*Math.cos(_*l)-m,z:0}}unproject(e,n){let{n:l,c,r0:m}=this,_=m+n,b=Math.atan2(e,Math.abs(_))*Math.sign(_);_*l<0&&(b-=Math.PI*Math.sign(e)*Math.sign(_));let I=te(this.center[0])*l;b=nt(b,-Math.PI-I,Math.PI-I);let E=rt(fe(b/l)+this.center[0],-180,180),L=Math.asin(rt((c-(e*e+_*_)*l*l)/(2*l),-1,1)),F=rt(fe(L),-gt,gt);return new ae(E,F)}}let qg=1.340264,$g=-.081106,Wg=893e-6,Hg=.003796,e0=Math.sqrt(3)/2;class t2 extends hm{project(e,n){n=n/180*Math.PI,e=e/180*Math.PI;let l=Math.asin(e0*Math.sin(n)),c=l*l,m=c*c*c;return{x:.5*(e*Math.cos(l)/(e0*(qg+3*$g*c+m*(7*Wg+9*Hg*c)))/Math.PI+.5),y:1-.5*(l*(qg+$g*c+m*(Wg+Hg*c))/Math.PI+1),z:0}}unproject(e,n){e=(2*e-.5)*Math.PI;let l=n=(2*(1-n)-1)*Math.PI,c=l*l,m=c*c*c;for(let L,F,V,W=0;W<12&&(F=l*(qg+$g*c+m*(Wg+Hg*c))-n,V=qg+3*$g*c+m*(7*Wg+9*Hg*c),L=F/V,l=rt(l-L,-Math.PI/3,Math.PI/3),c=l*l,m=c*c*c,!(Math.abs(L)<1e-12));++W);let _=e0*e*(qg+3*$g*c+m*(7*Wg+9*Hg*c))/Math.cos(l),b=Math.asin(Math.sin(l)/e0),I=rt(180*_/Math.PI,-180,180),E=rt(180*b/Math.PI,-gt,gt);return new ae(I,E)}}class i2 extends hm{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,n){return{x:.5+e/360,y:.5-n/360,z:0}}unproject(e,n){let l=360*(e-.5),c=rt(360*(.5-n),-gt,gt);return new ae(l,c)}}let z_=Math.PI/2;function t0(o){return Math.tan((z_+o)/2)}class n2 extends hm{constructor(e){super(e),this.center=e.center||[0,30];let[n,l]=this.parallels=e.parallels||[30,30],c=te(n),m=te(l);this.southernCenter=c+m<0,this.southernCenter&&(c=-c,m=-m);let _=Math.cos(c),b=t0(c);this.n=c===m?Math.sin(c):Math.log(_/Math.cos(m))/Math.log(t0(m)/b),this.f=_*Math.pow(t0(c),this.n)/this.n}project(e,n){n=te(n),this.southernCenter&&(n=-n),e=te(e-this.center[0]);let l=1e-6,{n:c,f:m}=this;m>0?n<-z_+l&&(n=-z_+l):n>z_-l&&(n=z_-l);let _=m/Math.pow(t0(n),c),b=_*Math.sin(c*e),I=m-_*Math.cos(c*e);return b=.5*(b/Math.PI+.5),I=.5*(I/Math.PI+.5),{x:b,y:this.southernCenter?I:1-I,z:0}}unproject(e,n){e=(2*e-.5)*Math.PI,this.southernCenter&&(n=1-n),n=(2*(1-n)-.5)*Math.PI;let{n:l,f:c}=this,m=c-n,_=Math.sign(m),b=Math.sign(l)*Math.sqrt(e*e+m*m),I=Math.atan2(e,Math.abs(m))*_;m*l<0&&(I-=Math.PI*Math.sign(e)*_);let E=rt(fe(I/l)+this.center[0],-180,180),L=rt(fe(2*Math.atan(Math.pow(c/b,1/l))-z_),-gt,gt);return new ae(E,this.southernCenter?-L:L)}}class Xv extends hm{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,n){return{x:Ne(e),y:Ve(n),z:0}}unproject(e,n){let l=Ke(e),c=Qe(n);return new ae(l,c)}}let Kv=te(gt);class r2 extends hm{project(e,n){let l=(n=te(n))*n,c=l*l;return{x:.5*((e=te(e))*(.8707-.131979*l+c*(c*(.003971*l-.001529*c)-.013791))/Math.PI+.5),y:1-.5*(n*(1.007226+l*(.015085+c*(.028874*l-.044475-.005916*c)))/Math.PI+1),z:0}}unproject(e,n){e=(2*e-.5)*Math.PI;let l=n=(2*(1-n)-1)*Math.PI,c=25,m=0,_=l*l;do{_=l*l;let E=_*_;m=(l*(1.007226+_*(.015085+E*(.028874*_-.044475-.005916*E)))-n)/(1.007226+_*(.045255+E*(.259866*_-.311325-.005916*11*E))),l=rt(l-m,-Kv,Kv)}while(Math.abs(m)>1e-6&&--c>0);_=l*l;let b=rt(fe(e/(.8707+_*(_*(_*_*_*(.003971-.001529*_)-.013791)-.131979))),-180,180),I=fe(l);return new ae(b,I)}}let Yv=te(gt);class o2 extends hm{project(e,n){n=te(n),e=te(e);let l=Math.cos(n),c=2/Math.PI,m=Math.acos(l*Math.cos(e/2)),_=Math.sin(m)/m,b=.5*(e*c+2*l*Math.sin(e/2)/_)||0,I=.5*(n+Math.sin(n)/_)||0;return{x:.5*(b/Math.PI+.5),y:1-.5*(I/Math.PI+1),z:0}}unproject(e,n){let l=e=(2*e-.5)*Math.PI,c=n=(2*(1-n)-1)*Math.PI,m=25,_=1e-6,b=0,I=0;do{let E=Math.cos(c),L=Math.sin(c),F=2*L*E,V=L*L,W=E*E,H=Math.cos(l/2),ee=Math.sin(l/2),le=2*H*ee,de=ee*ee,Ce=1-W*H*H,we=Ce?1/Ce:0,ie=Ce?Math.acos(E*H)*Math.sqrt(1/Ce):0,me=.5*(2*ie*E*ee+2*l/Math.PI)-e,Ie=.5*(ie*L+c)-n,ze=.5*we*(W*de+ie*E*H*V)+1/Math.PI,Je=we*(le*F/4-ie*L*ee),st=.125*we*(F*ee-ie*L*W*le),ut=.5*we*(V*H+ie*de*E)+.5,xt=Je*st-ut*ze;b=(Ie*Je-me*ut)/xt,I=(me*st-Ie*ze)/xt,l=rt(l-b,-Math.PI,Math.PI),c=rt(c-I,-Yv,Yv)}while((Math.abs(b)>_||Math.abs(I)>_)&&--m>0);return new ae(fe(l),fe(c))}}class Jv extends hm{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(te(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,n){let{scale:l,cosPhi:c}=this;return{x:te(e)*c*l+.5,y:-Math.sin(te(n))/c*l+.5,z:0}}unproject(e,n){let{scale:l,cosPhi:c}=this,m=-(n-.5)/l,_=rt(fe((e-.5)/l)/c,-180,180),b=Math.asin(rt(m*c,-1,1)),I=rt(fe(b),-gt,gt);return new ae(_,I)}}class s2 extends Xv{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,n,l){let c=Yf(e,n,l);return gr(c,c,If(Kh(l))),{x:c[0],y:c[1],z:c[2]}}locationPoint(e,n,l){let c=se(n.lat,n.lng),m=Lr([],c),_=l?e._centerAltitude+l:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(n),e._centerAltitude):e._centerAltitude;as(c,c,m,Oe(1,0)*xi*_);let b=on(new Float64Array(16));return gn(b,e.pixelMatrix,e.globeMatrix),gr(c,c,b),new Ue(c[0],c[1])}pixelsPerMeter(e,n){return Oe(1,0)*n}pixelSpaceConversion(e,n,l){let c=Oe(1,e)*n,m=en(Oe(1,45)*n,c,l);return this.pixelsPerMeter(e,n)/m}createTileMatrix(e,n,l){let c=Jf(Kh(l.canonical));return gn(new Float64Array(16),e.globeMatrix,c)}createInversionMatrix(e,n){let{center:l}=e,c=If(Kh(n));return to(c,c,te(l.lng)),qo(c,c,te(l.lat)),Bo(c,c,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(c)}pointCoordinate(e,n,l,c){return py(e,n,l,!0)||new Ct(0,0)}pointCoordinate3D(e,n,l){let c=this.pointCoordinate(e,n,l,0);return[c.x,c.y,c.z]}isPointAboveHorizon(e,n){return!py(e,n.x,n.y,!1)}farthestPixelDistance(e){let n=function(c,m){let _=c.cameraToCenterDistance,b=c._centerAltitude*m,I=c._camera,E=c._camera.forward(),L=ho([],Mr([],E,-_),[0,0,b]),F=c.worldSize/(2*Math.PI),V=[0,0,-F],W=c.width/c.height,H=Math.tan(c.fovAboveCenter),ee=Mr([],I.up(),H),le=Mr([],I.right(),H*W),de=Lr([],ho([],ho([],E,ee),le)),Ce=[],we;if(new Th(L,de).closestPointOnSphere(V,F,Ce)){let ie=ho([],Ce,V),me=hr([],ie,L);we=Math.cos(c.fovAboveCenter)*No(me)}else{let ie=hr([],L,V),me=hr([],V,L);Lr(me,me);let Ie=No(ie)-F;we=Math.sqrt(Ie*(Ie+2*F));let ze=Math.acos(we/(F+Ie))-Math.acos(jr(E,me));we*=Math.cos(ze)}return 1.01*we}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),l=mp(e.zoom);if(l>0){let c=Wv(e,Oe(1,e.center.lat)*e.worldSize),m=e.worldSize/(2*Math.PI),_=Math.max(e.width,e.height)/e.worldSize*Math.PI;return en(n,c+m*(1-Math.cos(_)),Math.pow(l,10))}return n}upVector(e,n,l){return Yf(n,l,e,1)}upVectorScale(e){return{metersToTile:vs(Jp(Kh(e)))}}}function Qv(o){let e=o.parallels,n=!!e&&Math.abs(e[0]+e[1])<.01;switch(o.name){case"mercator":return new Xv(o);case"equirectangular":return new i2(o);case"naturalEarth":return new r2(o);case"equalEarth":return new t2(o);case"winkelTripel":return new o2(o);case"albers":return n?new Jv(o):new e2(o);case"lambertConformalConic":return n?new Jv(o):new n2(o);case"globe":return new s2(o)}throw new Error(`Invalid projection name: ${o.name}`)}let a2=bp.VectorTileFeature.types,l2=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function i0(o,e,n,l,c,m,_,b,I,E,L,F,V){let W=b?Math.min(cm,Math.round(b[0])):0,H=b?Math.min(cm,Math.round(b[1])):0;o.emplaceBack(e,n,Math.round(32*l),Math.round(32*c),m,_,(W<<1)+(I?1:0),H,16*E,16*L,256*F,256*V)}function n0(o,e,n){o.emplaceBack(e,n)}function r0(o,e,n,l,c,m,_){o.emplaceBack(e,n,l,c,m,_)}function o0(o,e,n,l,c){o.emplaceBack(e,n,l,c),o.emplaceBack(e,n,l,c),o.emplaceBack(e,n,l,c),o.emplaceBack(e,n,l,c)}function c2(o){for(let e of o.sections)if(ep(e.text))return!0;return!1}class xx{constructor(e){this.layoutVertexArray=new Su,this.indexArray=new zo,this.programConfigurations=e,this.segments=new bo,this.dynamicLayoutVertexArray=new jl,this.opacityVertexArray=new Iu,this.placedSymbolArray=new Dm,this.iconTransitioningVertexArray=new xl,this.globeExtVertexArray=new el,this.zOffsetVertexArray=new dc}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,n,l,c,m){this.isEmpty()||(l&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Sh.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,n),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,Pu.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,l2,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,_d.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Rf.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||m)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,zf.members,!0)),this.opacityVertexBuffer.itemSize=1),(l||c)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}Ei(xx,"SymbolBuffers");class vx{constructor(e,n,l){this.layoutVertexArray=new e,this.layoutAttributes=n,this.indexArray=new l,this.segments=new bo,this.collisionVertexArray=new np,this.collisionVertexArrayExt=new jl}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,Pw.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,Aw.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Ei(vx,"CollisionBuffers");class s0{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.lut=e.lut,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(_=>_.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=on([]),this.placementViewportMatrix=on([]);let n=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Mv(this.zoom,n["text-size"]),this.iconSizeData=Mv(this.zoom,n["icon-size"]);let l=this.layers[0].layout,c=l.get("symbol-sort-key"),m=l.get("symbol-z-order");this.canOverlap=l.get("text-allow-overlap")||l.get("icon-allow-overlap")||l.get("text-ignore-placement")||l.get("icon-ignore-placement"),this.sortFeaturesByKey=m!=="viewport-y"&&c.constantOr(1)!==void 0,this.sortFeaturesByY=(m==="viewport-y"||m==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=l.get("text-writing-mode").map(_=>Ih[_]),this.stateDependentLayerIds=this.layers.filter(_=>_.isStateDependent()).map(_=>_.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new xx(new hp(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new xx(new hp(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new zm,this.lineVertexArray=new Hp,this.symbolInstances=new lp}calculateGlyphDependencies(e,n,l,c,m){for(let _ of e){let b=_.codePointAt(0);if(b===void 0)break;if(n[b]=!0,c&&m&&b<=65535){let I=Bg[_];I&&(n[I.charCodeAt(0)]=!0)}}}updateFootprints(e,n){}updateReplacement(e,n){if(n.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=n.updateTime;let l=n.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!_e(this.activeReplacements,l)&&(this.activeReplacements=l,!0)}populate(e,n,l,c){let m=this.layers[0],_=m.layout,b=this.projection.name==="globe",I=_.get("text-font"),E=_.get("text-field"),L=_.get("icon-image"),[F,V]=_.get("icon-size-scale-range"),W=rt(n.scaleFactor||1,F,V),H=(E.value.kind!=="constant"||E.value.value instanceof Ks&&!E.value.value.isEmpty()||E.value.value.toString().length>0)&&(I.value.kind!=="constant"||I.value.value.length>0),ee=L.value.kind!=="constant"||!!L.value.value||Object.keys(L.parameters).length>0,le=_.get("symbol-sort-key");if(this.features=[],!H&&!ee)return;let de=n.iconDependencies,Ce=n.glyphDependencies,we=n.availableImages,ie=new J(this.zoom);for(let{feature:me,id:Ie,index:ze,sourceLayerIndex:Je}of e){let st=m._featureFilter.needGeometry,ut=ji(me,st);if(!m._featureFilter.filter(ie,ut,l))continue;if(st||(ut.geometry=ki(me,l,c)),b&&me.type!==1&&l.z<=5){let Qt=ut.geometry,hi=.98078528056,Rt=(Yt,Et)=>jr(Yf(Yt.x,Yt.y,l,1),Yf(Et.x,Et.y,l,1))<hi;for(let Yt=0;Yt<Qt.length;Yt++)Qt[Yt]=ti(Qt[Yt],Rt)}let xt,Ft;if(H){let Qt=m.getValueAndResolveTokens("text-field",ut,l,we),hi=Ks.factory(Qt);c2(hi)&&(this.hasRTLText=!0),(!this.hasRTLText||k()==="unavailable"||this.hasRTLText&&q.isParsed())&&(xt=Rw(hi,m,ut))}if(ee){let Qt=m.getValueAndResolveTokens("icon-image",ut,l,we);Ft=typeof Qt=="string"?Xa.build(Qt):Qt}if(!xt&&!Ft)continue;let ri=this.sortFeaturesByKey?le.evaluate(ut,{},l):void 0,$t={id:Ie,text:xt,icon:Ft,index:ze,sourceLayerIndex:Je,geometry:ut.geometry,properties:me.properties,type:a2[me.type],sortKey:ri};if(this.features.push($t),Ft){let Qt=this.layers[0]._unevaluatedLayout._values,{iconPrimary:hi,iconSecondary:Rt}=Gv(Ft,this.iconSizeData,Qt["icon-size"],l,this.zoom,$t,this.pixelRatio,W),Yt=hi.id.toString();if(de.has(Yt)?de.get(Yt).push(hi):de.set(Yt,[hi]),Rt){let Et=Rt.id.toString();de.has(Et)?de.get(Et).push(Rt):de.set(Et,[Rt])}}if(xt){let Qt=I.evaluate(ut,{},l).join(","),hi=_.get("text-rotation-alignment")==="map"&&_.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Ih.vertical)>=0;for(let Rt of xt.sections)if(Rt.image){let Yt=Rt.image.getPrimary().scaleSelf(this.pixelRatio),Et=Yt.id.toString(),kt=de.get(Et)||[];kt.push(Yt),de.set(Et,kt)}else{let Yt=Wo(xt.toString()),Et=Rt.fontStack||Qt,kt=Ce[Et]=Ce[Et]||{};this.calculateGlyphDependencies(Rt.text,kt,hi,this.allowVerticalPlacement,Yt)}}}if(_.get("symbol-placement")==="line"&&(this.features=function(me){let Ie={},ze={},Je=[],st=0;function ut($t){Je.push(me[$t]),st++}function xt($t,Qt,hi){let Rt=ze[$t];return delete ze[$t],ze[Qt]=Rt,Je[Rt].geometry[0].pop(),Je[Rt].geometry[0]=Je[Rt].geometry[0].concat(hi[0]),Rt}function Ft($t,Qt,hi){let Rt=Ie[Qt];return delete Ie[Qt],Ie[$t]=Rt,Je[Rt].geometry[0].shift(),Je[Rt].geometry[0]=hi[0].concat(Je[Rt].geometry[0]),Rt}function ri($t,Qt,hi){let Rt=hi?Qt[0][Qt[0].length-1]:Qt[0][0];return`${$t}:${Rt.x}:${Rt.y}`}for(let $t=0;$t<me.length;$t++){let Qt=me[$t],hi=Qt.geometry,Rt=Qt.text?Qt.text.toString():null;if(!Rt){ut($t);continue}let Yt=ri(Rt,hi),Et=ri(Rt,hi,!0);if(Yt in ze&&Et in Ie&&ze[Yt]!==Ie[Et]){let kt=Ft(Yt,Et,hi),pi=xt(Yt,Et,Je[kt].geometry);delete Ie[Yt],delete ze[Et],ze[ri(Rt,Je[pi].geometry,!0)]=pi,Je[kt].geometry=null}else Yt in ze?xt(Yt,Et,hi):Et in Ie?Ft(Yt,Et,hi):(ut($t),Ie[Yt]=st-1,ze[Et]=st-1)}return Je.filter($t=>$t.geometry)}(this.features)),_.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",n.elevationFeatures){!this.elevationFeatures&&n.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(let me of n.elevationFeatures)this.elevationFeatureIdToIndex.set(me.id,this.elevationFeatures.length),this.elevationFeatures.push(me)}}else _.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((me,Ie)=>me.sortKey-Ie.sortKey)}update(e,n,l,c,m,_,b){this.text.programConfigurations.updatePaintArrays(e,n,m,l,c,_,b),this.icon.programConfigurations.updatePaintArrays(e,n,m,l,c,_,b)}updateRoadElevation(){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let e=!1;for(let n=0;n<this.symbolInstances.length;n++){let l=this.symbolInstances.get(n);if(l.elevationFeatureIndex===65535)continue;let c=this.elevationFeatures[l.elevationFeatureIndex];if(c){let m=.05+c.pointElevation(new Ue(l.tileAnchorX,l.tileAnchorY));l.zOffset!==m&&(e=!0,l.zOffset=m)}}e&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){let e=(m,_,b)=>{l+=_,l>m.length&&m.resize(l);for(let I=-_;I<0;I++)m.emplace(I+l,b)},n=(m,_,b)=>{c+=_,c>m.length&&m.resize(c);for(let I=-_;I<0;I++)m.emplace(I+c,b)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let l=0,c=0;for(let m=0;m<this.symbolInstances.length;m++){let _=this.symbolInstances.get(m),{numHorizontalGlyphVertices:b,numVerticalGlyphVertices:I,numIconVertices:E}=_,L=_.zOffset,F=E>0;if((b>0||I>0)&&(e(this.text.zOffsetVertexArray,b,L),e(this.text.zOffsetVertexArray,I,L)),F){let{placedIconSymbolIndex:V,verticalPlacedIconSymbolIndex:W}=_;V>=0&&n(this.icon.zOffsetVertexArray,E,L),W>=0&&n(this.icon.zOffsetVertexArray,_.numVerticalIconVertices,L)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Qv(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,n){let l=this.lineVertexArray.length;if(e.segment!==void 0)for(let{x:c,y:m}of n)this.lineVertexArray.emplaceBack(c,m);return{lineStartIndex:l,lineLength:this.lineVertexArray.length-l}}addSymbols(e,n,l,c,m,_,b,I,E,L,F,V,W,H,ee,le){let de=e.indexArray,Ce=e.layoutVertexArray,we=e.globeExtVertexArray,ie=e.segments.prepareSegment(4*n.length,Ce,de,this.canOverlap?_.sortKey:void 0),me=this.glyphOffsetArray.length,Ie=ie.vertexLength,ze=this.allowVerticalPlacement&&b===Ih.vertical?Math.PI/2:0,Je=_.text&&_.text.sections;for(let ut=0;ut<n.length;ut++){let{tl:xt,tr:Ft,bl:ri,br:$t,texPrimary:Qt,texSecondary:hi,pixelOffsetTL:Rt,pixelOffsetBR:Yt,minFontScaleX:Et,minFontScaleY:kt,glyphOffset:pi,isSDF:mi,sectionIndex:qi}=n[ut],Bi=ie.vertexLength,Ti=pi[1];if(i0(Ce,E.x,E.y,xt.x,Ti+xt.y,Qt.x,Qt.y,l,mi,Rt.x,Rt.y,Et,kt),i0(Ce,E.x,E.y,Ft.x,Ti+Ft.y,Qt.x+Qt.w,Qt.y,l,mi,Yt.x,Rt.y,Et,kt),i0(Ce,E.x,E.y,ri.x,Ti+ri.y,Qt.x,Qt.y+Qt.h,l,mi,Rt.x,Yt.y,Et,kt),i0(Ce,E.x,E.y,$t.x,Ti+$t.y,Qt.x+Qt.w,Qt.y+Qt.h,l,mi,Yt.x,Yt.y,Et,kt),I){let{x:ui,y:bn,z:Vi}=I.anchor,[Ui,mn,Pn]=I.up;r0(we,ui,bn,Vi,Ui,mn,Pn),r0(we,ui,bn,Vi,Ui,mn,Pn),r0(we,ui,bn,Vi,Ui,mn,Pn),r0(we,ui,bn,Vi,Ui,mn,Pn),o0(e.dynamicLayoutVertexArray,ui,bn,Vi,ze)}else o0(e.dynamicLayoutVertexArray,E.x,E.y,E.z,ze);if(le){let ui=hi||Qt;n0(e.iconTransitioningVertexArray,ui.x,ui.y),n0(e.iconTransitioningVertexArray,ui.x+ui.w,ui.y),n0(e.iconTransitioningVertexArray,ui.x,ui.y+ui.h),n0(e.iconTransitioningVertexArray,ui.x+ui.w,ui.y+ui.h)}de.emplaceBack(Bi,Bi+1,Bi+2),de.emplaceBack(Bi+1,Bi+2,Bi+3),ie.vertexLength+=4,ie.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(pi[0]),ut!==n.length-1&&qi===n[ut+1].sectionIndex||e.programConfigurations.populatePaintArrays(Ce.length,_,_.index,{},W,H,ee,Je&&Je[qi])}let st=I?I.anchor:E;e.placedSymbolArray.emplaceBack(st.x,st.y,st.z,E.x,E.y,me,this.glyphOffsetArray.length-me,Ie,L,F,E.segment,l?l[0]:0,l?l[1]:0,c[0],c[1],b,0,0,0,V,0)}_commitLayoutVertex(e,n,l,c,m,_,b){e.emplaceBack(n,l,c,m,_,Math.round(b.x),Math.round(b.y))}_addCollisionDebugVertices(e,n,l,c,m,_,b){let I=l.segments.prepareSegment(4,l.layoutVertexArray,l.indexArray),E=I.vertexLength,L=b.tileAnchorX,F=b.tileAnchorY;for(let W=0;W<4;W++)l.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(l.collisionVertexArrayExt,n,e.padding,b.zOffset),this._commitLayoutVertex(l.layoutVertexArray,c,m,_,L,F,new Ue(e.x1,e.y1)),this._commitLayoutVertex(l.layoutVertexArray,c,m,_,L,F,new Ue(e.x2,e.y1)),this._commitLayoutVertex(l.layoutVertexArray,c,m,_,L,F,new Ue(e.x2,e.y2)),this._commitLayoutVertex(l.layoutVertexArray,c,m,_,L,F,new Ue(e.x1,e.y2)),I.vertexLength+=4;let V=l.indexArray;V.emplaceBack(E,E+1),V.emplaceBack(E+1,E+2),V.emplaceBack(E+2,E+3),V.emplaceBack(E+3,E),I.primitiveLength+=4}_addTextDebugCollisionBoxes(e,n,l,c,m,_){for(let b=c;b<m;b++){let I=l.get(b),E=this.getSymbolInstanceTextSize(e,_,n,b);this._addCollisionDebugVertices(I,E,this.textCollisionBox,I.projectedAnchorX,I.projectedAnchorY,I.projectedAnchorZ,_)}}_addIconDebugCollisionBoxes(e,n,l,c,m,_){for(let b=c;b<m;b++){let I=l.get(b),E=this.getSymbolInstanceIconSize(e,n,_.placedIconSymbolIndex);this._addCollisionDebugVertices(I,E,this.iconCollisionBox,I.projectedAnchorX,I.projectedAnchorY,I.projectedAnchorZ,_)}}generateCollisionDebugBuffers(e,n,l){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new vx(Us,pv.members,xl),this.iconCollisionBox=new vx(Us,pv.members,xl);let c=Vg(this.iconSizeData,e),m=Vg(this.textSizeData,e,l);for(let _=0;_<this.symbolInstances.length;_++){let b=this.symbolInstances.get(_);this._addTextDebugCollisionBoxes(m,e,n,b.textBoxStartIndex,b.textBoxEndIndex,b),this._addTextDebugCollisionBoxes(m,e,n,b.verticalTextBoxStartIndex,b.verticalTextBoxEndIndex,b),this._addIconDebugCollisionBoxes(c,e,n,b.iconBoxStartIndex,b.iconBoxEndIndex,b),this._addIconDebugCollisionBoxes(c,e,n,b.verticalIconBoxStartIndex,b.verticalIconBoxEndIndex,b)}}getSymbolInstanceTextSize(e,n,l,c){let m=this.text.placedSymbolArray.get(n.rightJustifiedTextSymbolIndex>=0?n.rightJustifiedTextSymbolIndex:n.centerJustifiedTextSymbolIndex>=0?n.centerJustifiedTextSymbolIndex:n.leftJustifiedTextSymbolIndex>=0?n.leftJustifiedTextSymbolIndex:n.verticalPlacedTextSymbolIndex>=0?n.verticalPlacedTextSymbolIndex:c),_=dx(this.textSizeData,e,m)/ja;return this.tilePixelRatio*_}getSymbolInstanceIconSize(e,n,l){let c=this.icon.placedSymbolArray.get(l),m=dx(this.iconSizeData,e,c);return this.tilePixelRatio*m}_commitDebugCollisionVertexUpdate(e,n,l,c){e.emplaceBack(n,-l,-l,c),e.emplaceBack(n,l,-l,c),e.emplaceBack(n,l,l,c),e.emplaceBack(n,-l,l,c)}_updateTextDebugCollisionBoxes(e,n,l,c,m,_,b){for(let I=c;I<m;I++){let E=l.get(I),L=this.getSymbolInstanceTextSize(e,_,n,I);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,L,E.padding,_.zOffset)}}_updateIconDebugCollisionBoxes(e,n,l,c,m,_,b){for(let I=c;I<m;I++){let E=l.get(I),L=this.getSymbolInstanceIconSize(e,n,_.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,L,E.padding,_.zOffset)}}updateCollisionDebugBuffers(e,n,l,c){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();let m=Vg(this.iconSizeData,e,c),_=Vg(this.textSizeData,e,l);for(let b=0;b<this.symbolInstances.length;b++){let I=this.symbolInstances.get(b);this._updateTextDebugCollisionBoxes(_,e,n,I.textBoxStartIndex,I.textBoxEndIndex,I,l),this._updateTextDebugCollisionBoxes(_,e,n,I.verticalTextBoxStartIndex,I.verticalTextBoxEndIndex,I,l),this._updateIconDebugCollisionBoxes(m,e,n,I.iconBoxStartIndex,I.iconBoxEndIndex,I,c),this._updateIconDebugCollisionBoxes(m,e,n,I.verticalIconBoxStartIndex,I.verticalIconBoxEndIndex,I,c)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,n,l,c,m,_,b,I,E){let L={};if(n<l){let{x1:F,y1:V,x2:W,y2:H,padding:ee,projectedAnchorX:le,projectedAnchorY:de,projectedAnchorZ:Ce,tileAnchorX:we,tileAnchorY:ie,featureIndex:me}=e.get(n);L.textBox={x1:F,y1:V,x2:W,y2:H,padding:ee,projectedAnchorX:le,projectedAnchorY:de,projectedAnchorZ:Ce,tileAnchorX:we,tileAnchorY:ie},L.textFeatureIndex=me}if(c<m){let{x1:F,y1:V,x2:W,y2:H,padding:ee,projectedAnchorX:le,projectedAnchorY:de,projectedAnchorZ:Ce,tileAnchorX:we,tileAnchorY:ie,featureIndex:me}=e.get(c);L.verticalTextBox={x1:F,y1:V,x2:W,y2:H,padding:ee,projectedAnchorX:le,projectedAnchorY:de,projectedAnchorZ:Ce,tileAnchorX:we,tileAnchorY:ie},L.verticalTextFeatureIndex=me}if(_<b){let{x1:F,y1:V,x2:W,y2:H,padding:ee,projectedAnchorX:le,projectedAnchorY:de,projectedAnchorZ:Ce,tileAnchorX:we,tileAnchorY:ie,featureIndex:me}=e.get(_);L.iconBox={x1:F,y1:V,x2:W,y2:H,padding:ee,projectedAnchorX:le,projectedAnchorY:de,projectedAnchorZ:Ce,tileAnchorX:we,tileAnchorY:ie},L.iconFeatureIndex=me}if(I<E){let{x1:F,y1:V,x2:W,y2:H,padding:ee,projectedAnchorX:le,projectedAnchorY:de,projectedAnchorZ:Ce,tileAnchorX:we,tileAnchorY:ie,featureIndex:me}=e.get(I);L.verticalIconBox={x1:F,y1:V,x2:W,y2:H,padding:ee,projectedAnchorX:le,projectedAnchorY:de,projectedAnchorZ:Ce,tileAnchorX:we,tileAnchorY:ie},L.verticalIconFeatureIndex=me}return L}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let n=0;n<this.symbolInstances.length;n++){let l=this.symbolInstances.get(n);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,l.textBoxStartIndex,l.textBoxEndIndex,l.verticalTextBoxStartIndex,l.verticalTextBoxEndIndex,l.iconBoxStartIndex,l.iconBoxEndIndex,l.verticalIconBoxStartIndex,l.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,n){let l=e.placedSymbolArray.get(n),c=l.vertexStartIndex+4*l.numGlyphs;for(let m=l.vertexStartIndex;m<c;m+=4)e.indexArray.emplaceBack(m,m+1,m+2),e.indexArray.emplaceBack(m+1,m+2,m+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;let n=Math.sin(e),l=Math.cos(e),c=[],m=[],_=[];for(let b=0;b<this.symbolInstances.length;++b){_.push(b);let I=this.symbolInstances.get(b);c.push(0|Math.round(n*I.tileAnchorX+l*I.tileAnchorY)),m.push(I.featureIndex)}return _.sort((b,I)=>c[b]-c[I]||m[I]-m[b]),_}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,n)=>this.symbolInstances.get(n).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,n){let l=this.sortKeyRanges[this.sortKeyRanges.length-1];l&&l.sortKey===n?l.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:n,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(let n of this.symbolInstanceIndexes){let l=this.symbolInstances.get(n);this.featureSortOrder.push(l.featureIndex);let{rightJustifiedTextSymbolIndex:c,centerJustifiedTextSymbolIndex:m,leftJustifiedTextSymbolIndex:_,verticalPlacedTextSymbolIndex:b,placedIconSymbolIndex:I,verticalPlacedIconSymbolIndex:E}=l;c>=0&&this.addIndicesForPlacedSymbol(this.text,c),m>=0&&m!==c&&this.addIndicesForPlacedSymbol(this.text,m),_>=0&&_!==m&&_!==c&&this.addIndicesForPlacedSymbol(this.text,_),b>=0&&this.addIndicesForPlacedSymbol(this.text,b),I>=0&&this.addIndicesForPlacedSymbol(this.icon,I),E>=0&&this.addIndicesForPlacedSymbol(this.icon,E)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let e1,t1,bx;Ei(s0,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),s0.addDynamicAttributes=o0;class i1{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:Dh,this.defaultValue=e}evaluate(e){if(e.formattedSection){let n=this.defaultValue.property.overrides;if(n&&n.hasOverride(e.formattedSection))return n.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Ei(i1,"FormatSectionOverride",{omit:["defaultValue"]});let wx=()=>bx||(bx={layout:e1||(e1=new dt({"symbol-placement":new Se(xe.layout_symbol["symbol-placement"]),"symbol-spacing":new Se(xe.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Se(xe.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Be(xe.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Se(xe.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new Se(xe.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new Se(xe.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new Se(xe.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Se(xe.layout_symbol["icon-ignore-placement"]),"icon-optional":new Se(xe.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Se(xe.layout_symbol["icon-rotation-alignment"]),"icon-size":new Be(xe.layout_symbol["icon-size"]),"icon-size-scale-range":new Se(xe.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new Be(xe.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Be(xe.layout_symbol["icon-text-fit-padding"]),"icon-image":new Be(xe.layout_symbol["icon-image"]),"icon-rotate":new Be(xe.layout_symbol["icon-rotate"]),"icon-padding":new Se(xe.layout_symbol["icon-padding"]),"icon-keep-upright":new Se(xe.layout_symbol["icon-keep-upright"]),"icon-offset":new Be(xe.layout_symbol["icon-offset"]),"icon-anchor":new Be(xe.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Se(xe.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Se(xe.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Se(xe.layout_symbol["text-rotation-alignment"]),"text-field":new Be(xe.layout_symbol["text-field"]),"text-font":new Be(xe.layout_symbol["text-font"]),"text-size":new Be(xe.layout_symbol["text-size"]),"text-size-scale-range":new Se(xe.layout_symbol["text-size-scale-range"]),"text-max-width":new Be(xe.layout_symbol["text-max-width"]),"text-line-height":new Be(xe.layout_symbol["text-line-height"]),"text-letter-spacing":new Be(xe.layout_symbol["text-letter-spacing"]),"text-justify":new Be(xe.layout_symbol["text-justify"]),"text-radial-offset":new Be(xe.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Se(xe.layout_symbol["text-variable-anchor"]),"text-anchor":new Be(xe.layout_symbol["text-anchor"]),"text-max-angle":new Se(xe.layout_symbol["text-max-angle"]),"text-writing-mode":new Se(xe.layout_symbol["text-writing-mode"]),"text-rotate":new Be(xe.layout_symbol["text-rotate"]),"text-padding":new Se(xe.layout_symbol["text-padding"]),"text-keep-upright":new Se(xe.layout_symbol["text-keep-upright"]),"text-transform":new Be(xe.layout_symbol["text-transform"]),"text-offset":new Be(xe.layout_symbol["text-offset"]),"text-allow-overlap":new Se(xe.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Se(xe.layout_symbol["text-ignore-placement"]),"text-optional":new Se(xe.layout_symbol["text-optional"]),visibility:new Se(xe.layout_symbol.visibility)})),paint:t1||(t1=new dt({"icon-opacity":new Be(xe.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new Be(xe.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new Be(xe.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Be(xe.paint_symbol["text-emissive-strength"]),"icon-color":new Be(xe.paint_symbol["icon-color"]),"icon-halo-color":new Be(xe.paint_symbol["icon-halo-color"]),"icon-halo-width":new Be(xe.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Be(xe.paint_symbol["icon-halo-blur"]),"icon-translate":new Se(xe.paint_symbol["icon-translate"]),"icon-translate-anchor":new Se(xe.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Se(xe.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Be(xe.paint_symbol["text-opacity"]),"text-occlusion-opacity":new Be(xe.paint_symbol["text-occlusion-opacity"]),"text-color":new Be(xe.paint_symbol["text-color"],{runtimeType:Do,getOverride:o=>o.textColor,hasOverride:o=>!!o.textColor}),"text-halo-color":new Be(xe.paint_symbol["text-halo-color"]),"text-halo-width":new Be(xe.paint_symbol["text-halo-width"]),"text-halo-blur":new Be(xe.paint_symbol["text-halo-blur"]),"text-translate":new Se(xe.paint_symbol["text-translate"]),"text-translate-anchor":new Se(xe.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new Se(xe.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new Se(xe.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new Se(xe.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new Se(xe.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new Be(xe.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"})}))},bx);class a0 extends lr{constructor(e,n,l,c){super(e,wx(),n,l,c),this._colorAdjustmentMatrix=on([]),this.hasInitialOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}recalculate(e,n){super.recalculate(e,n),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));let l=this.layout.get("text-writing-mode");if(l){let c=[];for(let m of l)c.indexOf(m)<0&&c.push(m);this.layout._values["text-writing-mode"]=c}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,n,l,c){return this._saturation===e&&this._contrast===n&&this._brightnessMin===l&&this._brightnessMax===c||(this._colorAdjustmentMatrix=function(m,_,b,I){m=Es(m),_=oa(_);let E=Wi(),L=m/3,F=1-2*L,V=[F,L,L,0,L,F,L,0,L,L,F,0,0,0,0,1],W=.5-.5*_,H=I-b;return gn(E,[H,0,0,0,0,H,0,0,0,0,H,0,b,b,b,1],[_,0,0,0,0,_,0,0,0,0,_,0,W,W,W,1]),gn(E,E,V),E}(e,n,l,c),this._saturation=e,this._contrast=n,this._brightnessMin=l,this._brightnessMax=c),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,n,l,c){let m=this.layout.get(e).evaluate(n,{},l,c),_=this._unevaluatedLayout._values[e];return _.isDataDriven()||Gh(_.value)||!m?m:function(b,I){return I.replace(/{([^{}]+)}/g,(E,L)=>L in b?String(b[L]):"")}(n.properties,m)}createBucket(e){return new s0(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(let e of wx().paint.overridableProperties){if(!a0.hasPaintOverride(this.layout,e))continue;let n=this.paint.get(e),l=new i1(n),c=new jo(l,n.property.specification,this.scope,this.options),m=null;m=n.value.kind==="constant"||n.value.kind==="source"?new _h("source",c):new bu("composite",c,n.value.zoomStops,n.value.interpolationType),this.paint._values[e]=new Xe(n.property,m,n.parameters)}}_handleOverridablePaintPropertyUpdate(e,n,l){return!(!this.layout||n.isDataDriven()||l.isDataDriven())&&a0.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,n){let l=e.get("text-field"),c=wx().paint.properties[n],m=!1,_=b=>{for(let I of b)if(c.overrides&&c.overrides.hasOverride(I))return void(m=!0)};if(l.value.kind==="constant"&&l.value.value instanceof Ks)_(l.value.value.sections);else if(l.value.kind==="source"){let b=E=>{m||(E instanceof Tn&&$o(E.value)===lu?_(E.value.sections):E instanceof zh?_(E.sections):E.eachChild(b))},I=l.value;I._styleExpression&&b(I._styleExpression.expression)}return m}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,n,l){return{config:new cd(this,{zoom:n,lut:l}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let n1,r1,o1,s1;var Tx=Kn([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function Sx(o){switch(o){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function Ix(o){switch(o){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class Cx{constructor(e,n,l,c){this.context=e,this.format=l,this.useMipmap=c&&c.useMipmap,this.texture=e.gl.createTexture(),this.update(n,{premultiply:c&&c.premultiply})}update(e,n){let l=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,c=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:m}=this,{gl:_}=m,{x:b,y:I}=n&&n.position?n.position:{x:0,y:0},E=b+l,L=I+c;!this.size||this.size[0]===E&&this.size[1]===L||(_.bindTexture(_.TEXTURE_2D,null),_.deleteTexture(this.texture),this.texture=_.createTexture(),this.size=null),_.bindTexture(_.TEXTURE_2D,this.texture),m.pixelStoreUnpackFlipY.set(!1),m.pixelStoreUnpack.set(1),m.pixelStoreUnpackPremultiplyAlpha.set(this.format===_.RGBA8&&(!n||n.premultiply!==!1));let F=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&E>0&&L>0){let V=this.useMipmap?Math.floor(Math.log2(Math.max(E,L)))+1:1;_.texStorage2D(_.TEXTURE_2D,V,this.format,E,L),this.size=[E,L]}if(this.size)if(F)_.texSubImage2D(_.TEXTURE_2D,0,b,I,Sx(this.format),Ix(this.format),e);else{let V=e.data;V&&_.texSubImage2D(_.TEXTURE_2D,0,b,I,l,c,Sx(this.format),Ix(this.format),V)}this.useMipmap&&_.generateMipmap(_.TEXTURE_2D)}bind(e,n,l=!1){let{context:c}=this,{gl:m}=c;m.bindTexture(m.TEXTURE_2D,this.texture),e!==this.minFilter&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,e),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,this.useMipmap&&!l?e===m.NEAREST?m.NEAREST_MIPMAP_NEAREST:m.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),n!==this.wrapS&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,n),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,n),this.wrapS=n)}bindExtraParam(e,n,l,c){let{context:m}=this,{gl:_}=m;_.bindTexture(_.TEXTURE_2D,this.texture),n!==this.magFilter&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MAG_FILTER,n),this.magFilter=n),e!==this.minFilter&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MIN_FILTER,this.useMipmap?e===_.NEAREST?_.NEAREST_MIPMAP_NEAREST:_.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),l!==this.wrapS&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_S,l),this.wrapS=l),c!==this.wrapT&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_T,c),this.wrapT=c)}destroy(){let{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class l0{constructor(e,n){this.context=e,this.texture=n}bind(e,n){let{context:l}=this,{gl:c}=l;c.bindTexture(c.TEXTURE_2D,this.texture),e!==this.minFilter&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,e),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,e),this.minFilter=e),n!==this.wrapS&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,n),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,n),this.wrapS=n)}}function c0(o,e,n,l,c,m,_,b){let I=[o,e,1,n,l,1,c,m,1],E=[_,b,1],L=an([],I),[F,V,W]=yc(E,E,L);return Dt(I,I,[F,0,0,0,V,0,0,0,W])}function a1(o,e,n,l,c,m,_,b){let I=function(E,L,F,V,W,H,ee,le){let de=c0(0,0,1,0,1,1,0,1),Ce=c0(E,L,F,V,W,H,ee,le);return Dt(Ce,Ce,an([],de))}(o,e,n,l,c,m,_,b);return[I[2]/I[8]/xi,I[5]/I[8]/xi]}function h0(o){return[o[0],Math.min(Math.max(o[1],-gt),gt)]}class l1 extends nc{constructor(e,n,l,c){super(),this.id=e,this.dispatcher=l,this.coordinates=n.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(c),this.options=n,this._dirty=!1}load(e,n){if(this._loaded=n||!1,this.fire(new Sa("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=or(this.map._requestManager.transformRequest(this.url,Lu.Image),(l,c)=>{this._imageRequest=null,this._loaded=!0,l?this.fire(new Pp(l)):c&&(this.image=c instanceof HTMLImageElement?Ml.getImageData(c):c,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new l0(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Sa("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof l0||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let n=e[0][1],l=e[0][1];for(let m of e)m[1]>l&&(l=m[1]),m[1]<n&&(n=m[1]);let c=(l+n)/2;if(c>gt?this.onNorthPole=!0:c<-gt&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){let m=e.map(Ct.fromLngLat);this.tileID=function(_){let b=1/0,I=1/0,E=-1/0,L=-1/0;for(let ee of _)b=Math.min(b,ee.x),I=Math.min(I,ee.y),E=Math.max(E,ee.x),L=Math.max(L,ee.y);let F=Math.max(E-b,L-I),V=Math.max(0,Math.floor(-Math.log(F)/Math.LN2)),W=Math.pow(2,V),H=Math.floor((b+E)/2*W);return H>1&&(H-=1),new Gr(V,H,Math.floor((I+L)/2*W))}(m),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Sa("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(let de in this.tiles){let Ce=this.tiles[de];Ce.state!=="loaded"&&(Ce.state="loaded",Ce.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;let n=Zg(new Gr(0,0,0),this.map.transform.projection),l=[n.projection.project(this.coordinates[0][0],this.coordinates[0][1]),n.projection.project(this.coordinates[1][0],this.coordinates[1][1]),n.projection.project(this.coordinates[2][0],this.coordinates[2][1]),n.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(de){let Ce=de[1].x-de[0].x,we=de[1].y-de[0].y,ie=de[2].x-de[1].x,me=de[2].y-de[1].y,Ie=de[3].x-de[2].x,ze=de[3].y-de[2].y,Je=de[0].x-de[3].x,st=de[0].y-de[3].y,ut=Ce*me-ie*we,xt=ie*ze-Ie*me,Ft=Ie*st-Je*ze,ri=Je*we-Ce*st;return ut>0&&xt>0&&Ft>0&&ri>0||ut<0&&xt<0&&Ft<0&&ri<0}(l))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);let c=Zg(this.tileID,this.map.transform.projection),[m,_,b,I]=this.coordinates.map(de=>{let Ce=c.projection.project(de[0],de[1]);return Hv(c,Ce)._round()});this.perspectiveTransform=a1(m.x,m.y,_.x,_.y,b.x,b.y,I.x,I.y);let E=this._boundsArray=new uc;E.emplaceBack(m.x,m.y,0,0),E.emplaceBack(_.x,_.y,xi,0),E.emplaceBack(I.x,I.y,0,xi),E.emplaceBack(b.x,b.y,xi,xi),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(E,Tx.members),this.boundsSegments=bo.simpleSegment(0,0,4,2);let L=[],F=[h0((V=this.coordinates)[0]),h0(V[1]),h0(V[2]),h0(V[3])];var V;let[W,H,ee,le]=function(de){let Ce=de[0][0],we=Ce,ie=de[0][1],me=ie;for(let Ie=1;Ie<de.length;Ie++)de[Ie][0]<Ce?Ce=de[Ie][0]:de[Ie][0]>we&&(we=de[Ie][0]),de[Ie][1]<ie?ie=de[Ie][1]:de[Ie][1]>me&&(me=de[Ie][1]);return[Ce,ie,we-Ce,me-ie]}(F);{let de=new uc,[Ce,we,ie,me]=function(Rt){let Yt=Rt[0].x,Et=Yt,kt=Rt[0].y,pi=kt;for(let mi=1;mi<Rt.length;mi++)Rt[mi].x<Yt?Yt=Rt[mi].x:Rt[mi].x>Et&&(Et=Rt[mi].x),Rt[mi].y<kt?kt=Rt[mi].y:Rt[mi].y>pi&&(pi=Rt[mi].y);return[Yt,kt,Et-Yt,pi-kt]}(l),Ie=Rt=>[(Rt.x-Ce)/ie,(Rt.y-we)/me],[ze,Je,st,ut]=l.map(Ie),xt=function(Rt,Yt,Et,kt,pi,mi,qi,Bi){let Ti=c0(0,0,1,0,1,1,0,1);return Dt(Ti,Ti,an([],c0(Rt,Yt,Et,kt,pi,mi,qi,Bi)))}(ze[0],ze[1],Je[0],Je[1],st[0],st[1],ut[0],ut[1]);this.elevatedGlobePerspectiveTransform=a1(ze[0],ze[1],Je[0],Je[1],st[0],st[1],ut[0],ut[1]);let Ft=(Rt,Yt)=>{L.push(Rt.lng);let Et=Math.round((Rt.lng-W)/ee*xi),kt=Math.round((Rt.lat-H)/le*xi),pi=Ie(Yt),mi=yc([],[pi[0],pi[1],1],xt),qi=Math.round(mi[0]/mi[2]*xi),Bi=Math.round(mi[1]/mi[2]*xi);de.emplaceBack(Et,kt,qi,Bi)},ri=l[3].x-l[0].x,$t=l[3].y-l[0].y,Qt=l[2].x-l[1].x,hi=l[2].y-l[1].y;for(let Rt=0;Rt<65;Rt++){let Yt=Rt/64,Et=[l[0].x+Yt*ri,l[0].y+Yt*$t],kt=[l[1].x+Yt*Qt,l[1].y+Yt*hi],pi=kt[0]-Et[0],mi=kt[1]-Et[1];for(let qi=0;qi<65;qi++){let Bi=qi/64,Ti={x:Et[0]+pi*Bi,y:Et[1]+mi*Bi,z:0};Ft(n.projection.unproject(Ti.x,Ti.y),Ti)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(de,Tx.members)}{this.maxLongitudeTriangleSize=0;let de=[],Ce=new zo,we=(ie,me,Ie)=>{Ce.emplaceBack(ie,me,Ie);let ze=L[ie],Je=L[me],st=L[Ie],ut=Math.min(Math.min(ze,Je),st),xt=Math.max(Math.max(ze,Je),st)-ut;xt>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=xt),de.push(ut+xt/2)};for(let ie=0;ie<64;ie++)for(let me=0;me<64;me++){let Ie=65*ie+me,ze=Ie+1,Je=Ie+65,st=Je+1;we(Ie,Je,ze),we(ze,Je,st)}[de,Ce]=function(ie,me){let Ie=Array.from({length:ie.length},(st,ut)=>ut);Ie.sort((st,ut)=>ie[st]-ie[ut]);let ze=[],Je=new zo;for(let st=0;st<Ie.length;st++){let ut=Ie[st];ze.push(ie[ut]);let xt=3*ut,Ft=xt+1;Je.emplaceBack(me.uint16[xt],me.uint16[Ft],me.uint16[Ft+1])}return[ze,Je]}(de,Ce),this.elevatedGlobeTrianglesCenterLongitudes=de,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(Ce)}this.elevatedGlobeSegments=bo.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,ee/xi,0,le/xi,0,0,H,W,0])}prepare(){let e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;let n=this.map.painter.context,l=n.gl;!this._dirty||this.texture instanceof l0||(this.texture?this.texture.update(this.image):(this.texture=new Cx(n,this.image,l.RGBA8),this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(n)}loadTile(e,n){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},n(null)):(e.state="errored",n(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){let n=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!n)return null;let l=this.elevatedGlobeTrianglesCenterLongitudes,c=(m=e+180)+360*Math.round((l[0]-m)/360);var m;let _=new bo,b=(F,V)=>{_.segments.push({vertexOffset:0,primitiveOffset:F,vertexLength:n.segments[0].vertexLength,primitiveLength:V,sortKey:void 0,vaos:{}})},I=.51*this.maxLongitudeTriangleSize;if(Math.abs(l[0]-c)<=I){let F=xo(l,0,l.length,c+I);return F===l.length||b(F,To(l,F+1,l.length,c+360-I)-F),_}c<l[0]&&(c+=360);let E=To(l,0,l.length,c-I);if(E===l.length)return b(0,l.length),_;b(0,E-0);let L=xo(l,E+1,l.length,c+I);return L!==l.length&&b(L,l.length-L),_}}let h2=(Math.pow(256,2)-1)/16907520;class c1 extends lr{constructor(e,n,l,c){super(e,{layout:o1||(o1=new dt({visibility:new Se(xe.layout_raster.visibility)})),paint:s1||(s1=new dt({"raster-opacity":new Se(xe.paint_raster["raster-opacity"]),"raster-color":new ft(xe.paint_raster["raster-color"]),"raster-color-mix":new Se(xe.paint_raster["raster-color-mix"]),"raster-color-range":new Se(xe.paint_raster["raster-color-range"]),"raster-hue-rotate":new Se(xe.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Se(xe.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Se(xe.paint_raster["raster-brightness-max"]),"raster-saturation":new Se(xe.paint_raster["raster-saturation"]),"raster-contrast":new Se(xe.paint_raster["raster-contrast"]),"raster-resampling":new Se(xe.paint_raster["raster-resampling"]),"raster-fade-duration":new Se(xe.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new Se(xe.paint_raster["raster-emissive-strength"]),"raster-array-band":new Se(xe.paint_raster["raster-array-band"]),"raster-elevation":new Se(xe.paint_raster["raster-elevation"]),"raster-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"})}))},n,l,c),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof l1&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;let n=this._transitionablePaint._values["raster-color"].value.expression,[l,c]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(l)&&isNaN(c)||l===this._curRampRange[0]&&c===this._curRampRange[1]||(this.colorRamp=Cf({expression:n,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:l,end:c}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[l,c])}}let h1,u1,d1,p1,f1;class m1 extends lr{constructor(e,n,l,c){super(e,{layout:h1||(h1=new dt({visibility:new Se(xe["layout_raster-particle"].visibility)})),paint:u1||(u1=new dt({"raster-particle-array-band":new Se(xe["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new Se(xe["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new ft(xe["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new Se(xe["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new Se(xe["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new Se(xe["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new Se(xe["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new Se(xe["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"})}))},n,l,c),this._updateColorRamp(),this.lastInvalidatedAt=Ml.now()}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;let e=this._transitionablePaint._values["raster-particle-color"].value.expression,n=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Cf({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:n}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=Ml.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class u2 extends lr{constructor(e,n){super(e,{},n,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function Ex(o,e,n){let l=[0,0,1],c=Wa([]);return fl(c,c,n?-te(o)+Math.PI:te(o)),pl(c,c,-te(e)),Os(l,l,c),Lr(l,l)}function _1(o,e){let n=u0(o.projection,o.zoom,o.width,o.height),l=function(m,_,b,I,E){let L=new ae(b.lng-180*um,b.lat),F=new ae(b.lng+180*um,b.lat),V=m.project(L.lng,L.lat),W=m.project(F.lng,F.lat),H=-Math.atan2(W.y-V.y,W.x-V.x),ee=Ct.fromLngLat(b);ee.y=rt(ee.y,-1+um,1-um);let le=ee.toLngLat(),de=m.project(le.lng,le.lat),Ce=Ct.fromLngLat(le);Ce.x+=um;let we=Ce.toLngLat(),ie=m.project(we.lng,we.lat),me=y1(ie.x-de.x,ie.y-de.y,H),Ie=Ct.fromLngLat(le);Ie.y+=um;let ze=Ie.toLngLat(),Je=m.project(ze.lng,ze.lat),st=y1(Je.x-de.x,Je.y-de.y,H),ut=Math.abs(me.x)/Math.abs(st.y),xt=on([]);Br(xt,xt,-H*(1-(E?0:I)));let Ft=on([]);return Bo(Ft,Ft,[1,1-(1-ut)*I,1]),Ft[4]=-st.x/st.y*I,Br(Ft,Ft,H),gn(Ft,xt,Ft),Ft}(o.projection,0,o.center,n,e),c=g1(o);return Bo(l,l,[c,c,1]),l}function g1(o){let e=o.projection,n=u0(o.projection,o.zoom,o.width,o.height),l=Mx(e,o.center),c=Mx(e,ae.convert(e.center));return Math.pow(2,l*n+(1-n)*c)}function u0(o,e,n,l,c=1/0){let m=o.range;if(!m)return 0;let _=Math.min(c,Math.max(n,l)),b=Math.log(_/1024)/Math.LN2;return ct(m[0]+b,m[1]+b,e)}let um=1/4e4;function Mx(o,e){let n=rt(e.lat,-gt,gt),l=new ae(e.lng-180*um,n),c=new ae(e.lng+180*um,n),m=o.project(l.lng,n),_=o.project(c.lng,n),b=Ct.fromLngLat(l),I=Ct.fromLngLat(c),E=_.x-m.x,L=_.y-m.y,F=I.x-b.x,V=I.y-b.y,W=Math.sqrt((F*F+V*V)/(E*E+L*L));return Math.log(W)/Math.LN2}function y1(o,e,n){let l=Math.cos(n),c=Math.sin(n);return{x:o*l-e*c,y:o*c+e*l}}function x1(o,e,n){on(o),Br(o,o,te(e[2])),qo(o,o,te(e[0])),to(o,o,te(e[1])),Bo(o,o,n),gn(o,o,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function d0(o,e,n,l,c,m,_,b){let I=[n[0]-e[0],n[1]-e[1],0],E=[l[0]-e[0],l[1]-e[1],0];if(No(I)<1e-12||No(E)<1e-12)return Wa(o);let L=Co([],I,E);Lr(L,L),ss(E,l,e),I[2]=(m-c)*b,E[2]=(_-c)*b;let F=I;return Co(F,I,E),Lr(F,F),El(o,L,F)}function Px(o,e,n=!1){let l=mp(e.zoom),c=function(m,_,b){let I=_.worldSize,E=[m[12],m[13],m[14]],L=Qe(E[1]/I),F=Ke(E[0]/I),V=on([]),W=Oe(1,L)*I,H=Oe(1,0)*I*Ut(L,_.zoom),ee=1/lg(I),le=H*ee;if(b){let ie=u0(_.projection,_.zoom,_.width,_.height,1024);le=ee*_.projection.pixelSpaceConversion(_.center.lat,I,ie)}let de=se(L,F);ho(de,de,Mr([],Lr([],de),W*le*E[2]));let Ce=function(ie){let me=[ie[0],ie[1],ie[2]],Ie=[0,1,0],ze=Co([],Ie,me);return Co(Ie,me,ze),Da(Ie)===0&&(Ie=[0,1,0],Co(ze,me,Ie)),Lr(ze,ze),Lr(Ie,Ie),Lr(me,me),[ze[0],ze[1],ze[2],0,Ie[0],Ie[1],Ie[2],0,me[0],me[1],me[2],0,ie[0],ie[1],ie[2],1]}(de);Bo(V,V,[le,le,le*W]),vr(V,V,[-E[0],-E[1],-E[2]]);let we=gn([],_.globeMatrix,Ce);return gn(we,we,V),gn(we,we,m),we}(o,e,n);if(l>0){let m=function(_,b){let I=b.worldSize,E=Oe(1,0)*I*Ut(b.center.lat,b.zoom)/lg(I),L=Oe(1,b.center.lat)*I,F=on([]);return to(F,F,te(b.center.lng)),qo(F,F,te(b.center.lat)),vr(F,F,[0,0,v]),Bo(F,F,[E,E,E*L]),vr(F,F,[b.point.x-.5*I,b.point.y-.5*I,0]),gn(F,F,_),gn(F,b.globeMatrix,F)}(o,e);return function(_,b,I){let E=(H,ee,le)=>{let de=No(H),Ce=No(ee),we=fp(H,ee,le);return Mr(we,we,1/No(we)*en(de,Ce,le))},L=E([_[0],_[1],_[2]],[b[0],b[1],b[2]],I),F=E([_[4],_[5],_[6]],[b[4],b[5],b[6]],I),V=E([_[8],_[9],_[10]],[b[8],b[9],b[10]],I),W=fp([_[12],_[13],_[14]],[b[12],b[13],b[14]],I);return[L[0],L[1],L[2],0,F[0],F[1],F[2],0,V[0],V[1],V[2],0,W[0],W[1],W[2],1]}(c,m,l)}return c}function v1(o,e,n,l){let c=Jr.projectAabbCorners(l,n),m=Number.MAX_VALUE,_=-1;for(let E=0;E<c.length;++E){let L=c[E];L[0]=(.5*L[0]+.5)*e.width,L[1]=(.5-.5*L[1])*e.height,L[2]<m&&(_=E,m=L[2])}let b=E=>new Ue(c[E][0],c[E][1]),I;switch(_){case 0:case 6:I=[b(1),b(5),b(4),b(7),b(3),b(2),b(1)];break;case 1:case 7:I=[b(0),b(4),b(5),b(6),b(2),b(3),b(0)];break;case 3:case 5:I=[b(1),b(0),b(4),b(7),b(6),b(2),b(1)];break;default:I=[b(1),b(5),b(6),b(7),b(3),b(0),b(1)]}if(nn(o,I))return m}let d2=Kn([{name:"a_pos_3f",components:3,type:"Float32"}]),p2=Kn([{name:"a_color_3f",components:3,type:"Float32"}]),f2=Kn([{name:"a_color_4f",components:4,type:"Float32"}]),m2=Kn([{name:"a_uv_2f",components:2,type:"Float32"}]),_2=Kn([{name:"a_normal_3f",components:3,type:"Float32"}]),g2=Kn([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),y2=Kn([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]),b1={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7};class p0{constructor(e,n,l,c){this.message=(e?`${e}: `:"")+l,c&&(this.identifier=c),n!=null&&n.__line__&&(this.line=n.__line__)}}function Ax(o,e){let n=o.indexOf("://")===-1;try{return new URL(o,n&&e?"http://example.com":void 0),!0}catch{return!1}}class w1{constructor(e,n){this.feature=e,this.instancedDataOffset=n,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class T1{constructor(){this.instancedDataArray=new ap,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Dx{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.projection=e.projection,this.index=e.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs}updateFootprints(e,n){}populate(e,n,l,c){this.tileToMeter=vt(l);let m=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(let{feature:_,id:b,index:I,sourceLayerIndex:E}of e){let L=b??(_.properties&&_.properties.hasOwnProperty("id")?_.properties.id:void 0),F=ji(_,m);if(!this.layers[0]._featureFilter.filter(new J(this.zoom),F,l))continue;let V={id:L,sourceLayerIndex:E,index:I,geometry:m?F.geometry:ki(_,l,c),properties:_.properties,type:_.type,patterns:{}},W=this.addFeature(V,V.geometry,F);W&&n.featureIndex.insert(_,V.geometry,I,E,this.index,this.instancesPerModel[W].instancedDataArray.length,xi/32)}this.lookup=null}update(e,n,l,c){for(let m in this.instancesPerModel){let _=this.instancesPerModel[m];for(let b in e)_.idToFeaturesIndex.hasOwnProperty(b)&&(this.evaluate(_.features[_.idToFeaturesIndex[b]],e[b],_,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(let n in this.instancesPerModel){let l=this.instancesPerModel[n];for(let c of l.features){let m=this.layers[0],_=c.feature,b=this.canonical,I=m.paint.get("model-rotation").evaluate(_,{},b),E=m.paint.get("model-scale").evaluate(_,{},b),L=m.paint.get("model-translation").evaluate(_,{},b);va(c.rotation,I)&&va(c.scale,E)&&va(c.translation,L)||(this.evaluate(c,c.featureStates,l,!0),e=!0)}}return e}updateReplacement(e,n,l,c){if(n.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=n.updateTime;let m=n.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(_e(this.activeReplacements,m))return!1;this.activeReplacements=m;let _=!1;for(let b in this.instancesPerModel){let I=this.instancesPerModel[b],E=I.instancedDataArray;for(let L of I.features){let F=L.instancedDataOffset,V=L.instancedDataCount;for(let W=0;W<V;W++){let H=16*(W+F),ee=E.float32[H+0],le=ee>xi;ee=le?ee-xi:ee;let de=Math.floor(ee),Ce=E.float32[H+1],we=!1;for(let ie of this.activeReplacements)if(!G(ie,l,b1.Model,c)&&!(ie.min.x>de||de>ie.max.x||ie.min.y>Ce||Ce>ie.max.y)&&(we=Mt(lt(de,Ce,e.canonical,ie.footprintTileId.canonical),ie.footprint),we))break;E.float32[H]=we?ee+xi:ee,_=_||we!==le}}}return _}isEmpty(){for(let e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(let n in this.instancesPerModel){let l=this.instancesPerModel[n];l.instancedDataArray.length<0||l.instancedDataArray.length===0||(l.instancedDataBuffer?l.instancedDataBuffer.updateData(l.instancedDataArray):l.instancedDataBuffer=e.createVertexBuffer(l.instancedDataArray,g2.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(let n in this.instancesPerModel){let l=this.instancesPerModel[n];l.instancedDataArray.length!==0&&l.instancedDataBuffer&&l.instancedDataBuffer.destroy()}let e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(let n of this.modelUris)e.removeModel(n,"",!0)}addFeature(e,n,l){let c=this.layers[0],m=c.layout.get("model-id").evaluate(l,{},this.canonical);if(!m)return Hi(`modelId is not evaluated for layer ${c.id} and it is not going to get rendered.`),m;(Ax(m,!1)||this.styleDefinedModelURLs[m]!==void 0)&&(this.modelUris.includes(m)||this.modelUris.push(m)),this.instancesPerModel[m]||(this.instancesPerModel[m]=new T1);let _=this.instancesPerModel[m],b=_.instancedDataArray,I=new w1(l,b.length);for(let E of n)for(let L of E){if(L.x<0||L.x>=xi||L.y<0||L.y>=xi)continue;let F=(this.lookupDim-1)/xi,V=this.lookupDim*(L.y*F|0)+L.x*F|0;if(this.lookup){if(this.lookup[V]!==0)continue;this.lookup[V]=1}this.instanceCount++;let W=b.length;b.resize(W+1),_.instancesEvaluatedElevation.push(0),b.float32[16*W]=L.x,b.float32[16*W+1]=L.y}return I.instancedDataCount=_.instancedDataArray.length-I.instancedDataOffset,I.instancedDataCount>0&&(e.id&&(_.idToFeaturesIndex[e.id]=_.features.length),_.features.push(I),this.evaluate(I,{},_,!1)),m}getModelUris(){return this.modelUris}evaluate(e,n,l,c){let m=this.layers[0],_=e.feature,b=this.canonical,I=e.rotation=m.paint.get("model-rotation").evaluate(_,n,b),E=e.scale=m.paint.get("model-scale").evaluate(_,n,b),L=e.translation=m.paint.get("model-translation").evaluate(_,n,b),F=m.paint.get("model-color").evaluate(_,n,b);F.a=m.paint.get("model-color-mix-intensity").evaluate(_,n,b);let V=[];this.maxVerticalOffset<L[2]&&(this.maxVerticalOffset=L[2]),this.maxScale=Math.max(Math.max(this.maxScale,E[0]),Math.max(E[1],E[2])),x1(V,I,E);let W=Math.round(100*F.a)+F.b/1.05;for(let H=0;H<e.instancedDataCount;++H){let ee=e.instancedDataOffset+H,le=16*ee,de=l.instancedDataArray.float32,Ce=0;c&&(Ce=de[le+6]-l.instancesEvaluatedElevation[ee]);let we=0|de[le+1];de[le]=(0|de[le])+F.r/1.05,de[le+1]=we+F.g/1.05,de[le+2]=W,de[le+3]=1/(b.z>10?this.tileToMeter:vt(b,we)),de[le+4]=L[0],de[le+5]=L[1],de[le+6]=L[2]+Ce,de[le+7]=V[0],de[le+8]=V[1],de[le+9]=V[2],de[le+10]=V[4],de[le+11]=V[5],de[le+12]=V[6],de[le+13]=V[8],de[le+14]=V[9],de[le+15]=V[10],l.instancesEvaluatedElevation[ee]=L[2]}}}let S1,I1;Ei(Dx,"ModelBucket",{omit:["layers"]}),Ei(T1,"PerModelAttributes"),Ei(w1,"ModelFeature");let Jm=64,L_={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function C1(o,e,n,l,c,m,_,b,I,E=!1){let L=n.zoom,F=n.project(l),V=Ut(l.lat,L),W=1/V;on(o),vr(o,o,[F.x+_[0]*W,F.y+_[1]*W,_[2]]);let H=1,ee=1,le=n.worldSize;if(E){if(n.projection.name==="mercator"){let ie=0;n.elevation&&(ie=n.elevation.getAtPointOrZero(new Ct(F.x/le,F.y/le),0));let me=Vo([],[F.x,F.y,ie,1],n.projMatrix)[3]/n.cameraToCenterDistance;H=me,ee=me*Ut(n.center.lat,L)}else if(n.projection.name==="globe"){let ie=Px(o,n),me=[0,0,0,1];Vo(me,me,gn([],n.projMatrix,ie));let Ie=me[3]/n.cameraToCenterDistance,ze=mp(L),Je=n.projection.pixelsPerMeter(l.lat,le)*Ut(l.lat,L),st=n.projection.pixelsPerMeter(n.center.lat,le)*Ut(n.center.lat,L);H=Ie/en(Je,jt(n.center.lat),ze),ee=Ie*V/Je,H*=st,ee*=st}}else H=W;Bo(o,o,[H,H,ee]);let de=[...o],Ce=e.orientation,we=[];if(x1(we,[Ce[0]+c[0],Ce[1]+c[1],Ce[2]+c[2]],m),gn(o,de,we),b&&n.elevation){let ie=0,me=[];if(I&&n.elevation){ie=function(ze,Je,st,ut,xt){let Ft=Je.elevation;if(!Ft)return 0;let ri=Jr.projectAabbCorners(st,ut),$t=Oe(1,xt.lat)*Je.worldSize,Qt=function(ui,bn){let Vi=[0,0,1],Ui=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(let mn of Ui){let Pn=ui[mn.corners[0]],Rn=ui[mn.corners[1]],Zn=ui[mn.corners[2]],kn=[Rn[0]-Pn[0],Rn[1]-Pn[1],bn*(Rn[2]-Pn[2])],zn=Co(kn,kn,[Zn[0]-Pn[0],Zn[1]-Pn[1],bn*(Zn[2]-Pn[2])]);Lr(zn,zn),mn.dotProductWithUp=jr(zn,Vi)}return Ui.sort((mn,Pn)=>mn.dotProductWithUp-Pn.dotProductWithUp),Ui[0].corners}(ri,$t),hi=ri[Qt[0]],Rt=ri[Qt[1]],Yt=ri[Qt[2]],Et=ri[Qt[3]],kt=Ft.getAtPointOrZero(new Ct(hi[0]/Je.worldSize,hi[1]/Je.worldSize),0),pi=Ft.getAtPointOrZero(new Ct(Rt[0]/Je.worldSize,Rt[1]/Je.worldSize),0),mi=Ft.getAtPointOrZero(new Ct(Yt[0]/Je.worldSize,Yt[1]/Je.worldSize),0),qi=Ft.getAtPointOrZero(new Ct(Et[0]/Je.worldSize,Et[1]/Je.worldSize),0),Bi=(kt+qi)/2,Ti=(pi+mi)/2;return Bi>Ti?pi<mi?d0(ze,Rt,Et,hi,pi,qi,kt,$t):d0(ze,Yt,hi,Et,mi,kt,qi,$t):kt<qi?d0(ze,hi,Rt,Yt,kt,pi,mi,$t):d0(ze,Et,Yt,Rt,qi,mi,pi,$t),Math.max(Bi,Ti)}(me,n,e.aabb,o,l);let Ie=gn([],Aa([],me),we);gn(o,de,Ie)}else ie=n.elevation.getAtPointOrZero(new Ct(F.x/le,F.y/le),0);ie!==0&&(o[14]+=ie)}}function Xg(o,e,n=!1){o.uploaded||(o.gfxTexture=new Cx(e,o.image,n?e.gl.R8:e.gl.RGBA8,{useMipmap:o.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),o.uploaded=!0,o.image=null)}function x2(o,e,n){o.indexBuffer=e.createIndexBuffer(o.indexArray,!1,!0),o.vertexBuffer=e.createVertexBuffer(o.vertexArray,d2.members,!1,!0),o.normalArray&&(o.normalBuffer=e.createVertexBuffer(o.normalArray,_2.members,!1,!0)),o.texcoordArray&&(o.texcoordBuffer=e.createVertexBuffer(o.texcoordArray,m2.members,!1,!0)),o.colorArray&&(o.colorBuffer=e.createVertexBuffer(o.colorArray,(o.colorArray.bytesPerElement===12?p2:f2).members,!1,!0)),o.featureArray&&(o.pbrBuffer=e.createVertexBuffer(o.featureArray,y2.members,!0)),o.segments=bo.simpleSegment(0,0,o.vertexArray.length,o.indexArray.length);let l=o.material;l.pbrMetallicRoughness.baseColorTexture&&Xg(l.pbrMetallicRoughness.baseColorTexture,e),l.pbrMetallicRoughness.metallicRoughnessTexture&&Xg(l.pbrMetallicRoughness.metallicRoughnessTexture,e),l.normalTexture&&Xg(l.normalTexture,e),l.occlusionTexture&&Xg(l.occlusionTexture,e,n),l.emissionTexture&&Xg(l.emissionTexture,e)}function Rx(o,e,n){if(o.meshes)for(let l of o.meshes)x2(l,e,n);if(o.children)for(let l of o.children)Rx(l,e,n)}function f0(o){if(o.meshes)for(let e of o.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(o.children)for(let e of o.children)f0(e)}function zx(o){if(o.meshes)for(let n of o.meshes)n.vertexBuffer&&(n.vertexBuffer.destroy(),n.indexBuffer.destroy(),n.normalBuffer&&n.normalBuffer.destroy(),n.texcoordBuffer&&n.texcoordBuffer.destroy(),n.colorBuffer&&n.colorBuffer.destroy(),n.pbrBuffer&&n.pbrBuffer.destroy(),n.segments.destroy(),n.material&&((e=n.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(o.children)for(let n of o.children)zx(n)}class k_{constructor(e,n,l){this._demTile=e,this._dem=this._demTile.dem,this._scale=n,this._offset=l}static create(e,n,l){let c=l||e.findDEMTileFor(n);if(!c||!c.dem)return;let m=c.dem,_=c.tileID,b=1<<n.canonical.z-_.canonical.z;return new k_(c,m.dim/xi/b,[(n.canonical.x/b-_.canonical.x)*m.dim,(n.canonical.y/b-_.canonical.y)*m.dim])}tileCoordToPixel(e,n){let l=n*this._scale+this._offset[1],c=Math.floor(e*this._scale+this._offset[0]),m=Math.floor(l);return new Ue(c,m)}getElevationAt(e,n,l,c){let m=e*this._scale+this._offset[0],_=n*this._scale+this._offset[1],b=Math.floor(m),I=Math.floor(_),E=this._dem;return c=!!c,l?en(en(E.get(b,I,c),E.get(b,I+1,c),_-I),en(E.get(b+1,I,c),E.get(b+1,I+1,c),_-I),m-b):E.get(b,I,c)}getElevationAtPixel(e,n,l){return this._dem.get(e,n,!!l)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*Oe(1,e)*this._dem.stride}}let Lx=new Float32Array(262144),Qm=new Uint8Array(262144);function E1(o){let e=0;if(o.meshes)for(let n of o.meshes)e=Math.max(e,n.aabb.max[2]);if(o.children)for(let n of o.children)e=Math.max(e,E1(n));return e}function M1(o,e,n){if(o.meshes)for(let l of o.meshes){if(l.aabb.min[0]===1/0)continue;let c=Jr.applyTransform(l.aabb,o.matrix);n.insert(e,c.min[0],c.min[1],c.max[0],c.max[1])}if(o.children)for(let l of o.children)M1(l,e,n)}let P1=["","wall","door","roof","window","lamp","logo"];class A1{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:E1(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Jr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0,n=new Jr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(let l of this.node.meshes)this.node.lightMeshIndex!==e&&(l.transformedAabb=Jr.applyTransformFast(l.aabb,this.node.matrix),n.encapsulate(l.transformedAabb)),e++;this.aabb=n}return this.aabb}}class m0{constructor(e,n,l,c,m,_,b){this.id=l,this.layers=e,this.layerIds=this.layers.map(I=>I.fqid),this.stateDependentLayerIds=this.layers.filter(I=>I.isStateDependent()).map(I=>I.id),this.modelTraits|=L_.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,c&&(this.modelTraits|=L_.HasMapboxMeshFeatures),m&&(this.modelTraits|=L_.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=_,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(let I of n)this.nodesInfo.push(new A1(I)),M1(I,b.featureIndexArray.length,b.grid),b.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,b.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(e,n){for(let l of this.getNodesInfo()){let c=l.node;c.footprint&&n.push({footprint:c.footprint,id:e})}}update(e){let n=Object.keys(e).length!==0;if(n&&!this.stateDependentLayers.length)return;let l=n?this.stateDependentLayers:this.layers;if(!Qi(e,this.states))for(let c of l)this.evaluate(c,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;let n=this.getNodesInfo();for(let l of n){let c=l.node;this.uploaded?this.updatePbrBuffer(c):Rx(c,e,!0)}for(let l of n)f0(l.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let n=!1;if(!e.meshes)return n;for(let l of e.meshes)l.pbrBuffer&&(l.pbrBuffer.updateData(l.featureArray),n=!0);return n}needsReEvaluation(e,n,l){let c=e.transform.projectionOptions,m=e.style.getBrightness(),_=this.brightness!==m;if(!this.uploaded||this.dirty||c.name!==this.projection.name||Kg(l.paint.get("model-color").value,_)||Kg(l.paint.get("model-color-mix-intensity").value,_)||Kg(l.paint.get("model-roughness").value,_)||Kg(l.paint.get("model-emissive-strength").value,_)||Kg(l.paint.get("model-height-based-emissive-strength-multiplier").value,_)){this.projection=c,this.brightness=m;let b=this.getNodesInfo();for(let I of b)I.state=null;return!0}return!1}evaluateScale(e,n){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;let l=this.getNodesInfo(),c=this.id.canonical;for(let m of l){let _=m.feature;m.evaluatedScale=n.paint.get("model-scale").evaluate(_,{},c)}}evaluate(e,n){let l=this.getNodesInfo();for(let c of l){if(!c.node.meshes)continue;let m=c.feature,_=n&&n[m.id];if(Qi(_,c.state))continue;c.state=structuredClone(_);let b=c.node.meshes&&c.node.meshes[0].featureData,I=c.evaluatedColor[2],E=c.evaluatedRMEA[2],L=this.id.canonical;if(c.hasTranslucentParts=!1,b){for(let F=0;F<P1.length;F++){let V=P1[F];V.length&&(m.properties.part=V);let W=e.paint.get("model-color").evaluate(m,_,L).toRenderColor(null),H=e.paint.get("model-color-mix-intensity").evaluate(m,_,L);c.evaluatedColor[F]=[W.r,W.g,W.b,H],c.evaluatedRMEA[F][0]=e.paint.get("model-roughness").evaluate(m,_,L),c.evaluatedRMEA[F][2]=e.paint.get("model-emissive-strength").evaluate(m,_,L),c.evaluatedRMEA[F][3]=W.a,c.emissionHeightBasedParams[F]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(m,_,L),!c.hasTranslucentParts&&W.a<1&&(c.hasTranslucentParts=!0)}delete m.properties.part,b2(c,I!==c.evaluatedColor[2]||E!==c.evaluatedRMEA[2],this.modelTraits)}else c.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(m,_,L);c.evaluatedScale=e.paint.get("model-scale").evaluate(m,_,L),this.updatePbrBuffer(c.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,n,l,c){let m=e.findDEMTileFor(l);if(m&&(m.tileID.canonical!==this.terrainTile||n!==this.terrainExaggeration)){if(m.dem&&m.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=m.tileID.overscaledZ;let _=k_.create(e,l,m);if(!_)return;this.modelTraits&L_.HasMapboxMeshFeatures&&this.updateDEM(e,_,l,c);for(let b of this.getNodesInfo()){let I=b.node;if(!I.footprint||!I.footprint.vertices||!I.footprint.vertices.length)continue;let E=I.footprint.vertices,L=_.getElevationAt(E[0].x,E[0].y,!0,!0);for(let F=1;F<E.length;F++)L=Math.min(L,_.getElevationAt(E[F].x,E[F].y,!0,!0));I.elevation=L}}this.terrainTile=m.tileID.canonical,this.terrainExaggeration=n}}updateDEM(e,n,l,c){let m=n._dem._modifiedForSources[c];if(m===void 0&&(n._dem._modifiedForSources[c]=[],m=n._dem._modifiedForSources[c]),m.includes(l.canonical))return;let _=n._dem.dim;m.push(l.canonical);let b=!1;for(let I of this.getNodesInfo()){let E=I.node;if(!E.footprint||!E.footprint.grid)continue;let L=E.footprint.grid,F=n.tileCoordToPixel(L.min.x,L.min.y),V=n.tileCoordToPixel(L.max.x,L.max.y),W=Math.min(Math.min(_-V.y,F.x),Math.min(F.y,_-V.x));if(W<0)continue;let H=rt(W,2,5),ee=Math.max(0,F.x-H),le=Math.max(0,F.y-H),de=Math.min(V.x+H,_-1),Ce=Math.min(V.y+H,_-1);for(let Ie=le;Ie<=Ce;++Ie)for(let ze=ee;ze<=de;++ze)Qm[Ie*_+ze]=255;let we=0,ie=0;for(let Ie=0;Ie<L.cellsY;++Ie)for(let ze=0;ze<L.cellsX;++ze){if(!L.cells[Ie*L.cellsX+ze])continue;let Je=n.tileCoordToPixel(L.min.x+ze/L.xScale,L.min.y+Ie/L.yScale),st=n.tileCoordToPixel(L.min.x+(ze+1)/L.xScale,L.min.y+(Ie+1)/L.yScale);for(let ut=Je.y;ut<=Math.min(st.y+1,_-1);++ut)for(let xt=Je.x;xt<=Math.min(st.x+1,_-1);++xt)Qm[ut*_+xt]===255&&(Qm[ut*_+xt]=0,we+=n.getElevationAtPixel(xt,ut),ie++)}let me=we/ie;ee=Math.max(1,F.x-H),le=Math.max(1,F.y-H),de=Math.min(V.x+H,_-2),Ce=Math.min(V.y+H,_-2),b=!0;for(let Ie=le;Ie<=Ce;++Ie)for(let ze=ee;ze<=de;++ze)Qm[Ie*_+ze]===0&&(Lx[Ie*_+ze]=n._dem.set(ze,Ie,me));for(let Ie=1;Ie<H;++Ie){ee=Math.max(1,F.x-Ie),le=Math.max(1,F.y-Ie),de=Math.min(V.x+Ie,_-2),Ce=Math.min(V.y+Ie,_-2);for(let ze=le;ze<=Ce;++ze)for(let Je=ee;Je<=de;++Je){let st=ze*_+Je;if(Qm[st]===255){let ut=0,xt=0,Ft=-1,ri=-1;for(let $t=-1;$t<=1;++$t)for(let Qt=-1;Qt<=1;++Qt){let hi=(ze+$t)*_+Je+Qt;if(Qm[hi]>=Ie)continue;let Rt=Lx[hi],Yt=Math.abs(Rt);Yt>xt&&(ut=Rt,xt=Yt,Ft=Qt,ri=$t)}if(xt>.1){let $t=1-(Ie+.5*Math.abs(Ft*ri))/H,Qt=n._dem.get(Je,ze)+ut*$t,hi=n._dem.get(Je+Ft,ze+ri),Rt=n._dem.get(Je-Ft,ze-ri,!0);(Qt-hi)*(Qt-Rt)>0&&(Qt=(hi+Rt)/2),Lx[st]=n._dem.set(Je,ze,Qt),Qm[st]=Ie}}}}}b&&(n._demTile.needsDEMTextureUpload=!0,n._dem._timestamp=Ml.now())}setFilter(e){this.filter=e?Kt(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(e=>this.filter.filter(new J(this.id.overscaledZ),e.feature,this.id.canonical)):this.nodesInfo}destroy(){let e=this.getNodesInfo();for(let n of e)f0(n.node),zx(n.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,n){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;let l=n.getReplacementRegionsForTile(e.toUnwrapped()),c=this.getNodesInfo();for(let m=0;m<this.nodesInfo.length;m++){let _=c[m].node;c[m].hiddenByReplacement=!!_.footprint&&!l.find(b=>b.footprint===_.footprint)}}getHeightAtTileCoord(e,n){let l=this.getNodesInfo(),c=[],m=[0,0,0],_=on([]);for(let b=0;b<this.nodesInfo.length;b++){let I=l[b],E=I.node.meshes[0],L=E.transformedAabb;if(e<L.min[0]||n<L.min[1]||e>L.max[0]||n>L.max[1])continue;if(I.node.hidden===!0)return{height:1/0,maxHeight:I.feature.properties.height,hidden:!1,verticalScale:I.evaluatedScale[2]};vn(_,I.node.matrix),m[0]=e,m[1]=n,gr(m,m,_);let F=(m[0]-E.aabb.min[0])/(E.aabb.max[0]-E.aabb.min[0])*Jm|0,V=Math.min(63,(m[1]-E.aabb.min[1])/(E.aabb.max[1]-E.aabb.min[1])*Jm|0)*Jm+Math.min(63,F),W=E.heightmap[V];if(!(W<0&&I.node.footprint))return I.hiddenByReplacement?void 0:{height:W,maxHeight:I.feature.properties.height,hidden:!1,verticalScale:I.evaluatedScale[2]};if(I.node.footprint.grid.query(new Ue(e,n),new Ue(e,n),c),c.length>0)return{height:void 0,maxHeight:I.feature.properties.height,hidden:I.hiddenByReplacement,verticalScale:I.evaluatedScale[2]}}}}function Kg(o,e){return o instanceof _h&&!o.isLightConstant&&e}function v2(o,e,n,l,c,m,_,b){let I=(61440&e|(61440&e)>>4)>>8,E=(3840&e|(3840&e)>>4)>>4,L=240&e|(240&e)>>4;n[3]>0&&(I=en(I,255*n[0],n[3]),E=en(E,255*n[1],n[3]),L=en(L,255*n[2],n[3]));let F=I<<8|E,V=L<<8|Math.floor(255*l[3]),W=function(Ie){let ze=rt(Ie,0,2);return Math.min(Math.round(.5*ze*255),255)}(l[2])<<8|15*l[0]<<4|15*l[1],H=rt(c[0],0,1),ee=rt(c[1],0,1),le=rt(c[2],0,1),de=rt(c[3],0,1),Ce,we,ie,me;if(H!==ee&&_!==m&&ee!==H){let Ie=_-m;we=1/(Ie*(ee-H)),ie=-(m+Ie*H)/(Ie*(ee-H));let ze=rt(c[4],-1,1);me=Math.pow(10,ze),Ce=255*le<<8|255*de}else Ce=65535,we=0,ie=1,me=1;if(o.emplaceBack(F,V,W,Ce,we,ie,me),b){let Ie=b.length;b.clear();for(let ze=0;ze<Ie;ze++)b.emplaceBack(F,V,W,Ce,we,ie,me)}}function b2(o,e,n){let l=o.node,c=0,m=n&L_.HasMeshoptCompression;for(let _ of l.meshes){if(l.lights&&l.lightMeshIndex===c||!_.featureData)continue;_.featureArray=new _f,_.featureArray.reserve(_.featureData.length);let b=e;for(let I of _.featureData){let E=m?65535&I:I>>16&65535,L=m?I>>16&65535:65535&I,F=(15&L)<8?15&L:0,V=o.evaluatedRMEA[F],W=o.evaluatedColor[F],H=o.emissionHeightBasedParams[F],ee;if(b&&F===2&&l.lights&&(ee=new _f,ee.resize(10*l.lights.length)),v2(_.featureArray,E,W,V,H,_.aabb.min[2],_.aabb.max[2],ee),ee&&b){b=!1;let le=l.meshes[l.lightMeshIndex];le.featureArray=ee,le.featureArray._trim()}}_.featureArray._trim(),c++}}function D1(o,e,n,l){let c=1<<o.z;e.lat=Qe((l/xi+o.y)/c),e.lng=Ke((n/xi+o.x)/c)}Ei(m0,"Tiled3dModelBucket",{omit:["layers"]}),Ei(A1,"Tiled3dModelFeature");let w2={circle:class extends lr{constructor(o,e,n,l){super(o,{layout:Sr||(Sr=new dt({"circle-sort-key":new Be(xe.layout_circle["circle-sort-key"]),"circle-elevation-reference":new Se(xe.layout_circle["circle-elevation-reference"]),visibility:new Se(xe.layout_circle.visibility)})),paint:fo||(fo=new dt({"circle-radius":new Be(xe.paint_circle["circle-radius"]),"circle-color":new Be(xe.paint_circle["circle-color"]),"circle-blur":new Be(xe.paint_circle["circle-blur"]),"circle-opacity":new Be(xe.paint_circle["circle-opacity"]),"circle-translate":new Se(xe.paint_circle["circle-translate"]),"circle-translate-anchor":new Se(xe.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Se(xe.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Se(xe.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Be(xe.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Be(xe.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Be(xe.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new Se(xe.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"})}))},e,n,l)}createBucket(o){return new Oi(o)}queryRadius(o){let e=o;return Dn("circle-radius",this,e)+Dn("circle-stroke-width",this,e)+oo(this.paint.get("circle-translate"))}queryIntersectsFeature(o,e,n,l,c,m,_,b){let I=so(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),m.angle,o.pixelToTileUnitsFactor),E=this.paint.get("circle-radius").evaluate(e,n)+this.paint.get("circle-stroke-width").evaluate(e,n);return xy(o,l,m,_,b,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",I,E)}getProgramIds(){return["circle"]}getDefaultProgramParams(o,e,n){let l=pg(this);return{config:new cd(this,{zoom:e,lut:n}),defines:l,overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends lr{createBucket(o){return new fg(o)}constructor(o,e,n,l){super(o,{layout:mg||(mg=new dt({visibility:new Se(xe.layout_heatmap.visibility)})),paint:dd||(dd=new dt({"heatmap-radius":new Be(xe.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Be(xe.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Se(xe.paint_heatmap["heatmap-intensity"]),"heatmap-color":new ft(xe.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Se(xe.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"})}))},e,n,l),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(o){o==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Cf({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(o){return Dn("heatmap-radius",this,o)}queryIntersectsFeature(o,e,n,l,c,m,_,b){let I=this.paint.get("heatmap-radius").evaluate(e,n);return xy(o,l,m,_,b,!0,!0,new Ue(0,0),I)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(o,e,n){return o==="heatmap"?{config:new cd(this,{zoom:e,lut:n}),overrideFog:!1}:{}}},hillshade:class extends lr{constructor(o,e,n,l){super(o,{layout:_p||(_p=new dt({visibility:new Se(xe.layout_hillshade.visibility)})),paint:_g||(_g=new dt({"hillshade-illumination-direction":new Se(xe.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Se(xe.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Se(xe.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Se(xe.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Se(xe.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Se(xe.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new Se(xe.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"})}))},e,n,l)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(o,e,n){return{overrideFog:!1}}},fill:class extends lr{constructor(o,e,n,l){super(o,{layout:C_||(C_=new dt({"fill-sort-key":new Be(xe.layout_fill["fill-sort-key"]),visibility:new Se(xe.layout_fill.visibility),"fill-elevation-reference":new Se(xe.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new Be(xe.layout_fill["fill-construct-bridge-guard-rail"])})),paint:Wm||(Wm=new dt({"fill-antialias":new Se(xe.paint_fill["fill-antialias"]),"fill-opacity":new Be(xe.paint_fill["fill-opacity"]),"fill-color":new Be(xe.paint_fill["fill-color"]),"fill-outline-color":new Be(xe.paint_fill["fill-outline-color"]),"fill-translate":new Se(xe.paint_fill["fill-translate"]),"fill-translate-anchor":new Se(xe.paint_fill["fill-translate-anchor"]),"fill-pattern":new Be(xe.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new Se(xe.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new Se(xe.paint_fill["fill-emissive-strength"]),"fill-z-offset":new Be(xe.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new Be(xe.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new Be(xe.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"})}))},e,n,l)}getProgramIds(){let o=this.paint.get("fill-pattern"),e=o&&o.constantOr(1),n=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&n.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),n}getDefaultProgramParams(o,e,n){return{config:new cd(this,{zoom:e,lut:n}),overrideFog:!1}}recalculate(o,e){super.recalculate(o,e);let n=this.paint._values["fill-outline-color"];n.value.kind==="constant"&&n.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(o){return new I_(o)}queryRadius(){return oo(this.paint.get("fill-translate"))}queryIntersectsFeature(o,e,n,l,c,m){return!o.queryGeometry.isAboveHorizon&&Bn(fr(o.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),m.angle,o.pixelToTileUnitsFactor),l)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(o){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;let e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return o!=null?e&&!o:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends lr{constructor(o,e,n,l){super(o,{layout:pa||(pa=new dt({visibility:new Se(xe["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new Se(xe["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:Pa||(Pa=new dt({"fill-extrusion-opacity":new Se(xe["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Be(xe["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Se(xe["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Se(xe["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Be(xe["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new Se(xe["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new Be(xe["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Be(xe["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new Se(xe["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new Se(xe["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new Se(xe["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Se(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Se(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new Se(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new Se(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new Se(xe["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new Se(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new Se(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Be(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Be(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new Se(xe["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new Se(xe["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new Se(xe["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new Se(xe["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Be(xe["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new Be(xe["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new Se(xe["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"})}))},e,n,l),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(o){return new ql(o)}queryRadius(){return oo(this.paint.get("fill-extrusion-translate"))}is3D(o){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(o,e,n,l,c,m,_,b,I){let E=so(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),m.angle,o.pixelToTileUnitsFactor),L=this.paint.get("fill-extrusion-height").evaluate(e,n),F=this.paint.get("fill-extrusion-base").evaluate(e,n),V=[0,0],W=b&&m.elevation,H=m.elevation?m.elevation.exaggeration():1,ee=o.tile.getBucket(this);if(W&&ee instanceof ql){let ie=ee.centroidVertexArray,me=I+1;me<ie.length&&(V[0]=ie.geta_centroid_pos0(me),V[1]=ie.geta_centroid_pos1(me))}if(V[0]===0&&V[1]===1)return!1;m.projection.name==="globe"&&(l=Ma([l],[new Ue(0,0),new Ue(xi,xi)],o.tileID.canonical).map(ie=>ie.polygon).flat());let le=W?b:null,[de,Ce]=function(ie,me,Ie,ze,Je,st,ut,xt,Ft,ri,$t){return ie.projection.name==="globe"?function(Qt,hi,Rt,Yt,Et,kt,pi,mi,qi,Bi,Ti){let ui=[],bn=[],Vi=Qt.projection.upVectorScale(Ti,Qt.center.lat,Qt.worldSize).metersToTile,Ui=[0,0,0,1],mn=[0,0,0,1],Pn=(Zn,kn,zn,$r)=>{Zn[0]=kn,Zn[1]=zn,Zn[2]=$r,Zn[3]=1},Rn=Oc();Rt>0&&(Rt+=Rn),Yt+=Rn;for(let Zn of hi){let kn=[],zn=[];for(let $r of Zn){let ao=$r.x+Et.x,Me=$r.y+Et.y,ke=Qt.projection.projectTilePoint(ao,Me,Ti),Nt=Qt.projection.upVector(Ti,$r.x,$r.y),vi=Rt,Ci=Yt;if(pi){let Si=Df(ao,Me,Rt,Yt,pi,mi,qi,Bi);vi+=Si.base,Ci+=Si.top}Rt!==0?Pn(Ui,ke.x+Nt[0]*Vi*vi,ke.y+Nt[1]*Vi*vi,ke.z+Nt[2]*Vi*vi):Pn(Ui,ke.x,ke.y,ke.z),Pn(mn,ke.x+Nt[0]*Vi*Ci,ke.y+Nt[1]*Vi*Ci,ke.z+Nt[2]*Vi*Ci),gr(Ui,Ui,kt),gr(mn,mn,kt),kn.push(new Ts(Ui[0],Ui[1],Ui[2])),zn.push(new Ts(mn[0],mn[1],mn[2]))}ui.push(kn),bn.push(zn)}return[ui,bn]}(ie,me,Ie,ze,Je,st,ut,xt,Ft,ri,$t):ut?function(Qt,hi,Rt,Yt,Et,kt,pi,mi,qi){let Bi=[],Ti=[],ui=[0,0,0,1];for(let bn of Qt){let Vi=[],Ui=[];for(let mn of bn){let Pn=mn.x+Yt.x,Rn=mn.y+Yt.y,Zn=Df(Pn,Rn,hi,Rt,kt,pi,mi,qi);ui[0]=Pn,ui[1]=Rn,ui[2]=Zn.base,ui[3]=1,Vo(ui,ui,Et),ui[3]=Math.max(ui[3],1e-5);let kn=new Ts(ui[0]/ui[3],ui[1]/ui[3],ui[2]/ui[3]);ui[0]=Pn,ui[1]=Rn,ui[2]=Zn.top,ui[3]=1,Vo(ui,ui,Et),ui[3]=Math.max(ui[3],1e-5);let zn=new Ts(ui[0]/ui[3],ui[1]/ui[3],ui[2]/ui[3]);Vi.push(kn),Ui.push(zn)}Bi.push(Vi),Ti.push(Ui)}return[Bi,Ti]}(me,Ie,ze,Je,st,ut,xt,Ft,ri):function(Qt,hi,Rt,Yt,Et){let kt=[],pi=[],mi=Et[8]*hi,qi=Et[9]*hi,Bi=Et[10]*hi,Ti=Et[11]*hi,ui=Et[8]*Rt,bn=Et[9]*Rt,Vi=Et[10]*Rt,Ui=Et[11]*Rt;for(let mn of Qt){let Pn=[],Rn=[];for(let Zn of mn){let kn=Zn.x+Yt.x,zn=Zn.y+Yt.y,$r=Et[0]*kn+Et[4]*zn+Et[12],ao=Et[1]*kn+Et[5]*zn+Et[13],Me=Et[2]*kn+Et[6]*zn+Et[14],ke=Et[3]*kn+Et[7]*zn+Et[15],Nt=$r+mi,vi=ao+qi,Ci=Me+Bi,Si=Math.max(ke+Ti,1e-5),Gi=$r+ui,un=ao+bn,ir=Me+Vi,nr=Math.max(ke+Ui,1e-5);Pn.push(new Ts(Nt/Si,vi/Si,Ci/Si)),Rn.push(new Ts(Gi/nr,un/nr,ir/nr))}kt.push(Pn),pi.push(Rn)}return[kt,pi]}(me,Ie,ze,Je,st)}(m,l,F,L,E,_,le,V,H,m.center.lat,o.tileID.canonical),we=o.queryGeometry;return function(ie,me,Ie){let ze=1/0;Bn(Ie,me)&&(ze=tf(Ie,me[0]));for(let Je=0;Je<me.length;Je++){let st=me[Je],ut=ie[Je];for(let xt=0;xt<st.length-1;xt++){let Ft=st[xt],ri=[Ft,st[xt+1],ut[xt+1],ut[xt],Ft];nn(Ie,ri)&&(ze=Math.min(ze,tf(Ie,ri)))}}return ze!==1/0&&ze}(de,Ce,we.isPointQuery()?we.screenBounds:we.screenGeometry)}},line:class extends lr{constructor(o,e,n,l){let c=$y();super(o,c,e,n,l),c.layout&&(this.layout=new et(c.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(o){if(o==="line-gradient"){let e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof uh,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(o,e){super.recalculate(o,e),this.paint._values["line-floorwidth"]=(()=>{if(Km)return Km;let n=$y();return Km=new sx(n.paint.properties["line-width"].specification),Km.useIntegerZoom=!0,Km})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,o)}createBucket(o){return new Og(o)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(o,e,n){let l=Qh(this);return{config:new cd(this,{zoom:e,lut:n}),defines:l,overrideFog:!1}}queryRadius(o){let e=o,n=cl(Dn("line-width",this,e),Dn("line-gap-width",this,e)),l=Dn("line-offset",this,e);return n/2+Math.abs(l)+oo(this.paint.get("line-translate"))}queryIntersectsFeature(o,e,n,l,c,m){if(o.queryGeometry.isAboveHorizon)return!1;let _=fr(o.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),m.angle,o.pixelToTileUnitsFactor),b=o.pixelToTileUnitsFactor/2*cl(this.paint.get("line-width").evaluate(e,n),this.paint.get("line-gap-width").evaluate(e,n)),I=this.paint.get("line-offset").evaluate(e,n);return I&&(l=function(E,L){let F=[],V=new Ue(0,0);for(let W=0;W<E.length;W++){let H=E[W],ee=[];for(let le=0;le<H.length;le++){let de=H[le],Ce=H[le+1],we=le===0?V:de.sub(H[le-1])._unit()._perp(),ie=le===H.length-1?V:Ce.sub(de)._unit()._perp(),me=we._add(ie)._unit();me._mult(1/(me.x*ie.x+me.y*ie.y)),ee.push(me._mult(L)._add(de))}F.push(ee)}return F}(l,I*o.pixelToTileUnitsFactor)),function(E,L,F){for(let V=0;V<L.length;V++){let W=L[V];if(E.length>=3){for(let H=0;H<W.length;H++)if(Or(E,W[H]))return!0}if(Er(E,W,F))return!0}return!1}(_,l,b)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(o){return!this.hasElevatedBuckets}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:a0,background:class extends lr{constructor(o,e,n,l){super(o,{layout:n1||(n1=new dt({visibility:new Se(xe.layout_background.visibility)})),paint:r1||(r1=new dt({"background-pitch-alignment":new Se(xe.paint_background["background-pitch-alignment"]),"background-color":new Se(xe.paint_background["background-color"]),"background-pattern":new Se(xe.paint_background["background-pattern"]),"background-opacity":new Se(xe.paint_background["background-opacity"]),"background-emissive-strength":new Se(xe.paint_background["background-emissive-strength"]),"background-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"})}))},e,n,l)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(o,e,n){return{overrideFog:!1}}is3D(o){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:c1,"raster-particle":m1,sky:class extends lr{constructor(o,e,n,l){super(o,{layout:d1||(d1=new dt({visibility:new Se(xe.layout_sky.visibility)})),paint:p1||(p1=new dt({"sky-type":new Se(xe.paint_sky["sky-type"]),"sky-atmosphere-sun":new Se(xe.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Se(xe.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Se(xe.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Se(xe.paint_sky["sky-gradient-radius"]),"sky-gradient":new ft(xe.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Se(xe.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Se(xe.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Se(xe.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"})}))},e,n,l),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(o){o==="sky-gradient"?this._updateColorRamp():o!=="sky-atmosphere-sun"&&o!=="sky-atmosphere-halo-color"&&o!=="sky-atmosphere-color"&&o!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Cf({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(o){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){let e=o.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(o,e){if(this.paint.get("sky-type")==="atmosphere"){let l=this.paint.get("sky-atmosphere-sun"),c=!l,m=o.style.light,_=m.properties.get("position");return c&&m.properties.get("anchor")==="viewport"&&Hi("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),c?Ex(_.azimuthal,90-_.polar,e):Ex(l[0],90-l[1],e)}let n=this.paint.get("sky-gradient-center");return Ex(n[0],90-n[1],e)}isSky(){return!0}markSkyboxValid(o){this._skyboxInvalidated=!1,this._lightPosition=o.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){let o=this.paint.get("sky-type");return o==="atmosphere"?["skyboxCapture","skybox"]:o==="gradient"?["skyboxGradient"]:null}},slot:class extends lr{constructor(o,e,n,l){super(o,{paint:f1||(f1=new dt({}))},e,null)}},model:class extends lr{constructor(o,e,n,l){super(o,{layout:S1||(S1=new dt({visibility:new Se(xe.layout_model.visibility),"model-id":new Be(xe.layout_model["model-id"])})),paint:I1||(I1=new dt({"model-opacity":new Be(xe.paint_model["model-opacity"]),"model-rotation":new Be(xe.paint_model["model-rotation"]),"model-scale":new Be(xe.paint_model["model-scale"]),"model-translation":new Be(xe.paint_model["model-translation"]),"model-color":new Be(xe.paint_model["model-color"]),"model-color-mix-intensity":new Be(xe.paint_model["model-color-mix-intensity"]),"model-type":new Se(xe.paint_model["model-type"]),"model-cast-shadows":new Se(xe.paint_model["model-cast-shadows"]),"model-receive-shadows":new Se(xe.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new Se(xe.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Be(xe.paint_model["model-emissive-strength"]),"model-roughness":new Be(xe.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Be(xe.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new Se(xe.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new Se(xe.paint_model["model-front-cutoff"]),"model-color-use-theme":new Be({type:"string",default:"default","property-type":"data-driven"})}))},e,n,l),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(o){return new Dx(o)}getProgramIds(){return["model"]}is3D(o){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(o){return o instanceof m0?xi-1:0}queryIntersectsFeature(o,e,n,l,c,m){if(!this.modelManager)return!1;let _=this.modelManager,b=o.tile.getBucket(this);if(!(b&&b instanceof Dx))return!1;for(let I in b.instancesPerModel){let E=b.instancesPerModel[I],L=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(E.idToFeaturesIndex.hasOwnProperty(L)){let F=E.features[E.idToFeaturesIndex[L]],V=_.getModel(I,this.scope);if(!V)return!1;let W=Wi(),H=new ae(0,0),ee=b.canonical,le=Number.MAX_VALUE;for(let de=0;de<F.instancedDataCount;++de){let Ce=16*(F.instancedDataOffset+de),we=E.instancedDataArray.float32,ie=[we[Ce+4],we[Ce+5],we[Ce+6]];D1(ee,H,we[Ce],0|we[Ce+1]),C1(W,V,m,H,F.rotation,F.scale,ie,!1,!1,!1),m.projection.name==="globe"&&(W=Px(W,m));let me=gn([],m.projMatrix,W),Ie=o.queryGeometry,ze=v1(Ie.isPointQuery()?Ie.screenBounds:Ie.screenGeometry,m,me,V.aabb);ze!=null&&(le=Math.min(ze,le))}return le!==Number.MAX_VALUE&&le}}return!1}_handleOverridablePaintPropertyUpdate(o,e,n){return!(!this.layout||e.isDataDriven()||n.isDataDriven()||o!=="model-color"&&o!=="model-color-mix-intensity"&&o!=="model-rotation"&&o!=="model-scale"&&o!=="model-translation"&&o!=="model-emissive-strength")}_isPropertyZoomDependent(o){let e=this._transitionablePaint._values[o];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof bu}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends lr{constructor(o,e,n,l){super(o,{layout:om||(om=new dt({"clip-layer-types":new Se(xe.layout_clip["clip-layer-types"]),"clip-layer-scope":new Se(xe.layout_clip["clip-layer-scope"])})),paint:E_||(E_=new dt({}))},e,n,l)}recalculate(o,e){super.recalculate(o,e)}createBucket(o){return new Ry(o)}is3D(o){return!0}}};class T2{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class S2{constructor(){this.tasks={},this.taskQueue=[],Di(["process"],this),this.invoker=new T2(this.process),this.nextId=0}add(e,n){let l=this.nextId++,c=function({type:m,isSymbolTile:_,zoom:b}){return b=b||0,m==="message"?0:m!=="maybePrepare"||_?m!=="parseTile"||_?m==="parseTile"&&_?300-b:m==="maybePrepare"&&_?400-b:500:200-b:100-b}(n);if(c===0){try{e()}finally{}return null}return this.tasks[l]={fn:e,metadata:n,priority:c,id:l},this.taskQueue.push(l),this.invoker.trigger(),{cancel:()=>{delete this.tasks[l]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(l=>!!this.tasks[l]),!this.taskQueue.length)return;let e=this.pick();if(e===null)return;let n=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!n)return;n.fn()}finally{}}pick(){let e=null,n=1/0;for(let c=0;c<this.taskQueue.length;c++){let m=this.tasks[this.taskQueue[c]];m.priority<n&&(n=m.priority,e=c)}if(e===null)return null;let l=this.taskQueue[e];return this.taskQueue.splice(e,1),l}remove(){this.invoker.remove()}}class R1{constructor(e,n,l){this.target=e,this.parent=n,this.mapId=l,this.callbacks={},this.cancelCallbacks={},Di(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new S2}send(e,n,l,c,m=!1,_){let b=Math.round(1e18*Math.random()).toString(36).substring(0,10);l&&(l.metadata=_,this.callbacks[b]=l);let I=new Set;return this.target.postMessage({id:b,type:e,hasCallback:!!l,targetMapId:c,mustQueue:m,sourceMapId:this.mapId,data:ds(n,I)},I),{cancel:()=>{l&&delete this.callbacks[b],this.target.postMessage({id:b,type:"<cancel>",targetMapId:c,sourceMapId:this.mapId})}}}receive(e){let n=e.data;if(!n)return;let l=n.id;if(l&&(!n.targetMapId||this.mapId===n.targetMapId))if(n.type==="<cancel>"){let c=this.cancelCallbacks[l];delete this.cancelCallbacks[l],c&&c.cancel()}else if(n.mustQueue||Ar(self)){let c=this.callbacks[l],m=this.scheduler.add(()=>this.processTask(l,n),c&&c.metadata||{type:"message"});m&&(this.cancelCallbacks[l]=m)}else this.processTask(l,n)}processTask(e,n){if(delete this.cancelCallbacks[e],n.type==="<response>"){let l=this.callbacks[e];delete this.callbacks[e],l&&(n.error?l(yh(n.error)):l(null,yh(n.data)))}else{let l=new Set,c=n.hasCallback?(_,b)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:_?ds(_):null,data:ds(b,l)},l)}:()=>{},m=yh(n.data);if(this.parent[n.type])this.parent[n.type](n.sourceMapId,m,c);else if(this.parent.getWorkerSource){let _=n.type.split("."),{source:b,scope:I}=m;this.parent.getWorkerSource(n.sourceMapId,_[0],b,I)[_[1]](m,c)}else c(new Error(`Could not find function ${n.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var Yg={workerUrl:"",workerClass:null,workerParams:void 0};let kx="mapboxgl_preloaded_worker_pool",_0=(()=>{class o{constructor(){this.active={}}acquire(n,l=o.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<l;)this.workers.push(Yg.workerClass!=null?new Yg.workerClass:new self.Worker(Yg.workerUrl,Yg.workerParams));return this.active[n]=!0,this.workers.slice()}release(n){delete this.active[n],this.workers&&this.numActive()===0&&(this.workers.forEach(l=>{l.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[kx]}numActive(){return Object.keys(this.active).length}}return o.workerCount=2,o})();class O_{constructor(e,n,l="Worker",c=_0.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=Ii();let m=this.workerPool.acquire(this.id,c);for(let _=0;_<m.length;_++){let b=new O_.Actor(m[_],n,this.id);b.name=`${l} ${_}`,this.actors.push(b)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,n,l){Ot(this.actors,(c,m)=>{c.send(e,n,m)},l=l||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}let Jg,Ox;function g0(){return Jg||(Jg=new _0),Jg}O_.Actor=R1;let Fx=new sr(0,0,0),Bx={PATH_RULE_UNSPECIFIED:0,PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},Nx={LINE_CAP_UNSPECIFIED:0,LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},y0={LINE_JOIN_UNSPECIFIED:0,LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},I2={PAINT_ORDER_UNSPECIFIED:0,PAINT_ORDER_FILL_AND_STROKE:1,PAINT_ORDER_STROKE_AND_FILL:2},Qg={PATH_COMMAND_UNSPECIFIED:0,PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},z1={MASK_TYPE_UNSPECIFIED:0,MASK_TYPE_LUMINANCE:1,MASK_TYPE_ALPHA:2};function C2(o,e,n){o===1&&e.icons.push(function(l,c){return function(m){if(m.usvg_tree.height||(m.usvg_tree.height=m.usvg_tree.width),!m.metadata)return m;let{metadata:_}=m;if(_.content_area){let{content_area:b}=_;b.top==null&&(b.top=b.left),b.width==null&&(b.width=m.usvg_tree.width),b.height==null&&(b.height=b.width)}return _.stretch_x&&_.stretch_x.length&&L1(_,"x"),_.stretch_y&&_.stretch_y.length&&L1(_,"y"),m}(l.readFields(E2,{name:void 0},c))}(n,n.readVarint()+n.pos))}function L1(o,e){let n=[],l=o[`stretch_${e}`],c=null;for(let m=0;m<l.length;m++)c===null?c=n.length===0?l[0]:n[n.length-1][1]+l[m]:(n.push([c,c+l[m]]),c=null);o[`stretch_${e}_areas`]=n}function E2(o,e,n){o===1?e.name=n.readString():o===2?e.metadata=function(l,c){return l.readFields(M2,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},c)}(n,n.readVarint()+n.pos):o===3&&(e.usvg_tree=function(l,c){return l.readFields(D2,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},c)}(n,n.readVarint()+n.pos),e.data="usvg_tree")}function M2(o,e,n){o===1?e.stretch_x=n.readPackedVarint():o===2?e.stretch_y=n.readPackedVarint():o===3?e.content_area=function(l,c){return l.readFields(P2,{left:0},c)}(n,n.readVarint()+n.pos):o===4&&e.variables.push(function(l,c){return l.readFields(A2,{name:void 0},c)}(n,n.readVarint()+n.pos))}function P2(o,e,n){o===1?e.left=n.readVarint():o===2?e.width=n.readVarint():o===3?e.top=n.readVarint():o===4&&(e.height=n.readVarint())}function A2(o,e,n){o===1?e.name=n.readString():o===2&&(e.rgb_color=b0(n.readVarint()),e.value="rgb_color")}function D2(o,e,n){o===1?e.width=e.height=n.readVarint():o===2?e.height=n.readVarint():o===3?e.children.push(x0(n,n.readVarint()+n.pos)):o===4?e.linear_gradients.push(function(l,c){return l.readFields(B2,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},c)}(n,n.readVarint()+n.pos)):o===5?e.radial_gradients.push(function(l,c){return l.readFields(V2,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},c)}(n,n.readVarint()+n.pos)):o===7?e.clip_paths.push(function(l,c){return l.readFields(U2,{children:[]},c)}(n,n.readVarint()+n.pos)):o===8&&e.masks.push(function(l,c){let m=l.readFields(j2,{left:0,width:20,mask_type:z1.MASK_TYPE_LUMINANCE,children:[]},c);return m.height==null&&(m.height=m.width),m.top==null&&(m.top=m.left),m}(n,n.readVarint()+n.pos))}function x0(o,e){return o.readFields(R2,{},e)}function R2(o,e,n){o===1?(e.group=function(l,c){return l.readFields(z2,{opacity:255,children:[]},c)}(n,n.readVarint()+n.pos),e.node="group"):o===2&&(e.path=function(l,c){return l.readFields(k2,{paint_order:1,commands:[],step:1,diffs:[],rule:Bx.PATH_RULE_NON_ZERO},c)}(n,n.readVarint()+n.pos),e.node="path")}function z2(o,e,n){o===1?e.transform=v0(n,n.readVarint()+n.pos):o===2?e.opacity=n.readVarint():o===5?e.clip_path_idx=n.readVarint():o===6?e.mask_idx=n.readVarint():o===7&&e.children.push(x0(n,n.readVarint()+n.pos))}function v0(o,e){return o.readFields(L2,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function L2(o,e,n){o===1?e.sx=n.readFloat():o===2?e.ky=n.readFloat():o===3?e.kx=n.readFloat():o===4?e.sy=n.readFloat():o===5?e.tx=n.readFloat():o===6&&(e.ty=n.readFloat())}function k2(o,e,n){o===1?e.fill=function(l,c){return l.readFields(O2,{rgb_color:Fx,paint:"rgb_color",opacity:255},c)}(n,n.readVarint()+n.pos):o===2?e.stroke=function(l,c){return l.readFields(F2,{rgb_color:Fx,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},c)}(n,n.readVarint()+n.pos):o===3?e.paint_order=n.readVarint():o===5?n.readPackedVarint(e.commands):o===6?e.step=n.readFloat():o===7?n.readPackedSVarint(e.diffs):o===8&&(e.rule=n.readVarint())}function O2(o,e,n){o===1?(e.rgb_color=b0(n.readVarint()),e.paint="rgb_color"):o===2?(e.linear_gradient_idx=n.readVarint(),e.paint="linear_gradient_idx"):o===3?(e.radial_gradient_idx=n.readVarint(),e.paint="radial_gradient_idx"):o===5&&(e.opacity=n.readVarint())}function b0(o){return new sr((o>>16&255)/255,(o>>8&255)/255,(255&o)/255,1)}function F2(o,e,n){o===1?(e.rgb_color=b0(n.readVarint()),e.paint="rgb_color"):o===2?(e.linear_gradient_idx=n.readVarint(),e.paint="linear_gradient_idx"):o===3?(e.radial_gradient_idx=n.readVarint(),e.paint="radial_gradient_idx"):o===5?n.readPackedFloat(e.dasharray):o===6?e.dashoffset=n.readFloat():o===7?e.miterlimit=n.readFloat():o===8?e.opacity=n.readVarint():o===9?e.width=n.readFloat():o===10?e.linecap=n.readVarint():o===11&&(e.linejoin=n.readVarint())}function B2(o,e,n){o===1?e.transform=v0(n,n.readVarint()+n.pos):o===2?e.spread_method=n.readVarint():o===3?e.stops.push(k1(n,n.readVarint()+n.pos)):o===4?e.x1=n.readFloat():o===5?e.y1=n.readFloat():o===6?e.x2=n.readFloat():o===7&&(e.y2=n.readFloat())}function k1(o,e){return o.readFields(N2,{offset:0,opacity:255,rgb_color:Fx},e)}function N2(o,e,n){o===1?e.offset=n.readFloat():o===2?e.opacity=n.readVarint():o===3&&(e.rgb_color=b0(n.readVarint()))}function V2(o,e,n){o===1?e.transform=v0(n,n.readVarint()+n.pos):o===2?e.spread_method=n.readVarint():o===3?e.stops.push(k1(n,n.readVarint()+n.pos)):o===4?e.cx=n.readFloat():o===5?e.cy=n.readFloat():o===6?e.r=n.readFloat():o===7?e.fx=n.readFloat():o===8?e.fy=n.readFloat():o===9&&(e.fr=n.readFloat())}function U2(o,e,n){o===1?e.transform=v0(n,n.readVarint()+n.pos):o===2?e.clip_path_idx=n.readVarint():o===3&&e.children.push(x0(n,n.readVarint()+n.pos))}function j2(o,e,n){o===1?e.left=e.top=n.readFloat():o===2?e.width=e.height=n.readFloat():o===3?e.top=n.readFloat():o===4?e.height=n.readFloat():o===5?e.mask_type=n.readVarint():o===6?e.mask_idx=n.readVarint():o===7&&e.children.push(x0(n,n.readVarint()+n.pos))}class G2{static calculate(e={},n=[]){let l=new Map,c=new Map;if(Object.keys(e).length===0)return l;n.forEach(m=>{c.set(m.name,m.rgb_color||new sr(0,0,0))});for(let[m,_]of Object.entries(e))c.has(m)?l.set(c.get(m).toStringPremultipliedAlpha(),_):console.warn(`Ignoring unknown image variable "${m}"`);return l}}function F_(o,e=255,n){let l=e/255,c=o.toStringPremultipliedAlpha(),m=n.has(c)?n.get(c).clone():o.clone();return m.a*=l,m.toString()}function ey(o,e){if(!af()){let n=document.createElement("canvas");return n.width=o,n.height=e,n}return new OffscreenCanvas(o,e)}function Z2(o,e){let n=G2.calculate(e.params,o.metadata?o.metadata.variables:[]),l=o.usvg_tree,c=l.width,m=l.height,_=e.transform?e.transform:new DOMMatrix,b=Math.max(1,Math.round(c*_.a)),I=Math.max(1,Math.round(m*_.d)),E=new DOMMatrix([b/c,0,0,I/m,0,0]),L=ey(b,I).getContext("2d");return Vx(L,E,l,l,n),L.getImageData(0,0,b,I)}function Vx(o,e,n,l,c){for(let m of l.children)O1(o,e,n,m,c)}function O1(o,e,n,l,c){l.group?(o.save(),function(m,_,b,I,E){let L=I.mask_idx!=null?b.masks[I.mask_idx]:null,F=I.clip_path_idx!=null?b.clip_paths[I.clip_path_idx]:null;if(I.transform&&(_=w0(I.transform).preMultiplySelf(_)),!function(H,ee,le){return H.opacity!==255||ee||le}(I,F!=null,L!=null))return void Vx(m,_,b,I,E);let V=ey(m.canvas.width,m.canvas.height),W=V.getContext("2d");Vx(W,_,b,I,E),F&&G1(W,_,b,F),L&&Z1(W,_,b,L,E),m.globalAlpha=I.opacity/255,m.drawImage(V,0,0)}(o,e,n,l.group,c),o.restore()):l.path&&(o.save(),function(m,_,b,I,E){let L=q1(I);m.setTransform(_),I.paint_order===I2.PAINT_ORDER_FILL_AND_STROKE?(F1(m,b,I,L,E),N1(m,b,I,L,E)):(N1(m,b,I,L,E),F1(m,b,I,L,E))}(o,e,n,l.path,c),o.restore())}function F1(o,e,n,l,c){let m=n.fill;if(!m)return;let _=m.opacity/255;switch(m.paint){case"rgb_color":o.fillStyle=F_(m.rgb_color,m.opacity,c);break;case"linear_gradient_idx":o.fillStyle=V1(o,e.linear_gradients[m.linear_gradient_idx],_,c);break;case"radial_gradient_idx":o.fillStyle=U1(o,e.radial_gradients[m.radial_gradient_idx],_,c)}o.fill(l,B1(n))}function B1(o){return o.rule===Bx.PATH_RULE_NON_ZERO?"nonzero":o.rule===Bx.PATH_RULE_EVEN_ODD?"evenodd":void 0}function N1(o,e,n,l,c){let m=n.stroke;if(!m)return;o.lineWidth=m.width,o.miterLimit=m.miterlimit,o.setLineDash(m.dasharray),o.lineDashOffset=m.dashoffset;let _=m.opacity/255;switch(m.paint){case"rgb_color":o.strokeStyle=F_(m.rgb_color,m.opacity,c);break;case"linear_gradient_idx":o.strokeStyle=V1(o,e.linear_gradients[m.linear_gradient_idx],_,c);break;case"radial_gradient_idx":o.strokeStyle=U1(o,e.radial_gradients[m.radial_gradient_idx],_,c)}switch(m.linejoin){case y0.LINE_JOIN_MITER_CLIP:case y0.LINE_JOIN_MITER:o.lineJoin="miter";break;case y0.LINE_JOIN_ROUND:o.lineJoin="round";break;case y0.LINE_JOIN_BEVEL:o.lineJoin="bevel"}switch(m.linecap){case Nx.LINE_CAP_BUTT:o.lineCap="butt";break;case Nx.LINE_CAP_ROUND:o.lineCap="round";break;case Nx.LINE_CAP_SQUARE:o.lineCap="square"}o.stroke(l)}function V1(o,e,n,l){if(e.stops.length===1){let V=e.stops[0];return F_(V.rgb_color,V.opacity*n,l)}let c=w0(e.transform),{x1:m,y1:_,x2:b,y2:I}=e,E=c.transformPoint(new DOMPoint(m,_)),L=c.transformPoint(new DOMPoint(b,I)),F=o.createLinearGradient(E.x,E.y,L.x,L.y);for(let V of e.stops)F.addColorStop(V.offset,F_(V.rgb_color,V.opacity*n,l));return F}function U1(o,e,n,l){if(e.stops.length===1){let V=e.stops[0];return F_(V.rgb_color,V.opacity*n,l)}let c=w0(e.transform),{fx:m,fy:_,cx:b,cy:I}=e,E=c.transformPoint(new DOMPoint(m,_)),L=c.transformPoint(new DOMPoint(b,I)),F=o.createRadialGradient(E.x,E.y,0,L.x,L.y,e.r*((c.a+c.d)/2));for(let V of e.stops)F.addColorStop(V.offset,F_(V.rgb_color,V.opacity*n,l));return F}function j1(o,e,n,l){let c=l.transform?w0(l.transform).preMultiplySelf(e):e,m=ey(o.canvas.width,o.canvas.height),_=m.getContext("2d");for(let I of l.children)if(I.group)j1(_,c,n,I.group);else if(I.path){let E=I.path,L=new Path2D;L.addPath(q1(E),c),_.fill(L,B1(E))}let b=l.clip_path_idx!=null?n.clip_paths[l.clip_path_idx]:null;b&&G1(_,c,n,b),o.globalCompositeOperation="source-over",o.drawImage(m,0,0)}function G1(o,e,n,l){let c=ey(o.canvas.width,o.canvas.height);j1(c.getContext("2d"),e,n,l),o.globalCompositeOperation="destination-in",o.drawImage(c,0,0)}function Z1(o,e,n,l,c){if(l.children.length===0)return;let m=l.mask_idx!=null?n.masks[l.mask_idx]:null;m&&Z1(o,e,n,m,c);let _=o.canvas.width,b=o.canvas.height,I=ey(_,b),E=I.getContext("2d"),L=l.width,F=l.height,V=l.left,W=l.top,H=new Path2D,ee=new Path2D;ee.rect(V,W,L,F),H.addPath(ee,e),E.clip(H);for(let Ce of l.children)O1(E,e,n,Ce,c);let le=E.getImageData(0,0,_,b),de=le.data;if(l.mask_type===z1.MASK_TYPE_LUMINANCE)for(let Ce=0;Ce<de.length;Ce+=4)de[Ce+3]=de[Ce+3]/255*(.2126*de[Ce]+.7152*de[Ce+1]+.0722*de[Ce+2]);E.putImageData(le,0,0),o.globalCompositeOperation="destination-in",o.drawImage(I,0,0)}function w0(o){return o?new DOMMatrix([o.sx,o.ky,o.kx,o.sy,o.tx,o.ty]):new DOMMatrix}function q1(o){let e=new Path2D,n=o.step,l=o.diffs[0]*n,c=o.diffs[1]*n;e.moveTo(l,c);for(let m=0,_=2;m<o.commands.length;m++)switch(o.commands[m]){case Qg.PATH_COMMAND_MOVE:l+=o.diffs[_++]*n,c+=o.diffs[_++]*n,e.moveTo(l,c);break;case Qg.PATH_COMMAND_LINE:l+=o.diffs[_++]*n,c+=o.diffs[_++]*n,e.lineTo(l,c);break;case Qg.PATH_COMMAND_QUAD:{let b=l+o.diffs[_++]*n,I=c+o.diffs[_++]*n;l=b+o.diffs[_++]*n,c=I+o.diffs[_++]*n,e.quadraticCurveTo(b,I,l,c);break}case Qg.PATH_COMMAND_CUBIC:{let b=l+o.diffs[_++]*n,I=c+o.diffs[_++]*n,E=b+o.diffs[_++]*n,L=I+o.diffs[_++]*n;l=E+o.diffs[_++]*n,c=L+o.diffs[_++]*n,e.bezierCurveTo(b,I,E,L,l,c);break}case Qg.PATH_COMMAND_CLOSE:e.closePath()}return e}class T0{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;let n=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,n),n}put(e,n){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,n)}delete(e){this.cache.delete(e)}}Ei(T0,"LRUCache");class Ux{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new ua(e,e.data)}getFromCache(e,n,l){return this.cacheMap.has(l)||this.cacheMap.set(l,new T0(150)),this.cacheMap.get(l).get(Yr(e.toString(),n))}setInCache(e,n,l,c){this.cacheDependenciesMap.has(c)||this.cacheDependenciesMap.set(c,new Map),this.cacheMap.has(c)||this.cacheMap.set(c,new T0(150));let m=this.cacheDependenciesMap.get(c),_=Yr(e.id.toString(),l);m.get(_)||m.set(_,new Set);let b=this.cacheMap.get(c),I=e.toString();m.get(_).add(I),b.put(Yr(e.toString(),l),n)}removeImagesFromCacheByIds(e,n,l=0){if(!this.cacheMap.has(l)||!this.cacheDependenciesMap.has(l))return;let c=this.cacheMap.get(l),m=this.cacheDependenciesMap.get(l);for(let _ of e){let b=Yr(_.toString(),n);if(m.has(b)){for(let I of m.get(b))c.delete(I);m.delete(b)}}}rasterize(e,n,l,c,m=Z2){let _=this.getFromCache(e,l,c);if(_)return _.clone();let b=m(n.icon,e.options),I=Ux._getImage(b);return this.setInCache(e,I,l,c),I.clone()}}class $1{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,n){let l=this.toIdx(e,n);return{min:this.minimums[l],max:this.maximums[l]}}isLeaf(e,n){return this.leaves[this.toIdx(e,n)]}toIdx(e,n){return n*this.size+e}}function W1(o,e,n,l){let c=0,m=Number.MAX_VALUE;for(let _=0;_<3;_++)if(Math.abs(l[_])<1e-15){if(n[_]<o[_]||n[_]>e[_])return null}else{let b=1/l[_],I=(o[_]-n[_])*b,E=(e[_]-n[_])*b;if(I>E){let L=I;I=E,E=L}if(I>c&&(c=I),E<m&&(m=E),c>m)return null}return c}function H1(o,e,n,l,c,m,_,b,I,E,L){let F=l-o,V=c-e,W=m-n,H=_-o,ee=b-e,le=I-n,de=L[1]*le-L[2]*ee,Ce=L[2]*H-L[0]*le,we=L[0]*ee-L[1]*H,ie=F*de+V*Ce+W*we;if(Math.abs(ie)<1e-15)return null;let me=1/ie,Ie=E[0]-o,ze=E[1]-e,Je=E[2]-n,st=(Ie*de+ze*Ce+Je*we)*me;if(st<0||st>1)return null;let ut=ze*W-Je*V,xt=Je*F-Ie*W,Ft=Ie*V-ze*F,ri=(L[0]*ut+L[1]*xt+L[2]*Ft)*me;return ri<0||st+ri>1?null:(H*ut+ee*xt+le*Ft)*me}function X1(o,e,n){return(o-e)/(n-e)}function K1(o,e,n,l,c,m,_,b,I){let E=1<<n,L=m-l,F=_-c,V=(o+1)/E*L+l,W=(e+0)/E*F+c,H=(e+1)/E*F+c;b[0]=(o+0)/E*L+l,b[1]=W,I[0]=V,I[1]=H}class Y1{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;let n=function(m){let _=Math.ceil(Math.log2(m.dim/8)),b=[],I=Math.ceil(Math.pow(2,_)),E=1/I,L=(W,H,ee,le,de)=>{let Ce=le?1:0,we=(W+1)*ee-Ce,ie=H*ee,me=(H+1)*ee-Ce;de[0]=W*ee,de[1]=ie,de[2]=we,de[3]=me},F=new $1(I),V=[];for(let W=0;W<I*I;W++){L(W%I,Math.floor(W/I),E,!1,V);let H=dm(V[0],V[1],m),ee=dm(V[2],V[1],m),le=dm(V[2],V[3],m),de=dm(V[0],V[3],m);F.minimums.push(Math.min(H,ee,le,de)),F.maximums.push(Math.max(H,ee,le,de)),F.leaves.push(1)}for(b.push(F),I/=2;I>=1;I/=2){let W=b[b.length-1];F=new $1(I);for(let H=0;H<I*I;H++){L(H%I,Math.floor(H/I),2,!0,V);let ee=W.getElevation(V[0],V[1]),le=W.getElevation(V[2],V[1]),de=W.getElevation(V[2],V[3]),Ce=W.getElevation(V[0],V[3]),we=W.isLeaf(V[0],V[1]),ie=W.isLeaf(V[2],V[1]),me=W.isLeaf(V[2],V[3]),Ie=W.isLeaf(V[0],V[3]),ze=Math.min(ee.min,le.min,de.min,Ce.min),Je=Math.max(ee.max,le.max,de.max,Ce.max),st=we&&ie&&me&&Ie;F.maximums.push(Je),F.minimums.push(ze),F.leaves.push(Je-ze<=5&&st?1:0)}b.push(F)}return b}(this.dem),l=n.length-1,c=n[l];this._addNode(c.minimums[0],c.maximums[0],c.leaves[0]),this._construct(n,0,0,l,0)}raycastRoot(e,n,l,c,m,_,b=1){return W1([e,n,-100],[l,c,this.maximums[0]*b],m,_)}raycast(e,n,l,c,m,_,b=1){if(!this.nodeCount)return null;let I=this.raycastRoot(e,n,l,c,m,_,b);if(I==null)return null;let E=[],L=[],F=[],V=[],W=[{idx:0,t:I,nodex:0,nodey:0,depth:0}];for(;W.length>0;){let{idx:H,t:ee,nodex:le,nodey:de,depth:Ce}=W.pop();if(this.leaves[H]){K1(le,de,Ce,e,n,l,c,F,V);let ie=1<<Ce,me=(le+0)/ie,Ie=(le+1)/ie,ze=(de+0)/ie,Je=(de+1)/ie,st=dm(me,ze,this.dem)*b,ut=dm(Ie,ze,this.dem)*b,xt=dm(Ie,Je,this.dem)*b,Ft=dm(me,Je,this.dem)*b,ri=H1(F[0],F[1],st,V[0],F[1],ut,V[0],V[1],xt,m,_),$t=H1(V[0],V[1],xt,F[0],V[1],Ft,F[0],F[1],st,m,_),Qt=Math.min(ri!==null?ri:Number.MAX_VALUE,$t!==null?$t:Number.MAX_VALUE);if(Qt!==Number.MAX_VALUE)return Qt;{let hi=as([],m,_,ee);if(J1(st,ut,Ft,xt,X1(hi[0],F[0],V[0]),X1(hi[1],F[1],V[1]))>=hi[2])return ee}continue}let we=0;for(let ie=0;ie<this._siblingOffset.length;ie++){K1((le<<1)+this._siblingOffset[ie][0],(de<<1)+this._siblingOffset[ie][1],Ce+1,e,n,l,c,F,V),F[2]=-100,V[2]=this.maximums[this.childOffsets[H]+ie]*b;let me=W1(F,V,m,_);if(me!=null){let Ie=me;E[ie]=Ie;let ze=!1;for(let Je=0;Je<we&&!ze;Je++)Ie>=E[L[Je]]&&(L.splice(Je,0,ie),ze=!0);ze||(L[we]=ie),we++}}for(let ie=0;ie<we;ie++){let me=L[ie];W.push({idx:this.childOffsets[H]+me,t:E[me],nodex:(le<<1)+this._siblingOffset[me][0],nodey:(de<<1)+this._siblingOffset[me][1],depth:Ce+1})}}return null}_addNode(e,n,l){return this.minimums.push(e),this.maximums.push(n),this.leaves.push(l),this.childOffsets.push(0),this.nodeCount++}_construct(e,n,l,c,m){if(e[c].isLeaf(n,l)===1)return;this.childOffsets[m]||(this.childOffsets[m]=this.nodeCount);let _=c-1,b=e[_],I=0,E=0;for(let L=0;L<this._siblingOffset.length;L++){let F=2*n+this._siblingOffset[L][0],V=2*l+this._siblingOffset[L][1],W=b.getElevation(F,V),H=b.isLeaf(F,V),ee=this._addNode(W.min,W.max,H);H&&(I|=1<<L),E||(E=ee)}for(let L=0;L<this._siblingOffset.length;L++)I&1<<L||this._construct(e,2*n+this._siblingOffset[L][0],2*l+this._siblingOffset[L][1],_,E+L)}}function J1(o,e,n,l,c,m){return en(en(o,n,m),en(e,l,m),c)}function dm(o,e,n){let l=n.dim,c=rt(o*l-.5,0,l-1),m=rt(e*l-.5,0,l-1),_=Math.floor(c),b=Math.floor(m),I=Math.min(_+1,l-1),E=Math.min(b+1,l-1);return J1(n.get(_,b),n.get(I,b),n.get(_,E),n.get(I,E),c-_,m-b)}let q2={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function $2(o,e,n){return(256*o*256+256*e+n)/10-1e4}function W2(o,e,n){return 256*o+e+n/256-32768}class S0{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,n,l,c=!1){if(this.uid=e,n.height!==n.width)throw new RangeError("DEM tiles must be square");if(l&&l!=="mapbox"&&l!=="terrarium")return void Hi(`"${l}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=n.height;let m=this.dim=n.height-2,_=new Uint32Array(n.data.buffer);if(this.pixels=new Uint8Array(n.data.buffer),this.floatView=new Float32Array(n.data.buffer),this.borderReady=c,this._modifiedForSources={},!c){for(let I=0;I<m;I++)_[this._idx(-1,I)]=_[this._idx(0,I)],_[this._idx(m,I)]=_[this._idx(m-1,I)],_[this._idx(I,-1)]=_[this._idx(I,0)],_[this._idx(I,m)]=_[this._idx(I,m-1)];_[this._idx(-1,-1)]=_[this._idx(0,0)],_[this._idx(m,-1)]=_[this._idx(m-1,0)],_[this._idx(-1,m)]=_[this._idx(0,m-1)],_[this._idx(m,m)]=_[this._idx(m-1,m-1)]}let b=l==="terrarium"?W2:$2;for(let I=0;I<_.length;++I){let E=4*I;this.floatView[I]=b(this.pixels[E],this.pixels[E+1],this.pixels[E+2])}this._timestamp=Ml.now()}_buildQuadTree(){this._tree=new Y1(this)}get(e,n,l=!1){l&&(e=rt(e,-1,this.dim),n=rt(n,-1,this.dim));let c=this._idx(e,n);return this.floatView[c]}set(e,n,l){let c=this._idx(e,n),m=this.floatView[c];return this.floatView[c]=l,l-m}static getUnpackVector(e){return q2[e]}_idx(e,n){if(e<-1||e>=this.dim+1||n<-1||n>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(n+1)*this.stride+(e+1)}static pack(e,n){let l=[0,0,0,0],c=S0.getUnpackVector(n),m=Math.floor((e+c[3])/c[2]);return l[2]=m%256,m=Math.floor(m/256),l[1]=m%256,m=Math.floor(m/256),l[0]=m,l}getPixels(){return new wy({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,n,l){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let c=n*this.dim,m=n*this.dim+this.dim,_=l*this.dim,b=l*this.dim+this.dim;switch(n){case-1:c=m-1;break;case 1:m=c+1}switch(l){case-1:_=b-1;break;case 1:b=_+1}let I=-n*this.dim,E=-l*this.dim;for(let L=_;L<b;L++)for(let F=c;F<m;F++){let V=4*this._idx(F,L),W=4*this._idx(F+I,L+E);this.pixels[V+0]=e.pixels[W+0],this.pixels[V+1]=e.pixels[W+1],this.pixels[V+2]=e.pixels[W+2],this.pixels[V+3]=e.pixels[W+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function H2(o,e,n){o===1?e.headerLength=n.readFixed32():o===2?e.x=n.readVarint():o===3?e.y=n.readVarint():o===4?e.z=n.readVarint():o===5&&e.layers.push(function(l,c){return l.readFields(Q2,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},c)}(n,n.readVarint()+n.pos))}function X2(o,e,n){o===1?(e.delta_filter=function(l,c){return l.readFields(K2,{blockSize:0},c)}(n,n.readVarint()+n.pos),e.filter="delta_filter"):o===2?(n.readVarint(),e.filter="zigzag_filter"):o===3?(n.readVarint(),e.filter="bitshuffle_filter"):o===4&&(n.readVarint(),e.filter="byteshuffle_filter")}function K2(o,e,n){o===1&&(e.blockSize=n.readVarint())}function Y2(o,e,n){o===1?(n.readVarint(),e.codec="gzip_data"):o===2?(n.readVarint(),e.codec="jpeg_image"):o===3?(n.readVarint(),e.codec="webp_image"):o===4&&(n.readVarint(),e.codec="png_image")}function J2(o,e,n){let l=0,c=0;o===1?e.firstByte=n.readFixed64():o===2?e.lastByte=n.readFixed64():o===3?e.filters.push(function(m,_){return m.readFields(X2,{},_)}(n,n.readVarint()+n.pos)):o===4?e.codec=function(m,_){return m.readFields(Y2,{},_)}(n,n.readVarint()+n.pos):o===5?c=n.readFloat():o===6?l=n.readFloat():o===7?e.bands.push(n.readString()):o===8?e.offset=n.readDouble():o===9&&(e.scale=n.readDouble()),e.offset===0&&(e.offset=c),e.scale===0&&(e.scale=l)}function Q2(o,e,n){o===1?e.version=n.readVarint():o===2?e.name=n.readString():o===3?e.units=n.readString():o===4?e.tileSize=n.readVarint():o===5?e.buffer=n.readVarint():o===6?e.pixelFormat=n.readVarint():o===7&&e.dataIndex.push(function(l,c){return l.readFields(J2,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},c)}(n,n.readVarint()+n.pos))}function eT(o,e,n){if(o===2)(function(l,c,m){l.readFields(tT,m,c)})(n,n.readVarint()+n.pos,e);else if(o===3)throw new Error("Not implemented")}function tT(o,e,n){if(o===1){let l=0,c=n.readVarint()+n.pos;for(;n.pos<c;)e[l++]=n.readVarint()}}function iT(o,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let n=e[3];for(let l=2;l>=1;l--){let c=l===1?1:0,m=l===2?1:0;for(let _=0;_<e[0];_++){let b=e[1]*_;for(let I=c;I<e[1];I++){let E=e[2]*(I+b);for(let L=m;L<e[2];L++){let F=e[3]*(L+E);for(let V=0;V<e[3];V++){let W=F+V;o[W]+=o[W-n]}}}}n*=e[l]}return o}function nT(o){for(let e=0,n=o.length;e<n;e++)o[e]=o[e]>>>1^-(1&o[e]);return o}function rT(o,e){switch(e){case"uint32":return o;case"uint16":for(let n=0;n<o.length;n+=2){let l=o[n],c=o[n+1];o[n]=(240&l)>>4|(61440&l)>>8|(240&c)<<4|61440&c,o[n+1]=15&l|(3840&l)>>4|(15&c)<<8|(3840&c)<<4}return o;case"uint8":for(let n=0;n<o.length;n+=4){let l=o[n],c=o[n+1],m=o[n+2],_=o[n+3];o[n+0]=(192&l)>>6|(192&c)>>4|(192&m)>>2|192&_,o[n+1]=(48&l)>>4|(48&c)>>2|48&m|(48&_)<<2,o[n+2]=(12&l)>>2|12&c|(12&m)<<2|(12&_)<<4,o[n+3]=3&l|(3&c)<<2|(3&m)<<4|(3&_)<<6}return o;default:throw new Error(`Invalid pixel format, "${e}"`)}}Ei(S0,"DEMData"),Ei(Y1,"DemMinMaxQuadTree",{omit:["dem"]});var Au=Uint8Array,ty=Uint16Array,oT=Int32Array,Q1=new Au([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),eb=new Au([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),sT=new Au([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),tb=function(o,e){for(var n=new ty(31),l=0;l<31;++l)n[l]=e+=1<<o[l-1];var c=new oT(n[30]);for(l=1;l<30;++l)for(var m=n[l];m<n[l+1];++m)c[m]=m-n[l]<<5|l;return{b:n,r:c}},ib=tb(Q1,2),nb=ib.b,aT=ib.r;nb[28]=258,aT[258]=28;for(var lT=tb(eb,0).b,rb=new ty(32768),ia=0;ia<32768;++ia){var B_=(43690&ia)>>1|(21845&ia)<<1;rb[ia]=((65280&(B_=(61680&(B_=(52428&B_)>>2|(13107&B_)<<2))>>4|(3855&B_)<<4))>>8|(255&B_)<<8)>>1}var iy=function(o,e,n){for(var l=o.length,c=0,m=new ty(e);c<l;++c)o[c]&&++m[o[c]-1];var _,b=new ty(e);for(c=1;c<e;++c)b[c]=b[c-1]+m[c-1]<<1;_=new ty(1<<e);var I=15-e;for(c=0;c<l;++c)if(o[c])for(var E=c<<4|o[c],L=e-o[c],F=b[o[c]-1]++<<L,V=F|(1<<L)-1;F<=V;++F)_[rb[F]>>I]=E;return _},ny=new Au(288);for(ia=0;ia<144;++ia)ny[ia]=8;for(ia=144;ia<256;++ia)ny[ia]=9;for(ia=256;ia<280;++ia)ny[ia]=7;for(ia=280;ia<288;++ia)ny[ia]=8;var ob=new Au(32);for(ia=0;ia<32;++ia)ob[ia]=5;var cT=iy(ny,9),hT=iy(ob,5),jx=function(o){for(var e=o[0],n=1;n<o.length;++n)o[n]>e&&(e=o[n]);return e},Ip=function(o,e,n){var l=e/8|0;return(o[l]|o[l+1]<<8)>>(7&e)&n},Gx=function(o,e){var n=e/8|0;return(o[n]|o[n+1]<<8|o[n+2]<<16)>>(7&e)},uT=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Cp=function(o,e,n){var l=new Error(e||uT[o]);if(l.code=o,Error.captureStackTrace&&Error.captureStackTrace(l,Cp),!n)throw l;return l},dT=new Au(0),pT=typeof TextDecoder<"u"&&new TextDecoder;try{pT.decode(dT,{stream:!0})}catch{}let fT={gzip_data:"gzip"};class gd extends Error{constructor(e){super(e),this.name="MRTError"}}let mT={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},sb={uint32:1,uint16:2,uint8:4},_T={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array},Zx;class I0{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){let n=this.layers[e];if(!n)throw new gd(`Layer '${e}' not found`);return n}getHeaderLength(e){let n=new Uint8Array(e),l=new DataView(e);if(n[0]!==13)throw new gd("File is not a valid MRT.");return l.getUint32(1,!0)}parseHeader(e){let n=new Uint8Array(e),l=this.getHeaderLength(e);if(n.length<l)throw new gd(`Expected header with length >= ${l} but got buffer of length ${n.length}`);let c=function(m,_){return m.readFields(H2,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0)}(new Zx(n.subarray(0,l)));if(!isNaN(this.x)&&(this.x!==c.x||this.y!==c.y||this.z!==c.z))throw new gd(`Invalid attempt to parse header ${c.z}/${c.x}/${c.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=c.x,this.y=c.y,this.z=c.z;for(let m of c.layers)this.layers[m.name]=new ab(m,{cacheSize:this._cacheSize});return this}createDecodingTask(e){let n=[],l=this.getLayer(e.layerName);for(let c of e.blockIndices){let m=l.dataIndex[c],_=m.firstByte-e.firstByte,b=m.lastByte-e.firstByte;if(l._blocksInProgress.has(c))continue;let I={layerName:l.name,firstByte:_,lastByte:b,pixelFormat:l.pixelFormat,blockIndex:c,blockShape:[m.bands.length].concat(l.bandShape),buffer:l.buffer,codec:m.codec.codec,filters:m.filters.map(E=>E.filter)};l._blocksInProgress.add(c),n.push(I)}return new lb(n,()=>{n.forEach(c=>l._blocksInProgress.delete(c.blockIndex))},(c,m)=>{if(n.forEach(_=>l._blocksInProgress.delete(_.blockIndex)),c)throw c;m.forEach(_=>{this.getLayer(_.layerName).processDecodedData(_)})})}}class ab{constructor({version:e,name:n,units:l,tileSize:c,pixelFormat:m,buffer:_,dataIndex:b},I){if(this.version=e,this.version!==1)throw new gd(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=n,this.units=l,this.tileSize=c,this.buffer=_,this.pixelFormat=mT[m],this.dataIndex=b,this.bandShape=[c+2*_,c+2*_,sb[this.pixelFormat]],this._decodedBlocks=new T0(I?I.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return sb[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){let n=e.blockIndex.toString();this._decodedBlocks.get(n)||this._decodedBlocks.put(n,e.data)}getBlockForBand(e){let n=0;switch(typeof e){case"string":for(let[l,c]of this.dataIndex.entries()){for(let[m,_]of c.bands.entries())if(_===e)return{bandIndex:n+m,blockIndex:l,blockBandIndex:m};n+=c.bands.length}break;case"number":for(let[l,c]of this.dataIndex.entries()){if(e>=n&&e<n+c.bands.length)return{bandIndex:e,blockIndex:l,blockBandIndex:e-n};n+=c.bands.length}break;default:throw new gd(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let n=1/0,l=-1/0,c=[],m=new Set;for(let _ of e){let{blockIndex:b}=this.getBlockForBand(_);if(b<0)throw new gd(`Invalid band: ${JSON.stringify(_)}`);let I=this.dataIndex[b];c.includes(b)||c.push(b),m.add(b),n=Math.min(n,I.firstByte),l=Math.max(l,I.lastByte)}if(m.size>this.cacheSize)throw new gd(`Number of blocks to decode (${m.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:n,lastByte:l,blockIndices:c}}hasBand(e){let{blockIndex:n}=this.getBlockForBand(e);return n>=0}hasDataForBand(e){let{blockIndex:n}=this.getBlockForBand(e);return n>=0&&!!this._decodedBlocks.get(n.toString())}getBandView(e){let{blockIndex:n,blockBandIndex:l}=this.getBlockForBand(e);if(n<0)throw new gd(`Band not found: ${JSON.stringify(e)}`);let c=this._decodedBlocks.get(n.toString());if(!c)throw new gd(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);let m=this.dataIndex[n],_=this.bandShape.reduce((E,L)=>E*L,1),b=l*_,I=c.subarray(b,b+_);return{data:I,bytes:new Uint8Array(I.buffer).subarray(I.byteOffset,I.byteOffset+I.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:m.offset,scale:m.scale}}}I0.setPbf=function(o){Zx=o};class lb{constructor(e,n,l){this.tasks=e,this._onCancel=n,this._onComplete=l,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,n){this._finalized||(this._onComplete(e,n),this._finalized=!0)}}I0.performDecoding=function(o,e){let n=new Uint8Array(o);return Promise.all(e.tasks.map(l=>{let{layerName:c,firstByte:m,lastByte:_,pixelFormat:b,blockShape:I,blockIndex:E,filters:L,codec:F}=l,V=n.subarray(m,_+1),W=new Uint32Array(I[0]*I[1]*I[2]),H;if(F!=="gzip_data")throw new gd(`Unhandled codec: ${F}`);return H=function(ee,le){if(!globalThis.DecompressionStream&&le==="gzip_data")return Promise.resolve(((ie=function(ze){ze[0]==31&&ze[1]==139&&ze[2]==8||Cp(6,"invalid gzip data");var Je=ze[3],st=10;4&Je&&(st+=2+(ze[10]|ze[11]<<8));for(var ut=(Je>>3&1)+(Je>>4&1);ut>0;ut-=!ze[st++]);return st+(2&Je)}(we=ee))+8>we.length&&Cp(6,"invalid gzip data"),function(ze,Je,st,ut){var xt=ze.length;if(!xt||Je.f&&!Je.l)return st||new Au(0);var Ft=!st,ri=Ft||Je.i!=2,$t=Je.i;Ft&&(st=new Au(3*xt));var Qt,hi,Rt=function(Ko){var mo=st.length;if(Ko>mo){var eo=new Au(Math.max(2*mo,Ko));eo.set(st),st=eo}},Yt=Je.f||0,Et=Je.p||0,kt=Je.b||0,pi=Je.l,mi=Je.d,qi=Je.m,Bi=Je.n,Ti=8*xt;do{if(!pi){Yt=Ip(ze,Et,1);var ui=Ip(ze,Et+1,3);if(Et+=3,!ui){var bn=ze[(Me=4+((Et+7)/8|0))-4]|ze[Me-3]<<8,Vi=Me+bn;if(Vi>xt){$t&&Cp(0);break}ri&&Rt(kt+bn),st.set(ze.subarray(Me,Vi),kt),Je.b=kt+=bn,Je.p=Et=8*Vi,Je.f=Yt;continue}if(ui==1)pi=cT,mi=hT,qi=9,Bi=5;else if(ui==2){var Ui=Ip(ze,Et,31)+257,mn=Ip(ze,Et+10,15)+4,Pn=Ui+Ip(ze,Et+5,31)+1;Et+=14;for(var Rn=new Au(Pn),Zn=new Au(19),kn=0;kn<mn;++kn)Zn[sT[kn]]=Ip(ze,Et+3*kn,7);Et+=3*mn;var zn=jx(Zn),$r=(1<<zn)-1,ao=iy(Zn,zn);for(kn=0;kn<Pn;){var Me,ke=ao[Ip(ze,Et,$r)];if(Et+=15&ke,(Me=ke>>4)<16)Rn[kn++]=Me;else{var Nt=0,vi=0;for(Me==16?(vi=3+Ip(ze,Et,3),Et+=2,Nt=Rn[kn-1]):Me==17?(vi=3+Ip(ze,Et,7),Et+=3):Me==18&&(vi=11+Ip(ze,Et,127),Et+=7);vi--;)Rn[kn++]=Nt}}var Ci=Rn.subarray(0,Ui),Si=Rn.subarray(Ui);qi=jx(Ci),Bi=jx(Si),pi=iy(Ci,qi),mi=iy(Si,Bi)}else Cp(1);if(Et>Ti){$t&&Cp(0);break}}ri&&Rt(kt+131072);for(var Gi=(1<<qi)-1,un=(1<<Bi)-1,ir=Et;;ir=Et){var nr=(Nt=pi[Gx(ze,Et)&Gi])>>4;if((Et+=15&Nt)>Ti){$t&&Cp(0);break}if(Nt||Cp(2),nr<256)st[kt++]=nr;else{if(nr==256){ir=Et,pi=null;break}var Ln=nr-254;nr>264&&(Ln=Ip(ze,Et,(1<<(rr=Q1[kn=nr-257]))-1)+nb[kn],Et+=rr);var Nr=mi[Gx(ze,Et)&un],Qr=Nr>>4;if(Nr||Cp(3),Et+=15&Nr,Si=lT[Qr],Qr>3){var rr=eb[Qr];Si+=Gx(ze,Et)&(1<<rr)-1,Et+=rr}if(Et>Ti){$t&&Cp(0);break}ri&&Rt(kt+131072);var Po=kt+Ln;if(kt<Si){var lo=0-Si,Fr=Math.min(Si,Po);for(lo+kt<0&&Cp(3);kt<Fr;++kt)st[kt]=(void 0)[lo+kt]}for(;kt<Po;++kt)st[kt]=st[kt-Si]}}Je.l=pi,Je.p=ir,Je.b=kt,Je.f=Yt,pi&&(Yt=1,Je.m=qi,Je.d=mi,Je.n=Bi)}while(!Yt);return kt!=st.length&&Ft?(Qt=st,((hi=kt)==null||hi>Qt.length)&&(hi=Qt.length),new Au(Qt.subarray(0,hi))):st.subarray(0,kt)}(we.subarray(ie,-8),{i:2},new Au(((de=we)[(Ce=de.length)-4]|de[Ce-3]<<8|de[Ce-2]<<16|de[Ce-1]<<24)>>>0))));var de,Ce,we,ie;let me=fT[le];if(!me)throw new Error(`Unhandled codec: ${le}`);let Ie=new globalThis.DecompressionStream(me);return new Response(new Blob([ee]).stream().pipeThrough(Ie)).arrayBuffer().then(ze=>new Uint8Array(ze))}(V,F).then(ee=>(function(le,de){le.readFields(eT,de)}(new Zx(ee),W),new _T[b](W.buffer))),H.then(ee=>{for(let le=L.length-1;le>=0;le--)switch(L[le]){case"delta_filter":iT(ee,I);break;case"zigzag_filter":nT(ee);break;case"bitshuffle_filter":rT(ee,b);break;default:throw new gd(`Unhandled filter "${L[le]}"`)}return{layerName:c,blockIndex:E,data:ee}}).catch(ee=>{throw ee})}))},Ei(lb,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),Ei(I0,"MapboxRasterTile"),Ei(ab,"MapboxRasterLayer",{omit:["_blocksInProgress"]});let ry,qx,Ep,N_,$x,V_=null;function cb(){return Ar(self)&&self.worker.dracoUrl?self.worker.dracoUrl:qx||ls.DRACO_URL}function hb(){if(Ar(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(N_)return N_;let o=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return N_=WebAssembly.validate(o)?ls.MESHOPT_SIMD_URL:ls.MESHOPT_URL,N_}let C0={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},gT={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},oy={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function ub(o,e,n){let l=n.json.bufferViews.length,c=n.buffers.length;e.bufferView=l,n.json.bufferViews[l]={buffer:c,byteLength:o.byteLength},n.buffers[c]=o}let Wx="KHR_draco_mesh_compression";function yT(o,e){let n=o.extensions&&o.extensions[Wx];if(!n)return;let l=new Ep.Decoder,c=mb(e,n.bufferView),m=new Ep.Mesh;if(!l.DecodeArrayToMesh(c,c.byteLength,m))throw new Error("Failed to decode Draco mesh");let _=e.json.accessors[o.indices],b=C0[_.componentType],I=_.count*b.BYTES_PER_ELEMENT,E=Ep._malloc(I);b===Uint16Array?l.GetTrianglesUInt16Array(m,I,E):l.GetTrianglesUInt32Array(m,I,E),ub(Ep.memory.buffer.slice(E,E+I),_,e),Ep._free(E);for(let L of Object.keys(n.attributes)){let F=l.GetAttributeByUniqueId(m,n.attributes[L]),V=e.json.accessors[o.attributes[L]],W=gT[V.componentType],H=V.count*oy[V.type]*C0[V.componentType].BYTES_PER_ELEMENT,ee=Ep._malloc(H);l.GetAttributeDataArrayForAllPoints(m,F,Ep[W],H,ee),ub(Ep.memory.buffer.slice(ee,ee+H),V,e),Ep._free(ee)}l.destroy(),m.destroy(),delete o.extensions[Wx]}let E0="EXT_meshopt_compression";function xT(o,e){if(!o.extensions||!o.extensions[E0])return;let n=o.extensions[E0],l=new Uint8Array(e.buffers[n.buffer],n.byteOffset||0,n.byteLength||0),c=new Uint8Array(n.count*n.byteStride);$x.decodeGltfBuffer(c,n.count,n.byteStride,l,n.mode,n.filter),o.buffer=e.buffers.length,o.byteOffset=0,e.buffers[o.buffer]=c.buffer,delete o.extensions[E0]}let db=1179937895,pb=new TextDecoder("utf8");function fb(o,e){return new URL(o,e).href}function vT(o,e,n,l){return fetch(fb(o.uri,l)).then(c=>c.arrayBuffer()).then(c=>{e.buffers[n]=c})}function mb(o,e){let n=o.json.bufferViews[e];return new Uint8Array(o.buffers[n.buffer],n.byteOffset||0,n.byteLength)}function bT(o,e,n,l){if(o.uri){let c=fb(o.uri,l);return fetch(c).then(m=>m.blob()).then(m=>createImageBitmap(m)).then(m=>{e.images[n]=m})}if(o.bufferView!==void 0){let c=mb(e,o.bufferView),m=new Blob([c],{type:o.mimeType});return createImageBitmap(m).then(_=>{e.images[n]=_})}}function _b(o,e=0,n){let l={json:null,images:[],buffers:[]};if(new Uint32Array(o,e,1)[0]===db){let L=new Uint32Array(o,e),F=2,V=(L[F++]>>2)-3,W=L[F++]>>2;if(F++,l.json=JSON.parse(pb.decode(L.subarray(F,F+W))),F+=W,F<V){let H=L[F++];F++;let ee=e+(F<<2);l.buffers[0]=o.slice(ee,ee+H)}}else l.json=JSON.parse(pb.decode(new Uint8Array(o,e)));let{buffers:c,images:m,meshes:_,extensionsUsed:b,bufferViews:I}=l.json,E=Promise.resolve();if(c){let L=[];for(let F=0;F<c.length;F++){let V=c[F];V.uri?L.push(vT(V,l,F,n)):l.buffers[F]||(l.buffers[F]=null)}E=Promise.all(L)}return E.then(()=>{let L=[],F=b&&b.includes(Wx),V=b&&b.includes(E0);if(F&&L.push(function(){if(!Ep)return ry??(ry=function(W){let H,ee=null;function le(){H=new Uint8Array(ee.buffer)}function de(){throw new Error("Unexpected Draco error.")}let Ce={a:{a:de,d:function(we,ie,me){return H.copyWithin(we,ie,ie+me)},c:function(we){let ie=H.length,me=Math.max(we>>>0,Math.ceil(1.2*ie)),Ie=Math.ceil((me-ie)/65536);try{return ee.grow(Ie),le(),!0}catch{return!1}},b:de}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(W,Ce):W.then(we=>we.arrayBuffer()).then(we=>WebAssembly.instantiate(we,Ce))).then(we=>{let{Rb:ie,Qb:me,P:Ie,T:ze,X:Je,Ja:st,La:ut,Qa:xt,Va:Ft,Wa:ri,eb:$t,jb:Qt,f:hi,e:Rt,yb:Yt,zb:Et,Ab:kt,Bb:pi,Db:mi,Gb:qi}=we.instance.exports;ee=Rt;let Bi=(()=>{let Ti=0,ui=0,bn=0,Vi=0;return Ui=>{bn&&(ie(Vi),ie(Ti),ui+=bn,bn=Ti=0),Ti||(ui+=128,Ti=me(ui));let mn=Ui.length+7&-8,Pn=Ti;mn>=ui&&(bn=mn,Pn=Vi=me(mn));for(let Rn=0;Rn<Ui.length;Rn++)H[Pn+Rn]=Ui[Rn];return Pn}})();return le(),hi(),{memory:Rt,_free:ie,_malloc:me,Mesh:class{constructor(){this.ptr=Ie()}destroy(){ze(this.ptr)}},Decoder:class{constructor(){this.ptr=st()}destroy(){Qt(this.ptr)}DecodeArrayToMesh(Ti,ui,bn){let Vi=Bi(Ti),Ui=ut(this.ptr,Vi,ui,bn.ptr);return!!Je(Ui)}GetAttributeByUniqueId(Ti,ui){return{ptr:xt(this.ptr,Ti.ptr,ui)}}GetTrianglesUInt16Array(Ti,ui,bn){Ft(this.ptr,Ti.ptr,ui,bn)}GetTrianglesUInt32Array(Ti,ui,bn){ri(this.ptr,Ti.ptr,ui,bn)}GetAttributeDataArrayForAllPoints(Ti,ui,bn,Vi,Ui){$t(this.ptr,Ti.ptr,ui.ptr,bn,Vi,Ui)}},DT_INT8:Yt(),DT_UINT8:Et(),DT_INT16:kt(),DT_UINT16:pi(),DT_UINT32:mi(),DT_FLOAT32:qi()}})}(fetch(cb())),ry.then(W=>{Ep=W,ry=void 0}))}()),V&&L.push(function(){if($x)return;let W=function(H){let ee,le=WebAssembly.instantiateStreaming(H,{}).then(we=>{ee=we.instance,ee.exports.__wasm_call_ctors()}),de={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},Ce={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:le,supported:!0,decodeGltfBuffer(we,ie,me,Ie,ze,Je){(function(st,ut,xt,Ft,ri,$t,Qt){let hi=st.exports.sbrk,Rt=Ft+3&-4,Yt=hi(Rt*ri),Et=hi($t.length),kt=new Uint8Array(st.exports.memory.buffer);kt.set($t,Et);let pi=ut(Yt,Ft,ri,Et,$t.length);if(pi===0&&Qt&&Qt(Yt,Rt,ri),xt.set(kt.subarray(Yt,Yt+Ft*ri)),hi(Yt-hi(0)),pi!==0)throw new Error(`Malformed buffer data: ${pi}`)})(ee,ee.exports[Ce[ze]],we,ie,me,Ie,ee.exports[de[Je]])}}}(fetch(hb()));return W.ready.then(()=>{$x=W})}()),m)for(let W=0;W<m.length;W++)L.push(bT(m[W],l,W,n));return(L.length?Promise.all(L):Promise.resolve()).then(()=>{if(F&&_)for(let{primitives:W}of _)for(let H of W)yT(H,l);if(V&&_&&I)for(let W of I)xT(W,l);return l})})}function e_(o,e){let n=o.json.bufferViews[e.bufferView],l=C0[e.componentType];return new l(o.buffers[n.buffer],(e.byteOffset||0)+(n.byteOffset||0),e.count*(n.byteStride&&n.byteStride!==oy[e.type]*l.BYTES_PER_ELEMENT?n.byteStride/l.BYTES_PER_ELEMENT:oy[e.type]))}function Hx(o,e,n,l){let c=C0[e.componentType],m=function(L){switch(L){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(c),_=o.json.bufferViews[e.bufferView],b=_.byteStride?_.byteStride/c.BYTES_PER_ELEMENT:oy[e.type],I=n.float32,E=I.length/n.capacity;for(let L=0,F=0;L<e.count*b;L+=b,F+=E)for(let V=0;V<E;V++)I[F+V]=l[L+V]*m;n._trim()}function wT(o,e,n){let l=o.indices,c=o.attributes,m={};m.indexArray=new zo;let _=e.json.accessors[l],b=_.count/3;m.indexArray.reserve(b);let I=e_(e,_);for(let V=0;V<b;V++)m.indexArray.emplaceBack(I[3*V],I[3*V+1],I[3*V+2]);m.indexArray._trim(),m.vertexArray=new So;let E=e.json.accessors[c.POSITION];m.vertexArray.reserve(E.count);let L=e_(e,E);for(let V=0;V<E.count;V++)m.vertexArray.emplaceBack(L[3*V],L[3*V+1],L[3*V+2]);if(m.vertexArray._trim(),m.aabb=new Jr(E.min,E.max),m.centroid=function(V,W){let H=[0,0,0],ee=V.length;if(ee>0){for(let le=0;le<ee;le++){let de=3*V[le];H[0]+=W[de],H[1]+=W[de+1],H[2]+=W[de+2]}H[0]/=ee,H[1]/=ee,H[2]/=ee}return H}(I,L),c.COLOR_0!==void 0){let V=e.json.accessors[c.COLOR_0],W=oy[V.type],H=e_(e,V);m.colorArray=W===3?new So:new jl,m.colorArray.resize(V.count),Hx(e,V,m.colorArray,H)}if(c.NORMAL!==void 0){m.normalArray=new So;let V=e.json.accessors[c.NORMAL];m.normalArray.resize(V.count);let W=e_(e,V);Hx(e,V,m.normalArray,W)}if(c.TEXCOORD_0!==void 0&&n.length>0){m.texcoordArray=new od;let V=e.json.accessors[c.TEXCOORD_0];m.texcoordArray.resize(V.count);let W=e_(e,V);Hx(e,V,m.texcoordArray,W)}if(c._FEATURE_ID_RGBA4444!==void 0){let V=e.json.accessors[c._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(m.featureData=e_(e,V))}c._FEATURE_RGBA4444!==void 0&&(m.featureData=new Uint32Array(e_(e,e.json.accessors[c._FEATURE_RGBA4444]).buffer));let F=o.material;return m.material=function(V,W){let{emissiveFactor:H=[0,0,0],alphaMode:ee="OPAQUE",alphaCutoff:le=.5,normalTexture:de,occlusionTexture:Ce,emissiveTexture:we,doubleSided:ie}=V,{baseColorFactor:me=[1,1,1,1],metallicFactor:Ie=1,roughnessFactor:ze=1,baseColorTexture:Je,metallicRoughnessTexture:st}=V.pbrMetallicRoughness||{},ut=Ce?W[Ce.index]:void 0;if(Ce&&Ce.extensions&&Ce.extensions.KHR_texture_transform&&ut){let xt=Ce.extensions.KHR_texture_transform;ut.offsetScale=[xt.offset[0],xt.offset[1],xt.scale[0],xt.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new sr(...me),metallicFactor:Ie,roughnessFactor:ze,baseColorTexture:Je?W[Je.index]:void 0,metallicRoughnessTexture:st?W[st.index]:void 0},doubleSided:ie,emissiveFactor:H,alphaMode:ee,alphaCutoff:le,normalTexture:de?W[de.index]:void 0,occlusionTexture:ut,emissionTexture:we?W[we.index]:void 0,defined:V.defined===void 0}}(F!==void 0?e.json.materials[F]:{defined:!1},n),m}function gb(o,e,n){let{matrix:l,rotation:c,translation:m,scale:_,mesh:b,extras:I,children:E}=o,L={};if(L.matrix=l||function(F,V,W,H){var ee=V[0],le=V[1],de=V[2],Ce=V[3],we=ee+ee,ie=le+le,me=de+de,Ie=ee*we,ze=ee*ie,Je=ee*me,st=le*ie,ut=le*me,xt=de*me,Ft=Ce*we,ri=Ce*ie,$t=Ce*me,Qt=H[0],hi=H[1],Rt=H[2];return F[0]=(1-(st+xt))*Qt,F[1]=(ze+$t)*Qt,F[2]=(Je-ri)*Qt,F[3]=0,F[4]=(ze-$t)*hi,F[5]=(1-(Ie+xt))*hi,F[6]=(ut+Ft)*hi,F[7]=0,F[8]=(Je+ri)*Rt,F[9]=(ut-Ft)*Rt,F[10]=(1-(Ie+st))*Rt,F[11]=0,F[12]=W[0],F[13]=W[1],F[14]=W[2],F[15]=1,F}([],c||[0,0,0,1],m||[0,0,0],_||[1,1,1]),b!==void 0){L.meshes=n[b];let F=L.anchor=[0,0];for(let V of L.meshes){let{min:W,max:H}=V.aabb;F[0]+=W[0]+H[0],F[1]+=W[1]+H[1]}F[0]=Math.floor(F[0]/L.meshes.length/2),F[1]=Math.floor(F[1]/L.meshes.length/2)}if(I&&(I.id&&(L.id=I.id),I.lights&&(L.lights=function(F){if(!F.length)return[];let V=function(de){let Ce=atob(de),we=new Uint8Array(Ce.length);for(let ie=0;ie<Ce.length;ie++)we[ie]=Ce.codePointAt(ie);return we}(F),W=[],H=V.length/24,ee=new Uint16Array(V.buffer),le=new Float32Array(V.buffer);for(let de=0;de<H;de++){let Ce=ee[2*de*6]/30,we=ee[2*de*6+1]/30,ie=ee[2*de*6+10]/100,me=le[6*de+1],Ie=le[6*de+2],ze=le[6*de+3],Je=le[6*de+4],st=ze-me,ut=Je-Ie,xt=Math.hypot(st,ut);W.push({pos:[me+.5*st,Ie+.5*ut,we],normal:[ut/xt,-st/xt,0],width:xt,height:Ce,depth:ie,points:[me,Ie,ze,Je]})}return W}(I.lights))),E){let F=[];for(let V of E)F.push(gb(e.json.nodes[V],e,n));L.children=F}return L}function TT(o){if(o.vertices.length===0||o.indices.length===0)return null;let e=new Hm(o.vertices,o.indices,8,256),[n,l]=[e.min.clone(),e.max.clone()];return{vertices:o.vertices,indices:o.indices,grid:e,min:n,max:l}}function ST(o){if(!o.extras||!o.extras.ground)return null;let e=o.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;let n=e[0];if(!n||!Array.isArray(n)||n.length===0)return null;let l=[];for(let _ of n){if(!Array.isArray(_)||_.length!==2)continue;let b=_[0],I=_[1];typeof b=="number"&&typeof I=="number"&&l.push(new Ue(b,I))}if(l.length<3)return null;l.length>1&&l[l.length-1].equals(l[0])&&l.pop();let c=0;for(let _=0;_<l.length;_++){let b=l[_],I=l[(_+1)%l.length],E=l[(_+2)%l.length];c+=(b.x-I.x)*(E.y-I.y)-(E.x-I.x)*(b.y-I.y)}c>0&&l.reverse();let m=Ef(l.flatMap(_=>[_.x,_.y]),[]);return m.length===0?null:{vertices:l,indices:m}}function IT(o,e){let n=[],l=[],c=0,m=[];for(let _ of o){c=n.length;let b=_.vertexArray.float32,I=_.indexArray.uint16;for(let E=0;E<_.vertexArray.length;E++)m[0]=b[3*E+0],m[1]=b[3*E+1],m[2]=b[3*E+2],gr(m,m,e),n.push(new Ue(m[0],m[1]));for(let E=0;E<3*_.indexArray.length;E++)l.push(I[E]+c)}if(l.length%3!=0)return null;for(let _=0;_<l.length;_+=3){let b=n[l[_+0]],I=n[l[_+1]],E=n[l[_+2]];(b.x-I.x)*(E.y-I.y)-(E.x-I.x)*(b.y-I.y)>0&&([l[_+1],l[_+2]]=[l[_+2],l[_+1]])}return{vertices:n,indices:l}}function yb(o){let e=function(I,E){let L=[],F=WebGL2RenderingContext;if(I.json.textures)for(let V of I.json.textures){let W={magFilter:F.LINEAR,minFilter:F.NEAREST,wrapS:F.REPEAT,wrapT:F.REPEAT};V.sampler!==void 0&&Object.assign(W,I.json.samplers[V.sampler]),L.push({image:E[V.source],sampler:W,uploaded:!1})}return L}(o,o.images),n=function(I,E){let L=[];for(let F of I.json.meshes){let V=[];for(let W of F.primitives)V.push(wT(W,I,E));L.push(V)}return L}(o,e),{scenes:l,scene:c,nodes:m}=o.json,_=l?l[c||0].nodes:m,b=[];for(let I of _)b.push(gb(m[I],o,n));return function(I,E,L){let F={},V=new Set;for(let W=0;W<I.length;W++){let H=L[E[W]];if(!H.extras)continue;let ee=H.extras["mapbox:footprint:version"],le=H.extras["mapbox:footprint:id"];(ee||le)&&V.add(W),ee==="1.0.0"&&le&&(F[le]=W)}for(let W=0;W<I.length;W++){if(V.has(W))continue;let H=I[W],ee=L[E[W]];if(!ee.extras)continue;let le=null;H.id in F&&(le=IT(I[F[H.id]].meshes,H.matrix)),le||(le=ST(ee)),le&&(H.footprint=TT(le))}if(V.size>0){let W=Array.from(V.values()).sort((H,ee)=>H-ee);for(let H=W.length-1;H>=0;H--)I.splice(W[H],1)}}(b,_,o.json.nodes),b}function CT(o){o.heightmap=new Float32Array(4096),o.heightmap.fill(-1);let e=o.vertexArray.float32,n=o.aabb.min[0]-1,l=o.aabb.min[1]-1,c=Jm/(o.aabb.max[0]-n+2),m=Jm/(o.aabb.max[1]-l+2);for(let _=0;_<e.length;_+=3){let b=e[_+2],I=(e[_+0]-n)*c|0,E=(e[_+1]-l)*m|0;b>o.heightmap[E*Jm+I]&&(o.heightmap[E*Jm+I]=b)}}function ET(o,e){let n={};n.indexArray=new zo,n.indexArray.reserve(4*o.length),n.vertexArray=new So,n.vertexArray.reserve(10*o.length),n.colorArray=new jl,n.vertexArray.reserve(10*o.length);let l=0;for(let _ of o){let b=Math.min(10,Math.max(4,1.3*_.height))*e,I=[-_.normal[1],_.normal[0],0],E=Math.min(.29,.1*_.width/_.depth),L=_.width-2*_.depth*e*(E+.01),F=as([],_.pos,I,L/2),V=as([],_.pos,I,-L/2),W=[F[0],F[1],F[2]+_.height],H=[V[0],V[1],V[2]+_.height],ee=as([],_.normal,I,E);Mr(ee,ee,b);let le=as([],_.normal,I,-E);Mr(le,le,b),ho(ee,F,ee),ho(le,V,le),F[2]+=.1,V[2]+=.1,n.vertexArray.emplaceBack(ee[0],ee[1],ee[2]),n.vertexArray.emplaceBack(le[0],le[1],le[2]),n.vertexArray.emplaceBack(F[0],F[1],F[2]),n.vertexArray.emplaceBack(V[0],V[1],V[2]),n.vertexArray.emplaceBack(W[0],W[1],W[2]),n.vertexArray.emplaceBack(H[0],H[1],H[2]),n.vertexArray.emplaceBack(F[0],F[1],F[2]),n.vertexArray.emplaceBack(V[0],V[1],V[2]),n.vertexArray.emplaceBack(ee[0],ee[1],ee[2]),n.vertexArray.emplaceBack(le[0],le[1],le[2]);let de=L/b/2;n.colorArray.emplaceBack(-de-E,-1,de,.8),n.colorArray.emplaceBack(de+E,-1,de,.8),n.colorArray.emplaceBack(-de,0,de,1.3),n.colorArray.emplaceBack(de,0,de,1.3),n.colorArray.emplaceBack(de+E,-.8,de,.7),n.colorArray.emplaceBack(de+E,-.8,de,.7),n.colorArray.emplaceBack(0,0,de,1.3),n.colorArray.emplaceBack(0,0,de,1.3),n.colorArray.emplaceBack(de+E,-1.2,de,.8),n.colorArray.emplaceBack(de+E,-1.2,de,.8),n.indexArray.emplaceBack(6+l,4+l,8+l),n.indexArray.emplaceBack(7+l,9+l,5+l),n.indexArray.emplaceBack(0+l,1+l,2+l),n.indexArray.emplaceBack(1+l,3+l,2+l),l+=10}let c={defined:!0,emissiveFactor:[0,0,0]},m={};return m.baseColorFactor=sr.white,c.pbrMetallicRoughness=m,n.material=c,n.aabb=new Jr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),n}class xb{constructor(e){this._stringToNumber={},this._numberToString=[];for(let n=0;n<e.length;n++){let l=e[n];this._stringToNumber[l]=n,this._numberToString[n]=l}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}let MT=["id","tile","layer","source","sourceLayer","state"];class U_{constructor(e,n,l,c,m){this.type="Feature",this._vectorTileFeature=e,this._z=n,this._x=l,this._y=c,this.properties=e.properties,this.id=m}clone(){let e=new U_(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){let e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(let n of MT)this[n]!==void 0&&(e[n]=this[n]);return e}}class vb{constructor(e,n){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new gh(xi,16,0),this.featureIndexArray=new yf,this.promoteId=n,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,n,l,c,m,_=0,b=0){let I=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(l,c,m,_);let E=this.grid;for(let L=0;L<n.length;L++){let F=n[L],V=[1/0,1/0,-1/0,-1/0];for(let W=0;W<F.length;W++){let H=F[W];V[0]=Math.min(V[0],H.x),V[1]=Math.min(V[1],H.y),V[2]=Math.max(V[2],H.x),V[3]=Math.max(V[3],H.y)}b!==0&&(V[0]-=b,V[1]-=b,V[2]+=b,V[3]+=b),V[0]<xi&&V[1]<xi&&V[2]>=0&&V[3]>=0&&E.insert(I,V[0],V[1],V[2],V[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new bp.VectorTile(new Wy(this.rawTileData)).layers,this.sourceLayerCoder=new xb(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(let e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,n){let{tilespaceGeometry:l,transform:c,tileTransform:m,pixelPosMatrix:_,availableImages:b}=n;this.loadVTLayers(),this.serializedLayersCache.clear();let I=l.bufferedTilespaceBounds,E=this.grid.query(I.min.x,I.min.y,I.max.x,I.max.y,(W,H,ee,le)=>xs(l.bufferedTilespaceGeometry,W,H,ee,le));E.sort(PT);let L=null;c.elevation&&E.length>0&&(L=k_.create(c.elevation,this.tileID));let F={},V;for(let W=0;W<E.length;W++){let H=E[W];if(H===V)continue;V=H;let ee=this.featureIndexArray.get(H),le=null;this.is3DTile?this.loadMatchingModelFeature(F,ee,e,l,c):this.loadMatchingFeature(F,ee,e,b,(de,Ce,we,ie=0)=>(le||(le=ki(de,this.tileID.canonical,m)),Ce.queryIntersectsFeature(l,de,we,le,this.z,c,_,L,ie)))}return F}loadMatchingFeature(e,n,l,c,m){let{featureIndex:_,bucketIndex:b,sourceLayerIndex:I,layoutVertexArrayOffset:E}=n,L=this.bucketLayerIDs[b],F=l.layers,V=Object.keys(F);if(V.length&&!function(de,Ce){for(let we=0;we<de.length;we++)if(Ce.indexOf(de[we])>=0)return!0;return!1}(V,L))return;let W=l.sourceCache,H=this.sourceLayerCoder.decode(I),ee=this.vtLayers[H].feature(_),le=this.getId(ee,H);for(let de=0;de<L.length;de++){let Ce=L[de];if(!F[Ce])continue;let{styleLayer:we,targets:ie}=F[Ce],me={};le!==void 0&&(me=W.getFeatureState(we.sourceLayer,le));let Ie=!m||m(ee,we,me,E);if(!Ie)continue;let ze=new U_(ee,this.z,this.x,this.y,le);ze.tile=this.tileID.canonical,ze.state=me;let Je=this.serializedLayersCache.get(Ce);Je||(Je=we.serialize(),Je.id=Ce,this.serializedLayersCache.set(Ce,Je)),ze.source=Je.source,ze.sourceLayer=Je["source-layer"],ze.layer=wt({},Je),ze.layer.paint=bb(Je.paint,we.paint,ee,me,c),ze.layer.layout=bb(Je.layout,we.layout,ee,me,c);let st=!1;for(let ut of ie){this.updateFeatureProperties(ze,ut);let{filter:xt}=ut;if(xt){if(ee.properties=ze.properties,xt.needGeometry){let Ft=ji(ee,!0);if(!xt.filter(new J(this.tileID.overscaledZ),Ft,this.tileID.canonical))continue}else if(!xt.filter(new J(this.tileID.overscaledZ),ee))continue}st=!0,ut.targetId&&this.addFeatureVariant(ze,ut)}st&&this.appendToResult(e,Ce,_,ze,Ie)}}loadMatchingModelFeature(e,n,l,c,m){let _=this.bucketLayerIDs[0][0],b=l.layers;if(!b[_])return;let{styleLayer:I,targets:E}=b[_];if(I.type!=="model")return;let L=c.tile,F=n.featureIndex,V=L.getBucket(I);if(!(V&&V instanceof m0))return;let W=function(Je,st,ut,xt){let Ft=Je.getNodesInfo()[st];if(Ft.hiddenByReplacement||!Ft.node.meshes)return;let ri=Number.MAX_VALUE,$t=Ft.node,Qt=ut.tile,hi=xt.calculatePosMatrix(Qt.tileID.toUnwrapped(),xt.worldSize),Rt=Ft.evaluatedScale,Yt=0;xt.elevation&&$t.elevation&&(Yt=$t.elevation*xt.elevation.exaggeration()),vr(hi,hi,[($t.anchor?$t.anchor[0]:0)*(Rt[0]-1),($t.anchor?$t.anchor[1]:0)*(Rt[1]-1),Yt]),Bo(hi,hi,Rt);let Et=ut.queryGeometry,kt=Et.isPointQuery()?Et.screenBounds:Et.screenGeometry,pi=function(qi){let Bi=gn([],hi,qi.matrix);gn(Bi,xt.expandedFarZProjMatrix,Bi);for(let Ti=0;Ti<qi.meshes.length;++Ti){let ui=qi.meshes[Ti];if(Ti===qi.lightMeshIndex)continue;let bn=v1(kt,xt,Bi,ui.aabb);bn!=null&&(ri=Math.min(bn,ri))}if(qi.children)for(let Ti of qi.children)pi(Ti)};if(pi($t),ri===Number.MAX_VALUE)return;let mi=new ae(0,0);return D1(Qt.tileID.canonical,mi,Ft.node.anchor[0],Ft.node.anchor[1]),{intersectionZ:ri,position:mi,feature:Ft.feature}}(V,F,c,m);if(!W)return;let{z:H,x:ee,y:le}=L.tileID.canonical,{feature:de,intersectionZ:Ce,position:we}=W,ie={};de.id!==void 0&&(ie=l.sourceCache.getFeatureState(I.sourceLayer,de.id));let me=new U_({},H,ee,le,de.id);me.tile=this.tileID.canonical,me.state=ie,me.properties=de.properties,me.geometry={type:"Point",coordinates:[we.lng,we.lat]};let Ie=this.serializedLayersCache.get(_);Ie||(Ie=I.serialize(),Ie.id=_,this.serializedLayersCache.set(_,Ie)),me.source=Ie.source,me.sourceLayer=Ie["source-layer"],me.layer=wt({},Ie);let ze=!1;for(let Je of E){this.updateFeatureProperties(me,Je);let{filter:st}=Je;if(st){if(de.properties=me.properties,st.needGeometry){if(!st.filter(new J(this.tileID.overscaledZ),de,this.tileID.canonical))continue}else if(!st.filter(new J(this.tileID.overscaledZ),de))continue}ze=!0,Je.targetId&&this.addFeatureVariant(me,Je)}ze&&this.appendToResult(e,_,F,me,Ce)}updateFeatureProperties(e,n,l){if(n.properties){let c={};for(let m in n.properties){let _=n.properties[m].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,l);_!=null&&(c[m]=_)}e.properties=c}}addFeatureVariant(e,n,l){let c={target:n.target,namespace:n.namespace,uniqueFeatureID:n.uniqueFeatureID};n.properties&&(c.properties=e.properties),e.variants=e.variants||{},e.variants[n.targetId]=e.variants[n.targetId]||[],e.variants[n.targetId].push(c)}appendToResult(e,n,l,c,m){let _=e[n];_===void 0&&(_=e[n]=[]),_.push({featureIndex:l,feature:c,intersectionZ:m})}lookupSymbolFeatures(e,n,l,c,m){let _={};this.loadVTLayers();for(let b of e)this.loadMatchingFeature(_,{bucketIndex:n,sourceLayerIndex:l,featureIndex:b,layoutVertexArrayOffset:0},c,m);return _}loadFeature(e){let{featureIndex:n,sourceLayerIndex:l}=e;this.loadVTLayers();let c=this.sourceLayerCoder.decode(l),m=this.vtFeatures[c];if(m[n])return m[n];let _=this.vtLayers[c].feature(n);return m[n]=_,_}hasLayer(e){for(let n of this.bucketLayerIDs)for(let l of n)if(e===l)return!0;return!1}getId(e,n){let l=e.id;if(this.promoteId){let c=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[n];if(c!=null)if(Array.isArray(c)){if(!this.promoteIdExpression){let m=mh(c);if(m.result!=="success"){let _=m.value.map(b=>`${b.key}: ${b.message}`).join(", ");return void Hi(`Failed to create expression for promoteId: ${_}`)}this.promoteIdExpression=m.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new Bu),l=this.promoteIdExpression.evaluate({zoom:0},e)}else l=e.properties[c];typeof l=="boolean"&&(l=Number(l))}return l}}function bb(o,e,n,l,c){return Ni(o,(m,_)=>{let b=e instanceof et?e.get(_):null;return b&&b.evaluate?b.evaluate(n,l,void 0,c):b})}function PT(o,e){return e-o}Ei(vb,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});let wb=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Xx{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");let[n,l]=new Uint8Array(e,0,2);if(n!==219)throw new Error("Data does not appear to be in a KDBush format.");let c=l>>4;if(c!==1)throw new Error(`Got v${c} data when expected v1.`);let m=wb[15&l];if(!m)throw new Error("Unrecognized array type.");let[_]=new Uint16Array(e,2,1),[b]=new Uint32Array(e,4,1);return new Xx(b,_,m,e)}constructor(e,n=64,l=Float64Array,c){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+n,2),65535),this.ArrayType=l,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;let m=wb.indexOf(this.ArrayType),_=2*e*this.ArrayType.BYTES_PER_ELEMENT,b=e*this.IndexArrayType.BYTES_PER_ELEMENT,I=(8-b%8)%8;if(m<0)throw new Error(`Unexpected typed array class: ${l}.`);c&&c instanceof ArrayBuffer?(this.data=c,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+b+I,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+_+b+I),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+b+I,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+m]),new Uint16Array(this.data,2,1)[0]=n,new Uint32Array(this.data,4,1)[0]=e)}add(e,n){let l=this._pos>>1;return this.ids[l]=l,this.coords[this._pos++]=e,this.coords[this._pos++]=n,l}finish(){let e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return Kx(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,n,l,c){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:m,coords:_,nodeSize:b}=this,I=[0,m.length-1,0],E=[];for(;I.length;){let L=I.pop()||0,F=I.pop()||0,V=I.pop()||0;if(F-V<=b){for(let le=V;le<=F;le++){let de=_[2*le],Ce=_[2*le+1];de>=e&&de<=l&&Ce>=n&&Ce<=c&&E.push(m[le])}continue}let W=V+F>>1,H=_[2*W],ee=_[2*W+1];H>=e&&H<=l&&ee>=n&&ee<=c&&E.push(m[W]),(L===0?e<=H:n<=ee)&&(I.push(V),I.push(W-1),I.push(1-L)),(L===0?l>=H:c>=ee)&&(I.push(W+1),I.push(F),I.push(1-L))}return E}within(e,n,l){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:c,coords:m,nodeSize:_}=this,b=[0,c.length-1,0],I=[],E=l*l;for(;b.length;){let L=b.pop()||0,F=b.pop()||0,V=b.pop()||0;if(F-V<=_){for(let le=V;le<=F;le++)Sb(m[2*le],m[2*le+1],e,n)<=E&&I.push(c[le]);continue}let W=V+F>>1,H=m[2*W],ee=m[2*W+1];Sb(H,ee,e,n)<=E&&I.push(c[W]),(L===0?e-l<=H:n-l<=ee)&&(b.push(V),b.push(W-1),b.push(1-L)),(L===0?e+l>=H:n+l>=ee)&&(b.push(W+1),b.push(F),b.push(1-L))}return I}}function Kx(o,e,n,l,c,m){if(c-l<=n)return;let _=l+c>>1;Tb(o,e,_,l,c,m),Kx(o,e,n,l,_-1,1-m),Kx(o,e,n,_+1,c,1-m)}function Tb(o,e,n,l,c,m){for(;c>l;){if(c-l>600){let E=c-l+1,L=n-l+1,F=Math.log(E),V=.5*Math.exp(2*F/3),W=.5*Math.sqrt(F*V*(E-V)/E)*(L-E/2<0?-1:1);Tb(o,e,n,Math.max(l,Math.floor(n-L*V/E+W)),Math.min(c,Math.floor(n+(E-L)*V/E+W)),m)}let _=e[2*n+m],b=l,I=c;for(sy(o,e,l,n),e[2*c+m]>_&&sy(o,e,l,c);b<I;){for(sy(o,e,b,I),b++,I--;e[2*b+m]<_;)b++;for(;e[2*I+m]>_;)I--}e[2*l+m]===_?sy(o,e,l,I):(I++,sy(o,e,I,c)),I<=n&&(l=I+1),n<=I&&(c=I-1)}}function sy(o,e,n,l){Yx(o,n,l),Yx(e,2*n,2*l),Yx(e,2*n+1,2*l+1)}function Yx(o,e,n){let l=o[e];o[e]=o[n],o[n]=l}function Sb(o,e,n,l){let c=o-n,m=e-l;return c*c+m*m}t.$=Ys,t.A=Sa,t.B=Vs,t.C=Yr,t.D=O_,t.E=nc,t.F=2,t.G=Ug,t.H=Lv,t.I=hs,t.J=class extends p0{},t.K=ln,t.L=Dl,t.M=pt,t.N=$p,t.O=Hd,t.P=Ue,t.Q=pf,t.R=Lu,t.S=Gh,t.T=Cx,t.U=zt,t.V=p0,t.W=id,t.X=mh,t.Y=Zu,t.Z=qu,t._=hh,t.a=function(o){return ls.API_CDN_URL_REGEX.test(o)},t.a$=Ii,t.a0=Jc,t.a1=ei,t.a2=Qu,t.a3=Xd,t.a4=function(o){let e=o.value,n=[];if(!e)return n;let l=ln(e);return l!=="string"?(n=n.concat([new p0(o.key,e,`string expected, "${l}" found`)]),n):(Ax(e,!0)||(n=n.concat([new p0(o.key,e,`invalid url "${e}"`)])),n)},t.a5=xe,t.a6=ue,t.a7=dt,t.a8=Se,t.a9=class{constructor(o){this.specification=o}possiblyEvaluate(o,e){return Un(o.expression.evaluate(e))}interpolate(o,e,n){return{x:en(o.x,e.x,n),y:en(o.y,e.y,n),z:en(o.z,e.z,n),azimuthal:en(o.azimuthal,e.azimuthal,n),polar:en(o.polar,e.polar,n)}}},t.aA=Vo,t.aB=Or,t.aC=qt,t.aD=rt,t.aE=v,t.aF=function(o,e){let n={};for(let l=0;l<e.length;l++){let c=e[l];c in o&&(n[c]=o[c])}return n},t.aG=be,t.aH=Ve,t.aI=class{constructor(o){this.entries={},this.scheduler=o}request(o,e,n,l){let c=this.entries[o]=this.entries[o]||{callbacks:[]};if(c.result){let[m,_]=c.result;return this.scheduler?this.scheduler.add(()=>{l(m,_)},e):l(m,_),()=>{}}return c.callbacks.push(l),c.cancel||(c.cancel=n((m,_)=>{c.result=[m,_];for(let b of c.callbacks)this.scheduler?this.scheduler.add(()=>{b(m,_)},e):b(m,_);setTimeout(()=>delete this.entries[o],3e3)})),()=>{c.result||(c.callbacks=c.callbacks.filter(m=>m!==l),c.callbacks.length||(c.cancel(),delete this.entries[o]))}}},t.aJ=function(o,e,n){let l=JSON.stringify(o.request);return o.data&&(this.deduped.entries[l]={result:[null,o.data]}),this.deduped.request(l,{type:"parseTile",isSymbolTile:o.isSymbolTile,zoom:o.tileZoom},c=>{let m=gs(o.request,(_,b,I,E)=>{_?c(_):b&&c(null,{vectorTile:n?void 0:new bp.VectorTile(new Wy(b)),rawData:b,cacheControl:I,expires:E})});return()=>{m.cancel(),c()}},e)},t.aK=function(o){tc++,tc>al&&(o.getActor().send("enforceCacheSizeLimit",xc),tc=0)},t.aL=function(o){return o<=1?1:Math.pow(2,Math.floor(Math.log(o)/Math.LN2))},t.aM=Xo,t.aN=c1,t.aO=m1,t.aP=l1,t.aQ=function(o,e){let n=document.createElement("video");n.muted=!0,n.onloadstart=function(){e(null,n)};for(let l=0;l<o.length;l++){let c=document.createElement("source");cs(o[l])||(n.crossOrigin="Anonymous"),c.src=o[l],n.appendChild(c)}return{cancel:()=>{}}},t.aR=l0,t.aS=function(o){return fetch(o).then(e=>e.arrayBuffer()).then(e=>_b(e,0,o))},t.aT=yb,t.aU=class{constructor(o,e,n,l){this.id=o,this.position=e!=null?new ae(e[0],e[1]):new ae(0,0),this.orientation=n??[0,0,0],this.nodes=l,this.uploaded=!1,this.aabb=new Jr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(o,e){if(gn(o.matrix,e,o.matrix),o.meshes)for(let n of o.meshes){let l=Jr.applyTransformFast(n.aabb,o.matrix);this.aabb.encapsulate(l)}if(o.children)for(let n of o.children)this._applyTransformations(n,o.matrix)}computeBoundsAndApplyParent(){let o=on([]);for(let e of this.nodes)this._applyTransformations(e,o)}computeModelMatrix(o,e,n,l,c,m,_=!1){C1(this.matrix,this,o.transform,this.position,e,n,l,c,m,_)}upload(o){if(!this.uploaded){for(let e of this.nodes)Rx(e,o);for(let e of this.nodes)f0(e);this.uploaded=!0}}destroy(){for(let o of this.nodes)zx(o)}},t.aV=Di,t.aW=Zg,t.aX=Ke,t.aY=Qe,t.aZ=uc,t.a_=zo,t.aa=J,t.ab=bu,t.ac=Ct,t.ad=gr,t.ae=No,t.af=ct,t.ag=et,t.ah=mp,t.ai=en,t.aj=xi,t.ak=au,t.al=te,t.am=sr,t.an=class{constructor(o){this.specification=o}possiblyEvaluate(o,e){return function([n,l]){let c=Un([1,n,l]);return{x:c.x,y:c.y,z:c.z}}(o.expression.evaluate(e))}interpolate(o,e,n){return{x:en(o.x,e.x,n),y:en(o.y,e.y,n),z:en(o.z,e.z,n)}}},t.ao=function(o,e,n=0,l=!0){let c=new Ue(n,n),m=o.sub(c),_=e.add(c),b=[m,new Ue(_.x,m.y),_,new Ue(m.x,_.y)];return l&&b.push(m.clone()),b},t.ap=function(o,e){let n=[];for(let l=0;l<o.length;l++){let c=nt(l-1,-1,o.length-1),m=nt(l+1,-1,o.length-1),_=o[l],b=o[m],I=o[c].sub(_).unit(),E=b.sub(_).unit(),L=E.angleWithSep(I.x,I.y),F=I.add(E).unit().mult(-1*e/Math.sin(L/2));n.push(_.add(F))}return n},t.aq=Hv,t.ar=xs,t.as=function(o,e,n=0){return Ur(((e.x-n)*o.scale-o.x)*xi,(e.y*o.scale-o.y)*xi,It(e.z,e.y))},t.at=hr,t.au=Lr,t.av=Th,t.aw=jy,t.ax=function(o){let e=1/0,n=1/0,l=-1/0,c=-1/0;for(let m of o)e=Math.min(e,m.x),n=Math.min(n,m.y),l=Math.max(l,m.x),c=Math.max(c,m.y);return{min:new Ue(e,n),max:new Ue(l,c)}},t.ay=Ne,t.az=gn,t.b=function(o){return ls.API_FONTS_REGEX.test(o)},t.b$=Mr,t.b0=Wf,t.b1=s0,t.b2=function(){q.isLoading()||q.isLoaded()||k()!=="deferred"||j()},t.b3=Kt,t.b4=ji,t.b5=U_,t.b6=go,t.b7=Og,t.b8=I_,t.b9=ki,t.bA=function(o,e){let{x:n,y:l}=o.point,c=cg(n,l,o.worldSize/o._pixelsPerMercatorPixel,0,0);return gn(c,c,Jf(Kh(e)))},t.bB=Cn,t.bC=function(o){return o[0]=0,o[1]=0,o[2]=0,o},t.bD=function(o,e){return Math.hypot(e[0]-o[0],e[1]-o[1],e[2]-o[2])},t.bE=jr,t.bF=as,t.bG=Co,t.bH=Vg,t.bI=Ih,t.bJ=dx,t.bK=function(o,e,n,l,c){let m=5*e+2;o.float32[m+0]=n,o.float32[m+1]=l,o.float32[m+2]=c},t.bL=o0,t.bM=wp,t.bN=nn,t.bO=ja,t.bP=G,t.bQ=b1,t.bR=lt,t.bS=Mt,t.bT=_x,t.bU=Uv,t.bV=ux,t.bW=Xx,t.bX=nt,t.bY=Wa,t.bZ=function(o,e,n){n*=.5;var l=e[0],c=e[1],m=e[2],_=e[3],b=Math.sin(n),I=Math.cos(n);return o[0]=l*I+c*b,o[1]=c*I-l*b,o[2]=m*I+_*b,o[3]=_*I-m*b,o},t.b_=pl,t.ba=la,t.bb=sp,t.bc=Hh,t.bd=bo,t.be=Ef,t.bf=Tx,t.bg=function(o,e){let n=mp(e.zoom);if(n===0)return Kh(o);let l=Vm(o),c=Um(l),m=Ne(l.getWest())*e.worldSize,_=Ne(l.getEast())*e.worldSize,b=Ve(l.getNorth())*e.worldSize,I=Ve(l.getSouth())*e.worldSize,E=[m,b,0],L=[_,b,0],F=[m,I,0],V=[_,I,0],W=vn([],e.globeMatrix);return gr(E,E,W),gr(L,L,W),gr(F,F,W),gr(V,V,W),c[0]=fp(c[0],F,n),c[1]=fp(c[1],V,n),c[2]=fp(c[2],L,n),c[3]=fp(c[3],E,n),Jr.fromPoints(c)},t.bh=If,t.bi=vn,t.bj=Yf,t.bk=fp,t.bl=qh,t.bm=fc,t.bn=os,t.bo=vr,t.bp=I0,t.bq=Wy,t.br=gs,t.bs=function(o,e){let n=[];for(let l in o)l in e||n.push(l);return n},t.bt=Ot,t.bu=["type","source","source-layer","minzoom","maxzoom","filter","layout"],t.bv=Qi,t.bw=function(o){var e=new yi(16);return e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=o[3],e[4]=o[4],e[5]=o[5],e[6]=o[6],e[7]=o[7],e[8]=o[8],e[9]=o[9],e[10]=o[10],e[11]=o[11],e[12]=o[12],e[13]=o[13],e[14]=o[14],e[15]=o[15],e},t.bx=on,t.by=Br,t.bz=Wi,t.c=Eh,t.c$=function(o){return o({pluginStatus:r,pluginURL:h}),A.on("pluginStateChange",o),o},t.c0=ra,t.c1=Qo,t.c2=function(o,e){return o[0]=-e[0],o[1]=-e[1],o[2]=-e[2],o[3]=e[3],o},t.c3=Aa,t.c4=function(o,e,n,l,c){var m,_=1/Math.tan(e/2);return o[0]=_/n,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=_,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=-1,o[12]=0,o[13]=0,o[15]=0,c!=null&&c!==1/0?(o[10]=(c+l)*(m=1/(l-c)),o[14]=2*c*l*m):(o[10]=-1,o[14]=-2*l),o},t.c5=function(o,e,n,l,c,m,_){var b=1/(e-n),I=1/(l-c),E=1/(m-_);return o[0]=-2*b,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*I,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*E,o[11]=0,o[12]=(e+n)*b,o[13]=(c+l)*I,o[14]=(_+m)*E,o[15]=1,o},t.c6=Oe,t.c7=function(o,e,n){o[4*e+0]=n[0],o[4*e+1]=n[1],o[4*e+2]=n[2],o[4*e+3]=n[3]},t.c8=Yp,t.c9=bh,t.cA=u0,t.cB=Ql,t.cC=_1,t.cD=function(o){let e=_1(o,!0);return Cn([],[e[0],e[1],e[4],e[5]])},t.cE=Bo,t.cF=up,t.cG=qo,t.cH=function(o){let{x:e,y:n}=o.point,{lng:l,lat:c}=o._center;return cg(e,n,o.worldSize,l,c)},t.cI=ya,t.cJ=fe,t.cK=ha,t.cL=S,t.cM=function(o,e,n){let l=0;for(let c=0;c<2;++c)o[c]>0&&(l+=(o[c]-0)*(o[c]-0)),e[c]<0&&(l+=(0-e[c])*(0-e[c]));return l},t.cN=45,t.cO=Qc,t.cP=Ge,t.cQ=vf,t.cR=function(o,e,n){let l=Math.sqrt(o*o+e*e+n*n),c=l>0?Math.acos(n/l)*ht:0,m=o!==0||e!==0?Math.atan2(-e,-o)*ht+90:0;return m<0&&(m+=360),[l,m,c]},t.cS=Ur,t.cT=vt,t.cU=ho,t.cV=Jr,t.cW=Un,t.cX=function(o){return[Math.pow(o[0],1/2.2),Math.pow(o[1],1/2.2),Math.pow(o[2],1/2.2)]},t.cY=ss,t.cZ=Ax,t.c_=function(o,e){return o.readFields(C2,{icons:[]},e)},t.ca=xf,t.cb=is,t.cc=Xf,t.cd=ae,t.ce=Qv,t.cf=function(){var o=new yi(4);return yi!=Float32Array&&(o[1]=0,o[2]=0),o[0]=1,o[3]=1,o},t.cg=function(o,e,n){var l=e[0],c=e[1],m=e[2],_=e[3],b=Math.sin(n),I=Math.cos(n);return o[0]=l*I+m*b,o[1]=c*I+_*b,o[2]=l*-b+m*I,o[3]=c*-b+_*I,o},t.ch=function(o,e){return o[0]===e[0]&&o[1]===e[1]&&o[2]===e[2]&&o[3]===e[3]},t.ci=va,t.cj=function(o){return Math.hypot(o[0],o[1],o[2],o[3])},t.ck=sl,t.cl=Os,t.cm=ea,t.cn=pp,t.co=g1,t.cp=Gr,t.cq=_y,t.cr=function(o,e,n,l,c,m,_,b,I){if(I.name==="globe")return _y(o,e,new Gr(n,l,c),!1);let E=Zg({z:n,x:l,y:c},I);return new Jr([(m+E.x/E.scale)*e,e*(E.y/E.scale),_],[(m+E.x2/E.scale)*e,e*(E.y2/E.scale),b])},t.cs=function(o,e,n){return o[0]=Math.min(e[0],n[0]),o[1]=Math.min(e[1],n[1]),o[2]=Math.min(e[2],n[2]),o[3]=Math.min(e[3],n[3]),o},t.ct=function(o,e,n){return o[0]=Math.max(e[0],n[0]),o[1]=Math.max(e[1],n[1]),o[2]=Math.max(e[2],n[2]),o[3]=Math.max(e[3],n[3]),o},t.cu=function(o){let e=Math.round((o+45+360)%360/90)%4;return Ae[e]},t.cv=gt,t.cw=Jo,t.cx=C,t.cy=function(o){let e=on(new Float64Array(16));gn(e,o.pixelMatrix,o.globeMatrix);let n=[0,$,0],l=[0,Z,0];return gr(n,n,e),gr(l,l,e),[n[0]>0&&n[0]<=o.width&&n[1]>0&&n[1]<=o.height&&!p_(o,new ae(o.center.lat,90)),l[0]>0&&l[0]<=o.width&&l[1]>0&&l[1]<=o.height&&!p_(o,new ae(o.center.lat,-90))]},t.cz=function(o,e){let{scale:n}=o.tileTransform,l=n*xi/(o.tileSize*Math.pow(2,e.zoom-o.tileID.overscaledZ+o.tileID.canonical.z));return function(c,m,_){var b=m[1],I=m[2],E=m[3],L=_[0],F=_[1];return c[0]=m[0]*L,c[1]=b*L,c[2]=I*F,c[3]=E*F,c}(new Float32Array(4),e.inverseAdjustmentMatrix,[l,l])},t.d=function(o){return ls.API_TILEJSON_REGEX.test(o)},t.d$=Zf,t.d0=g0,t.d1=D_,t.d2=fx,t.d3=wn,t.d4=x,t.d5=Ra,t.d6=za,t.d7=An,t.d8=function(o){let e=o.indexOf(vo);return e>=0?o.slice(0,e):o},t.d9=function(o){return o.indexOf(vo)>=0},t.dA=gy,t.dB=Es,t.dC=oa,t.dD=256,t.dE=function(o,e){let n=[0,0,0];return gr(n,n,If(Kh(e.canonical))),gr(n,n,o),n},t.dF=o=>({u_camera_to_center_distance:new is(o),u_extrude_scale:new zc(o),u_device_pixel_ratio:new is(o),u_matrix:new Yp(o),u_inv_rot_matrix:new Yp(o),u_merc_center:new bh(o),u_tile_id:new xf(o),u_zoom_transition:new is(o),u_up_dir:new xf(o),u_emissive_strength:new is(o)}),t.dG=o=>({u_matrix:new Yp(o),u_pixels_to_tile_units:new zc(o),u_device_pixel_ratio:new is(o),u_width_scale:new is(o),u_floor_width_scale:new is(o),u_units_to_pixels:new bh(o),u_dash_image:new Xf(o),u_gradient_image:new Xf(o),u_image_height:new is(o),u_texsize:new bh(o),u_tile_units_to_pixels:new is(o),u_alpha_discard_threshold:new is(o),u_trim_offset:new bh(o),u_trim_fade_range:new bh(o),u_trim_color:new vf(o),u_emissive_strength:new is(o),u_zbias_factor:new is(o),u_tile_to_meter:new is(o),u_ground_shadow_factor:new xf(o)}),t.dH=o=>({u_matrix:new Yp(o),u_texsize:new bh(o),u_pixels_to_tile_units:new zc(o),u_device_pixel_ratio:new is(o),u_width_scale:new is(o),u_floor_width_scale:new is(o),u_image:new Xf(o),u_units_to_pixels:new bh(o),u_tile_units_to_pixels:new is(o),u_alpha_discard_threshold:new is(o),u_trim_offset:new bh(o),u_trim_fade_range:new bh(o),u_trim_color:new vf(o),u_emissive_strength:new is(o),u_zbias_factor:new is(o),u_tile_to_meter:new is(o),u_ground_shadow_factor:new xf(o),u_pattern_transition:new is(o)}),t.dI=vl,t.dJ=Dw,t.dK=pg,t.dL=(o,e,n,l,c,m)=>{let _=o.transform,b=_.projection.name==="globe",I;if(m.paint.get("circle-pitch-alignment")==="map")if(b){let L=gy(_.zoom,e.canonical)*_._pixelsPerMercatorPixel;I=Float32Array.from([L,0,0,L])}else I=_.calculatePixelsToTileUnitsMatrix(n);else I=new Float32Array([_.pixelsToGLUnits[0],0,0,_.pixelsToGLUnits[1]]);let E={u_camera_to_center_distance:o.transform.getCameraToCenterDistance(_.projection),u_matrix:o.translatePosMatrix(e.projMatrix,n,m.paint.get("circle-translate"),m.paint.get("circle-translate-anchor")),u_device_pixel_ratio:Ml.devicePixelRatio,u_extrude_scale:I,u_inv_rot_matrix:X0,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:m.paint.get("circle-emissive-strength")};if(b){E.u_inv_rot_matrix=l,E.u_merc_center=c,E.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],E.u_zoom_transition=mp(_.zoom);let L=c[0]*xi,F=c[1]*xi;E.u_up_dir=_.projection.upVector(new Gr(0,0,0),L,F)}return E},t.dM=Qh,t.dN=Xa,t.dO=(o,e,n,l,c,m,_,b,I,E)=>{let L=o.transform,F=L.pitch<15?Gy(.07,.7,rt((14-L.zoom)/5,0,1)):.07,V=n.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:qy(o,e,n,l),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:L.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:c,u_width_scale:m,u_floor_width_scale:_,u_image:0,u_tile_units_to_pixels:Zy(e,L),u_units_to_pixels:[1/L.pixelsToGLUnits[0],1/L.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:b,u_trim_fade_range:n.paint.get("line-trim-fade-range"),u_trim_color:n.paint.get("line-trim-color").toRenderColor(V?null:n.lut).toArray01(),u_emissive_strength:n.paint.get("line-emissive-strength"),u_zbias_factor:F,u_tile_to_meter:vt(e.tileID.canonical,0),u_ground_shadow_factor:I,u_pattern_transition:E}},t.dP=(o,e,n,l,c,m,_,b,I,E)=>{let L=o.transform,F=L.calculatePixelsToTileUnitsMatrix(e),V=n.paint.get("line-trim-color-use-theme").constantOr("default")==="none",W=L.pitch<15?Gy(.07,.7,rt((14-L.zoom)/5,0,1)):.07;return{u_matrix:qy(o,e,n,l),u_pixels_to_tile_units:F,u_device_pixel_ratio:m,u_width_scale:_,u_floor_width_scale:b,u_units_to_pixels:[1/L.pixelsToGLUnits[0],1/L.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:c,u_texsize:Xm(n)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Zy(e,o.transform),u_alpha_discard_threshold:0,u_trim_offset:I,u_trim_fade_range:n.paint.get("line-trim-fade-range"),u_trim_color:n.paint.get("line-trim-color").toRenderColor(V?null:n.lut).toArray01(),u_emissive_strength:n.paint.get("line-emissive-strength"),u_zbias_factor:W,u_tile_to_meter:vt(e.tileID.canonical,0),u_ground_shadow_factor:E}},t.dQ=Bt,t.dR=Cf,t.dS=It,t.dT=Oc,t.dU=wh,t.dV=ql,t.dW=Fi,t.dX=450,t.dY=7,t.dZ=h2,t.d_=Kn,t.da=function(o){let e=o.lastIndexOf(vo);return e>=0?o.slice(e+1):""},t.db=function(o){let e=[],n=o.id;return n===void 0&&e.push({message:`layers.${n}: missing required property "id"`}),o.render===void 0&&e.push({message:`layers.${n}: missing required method "render"`}),o.renderingMode&&o.renderingMode!=="2d"&&o.renderingMode!=="3d"&&e.push({message:`layers.${n}: property "renderingMode" must be either "2d" or "3d"`}),e},t.dc=function(o,e,n,l){return o.type==="custom"?new u2(o,e):new w2[o.type](o,e,n,l)},t.dd=dn,t.de=function(o){let e=o.indexOf(vo);return e>=0?o.slice(e+1):""},t.df=class extends U_{constructor(o,e){super(o._vectorTileFeature,o._z,o._x,o._y,o.id),o.state&&(this.state=Object.assign({},o.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=o.source,this.sourceLayer=o.sourceLayer,this.layer=o.layer)}toJSON(){let o=super.toJSON();return o.target=this.target,o.namespace=this.namespace,o}},t.dg=A,t.dh=Ps,t.di=d_,t.dj=class extends Rc{constructor(o){super(o),this.current=Bm}set(o,e,n){if(this.fetchUniformLocation(o,e)){for(let l=0;l<9;l++)if(n[l]!==this.current[l]){this.current=n,this.gl.uniformMatrix3fv(this.location,!1,n);break}}}},t.dk=qe,t.dl=function(o,e,n){let l=mp(n.zoom),c=o.style.map._antialias,m=o.terrain&&o.terrain.exaggeration()>0;return l===0&&!c&&!m},t.dm=function(o){let e=o.pixelsPerMeter,n=e/Oe(1,o.center.lat),l=on(new Float64Array(16));return vr(l,l,[o.point.x,o.point.y,0]),Bo(l,l,[n,n,e]),Float32Array.from(l)},t.dn=Vm,t.dp=function(o){let e=gt-5;o=rt(o,-e,e)/e*90;let n=Math.pow(Math.abs(Math.sin(te(o))),3);return Math.round(n*(U.length-1))},t.dq=function(o,e,n,l){let c=e.getNorth(),m=e.getSouth(),_=e.getWest(),b=e.getEast(),I=1<<o.z,E=b-_,L=c-m,F=E/N,V=-L/U[n],W=[0,F,0,V,0,0,c,_,0];if(o.z>0){let H=180/l;Dt(W,W,[H/E+1,0,0,0,H/L+1,0,-.5*H/F,.5*H/V,1])}return W[2]=I,W[5]=o.x,W[8]=o.y,W},t.dr=Kh,t.ds=function(o,e,n){let l=on(new Float64Array(16)),c=(e/(1<<o)-.5)*Math.PI*2;return to(l,n.globeMatrix,c),Float32Array.from(l)},t.dt=class{isDataAvailableAtPoint(o){let e=this._source();if(this.isUsingMockSource()||!e||o.y<0||o.y>1)return!1;let n=e.getSource().maxzoom,l=1<<n,c=Math.floor(o.x),m=Math.floor((o.x-c)*l),_=Math.floor(o.y*l),b=this.findDEMTileFor(new Xo(n,c,n,m,_));return!(!b||!b.dem)}getAtPointOrZero(o,e=0){return this.getAtPoint(o,e)||0}getAtPoint(o,e,n=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);let l=this._source();if(!l||o.y<0||o.y>1)return e;let c=l.getSource().maxzoom,m=1<<c,_=Math.floor(o.x),b=o.x-_,I=new Xo(c,_,c,Math.floor(b*m),Math.floor(o.y*m)),E=this.findDEMTileFor(I);if(!E||!E.dem)return e;let L=E.dem,F=1<<E.tileID.canonical.z,V=(b*F-E.tileID.canonical.x)*L.dim,W=(o.y*F-E.tileID.canonical.y)*L.dim,H=Math.floor(V),ee=Math.floor(W);return(n?this.exaggeration():1)*en(en(L.get(H,ee),L.get(H,ee+1),W-ee),en(L.get(H+1,ee),L.get(H+1,ee+1),W-ee),V-H)}getAtTileOffset(o,e,n){let l=1<<o.canonical.z;return this.getAtPointOrZero(new Ct(o.wrap+(o.canonical.x+e/xi)/l,(o.canonical.y+n/xi)/l))}getAtTileOffsetFunc(o,e,n,l){return c=>{let m=this.getAtTileOffset(o,c.x,c.y),_=l.upVector(o.canonical,c.x,c.y);return Mr(_,_,m*l.upVectorScale(o.canonical,e,n).metersToTile),_}}getForTilePoints(o,e,n,l){if(this.isUsingMockSource())return!1;let c=k_.create(this,o,l);return!!c&&(e.forEach(m=>{m[2]=this.exaggeration()*c.getElevationAt(m[0],m[1],n)}),!0)}getMinMaxForTile(o){if(this.isUsingMockSource())return null;let e=this.findDEMTileFor(o);if(!e||!e.dem)return null;let n=e.dem.tree,l=e.tileID,c=1<<o.canonical.z-l.canonical.z,m=o.canonical.x/c-l.canonical.x,_=o.canonical.y/c-l.canonical.y,b=0;for(let I=0;I<o.canonical.z-l.canonical.z&&!n.leaves[b];I++){m*=2,_*=2;let E=2*Math.floor(_)+Math.floor(m);b=n.childOffsets[b]+E,m%=1,_%=1}return{min:this.exaggeration()*n.minimums[b],max:this.exaggeration()*n.maximums[b]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(o,e,n){throw new Error("Pure virtual method called.")}pointCoordinate(o){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(o){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){let o=this.visibleDemTiles;if(o.length===0)return null;let e=!1,n=Number.MAX_VALUE,l=Number.MIN_VALUE;for(let c of o){let m=this.getMinMaxForTile(c.tileID);m&&(n=Math.min(n,m.min),l=Math.max(l,m.max),e=!0)}return e?{min:n,max:l}:null}},t.du=wy,t.dv=vs,t.dw=function(o,e){return[Math.pow(o[0],2.2)*e,Math.pow(o[1],2.2)*e,Math.pow(o[2],2.2)*e]},t.dx=_r,t.dy=function(o,e){var n=Math.sin(e),l=Math.cos(e);return o[0]=l,o[1]=n,o[2]=0,o[3]=-n,o[4]=l,o[5]=0,o[6]=0,o[7]=0,o[8]=1,o},t.dz=yc,t.e=ls,t.e$=xb,t.e0=256,t.e1=Jf,t.e2=So,t.e3=to,t.e4=function(o,e){return o[0]=e[0],o[1]=e[1],o[2]=e[2],o[3]=e[4],o[4]=e[5],o[5]=e[6],o[6]=e[8],o[7]=e[9],o[8]=e[10],o},t.e5=Gl,t.e6=Wp,t.e7=function(o,e,n,l,c){return rt((o-e)/(n-e)*(c-l)+l,l,c)},t.e8=fl,t.e9=function(o,e){var n=e[0],l=e[1],c=e[2],m=e[3],_=e[4],b=e[5],I=e[6],E=e[7],L=e[8],F=L*_-b*E,V=-L*m+b*I,W=E*m-_*I,H=n*F+l*V+c*W;return H?(o[0]=F*(H=1/H),o[1]=(-L*l+c*E)*H,o[2]=(b*l-c*_)*H,o[3]=V*H,o[4]=(L*n-c*I)*H,o[5]=(-b*n+c*m)*H,o[6]=W*H,o[7]=(-E*n+l*I)*H,o[8]=(_*n-l*m)*H,o):null},t.eA=function(o,e,n){return o[0]=e[0]/n[0],o[1]=e[1]/n[1],o[2]=e[2]/n[2],o},t.eB=Cl,t.eC=se,t.eD=Da,t.eE=function(o,e,n,l){return o[0]=e,o[1]=n,o[2]=l,o},t.eF=function([o,e,n]){let l=Math.hypot(o,e,n),c=Math.atan2(o,n),m=.5*Math.PI-Math.acos(-e/l);return new ae(fe(c),fe(m))},t.eG=Fs,t.eH=Mx,t.eI=function(o){let e=o.navigator?o.navigator.userAgent:null;return!!function(n){if(yo==null){let l=n.navigator?n.navigator.userAgent:null;yo=!!n.safari||!(!l||!(/\b(iPad|iPhone|iPod)\b/.test(l)||l.match("Safari")&&!l.match("Chrome")))}return yo}(o)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},t.eJ=function(o,e){xc=o,al=e},t.eK=p_,t.eL=yy,t.eM=function(o){let e=[0,0,0],n=on(new Float64Array(16));return gn(n,o.pixelMatrix,o.globeMatrix),gr(e,e,n),new Ue(e[0],e[1])},t.eN=function(o,e,n=!1){if(r===tp||r===rd||r===ip)throw new Error("setRTLTextPlugin cannot be called multiple times.");h=Ml.resolveURL(o),r=tp,M=e,w(),n||j()},t.eO=k,t.eP=function(){g0().acquire(kx)},t.eQ=function(){let o=Jg;o&&(o.isPreloaded()&&o.numActive()===1?(o.release(kx),Jg=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},t.eR=_0,t.eS=function(o){let e=ec();if(!e)return;let n=e.delete(_l);o&&n.then(()=>o()).catch(o)},t.eT=Yg,t.eU=cb,t.eV=function(o){qx=Ml.resolveURL(o),V_||(V_=new O_(g0(),new nc)),V_.broadcast("setDracoUrl",qx)},t.eW=hb,t.eX=function(o){N_=Ml.resolveURL(o),V_||(V_=new O_(g0(),new nc)),V_.broadcast("setMeshoptUrl",N_)},t.eY=Ei,t.eZ=Eu,t.e_=Sp,t.ea=hc,t.eb=xa,t.ec=Ut,t.ed=class{constructor(o,e,n,l){this.context=o,this.format=l,this.size=n,this.texture=o.gl.createTexture();let[c,m,_]=this.size,{gl:b}=o;b.bindTexture(b.TEXTURE_3D,this.texture),o.pixelStoreUnpackFlipY.set(!1),o.pixelStoreUnpack.set(1),o.pixelStoreUnpackPremultiplyAlpha.set(!1),b.texImage3D(b.TEXTURE_3D,0,this.format,c,m,_,0,Sx(this.format),Ix(this.format),e.data)}bind(o,e){let{context:n}=this,{gl:l}=n;l.bindTexture(l.TEXTURE_3D,this.texture),o!==this.minFilter&&(l.texParameteri(l.TEXTURE_3D,l.TEXTURE_MAG_FILTER,o),l.texParameteri(l.TEXTURE_3D,l.TEXTURE_MIN_FILTER,o),this.minFilter=o),e!==this.wrapS&&(l.texParameteri(l.TEXTURE_3D,l.TEXTURE_WRAP_S,e),l.texParameteri(l.TEXTURE_3D,l.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){let{gl:o}=this.context;o.deleteTexture(this.texture),this.texture=null}},t.ee=function(o,e){if(o===e){var n=e[1],l=e[2],c=e[3],m=e[6],_=e[7],b=e[11];o[1]=e[4],o[2]=e[8],o[3]=e[12],o[4]=n,o[6]=e[9],o[7]=e[13],o[8]=l,o[9]=m,o[11]=e[14],o[12]=c,o[13]=_,o[14]=b}else o[0]=e[0],o[1]=e[4],o[2]=e[8],o[3]=e[12],o[4]=e[1],o[5]=e[5],o[6]=e[9],o[7]=e[13],o[8]=e[2],o[9]=e[6],o[10]=e[10],o[11]=e[14],o[12]=e[3],o[13]=e[7],o[14]=e[11],o[15]=e[15];return o},t.ef=Px,t.eg=Io,t.eh=[1,1,1],t.ei=function(o,e,n,l){var c=new yi(4);return c[0]=o,c[1]=e,c[2]=n,c[3]=l,c},t.ej=Cs,t.ek=function(o,e,n,l){var c=e[0],m=e[1],_=e[2],b=e[3];return o[0]=c+l*(n[0]-c),o[1]=m+l*(n[1]-m),o[2]=_+l*(n[2]-_),o[3]=b+l*(n[3]-b),o},t.el=k_,t.em=L_,t.en=xl,t.eo=od,t.ep=function(o,e,n,l,c,m,_,b,I,E,L,F,V,W,H,ee){var le=new yi(16);return le[0]=o,le[1]=e,le[2]=n,le[3]=l,le[4]=c,le[5]=m,le[6]=_,le[7]=b,le[8]=I,le[9]=E,le[10]=L,le[11]=F,le[12]=V,le[13]=W,le[14]=H,le[15]=ee,le},t.eq=re,t.er=$h,t.es=Cu,t.et=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Ue(1/0,1/0),max:new Ue(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(o,e=!1){let n=ve(new Ue(0,0),new Ue(xi,xi),o),l=[];if(e&&!ce(n,this._globalClipBounds))return l;for(let c of this._activeRegions){if(c.hiddenByOverlap||!ce(n,c))continue;let m=Te(c.min,c.max,o);l.push({min:m.min,max:m.max,sourceId:this._sourceIds[c.priority],footprint:c.footprint,footprintTileId:c.tileId,order:c.order,clipMask:c.clipMask,clipScope:c.clipScope})}return l}setSources(o){this._setSources(o.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{let n=[];for(let l of e.cache.getVisibleCoordinates()){let c=e.cache.getTile(l).buckets[e.layer];c&&c.updateFootprints(l.toUnwrapped(),n)}return n},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(o){let e=o.getFootprints();if(e.length===0)return;let n=o.getOrder(),l=o.getClipMask(),c=o.getClipScope();for(let m of e){if(!m.footprint)continue;let _=ve(m.footprint.min,m.footprint.max,m.id);this._activeRegions.push({min:_.min,max:_.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:m.id,footprint:m.footprint,order:n,clipMask:l,clipScope:c})}this._sourceIds.push(o.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,n)=>e.priority-n.priority||K(e.min,n.min)||K(e.max,n.max)||e.order-n.order||e.clipMask-n.clipMask||function(l,c){let m=(_,b)=>_+b;return l.length-c.length||l.reduce(m,"").localeCompare(c.reduce(m,""))}(e.clipScope,n.clipScope));let o=this._activeRegions.length!==this._prevRegions.length;if(!o){let e=0;for(;!o&&e!==this._activeRegions.length;){let n=this._activeRegions[e],l=this._prevRegions[e];o=n.priority!==l.priority||!Q(n,l)||n.order!==l.order||n.clipMask!==l.clipMask||!Qi(n.clipScope,l.clipScope),++e}}if(o){++this._updateTime;for(let n of this._activeRegions)n.order!==B&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,n.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,n.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,n.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,n.max.y));let e=n=>{let l=this._activeRegions;if(n>=l.length)return n;let c=l[n].priority;for(;n<l.length&&l[n].priority===c;)++n;return n};if(this._sourceIds.length>1){let n=0,l=e(n);for(;n!==l;){let c=n,m=n;for(;c!==l;){let _=this._activeRegions[c];_.hiddenByOverlap=!1;for(let b=0;b<m;b++){let I=this._activeRegions[b];if(!I.hiddenByOverlap&&_.order===B&&ce(_,I)&&(_.hiddenByOverlap=Ye(_.footprint,_.tileId,I.footprint,I.tileId),_.hiddenByOverlap))break}++c}n=l,l=e(n)}}}}_setSources(o){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=o.length-1;e>=0;e--)this._addSource(o[e]);this._computeReplacement()}},t.eu=class{constructor(o){this._createGrid(o),this._createPoles(o)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(let o of this._poleSegments)o.destroy();for(let o of this._gridSegments)o.withSkirts.destroy(),o.withoutSkirts.destroy()}_fillGridMeshWithLods(o,e){let n=new la,l=new zo,c=[],m=o+1+2,_=e[0]+1,b=e[0]+1+(1+e.length),I=(E,L,F)=>{let V=E===m-1?E-2:E===0?E:E-1;return V+=F?24575:0,[V,L]};for(let E=0;E<m;++E)n.emplaceBack(...I(E,0,!0));for(let E=0;E<_;++E)for(let L=0;L<m;++L)n.emplaceBack(...I(L,E,(L===0||L===m-1)&&!0));for(let E=0;E<e.length;++E){let L=e[E];for(let F=0;F<m;++F)n.emplaceBack(...I(F,L,!0))}for(let E=0;E<e.length;++E){let L=l.length,F=e[E]+1+2,V=new zo;for(let ee=0;ee<F-1;ee++){let le=ee===F-2,de=le?m*(b-e.length+E-ee):m;for(let Ce=0;Ce<m-1;Ce++){let we=ee*m+Ce;ee===0||le||Ce===0||Ce===m-2?(V.emplaceBack(we+1,we,we+de),V.emplaceBack(we+de,we+de+1,we+1)):(l.emplaceBack(we+1,we,we+de),l.emplaceBack(we+de,we+de+1,we+1))}}let W=bo.simpleSegment(0,L,n.length,l.length-L);for(let ee=0;ee<V.uint16.length;ee+=3)l.emplaceBack(V.uint16[ee],V.uint16[ee+1],V.uint16[ee+2]);let H=bo.simpleSegment(0,L,n.length,l.length-L);c.push({withoutSkirts:W,withSkirts:H})}return{vertices:n,indices:l,segments:c}}_createGrid(o){let e=this._fillGridMeshWithLods(N,U);this._gridSegments=e.segments,this._gridBuffer=o.createVertexBuffer(e.vertices,Hh.members),this._gridIndexBuffer=o.createIndexBuffer(e.indices,!0)}_createPoles(o){let e=new zo;for(let _=0;_<=N;_++)e.emplaceBack(0,_+1,_+2);this._poleIndexBuffer=o.createIndexBuffer(e,!0);let n=new Gl,l=new Gl,c=new Gl,m=new Gl;this._poleSegments=[];for(let _=0,b=0;_<S;_++){let I=360/(1<<_);n.emplaceBack(0,-v,0,.5,0),l.emplaceBack(0,-v,0,.5,1),c.emplaceBack(0,-v,0,.5,.5),m.emplaceBack(0,-v,0,.5,.5);for(let E=0;E<=N;E++){let L=E/N,F=0,V=en(0,I,L),[W,H,ee]=X(ug,dg,V,v);n.emplaceBack(W,H,ee,L,F),l.emplaceBack(W,H,ee,L,1-F);let le=te(V);L=.5+.5*Math.sin(le),F=.5+.5*Math.cos(le),c.emplaceBack(W,H,ee,L,F),m.emplaceBack(W,H,ee,L,1-F)}this._poleSegments.push(bo.simpleSegment(b,0,66,64)),b+=66}this._poleNorthVertexBuffer=o.createVertexBuffer(n,Zl,!1),this._poleSouthVertexBuffer=o.createVertexBuffer(l,Zl,!1),this._texturedPoleNorthVertexBuffer=o.createVertexBuffer(c,Zl,!1),this._texturedPoleSouthVertexBuffer=o.createVertexBuffer(m,Zl,!1)}getGridBuffers(o,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[o].withSkirts:this._gridSegments[o].withoutSkirts]}getPoleBuffers(o,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[o]]}},t.ev=B,t.ew=je,t.ex=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},t.ey=We,t.ez=fi,t.f=function(o){return o.indexOf("mapbox:")===0},t.f0=vb,t.f1=M_,t.f2=fd,t.f3="hd_road_elevation",t.f4=Na,t.f5=Ni,t.f6=ef,t.f7=px,t.f8=Ym,t.f9=function(o,e,n,l,c,m,_,b=1,I,E){o.createArrays(),o.tilePixelRatio=xi/(512*o.overscaling),o.compareText={},o.iconsNeedLinear=!1;let L=o.layers[0].layout,F=o.layers[0]._unevaluatedLayout._values,V={};V.scaleFactor=b,V.textSizeScaleRange=L.get("text-size-scale-range"),V.iconSizeScaleRange=L.get("icon-size-scale-range");let[W,H]=V.textSizeScaleRange,[ee,le]=V.iconSizeScaleRange;V.textScaleFactor=rt(V.scaleFactor,W,H),V.iconScaleFactor=rt(V.scaleFactor,ee,le);let de=F["text-size"],Ce=F["icon-size"];if(o.textSizeData.kind==="composite"){let{minZoom:Je,maxZoom:st}=o.textSizeData;V.compositeTextSizes=[de.possiblyEvaluate(new J(Je),m),de.possiblyEvaluate(new J(st),m)]}if(o.iconSizeData.kind==="composite"){let{minZoom:Je,maxZoom:st}=o.iconSizeData;V.compositeIconSizes=[Ce.possiblyEvaluate(new J(Je),m),Ce.possiblyEvaluate(new J(st),m)]}V.layoutTextSize=de.possiblyEvaluate(new J(_+1),m),V.layoutIconSize=Ce.possiblyEvaluate(new J(_+1),m),V.textMaxSize=de.possiblyEvaluate(new J(18),m);let we=L.get("symbol-placement"),ie=L.get("text-rotation-alignment")==="map"&&we!=="point",me=L.get("text-size"),Ie=!1,ze=[];for(let Je of o.features){let st=L.get("text-font").evaluate(Je,{},m).join(","),ut=me.evaluate(Je,{},m)*V.textScaleFactor,xt=V.layoutTextSize.evaluate(Je,{},m)*V.textScaleFactor,Ft=V.layoutIconSize.evaluate(Je,{},m)*V.iconScaleFactor,ri={horizontal:{},vertical:void 0},$t=Je.text,Qt,hi=[0,0];if($t){let Ui=$t.toString(),mn=L.get("text-letter-spacing").evaluate(Je,{},m)*ja,Pn=L.get("text-line-height").evaluate(Je,{},m)*ja,Rn=ys(Ui)?mn:0,Zn=L.get("text-anchor").evaluate(Je,{},m),kn=L.get("text-variable-anchor");if(!kn){let ke=L.get("text-radial-offset").evaluate(Je,{},m);if(ke)hi=Uv(Zn,[ke*ja,mx]);else{let Nt=L.get("text-offset").evaluate(Je,{},m);hi=[Nt[0]*ja,Nt[1]*ja]}}let zn=ie?"center":L.get("text-justify").evaluate(Je,{},m),$r=we==="point",ao=$r?L.get("text-max-width").evaluate(Je,{},m)*ja:1/0,Me=ke=>{o.allowVerticalPlacement&&Wo(Ui)&&(ri.vertical=hx($t,e,n,c,st,ao,Pn,Zn,ke,Rn,hi,Ih.vertical,!0,xt,ut,I))};if(!ie&&kn){let ke=zn==="auto"?kn.map(vi=>_x(vi)):[zn],Nt=!1;for(let vi=0;vi<ke.length;vi++){let Ci=ke[vi];if(!ri.horizontal[Ci])if(Nt)ri.horizontal[Ci]=ri.horizontal[0];else{let Si=hx($t,e,n,c,st,ao,Pn,"center",Ci,Rn,hi,Ih.horizontal,!1,xt,ut,I);Si&&(ri.horizontal[Ci]=Si,Nt=Si.positionedLines.length===1)}}Me("left")}else{if(zn==="auto"&&(zn=_x(Zn)),$r||L.get("text-writing-mode").indexOf("horizontal")>=0||!Wo(Ui)){let ke=hx($t,e,n,c,st,ao,Pn,Zn,zn,Rn,hi,Ih.horizontal,!1,xt,ut,I);ke&&(ri.horizontal[zn]=ke)}Me($r?"left":zn)}}let Rt,Yt,Et,kt,pi,mi,qi,Bi=!1;if(Je.icon&&Je.icon.hasPrimary()){let Ui=Gv(Je.icon,o.iconSizeData,F["icon-size"],m,o.zoom,Je,I,V.iconScaleFactor);Rt=Ui.iconPrimary,Et=Ui.iconSecondary;let mn=Rt.toString();if(Yt=l.get(mn),Yt&&(pi=L.get("icon-offset").evaluate(Je,{},m),mi=L.get("icon-anchor").evaluate(Je,{},m),qi=L.get("icon-text-fit").evaluate(Je,{},m),Qt=Uw(c.get(mn),Et?c.get(Et.toString()):void 0,pi,mi),Bi=Yt.sdf,o.sdfIcons===void 0?o.sdfIcons=Yt.sdf:o.sdfIcons!==Yt.sdf&&Hi("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Yt.pixelRatio!==o.pixelRatio||L.get("icon-rotate").constantOr(1)!==0)&&(o.iconsNeedLinear=!0)),Et){let Pn=Et.toString();kt=l.get(Pn)}}Ie=Ie||!(!Je.icon||!Je.icon.hasSecondary());let Ti=gx(ri.horizontal)||ri.vertical;o.iconsInText||(o.iconsInText=!!Ti&&Ti.iconsInText);let ui=xt*V.textScaleFactor/ja,{defaultShapedIcon:bn,verticallyShapedIcon:Vi}=Kw(o,Qt,L,Je,m,ri,ui,pi,qi);qi!=="none"&&Qt&&(Iv(Qt)||Cv(Qt))&&(Jy(0,Yt,Rt,Qt,bn,qi,E,l,c),Jy(0,kt,Et,Qt,bn,qi,E,l,c),Vi&&(Jy(0,Yt,Rt,Qt,Vi,qi,E,l,c),Jy(0,kt,Et,Qt,Vi,qi,E,l,c))),Qt=bn,ze.push({feature:Je,shapedTextOrientations:ri,shapedText:Ti,shapedIcon:Qt,iconPrimary:Rt,iconSecondary:Et,iconOffset:pi,iconAnchor:mi,verticallyShapedIcon:Vi,layoutTextSize:xt,layoutIconSize:Ft,textOffset:hi,isSDFIcon:Bi,iconTextFit:qi})}return{featureData:ze,sizes:V,hasAnySecondaryIcon:Ie,textAlongLine:ie,symbolPlacement:we}},t.fa=kv,t.fb=function(o,e,n,l,c,m,_,b,I,E){let{featureData:L,hasAnySecondaryIcon:F,sizes:V,textAlongLine:W,symbolPlacement:H}=e;for(let ee of L){let{shapedIcon:le,verticallyShapedIcon:de,feature:Ce,shapedTextOrientations:we,shapedText:ie,layoutTextSize:me,textOffset:Ie,isSDFIcon:ze,iconPrimary:Je,iconSecondary:st,iconTextFit:ut,iconOffset:xt}=ee;Zv(le,E.iconPositions,Je,st),Zv(de,E.iconPositions,Je,st),Xw(we,E.iconPositions),(ie||le)&&Yw(o,Ce,we,le,de,I,V,me,0,Ie,ze,l,c,_,b,F,ut,xt,W,H)}n&&o.generateCollisionDebugBuffers(m,o.collisionBoxArray,V.textScaleFactor)},t.fc=bp,t.fd=S0,t.fe=wi,t.ff=Eg,t.fg=_v,t.fh=Xt,t.fi=function(o){let e=0;if(new Uint32Array(o,0,1)[0]!==db){let n=new Uint32Array(o,0,7),[,,l,c,m,_]=n;e=n.byteLength+c+m+_+m,(l!==o.byteLength||e>=o.byteLength)&&Hi("Invalid b3dm header information.")}return _b(o,e)},t.fj=function(o,e){let n=yb(o);for(let l of n){for(let c of l.meshes)CT(c);l.lights&&(l.lightMeshIndex=l.meshes.length,l.meshes.push(ET(l.lights,e)))}return n},t.fk=m0,t.fl=Ar,t.fm=R1,t.fn=q,t.fo=function(o){Ta(),Ms?.then(e=>{e.keys().then(n=>{for(let l=0;l<n.length-o;l++)e.delete(n[l]).catch(c=>Hi(c.message))}).catch(n=>Hi(n.message))}).catch(e=>Hi(e.message))},t.g=function(o,e){return Ps(wt(o,{method:"GET"}),e)},t.h=wa,t.i=function(o){return ls.API_STYLE_REGEX.test(o)&&!Eh(o)},t.j=function(o){return decodeURIComponent(atob(o).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},t.k=function(o){return btoa(encodeURIComponent(o).replace(/%([0-9A-F]{2})/g,(e,n)=>String.fromCharCode(+("0x"+n))))},t.l=wt,t.m=Id,t.n=function(o,e){return Ps(wt(o,{type:"json"}),e)},t.o=or,t.p=function(o,e){return Ps(wt(o,{method:"POST"}),e)},t.q=Ml,t.r=ua,t.s=function(o){try{let e=self[o];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},t.t=af,t.u=function(){return function o(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,o)}()},t.v=function(o){return!!o&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(o)},t.w=Hi,t.x=function(){return Ox||(Ox=new _0),Ox},t.y=Ux,t.z=Pp}),Y(["./shared"],function(t){function at(ht){let te=ht?ht.url.toString():void 0;return te?performance.getEntriesByName(te):[]}function yi(ht){if(typeof ht=="number"||typeof ht=="boolean"||typeof ht=="string"||ht==null)return JSON.stringify(ht);if(Array.isArray(ht)){let fe="[";for(let Ae of ht)fe+=`${yi(Ae)},`;return`${fe}]`}let te="{";for(let fe of Object.keys(ht).sort())te+=`${fe}:${yi(ht[fe])},`;return`${te}}`}function Cn(ht){let te="";for(let fe of t.bu)(ht.type!=="model"||fe!=="minzoom"&&fe!=="maxzoom")&&(te+=`/${yi(ht[fe])}`);return te}class _r{constructor(te){this.keyCache={},this._layers={},this._layerConfigs={},te&&this.replace(te)}replace(te,fe){this._layerConfigs={},this._layers={},this.update(te,[],fe)}update(te,fe,Ae){this._options=Ae;for(let je of te)this._layerConfigs[je.id]=je,(this._layers[je.id]=t.dc(je,this.scope,null,this._options)).compileFilter(Ae),this.keyCache[je.id]&&delete this.keyCache[je.id];for(let je of fe)delete this.keyCache[je],delete this._layerConfigs[je],delete this._layers[je];this.familiesBySource={};let qe=function(je,We){let rt={};for(let nt=0;nt<je.length;nt++){let Ot=je[nt],wt=We&&We[Ot.id];wt||(Ot.type==="symbol"?wt=Ot.id:(wt=Cn(Ot),Ot.type==="line"&&Ot.paint&&function Ii(Bt){return typeof Bt=="string"&&Bt==="line-progress"||(Array.isArray(Bt)?Bt.some(Ii):!(!Bt||typeof Bt!="object")&&Object.values(Bt).some(Ii))}(Ot.paint["line-width"])&&(wt+=`/${yi(Ot.paint["line-width"])}`))),We&&(We[Ot.id]=wt);let _i=rt[wt];_i||(_i=rt[wt]=[]),_i.push(Ot)}let ct=[];for(let nt in rt)ct.push(rt[nt]);return ct}(Object.values(this._layerConfigs),this.keyCache);for(let je of qe){let We=je.map(_i=>this._layers[_i.id]),rt=We[0];if(rt.visibility==="none")continue;let ct=rt.source||"",nt=this.familiesBySource[ct];nt||(nt=this.familiesBySource[ct]={});let Ot=rt.sourceLayer||"_geojsonTileLayer",wt=nt[Ot];wt||(wt=nt[Ot]=[]),wt.push(We)}}}let an=1*t.e_;class Dt{constructor(te){let fe={},Ae=[];for(let rt in te){let ct=te[rt],nt=fe[rt]={};for(let Ot in ct.glyphs){let wt=ct.glyphs[+Ot];if(!wt||wt.bitmap.width===0||wt.bitmap.height===0)continue;let _i=wt.metrics.localGlyph?an:1,Ii={x:0,y:0,w:wt.bitmap.width+2*_i,h:wt.bitmap.height+2*_i};Ae.push(Ii),nt[Ot]=Ii}}let{w:qe,h:je}=t.H(Ae),We=new t.eZ({width:qe||1,height:je||1});for(let rt in te){let ct=te[rt];for(let nt in ct.glyphs){let Ot=ct.glyphs[+nt];if(!Ot||Ot.bitmap.width===0||Ot.bitmap.height===0)continue;let wt=fe[rt][nt],_i=Ot.metrics.localGlyph?an:1;t.eZ.copy(Ot.bitmap,We,{x:0,y:0},{x:wt.x+_i,y:wt.y+_i},Ot.bitmap)}}this.image=We,this.positions=fe}}t.eY(Dt,"GlyphAtlas");class Wi{constructor(te){this.tileID=new t.aM(te.tileID.overscaledZ,te.tileID.wrap,te.tileID.canonical.z,te.tileID.canonical.x,te.tileID.canonical.y),this.tileZoom=te.tileZoom,this.uid=te.uid,this.zoom=te.zoom,this.lut=te.lut,this.canonical=te.tileID.canonical,this.pixelRatio=te.pixelRatio,this.tileSize=te.tileSize,this.source=te.source,this.scope=te.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=te.showCollisionBoxes,this.collectResourceTiming=!!te.request&&te.request.collectResourceTiming,this.promoteId=te.promoteId,this.isSymbolTile=te.isSymbolTile,this.tileTransform=t.aW(te.tileID.canonical,te.projection),this.projection=te.projection,this.worldview=te.worldview,this.localizableLayerIds=te.localizableLayerIds,this.brightness=te.brightness,this.extraShadowCaster=!!te.extraShadowCaster,this.tessellationStep=te.tessellationStep,this.scaleFactor=te.scaleFactor}parse(te,fe,Ae,qe,je,We){this.status="parsing",this.data=te,this.collisionBoxArray=new t.b0;let rt=new t.e$(Object.keys(te.layers).sort()),ct=new t.f0(this.tileID,this.promoteId);ct.bucketLayerIDs=[];let nt={},Ot=new t.f1(256,256),wt={featureIndex:ct,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:Ot,availableImages:Ae,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},_i=fe.familiesBySource[this.source];for(let Jn in _i){let Un=te.layers[Jn];if(!Un)continue;let Ar=!1,go=!1,yo=!1;for(let oa of _i[Jn])oa[0].type==="symbol"?Ar=!0:go=!0,oa[0].is3D()&&oa[0].type!=="model"&&(yo=!0);if(this.extraShadowCaster&&!yo||this.isSymbolTile===!0&&!Ar||this.isSymbolTile===!1&&!go)continue;Un.version===1&&t.w(`Vector tile source "${this.source}" layer "${Jn}" does not use vector tile spec v2 and therefore may have some rendering errors.`);let Qo=rt.encode(Jn),To=[],xo=!1;for(let oa=0,Es=0;oa<Un.length;oa++){let _s=Un.feature(oa),ls=ct.getId(_s,Jn);if(this.localizableLayerIds&&this.localizableLayerIds.has(Jn)){let wa=_s.properties?_s.properties.worldview:null;if(this.worldview&&typeof wa=="string")if(wa==="all")_s.properties.$localized=!0;else{if(!wa.split(",").includes(this.worldview))continue;_s.properties.$localized=!0,_s.properties.worldview=this.worldview}}!xo&&_s.properties&&_s.properties.hasOwnProperty(t.f2)&&(xo=!0),To.push({feature:_s,id:ls,index:Es,sourceLayerIndex:Qo}),Es++}xo&&!wt.elevationFeatures&&te.layers.hasOwnProperty(t.f3)&&(wt.elevationFeatures=t.f4.parseFrom(te.layers[t.f3],this.canonical));for(let oa of _i[Jn]){let Es=oa[0];(!this.extraShadowCaster||Es.is3D()&&Es.type!=="model")&&(this.isSymbolTile!==void 0&&Es.type==="symbol"!==this.isSymbolTile||Es.minzoom&&this.zoom<Math.floor(Es.minzoom)||Es.maxzoom&&this.zoom>=Es.maxzoom||Es.visibility!=="none"&&(on(oa,this.zoom,wt.brightness,Ae),(nt[Es.id]=Es.createBucket({index:ct.bucketLayerIDs.length,layers:oa,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Qo,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:qe})).populate(To,wt,this.tileID.canonical,this.tileTransform),ct.bucketLayerIDs.push(oa.map(_s=>t.C(_s.id,_s.scope)))))}}let Ii,Bt,Di,Ni,dn,An;Ot.trim();let kr={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Hi=()=>{if(Ii)return this.status="done",We(Ii);if(this.extraShadowCaster)this.status="done",We(null,{buckets:Object.values(nt).filter(Jn=>!Jn.isEmpty()),featureIndex:ct,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:wt.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Bt&&Di&&Ni){let Jn=new Dt(Bt),Un=new Map;for(let[yo,Qo]of Di.entries()){let{imagePosition:To}=t.f7(yo,Qo,t.f8);Un.set(yo,To)}let Ar={};for(let yo in nt){let Qo=nt[yo];Qo instanceof t.b1&&(on(Qo.layers,this.zoom,wt.brightness,Ae),Ar[yo]=t.f9(Qo,Bt,Jn.positions,Di,Un,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,dn))}let go={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(je,Di,dn,()=>{go.iconsPending=!1,yr(Ar,Jn,go)}),this.rasterizeIfNeeded(je,Ni,An,()=>{go.patternsPending=!1,yr(Ar,Jn,go)})}},yr=(Jn,Un,Ar,go)=>{if(Ar.iconsPending||Ar.patternsPending)return;let yo=new t.fa(Di,Ni,this.lut);for(let Qo in nt){let To=nt[Qo];if(Qo in Jn)t.fb(To,Jn[Qo],this.showCollisionBoxes,Ae,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,Di,yo);else if(To.hasPattern&&(To instanceof t.b7||To instanceof t.b8||To instanceof t.dV)){on(To.layers,this.zoom,wt.brightness,Ae);let xo=Object.fromEntries(yo.patternPositions);To.addFeatures(wt,this.tileID.canonical,xo,Ae,this.tileTransform,this.brightness)}}this.status="done",We(null,{buckets:Object.values(nt).filter(Qo=>!Qo.isEmpty()),featureIndex:ct,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Un.image,lineAtlas:Ot,imageAtlas:yo,brightness:wt.brightness})};if(!this.extraShadowCaster){let Jn=t.f5(wt.glyphDependencies,go=>Object.keys(go).map(Number));Object.keys(Jn).length?je.send("getGlyphs",{uid:this.uid,stacks:Jn,scope:this.scope},(go,yo)=>{Ii||(Ii=go,Bt=yo,Hi())},void 0,!1,kr):Bt={};let Un=Array.from(wt.iconDependencies.keys()).map(go=>t.I.parse(go));Un.length?je.send("getImages",{images:Un,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(go,yo)=>{Ii||(Ii=go,Di=new Map,dn=this.updateImageMapAndGetImageTaskQueue(Di,yo,wt.iconDependencies),Hi())},void 0,!1,kr):(Di=new Map,dn=new Map);let Ar=Array.from(wt.patternDependencies.keys()).map(go=>t.I.parse(go));Ar.length?je.send("getImages",{images:Ar,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(go,yo)=>{Ii||(Ii=go,Ni=new Map,An=this.updateImageMapAndGetImageTaskQueue(Ni,yo,wt.patternDependencies),Hi())},void 0,!1,kr):(Ni=new Map,An=new Map)}if(wt.elevationFeatures&&wt.elevationFeatures.length>0){let Jn=[];for(let Ar of Object.values(nt))if(Ar instanceof t.b8){let go=Ar.getUnevaluatedPortalGraph();go&&Jn.push(go)}let Un=t.f6.evaluate(Jn);for(let Ar of Object.values(nt))Ar instanceof t.b8&&Ar.setEvaluatedPortalGraph(Un)}Hi()}rasterizeIfNeeded(te,fe,Ae,qe){Array.from(fe.values()).some(je=>je.usvg)?this.rasterize(te,fe,Ae,qe):qe()}updateImageMapAndGetImageTaskQueue(te,fe,Ae){let qe=new Map;for(let je of fe.keys()){let We=Ae.get(je)||[];for(let rt of We){let ct=rt.toString(),nt=fe.get(rt.id.toString());nt.usvg?qe.has(ct)||(qe.set(ct,rt),te.set(ct,Object.assign({},nt))):te.set(ct,nt)}}return qe}rasterize(te,fe,Ae,qe){this.rasterizeTask=te.send("rasterizeImages",{scope:this.scope,tasks:Ae},(je,We)=>{if(!je)for(let[rt,ct]of We.entries()){let nt=Object.assign(fe.get(rt),{data:ct});fe.set(rt,nt)}qe()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function on(ht,te,fe,Ae){let qe=new t.aa(te,{brightness:fe});for(let je of ht)je.recalculate(qe,Ae)}class vn extends t.E{constructor(te,fe,Ae,qe,je,We,rt){super(),this.actor=te,this.layerIndex=fe,this.availableImages=Ae,this.availableModels=qe,this.loadVectorData=We||t.aJ,this.loading={},this.loaded={},this.deduped=new t.aI(te.scheduler),this.isSpriteLoaded=je,this.scheduler=te.scheduler,this.brightness=rt}loadTile(te,fe){let Ae=te.uid,qe=te&&te.request,je=qe&&qe.collectResourceTiming,We=this.loading[Ae]=new Wi(te);We.abort=this.loadVectorData(te,(rt,ct)=>{let nt=!this.loading[Ae];if(delete this.loading[Ae],We.cancelRasterize(),nt||rt||!ct)return We.status="done",nt||(this.loaded[Ae]=We),fe(rt);let Ot=ct.rawData,wt={};ct.expires&&(wt.expires=ct.expires),ct.cacheControl&&(wt.cacheControl=ct.cacheControl),We.vectorTile=ct.vectorTile||new t.fc.VectorTile(new t.bq(Ot));let _i=()=>{We.parse(We.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(Ii,Bt)=>{if(Ii||!Bt)return fe(Ii);let Di={};if(je){let Ni=at(qe);Ni.length>0&&(Di.resourceTiming=JSON.parse(JSON.stringify(Ni)))}fe(null,t.l({rawTileData:Ot.slice(0)},Bt,wt,Di))})};this.isSpriteLoaded?_i():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(_i,{type:"parseTile",isSymbolTile:te.isSymbolTile,zoom:te.tileZoom}):_i()}),this.loaded=this.loaded||{},this.loaded[Ae]=We})}reloadTile(te,fe){let Ae=this.loaded,qe=te.uid;if(Ae&&Ae[qe]){let je=Ae[qe];je.scaleFactor=te.scaleFactor,je.showCollisionBoxes=te.showCollisionBoxes,je.projection=te.projection,je.brightness=te.brightness,je.tileTransform=t.aW(te.tileID.canonical,te.projection),je.extraShadowCaster=te.extraShadowCaster,je.lut=te.lut;let We=(rt,ct)=>{let nt=je.reloadCallback;nt&&(delete je.reloadCallback,je.parse(je.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,nt)),fe(rt,ct)};je.status==="parsing"?je.reloadCallback=We:je.status==="done"&&(je.vectorTile?je.parse(je.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,We):We())}else fe(null,void 0)}abortTile(te,fe){let Ae=te.uid,qe=this.loading[Ae];qe&&(qe.abort&&qe.abort(),delete this.loading[Ae]),fe()}removeTile(te,fe){let Ae=this.loaded,qe=te.uid;Ae&&Ae[qe]&&delete Ae[qe],fe()}}class gn{loadTile(te,fe){let{uid:Ae,encoding:qe,rawImageData:je,padding:We}=te,rt=ImageBitmap&&je instanceof ImageBitmap?this.getImageData(je,We):je;fe(null,new t.fd(Ae,rt,qe,We<1))}reloadTile(te,fe){fe(null,null)}abortTile(te,fe){fe()}removeTile(te,fe){fe()}getImageData(te,fe){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(te.width,te.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=te.width,this.offscreenCanvas.height=te.height,this.offscreenCanvasContext.drawImage(te,0,0,te.width,te.height);let Ae=this.offscreenCanvasContext.getImageData(-fe,-fe,te.width+2*fe,te.height+2*fe);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),Ae}}t.bp.setPbf(t.bq);class vr{constructor(te){this._mrt=new t.bp(te.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=te.uid,this.tileID=te.tileID,this.source=te.source}parse(te,fe){let Ae=this._mrt;this.status="parsing",this._entireBuffer=te;try{Ae.parseHeader(te),this._isHeaderLoaded=!0;let qe=[];for(let je in Ae.layers){let We=Ae.getLayer(je),rt=We.getDataRange(We.getBandList()),ct=Ae.createDecodingTask(rt),nt=te.slice(rt.firstByte,rt.lastByte+1),Ot=t.bp.performDecoding(nt,ct).then(wt=>ct.complete(null,wt)).catch(wt=>ct.complete(wt,null));qe.push(Ot)}Promise.allSettled(qe).then(()=>fe(null,Ae)).catch(je=>fe(je))}catch(qe){fe(qe)}}}class Bo{constructor(te){this.actor=te,this.loading={},this.loaded={}}loadTile(te,fe){let Ae=te.uid,qe=te.request,je=this.loading[Ae]=new vr(te),{cancel:We}=t.br(qe,(rt,ct,nt,Ot)=>{let wt=!this.loading[Ae];if(delete this.loading[Ae],wt||rt||!ct)return je.status="done",wt||(this.loaded[Ae]=je),fe(rt);je.parse(ct,(_i,Ii)=>{if(_i||!Ii)return fe(_i);fe(null,Ii,nt,Ot)}),this.loaded[Ae]=je});je.abort=We}reloadTile(te,fe){fe(null,void 0)}abortTile(te,fe){let Ae=te.uid,qe=this.loading[Ae];qe&&(qe.abort&&qe.abort(),delete this.loading[Ae]),fe()}removeTile(te,fe){let Ae=te.uid;this.loaded[Ae]&&delete this.loaded[Ae],fe()}decodeRasterArray(te,fe){t.bp.performDecoding(te.buffer,te.task).then(Ae=>fe(null,Ae)).catch(Ae=>fe(Ae))}}let qo=t.fc.VectorTileFeature.prototype.toGeoJSON;class to{constructor(te){this._feature=te,this.extent=t.aj,this.type=te.type,this.properties=te.tags,"id"in te&&!isNaN(te.id)&&(this.id=parseInt(te.id,10))}loadGeometry(){if(this._feature.type===1){let te=[];for(let fe of this._feature.geometry)te.push([new t.P(fe[0],fe[1])]);return te}{let te=[];for(let fe of this._feature.geometry){let Ae=[];for(let qe of fe)Ae.push(new t.P(qe[0],qe[1]));te.push(Ae)}return te}}toGeoJSON(te,fe,Ae){return qo.call(this,te,fe,Ae)}}class Br{constructor(te){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=t.aj,this.length=te.length,this._features=te}feature(te){return new to(this._features[te])}}let os=64/4096,ga=128;class Aa{constructor(){this.features=new Map}clear(){this.features.clear()}load(te=[],fe){for(let Ae of te){let qe=Ae.id;if(qe==null)continue;let je=this.features.get(qe);je&&this.updateCache(je,fe),Ae.geometry?(je=Io(Ae),this.updateCache(je,fe),this.features.set(qe,je)):this.features.delete(qe),this.updateCache(je,fe)}}updateCache(te,fe){for(let{canonical:Ae,uid:qe}of Object.values(fe)){let{z:je,x:We,y:rt}=Ae;Ql(te,Math.pow(2,je),We,rt)&&delete fe[qe]}}getTile(te,fe,Ae){let qe=Math.pow(2,te),je=[];for(let We of this.features.values())Ql(We,qe,fe,Ae)&&je.push(ho(We,qe,fe,Ae));return{features:je}}getFeatures(){return[...this.features.values()]}}function Ql({minX:ht,minY:te,maxX:fe,maxY:Ae},qe,je,We){return ht<(je+1+os)/qe&&te<(We+1+os)/qe&&fe>(je-os)/qe&&Ae>(We-os)/qe}function Io(ht){let{id:te,geometry:fe,properties:Ae}=ht;if(!fe)return;if(fe.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");let{type:qe,coordinates:je}=fe,We={id:te,type:1,geometry:[],tags:Ae,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},rt=We.geometry;if(qe==="Point")qa(je,rt,We);else if(qe==="MultiPoint")for(let ct of je)qa(ct,rt,We);else if(qe==="LineString")We.type=2,No(je,rt,We);else if(qe==="MultiLineString")We.type=2,Ur(je,rt,We);else if(qe==="Polygon")We.type=3,Ur(je,rt,We,!0);else{if(qe!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");We.type=3;for(let ct of je)Ur(ct,rt,We,!0)}return We}function qa([ht,te],fe,Ae){let qe=t.ay(ht),je=t.aH(te);je=je<0?0:je>1?1:je,fe.push(qe,je),Ae.minX=Math.min(Ae.minX,qe),Ae.minY=Math.min(Ae.minY,je),Ae.maxX=Math.max(Ae.maxX,qe),Ae.maxY=Math.max(Ae.maxY,je)}function No(ht,te,fe,Ae=!1,qe=!1){let je=[];for(let We of ht)qa(We,je,fe);te.push(je),Ae&&function(We,rt){let ct=0;for(let nt=0,Ot=We.length,wt=Ot-2;nt<Ot;wt=nt,nt+=2)ct+=(We[nt]-We[wt])*(We[nt+1]+We[wt+1]);if(ct>0===rt)for(let nt=0,Ot=We.length;nt<Ot/2;nt+=2){let wt=We[nt],_i=We[nt+1];We[nt]=We[Ot-2-nt],We[nt+1]=We[Ot-1-nt],We[Ot-2-nt]=wt,We[Ot-1-nt]=_i}}(je,qe)}function Ur(ht,te,fe,Ae=!1){for(let qe=0;qe<ht.length;qe++)No(ht[qe],te,fe,Ae,qe===0)}function ho(ht,te,fe,Ae){let{id:qe,type:je,geometry:We,tags:rt}=ht,ct=[];if(je===1)(function(nt,Ot,wt,_i,Ii){for(let Bt=0;Bt<nt.length;Bt+=2){let Di=Math.round(t.aj*(nt[Bt+0]*Ot-wt)),Ni=Math.round(t.aj*(nt[Bt+1]*Ot-_i));Ii.push([Di,Ni])}})(We,te,fe,Ae,ct);else for(let nt of We)ss(nt,te,fe,Ae,ct);return{id:qe,type:je,geometry:ct,tags:rt}}function ss(ht,te,fe,Ae,qe){let je=-ga,We=t.aj+ga,rt;for(let ct=0;ct<ht.length-2;ct+=2){let nt=Math.round(t.aj*(ht[ct+0]*te-fe)),Ot=Math.round(t.aj*(ht[ct+1]*te-Ae)),wt=Math.round(t.aj*(ht[ct+2]*te-fe)),_i=Math.round(t.aj*(ht[ct+3]*te-Ae)),Ii=wt-nt,Bt=_i-Ot;nt<je&&wt<je||(nt<je?(Ot+=Math.round(Bt*((je-nt)/Ii)),nt=je):wt<je&&(_i=Ot+Math.round(Bt*((je-nt)/Ii)),wt=je),Ot<je&&_i<je||(Ot<je?(nt+=Math.round(Ii*((je-Ot)/Bt)),Ot=je):_i<je&&(wt=nt+Math.round(Ii*((je-Ot)/Bt)),_i=je),nt>=We&&wt>=We||(nt>=We?(Ot+=Math.round(Bt*((We-nt)/Ii)),nt=We):wt>=We&&(_i=Ot+Math.round(Bt*((We-nt)/Ii)),wt=We),Ot>=We&&_i>=We||(Ot>=We?(nt+=Math.round(Ii*((We-Ot)/Bt)),Ot=We):_i>=We&&(wt=nt+Math.round(Ii*((We-Ot)/Bt)),_i=We),rt&&nt===rt[rt.length-1][0]&&Ot===rt[rt.length-1][1]||(rt=[[nt,Ot]],qe.push(rt)),rt.push([wt,_i])))))}}var ya,dl,$a,Mr={exports:{}},as=function(){if($a)return Mr.exports;$a=1;var ht=t.fg(),te=function(){if(dl)return ya;dl=1;var Ot=t.fe(),wt=t.ff().VectorTileFeature;function _i(Bt,Di){this.options=Di||{},this.features=Bt,this.length=Bt.length}function Ii(Bt,Di){this.id=typeof Bt.id=="number"?Bt.id:void 0,this.type=Bt.type,this.rawGeometry=Bt.type===1?[Bt.geometry]:Bt.geometry,this.properties=Bt.tags,this.extent=Di||4096}return ya=_i,_i.prototype.feature=function(Bt){return new Ii(this.features[Bt],this.options.extent)},Ii.prototype.loadGeometry=function(){var Bt=this.rawGeometry;this.geometry=[];for(var Di=0;Di<Bt.length;Di++){for(var Ni=Bt[Di],dn=[],An=0;An<Ni.length;An++)dn.push(new Ot(Ni[An][0],Ni[An][1]));this.geometry.push(dn)}return this.geometry},Ii.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var Bt=this.geometry,Di=1/0,Ni=-1/0,dn=1/0,An=-1/0,kr=0;kr<Bt.length;kr++)for(var Hi=Bt[kr],yr=0;yr<Hi.length;yr++){var Jn=Hi[yr];Di=Math.min(Di,Jn.x),Ni=Math.max(Ni,Jn.x),dn=Math.min(dn,Jn.y),An=Math.max(An,Jn.y)}return[Di,dn,Ni,An]},Ii.prototype.toGeoJSON=wt.prototype.toGeoJSON,ya}();function fe(Ot){var wt=new ht;return function(_i,Ii){for(var Bt in _i.layers)Ii.writeMessage(3,Ae,_i.layers[Bt])}(Ot,wt),wt.finish()}function Ae(Ot,wt){var _i;wt.writeVarintField(15,Ot.version||1),wt.writeStringField(1,Ot.name||""),wt.writeVarintField(5,Ot.extent||4096);var Ii={keys:[],values:[],keycache:{},valuecache:{}};for(_i=0;_i<Ot.length;_i++)Ii.feature=Ot.feature(_i),wt.writeMessage(2,qe,Ii);var Bt=Ii.keys;for(_i=0;_i<Bt.length;_i++)wt.writeStringField(3,Bt[_i]);var Di=Ii.values;for(_i=0;_i<Di.length;_i++)wt.writeMessage(4,nt,Di[_i])}function qe(Ot,wt){var _i=Ot.feature;_i.id!==void 0&&wt.writeVarintField(1,_i.id),wt.writeMessage(2,je,Ot),wt.writeVarintField(3,_i.type),wt.writeMessage(4,ct,_i)}function je(Ot,wt){var _i=Ot.feature,Ii=Ot.keys,Bt=Ot.values,Di=Ot.keycache,Ni=Ot.valuecache;for(var dn in _i.properties){var An=_i.properties[dn],kr=Di[dn];if(An!==null){kr===void 0&&(Ii.push(dn),Di[dn]=kr=Ii.length-1),wt.writeVarint(kr);var Hi=typeof An;Hi!=="string"&&Hi!=="boolean"&&Hi!=="number"&&(An=JSON.stringify(An));var yr=Hi+":"+An,Jn=Ni[yr];Jn===void 0&&(Bt.push(An),Ni[yr]=Jn=Bt.length-1),wt.writeVarint(Jn)}}}function We(Ot,wt){return(wt<<3)+(7&Ot)}function rt(Ot){return Ot<<1^Ot>>31}function ct(Ot,wt){for(var _i=Ot.loadGeometry(),Ii=Ot.type,Bt=0,Di=0,Ni=_i.length,dn=0;dn<Ni;dn++){var An=_i[dn],kr=1;Ii===1&&(kr=An.length),wt.writeVarint(We(1,kr));for(var Hi=Ii===3?An.length-1:An.length,yr=0;yr<Hi;yr++){yr===1&&Ii!==1&&wt.writeVarint(We(2,Hi-1));var Jn=An[yr].x-Bt,Un=An[yr].y-Di;wt.writeVarint(rt(Jn)),wt.writeVarint(rt(Un)),Bt+=Jn,Di+=Un}Ii===3&&wt.writeVarint(We(7,1))}}function nt(Ot,wt){var _i=typeof Ot;_i==="string"?wt.writeStringField(1,Ot):_i==="boolean"?wt.writeBooleanField(7,Ot):_i==="number"&&(Ot%1!=0?wt.writeDoubleField(3,Ot):Ot<0?wt.writeSVarintField(6,Ot):wt.writeVarintField(5,Ot))}return Mr.exports=fe,Mr.exports.fromVectorTileJs=fe,Mr.exports.fromGeojsonVt=function(Ot,wt){wt=wt||{};var _i={};for(var Ii in Ot)_i[Ii]=new te(Ot[Ii].features,wt),_i[Ii].name=Ii,_i[Ii].version=wt.version,_i[Ii].extent=wt.extent;return fe({layers:_i})},Mr.exports.GeoJSONWrapper=te,Mr.exports}(),Hr=t.fh(as);let Da={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:ht=>ht},xa=Math.fround||(Lr=new Float32Array(1),ht=>(Lr[0]=+ht,Lr[0]));var Lr;let jr=3,Co=5,$c=6;class gr{constructor(te){this.options=Object.assign(Object.create(Da),te),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(te){let{log:fe,minZoom:Ae,maxZoom:qe}=this.options;fe&&console.time("total time");let je=`prepare ${te.length} points`;fe&&console.time(je),this.points=te;let We=[];for(let ct=0;ct<te.length;ct++){let nt=te[ct];if(!nt.geometry)continue;let[Ot,wt]=nt.geometry.coordinates,_i=xa(va(Ot)),Ii=xa(hr(wt));We.push(_i,Ii,1/0,ct,-1,1),this.options.reduce&&We.push(0)}let rt=this.trees[qe+1]=this._createTree(We);fe&&console.timeEnd(je);for(let ct=qe;ct>=Ae;ct--){let nt=+Date.now();rt=this.trees[ct]=this._createTree(this._cluster(rt,ct)),fe&&console.log("z%d: %d clusters in %dms",ct,rt.numItems,+Date.now()-nt)}return fe&&console.timeEnd("total time"),this}getClusters(te,fe){let Ae=((te[0]+180)%360+360)%360-180,qe=Math.max(-90,Math.min(90,te[1])),je=te[2]===180?180:((te[2]+180)%360+360)%360-180,We=Math.max(-90,Math.min(90,te[3]));if(te[2]-te[0]>=360)Ae=-180,je=180;else if(Ae>je){let wt=this.getClusters([Ae,qe,180,We],fe),_i=this.getClusters([-180,qe,je,We],fe);return wt.concat(_i)}let rt=this.trees[this._limitZoom(fe)],ct=rt.range(va(Ae),hr(We),va(je),hr(qe)),nt=rt.data,Ot=[];for(let wt of ct){let _i=this.stride*wt;Ot.push(nt[_i+Co]>1?yc(nt,_i,this.clusterProps):this.points[nt[_i+jr]])}return Ot}getChildren(te){let fe=this._getOriginId(te),Ae=this._getOriginZoom(te),qe="No cluster with the specified id.",je=this.trees[Ae];if(!je)throw new Error(qe);let We=je.data;if(fe*this.stride>=We.length)throw new Error(qe);let rt=this.options.radius/(this.options.extent*Math.pow(2,Ae-1)),ct=je.within(We[fe*this.stride],We[fe*this.stride+1],rt),nt=[];for(let Ot of ct){let wt=Ot*this.stride;We[wt+4]===te&&nt.push(We[wt+Co]>1?yc(We,wt,this.clusterProps):this.points[We[wt+jr]])}if(nt.length===0)throw new Error(qe);return nt}getLeaves(te,fe,Ae){let qe=[];return this._appendLeaves(qe,te,fe=fe||10,Ae=Ae||0,0),qe}getTile(te,fe,Ae){let qe=this.trees[this._limitZoom(te)],je=Math.pow(2,te),{extent:We,radius:rt}=this.options,ct=rt/We,nt=(Ae-ct)/je,Ot=(Ae+1+ct)/je,wt={features:[]};return this._addTileFeatures(qe.range((fe-ct)/je,nt,(fe+1+ct)/je,Ot),qe.data,fe,Ae,je,wt),fe===0&&this._addTileFeatures(qe.range(1-ct/je,nt,1,Ot),qe.data,je,Ae,je,wt),fe===je-1&&this._addTileFeatures(qe.range(0,nt,ct/je,Ot),qe.data,-1,Ae,je,wt),wt.features.length?wt:null}getClusterExpansionZoom(te){let fe=this._getOriginZoom(te)-1;for(;fe<=this.options.maxZoom;){let Ae=this.getChildren(te);if(fe++,Ae.length!==1)break;te=Ae[0].properties.cluster_id}return fe}_appendLeaves(te,fe,Ae,qe,je){let We=this.getChildren(fe);for(let rt of We){let ct=rt.properties;if(ct&&ct.cluster?je+ct.point_count<=qe?je+=ct.point_count:je=this._appendLeaves(te,ct.cluster_id,Ae,qe,je):je<qe?je++:te.push(rt),te.length===Ae)break}return je}_createTree(te){let fe=new t.bW(te.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Ae=0;Ae<te.length;Ae+=this.stride)fe.add(te[Ae],te[Ae+1]);return fe.finish(),fe.data=te,fe}_addTileFeatures(te,fe,Ae,qe,je,We){for(let rt of te){let ct=rt*this.stride,nt=fe[ct+Co]>1,Ot,wt,_i;if(nt)Ot=Os(fe,ct,this.clusterProps),wt=fe[ct],_i=fe[ct+1];else{let Di=this.points[fe[ct+jr]];Ot=Di.properties;let[Ni,dn]=Di.geometry.coordinates;wt=va(Ni),_i=hr(dn)}let Ii={type:1,geometry:[[Math.round(this.options.extent*(wt*je-Ae)),Math.round(this.options.extent*(_i*je-qe))]],tags:Ot},Bt;Bt=nt||this.options.generateId?fe[ct+jr]:this.points[fe[ct+jr]].id,Bt!==void 0&&(Ii.id=Bt),We.features.push(Ii)}}_limitZoom(te){return Math.max(this.options.minZoom,Math.min(Math.floor(+te),this.options.maxZoom+1))}_cluster(te,fe){let{radius:Ae,extent:qe,reduce:je,minPoints:We}=this.options,rt=Ae/(qe*Math.pow(2,fe)),ct=te.data,nt=[],Ot=this.stride;for(let wt=0;wt<ct.length;wt+=Ot){if(ct[wt+2]<=fe)continue;ct[wt+2]=fe;let _i=ct[wt],Ii=ct[wt+1],Bt=te.within(ct[wt],ct[wt+1],rt),Di=ct[wt+Co],Ni=Di;for(let dn of Bt){let An=dn*Ot;ct[An+2]>fe&&(Ni+=ct[An+Co])}if(Ni>Di&&Ni>=We){let dn,An=_i*Di,kr=Ii*Di,Hi=-1,yr=(wt/Ot<<5)+(fe+1)+this.points.length;for(let Jn of Bt){let Un=Jn*Ot;if(ct[Un+2]<=fe)continue;ct[Un+2]=fe;let Ar=ct[Un+Co];An+=ct[Un]*Ar,kr+=ct[Un+1]*Ar,ct[Un+4]=yr,je&&(dn||(dn=this._map(ct,wt,!0),Hi=this.clusterProps.length,this.clusterProps.push(dn)),je(dn,this._map(ct,Un)))}ct[wt+4]=yr,nt.push(An/Ni,kr/Ni,1/0,yr,-1,Ni),je&&nt.push(Hi)}else{for(let dn=0;dn<Ot;dn++)nt.push(ct[wt+dn]);if(Ni>1)for(let dn of Bt){let An=dn*Ot;if(!(ct[An+2]<=fe)){ct[An+2]=fe;for(let kr=0;kr<Ot;kr++)nt.push(ct[An+kr])}}}}return nt}_getOriginId(te){return te-this.points.length>>5}_getOriginZoom(te){return(te-this.points.length)%32}_map(te,fe,Ae){if(te[fe+Co]>1){let We=this.clusterProps[te[fe+$c]];return Ae?Object.assign({},We):We}let qe=this.points[te[fe+jr]].properties,je=this.options.map(qe);return Ae&&je===qe?Object.assign({},je):je}}function yc(ht,te,fe){return{type:"Feature",id:ht[te+jr],properties:Os(ht,te,fe),geometry:{type:"Point",coordinates:[(Ae=ht[te],360*(Ae-.5)),Cl(ht[te+1])]}};var Ae}function Os(ht,te,fe){let Ae=ht[te+Co],qe=Ae>=1e4?`${Math.round(Ae/1e3)}k`:Ae>=1e3?Math.round(Ae/100)/10+"k":Ae,je=ht[te+$c],We=je===-1?{}:Object.assign({},fe[je]);return Object.assign(We,{cluster:!0,cluster_id:ht[te+jr],point_count:Ae,point_count_abbreviated:qe})}function va(ht){return ht/360+.5}function hr(ht){let te=Math.sin(ht*Math.PI/180),fe=.5-.25*Math.log((1+te)/(1-te))/Math.PI;return fe<0?0:fe>1?1:fe}function Cl(ht){let te=(180-360*ht)*Math.PI/180;return 360*Math.atan(Math.exp(te))/Math.PI-90}function ra(ht,te,fe,Ae){let qe=Ae,je=te+(fe-te>>1),We,rt=fe-te,ct=ht[te],nt=ht[te+1],Ot=ht[fe],wt=ht[fe+1];for(let _i=te+3;_i<fe;_i+=3){let Ii=Cs(ht[_i],ht[_i+1],ct,nt,Ot,wt);if(Ii>qe)We=_i,qe=Ii;else if(Ii===qe){let Bt=Math.abs(_i-je);Bt<rt&&(We=_i,rt=Bt)}}qe>Ae&&(We-te>3&&ra(ht,te,We,Ae),ht[We+2]=qe,fe-We>3&&ra(ht,We,fe,Ae))}function Cs(ht,te,fe,Ae,qe,je){let We=qe-fe,rt=je-Ae;if(We!==0||rt!==0){let ct=((ht-fe)*We+(te-Ae)*rt)/(We*We+rt*rt);ct>1?(fe=qe,Ae=je):ct>0&&(fe+=We*ct,Ae+=rt*ct)}return We=ht-fe,rt=te-Ae,We*We+rt*rt}function Jo(ht,te,fe,Ae){let qe={id:ht??null,type:te,geometry:fe,tags:Ae,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(te==="Point"||te==="MultiPoint"||te==="LineString")Fs(qe,fe);else if(te==="Polygon")Fs(qe,fe[0]);else if(te==="MultiLineString")for(let je of fe)Fs(qe,je);else if(te==="MultiPolygon")for(let je of fe)Fs(qe,je[0]);return qe}function Fs(ht,te){for(let fe=0;fe<te.length;fe+=3)ht.minX=Math.min(ht.minX,te[fe]),ht.minY=Math.min(ht.minY,te[fe+1]),ht.maxX=Math.max(ht.maxX,te[fe]),ht.maxY=Math.max(ht.maxY,te[fe+1])}function Vo(ht,te,fe,Ae){if(!te.geometry)return;let qe=te.geometry.coordinates;if(qe&&qe.length===0)return;let je=te.geometry.type,We=Math.pow(fe.tolerance/((1<<fe.maxZoom)*fe.extent),2),rt=[],ct=te.id;if(fe.promoteId?ct=te.properties[fe.promoteId]:fe.generateId&&(ct=Ae||0),je==="Point")ba(qe,rt);else if(je==="MultiPoint")for(let nt of qe)ba(nt,rt);else if(je==="LineString")Wa(qe,rt,We,!1);else if(je==="MultiLineString"){if(fe.lineMetrics){for(let nt of qe)rt=[],Wa(nt,rt,We,!1),ht.push(Jo(ct,"LineString",rt,te.properties));return}pl(qe,rt,We,!1)}else if(je==="Polygon")pl(qe,rt,We,!0);else{if(je!=="MultiPolygon"){if(je==="GeometryCollection"){for(let nt of te.geometry.geometries)Vo(ht,{id:ct,geometry:nt,properties:te.properties},fe,Ae);return}throw new Error("Input data is not a valid GeoJSON object.")}for(let nt of qe){let Ot=[];pl(nt,Ot,We,!0),rt.push(Ot)}}ht.push(Jo(ct,je,rt,te.properties))}function ba(ht,te){te.push(fl(ht[0]),fs(ht[1]),0)}function Wa(ht,te,fe,Ae){let qe,je,We=0;for(let ct=0;ct<ht.length;ct++){let nt=fl(ht[ct][0]),Ot=fs(ht[ct][1]);te.push(nt,Ot,0),ct>0&&(We+=Ae?(qe*Ot-nt*je)/2:Math.sqrt(Math.pow(nt-qe,2)+Math.pow(Ot-je,2))),qe=nt,je=Ot}let rt=te.length-3;te[2]=1,ra(te,0,rt,fe),te[rt+2]=1,te.size=Math.abs(We),te.start=0,te.end=te.size}function pl(ht,te,fe,Ae){for(let qe=0;qe<ht.length;qe++){let je=[];Wa(ht[qe],je,fe,Ae),te.push(je)}}function fl(ht){return ht/360+.5}function fs(ht){let te=Math.sin(ht*Math.PI/180),fe=.5-.25*Math.log((1+te)/(1-te))/Math.PI;return fe<0?0:fe>1?1:fe}function Ws(ht,te,fe,Ae,qe,je,We,rt){if(Ae/=te,je>=(fe/=te)&&We<Ae)return ht;if(We<fe||je>=Ae)return null;let ct=[];for(let nt of ht){let Ot=nt.geometry,wt=nt.type,_i=qe===0?nt.minX:nt.minY,Ii=qe===0?nt.maxX:nt.maxY;if(_i>=fe&&Ii<Ae){ct.push(nt);continue}if(Ii<fe||_i>=Ae)continue;let Bt=[];if(wt==="Point"||wt==="MultiPoint")ml(Ot,Bt,fe,Ae,qe);else if(wt==="LineString")Hs(Ot,Bt,fe,Ae,qe,!1,rt.lineMetrics);else if(wt==="MultiLineString")sl(Ot,Bt,fe,Ae,qe,!1);else if(wt==="Polygon")sl(Ot,Bt,fe,Ae,qe,!0);else if(wt==="MultiPolygon")for(let Di of Ot){let Ni=[];sl(Di,Ni,fe,Ae,qe,!0),Ni.length&&Bt.push(Ni)}if(Bt.length){if(rt.lineMetrics&&wt==="LineString"){for(let Di of Bt)ct.push(Jo(nt.id,wt,Di,nt.tags));continue}wt!=="LineString"&&wt!=="MultiLineString"||(Bt.length===1?(wt="LineString",Bt=Bt[0]):wt="MultiLineString"),wt!=="Point"&&wt!=="MultiPoint"||(wt=Bt.length===3?"Point":"MultiPoint"),ct.push(Jo(nt.id,wt,Bt,nt.tags))}}return ct.length?ct:null}function ml(ht,te,fe,Ae,qe){for(let je=0;je<ht.length;je+=3){let We=ht[je+qe];We>=fe&&We<=Ae&&El(te,ht[je],ht[je+1],ht[je+2])}}function Hs(ht,te,fe,Ae,qe,je,We){let rt=Ha(ht),ct=qe===0?ms:Vt,nt,Ot,wt=ht.start;for(let Ni=0;Ni<ht.length-3;Ni+=3){let dn=ht[Ni],An=ht[Ni+1],kr=ht[Ni+2],Hi=ht[Ni+3],yr=ht[Ni+4],Jn=qe===0?dn:An,Un=qe===0?Hi:yr,Ar=!1;We&&(nt=Math.sqrt(Math.pow(dn-Hi,2)+Math.pow(An-yr,2))),Jn<fe?Un>fe&&(Ot=ct(rt,dn,An,Hi,yr,fe),We&&(rt.start=wt+nt*Ot)):Jn>Ae?Un<Ae&&(Ot=ct(rt,dn,An,Hi,yr,Ae),We&&(rt.start=wt+nt*Ot)):El(rt,dn,An,kr),Un<fe&&Jn>=fe&&(Ot=ct(rt,dn,An,Hi,yr,fe),Ar=!0),Un>Ae&&Jn<=Ae&&(Ot=ct(rt,dn,An,Hi,yr,Ae),Ar=!0),!je&&Ar&&(We&&(rt.end=wt+nt*Ot),te.push(rt),rt=Ha(ht)),We&&(wt+=nt)}let _i=ht.length-3,Ii=ht[_i],Bt=ht[_i+1],Di=qe===0?Ii:Bt;Di>=fe&&Di<=Ae&&El(rt,Ii,Bt,ht[_i+2]),_i=rt.length-3,je&&_i>=3&&(rt[_i]!==rt[0]||rt[_i+1]!==rt[1])&&El(rt,rt[0],rt[1],rt[2]),rt.length&&te.push(rt)}function Ha(ht){let te=[];return te.size=ht.size,te.start=ht.start,te.end=ht.end,te}function sl(ht,te,fe,Ae,qe,je){for(let We of ht)Hs(We,te,fe,Ae,qe,je,!1)}function El(ht,te,fe,Ae){ht.push(te,fe,Ae)}function ms(ht,te,fe,Ae,qe,je){let We=(je-te)/(Ae-te);return El(ht,je,fe+(qe-fe)*We,1),We}function Vt(ht,te,fe,Ae,qe,je){let We=(je-fe)/(qe-fe);return El(ht,te+(Ae-te)*We,je,1),We}function Le(ht,te){let fe=[];for(let Ae=0;Ae<ht.length;Ae++){let qe=ht[Ae],je=qe.type,We;if(je==="Point"||je==="MultiPoint"||je==="LineString")We=Fe(qe.geometry,te);else if(je==="MultiLineString"||je==="Polygon"){We=[];for(let rt of qe.geometry)We.push(Fe(rt,te))}else if(je==="MultiPolygon"){We=[];for(let rt of qe.geometry){let ct=[];for(let nt of rt)ct.push(Fe(nt,te));We.push(ct)}}fe.push(Jo(qe.id,je,We,qe.tags))}return fe}function Fe(ht,te){let fe=[];fe.size=ht.size,ht.start!==void 0&&(fe.start=ht.start,fe.end=ht.end);for(let Ae=0;Ae<ht.length;Ae+=3)fe.push(ht[Ae]+te,ht[Ae+1],ht[Ae+2]);return fe}function He(ht,te){if(ht.transformed)return ht;let fe=1<<ht.z,Ae=ht.x,qe=ht.y;for(let je of ht.features){let We=je.geometry,rt=je.type;if(je.geometry=[],rt===1)for(let ct=0;ct<We.length;ct+=2)je.geometry.push(mt(We[ct],We[ct+1],te,fe,Ae,qe));else for(let ct=0;ct<We.length;ct++){let nt=[];for(let Ot=0;Ot<We[ct].length;Ot+=2)nt.push(mt(We[ct][Ot],We[ct][Ot+1],te,fe,Ae,qe));je.geometry.push(nt)}}return ht.transformed=!0,ht}function mt(ht,te,fe,Ae,qe,je){return[Math.round(fe*(ht*Ae-qe)),Math.round(fe*(te*Ae-je))]}function St(ht,te,fe,Ae,qe){let je=te===qe.maxZoom?0:qe.tolerance/((1<<te)*qe.extent),We={features:[],numPoints:0,numSimplified:0,numFeatures:ht.length,source:null,x:fe,y:Ae,z:te,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(let rt of ht)Tt(We,rt,je,qe);return We}function Tt(ht,te,fe,Ae){let qe=te.geometry,je=te.type,We=[];if(ht.minX=Math.min(ht.minX,te.minX),ht.minY=Math.min(ht.minY,te.minY),ht.maxX=Math.max(ht.maxX,te.maxX),ht.maxY=Math.max(ht.maxY,te.maxY),je==="Point"||je==="MultiPoint")for(let rt=0;rt<qe.length;rt+=3)We.push(qe[rt],qe[rt+1]),ht.numPoints++,ht.numSimplified++;else if(je==="LineString")Xt(We,qe,ht,fe,!1,!1);else if(je==="MultiLineString"||je==="Polygon")for(let rt=0;rt<qe.length;rt++)Xt(We,qe[rt],ht,fe,je==="Polygon",rt===0);else if(je==="MultiPolygon")for(let rt=0;rt<qe.length;rt++){let ct=qe[rt];for(let nt=0;nt<ct.length;nt++)Xt(We,ct[nt],ht,fe,!0,nt===0)}if(We.length){let rt=te.tags||null;if(je==="LineString"&&Ae.lineMetrics){rt={};for(let nt in te.tags)rt[nt]=te.tags[nt];rt.mapbox_clip_start=qe.start/qe.size,rt.mapbox_clip_end=qe.end/qe.size}let ct={geometry:We,type:je==="Polygon"||je==="MultiPolygon"?3:je==="LineString"||je==="MultiLineString"?2:1,tags:rt};te.id!==null&&(ct.id=te.id),ht.features.push(ct)}}function Xt(ht,te,fe,Ae,qe,je){let We=Ae*Ae;if(Ae>0&&te.size<(qe?We:Ae))return void(fe.numPoints+=te.length/3);let rt=[];for(let ct=0;ct<te.length;ct+=3)(Ae===0||te[ct+2]>We)&&(fe.numSimplified++,rt.push(te[ct],te[ct+1])),fe.numPoints++;qe&&function(ct,nt){let Ot=0;for(let wt=0,_i=ct.length,Ii=_i-2;wt<_i;Ii=wt,wt+=2)Ot+=(ct[wt]-ct[Ii])*(ct[wt+1]+ct[Ii+1]);if(Ot>0===nt)for(let wt=0,_i=ct.length;wt<_i/2;wt+=2){let Ii=ct[wt],Bt=ct[wt+1];ct[wt]=ct[_i-2-wt],ct[wt+1]=ct[_i-1-wt],ct[_i-2-wt]=Ii,ct[_i-1-wt]=Bt}}(rt,je),ht.push(rt)}let Lt={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class di{constructor(te,fe){let Ae=(fe=this.options=function(je,We){for(let rt in We)je[rt]=We[rt];return je}(Object.create(Lt),fe)).debug;if(Ae&&console.time("preprocess data"),fe.maxZoom<0||fe.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(fe.promoteId&&fe.generateId)throw new Error("promoteId and generateId cannot be used together.");let qe=function(je,We){let rt=[];if(je.type==="FeatureCollection")for(let ct=0;ct<je.features.length;ct++)Vo(rt,je.features[ct],We,ct);else Vo(rt,je.type==="Feature"?je:{geometry:je},We);return rt}(te,fe);this.tiles={},this.tileCoords=[],Ae&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",fe.indexMaxZoom,fe.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),qe=function(je,We){let rt=We.buffer/We.extent,ct=je,nt=Ws(je,1,-1-rt,rt,0,-1,2,We),Ot=Ws(je,1,1-rt,2+rt,0,-1,2,We);return(nt||Ot)&&(ct=Ws(je,1,-rt,1+rt,0,-1,2,We)||[],nt&&(ct=Le(nt,1).concat(ct)),Ot&&(ct=ct.concat(Le(Ot,-1)))),ct}(qe,fe),qe.length&&this.splitTile(qe,0,0,0),Ae&&(qe.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(te,fe,Ae,qe,je,We,rt){let ct=[te,fe,Ae,qe],nt=this.options,Ot=nt.debug;for(;ct.length;){qe=ct.pop(),Ae=ct.pop(),fe=ct.pop(),te=ct.pop();let wt=1<<fe,_i=li(fe,Ae,qe),Ii=this.tiles[_i];if(!Ii&&(Ot>1&&console.time("creation"),Ii=this.tiles[_i]=St(te,fe,Ae,qe,nt),this.tileCoords.push({z:fe,x:Ae,y:qe}),Ot)){Ot>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",fe,Ae,qe,Ii.numFeatures,Ii.numPoints,Ii.numSimplified),console.timeEnd("creation"));let Ar=`z${fe}`;this.stats[Ar]=(this.stats[Ar]||0)+1,this.total++}if(Ii.source=te,je==null){if(fe===nt.indexMaxZoom||Ii.numPoints<=nt.indexMaxPoints)continue}else{if(fe===nt.maxZoom||fe===je)continue;if(je!=null){let Ar=je-fe;if(Ae!==We>>Ar||qe!==rt>>Ar)continue}}if(Ii.source=null,te.length===0)continue;Ot>1&&console.time("clipping");let Bt=.5*nt.buffer/nt.extent,Di=.5-Bt,Ni=.5+Bt,dn=1+Bt,An=null,kr=null,Hi=null,yr=null,Jn=Ws(te,wt,Ae-Bt,Ae+Ni,0,Ii.minX,Ii.maxX,nt),Un=Ws(te,wt,Ae+Di,Ae+dn,0,Ii.minX,Ii.maxX,nt);te=null,Jn&&(An=Ws(Jn,wt,qe-Bt,qe+Ni,1,Ii.minY,Ii.maxY,nt),kr=Ws(Jn,wt,qe+Di,qe+dn,1,Ii.minY,Ii.maxY,nt),Jn=null),Un&&(Hi=Ws(Un,wt,qe-Bt,qe+Ni,1,Ii.minY,Ii.maxY,nt),yr=Ws(Un,wt,qe+Di,qe+dn,1,Ii.minY,Ii.maxY,nt),Un=null),Ot>1&&console.timeEnd("clipping"),ct.push(An||[],fe+1,2*Ae,2*qe),ct.push(kr||[],fe+1,2*Ae,2*qe+1),ct.push(Hi||[],fe+1,2*Ae+1,2*qe),ct.push(yr||[],fe+1,2*Ae+1,2*qe+1)}}getTile(te,fe,Ae){te=+te,fe=+fe,Ae=+Ae;let qe=this.options,{extent:je,debug:We}=qe;if(te<0||te>24)return null;let rt=1<<te,ct=li(te,fe=fe+rt&rt-1,Ae);if(this.tiles[ct])return He(this.tiles[ct],je);We>1&&console.log("drilling down to z%d-%d-%d",te,fe,Ae);let nt,Ot=te,wt=fe,_i=Ae;for(;!nt&&Ot>0;)Ot--,wt>>=1,_i>>=1,nt=this.tiles[li(Ot,wt,_i)];return nt&&nt.source?(We>1&&(console.log("found parent tile z%d-%d-%d",Ot,wt,_i),console.time("drilling down")),this.splitTile(nt.source,Ot,wt,_i,te,fe,Ae),We>1&&console.timeEnd("drilling down"),this.tiles[ct]?He(this.tiles[ct],je):null):null}}function li(ht,te,fe){return 32*((1<<ht)*fe+te)+ht}function Zt(ht,te){let fe=ht.tileID.canonical;if(!this._geoJSONIndex)return void te(null,null);let Ae=this._geoJSONIndex.getTile(fe.z,fe.x,fe.y);if(!Ae)return void te(null,null);let qe=new Br(Ae.features),je=Hr(qe);je.byteOffset===0&&je.byteLength===je.buffer.byteLength||(je=new Uint8Array(je)),te(null,{vectorTile:qe,rawData:je.buffer})}class wi extends vn{constructor(te,fe,Ae,qe,je,We,rt){super(te,fe,Ae,qe,je,Zt,rt),We&&(this.loadGeoJSON=We),this._dynamicIndex=new Aa}loadData(te,fe){let Ae=te&&te.request,qe=Ae&&Ae.collectResourceTiming;this.loadGeoJSON(te,(je,We)=>{if(je||!We)return fe(je);if(typeof We!="object")return fe(new Error(`Input data given to '${te.source}' is not a valid GeoJSON object.`));{try{if(te.filter){let ct=t.X(te.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(ct.result==="error")throw new Error(ct.value.map(nt=>`${nt.key}: ${nt.message}`).join(", "));We.features=We.features.filter(nt=>ct.value.evaluate({zoom:0},nt))}te.dynamic?(We.type==="Feature"&&(We={type:"FeatureCollection",features:[We]}),te.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(We.features,this.loaded),te.cluster&&(We.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=te.cluster?new gr(function({superclusterOptions:ct,clusterProperties:nt}){if(!nt||!ct)return ct;let Ot={},wt={},_i={accumulated:null,zoom:0},Ii={properties:null},Bt=Object.keys(nt);for(let Di of Bt){let[Ni,dn]=nt[Di],An=t.X(dn),kr=t.X(typeof Ni=="string"?[Ni,["accumulated"],["get",Di]]:Ni);Ot[Di]=An.value,wt[Di]=kr.value}return ct.map=Di=>{Ii.properties=Di;let Ni={};for(let dn of Bt)Ni[dn]=Ot[dn].evaluate(_i,Ii);return Ni},ct.reduce=(Di,Ni)=>{Ii.properties=Ni;for(let dn of Bt)_i.accumulated=Di[dn],Di[dn]=wt[dn].evaluate(_i,Ii)},ct}(te)).load(We.features):te.dynamic?this._dynamicIndex:function(ct,nt){return new di(ct,nt)}(We,te.geojsonVtOptions)}catch(ct){return fe(ct)}let rt={};if(qe){let ct=at(Ae);ct&&(rt.resourceTiming={},rt.resourceTiming[te.source]=JSON.parse(JSON.stringify(ct)))}fe(null,rt)}})}reloadTile(te,fe){let Ae=this.loaded;return Ae&&Ae[te.uid]?te.partial?fe(null,void 0):super.reloadTile(te,fe):this.loadTile(te,fe)}loadGeoJSON(te,fe){if(te.request)t.n(te.request,fe);else{if(typeof te.data!="string")return fe(new Error(`Input data given to '${te.source}' is not a valid GeoJSON object.`));try{return fe(null,JSON.parse(te.data))}catch{return fe(new Error(`Input data given to '${te.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(te,fe){try{fe(null,this._geoJSONIndex.getClusterExpansionZoom(te.clusterId))}catch(Ae){fe(Ae)}}getClusterChildren(te,fe){try{fe(null,this._geoJSONIndex.getChildren(te.clusterId))}catch(Ae){fe(Ae)}}getClusterLeaves(te,fe){try{fe(null,this._geoJSONIndex.getLeaves(te.clusterId,te.limit,te.offset))}catch(Ae){fe(Ae)}}}class Ue{constructor(te,fe){this.tileID=new t.aM(te.tileID.overscaledZ,te.tileID.wrap,te.tileID.canonical.z,te.tileID.canonical.x,te.tileID.canonical.y),this.tileZoom=te.tileZoom,this.uid=te.uid,this.zoom=te.zoom,this.canonical=te.tileID.canonical,this.pixelRatio=te.pixelRatio,this.tileSize=te.tileSize,this.source=te.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=te.projection,this.brightness=fe}parse(te,fe,Ae,qe){this.status="parsing";let je=new t.aM(Ae.tileID.overscaledZ,Ae.tileID.wrap,Ae.tileID.canonical.z,Ae.tileID.canonical.x,Ae.tileID.canonical.y),We=[],rt=fe.familiesBySource[Ae.source],ct=new t.f0(je,Ae.promoteId);ct.bucketLayerIDs=[],ct.is3DTile=!0,t.fi(te).then(nt=>{if(!nt)return qe(new Error("Could not parse tile"));let Ot=t.fj(nt,1/t.cT(Ae.tileID.canonical)),wt=nt.json.extensionsUsed&&nt.json.extensionsUsed.includes("MAPBOX_mesh_features")||nt.json.asset.extras&&nt.json.asset.extras.MAPBOX_mesh_features,_i=nt.json.extensionsUsed&&nt.json.extensionsUsed.includes("EXT_meshopt_compression"),Ii=new t.aa(this.zoom,{brightness:this.brightness});for(let Bt in rt)for(let Di of rt[Bt]){let Ni=Di[0];ct.bucketLayerIDs.push(Di.map(An=>t.C(An.id,An.scope))),Ni.recalculate(Ii,[]);let dn=new t.fk(Di,Ot,je,wt,_i,this.brightness,ct);wt||(dn.needsUpload=!0),We.push(dn),dn.evaluate(Ni)}this.status="done",qe(null,{buckets:We,featureIndex:ct,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(nt=>qe(new Error(nt.message)))}}class Qi{constructor(te,fe,Ae,qe,je,We,rt){this.actor=te,this.layerIndex=fe,this.availableImages=Ae,this.availableModels=qe,this.brightness=rt,this.loading={},this.loaded={}}loadTile(te,fe){let Ae=te.uid,qe=this.loading[Ae]=new Ue(te,this.brightness);t.br(te.request,(je,We)=>{let rt=!this.loading[Ae];return delete this.loading[Ae],rt||je?(qe.status="done",rt||(this.loaded[Ae]=qe),fe(je)):We&&We.byteLength!==0?void qe.parse(We,this.layerIndex,te,(ct,nt)=>{qe.status="done",this.loaded=this.loaded||{},this.loaded[Ae]=qe,ct||!nt?fe(ct):fe(null,nt)}):(qe.status="done",this.loaded[Ae]=qe,fe())})}reloadTile(te,fe){let Ae=this.loaded,qe=te.uid;if(Ae&&Ae[qe]){let je=Ae[qe];je.projection=te.projection,je.brightness=te.brightness;let We=(rt,ct)=>{je.reloadCallback&&(delete je.reloadCallback,this.loadTile(te,fe)),fe(rt,ct)};je.status==="parsing"?je.reloadCallback=We:je.status==="done"&&this.loadTile(te,fe)}}abortTile(te,fe){let Ae=te.uid;this.loading[Ae]&&delete this.loading[Ae],fe()}removeTile(te,fe){let Ae=this.loaded,qe=te.uid;Ae&&Ae[qe]&&delete Ae[qe],fe()}}class $n{constructor(te){this.self=te,this.actor=new t.fm(te,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new t.y,this.projections={},this.defaultProjection=t.ce({name:"mercator"}),this.workerSourceTypes={vector:vn,geojson:wi,"raster-dem":gn,"raster-array":Bo,"batched-model":Qi},this.workerSources={},this.self.registerWorkerSource=(fe,Ae)=>{if(this.workerSourceTypes[fe])throw new Error(`Worker source with name "${fe}" already registered.`);this.workerSourceTypes[fe]=Ae},this.self.registerRTLTextPlugin=fe=>{if(t.fn.isParsed())throw new Error("RTL text plugin already registered.");t.fn.applyArabicShaping=fe.applyArabicShaping,t.fn.processBidirectionalText=fe.processBidirectionalText,t.fn.processStyledBidirectionalText=fe.processStyledBidirectionalText}}clearCaches(te,fe,Ae){delete this.layerIndexes[te],delete this.availableImages[te],delete this.availableModels[te],delete this.workerSources[te],Ae()}checkIfReady(te,fe,Ae){Ae()}setReferrer(te,fe){this.referrer=fe}spriteLoaded(te,fe){this.isSpriteLoaded[te]||(this.isSpriteLoaded[te]={});let{scope:Ae,isLoaded:qe}=fe;if(this.isSpriteLoaded[te][Ae]=qe,this.workerSources[te]&&this.workerSources[te][Ae])for(let je in this.workerSources[te][Ae]){let We=this.workerSources[te][Ae][je];for(let rt in We){let ct=We[rt];ct instanceof vn&&(ct.isSpriteLoaded=qe,ct.fire(new t.A("isSpriteLoaded")))}}}setImages(te,fe,Ae){this.availableImages[te]||(this.availableImages[te]={});let{scope:qe,images:je}=fe;if(this.availableImages[te][qe]=je,this.workerSources[te]&&this.workerSources[te][qe]){for(let We in this.workerSources[te][qe]){let rt=this.workerSources[te][qe][We];for(let ct in rt)rt[ct].availableImages=je}Ae()}else Ae()}setModels(te,{scope:fe,models:Ae},qe){if(this.availableModels[te]||(this.availableModels[te]={}),this.availableModels[te][fe]=Ae,this.workerSources[te]&&this.workerSources[te][fe]){for(let je in this.workerSources[te][fe]){let We=this.workerSources[te][fe][je];for(let rt in We)We[rt].availableModels=Ae}qe()}else qe()}setProjection(te,fe){this.projections[te]=t.ce(fe)}setBrightness(te,fe,Ae){this.brightness=fe,Ae()}setLayers(te,fe,Ae){this.getLayerIndex(te,fe.scope).replace(fe.layers,fe.options),Ae()}updateLayers(te,fe,Ae){this.getLayerIndex(te,fe.scope).update(fe.layers,fe.removedIds,fe.options),Ae()}loadTile(te,fe,Ae){fe.projection=this.projections[te]||this.defaultProjection,this.getWorkerSource(te,fe.type,fe.source,fe.scope).loadTile(fe,Ae)}decodeRasterArray(te,fe,Ae){this.getWorkerSource(te,fe.type,fe.source,fe.scope).decodeRasterArray(fe,Ae)}reloadTile(te,fe,Ae){fe.projection=this.projections[te]||this.defaultProjection,this.getWorkerSource(te,fe.type,fe.source,fe.scope).reloadTile(fe,Ae)}abortTile(te,fe,Ae){this.getWorkerSource(te,fe.type,fe.source,fe.scope).abortTile(fe,Ae)}removeTile(te,fe,Ae){this.getWorkerSource(te,fe.type,fe.source,fe.scope).removeTile(fe,Ae)}removeSource(te,fe,Ae){if(!(this.workerSources[te]&&this.workerSources[te][fe.scope]&&this.workerSources[te][fe.scope][fe.type]&&this.workerSources[te][fe.scope][fe.type][fe.source]))return;let qe=this.workerSources[te][fe.scope][fe.type][fe.source];delete this.workerSources[te][fe.scope][fe.type][fe.source],qe.removeSource!==void 0?qe.removeSource(fe,Ae):Ae()}loadWorkerSource(te,fe,Ae){try{this.self.importScripts(fe.url),Ae()}catch(qe){Ae(qe.toString())}}syncRTLPluginState(te,fe,Ae){try{t.fn.setState(fe);let qe=t.fn.getPluginURL();if(t.fn.isLoaded()&&!t.fn.isParsed()&&qe!=null){this.self.importScripts(qe);let je=t.fn.isParsed();Ae(je?void 0:new Error(`RTL Text Plugin failed to import scripts from ${qe}`),je)}}catch(qe){Ae(qe.toString())}}setDracoUrl(te,fe){this.dracoUrl=fe}getAvailableImages(te,fe){this.availableImages[te]||(this.availableImages[te]={});let Ae=this.availableImages[te][fe];return Ae||(Ae=[]),Ae}getAvailableModels(te,fe){this.availableModels[te]||(this.availableModels[te]={});let Ae=this.availableModels[te][fe];return Ae||(Ae={}),Ae}getLayerIndex(te,fe){this.layerIndexes[te]||(this.layerIndexes[te]={});let Ae=this.layerIndexes[te][fe];return Ae||(Ae=this.layerIndexes[te][fe]=new _r,Ae.scope=fe),Ae}getWorkerSource(te,fe,Ae,qe){let je=this.workerSources;return je[te]||(je[te]={}),je[te][qe]||(je[te][qe]={}),je[te][qe][fe]||(je[te][qe][fe]={}),this.isSpriteLoaded[te]||(this.isSpriteLoaded[te]={}),je[te][qe][fe][Ae]||(je[te][qe][fe][Ae]=new this.workerSourceTypes[fe]({send:(We,rt,ct,nt,Ot,wt)=>this.actor.send(We,rt,ct,te,Ot,wt),scheduler:this.actor.scheduler},this.getLayerIndex(te,qe),this.getAvailableImages(te,qe),this.getAvailableModels(te,qe),this.isSpriteLoaded[te][qe],void 0,this.brightness)),je[te][qe][fe][Ae]}rasterizeImagesWorker(te,fe,Ae){let qe=new Map;for(let[je,{image:We,imageVariant:rt}]of fe.tasks.entries()){let ct=this.imageRasterizer.rasterize(rt,We,fe.scope,te);qe.set(je,ct)}Ae(void 0,qe)}removeRasterizedImages(te,fe,Ae){this.imageRasterizer.removeImagesFromCacheByIds(fe.imageIds,fe.scope,te),Ae()}enforceCacheSizeLimit(te,fe){t.fo(fe)}getWorkerPerformanceMetrics(te,fe,Ae){Ae(void 0,void 0)}}return t.fl(self)&&(self.worker=new $n(self)),$n}),Y(["./shared"],function(t){var at="3.12.0";let yi={create:"create",load:"load",fullLoad:"fullLoad"},Cn={mark(p){performance.mark(p)},measure(p,i,a){performance.measure(p,i,a)}};function _r(p){let i=p.name.split("?")[0];return t.a(i)&&i.includes("mapbox-gl.js")?"javascript":t.a(i)&&i.includes("mapbox-gl.css")?"css":t.b(i)?"fontRange":t.c(i)?"sprite":t.i(i)?"style":t.d(i)?"tilejson":"other"}var an,Dt={},Wi=function(){if(an)return Dt;function p(f){return!i(f)}function i(f){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var v,S,C=new Blob([""],{type:"text/javascript"}),z=URL.createObjectURL(C);try{S=new Worker(z),v=!0}catch{v=!1}return S&&S.terminate(),URL.revokeObjectURL(z),v}()?function(){var v=document.createElement("canvas");v.width=v.height=1;var S=v.getContext("2d");if(!S)return!1;var C=S.getImageData(0,0,1,1);return C&&C.width===v.width}()?(a[g=f&&f.failIfMajorPerformanceCaveat]===void 0&&(a[g]=function(v){var S,C=function(z){var N=document.createElement("canvas"),U=Object.create(p.webGLContextAttributes);return U.failIfMajorPerformanceCaveat=z,N.getContext("webgl2",U)}(v);if(!C)return!1;try{S=C.createShader(C.VERTEX_SHADER)}catch{return!1}return!(!S||C.isContextLost())&&(C.shaderSource(S,"void main() {}"),C.compileShader(S),C.getShaderParameter(S,C.COMPILE_STATUS)===!0)}(g)),a[g]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var g}an=1,Dt.supported=p,Dt.notSupportedReason=i;var a={};return p.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},Dt}();function on(p,i,a){let f=document.createElement(p);return i!=null&&(f.className=i),a&&a.appendChild(f),f}function vn(p,i,a){let f=document.createElementNS("http://www.w3.org/2000/svg",p);for(let g of Object.keys(i))f.setAttributeNS(null,g,String(i[g]));return a&&a.appendChild(f),f}let gn=typeof document<"u"?document.documentElement&&document.documentElement.style:null,vr=gn&&gn.userSelect!==void 0?"userSelect":"WebkitUserSelect",Bo;function qo(){gn&&vr&&(Bo=gn[vr],gn[vr]="none")}function to(){gn&&vr&&(gn[vr]=Bo)}function Br(p){p.preventDefault(),p.stopPropagation(),window.removeEventListener("click",Br,!0)}function os(){window.addEventListener("click",Br,!0),window.setTimeout(()=>{window.removeEventListener("click",Br,!0)},0)}function ga(p,i){let a=p.getBoundingClientRect();return Io(p,a,i)}function Aa(p,i){let a=p.getBoundingClientRect(),f=[];for(let g=0;g<i.length;g++)f.push(Io(p,a,i[g]));return f}function Ql(p){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&p.button===2&&p.ctrlKey?0:p.button}function Io(p,i,a){let f=p.offsetWidth===i.width?1:p.offsetWidth/i.width;return new t.P((a.clientX-i.left)*f,(a.clientY-i.top)*f)}let qa="01",No="NO_ACCESS_TOKEN";class Ur{constructor(i,a,f){this._transformRequestFn=i,this._customAccessToken=a,this._silenceAuthErrors=!!f,this._createSkuToken()}_createSkuToken(){let i=function(){let a="";for(let f=0;f<10;f++)a+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",qa,a].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=i.token,this._skuTokenExpiresAt=i.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(i,a){return this._transformRequestFn&&this._transformRequestFn(i,a)||{url:i}}normalizeStyleURL(i,a){if(!t.f(i))return i;let f=ss(i);return f.params.push(`sdk=js-${at}`),f.path=`/styles/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||a)}normalizeGlyphsURL(i,a){if(!t.f(i))return i;let f=ss(i);return f.path=`/fonts/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||a)}normalizeModelURL(i,a){if(!t.f(i))return i;let f=ss(i);return f.path=`/models/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||a)}normalizeSourceURL(i,a,f,g){if(!t.f(i))return i;let v=ss(i);return v.path=`/v4/${v.authority}.json`,v.params.push("secure"),f&&v.params.push(`language=${f}`),g&&v.params.push(`worldview=${g}`),this._makeAPIURL(v,this._customAccessToken||a)}normalizeIconsetURL(i,a){let f=ss(i);return t.f(i)?(f.path=`/styles/v1${f.path}/iconset.pbf`,this._makeAPIURL(f,this._customAccessToken||a)):ya(f)}normalizeSpriteURL(i,a,f,g){let v=ss(i);return t.f(i)?(v.path=`/styles/v1${v.path}/sprite${a}${f}`,this._makeAPIURL(v,this._customAccessToken||g)):(v.path+=`${a}${f}`,ya(v))}normalizeTileURL(i,a,f){if(this._isSkuTokenExpired()&&this._createSkuToken(),i&&!t.f(i))return i;let g=ss(i);g.path=g.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${a||f&&g.authority!=="raster"&&f===512?"@2x":""}${t.m.supported?".webp":"$1"}`),g.authority==="raster"?g.path=`/${t.e.RASTER_URL_PREFIX}${g.path}`:g.authority==="rasterarrays"?g.path=`/${t.e.RASTERARRAYS_URL_PREFIX}${g.path}`:g.authority==="3dtiles"?g.path=`/${t.e.TILES3D_URL_PREFIX}${g.path}`:(g.path=g.path.replace(/^.+\/v4\//,"/"),g.path=`/${t.e.TILE_URL_VERSION}${g.path}`);let v=this._customAccessToken||function(S){for(let C of S){let z=C.match(/^access_token=(.*)$/);if(z)return z[1]}return null}(g.params)||t.e.ACCESS_TOKEN;return t.e.REQUIRE_ACCESS_TOKEN&&v&&this._skuToken&&g.params.push(`sku=${this._skuToken}`),this._makeAPIURL(g,v)}canonicalizeTileURL(i,a){let f=ss(i);if(!f.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!f.path.match(/\.[\w]+$/))return i;let g="mapbox://";f.path.match(/^\/raster\/v1\//)?g+=`raster/${f.path.replace(`/${t.e.RASTER_URL_PREFIX}/`,"")}`:f.path.match(/^\/rasterarrays\/v1\//)?g+=`rasterarrays/${f.path.replace(`/${t.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:g+=`tiles/${f.path.replace(`/${t.e.TILE_URL_VERSION}/`,"")}`;let v=f.params;return a&&(v=v.filter(S=>!S.match(/^access_token=/))),v.length&&(g+=`?${v.join("&")}`),g}canonicalizeTileset(i,a){let f=!!a&&t.f(a),g=[];for(let v of i.tiles||[])t.h(v)?g.push(this.canonicalizeTileURL(v,f)):g.push(v);return g}_makeAPIURL(i,a){let f="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",g=ss(t.e.API_URL);if(i.protocol=g.protocol,i.authority=g.authority,i.protocol==="http"){let v=i.params.indexOf("secure");v>=0&&i.params.splice(v,1)}if(g.path!=="/"&&(i.path=`${g.path}${i.path}`),!t.e.REQUIRE_ACCESS_TOKEN)return ya(i);if(a=a||t.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!a)throw new Error(`An API access token is required to use Mapbox GL. ${f}`);if(a[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${f}`)}return i.params=i.params.filter(v=>v.indexOf("access_token")===-1),i.params.push(`access_token=${a||""}`),ya(i)}}let ho=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function ss(p){let i=p.match(ho);if(!i)throw new Error("Unable to parse URL object");return{protocol:i[1],authority:i[2],path:i[3]||"/",params:i[4]?i[4].split("&"):[]}}function ya(p){let i=p.params.length?`?${p.params.join("&")}`:"";return`${p.protocol}://${p.authority}${p.path}${i}`}let dl="mapbox.eventData";function $a(p){if(!p)return null;let i=p.split(".");if(!i||i.length!==3)return null;try{return JSON.parse(t.j(i[1]))}catch{return null}}class Mr{constructor(i){this.type=i,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(i){let a=$a(t.e.ACCESS_TOKEN),f="";return f=a&&a.u?t.k(a.u):t.e.ACCESS_TOKEN||"",i?`${dl}.${i}:${f}`:`${dl}:${f}`}fetchEventData(){let i=t.s("localStorage"),a=this.getStorageKey(),f=this.getStorageKey("uuid");if(i)try{let g=localStorage.getItem(a);g&&(this.eventData=JSON.parse(g));let v=localStorage.getItem(f);v&&(this.anonId=v)}catch{t.w("Unable to read from LocalStorage")}}saveEventData(){let i=t.s("localStorage"),a=this.getStorageKey(),f=this.getStorageKey("uuid"),g=this.anonId;if(i&&g)try{localStorage.setItem(f,g),Object.keys(this.eventData).length>=1&&localStorage.setItem(a,JSON.stringify(this.eventData))}catch{t.w("Unable to write to LocalStorage")}}processRequests(i){}postEvent(i,a,f,g){if(!t.e.EVENTS_URL)return;let v=ss(t.e.EVENTS_URL);v.params.push(`access_token=${g||t.e.ACCESS_TOKEN||""}`);let S={event:this.type,created:new Date(i).toISOString()},C=a?t.l(S,a):S,z={url:ya(v),headers:{"Content-Type":"text/plain"},body:JSON.stringify([C])};this.pendingRequest=t.p(z,N=>{this.pendingRequest=null,f(N),this.saveEventData(),this.processRequests(g)})}queueRequest(i,a){this.queue.push(i),this.processRequests(a)}}let as=new class extends Mr{constructor(p){super("appUserTurnstile"),this._customAccessToken=p}postTurnstileEvent(p,i){t.e.EVENTS_URL&&t.e.ACCESS_TOKEN&&Array.isArray(p)&&p.some(a=>t.f(a)||t.h(a))&&this.queueRequest(Date.now(),i)}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();let i=$a(t.e.ACCESS_TOKEN),a=i?i.u:t.e.ACCESS_TOKEN,f=a!==this.eventData.tokenU;t.v(this.anonId)||(this.anonId=t.u(),f=!0);let g=this.queue.shift();if(this.eventData.lastSuccess){let v=new Date(this.eventData.lastSuccess),S=new Date(g),C=(g-this.eventData.lastSuccess)/864e5;f=f||C>=1||C<-1||v.getDate()!==S.getDate()}else f=!0;f?this.postEvent(g,{sdkIdentifier:"mapbox-gl-js",sdkVersion:at,skuId:qa,"enabled.telemetry":!1,userId:this.anonId},v=>{v||(this.eventData.lastSuccess=g,this.eventData.tokenU=a)},p):this.processRequests()}},Hr=as.postTurnstileEvent.bind(as),Da=new class extends Mr{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(p,i,a,f){this.skuToken=i,this.errorCb=f,t.e.EVENTS_URL&&(a||t.e.ACCESS_TOKEN?this.queueRequest({id:p,timestamp:Date.now()},a):this.errorCb(new Error(No)))}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;let{id:i,timestamp:a}=this.queue.shift();i&&this.success[i]||(this.anonId||this.fetchEventData(),t.v(this.anonId)||(this.anonId=t.u()),this.postEvent(a,{sdkIdentifier:"mapbox-gl-js",sdkVersion:at,skuId:qa,skuToken:this.skuToken,userId:this.anonId},f=>{f?this.errorCb(f):i&&(this.success[i]=!0)},p))}remove(){this.errorCb=null}},xa=Da.postMapLoadEvent.bind(Da),Lr=new class extends Mr{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(p){let i=this.mapInstanceIdMap.get(p);return i||(i=t.u(),this.mapInstanceIdMap.set(p,i)),i}getEventId(p){let i=this.eventIdPerMapInstanceMap.get(p)||0;return this.eventIdPerMapInstanceMap.set(p,i+1),i}postStyleLoadEvent(p,i){let{map:a,style:f,importedStyles:g}=i;if(!t.e.EVENTS_URL||!p&&!t.e.ACCESS_TOKEN)return;let v=this.getMapInstanceId(a),S={mapInstanceId:v,eventId:this.getEventId(v),style:f};g.length&&(S.importedStyles=g),this.queueRequest({timestamp:Date.now(),payload:S},p)}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:i,payload:a}=this.queue.shift();this.postEvent(i,a,()=>{},p)}},jr=Lr.postStyleLoadEvent.bind(Lr),Co=new class extends Mr{constructor(){super("gljs.performance")}postPerformanceEvent(p,i){t.e.EVENTS_URL&&(p||t.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:i},p)}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:i,performanceData:a}=this.queue.shift(),f=function(g){let v=performance.getEntriesByType("resource"),S=performance.getEntriesByType("mark"),C=function(X){let se={};if(X){for(let re in X)if(re!=="other")for(let he of X[re]){let ae=`${re}ResolveRangeMin`,be=`${re}ResolveRangeMax`,Pe=`${re}RequestCount`,Re=`${re}RequestCachedCount`;se[ae]=Math.min(se[ae]||1/0,he.startTime),se[be]=Math.max(se[be]||-1/0,he.responseEnd);let Ge=Ne=>{se[Ne]===void 0&&(se[Ne]=0),++se[Ne]};he.transferSize!==void 0&&he.transferSize===0&&Ge(Re),Ge(Pe)}}return se}(function(X,se){let re={};if(X)for(let he of X){let ae=se(he);re[ae]===void 0&&(re[ae]=[]),re[ae].push(he)}return re}(v,_r)),z=window.devicePixelRatio,N=navigator.connection||navigator.mozConnection||navigator.webkitConnection,U=N?N.effectiveType:void 0,$={counters:[],metadata:[],attributes:[]},Z=(X,se,re)=>{re!=null&&X.push({name:se,value:re.toString()})};for(let X in C)Z($.counters,X,C[X]);if(g.interactionRange[0]!==1/0&&g.interactionRange[1]!==-1/0&&(Z($.counters,"interactionRangeMin",g.interactionRange[0]),Z($.counters,"interactionRangeMax",g.interactionRange[1])),S)for(let X of Object.keys(yi)){let se=yi[X],re=S.find(he=>he.name===se);re&&Z($.counters,se,re.startTime)}return Z($.counters,"visibilityHidden",g.visibilityHidden),Z($.attributes,"style",function(X){if(X)for(let se of X){let re=se.name.split("?")[0];if(t.i(re)){let he=re.split("/").slice(-2);if(he.length===2)return`mapbox://styles/${he[0]}/${he[1]}`}}}(v)),Z($.attributes,"terrainEnabled",g.terrainEnabled?"true":"false"),Z($.attributes,"fogEnabled",g.fogEnabled?"true":"false"),Z($.attributes,"projection",g.projection),Z($.attributes,"zoom",g.zoom),Z($.metadata,"devicePixelRatio",z),Z($.metadata,"connectionEffectiveType",U),Z($.metadata,"navigatorUserAgent",navigator.userAgent),Z($.metadata,"screenWidth",window.screen.width),Z($.metadata,"screenHeight",window.screen.height),Z($.metadata,"windowWidth",window.innerWidth),Z($.metadata,"windowHeight",window.innerHeight),Z($.metadata,"mapWidth",g.width/z),Z($.metadata,"mapHeight",g.height/z),Z($.metadata,"webglRenderer",g.renderer),Z($.metadata,"webglVendor",g.vendor),Z($.metadata,"sdkVersion",at),Z($.metadata,"sdkIdentifier","mapbox-gl-js"),$}(a);for(let g of f.metadata);for(let g of f.counters);for(let g of f.attributes);this.postEvent(i,f,()=>{},p)}},$c=Co.postPerformanceEvent.bind(Co),gr=new class extends Mr{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(p,i,a,f){if(!t.e.API_URL||!t.e.SESSION_PATH)return;let g=ss(t.e.API_URL+t.e.SESSION_PATH);g.params.push(`sku=${i||""}`),g.params.push(`access_token=${f||t.e.ACCESS_TOKEN||""}`);let v={url:ya(g),headers:{"Content-Type":"text/plain"}};this.pendingRequest=t.g(v,S=>{this.pendingRequest=null,a(S),this.saveEventData(),this.processRequests(f)})}getSessionAPI(p,i,a,f){this.skuToken=i,this.errorCb=f,t.e.SESSION_PATH&&t.e.API_URL&&(a||t.e.ACCESS_TOKEN?this.queueRequest({id:p,timestamp:Date.now()},a):this.errorCb(new Error(No)))}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;let{id:i,timestamp:a}=this.queue.shift();i&&this.success[i]||this.getSession(a,this.skuToken,f=>{f?this.errorCb(f):i&&(this.success[i]=!0)},p)}remove(){this.errorCb=null}},yc=gr.getSessionAPI.bind(gr),Os=new Set;function va(p,i){i?Os.add(p):Os.delete(p)}class hr{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(i,a){this._updatedSourceCaches[i]=a,this.setDirty()}discardSourceCacheUpdate(i){delete this._updatedSourceCaches[i]}updateLayer(i){let a=i.scope;this._updatedLayers[a]=this._updatedLayers[a]||new Set,this._updatedLayers[a].add(i.id),this.setDirty()}removeLayer(i){let a=i.scope;this._removedLayers[a]=this._removedLayers[a]||{},this._updatedLayers[a]=this._updatedLayers[a]||new Set,this._removedLayers[a][i.id]=i,this._updatedLayers[a].delete(i.id),this._updatedPaintProps.delete(i.fqid),this.setDirty()}getRemovedLayer(i){return this._removedLayers[i.scope]?this._removedLayers[i.scope][i.id]:null}discardLayerRemoval(i){this._removedLayers[i.scope]&&delete this._removedLayers[i.scope][i.id]}getLayerUpdatesByScope(){let i={};for(let a in this._updatedLayers)i[a]=i[a]||{},i[a].updatedIds=Array.from(this._updatedLayers[a].values());for(let a in this._removedLayers)i[a]=i[a]||{},i[a].removedIds=Object.keys(this._removedLayers[a]);return i}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(i){this._updatedPaintProps.add(i.fqid),this.setDirty()}getUpdatedImages(i){return this._updatedImages[i]?Array.from(this._updatedImages[i].values()):[]}updateImage(i,a){this._updatedImages[a]=this._updatedImages[a]||new Set,this._updatedImages[a].add(t.I.toString(i)),this.setDirty()}resetUpdatedImages(i){this._updatedImages[i]&&this._updatedImages[i].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function Cl(p){let{userImage:i}=p;return!!(i&&i.render&&i.render())&&(p.data.replace(new Uint8Array(i.data.buffer)),!0)}class ra extends t.E{constructor(i){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=i,i!=="raster"&&t.t()&&(this.imageRasterizerDispatcher=new t.D(t.x(),this,"Image Rasterizer Worker",1))}addScope(i){this.loaded.set(i,!1),this.imageProviders.set(i,new Map),this.images.set(i,new Map),this.updatedImages.set(i,new Set),this.callbackDispatchedThisFrame.set(i,new Set),this.patterns.set(i,new Map),this.atlasImage.set(i,new t.r({width:1,height:1}))}removeScope(i){this.loaded.delete(i),this.imageProviders.delete(i),this.images.delete(i),this.updatedImages.delete(i),this.callbackDispatchedThisFrame.delete(i),this.patterns.delete(i),this.atlasImage.delete(i);let a=this.atlasTexture.get(i);a&&(a.destroy(),this.atlasTexture.delete(i))}addImageProvider(i,a){this.imageProviders.has(a)||this.imageProviders.set(a,new Map),this.imageProviders.get(a).set(i.id,i)}removeImageProvider(i,a){this.imageProviders.has(a)&&this.imageProviders.get(a).delete(i)}getPendingImageProviders(){let i=[];for(let a of this.imageProviders.values())for(let f of a.values())f.hasPendingRequests()&&i.push(f);return i}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new t.y),this._imageRasterizer}isLoaded(){for(let i of this.loaded.keys())if(!this.loaded.get(i))return!1;return!0}setLoaded(i,a){if(this.loaded.get(a)!==i&&(this.loaded.set(a,i),i)){for(let{ids:f,callback:g}of this.requestors)this._notify(f,a,g);this.requestors=[]}}hasImage(i,a){return!!this.getImage(i,a)}getImage(i,a){return this.images.get(a).get(i.toString())}addImage(i,a,f){this._validate(i,f)&&this.images.get(a).set(i.toString(),f)}_validate(i,a){let f=!0;return this._validateStretch(a.stretchX,a.data&&a.data.width)||(this.fire(new t.z(new Error(`Image "${i.name}" has invalid "stretchX" value`))),f=!1),this._validateStretch(a.stretchY,a.data&&a.data.height)||(this.fire(new t.z(new Error(`Image "${i.name}" has invalid "stretchY" value`))),f=!1),this._validateContent(a.content,a)||(this.fire(new t.z(new Error(`Image "${i.name}" has invalid "content" value`))),f=!1),f}_validateStretch(i,a){if(!i)return!0;let f=0;for(let g of i){if(g[0]<f||g[1]<g[0]||a<g[1])return!1;f=g[1]}return!0}_validateContent(i,a){return i?i.length!==4||!a.usvg&&(i[0]<0||a.data.width<i[0]||i[1]<0||a.data.height<i[1]||i[2]<0||a.data.width<i[2]||i[3]<0||a.data.height<i[3])?!1:!(i[2]<i[0]||i[3]<i[1]):!0}updateImage(i,a,f){let g=this.images.get(a).get(i.toString());f.version=g.version+1,this.images.get(a).set(i.toString(),f),this.updatedImages.get(a).add(i),this.removeFromImageRasterizerCache(i,a)}clearUpdatedImages(i){this.updatedImages.get(i).clear()}removeFromImageRasterizerCache(i,a){this.spriteFormat!=="raster"&&(t.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[i],scope:a}):this.imageRasterizer.removeImagesFromCacheByIds([i],a))}removeImage(i,a){let f=this.images.get(a),g=f.get(i.toString());f.delete(i.toString()),this.patterns.get(a).delete(i.toString()),this.removeFromImageRasterizerCache(i,a),g.userImage&&g.userImage.onRemove&&g.userImage.onRemove()}listImages(i){return Array.from(this.images.get(i).keys()).map(a=>t.I.from(a))}getImages(i,a,f){let g=[],v=[],S=this.imageProviders.get(a);for(let U of i){if(!U.iconsetId){g.push(U);continue}let $=S.get(U.iconsetId);$&&(this.getImage(U,a)?v.push(U):$.addPendingRequest(U))}if(g.length===0)return void this._notify(v,a,f);let C=!0,z=!!this.loaded.get(a),N=this.images.get(a);if(!z)for(let U of g)N.has(U.toString())||(C=!1);z||C?this._notify(g,a,f):this.requestors.push({ids:g,scope:a,callback:f})}rasterizeImages(i,a){let f=new Map,{tasks:g,scope:v}=i;for(let[S,C]of g.entries()){let z=this.getImage(C.id,v);z&&f.set(S,{image:z,imageVariant:C})}this._rasterizeImages(v,f,a)}_rasterizeImages(i,a,f){if(t.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:a,scope:i},f);else{let g=new Map;for(let[v,{image:S,imageVariant:C}]of a.entries())g.set(v,this.imageRasterizer.rasterize(C,S,i,0));f(void 0,g)}}getUpdatedImages(i){return this.updatedImages.get(i)||new Set}_notify(i,a,f){let g=this.images.get(a),v=new Map;for(let S of i){if(!g.get(S.toString())){if(S.iconsetId)continue;this.fire(new t.A("styleimagemissing",{id:S.name}))}let C=g.get(S.toString());if(!C){t.w(`Image "${S.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}let z={data:C.usvg?null:C.data.clone(),pixelRatio:C.pixelRatio,sdf:C.sdf,usvg:C.usvg,version:C.version,stretchX:C.stretchX,stretchY:C.stretchY,content:C.content,hasRenderCallback:!!(C.userImage&&C.userImage.render)};C.usvg&&Object.assign(z,{width:C.icon.usvg_tree.width,height:C.icon.usvg_tree.height}),v.set(t.I.toString(S),z)}f(null,v)}getPixelSize(i){let{width:a,height:f}=this.atlasImage.get(i);return{width:a,height:f}}getPattern(i,a,f){let g=i.toString(),v=this.patterns.get(a),S=v.get(g),C=this.getImage(i,a);if(!C)return null;if(S){if(S.position.version===C.version)return S.position;S.position.version=C.version}else{if(C.usvg&&!C.data){let z=this.getPatternInFlightId(g,a);if(this.patternsInFlight.has(z))return null;this.patternsInFlight.add(z);let N=new t.B(i).scaleSelf(t.q.devicePixelRatio),U=new Map([[N.toString(),{image:C,imageVariant:N}]]);return this._rasterizeImages(a,U,($,Z)=>this.storePatternImage(N,a,C,f,Z)),null}this.storePattern(i,a,C)}return this._updatePatternAtlas(a,f),v.get(g).position}getPatternInFlightId(i,a){return t.C(i,a)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(i,a,f,g,v){let S=i.toString(),C=v?v.get(S):void 0;C&&(f.data=C,this.storePattern(i.id,a,f),this._updatePatternAtlas(a,g),this.patternsInFlight.delete(this.getPatternInFlightId(i.id.toString(),a)))}storePattern(i,a,f){let g={w:f.data.width+2*t.F,h:f.data.height+2*t.F,x:0,y:0},v=new t.G(g,f,t.F);this.patterns.get(a).set(i.toString(),{bin:g,position:v})}bind(i,a){let f=i.gl,g=this.atlasTexture.get(a);g?this.dirty&&(g.update(this.atlasImage.get(a)),this.dirty=!1):(g=new t.T(i,this.atlasImage.get(a),f.RGBA8),this.atlasTexture.set(a,g)),g.bind(f.LINEAR,f.CLAMP_TO_EDGE)}_updatePatternAtlas(i,a){let f=this.patterns.get(i),g=Array.from(f.values()).map(({bin:N})=>N),{w:v,h:S}=t.H(g),C=this.atlasImage.get(i);C.resize({width:v||1,height:S||1});let z=this.images.get(i);for(let[N,{bin:U,position:$}]of f.entries()){let Z=$.padding,X=U.x+Z,se=U.y+Z,re=z.get(N).data,he=re.width,ae=re.height;Z=Z>1?Z-1:Z,t.r.copy(re,C,{x:0,y:0},{x:X,y:se},{width:he,height:ae},a),t.r.copy(re,C,{x:0,y:ae-Z},{x:X,y:se-Z},{width:he,height:Z},a),t.r.copy(re,C,{x:0,y:0},{x:X,y:se+ae},{width:he,height:Z},a),t.r.copy(re,C,{x:he-Z,y:0},{x:X-Z,y:se},{width:Z,height:ae},a),t.r.copy(re,C,{x:0,y:0},{x:X+he,y:se},{width:Z,height:ae},a),t.r.copy(re,C,{x:he-Z,y:ae-Z},{x:X-Z,y:se-Z},{width:Z,height:Z},a),t.r.copy(re,C,{x:0,y:ae-Z},{x:X+he,y:se-Z},{width:Z,height:Z},a),t.r.copy(re,C,{x:0,y:0},{x:X+he,y:se+ae},{width:Z,height:Z},a),t.r.copy(re,C,{x:he-Z,y:0},{x:X-Z,y:se+ae},{width:Z,height:Z},a)}this.dirty=!0}beginFrame(){for(let i of this.images.keys())this.callbackDispatchedThisFrame.set(i,new Set)}dispatchRenderCallbacks(i,a){let f=this.images.get(a);for(let g of i){if(this.callbackDispatchedThisFrame.get(a).has(g.toString()))continue;this.callbackDispatchedThisFrame.get(a).add(g.toString());let v=f.get(g.toString());Cl(v)&&this.updateImage(g,a,v)}}}function Cs(p){let i=p.key,a=p.value,f=p.valueSpec||{},g=p.objectElementValidators||{},v=p.style,S=p.styleSpec,C=[],z=t.K(a);if(z!=="object")return[new t.V(i,a,`object expected, ${z} found`)];for(let N in a){let U=N.split(".")[0],$;g[U]?$=g[U]:f[U]?$=Tt:g["*"]?$=g["*"]:f["*"]&&($=Tt),$?C=C.concat($({key:(i&&`${i}.`)+N,value:a[N],valueSpec:f[U]||f["*"],style:v,styleSpec:S,object:a,objectKey:N},a)):C.push(new t.J(i,a[N],`unknown property "${N}"`))}for(let N in f)g[N]||f[N].required&&f[N].default===void 0&&a[N]===void 0&&C.push(new t.V(i,a,`missing required property "${N}"`));return C}function Jo(p){let i=p.value,a=p.valueSpec,f=p.style,g=p.styleSpec,v=p.key,S=p.arrayElementValidator||Tt;if(t.K(i)!=="array")return[new t.V(v,i,`array expected, ${t.K(i)} found`)];if(a.length&&i.length!==a.length)return[new t.V(v,i,`array length ${a.length} expected, length ${i.length} found`)];if(a["min-length"]&&i.length<a["min-length"])return[new t.V(v,i,`array length at least ${a["min-length"]} expected, length ${i.length} found`)];let C={type:a.value,values:a.values,minimum:a.minimum,maximum:a.maximum,function:void 0};g.$version<7&&(C.function=a.function),t.K(a.value)==="object"&&(C=a.value);let z=[];for(let N=0;N<i.length;N++)z=z.concat(S({array:i,arrayIndex:N,value:i[N],valueSpec:C,style:f,styleSpec:g,key:`${v}[${N}]`},!0));return z}function Fs(p){let i=p.key,a=p.value,f=p.valueSpec,g=t.K(a);if(g==="number"&&a!=a&&(g="NaN"),g!=="number")return[new t.V(i,a,`number expected, ${g} found`)];if("minimum"in f){let v=f.minimum;if(t.K(f.minimum)==="array"&&(v=f.minimum[p.arrayIndex]),a<v)return[new t.V(i,a,`${a} is less than the minimum value ${v}`)]}if("maximum"in f){let v=f.maximum;if(t.K(f.maximum)==="array"&&(v=f.maximum[p.arrayIndex]),a>v)return[new t.V(i,a,`${a} is greater than the maximum value ${v}`)]}return[]}function Vo(p){let i=p.valueSpec,a=t.M(p.value.type),f,g,v,S={},C=a!=="categorical"&&p.value.property===void 0,z=!C,N=t.K(p.value.stops)==="array"&&t.K(p.value.stops[0])==="array"&&t.K(p.value.stops[0][0])==="object",U=Cs({key:p.key,value:p.value,valueSpec:p.styleSpec.function,style:p.style,styleSpec:p.styleSpec,objectElementValidators:{stops:function(X){if(a==="identity")return[new t.V(X.key,X.value,'identity function may not have a "stops" property')];let se=[],re=X.value;return se=se.concat(Jo({key:X.key,value:re,valueSpec:X.valueSpec,style:X.style,styleSpec:X.styleSpec,arrayElementValidator:$})),t.K(re)==="array"&&re.length===0&&se.push(new t.V(X.key,re,"array must have at least one stop")),se},default:function(X){return Tt({key:X.key,value:X.value,valueSpec:i,style:X.style,styleSpec:X.styleSpec})}}});return a==="identity"&&C&&U.push(new t.V(p.key,p.value,'missing required property "property"')),a==="identity"||p.value.stops||U.push(new t.V(p.key,p.value,'missing required property "stops"')),a==="exponential"&&p.valueSpec.expression&&!t.N(p.valueSpec)&&U.push(new t.V(p.key,p.value,"exponential functions not supported")),p.styleSpec.$version>=8&&(z&&!t.O(p.valueSpec)?U.push(new t.V(p.key,p.value,"property functions not supported")):C&&!t.Q(p.valueSpec)&&U.push(new t.V(p.key,p.value,"zoom functions not supported"))),a!=="categorical"&&!N||p.value.property!==void 0||U.push(new t.V(p.key,p.value,'"property" property is required')),U;function $(X){let se=[],re=X.value,he=X.key;if(t.K(re)!=="array")return[new t.V(he,re,`array expected, ${t.K(re)} found`)];if(re.length!==2)return[new t.V(he,re,`array length 2 expected, length ${re.length} found`)];if(N){if(t.K(re[0])!=="object")return[new t.V(he,re,`object expected, ${t.K(re[0])} found`)];if(re[0].zoom===void 0)return[new t.V(he,re,"object stop key must have zoom")];if(re[0].value===void 0)return[new t.V(he,re,"object stop key must have value")];let ae=t.M(re[0].zoom);if(typeof ae!="number")return[new t.V(he,re[0].zoom,"stop zoom values must be numbers")];if(v&&v>ae)return[new t.V(he,re[0].zoom,"stop zoom values must appear in ascending order")];ae!==v&&(v=ae,g=void 0,S={}),se=se.concat(Cs({key:`${he}[0]`,value:re[0],valueSpec:{zoom:{}},style:X.style,styleSpec:X.styleSpec,objectElementValidators:{zoom:Fs,value:Z}}))}else se=se.concat(Z({key:`${he}[0]`,value:re[0],valueSpec:{},style:X.style,styleSpec:X.styleSpec},re));return t.S(t.U(re[1]))?se.concat([new t.V(`${he}[1]`,re[1],"expressions are not allowed in function stops.")]):se.concat(Tt({key:`${he}[1]`,value:re[1],valueSpec:i,style:X.style,styleSpec:X.styleSpec}))}function Z(X,se){let re=t.K(X.value),he=t.M(X.value),ae=X.value!==null?X.value:se;if(f){if(re!==f)return[new t.V(X.key,ae,`${re} stop domain type must match previous stop domain type ${f}`)]}else f=re;if(re!=="number"&&re!=="string"&&re!=="boolean"&&typeof he!="number"&&typeof he!="string"&&typeof he!="boolean")return[new t.V(X.key,ae,"stop domain value must be a number, string, or boolean")];if(re!=="number"&&a!=="categorical"){let be=`number expected, ${re} found`;return t.O(i)&&a===void 0&&(be+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new t.V(X.key,ae,be)]}return a!=="categorical"||re!=="number"||typeof he=="number"&&isFinite(he)&&Math.floor(he)===he?a!=="categorical"&&re==="number"&&typeof he=="number"&&typeof g=="number"&&g!==void 0&&he<g?[new t.V(X.key,ae,"stop domain values must appear in ascending order")]:(g=he,a==="categorical"&&he in S?[new t.V(X.key,ae,"stop domain values must be unique")]:(S[he]=!0,[])):[new t.V(X.key,ae,`integer expected, found ${String(he)}`)]}}function ba(p){let i=(p.expressionContext==="property"?t.W:t.X)(t.U(p.value),p.valueSpec);if(i.result==="error")return i.value.map(f=>new t.V(`${p.key}${f.key}`,p.value,f.message));let a=i.value.expression||i.value._styleExpression.expression;if(p.expressionContext==="property"&&p.propertyKey==="text-font"&&!a.outputDefined())return[new t.V(p.key,p.value,`Invalid data expression for "${p.propertyKey}". Output values must be contained as literals within the expression.`)];if(p.expressionContext==="property"&&p.propertyType==="layout"&&!t.Y(a))return[new t.V(p.key,p.value,'"feature-state" data expressions are not supported with layout properties.')];if(p.expressionContext==="filter")return Wa(a,p);if(p.expressionContext&&p.expressionContext.indexOf("cluster")===0){if(!t.Z(a,["zoom","feature-state"]))return[new t.V(p.key,p.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(p.expressionContext==="cluster-initial"&&!t._(a))return[new t.V(p.key,p.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Wa(p,i){let a=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(i.valueSpec&&i.valueSpec.expression)for(let g of i.valueSpec.expression.parameters)a.delete(g);if(a.size===0)return[];let f=[];return p instanceof t.$&&a.has(p.name)?[new t.V(i.key,i.value,`["${p.name}"] expression is not supported in a filter for a ${i.object.type} layer with id: ${i.object.id}`)]:(p.eachChild(g=>{f.push(...Wa(g,i))}),f)}function pl(p){let i=p.key,a=p.value,f=p.valueSpec,g=[];return Array.isArray(f.values)?f.values.indexOf(t.M(a))===-1&&g.push(new t.V(i,a,`expected one of [${f.values.join(", ")}], ${JSON.stringify(a)} found`)):Object.keys(f.values).indexOf(t.M(a))===-1&&g.push(new t.V(i,a,`expected one of [${Object.keys(f.values).join(", ")}], ${JSON.stringify(a)} found`)),g}function fl(p){return t.a1(t.U(p.value))?ba(t.L({},p,{expressionContext:"filter",valueSpec:p.styleSpec[`filter_${p.layerType||"fill"}`]})):fs(p)}function fs(p){let i=p.value,a=p.key;if(t.K(i)!=="array")return[new t.V(a,i,`array expected, ${t.K(i)} found`)];let f=p.styleSpec,g,v=[];if(i.length<1)return[new t.V(a,i,"filter array must have at least 1 element")];switch(v=v.concat(pl({key:`${a}[0]`,value:i[0],valueSpec:f.filter_operator,style:p.style,styleSpec:p.styleSpec})),t.M(i[0])){case"<":case"<=":case">":case">=":i.length>=2&&t.M(i[1])==="$type"&&v.push(new t.V(a,i,`"$type" cannot be use with operator "${i[0]}"`));case"==":case"!=":i.length!==3&&v.push(new t.V(a,i,`filter array for operator "${i[0]}" must have 3 elements`));case"in":case"!in":i.length>=2&&(g=t.K(i[1]),g!=="string"&&v.push(new t.V(`${a}[1]`,i[1],`string expected, ${g} found`)));for(let S=2;S<i.length;S++)g=t.K(i[S]),t.M(i[1])==="$type"?v=v.concat(pl({key:`${a}[${S}]`,value:i[S],valueSpec:f.geometry_type,style:p.style,styleSpec:p.styleSpec})):g!=="string"&&g!=="number"&&g!=="boolean"&&v.push(new t.V(`${a}[${S}]`,i[S],`string, number, or boolean expected, ${g} found`));break;case"any":case"all":case"none":for(let S=1;S<i.length;S++)v=v.concat(fs({key:`${a}[${S}]`,value:i[S],style:p.style,styleSpec:p.styleSpec}));break;case"has":case"!has":g=t.K(i[1]),i.length!==2?v.push(new t.V(a,i,`filter array for "${i[0]}" operator must have 2 elements`)):g!=="string"&&v.push(new t.V(`${a}[1]`,i[1],`string expected, ${g} found`))}return v}function Ws(p,i){let a=p.key,f=p.style,g=p.layer,v=p.styleSpec,S=p.value,C=p.objectKey,z=v[`${i}_${p.layerType}`];if(!z)return[];let N=C.match(/^(.*)-use-theme$/);if(i==="paint"&&N&&z[N[1]])return t.S(S)?[].concat(Tt({key:p.key,value:S,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:f,styleSpec:v,expressionContext:"property",propertyType:i,propertyKey:C})):Tt({key:a,value:S,valueSpec:{type:"string"},style:f,styleSpec:v});let U=C.match(/^(.*)-transition$/);if(i==="paint"&&U&&z[U[1]]&&z[U[1]].transition)return Tt({key:a,value:S,valueSpec:v.transition,style:f,styleSpec:v});let $=p.valueSpec||z[C];if(!$)return[new t.J(a,S,`unknown property "${C}"`)];let Z;if(t.K(S)==="string"&&t.O($)&&!$.tokens&&(Z=/^{([^}]+)}$/.exec(S))){let se=`\`{ "type": "identity", "property": ${Z?JSON.stringify(Z[1]):'"_"'} }\``;return[new t.V(a,S,`"${C}" does not support interpolation syntax
Use an identity property function instead: ${se}.`)]}let X=[];if(p.layerType==="symbol")C!=="text-field"||!f||f.glyphs||f.imports||X.push(new t.V(a,S,'use of "text-field" requires a style "glyphs" property')),C==="text-font"&&t.a2(t.U(S))&&t.M(S.type)==="identity"&&X.push(new t.V(a,S,'"text-font" does not support identity functions'));else if(p.layerType==="model"&&i==="paint"&&g&&g.layout&&g.layout.hasOwnProperty("model-id")&&t.O($)&&(t.a3($)||t.Q($))){let se=t.W(t.U(S),$),re=se.value.expression||se.value._styleExpression.expression;re&&!t.Z(re,["measure-light"])&&(C==="model-emissive-strength"&&t._(re)&&t.Y(re)||X.push(new t.V(a,S,`${C} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return X.concat(Tt({key:p.key,value:S,valueSpec:$,style:f,styleSpec:v,expressionContext:"property",propertyType:i,propertyKey:C}))}function ml(p){return Ws(p,"paint")}function Hs(p){return Ws(p,"layout")}function Ha(p){let i=[],a=p.value,f=p.key,g=p.style,v=p.styleSpec;a.type||a.ref||i.push(new t.V(f,a,'either "type" or "ref" is required'));let S=t.M(a.type),C=t.M(a.ref);if(a.id){let z=t.M(a.id);for(let N=0;N<p.arrayIndex;N++){let U=g.layers[N];t.M(U.id)===z&&i.push(new t.V(f,a.id,`duplicate layer id "${a.id}", previously used at line ${U.id.__line__}`))}}if("ref"in a){let z;["type","source","source-layer","filter","layout"].forEach(N=>{N in a&&i.push(new t.V(f,a[N],`"${N}" is prohibited for ref layers`))}),g.layers.forEach(N=>{t.M(N.id)===C&&(z=N)}),z?z.ref?i.push(new t.V(f,a.ref,"ref cannot reference another ref layer")):S=t.M(z.type):typeof C=="string"&&i.push(new t.V(f,a.ref,`ref layer "${C}" not found`))}else if(S!=="background"&&S!=="sky"&&S!=="slot")if(a.source){let z=g.sources&&g.sources[a.source],N=z&&t.M(z.type);z?N==="vector"&&S==="raster"?i.push(new t.V(f,a.source,`layer "${a.id}" requires a raster source`)):N==="raster"&&S!=="raster"?i.push(new t.V(f,a.source,`layer "${a.id}" requires a vector source`)):N!=="vector"||a["source-layer"]?N==="raster-dem"&&S!=="hillshade"?i.push(new t.V(f,a.source,"raster-dem source can only be used with layer type 'hillshade'.")):N!=="raster-array"||["raster","raster-particle"].includes(S)?S==="line"&&a.paint&&(a.paint["line-gradient"]||a.paint["line-trim-offset"])&&N==="geojson"&&!z.lineMetrics?i.push(new t.V(f,a,`layer "${a.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):S==="raster-particle"&&N!=="raster-array"&&i.push(new t.V(f,a.source,`layer "${a.id}" requires a 'raster-array' source.`)):i.push(new t.V(f,a.source,"raster-array source can only be used with layer type 'raster'.")):i.push(new t.V(f,a,`layer "${a.id}" must specify a "source-layer"`)):i.push(new t.V(f,a.source,`source "${a.source}" not found`))}else i.push(new t.V(f,a,'missing required property "source"'));return i=i.concat(Cs({key:f,value:a,valueSpec:v.layer,style:p.style,styleSpec:p.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Tt({key:`${f}.type`,value:a.type,valueSpec:v.layer.type,style:p.style,styleSpec:p.styleSpec,object:a,objectKey:"type"}),filter:z=>fl(t.L({layerType:S},z)),layout:z=>Cs({layer:a,key:z.key,value:z.value,valueSpec:{},style:z.style,styleSpec:z.styleSpec,objectElementValidators:{"*":N=>Hs(t.L({layerType:S},N))}}),paint:z=>Cs({layer:a,key:z.key,value:z.value,valueSpec:{},style:z.style,styleSpec:z.styleSpec,objectElementValidators:{"*":N=>ml(t.L({layerType:S,layer:a},N))}})}})),i}function sl(p){let i=p.value,a=p.key,f=t.K(i);return f!=="string"?[new t.V(a,i,`string expected, ${f} found`)]:[]}let El={promoteId:function p({key:i,value:a}){if(t.K(a)==="string")return sl({key:i,value:a});if(Array.isArray(a)){let f=[],g=t.U(a),v=t.X(g);return v.result==="error"&&v.value.forEach(S=>{f.push(new t.V(`${i}${S.key}`,null,`${S.message}`))}),t.Z(v.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||f.push(new t.V(`${i}`,null,"promoteId expression should be only feature dependent")),f}{let f=[];for(let g in a)f.push(...p({key:`${i}.${g}`,value:a[g]}));return f}}};function ms(p){let i=p.value,a=p.key,f=p.styleSpec,g=p.style;if(!i.type)return[new t.V(a,i,'"type" is required')];let v=t.M(i.type),S=[];switch(["vector","raster","raster-dem","raster-array"].includes(v)&&(i.url||i.tiles||S.push(new t.J(a,i,'Either "url" or "tiles" is required.'))),v){case"vector":case"raster":case"raster-dem":case"raster-array":return S=S.concat(Cs({key:a,value:i,valueSpec:f[`source_${v.replace("-","_")}`],style:p.style,styleSpec:f,objectElementValidators:El})),S;case"geojson":if(S=Cs({key:a,value:i,valueSpec:f.source_geojson,style:g,styleSpec:f,objectElementValidators:El}),i.cluster)for(let C in i.clusterProperties){let[z,N]=i.clusterProperties[C],U=typeof z=="string"?[z,["accumulated"],["get",C]]:z;S.push(...ba({key:`${a}.${C}.map`,value:N,expressionContext:"cluster-map"})),S.push(...ba({key:`${a}.${C}.reduce`,value:U,expressionContext:"cluster-reduce"}))}return S;case"video":return Cs({key:a,value:i,valueSpec:f.source_video,style:g,styleSpec:f});case"image":return Cs({key:a,value:i,valueSpec:f.source_image,style:g,styleSpec:f});case"canvas":return[new t.V(a,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return pl({key:`${a}.type`,value:i.type,valueSpec:{values:Vt(f)},style:g,styleSpec:f})}}function Vt(p){return p.source.reduce((i,a)=>{let f=p[a];return f.type.type==="enum"&&(i=i.concat(Object.keys(f.type.values))),i},[])}function Le(p){let i=p.value,a=p.styleSpec,f=a.light,g=p.style,v=[],S=t.K(i);if(i===void 0)return v;if(S!=="object")return v=v.concat([new t.V("light",i,`object expected, ${S} found`)]),v;for(let C in i){let z=C.match(/^(.*)-transition$/),N=C.match(/^(.*)-use-theme$/);v=v.concat(N&&f[N[1]]?Tt({key:C,value:i[C],valueSpec:{type:"string"},style:g,styleSpec:a}):z&&f[z[1]]&&f[z[1]].transition?Tt({key:C,value:i[C],valueSpec:a.transition,style:g,styleSpec:a}):f[C]?Tt({key:C,value:i[C],valueSpec:f[C],style:g,styleSpec:a}):[new t.V(C,i[C],`unknown property "${C}"`)])}return v}function Fe(p){let i=p.value,a=[];if(!i)return a;let f=t.K(i);if(f!=="object")return a=a.concat([new t.V("light-3d",i,`object expected, ${f} found`)]),a;let g=p.styleSpec,v=g["light-3d"],S=p.key,C=p.style,z=p.style.lights;for(let $ of["type","id"])if(!($ in i))return a=a.concat([new t.V("light-3d",i,`missing property ${$} on light`)]),a;if(i.type&&z)for(let $=0;$<p.arrayIndex;$++){let Z=t.M(i.type),X=z[$];t.M(X.type)===Z&&a.push(new t.V(S,i.id,`duplicate light type "${i.type}", previously defined at line ${X.id.__line__}`))}let N=`properties_light_${i.type}`;if(!(N in g))return a=a.concat([new t.V("light-3d",i,`Invalid light type ${i.type}`)]),a;let U=g[N];for(let $ in i)if($==="properties"){let Z=i[$],X=t.K(Z);if(X!=="object")return a=a.concat([new t.V("properties",Z,`object expected, ${X} found`)]),a;for(let se in Z)a=a.concat(U[se]?Tt({key:se,value:Z[se],valueSpec:U[se],style:C,styleSpec:g}):[new t.J(p.key,Z[se],`unknown property "${se}"`)])}else{let Z=$.match(/^(.*)-transition$/),X=$.match(/^(.*)-use-theme$/);a=a.concat(X&&v[X[1]]?Tt({key:$,value:i[$],valueSpec:{type:"string"},style:C,styleSpec:g}):Z&&v[Z[1]]&&v[Z[1]].transition?Tt({key:$,value:i[$],valueSpec:g.transition,style:C,styleSpec:g}):v[$]?Tt({key:$,value:i[$],valueSpec:v[$],style:C,styleSpec:g}):[new t.J($,i[$],`unknown property "${$}"`)])}return a}function He(p){let i=p.value,a=p.key,f=p.style,g=p.styleSpec,v=g.terrain,S=[],C=t.K(i);if(i===void 0||C==="null")return S;if(C!=="object")return S=S.concat([new t.V("terrain",i,`object expected, ${C} found`)]),S;for(let z in i){let N=z.match(/^(.*)-transition$/),U=z.match(/^(.*)-use-theme$/);S=S.concat(U&&v[U[1]]?Tt({key:z,value:i[z],valueSpec:{type:"string"},style:f,styleSpec:g}):N&&v[N[1]]&&v[N[1]].transition?Tt({key:z,value:i[z],valueSpec:g.transition,style:f,styleSpec:g}):v[z]?Tt({key:z,value:i[z],valueSpec:v[z],style:f,styleSpec:g}):[new t.J(z,i[z],`unknown property "${z}"`)])}if(i.source){let z=f.sources&&f.sources[i.source],N=z&&t.M(z.type);z?N!=="raster-dem"&&S.push(new t.V(a,i.source,`terrain cannot be used with a source of type ${String(N)}, it only be used with a "raster-dem" source type`)):S.push(new t.V(a,i.source,`source "${i.source}" not found`))}else S.push(new t.V(a,i,'terrain is missing required property "source"'));return S}function mt(p){let i=p.value,a=p.style,f=p.styleSpec,g=f.fog,v=[],S=t.K(i);if(i===void 0)return v;if(S!=="object")return v=v.concat([new t.V("fog",i,`object expected, ${S} found`)]),v;for(let C in i){let z=C.match(/^(.*)-transition$/),N=C.match(/^(.*)-use-theme$/);v=v.concat(N&&g[N[1]]?Tt({key:C,value:i[C],valueSpec:{type:"string"},style:a,styleSpec:f}):z&&g[z[1]]&&g[z[1]].transition?Tt({key:C,value:i[C],valueSpec:f.transition,style:a,styleSpec:f}):g[C]?Tt({key:C,value:i[C],valueSpec:g[C],style:a,styleSpec:f}):[new t.J(C,i[C],`unknown property "${C}"`)])}return v}let St={"*":()=>[],array:Jo,boolean:function(p){let i=p.value,a=p.key,f=t.K(i);return f!=="boolean"?[new t.V(a,i,`boolean expected, ${f} found`)]:[]},number:Fs,color:function(p){let i=p.key,a=p.value,f=t.K(a);return f!=="string"?[new t.V(i,a,`color expected, ${f} found`)]:t.a0.parseCSSColor(a)===null?[new t.V(i,a,`color expected, "${a}" found`)]:[]},enum:pl,filter:fl,function:Vo,layer:Ha,object:Cs,source:ms,model:t.a4,light:Le,"light-3d":Fe,terrain:He,fog:mt,string:sl,formatted:function(p){return sl(p).length===0?[]:ba(p)},resolvedImage:function(p){return sl(p).length===0?[]:ba(p)},projection:function(p){let i=p.value,a=p.styleSpec,f=a.projection,g=p.style,v=[],S=t.K(i);if(S==="object")for(let C in i)v=v.concat(Tt({key:C,value:i[C],valueSpec:f[C],style:g,styleSpec:a}));else S!=="string"&&(v=v.concat([new t.V("projection",i,`object or string expected, ${S} found`)]));return v},import:function(p){let{value:i,styleSpec:a}=p,S=i,{data:f}=S,g=Qx(S,["data"]);Object.defineProperty(g,"__line__",{value:i.__line__,enumerable:!1});let v=Cs(t.L({},p,{value:g,valueSpec:a.import}));return t.M(g.id)===""&&v.push(new t.V(`${p.key}.id`,g,"import id can't be an empty string")),f&&(v=v.concat(Lt(f,a,{key:`${p.key}.data`}))),v},iconset:function(p){let i=p.value,a=p.key,f=p.styleSpec,g=p.style;if(!i.type)return[new t.V(a,i,'"type" is required')];let v=t.M(i.type),S=[];if(S=S.concat(Cs({key:a,value:i,valueSpec:f[`iconset_${v}`],style:g,styleSpec:f})),v==="source"&&i.source){let C=g.sources&&g.sources[i.source],z=C&&t.M(C.type);C?z!=="raster-array"&&S.push(new t.V(a,i.source,`iconset cannot be used with a source of type ${String(z)}, it only be used with a "raster-array" source type`)):S.push(new t.V(a,i.source,`source "${i.source}" not found`))}return S}};function Tt(p,i=!1){let a=p.value,f=p.valueSpec,g=p.styleSpec;if(f.expression&&t.a2(t.M(a)))return Vo(p);if(f.expression&&t.S(t.U(a)))return ba(p);if(f.type&&St[f.type]){let v=St[f.type](p);return i===!0&&v.length>0&&t.K(p.value)==="array"?ba(p):v}return Cs(t.L({},p,{valueSpec:f.type?g[f.type]:f}))}function Xt(p){let i=p.value,a=p.key,f=sl(p);return f.length||(i.indexOf("{fontstack}")===-1&&f.push(new t.V(a,i,'"glyphs" url must include a "{fontstack}" token')),i.indexOf("{range}")===-1&&f.push(new t.V(a,i,'"glyphs" url must include a "{range}" token'))),f}function Lt(p,i=t.a5,a={}){return Tt({key:a.key||"",value:p,valueSpec:i.$root,styleSpec:i,style:p,objectElementValidators:{glyphs:Xt,"*":()=>[]}})}function di(p,i=t.a5){return We(Lt(p,i))}let li=p=>We(ms(p)),Zt=p=>We(Le(p)),wi=p=>We(Fe(p)),Ue=p=>We(He(p)),Qi=p=>We(mt(p)),$n=p=>We(function(i){let a=i.value,f=i.style,g=i.styleSpec,v=g.snow,S=[],C=t.K(a);if(a===void 0)return S;if(C!=="object")return S=S.concat([new t.V("snow",a,`object expected, ${C} found`)]),S;for(let z in a){let N=z.match(/^(.*)-transition$/);S=S.concat(N&&v[N[1]]&&v[N[1]].transition?Tt({key:z,value:a[z],valueSpec:g.transition,style:f,styleSpec:g}):v[z]?Tt({key:z,value:a[z],valueSpec:v[z],style:f,styleSpec:g}):[new t.J(z,a[z],`unknown property "${z}"`)])}return S}(p)),ht=p=>We(function(i){let a=i.value,f=i.style,g=i.styleSpec,v=g.rain,S=[],C=t.K(a);if(a===void 0)return S;if(C!=="object")return S=S.concat([new t.V("rain",a,`object expected, ${C} found`)]),S;for(let z in a){let N=z.match(/^(.*)-transition$/);S=S.concat(N&&v[N[1]]&&v[N[1]].transition?Tt({key:z,value:a[z],valueSpec:g.transition,style:f,styleSpec:g}):v[z]?Tt({key:z,value:a[z],valueSpec:v[z],style:f,styleSpec:g}):[new t.J(z,a[z],`unknown property "${z}"`)])}return S}(p)),te=p=>We(Ha(p)),fe=p=>We(fl(p)),Ae=p=>We(ml(p)),qe=p=>We(Hs(p)),je=p=>We(t.a4(p));function We(p){return p.slice().sort((i,a)=>i.line&&a.line?i.line-a.line:0)}function rt(p,i){let a=!1;if(i&&i.length)for(let f of i)f instanceof t.J?t.w(f.message):(p.fire(new t.z(new Error(f.message))),a=!0);return a}let ct;class nt extends t.E{constructor(i,a="flat"){super(),this._transitionable=new t.a6(ct||(ct=new t.a7({anchor:new t.a8(t.a5.light.anchor),position:new t.a9(t.a5.light.position),color:new t.a8(t.a5.light.color),intensity:new t.a8(t.a5.light.intensity)}))),this.setLight(i,a),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(i,a,f={}){this._validate(Zt,i,f)||(this._transitionable.setTransitionOrValue(i),this.id=a)}updateTransitions(i){this._transitioning=this._transitionable.transitioned(i,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(i){this.properties=this._transitioning.possiblyEvaluate(i)}_validate(i,a,f){return(!f||f.validate!==!1)&&rt(this,i.call(di,t.l({value:a,style:{glyphs:!0,sprite:!0},styleSpec:t.a5})))}}let Ot=class extends t.E{constructor(p,i,a,f){super(),this.scope=a,this._transitionable=new t.a6(new t.a7({source:new t.a8(t.a5.terrain.source),exaggeration:new t.a8(t.a5.terrain.exaggeration)}),a,f),this._transitionable.setTransitionOrValue(p,f),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=i}get(){return this._transitionable.serialize()}set(p,i){this._transitionable.setTransitionOrValue(p,i)}updateTransitions(p){this._transitioning=this._transitionable.transitioned(p,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(p){this.properties=this._transitioning.possiblyEvaluate(p)}getExaggeration(p){return this._transitioning.possiblyEvaluate(new t.aa(p)).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;let p=this._transitionable._values.exaggeration;if(!p)return null;let i=p.value.expression;if(!i)return null;let a=-1,f=-1,g=1;for(let v of i.zoomStops)g=i.evaluate(new t.aa(v)),g>.01?(a=v,f=-1):f=v;return g<.01&&a>0&&f>a?[a,f]:null}isZoomDependent(){let p=this._transitionable._values.exaggeration;return p!=null&&p.value!=null&&p.value.expression!=null&&p.value.expression instanceof t.ab}},wt=45,_i=65,Ii=.05;function Bt(p,i,a,f){let g=t.af(wt,_i,a),[v,S]=Di(p,f),C=1-Math.min(1,Math.exp((i-v)/(S-v)*-6));return C*=C*C,C=Math.min(1,1.00747*C),C*g*p.alpha}function Di(p,i){let a=.5/Math.tan(.5*i);return[p.range[0]+a,p.range[1]+a]}function Ni(p,i,a,f,g){let v=t.ad([],[i,a,f],g.mercatorFogMatrix);return Bt(p,t.ae(v),g.pitch,g._fov)}function dn(p,i,a,f,g,v,S){let C=[[a,f,0],[g,f,0],[g,v,0],[a,v,0]],z=Number.MAX_VALUE,N=-Number.MAX_VALUE;for(let U of C){let $=t.ad([],U,i),Z=t.ae($);z=Math.min(z,Z),N=Math.max(N,Z)}return[Bt(p,z,S.pitch,S._fov),Bt(p,N,S.pitch,S._fov)]}class An extends t.E{constructor(i,a,f,g){super();let v=new t.a7({range:new t.a8(t.a5.fog.range),color:new t.a8(t.a5.fog.color),"color-use-theme":new t.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new t.a8(t.a5.fog["high-color"]),"high-color-use-theme":new t.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new t.a8(t.a5.fog["space-color"]),"space-color-use-theme":new t.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new t.a8(t.a5.fog["horizon-blend"]),"star-intensity":new t.a8(t.a5.fog["star-intensity"]),"vertical-range":new t.a8(t.a5.fog["vertical-range"])});this._transitionable=new t.a6(v,f,new Map(g)),this.set(i,g),this._transitioning=this._transitionable.untransitioned(),this._transform=a,this.properties=new t.ag(v),this.scope=f}get state(){let i=this._transform,a=i.projection.name==="globe",f=t.ah(i.zoom),g=this.properties.get("range"),v=[.5,3];return{range:a?[t.ai(v[0],g[0],f),t.ai(v[1],g[1],f)]:g,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(i,a,f={}){if(this._validate(Qi,i,f))return;let g=t.l({},i);for(let v of Object.keys(t.a5.fog))g[v]===void 0&&(g[v]=t.a5.fog[v].default);this._options=g,this._transitionable.setTransitionOrValue(this._options,a)}getOpacity(i){if(!this._transform.projection.supportsFog)return 0;let a=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:t.af(wt,_i,i))*a.a}getOpacityAtLatLng(i,a){return this._transform.projection.supportsFog?function(f,g,v){let S=t.ac.fromLngLat(g),C=v.elevation?v.elevation.getAtPointOrZero(S):0;return Ni(f,S.x,S.y,C,v)}(this.state,i,a):0}getOpacityForTile(i){if(!this._transform.projection.supportsFog)return[1,1];let a=this._transform.calculateFogTileMatrix(i.toUnwrapped());return dn(this.state,a,0,0,t.aj,t.aj,this._transform)}getOpacityForBounds(i,a,f,g,v){return this._transform.projection.supportsFog?dn(this.state,i,a,f,g,v,this._transform):[1,1]}getFovAdjustedRange(i){return this._transform.projection.supportsFog?Di(this.state,i):[0,1]}isVisibleOnFrustum(i){if(!this._transform.projection.supportsFog)return!1;let a=[4,5,6,7];for(let f of a){let g=i.points[f],v;if(g[2]>=0)v=g;else{let S=i.points[f-4];v=t.ak(S,g,S[2]/(S[2]-g[2]))}if(Ni(this.state,v[0],v[1],0,this._transform)>=Ii)return!0}return!1}updateConfig(i){this._transitionable.setTransitionOrValue(this._options,new Map(i))}updateTransitions(i){this._transitioning=this._transitionable.transitioned(i,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(i){this.properties=this._transitioning.possiblyEvaluate(i)}_validate(i,a,f){return(!f||f.validate!==!1)&&rt(this,i.call(di,t.l({value:a,style:{glyphs:!0,sprite:!0},styleSpec:t.a5})))}}let kr,Hi,yr,Jn,Un=class extends t.E{constructor(p,i,a,f){super();let g=kr||(kr=new t.a7({density:new t.a8(t.a5.snow.density),intensity:new t.a8(t.a5.snow.intensity),color:new t.a8(t.a5.snow.color),opacity:new t.a8(t.a5.snow.opacity),vignette:new t.a8(t.a5.snow.vignette),"vignette-color":new t.a8(t.a5.snow["vignette-color"]),"center-thinning":new t.a8(t.a5.snow["center-thinning"]),direction:new t.a8(t.a5.snow.direction),"flake-size":new t.a8(t.a5.snow["flake-size"])}));this._transitionable=new t.a6(g,a,new Map(f)),this.set(p,f),this._transitioning=this._transitionable.untransitioned(),this.properties=new t.ag(g),this.scope=a}get state(){let p=this.properties.get("opacity"),i=this.properties.get("color"),a=this.properties.get("direction"),f=t.al(a[0]),g=-Math.max(t.al(a[1]),.01),v=[Math.cos(f)*Math.cos(g),Math.sin(f)*Math.cos(g),Math.sin(g)],S=this.properties.get("vignette"),C=this.properties.get("vignette-color");return C.a=S,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new t.am(i.r,i.g,i.b,i.a*p),direction:v,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:C}}get(){return this._transitionable.serialize()}set(p,i,a={}){if(this._validate($n,p,a))return;let f=t.l({},p);for(let g of Object.keys(t.a5.snow))f[g]===void 0&&(f[g]=t.a5.snow[g].default);this._options=f,this._transitionable.setTransitionOrValue(this._options,i)}updateConfig(p){this._transitionable.setTransitionOrValue(this._options,new Map(p))}updateTransitions(p){this._transitioning=this._transitionable.transitioned(p,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(p){this.properties=this._transitioning.possiblyEvaluate(p)}_validate(p,i,a){return(!a||a.validate!==!1)&&rt(this,p.call(di,t.l({value:i,style:{glyphs:!0,sprite:!0},styleSpec:t.a5})))}},Ar=class extends t.E{constructor(p,i,a,f){super();let g=Hi||(Hi=new t.a7({density:new t.a8(t.a5.rain.density),intensity:new t.a8(t.a5.rain.intensity),color:new t.a8(t.a5.rain.color),opacity:new t.a8(t.a5.rain.opacity),vignette:new t.a8(t.a5.rain.vignette),"vignette-color":new t.a8(t.a5.rain["vignette-color"]),"center-thinning":new t.a8(t.a5.rain["center-thinning"]),direction:new t.a8(t.a5.rain.direction),"droplet-size":new t.a8(t.a5.rain["droplet-size"]),"distortion-strength":new t.a8(t.a5.rain["distortion-strength"])}));this._transitionable=new t.a6(g,a,new Map(f)),this.set(p,f),this._transitioning=this._transitionable.untransitioned(),this.properties=new t.ag(g),this.scope=a}get state(){let p=this.properties.get("opacity"),i=this.properties.get("color"),a=this.properties.get("direction"),f=t.al(a[0]),g=-Math.max(t.al(a[1]),.01),v=[Math.cos(f)*Math.cos(g),Math.sin(f)*Math.cos(g),Math.sin(g)],S=this.properties.get("vignette-color");return S.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new t.am(i.r,i.g,i.b,i.a*p),direction:v,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:S}}get(){return this._transitionable.serialize()}set(p,i,a={}){if(this._validate(ht,p,a))return;let f=t.l({},p);for(let g of Object.keys(t.a5.rain))f[g]===void 0&&(f[g]=t.a5.rain[g].default);this._options=f,this._transitionable.setTransitionOrValue(this._options,i)}updateConfig(p){this._transitionable.setTransitionOrValue(this._options,new Map(p))}updateTransitions(p){this._transitioning=this._transitionable.transitioned(p,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(p){this.properties=this._transitioning.possiblyEvaluate(p)}_validate(p,i,a){return(!a||a.validate!==!1)&&rt(this,p.call(di,t.l({value:i,style:{glyphs:!0,sprite:!0},styleSpec:t.a5})))}};class go extends t.E{constructor(i,a,f,g){super(),this.scope=f,this._options=i,this.properties=new t.ag(a),this._transitionable=new t.a6(a,f,new Map(g)),this._transitionable.setTransitionOrValue(i.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(i){this._transitionable.setTransitionOrValue(this._options.properties,new Map(i))}updateTransitions(i){this._transitioning=this._transitionable.transitioned(i,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(i){this.properties=this._transitioning.possiblyEvaluate(i)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(i,a){this._options=i,this._transitionable.setTransitionOrValue(i.properties,a)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class yo{constructor(i,a,f,g){this.screenBounds=i,this.cameraPoint=a,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=f,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,g)}static createFromScreenPoints(i,a){let f,g;if(i instanceof t.P||typeof i[0]=="number"){let v=t.P.convert(i);f=[v],g=a.isPointAboveHorizon(v)}else{let v=t.P.convert(i[0]),S=t.P.convert(i[1]),C=v.add(S)._div(2);f=[v,S],g=t.ao(v,S).every(z=>a.isPointAboveHorizon(z))&&a.isPointAboveHorizon(C)}return new yo(f,a.getCameraPoint(),g,a)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(i){return t.ao(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],i)}bufferedCameraGeometry(i){let a=this.screenBounds[0],f=this.screenBounds.length===1?this.screenBounds[0].add(new t.P(1,1)):this.screenBounds[1],g=t.ao(a,f,0,!1);return this.cameraPoint.y>f.y&&(this.cameraPoint.x>a.x&&this.cameraPoint.x<f.x?g.splice(3,0,this.cameraPoint):this.cameraPoint.x>=f.x?g[2]=this.cameraPoint:this.cameraPoint.x<=a.x&&(g[3]=this.cameraPoint)),t.ap(g,i)}bufferedCameraGeometryGlobe(i){let a=this.screenBounds[0],f=this.screenBounds.length===1?this.screenBounds[0].add(new t.P(1,1)):this.screenBounds[1],g=t.ao(a,f,i),v=this.cameraPoint.clone();switch(3*((v.y>a.y)+(v.y>f.y))+((v.x>a.x)+(v.x>f.x))){case 0:g[0]=v,g[4]=v.clone();break;case 1:g.splice(1,0,v);break;case 2:g[1]=v;break;case 3:g.splice(4,0,v);break;case 5:g.splice(2,0,v);break;case 6:g[3]=v;break;case 7:g.splice(3,0,v);break;case 8:g[2]=v}return g}containsTile(i,a,f,g=0){let v=i.queryPadding/a._pixelsPerMercatorPixel+1,S=f?this._bufferedCameraMercator(v,a):this._bufferedScreenMercator(v,a),C=i.tileID.wrap+(S.unwrapped?g:0),z=S.polygon.map(he=>t.aq(i.tileTransform,he,C));if(!t.ar(z,0,0,t.aj,t.aj))return;C=i.tileID.wrap+(this.screenGeometryMercator.unwrapped?g:0);let N=this.screenGeometryMercator.polygon.map(he=>t.as(i.tileTransform,he,C)),U=N.map(he=>new t.P(he[0],he[1])),$=a.getFreeCameraOptions().position||new t.ac(0,0,0),Z=t.as(i.tileTransform,$,C),X=N.map(he=>{let ae=t.at(he,he,Z);return t.au(ae,ae),new t.av(Z,ae)}),se=t.aw(i,1,a.zoom)*a._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:U,tilespaceRays:X,bufferedTilespaceGeometry:z,bufferedTilespaceBounds:(re=t.ax(z),re.min.x=t.aD(re.min.x,0,t.aj),re.min.y=t.aD(re.min.y,0,t.aj),re.max.x=t.aD(re.max.x,0,t.aj),re.max.y=t.aD(re.max.y,0,t.aj),re),tile:i,tileID:i.tileID,pixelToTileUnitsFactor:se};var re}_bufferedScreenMercator(i,a){let f=xo(i);if(this._screenRaycastCache[f])return this._screenRaycastCache[f];{let g;return g=a.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(i),a):{polygon:this.bufferedScreenGeometry(i).map(v=>a.pointCoordinate3D(v)),unwrapped:!0},this._screenRaycastCache[f]=g,g}}_bufferedCameraMercator(i,a){let f=xo(i);if(this._cameraRaycastCache[f])return this._cameraRaycastCache[f];{let g;return g=a.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(i),a):{polygon:this.bufferedCameraGeometry(i).map(v=>a.pointCoordinate3D(v)),unwrapped:!0},this._cameraRaycastCache[f]=g,g}}_projectAndResample(i,a){let f=function(v,S){let C=t.az([],S.pixelMatrix,S.globeMatrix),z=[0,-t.aE,0,1],N=[0,t.aE,0,1],U=[0,0,0,1];t.aA(z,z,C),t.aA(N,N,C),t.aA(U,U,C);let $=new t.P(z[0]/z[3],z[1]/z[3]),Z=new t.P(N[0]/N[3],N[1]/N[3]),X=t.aB(v,$)&&z[3]<U[3],se=t.aB(v,Z)&&N[3]<U[3];if(!X&&!se)return null;let re=function(Ve,Oe,Ke){for(let Qe=1;Qe<Ve.length;Qe++){let It=To(Oe.pointCoordinate3D(Ve[Qe-1]).x),gt=To(Oe.pointCoordinate3D(Ve[Qe]).x);if(Ke<0){if(It<gt)return{idx:Qe,t:-It/(gt-1-It)}}else if(gt<It)return{idx:Qe,t:(1-It)/(gt+1-It)}}return null}(v,S,X?-1:1);if(!re)return null;let{idx:he,t:ae}=re,be=he>1?Qo(v.slice(0,he),S):[],Pe=he<v.length?Qo(v.slice(he),S):[];be=be.map(Ve=>new t.P(To(Ve.x),Ve.y)),Pe=Pe.map(Ve=>new t.P(To(Ve.x),Ve.y));let Re=[...be];Re.length===0&&Re.push(Pe[Pe.length-1]);let Ge=t.ai(Re[Re.length-1].y,(Pe.length===0?be[0]:Pe[0]).y,ae),Ne;return Ne=X?[new t.P(0,Ge),new t.P(0,0),new t.P(1,0),new t.P(1,Ge)]:[new t.P(1,Ge),new t.P(1,1),new t.P(0,1),new t.P(0,Ge)],Re.push(...Ne),Pe.length===0?Re.push(be[0]):Re.push(...Pe),{polygon:Re.map(Ve=>new t.ac(Ve.x,Ve.y)),unwrapped:!1}}(i,a);if(f)return f;let g=function(v,S){let C=!1,z=-1/0,N=0;for(let $=0;$<v.length-1;$++)v[$].x>z&&(z=v[$].x,N=$);for(let $=0;$<v.length-1;$++){let Z=(N+$)%(v.length-1),X=v[Z],se=v[Z+1];Math.abs(X.x-se.x)>.5&&(X.x<se.x?(X.x+=1,Z===0&&(v[v.length-1].x+=1)):(se.x+=1,Z+1===v.length-1&&(v[0].x+=1)),C=!0)}let U=t.ay(S.center.lng);return C&&U<Math.abs(U-1)&&v.forEach($=>{$.x-=1}),{polygon:v,unwrapped:C}}(Qo(i,a).map(v=>new t.P(To(v.x),v.y)),a);return{polygon:g.polygon.map(v=>new t.ac(v.x,v.y)),unwrapped:g.unwrapped}}}function Qo(p,i){return t.aC(p,a=>{let f=i.pointCoordinate3D(a);a.x=f.x,a.y=f.y},1/256)}function To(p){return p<0?1+p%1:p%1}function xo(p){return 100*p|0}function oa(p,i,a,f,g){let v=function(C,z){if(C)return g(C);if(z){if(p.url&&z.tiles&&p.tiles&&delete p.tiles,z.variants){if(!Array.isArray(z.variants))return g(new Error("variants must be an array"));for(let U of z.variants){if(U==null||typeof U!="object"||U.constructor!==Object)return g(new Error("variant must be an object"));if(!Array.isArray(U.capabilities))return g(new Error("capabilities must be an array"));if(U.capabilities.length===1&&U.capabilities[0]==="meshopt"){z=t.l(z,U);break}}}let N=t.aF(t.l({},z,p),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);N.tiles=i.canonicalizeTileset(N,p.url),g(null,N)}},S=function(C,z,N){if(!C)return null;if(!z&&!N)return C;N=N||C.worldview_default;let U=Object.values(C.language||{});if(U.length===0)return null;let $=Object.values(C.worldview||{});if($.length===0)return null;let Z=U.every(se=>se===z),X=$.every(se=>se===N);return Z&&X?C:z in(C.language_options||{})||N in(C.worldview_options||{})?null:C.language_options&&C.worldview_options?C:null}(p.data,a,f);return S?t.q.frame(()=>v(null,S)):p.url?t.n(i.transformRequest(i.normalizeSourceURL(p.url,null,a,f),t.R.Source),v):t.q.frame(()=>{let N=p,{data:C}=N,z=Qx(N,["data"]);v(null,z)})}function Es(p,i){let a=Math.pow(2,i.z),f=Math.floor(t.ay(p.getWest())*a),g=Math.floor(t.aH(p.getNorth())*a),v=Math.ceil(t.ay(p.getEast())*a),S=Math.ceil(t.aH(p.getSouth())*a);return i.x>=f&&i.x<v&&i.y>=g&&i.y<S}class _s{constructor(i,a,f){this.bounds=i?t.aG.convert(this.validateBounds(i)):null,this.minzoom=a||0,this.maxzoom=f||24}validateBounds(i){return Array.isArray(i)&&i.length===4?[Math.max(-180,i[0]),Math.max(-90,i[1]),Math.min(180,i[2]),Math.min(90,i[3])]:[-180,-90,180,90]}addExtraBounds(i){if(i){this.extraBounds||(this.extraBounds=[]);for(let a of i)this.extraBounds.push(t.aG.convert(this.validateBounds(a)))}}contains(i){if(i.z>this.maxzoom||i.z<this.minzoom||this.bounds&&!Es(this.bounds,i))return!1;if(!this.extraBounds)return!0;for(let a of this.extraBounds)if(Es(a,i))return!0;return!1}static fromTileJSON(i){if(!i.bounds&&!i.extra_bounds)return null;let a=new _s(i.bounds,i.minzoom,i.maxzoom);return a.addExtraBounds(i.extra_bounds),a}}class ls extends t.E{constructor(i,a,f,g){if(super(),this.id=i,this.dispatcher=f,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,t.l(this,t.aF(a,["url","scheme","tileSize","promoteId"])),this._options=t.l({type:"vector"},a),this._collectResourceTiming=!!a.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(g),this._tileWorkers={},this._deduped=new t.aI}load(i){this._loaded=!1,this.fire(new t.A("dataloading",{dataType:"source"}));let a=Array.isArray(this.map._language)?this.map._language.join():this.map._language,f=this.map.getWorldview();this._tileJSONRequest=oa(this._options,this.map._requestManager,a,f,(g,v)=>{if(this._tileJSONRequest=null,this._loaded=!0,g)a&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${a}`),f&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${f}`),this.fire(new t.z(g));else if(v){if(t.l(this,v),this.hasWorldviews=!!v.worldview_options,v.worldview_default&&(this.worldviewDefault=v.worldview_default),v.vector_layers){this.vectorLayers=v.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(let S of v.vector_layers)this.vectorLayerIds.push(S.id),v.worldview&&v.worldview[S.source]&&this.localizableLayerIds.add(S.id)}this.tileBounds=_s.fromTileJSON(v),Hr(v.tiles,this.map._requestManager._customAccessToken),this.fire(new t.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new t.A("data",{dataType:"source",sourceDataType:"content"}))}i&&i(g)})}loaded(){return this._loaded}hasTile(i){return!this.tileBounds||this.tileBounds.contains(i.canonical)}onAdd(i){this.map=i,this.load()}reload(){this.cancelTileJSONRequest();let i=t.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(i))}setTiles(i){return this._options.tiles=i,this.reload(),this}setUrl(i){return this.url=i,this._options.url=i,this.reload(),this}onRemove(i){this.cancelTileJSONRequest()}serialize(){return t.l({},this._options)}loadTile(i,a){let f=i.tileID.canonical.url(this.tiles,this.scheme),g=this.map._requestManager.normalizeTileURL(f),v=this.map._requestManager.transformRequest(g,t.R.Tile),S=this.map.style?this.map.style.getLut(this.scope):null,C=S?{image:S.image.clone()}:null,z={request:v,data:void 0,uid:i.uid,tileID:i.tileID,tileZoom:i.tileZoom,zoom:i.tileID.overscaledZ,maxZoom:this.maxzoom,lut:C,tileSize:this.tileSize*i.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:t.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:i.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:i.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor()};if(this.hasWorldviews&&t.f(f)&&(z.worldview=this.map.getWorldview()||this.worldviewDefault,z.localizableLayerIds=this.localizableLayerIds),z.request.collectResourceTiming=this._collectResourceTiming,i.actor&&i.state!=="expired")i.state==="loading"?i.reloadCallback=a:i.request=i.actor.send("reloadTile",z,N.bind(this));else if(i.actor=this._tileWorkers[g]=this._tileWorkers[g]||this.dispatcher.getActor(),this.dispatcher.ready)i.request=i.actor.send("loadTile",z,N.bind(this),void 0,!0);else{let U=t.aJ.call({deduped:this._deduped},z,($,Z)=>{$||!Z?N.call(this,$):(z.data={cacheControl:Z.cacheControl,expires:Z.expires,rawData:Z.rawData.slice(0)},i.actor&&i.actor.send("loadTile",z,N.bind(this),void 0,!0))},!0);i.request={cancel:U}}function N(U,$){return delete i.request,i.aborted?a(null):U&&U.status!==404?a(U):($&&$.resourceTiming&&(i.resourceTiming=$.resourceTiming),this.map._refreshExpiredTiles&&$&&i.setExpiryData($),i.loadVectorData($,this.map.painter),t.aK(this.dispatcher),a(null),void(i.reloadCallback&&(this.loadTile(i,i.reloadCallback),i.reloadCallback=null)))}}abortTile(i){i.request&&(i.request.cancel(),delete i.request),i.actor&&i.actor.send("abortTile",{uid:i.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(i,a){i.actor&&i.actor.send("removeTile",{uid:i.uid,type:this.type,source:this.id,scope:this.scope}),i.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class wa extends t.E{constructor(i,a,f,g){super(),this.id=i,this.dispatcher=f,this.setEventedParent(g),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=t.l({type:"raster"},a),t.l(this,t.aF(a,["url","scheme","tileSize"]))}load(i){this._loaded=!1,this.fire(new t.A("dataloading",{dataType:"source"})),this._tileJSONRequest=oa(this._options,this.map._requestManager,null,null,(a,f)=>{this._tileJSONRequest=null,this._loaded=!0,a?this.fire(new t.z(a)):f&&(t.l(this,f),f.raster_layers&&(this.rasterLayers=f.raster_layers,this.rasterLayerIds=this.rasterLayers.map(g=>g.id)),this.tileBounds=_s.fromTileJSON(f),Hr(f.tiles),this.fire(new t.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new t.A("data",{dataType:"source",sourceDataType:"content"}))),i&&i(a)})}loaded(){return this._loaded}onAdd(i){this.map=i,this.load()}reload(){this.cancelTileJSONRequest();let i=t.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(i))}setTiles(i){return this._options.tiles=i,this.reload(),this}setUrl(i){return this.url=i,this._options.url=i,this.reload(),this}onRemove(i){this.cancelTileJSONRequest()}serialize(){return t.l({},this._options)}hasTile(i){return!this.tileBounds||this.tileBounds.contains(i.canonical)}loadTile(i,a){let f=t.q.devicePixelRatio>=2,g=this.map._requestManager.normalizeTileURL(i.tileID.canonical.url(this.tiles,this.scheme),f,this.tileSize);i.request=t.o(this.map._requestManager.transformRequest(g,t.R.Tile),(v,S,C,z)=>(delete i.request,i.aborted?(i.state="unloaded",a(null)):v?(i.state="errored",a(v)):S?(this.map._refreshExpiredTiles&&i.setExpiryData({cacheControl:C,expires:z}),i.setTexture(S,this.map.painter),i.state="loaded",t.aK(this.dispatcher),void a(null)):a(null)))}abortTile(i,a){i.request&&(i.request.cancel(),delete i.request),a&&a()}unloadTile(i,a){i.texture&&i.texture instanceof t.T?(i.destroy(!0),i.texture&&i.texture instanceof t.T&&this.map.painter.saveTileTexture(i.texture)):i.destroy(),a&&a()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Eh extends wa{constructor(i,a,f,g){super(i,a,f,g),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._options=t.l({type:"raster-array"},a)}triggerRepaint(i){let a=this.map.painter._terrain,f=this.map.style.getSourceCache(this.id);a&&a.enabled&&f&&a._clearRenderCacheForTile(f.id,i.tileID),this.map.triggerRepaint()}loadTile(i,a){let f=this.map._requestManager.normalizeTileURL(i.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),g=this.map._requestManager.transformRequest(f,t.R.Tile),v={request:g,uid:i.uid,tileID:i.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};i.source=this.id,i.scope=this.scope,i.requestParams=g,i.actor||(i.actor=this.dispatcher.getActor());let S=(C,z,N,U)=>{if(delete i.request,i.aborted)return i.state="unloaded",a(null);if(C)return C.name==="AbortError"?void 0:(i.state="errored",a(C));if(this.map._refreshExpiredTiles&&z&&i.setExpiryData({cacheControl:N,expires:U}),this.partial)i.state="empty";else{if(!z)return a(null);i.state="loaded",i._isHeaderLoaded=!0,i._mrt=z}a(null)};i.request=this.partial?i.fetchHeader(void 0,S.bind(this)):i.actor.send("loadTile",v,S.bind(this),void 0,!0)}abortTile(i){i.request&&(i.request.cancel(),delete i.request),i.actor&&i.actor.send("abortTile",{uid:i.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(i,a){let f=i.texture;f&&f instanceof t.T?(i.destroy(!0),this.map.painter.saveTileTexture(f)):(i.destroy(),i.flushQueues(),i._isHeaderLoaded=!1,delete i._mrt,delete i.textureDescriptor),i.fbo&&(i.fbo.destroy(),delete i.fbo),delete i.request,delete i.requestParams,delete i.neighboringTiles,i.state="unloaded"}prepareTile(i,a,f){i._isHeaderLoaded&&(i.state!=="empty"&&(i.state="reloading"),i.fetchBand(a,f,(g,v)=>{if(g)return i.state="errored",this.fire(new t.z(g)),void this.triggerRepaint(i);v&&(i._isHeaderLoaded=!0,i.setTexture(v,this.map.painter),i.state="loaded",this.triggerRepaint(i))}))}getInitialBand(i){if(!this.rasterLayers)return 0;let a=this.rasterLayers.find(({id:v})=>v===i),f=a&&a.fields,g=f&&f.bands&&f.bands;return g?g[0]:0}getTextureDescriptor(i,a,f){if(!i)return;let g=a.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!g)return;let v=null;a instanceof t.aN?v=a.paint.get("raster-array-band"):a instanceof t.aO&&(v=a.paint.get("raster-particle-array-band"));let S=v||this.getInitialBand(g);if(S!=null)if(i.textureDescriptor){if(!i.updateNeeded(g,S)||f)return Object.assign({},i.textureDescriptor,{texture:i.texture})}else this.prepareTile(i,g,S)}getImages(i,a){let f=new Map;for(let g of i)for(let v of a){let[S,C]=v.split("/"),z=g.getLayer(S);if(!z||!z.hasBand(C)||!z.hasDataForBand(C))continue;let{bytes:N,tileSize:U,buffer:$}=z.getBandView(C),Z=U+2*$,X={data:new t.r({width:Z,height:Z},N),pixelRatio:2,sdf:!1,usvg:!1,version:0};f.set(v,X)}return f}}let Ru={vector:ls,raster:wa,"raster-dem":class extends wa{constructor(p,i,a,f){super(p,i,a,f),this.type="raster-dem",this.maxzoom=22,this._options=t.l({type:"raster-dem"},i),this.encoding=i.encoding||"mapbox"}loadTile(p,i){let a=this.map._requestManager.normalizeTileURL(p.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function f(g,v){g&&(p.state="errored",i(g)),v&&(p.dem=v,p.dem.onDeserialize(),p.needsHillshadePrepare=!0,p.needsDEMTextureUpload=!0,p.state="loaded",i(null))}p.request=t.o(this.map._requestManager.transformRequest(a,t.R.Tile),(function(g,v,S,C){if(delete p.request,p.aborted)p.state="unloaded",i(null);else if(g)p.state="errored",i(g);else if(v){this.map._refreshExpiredTiles&&p.setExpiryData({cacheControl:S,expires:C});let z=ImageBitmap&&v instanceof ImageBitmap&&t.t(),N=1-(v.width-t.aL(v.width))/2;N<1||p.neighboringTiles||(p.neighboringTiles=this._getNeighboringTiles(p.tileID));let U=z?v:t.q.getImageData(v,N),$={uid:p.uid,tileID:p.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:U,encoding:this.encoding,padding:N};p.actor&&p.state!=="expired"||(p.actor=this.dispatcher.getActor(),p.actor.send("loadTile",$,f.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(p){let i=p.canonical,a=Math.pow(2,i.z),f=(i.x-1+a)%a,g=i.x===0?p.wrap-1:p.wrap,v=(i.x+1+a)%a,S=i.x+1===a?p.wrap+1:p.wrap,C={};return C[new t.aM(p.overscaledZ,g,i.z,f,i.y).key]={backfilled:!1},C[new t.aM(p.overscaledZ,S,i.z,v,i.y).key]={backfilled:!1},i.y>0&&(C[new t.aM(p.overscaledZ,g,i.z,f,i.y-1).key]={backfilled:!1},C[new t.aM(p.overscaledZ,p.wrap,i.z,i.x,i.y-1).key]={backfilled:!1},C[new t.aM(p.overscaledZ,S,i.z,v,i.y-1).key]={backfilled:!1}),i.y+1<a&&(C[new t.aM(p.overscaledZ,g,i.z,f,i.y+1).key]={backfilled:!1},C[new t.aM(p.overscaledZ,p.wrap,i.z,i.x,i.y+1).key]={backfilled:!1},C[new t.aM(p.overscaledZ,S,i.z,v,i.y+1).key]={backfilled:!1}),C}},"raster-array":Eh,geojson:class extends t.E{constructor(p,i,a,f){super(),this.id=p,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=a.getActor(),this.setEventedParent(f),this._data=i.data,this._options=t.l({},i),this._collectResourceTiming=i.collectResourceTiming,i.maxzoom!==void 0&&(this.maxzoom=i.maxzoom),i.minzoom!==void 0&&(this.minzoom=i.minzoom),i.type&&(this.type=i.type),i.attribution&&(this.attribution=i.attribution),this.promoteId=i.promoteId;let g=t.aj/this.tileSize;this.workerOptions=t.l({source:this.id,scope:this.scope,cluster:i.cluster||!1,geojsonVtOptions:{buffer:(i.buffer!==void 0?i.buffer:128)*g,tolerance:(i.tolerance!==void 0?i.tolerance:.375)*g,extent:t.aj,maxZoom:this.maxzoom,lineMetrics:i.lineMetrics||!1,generateId:i.generateId||!1},superclusterOptions:{maxZoom:i.clusterMaxZoom!==void 0?i.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,i.clusterMinPoints||2),extent:t.aj,radius:(i.clusterRadius!==void 0?i.clusterRadius:50)*g,log:!1,generateId:i.generateId||!1},clusterProperties:i.clusterProperties,filter:i.filter,dynamic:i.dynamic},i.workerOptions)}onAdd(p){this.map=p,this.setData(this._data)}setData(p){return this._data=p,this._updateWorkerData(),this}updateData(p){if(!this._options.dynamic)return this.fire(new t.z(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof p!="string"&&(p.type==="Feature"&&(p={type:"FeatureCollection",features:[p]}),p.type!=="FeatureCollection"))return this.fire(new t.z(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof p!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){let i=new Map;for(let a of this._data.features)i.set(a.id,a);for(let a of p.features)i.set(a.id,a);this._data.features=[...i.values()]}else this._data=p;return this._updateWorkerData(!0),this}getClusterExpansionZoom(p,i){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:p,source:this.id,scope:this.scope},i),this}getClusterChildren(p,i){return this.actor.send("geojson.getClusterChildren",{clusterId:p,source:this.id,scope:this.scope},i),this}getClusterLeaves(p,i,a,f){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:p,limit:i,offset:a},f),this}_updateWorkerData(p=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new t.A("dataloading",{dataType:"source"})),this._loaded=!1;let i=t.l({append:p},this.workerOptions);i.scope=this.scope;let a=this._data;typeof a=="string"?(i.request=this.map._requestManager.transformRequest(t.q.resolveURL(a),t.R.Source),i.request.collectResourceTiming=this._collectResourceTiming):i.data=JSON.stringify(a),this._pendingLoad=this.actor.send(`${this.type}.loadData`,i,(f,g)=>{if(this._loaded=!0,this._pendingLoad=null,f)this.fire(new t.z(f));else{let v={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&g&&g.resourceTiming&&g.resourceTiming[this.id]&&(v.resourceTiming=g.resourceTiming[this.id]),p&&(this._partialReload=!0),this.fire(new t.A("data",v)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(p),this._coalesce=!1)})}loaded(){return this._loaded}reload(){let p=t.C(this.id,this.scope);this.map.style.clearSource(p),this._updateWorkerData()}loadTile(p,i){let a=p.actor?"reloadTile":"loadTile";p.actor=this.actor;let f=this.map.style?this.map.style.getLut(this.scope):null,g=f?{image:f.image.clone()}:null,v=this._partialReload,S={type:this.type,uid:p.uid,tileID:p.tileID,tileZoom:p.tileZoom,zoom:p.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:g,scope:this.scope,pixelRatio:t.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:p.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:v};p.request=this.actor.send(a,S,(C,z)=>v&&!z?(p.state="loaded",i(null)):(delete p.request,p.destroy(),p.aborted?i(null):C?i(C):(p.loadVectorData(z,this.map.painter,a==="reloadTile"),i(null))),void 0,a==="loadTile")}abortTile(p){p.request&&(p.request.cancel(),delete p.request),p.aborted=!0}unloadTile(p,i){this.actor.send("removeTile",{uid:p.uid,type:this.type,source:this.id,scope:this.scope}),p.destroy()}onRemove(p){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return t.l({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends t.aP{constructor(p,i,a,f){super(p,i,a,f),this.roundZoom=!0,this.type="video",this.options=i}load(){this._loaded=!1;let p=this.options;this.urls=[];for(let i of p.urls)this.urls.push(this.map._requestManager.transformRequest(i,t.R.Source).url);t.aQ(this.urls,(i,a)=>{this._loaded=!0,i?this.fire(new t.z(i)):a&&(this.video=a,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(p){if(this.video){let i=this.video.seekable;p<i.start(0)||p>i.end(0)?this.fire(new t.z(new t.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${i.start(0)} and ${i.end(0)}-second mark.`))):this.video.currentTime=p}}getVideo(){return this.video}onAdd(p){this.map||(this.map=p,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;let p=this.map.painter.context,i=p.gl;this.texture?this.video.paused||(this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),i.texSubImage2D(i.TEXTURE_2D,0,0,0,i.RGBA,i.UNSIGNED_BYTE,this.video)):(this.texture=new t.T(p,this.video,i.RGBA8),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(p)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:t.aP,model:class extends t.E{constructor(p,i,a,f){super(),this.id=p,this.type="model",this.models=[],this._loaded=!1,this._options=i}load(){let p=[];for(let i in this._options.models){let a=this._options.models[i],f=t.aS(this.map._requestManager.transformRequest(a.uri,t.R.Model).url).then(g=>{if(!g)return;let v=t.aT(g),S=new t.aU(i,a.position,a.orientation,v);S.computeBoundsAndApplyParent(),this.models.push(S)}).catch(g=>{this.fire(new t.z(new Error(`Could not load model ${i} from ${a.uri}: ${g.message}`)))});p.push(f)}Promise.allSettled(p).then(()=>{this._loaded=!0,this.fire(new t.A("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(i=>{this._loaded=!0,this.fire(new t.z(new Error(`Could not load models: ${i.message}`)))})}onAdd(p){this.map=p,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(p,i){}serialize(){return this._options}},"batched-model":class extends t.E{constructor(p,i,a,f){super(),this.type="batched-model",this.id=p,this.tileSize=512,this._options=i,this.tiles=this._options.tiles,this.maxzoom=i.maxzoom||19,this.minzoom=i.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=a,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(f)}onAdd(p){this.map=p,this.load()}reload(){this.cancelTileJSONRequest();let p=t.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(p))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(p){this._loaded=!1,this.fire(new t.A("dataloading",{dataType:"source"}));let i=Array.isArray(this.map._language)?this.map._language.join():this.map._language,a=this.map.getWorldview();this._tileJSONRequest=oa(this._options,this.map._requestManager,i,a,(f,g)=>{this._tileJSONRequest=null,this._loaded=!0,f?(i&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${i}`),a&&a.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${a}`),this.fire(new t.z(f))):g&&(t.l(this,g),g.bounds&&(this.tileBounds=new _s(g.bounds,this.minzoom,this.maxzoom)),Hr(g.tiles,this.map._requestManager._customAccessToken),this.fire(new t.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new t.A("data",{dataType:"source",sourceDataType:"content"}))),p&&p(f)})}hasTransition(){return!1}hasTile(p){return!this.tileBounds||this.tileBounds.contains(p.canonical)}loaded(){return this._loaded}loadTile(p,i){let a=this.map._requestManager.normalizeTileURL(p.tileID.canonical.url(this.tiles,this.scheme)),f={request:this.map._requestManager.transformRequest(a,t.R.Tile),data:void 0,uid:p.uid,tileID:p.tileID,tileZoom:p.tileZoom,zoom:p.tileID.overscaledZ,tileSize:this.tileSize*p.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:p.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:t.q.devicePixelRatio,promoteId:this.promoteId};if(p.actor&&p.state!=="expired")if(p.state==="loading")p.reloadCallback=i;else{if(p.buckets){let v=Object.values(p.buckets);for(let S of v)S.dirty=!0;return void(p.state="loaded")}p.request=p.actor.send("reloadTile",f,g.bind(this))}else p.actor=this.dispatcher.getActor(),p.request=p.actor.send("loadTile",f,g.bind(this),void 0,!0);function g(v,S){return p.aborted?i(null):v&&v.status!==404?i(v):(this.map._refreshExpiredTiles&&S&&p.setExpiryData(S),p.loadModelData(S,this.map.painter),p.state="loaded",void i(null))}}serialize(){return t.l({},this._options)}},canvas:class extends t.aP{constructor(p,i,a,f){super(p,i,a,f),i.coordinates?Array.isArray(i.coordinates)&&i.coordinates.length===4&&!i.coordinates.some(g=>!Array.isArray(g)||g.length!==2||g.some(v=>typeof v!="number"))||this.fire(new t.z(new t.V(`sources.${p}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new t.z(new t.V(`sources.${p}`,null,'missing required property "coordinates"'))),i.animate&&typeof i.animate!="boolean"&&this.fire(new t.z(new t.V(`sources.${p}`,null,'optional "animate" property must be a boolean value'))),i.canvas?typeof i.canvas=="string"||i.canvas instanceof HTMLCanvasElement||this.fire(new t.z(new t.V(`sources.${p}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new t.z(new t.V(`sources.${p}`,null,'missing required property "canvas"'))),this.options=i,this.animate=i.animate===void 0||i.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new t.z(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(p){this.map=p,this.load(),this.canvas&&this.animate&&this.play()}onRemove(p){this.pause()}prepare(){let p=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,p=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,p=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;let i=this.map.painter.context;this.texture?!p&&!this._playing||this.texture instanceof t.aR||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new t.T(i,this.canvas,i.gl.RGBA8,{premultiply:!0}),this._prepareData(i)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(let p of[this.canvas.width,this.canvas.height])if(isNaN(p)||p<=0)return!0;return!1}},custom:class extends t.E{constructor(p,i,a,f){super(),this.id=p,this.type="custom",this._dataType="raster",this._dispatcher=a,this._implementation=i,this.setEventedParent(f),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new t.z(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new t.z(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new _s(this._implementation.bounds,this.minzoom,this.maxzoom)),i.update=this._update.bind(this),i.clearTiles=this._clearTiles.bind(this),i.coveringTiles=this._coveringTiles.bind(this),t.l(this,t.aF(i,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return t.aF(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new t.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new t.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(p){this.map=p,this._loaded=!1,this.fire(new t.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(p),this.load()}onRemove(p){this._implementation.onRemove&&this._implementation.onRemove(p)}hasTile(p){if(this._implementation.hasTile){let{x:i,y:a,z:f}=p.canonical;return this._implementation.hasTile({x:i,y:a,z:f})}return!this.tileBounds||this.tileBounds.contains(p.canonical)}loadTile(p,i){let{x:a,y:f,z:g}=p.tileID.canonical,v=new AbortController;p.request=Promise.resolve(this._implementation.loadTile({x:a,y:f,z:g},{signal:v.signal})).then((function(S){return delete p.request,p.aborted?(p.state="unloaded",i(null)):S===void 0?(p.state="errored",i(null)):S===null?(this.loadTileData(p,{width:this.tileSize,height:this.tileSize,data:null}),p.state="loaded",i(null)):function(C){return C instanceof ImageData||C instanceof HTMLCanvasElement||C instanceof ImageBitmap||C instanceof HTMLImageElement}(S)?(this.loadTileData(p,S),p.state="loaded",void i(null)):(p.state="errored",i(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(S=>{S.name!=="AbortError"&&(p.state="errored",i(S))}),p.request.cancel=()=>v.abort()}loadTileData(p,i){p.setTexture(i,this.map.painter)}unloadTile(p,i){if(p.texture&&p.texture instanceof t.T?(p.destroy(!0),p.texture&&p.texture instanceof t.T&&this.map.painter.saveTileTexture(p.texture)):p.destroy(),this._implementation.unloadTile){let{x:a,y:f,z:g}=p.tileID.canonical;this._implementation.unloadTile({x:a,y:f,z:g})}i&&i()}abortTile(p,i){p.request&&p.request.cancel&&(p.request.cancel(),delete p.request),i&&i()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(p=>({x:p.canonical.x,y:p.canonical.y,z:p.canonical.z}))}_clearTiles(){let p=t.C(this.id,this.scope);this.map.style.clearSource(p)}_update(){this.fire(new t.A("data",{dataType:"source",sourceDataType:"content"}))}}},ou=function(p,i,a,f){let g=new Ru[i.type](p,i,a,f);if(g.id!==p)throw new Error(`Expected Source id to be ${p} instead of ${g.id}`);return t.aV(["load","abort","unload","serialize","prepare"],g),g};function Wc(p,i,a=""){return`${a}:${i.id||""}:${i.layer.id}:${function(f){if("layerId"in f)return`layer:${f.layerId}`;{let{featuresetId:g,importId:v}=f;return`featureset:${g}${v?`:import:${v}`:""}`}}(p.target)}`}function zu(p,i,a,f=""){if(p.uniqueFeatureID){let g=Wc(p,i,f);if(a.has(g))return!0;a.add(g)}return!1}function Mh(p,i,a,f,g=!1){let v=i.sourceCache.transform,S=i.sourceCache.tilesIn(p,i.has3DLayers,g);S.sort(Ml);let C=[];for(let z of S){let N=z.tile.queryRenderedFeatures(i,z,a,f,v,g);Object.keys(N).length&&C.push({wrappedTileID:z.tile.tileID.wrapped().key,queryResults:N})}return C.length===0?{}:function(z){let N={},U={};for(let $ of z){let Z=$.queryResults,X=$.wrappedTileID,se=U[X]=U[X]||{};for(let re in Z){let he=Z[re],ae=se[re]=se[re]||{},be=N[re]=N[re]||[];for(let Pe of he)ae[Pe.featureIndex]||(ae[Pe.featureIndex]=!0,be.push(Pe))}}return N}(C)}function Hc(p,i,a,f,g){let v={},S=f.queryRenderedSymbols(p),C=[];for(let z of Object.keys(S).map(Number))C.push(g[z]);C.sort(Ml);for(let z of C){let N=z.featureIndex.lookupSymbolFeatures(S[z.bucketInstanceId],z.bucketIndex,z.sourceLayerIndex,i,a);for(let U in N){let $=v[U]=v[U]||[],Z=N[U];Z.sort((X,se)=>{let re=z.featureSortOrder;if(re){let he=re.indexOf(X.featureIndex);return re.indexOf(se.featureIndex)-he}return se.featureIndex-X.featureIndex});for(let X of Z)$.push(X)}}return v}function af(p,i){let a=p.getRenderableIds().map(v=>p.getTileByID(v)),f=[],g={};for(let v=0;v<a.length;v++){let S=a[v],C=S.tileID.canonical.key;g[C]||(g[C]=!0,S.querySourceFeatures(f,i))}return f}function Ml(p,i){let a=p.tileID,f=i.tileID;return a.overscaledZ-f.overscaledZ||a.canonical.y-f.canonical.y||a.wrap-f.wrap||a.canonical.x-f.canonical.x}function Ph(p,i){let a={};if(!i)return a;for(let f of p){let g=f.layerIds.map(v=>i.getLayer(v)).filter(Boolean);if(g.length!==0){f.layers=g,f.stateDependentLayerIds&&(f.stateDependentLayers=f.stateDependentLayerIds.map(v=>g.filter(S=>S.id===v)[0]));for(let v of g)a[v.fqid]=f}}return a}let Ra=32,_l=33,xc=new Uint16Array(8184);for(let p=0;p<2046;p++){let i=p+2,a=0,f=0,g=0,v=0,S=0,C=0;for(1&i?g=v=S=Ra:a=f=C=Ra;(i>>=1)>1;){let N=a+g>>1,U=f+v>>1;1&i?(g=a,v=f,a=S,f=C):(a=g,f=v,g=S,v=C),S=N,C=U}let z=4*p;xc[z+0]=a,xc[z+1]=f,xc[z+2]=g,xc[z+3]=v}let al=new Uint16Array(2178),Pl=new Uint8Array(1089),Ms=new Uint16Array(1089);function Ir(p){return p===0?-.03125:p===32?.03125:0}let ec={type:2,extent:t.aj,loadGeometry:()=>[[new t.P(0,0),new t.P(t.aj+1,0),new t.P(t.aj+1,t.aj+1),new t.P(0,t.aj+1),new t.P(0,0)]]};class Ta{constructor(i,a,f,g,v){this.tileID=i,this.uid=t.a$(),this.uses=0,this.tileSize=a,this.tileZoom=f,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=v,g&&g.style&&(this._lastUpdatedBrightness=g.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",g&&g.transform&&(this.projection=g.transform.projection)}registerFadeDuration(i){let a=i+this.timeAdded;a<t.q.now()||this.fadeEndTime&&a<this.fadeEndTime||(this.fadeEndTime=a)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=t.aW(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(i,a,f){if(this.unloadVectorData(),this.state="loaded",i){i.featureIndex&&(this.latestFeatureIndex=i.featureIndex,i.rawTileData?(this.latestRawTileData=i.rawTileData,this.latestFeatureIndex.rawTileData=i.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=i.collisionBoxArray,this.buckets=Ph(i.buckets,a.style),this.hasSymbolBuckets=!1;for(let g in this.buckets){let v=this.buckets[g];if(v instanceof t.b1){if(this.hasSymbolBuckets=!0,!f)break;v.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(let g in this.buckets){let v=this.buckets[g];if(v instanceof t.b1&&v.hasRTLText){this.hasRTLText=!0,t.b2();break}}this.queryPadding=0;for(let g in this.buckets){let v=this.buckets[g],S=a.style.getOwnLayer(g);if(!S)continue;let C=S.queryRadius(v);this.queryPadding=Math.max(this.queryPadding,C)}i.imageAtlas&&(this.imageAtlas=i.imageAtlas),i.glyphAtlasImage&&(this.glyphAtlasImage=i.glyphAtlasImage),i.lineAtlas&&(this.lineAtlas=i.lineAtlas),this._lastUpdatedBrightness=i.brightness}else this.collisionBoxArray=new t.b0}unloadVectorData(){if(this.hasData()){for(let i in this.buckets)this.buckets[i].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(i,a,f){i&&(i.resourceTiming&&(this.resourceTiming=i.resourceTiming),this.buckets=Object.assign({},this.buckets,Ph(i.buckets,a.style)),i.featureIndex&&(this.latestFeatureIndex=i.featureIndex))}getBucket(i){return this.buckets[i.fqid]}upload(i){for(let g in this.buckets){let v=this.buckets[g];v.uploadPending()&&v.upload(i)}let a=i.gl,f=this.imageAtlas;f&&!f.uploaded&&(this.imageAtlasTexture=new t.T(i,f.image,a.RGBA8,{useMipmap:!!f.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new t.T(i,this.glyphAtlasImage,a.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new t.T(i,this.lineAtlas.image,a.R8),this.lineAtlas.uploaded=!0)}prepare(i,a,f){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(i,this.imageAtlasTexture,f),!a||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;let g=a.style.getBrightness();(this._lastUpdatedBrightness||g)&&(this._lastUpdatedBrightness&&g&&Math.abs(this._lastUpdatedBrightness-g)<.001||(this.updateBuckets(a,this._lastUpdatedBrightness!==g),this._lastUpdatedBrightness=g))}queryRenderedFeatures(i,a,f,g,v,S){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};let C=function(z,N){let U=t.bn([],[.5*z.width,.5*-z.height,1]);return t.bo(U,U,[1,-1,0]),t.az(U,U,z.calculateProjMatrix(N.toUnwrapped())),Float32Array.from(U)}(v,this.tileID);return this.latestFeatureIndex.query(i,{tilespaceGeometry:a,pixelPosMatrix:C,transform:g,availableImages:f,tileTransform:this.tileTransform})}querySourceFeatures(i,a){let f=this.latestFeatureIndex;if(!f||!f.rawTileData)return;let g=f.loadVTLayers(),v=a?a.sourceLayer:"",S=g._geojsonTileLayer||g[v];if(!S)return;let C=t.b3(a&&a.filter),{z,x:N,y:U}=this.tileID.canonical,$={z,x:N,y:U};for(let Z=0;Z<S.length;Z++){let X=S.feature(Z);if(C.needGeometry){let he=t.b4(X,!0);if(!C.filter(new t.aa(this.tileID.overscaledZ),he,this.tileID.canonical))continue}else if(!C.filter(new t.aa(this.tileID.overscaledZ),X))continue;let se=f.getId(X,v),re=new t.b5(X,z,N,U,se);re.tile=$,i.push(re)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(i){let a=this.expirationTime;if(i.cacheControl){let f=t.b6(i.cacheControl);f["max-age"]&&(this.expirationTime=Date.now()+1e3*f["max-age"])}else i.expires&&(this.expirationTime=new Date(i.expires).getTime());if(this.expirationTime){let f=Date.now(),g=!1;if(this.expirationTime>f)g=!1;else if(a)if(this.expirationTime<a)g=!0;else{let v=this.expirationTime-a;v?this.expirationTime=f+Math.max(v,3e4):g=!0}else g=!0;g?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(i){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&i&&this.updateBuckets(i)}updateBuckets(i,a){if(!this.latestFeatureIndex||!i.style)return;let f=this.latestFeatureIndex.loadVTLayers(),g=i.style.listImages(),v=i.style.getBrightness();for(let S in this.buckets){if(!i.style.hasLayer(S))continue;let C=this.buckets[S],z=C.layers[0],N=z.sourceLayer||"_geojsonTileLayer",U=f[N],$=i.style.getLayerSourceCache(z),Z={};$&&(Z=$._state.getState(N,void 0));let X=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},se=Object.keys(Z).length>0&&!a;se&&!C.stateDependentLayers.length&&!a||C.update(Z,U,g,X,se?C.stateDependentLayers:C.layers,a,v),(C instanceof t.b7||C instanceof t.b8)&&i._terrain&&i._terrain.enabled&&$&&C.uploadPending()&&i._terrain._clearRenderCacheForTile($.id,this.tileID);let re=i&&i.style&&i.style.getOwnLayer(S);re&&(this.queryPadding=Math.max(this.queryPadding,re.queryRadius(C)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<t.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(i){this.symbolFadeHoldUntil=t.q.now()+i}setTexture(i,a){let f=a.context,g=f.gl;this.texture=this.texture||a.getTileTexture(i.width),this.texture&&this.texture instanceof t.T?this.texture.update(i):(this.texture=new t.T(f,i,g.RGBA8,{useMipmap:!0}),this.texture.bind(g.LINEAR,g.CLAMP_TO_EDGE))}setDependencies(i,a){let f={};for(let g of a)f[g]=!0;this.dependencies[i]=f}hasDependency(i,a){for(let f of i){let g=this.dependencies[f];if(g){for(let v of a)if(g[v])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(i,a){if(!a||a.name==="mercator"||this._tileDebugBuffer)return;let f=t.b9(ec,this.tileID.canonical,this.tileTransform)[0],g=new t.ba,v=new t.bb;for(let S=0;S<f.length;S++){let{x:C,y:z}=f[S];g.emplaceBack(C,z),v.emplaceBack(S)}v.emplaceBack(0),this._tileDebugIndexBuffer=i.createIndexBuffer(v),this._tileDebugBuffer=i.createVertexBuffer(g,t.bc.members),this._tileDebugSegments=t.bd.simpleSegment(0,0,g.length,v.length)}_makeTileBoundsBuffers(i,a){if(this._tileBoundsBuffer||!a||a.name==="mercator")return;let f=t.b9(ec,this.tileID.canonical,this.tileTransform)[0],g,v;if(this.isRaster){let S=function(C,z){let N=t.aW(C,z),U=Math.pow(2,C.z);for(let he=0;he<_l;he++)for(let ae=0;ae<_l;ae++){let be=t.aX((C.x+(ae+Ir(ae))/Ra)/U),Pe=t.aY((C.y+(he+Ir(he))/Ra)/U),Re=z.project(be,Pe),Ge=he*_l+ae;al[2*Ge+0]=Math.round((Re.x*N.scale-N.x)*t.aj),al[2*Ge+1]=Math.round((Re.y*N.scale-N.y)*t.aj)}Pl.fill(0),Ms.fill(0);for(let he=2045;he>=0;he--){let ae=4*he,be=xc[ae+0],Pe=xc[ae+1],Re=xc[ae+2],Ge=xc[ae+3],Ne=be+Re>>1,Ve=Pe+Ge>>1,Oe=Ne+Ve-Pe,Ke=Ve+be-Ne,Qe=Pe*_l+be,It=Ge*_l+Re,gt=Ve*_l+Ne,jt=Math.hypot((al[2*Qe+0]+al[2*It+0])/2-al[2*gt+0],(al[2*Qe+1]+al[2*It+1])/2-al[2*gt+1])>=16;Pl[gt]=Pl[gt]||(jt?1:0),he<1022&&(Pl[gt]=Pl[gt]||Pl[(Pe+Ke>>1)*_l+(be+Oe>>1)]||Pl[(Ge+Ke>>1)*_l+(Re+Oe>>1)])}let $=new t.aZ,Z=new t.a_,X=0;function se(he,ae){let be=ae*_l+he;return Ms[be]===0&&($.emplaceBack(al[2*be+0],al[2*be+1],he*t.aj/Ra,ae*t.aj/Ra),Ms[be]=++X),Ms[be]-1}function re(he,ae,be,Pe,Re,Ge){let Ne=he+be>>1,Ve=ae+Pe>>1;if(Math.abs(he-Re)+Math.abs(ae-Ge)>1&&Pl[Ve*_l+Ne])re(Re,Ge,he,ae,Ne,Ve),re(be,Pe,Re,Ge,Ne,Ve);else{let Oe=se(he,ae),Ke=se(be,Pe),Qe=se(Re,Ge);Z.emplaceBack(Oe,Ke,Qe)}}return re(0,0,Ra,Ra,Ra,0),re(Ra,Ra,0,0,0,Ra),{vertices:$,indices:Z}}(this.tileID.canonical,a);g=S.vertices,v=S.indices}else{g=new t.aZ,v=new t.a_;for(let{x:C,y:z}of f)g.emplaceBack(C,z,0,0);let S=t.be(g.int16.subarray(0,4*g.length),void 0,4);for(let C=0;C<S.length;C+=3)v.emplaceBack(S[C],S[C+1],S[C+2])}this._tileBoundsBuffer=i.createVertexBuffer(g,t.bf.members),this._tileBoundsIndexBuffer=i.createIndexBuffer(v),this._tileBoundsSegments=t.bd.simpleSegment(0,0,g.length,v.length)}_makeGlobeTileDebugBuffers(i,a){let f=a.projection;if(!f||f.name!=="globe"||a.freezeTileCoverage)return;let g=this.tileID.canonical,v=t.bg(g,a),S=t.bh(v),C=t.ah(a.zoom),z;C>0&&(z=t.bi(new Float64Array(16),a.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(i,g,a,S,z,C),this._makeGlobeTileDebugTextBuffer(i,g,a,S,z,C)}_globePoint(i,a,f,g,v,S,C){let z=t.bj(i,a,f);if(S){let N=1<<f.z,U=t.ay(g.center.lng),$=t.aH(g.center.lat),Z=(f.x+.5)/N-U,X=0;Z>.5?X=-1:Z<-.5&&(X=1);let se=(i/t.aj+f.x)/N+X,re=(a/t.aj+f.y)/N;se=(se-U)*g._pixelsPerMercatorPixel+U,re=(re-$)*g._pixelsPerMercatorPixel+$;let he=[se*g.worldSize,re*g.worldSize,0];t.ad(he,he,S),z=t.bk(z,he,C)}return t.ad(z,z,v)}_makeGlobeTileDebugBorderBuffer(i,a,f,g,v,S){let C=new t.ba,z=new t.bb,N=new t.bl,U=(Z,X,se,re,he)=>{let ae=(se-Z)/(he-1),be=(re-X)/(he-1),Pe=C.length;for(let Re=0;Re<he;Re++){let Ge=Z+Re*ae,Ne=X+Re*be;C.emplaceBack(Ge,Ne);let Ve=this._globePoint(Ge,Ne,a,f,g,v,S);N.emplaceBack(Ve[0],Ve[1],Ve[2]),z.emplaceBack(Pe+Re)}},$=t.aj;U(0,0,$,0,16),U($,0,$,$,16),U($,$,0,$,16),U(0,$,0,0,16),this._tileDebugIndexBuffer=i.createIndexBuffer(z),this._tileDebugBuffer=i.createVertexBuffer(C,t.bc.members),this._globeTileDebugBorderBuffer=i.createVertexBuffer(N,t.bm.members),this._tileDebugSegments=t.bd.simpleSegment(0,0,C.length,z.length)}_makeGlobeTileDebugTextBuffer(i,a,f,g,v,S){let C=t.aj/4,z=new t.ba,N=new t.a_,U=new t.bl,$=25;N.reserve(32),z.reserve($),U.reserve($);let Z=(X,se)=>$*X+se;for(let X=0;X<$;X++){let se=X*C;for(let re=0;re<$;re++){let he=re*C;z.emplaceBack(he,se);let ae=this._globePoint(he,se,a,f,g,v,S);U.emplaceBack(ae[0],ae[1],ae[2])}}for(let X=0;X<4;X++)for(let se=0;se<4;se++){let re=Z(X,se),he=Z(X,se+1),ae=Z(X+1,se),be=Z(X+1,se+1);N.emplaceBack(re,he,ae),N.emplaceBack(ae,he,be)}this._tileDebugTextIndexBuffer=i.createIndexBuffer(N),this._tileDebugTextBuffer=i.createVertexBuffer(z,t.bc.members),this._globeTileDebugTextBuffer=i.createVertexBuffer(U,t.bm.members),this._tileDebugTextSegments=t.bd.simpleSegment(0,0,$,32)}destroy(i=!1){for(let a in this.buckets)this.buckets[a].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!i&&this.texture&&this.texture instanceof t.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}t.bp.setPbf(t.bq);class tc extends Ta{constructor(i,a,f,g,v){super(i,a,f,g,v),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(i){return this._mrt&&this._mrt.getLayer(i)}setTexture(i,a){let f=a.context,g=f.gl;this.texture=this.texture||a.getTileTexture(i.width),this.texture&&this.texture instanceof t.T?this.texture.update(i,{premultiply:!1}):this.texture=new t.T(f,i,g.RGBA8,{premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(i=16384,a){let f=this._mrt=new t.bp(30),g=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(i-1)}});return this.entireBuffer=null,this.request=t.br(g,(v,S,C,z)=>{if(v)a(v);else try{let N=f.getHeaderLength(S);if(N>i)return void(this.request=this.fetchHeader(N,a));f.parseHeader(S),this._isHeaderLoaded=!0;let U=0;for(let $ of Object.values(f.layers))U=Math.max(U,$.dataIndex[$.dataIndex.length-1].lastByte);S.byteLength>=U&&(this.entireBuffer=S),a(null,this.entireBuffer||S,C,z)}catch(N){a(N)}}),this.request}fetchBand(i,a,f){let g=this._mrt;if(!this._isHeaderLoaded||!g)return void f(new Error("Tile header is not ready"));let v=this.actor;if(!v)return void f(new Error("Can't fetch tile band without an actor"));let S,C=($,Z)=>{S.complete($,Z),$?f($):(this.updateTextureDescriptor(i,a),f(null,this.textureDescriptor&&this.textureDescriptor.img))},z=($,Z)=>{if($)return f($);let X=v.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:Z,task:S},C,void 0,!0);this._workQueue.push(()=>{X&&X.cancel(),S.cancel()})},N=g.getLayer(i);if(!N)return void f(new Error(`Unknown sourceLayer "${i}"`));if(N.hasDataForBand(a))return this.updateTextureDescriptor(i,a),void f(null,this.textureDescriptor?this.textureDescriptor.img:null);let U=N.getDataRange([a]);if(S=g.createDecodingTask(U),!S||S.tasks.length)if(this.flushQueues(),this.entireBuffer)z(null,this.entireBuffer.slice(U.firstByte,U.lastByte+1));else{let $=Object.assign({},this.requestParams,{headers:{Range:`bytes=${U.firstByte}-${U.lastByte}`}}),Z=t.br($,z);this._fetchQueue.push(()=>{Z.cancel(),S.cancel()})}else f(null)}updateNeeded(i,a){return(!this.textureDescriptor||this.textureDescriptor.band!==a||this.textureDescriptor.layer!==i)&&this.state!=="errored"}updateTextureDescriptor(i,a){if(!this._mrt)return;let f=this._mrt.getLayer(i);if(!f||!f.hasBand(a)||!f.hasDataForBand(a))return;let{bytes:g,tileSize:v,buffer:S,offset:C,scale:z}=f.getBandView(a),N=v+2*S,U=new t.r({width:N,height:N},g),$=this.texture;$&&$ instanceof t.T&&$.update(U,{premultiply:!1}),this.textureDescriptor={layer:i,band:a,img:U,buffer:S,offset:C,tileSize:v,format:f.pixelFormat,mix:[z,256*z,65536*z,16777216*z]}}}class Id{constructor(i,a){this.max=i,this.onRemove=a,this.reset()}reset(){for(let i in this.data)for(let a of this.data[i])a.timeout&&clearTimeout(a.timeout),this.onRemove(a.value);return this.data={},this.order=[],this}add(i,a,f){let g=i.wrapped().key;this.data[g]===void 0&&(this.data[g]=[]);let v={value:a,timeout:void 0};if(f!==void 0&&(v.timeout=setTimeout(()=>{this.remove(i,v)},f)),this.data[g].push(v),this.order.push(g),this.order.length>this.max){let S=this._getAndRemoveByKey(this.order[0]);S&&this.onRemove(S)}return this}has(i){return i.wrapped().key in this.data}getAndRemove(i){return this.has(i)?this._getAndRemoveByKey(i.wrapped().key):null}_getAndRemoveByKey(i){let a=this.data[i].shift();return a.timeout&&clearTimeout(a.timeout),this.data[i].length===0&&delete this.data[i],this.order.splice(this.order.indexOf(i),1),a.value}getByKey(i){let a=this.data[i];return a?a[0].value:null}get(i){return this.has(i)?this.data[i.wrapped().key][0].value:null}remove(i,a){if(!this.has(i))return this;let f=i.wrapped().key,g=a===void 0?0:this.data[f].indexOf(a),v=this.data[f][g];return this.data[f].splice(g,1),v.timeout&&clearTimeout(v.timeout),this.data[f].length===0&&delete this.data[f],this.onRemove(v.value),this.order.splice(this.order.indexOf(f),1),this}setMaxSize(i){for(this.max=i;this.order.length>this.max;){let a=this._getAndRemoveByKey(this.order[0]);a&&this.onRemove(a)}return this}filter(i){let a=[];for(let f in this.data)for(let g of this.data[f])i(g.value)||a.push(g);for(let f of a)this.remove(f.value.tileID,f)}}class su{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(i,a,f){let g=String(a);if(this.stateChanges[i]=this.stateChanges[i]||{},this.stateChanges[i][g]=this.stateChanges[i][g]||{},t.l(this.stateChanges[i][g],f),this.deletedStates[i]===null){this.deletedStates[i]={};for(let v in this.state[i])v!==g&&(this.deletedStates[i][v]=null)}else if(this.deletedStates[i]&&this.deletedStates[i][g]===null){this.deletedStates[i][g]={};for(let v in this.state[i][g])f[v]||(this.deletedStates[i][g][v]=null)}else for(let v in f)this.deletedStates[i]&&this.deletedStates[i][g]&&this.deletedStates[i][g][v]===null&&delete this.deletedStates[i][g][v]}removeFeatureState(i,a,f){if(this.deletedStates[i]===null)return;let g=String(a);if(this.deletedStates[i]=this.deletedStates[i]||{},f&&a!==void 0)this.deletedStates[i][g]!==null&&(this.deletedStates[i][g]=this.deletedStates[i][g]||{},this.deletedStates[i][g][f]=null);else if(a!==void 0)if(this.stateChanges[i]&&this.stateChanges[i][g])for(f in this.deletedStates[i][g]={},this.stateChanges[i][g])this.deletedStates[i][g][f]=null;else this.deletedStates[i][g]=null;else this.deletedStates[i]=null}getState(i,a){let f=this.state[i]||{},g=this.stateChanges[i]||{},v=this.deletedStates[i];if(v===null)return{};if(a!==void 0){let C=String(a),z=t.l({},f[C],g[C]);if(v){let N=v[a];if(N===null)return{};for(let U in N)delete z[U]}return z}let S=t.l({},f,g);if(v)for(let C in v)delete S[C];return S}initializeTileState(i,a){i.refreshFeatureState(a)}coalesceChanges(i,a){let f={};for(let g in this.stateChanges){this.state[g]=this.state[g]||{};let v={};for(let S in this.stateChanges[g])this.state[g][S]||(this.state[g][S]={}),t.l(this.state[g][S],this.stateChanges[g][S]),v[S]=this.state[g][S];f[g]=v}for(let g in this.deletedStates){this.state[g]=this.state[g]||{};let v={};if(this.deletedStates[g]===null)for(let S in this.state[g])v[S]={},this.state[g][S]={};else for(let S in this.deletedStates[g]){if(this.deletedStates[g][S]===null)this.state[g][S]={};else if(this.state[g][S])for(let C of Object.keys(this.deletedStates[g][S]))delete this.state[g][S][C];v[S]=this.state[g][S]}f[g]=f[g]||{},t.l(f[g],v)}if(this.stateChanges={},this.deletedStates={},Object.keys(f).length!==0)for(let g in i)i[g].refreshFeatureState(a)}}class Uo extends t.E{constructor(i,a,f){super(),this.id=i,this._onlySymbols=f,a.on("data",g=>{g.dataType==="source"&&g.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&g.dataType==="source"&&g.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),a.on("error",()=>{this._sourceErrored=!0}),this._source=a,this._tiles={},this._cache=new Id(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=a.minTileCacheSize,this._maxTileCacheSize=a.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new su,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(i){this.map=i,this._minTileCacheSize=this._minTileCacheSize===void 0&&i?i._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&i?i._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(let i in this._tiles)if(!this._tiles[i].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;let i=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,i&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(i,a){return i.isSymbolTile=this._onlySymbols,i.isExtraShadowCaster=this._shadowCasterTiles[i.tileID.key],this._source.loadTile(i,a)}_unloadTile(i){if(this._source.unloadTile)return this._source.unloadTile(i)}_abortTile(i){if(this._source.abortTile)return this._source.abortTile(i)}serialize(){return this._source.serialize()}prepare(i){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(let a in this._tiles){let f=this._tiles[a];f.upload(i),f.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(i=>i.tileID).sort(Al).map(i=>i.key)}getRenderableIds(i,a){let f=[];for(let g in this._tiles)this._isIdRenderable(+g,i,a)&&f.push(this._tiles[g]);return i?f.sort((g,v)=>{let S=g.tileID,C=v.tileID,z=new t.P(S.canonical.x,S.canonical.y)._rotate(this.transform.angle),N=new t.P(C.canonical.x,C.canonical.y)._rotate(this.transform.angle);return S.overscaledZ-C.overscaledZ||N.y-z.y||N.x-z.x}).map(g=>g.tileID.key):f.map(g=>g.tileID).sort(Al).map(g=>g.key)}hasRenderableParent(i){let a=this.findLoadedParent(i,0);return!!a&&this._isIdRenderable(a.tileID.key)}_isIdRenderable(i,a,f){return this._tiles[i]&&this._tiles[i].hasData()&&!this._coveredTiles[i]&&(a||!this._tiles[i].holdingForFade())&&(f||!this._shadowCasterTiles[i])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(let i in this._tiles)this._tiles[i].state!=="errored"&&this._reloadTile(+i,"reloading")}}_reloadTile(i,a){let f=this._tiles[i];f&&(f.state!=="loading"&&(f.state=a),this._loadTile(f,this._tileLoaded.bind(this,f,i,a)))}_tileLoaded(i,a,f,g){if(g)if(i.state="errored",g.status!==404)this._source.fire(new t.z(g,{tile:i}));else{if(this._source.fire(new t.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:i})),!(i.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){let v=this.map.painter.terrain;this.update(this.transform,v.getScaledDemTileSize(),!0),v.resetTileLookupCache(this.id)}else this.update(this.transform)}else i.timeAdded=t.q.now(),f==="expired"&&(i.refreshedUponExpiration=!0),this._setTileReloadTimer(a,i),this._source.type==="raster-dem"&&i.dem&&this._backfillDEM(i),this._state.initializeTileState(i,this.map?this.map.painter:null),this._source.fire(new t.A("data",{dataType:"source",tile:i,coord:i.tileID,sourceCacheId:this.id}))}_backfillDEM(i){let a=this.getRenderableIds();for(let g=0;g<a.length;g++){let v=a[g];if(i.neighboringTiles&&i.neighboringTiles[v]){let S=this.getTileByID(v);f(i,S),f(S,i)}}function f(g,v){if(!g.dem||g.dem.borderReady)return;g.needsHillshadePrepare=!0,g.needsDEMTextureUpload=!0;let S=v.tileID.canonical.x-g.tileID.canonical.x,C=v.tileID.canonical.y-g.tileID.canonical.y,z=Math.pow(2,g.tileID.canonical.z),N=v.tileID.key;S===0&&C===0||Math.abs(C)>1||(Math.abs(S)>1&&(Math.abs(S+z)===1?S+=z:Math.abs(S-z)===1&&(S-=z)),v.dem&&g.dem&&(g.dem.backfillBorder(v.dem,S,C),g.neighboringTiles&&g.neighboringTiles[N]&&(g.neighboringTiles[N].backfilled=!0)))}}getTile(i){return this.getTileByID(i.key)}getTileByID(i){return this._tiles[i]}_retainLoadedChildren(i,a,f,g){for(let v in this._tiles){let S=this._tiles[v];if(g[v]||!S.hasData()||S.tileID.overscaledZ<=a||S.tileID.overscaledZ>f)continue;let C=S.tileID;for(;S&&S.tileID.overscaledZ>a+1;){let N=S.tileID.scaledTo(S.tileID.overscaledZ-1);S=this._tiles[N.key],S&&S.hasData()&&(C=N)}let z=C;for(;z.overscaledZ>a;)if(z=z.scaledTo(z.overscaledZ-1),i[z.key]){g[C.key]=C;break}}}findLoadedParent(i,a){if(i.key in this._loadedParentTiles){let f=this._loadedParentTiles[i.key];return f&&f.tileID.overscaledZ>=a?f:null}for(let f=i.overscaledZ-1;f>=a;f--){let g=i.scaledTo(f),v=this._getLoadedTile(g);if(v)return v}}_getLoadedTile(i){let a=this._tiles[i.key];return a&&a.hasData()?a:this._cache.getByKey(this._source.reparseOverscaled?i.wrapped().key:i.canonical.key)}updateCacheSize(i,a){a=a||this._source.tileSize;let f=Math.ceil(i.width/a)+1,g=Math.ceil(i.height/a)+1,v=Math.floor(f*g*5),S=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,v):v,C=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,S):S;this._cache.setMaxSize(C)}handleWrapJump(i){let a=Math.round((i-(this._prevLng===void 0?i:this._prevLng))/360);if(this._prevLng=i,a){let f={};for(let g in this._tiles){let v=this._tiles[g];v.tileID=v.tileID.unwrapTo(v.tileID.wrap+a),f[v.tileID.key]=v}this._tiles=f;for(let g in this._timers)clearTimeout(this._timers[g]),delete this._timers[g];for(let g in this._tiles)this._setTileReloadTimer(+g,this._tiles[g])}}update(i,a,f,g,v){if(this.transform=i,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!f)return;this.updateCacheSize(i,a),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};let S=this._source.type==="batched-model",C,z=this._source.maxzoom,N=this.map&&this.map.painter?this.map.painter._terrain:null;if(N&&N.sourceCache===this&&N.attenuationRange()){let Z=N.attenuationRange()[0],X=Math.floor(Z)-Math.log2(N.getDemUpscale());z>X&&(z=X)}if(this.used||this.usedForTerrain){if(this._source.tileID)C=i.getVisibleUnwrappedCoordinates(this._source.tileID).map(Z=>new t.aM(Z.canonical.z,Z.wrap,Z.canonical.z,Z.canonical.x,Z.canonical.y));else if(this.tileCoverLift!==0){let Z=i.clone();Z.tileCoverLift=this.tileCoverLift,C=Z.coveringTiles({tileSize:a||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:z,roundZoom:this._source.roundZoom&&!f,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:S}),this._source.minzoom<=1&&i.projection.name==="globe"&&(C.push(new t.aM(1,0,1,0,0)),C.push(new t.aM(1,0,1,1,0)),C.push(new t.aM(1,0,1,0,1)),C.push(new t.aM(1,0,1,1,1)))}else if(C=i.coveringTiles({tileSize:a||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:z,roundZoom:this._source.roundZoom&&!f,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:S}),this._source.hasTile){let Z=this._source.hasTile.bind(this._source);C=C.filter(X=>Z(X))}}else C=[];if(C.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!Pr(this._source.type)){let Z=i.coveringZoomLevel({tileSize:a||this._source.tileSize,roundZoom:this._source.roundZoom&&!f}),X=Math.min(Z,this._source.maxzoom);if(S){let se=i.extendTileCover(C,X);for(let re of se)C.push(re)}else if(v){let se=i.extendTileCover(C,X,this.transform._camera.forward());for(let re of se)C.push(re)}else if(this.castsShadows&&g){let se=i.extendTileCover(C,X,g);for(let re of se)this._shadowCasterTiles[re.key]=!0,C.push(re)}}let U=this._updateRetainedTiles(C);if(Pr(this._source.type)&&C.length!==0){let Z={},X={},se=Object.keys(U);for(let he of se){let ae=U[he],be=this._tiles[he];if(!be||be.fadeEndTime&&be.fadeEndTime<=t.q.now())continue;let Pe=this.findLoadedParent(ae,Math.max(ae.overscaledZ-Uo.maxOverzooming,this._source.minzoom));Pe&&(this._addTile(Pe.tileID),Z[Pe.tileID.key]=Pe.tileID),X[he]=ae}let re=C[C.length-1].overscaledZ;for(let he in this._tiles){let ae=this._tiles[he];if(U[he]||!ae.hasData())continue;let be=ae.tileID;for(;be.overscaledZ>re;){be=be.scaledTo(be.overscaledZ-1);let Pe=this._tiles[be.key];if(Pe&&Pe.hasData()&&X[be.key]){U[he]=ae.tileID;break}}}for(let he in Z)U[he]||(this._coveredTiles[he]=!0,U[he]=Z[he])}for(let Z in U)this._tiles[Z].clearFadeHold();let $=t.bs(this._tiles,U);for(let Z of $){let X=this._tiles[Z];X.hasSymbolBuckets&&!X.holdingForFade()?X.setHoldDuration(this.map._fadeDuration):X.hasSymbolBuckets&&!X.symbolFadeFinished()||this._removeTile(+Z)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(let i in this._tiles)this._tiles[i].holdingForFade()&&this._removeTile(+i)}_updateRetainedTiles(i){let a={};if(i.length===0)return a;let f={},g=i.reduce((N,U)=>Math.min(N,U.overscaledZ),1/0),v=i[0].overscaledZ,S=Math.max(v-Uo.maxOverzooming,this._source.minzoom),C=Math.max(v+Uo.maxUnderzooming,this._source.minzoom),z={};for(let N of i){let U=this._addTile(N);a[N.key]=N,U.hasData()||g<this._source.maxzoom&&(z[N.key]=N)}this._retainLoadedChildren(z,g,C,a);for(let N of i){let U=this._tiles[N.key];if(U.hasData())continue;if(N.canonical.z>=this._source.maxzoom){let Z=N.children(this._source.maxzoom)[0],X=this.getTile(Z);if(X&&X.hasData()){a[Z.key]=Z;continue}}else{let Z=N.children(this._source.maxzoom);if(a[Z[0].key]&&a[Z[1].key]&&a[Z[2].key]&&a[Z[3].key])continue}let $=U.wasRequested();for(let Z=N.overscaledZ-1;Z>=S;--Z){let X=N.scaledTo(Z);if(f[X.key]||(f[X.key]=!0,U=this.getTile(X),!U&&$&&(U=this._addTile(X)),U&&(a[X.key]=X,$=U.wasRequested(),U.hasData())))break}}return a}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(let i in this._tiles){let a=[],f,g=this._tiles[i].tileID;for(;g.overscaledZ>0;){if(g.key in this._loadedParentTiles){f=this._loadedParentTiles[g.key];break}a.push(g.key);let v=g.scaledTo(g.overscaledZ-1);if(f=this._getLoadedTile(v),f)break;g=v}for(let v of a)this._loadedParentTiles[v]=f}}_addTile(i){let a=this._tiles[i.key];if(a)return a.isExtraShadowCaster!==!0||this._shadowCasterTiles[i.key]||this._reloadTile(i.key,"reloading"),a;a=this._cache.getAndRemove(i),a&&(this._setTileReloadTimer(i.key,a),a.tileID=i,this._state.initializeTileState(a,this.map?this.map.painter:null),this._cacheTimers[i.key]&&(clearTimeout(this._cacheTimers[i.key]),delete this._cacheTimers[i.key],this._setTileReloadTimer(i.key,a)));let f=!!a;if(!f){let g=this.map?this.map.painter:null,v=this._source.tileSize*i.overscaleFactor();a=this._source.type==="raster-array"?new tc(i,v,this.transform.tileZoom,g,this._isRaster):new Ta(i,v,this.transform.tileZoom,g,this._isRaster),this._loadTile(a,this._tileLoaded.bind(this,a,i.key,a.state))}return a.uses++,this._tiles[i.key]=a,f||this._source.fire(new t.A("dataloading",{tile:a,coord:a.tileID,dataType:"source"})),a}_setTileReloadTimer(i,a){i in this._timers&&(clearTimeout(this._timers[i]),delete this._timers[i]);let f=a.getExpiryTimeout();f&&(this._timers[i]=setTimeout(()=>{this._reloadTile(i,"expired"),delete this._timers[i]},f))}_removeTile(i){let a=this._tiles[i];a&&(a.uses--,delete this._tiles[i],this._timers[i]&&(clearTimeout(this._timers[i]),delete this._timers[i]),a.uses>0||(a.hasData()&&a.state!=="reloading"||a.state==="empty"?this._cache.add(a.tileID,a,a.getExpiryTimeout()):(a.aborted=!0,this._abortTile(a),this._unloadTile(a))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(let i in this._tiles)this._removeTile(+i);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(i,a,f){let g=[],v=this.transform;if(!v)return g;let S=v.projection.name==="globe",C=t.ay(v.center.lng);for(let z in this._tiles){let N=this._tiles[z];if(f&&N.clearQueryDebugViz(),N.holdingForFade())continue;let U;if(S){let $=N.tileID.canonical;if($.z===0){let Z=[Math.abs(t.aD(C,...vc($,-1))-C),Math.abs(t.aD(C,...vc($,1))-C)];U=[0,2*Z.indexOf(Math.min(...Z))-1]}else{let Z=[Math.abs(t.aD(C,...vc($,-1))-C),Math.abs(t.aD(C,...vc($,0))-C),Math.abs(t.aD(C,...vc($,1))-C)];U=[Z.indexOf(Math.min(...Z))-1]}}else U=[0];for(let $ of U){let Z=i.containsTile(N,v,a,$);Z&&g.push(Z)}}return g}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(i){return this._getRenderableCoordinates(i)}_getRenderableCoordinates(i,a){let f=this.getRenderableIds(i,a).map(v=>this._tiles[v].tileID),g=this.transform.projection.name==="globe";for(let v of f)v.projMatrix=this.transform.calculateProjMatrix(v.toUnwrapped()),v.expandedProjMatrix=g?this.transform.calculateProjMatrix(v.toUnwrapped(),!1,!0):v.projMatrix;return f}sortCoordinatesByDistance(i){let a=i.slice(),f=this.transform._camera.position,g=this.transform._camera.forward(),v={};for(let S of a){let C=1/(1<<S.canonical.z);v[S.key]=((S.canonical.x+.5)*C+S.wrap-f[0])*g[0]+((S.canonical.y+.5)*C-f[1])*g[1]-f[2]*g[2]}return a.sort((S,C)=>v[S.key]-v[C.key]),a}hasTransition(){if(this._source.hasTransition())return!0;if(Pr(this._source.type))for(let i in this._tiles){let a=this._tiles[i];if(a.fadeEndTime!==void 0&&a.fadeEndTime>=t.q.now())return!0}return!1}setFeatureState(i,a,f){this._state.updateState(i=i||"_geojsonTileLayer",a,f)}removeFeatureState(i,a,f){this._state.removeFeatureState(i=i||"_geojsonTileLayer",a,f)}getFeatureState(i,a){return this._state.getState(i=i||"_geojsonTileLayer",a)}setDependencies(i,a,f){let g=this._tiles[i];g&&g.setDependencies(a,f)}reloadTilesForDependencies(i,a){for(let f in this._tiles)this._tiles[f].hasDependency(i,a)&&this._reloadTile(+f,"reloading");this._cache.filter(f=>!f.hasDependency(i,a))}_preloadTiles(i,a){if(!this._sourceLoaded){let z=()=>{this._sourceLoaded&&(this._source.off("data",z),this._preloadTiles(i,a))};return void this._source.on("data",z)}let f=new Map,g=Array.isArray(i)?i:[i],v=this.map.painter.terrain,S=this.usedForTerrain&&v?v.getScaledDemTileSize():this._source.tileSize;for(let z of g){let N=z.coveringTiles({tileSize:S,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(let U of N)f.set(U.key,U);this.usedForTerrain&&z.updateElevation(!1)}let C=Array.from(f.values());t.bt(C,(z,N)=>{let U=new Ta(z,this._source.tileSize*z.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(U,$=>{this._source.type==="raster-dem"&&U.dem&&this._backfillDEM(U),N($,U)})},a)}}function Al(p,i){let a=Math.abs(2*p.wrap)-+(p.wrap<0),f=Math.abs(2*i.wrap)-+(i.wrap<0);return p.overscaledZ-i.overscaledZ||f-a||i.canonical.y-p.canonical.y||i.canonical.x-p.canonical.x}function Pr(p){return p==="raster"||p==="image"||p==="video"||p==="custom"}function vc(p,i){let a=1<<p.z;return[p.x/a+i,(p.x+1)/a+i]}Uo.maxOverzooming=10,Uo.maxUnderzooming=3;class Cd{constructor(i){this.style=i,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];let i=!1,a=!1;for(let f in this.style._mergedLayers){let g=this.style._mergedLayers[f];if(g.type==="fill-extrusion")this.layers.push({layer:g,visible:i,visibilityChanged:a});else if(g.type==="model"){let v=this.style.getLayerSource(g);v&&v.type==="batched-model"&&this.layers.push({layer:g,visible:i,visibilityChanged:a})}}}onNewFrame(i){this.layersGotHidden=!1;for(let a of this.layers){let f=a.layer,g=!1;f.type==="fill-extrusion"?g=!f.isHidden(i)&&f.paint.get("fill-extrusion-opacity")>0:f.type==="model"&&(g=!f.isHidden(i)&&f.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!g&&a.visible,a.visible=g}}updateZOffset(i,a){this.currentBuildingBuckets=[];for(let g of this.layers){let v=g.layer,S=this.style.getLayerSourceCache(v),C=1;v.type==="fill-extrusion"&&(C=g.visible?v.paint.get("fill-extrusion-vertical-scale"):0);let z=S?S.getTile(a):null;if(!z&&S&&a.canonical.z>S.getSource().minzoom){let N=a.scaledTo(Math.min(S.getSource().maxzoom,a.overscaledZ-1));for(;N.overscaledZ>=S.getSource().minzoom&&(z=S.getTile(N),!z&&N.overscaledZ!==0);)N=N.scaledTo(N.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:z?z.getBucket(v):null,tileID:z?z.tileID:a,verticalScale:C})}i.hasAnyZOffset=!1;let f=!1;for(let g=0;g<i.symbolInstances.length;g++){let v=i.symbolInstances.get(g),S=v.zOffset,C=this._getHeightAtTileOffset(a,v.tileAnchorX,v.tileAnchorY);v.zOffset=C!==Number.NEGATIVE_INFINITY?C:S,f||S===v.zOffset||(f=!0),i.hasAnyZOffset||v.zOffset===0||(i.hasAnyZOffset=!0)}f&&(i.zOffsetBuffersNeedUpload=!0,i.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(i,a,f,g){let v=a,S=f;if(i.canonical.z!==g.canonical.z){let C=g.canonical,z=1/(1<<i.canonical.z-C.z);v=(a+i.canonical.x*t.aj)*z-C.x*t.aj|0,S=(f+i.canonical.y*t.aj)*z-C.y*t.aj|0}return{tileX:v,tileY:S}}_getHeightAtTileOffset(i,a,f){let g,v;for(let S=0;S<this.layers.length;++S){if(this.layers[S].layer.type!=="fill-extrusion")continue;let{bucket:C,tileID:z,verticalScale:N}=this.currentBuildingBuckets[S];if(!C)continue;let{tileX:U,tileY:$}=this._mapCoordToOverlappingTile(i,a,f,z),Z=C.getHeightAtTileCoord(U,$);Z&&Z.height!==void 0&&(Z.hidden?g=Z.height:v=Math.max(Z.height*N,v||0))}if(v!==void 0)return v;for(let S=0;S<this.layers.length;++S){let C=this.layers[S];if(C.layer.type!=="model"||!C.visible)continue;let{bucket:z,tileID:N}=this.currentBuildingBuckets[S];if(!z)continue;let{tileX:U,tileY:$}=this._mapCoordToOverlappingTile(i,a,f,N),Z=z.getHeightAtTileCoord(U,$);if(Z&&!Z.hidden)return Z.height===void 0&&g!==void 0?Math.min(Z.maxHeight,g)*Z.verticalScale:Z.height?Z.height*Z.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Lu(p,i){let a={};for(let f in p)f!=="ref"&&(a[f]=p[f]);return t.bu.forEach(f=>{f in i&&(a[f]=i[f])}),a}function Xs(p){p=p.slice();let i=Object.create(null);for(let a=0;a<p.length;a++)i[p[a].id]=p[a];for(let a=0;a<p.length;a++)"ref"in p[a]&&(p[a]=Lu(p[a],i[p[a].ref]));return p}let wn={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function Ps(p,i,a){a.push({command:wn.addSource,args:[p,i[p]]})}function gs(p,i,a){i.push({command:wn.removeSource,args:[p]}),a[p]=!0}function cs(p,i,a,f){gs(p,a,f),Ps(p,i,a)}function Ed(p,i,a){let f;for(f in p[a])if(p[a].hasOwnProperty(f)&&f!=="data"&&!t.bv(p[a][f],i[a][f]))return!1;for(f in i[a])if(i[a].hasOwnProperty(f)&&f!=="data"&&!t.bv(p[a][f],i[a][f]))return!1;return!0}function Cr(p,i,a,f,g,v){let S;for(S in i=i||{},p=p||{})p.hasOwnProperty(S)&&(t.bv(p[S],i[S])||a.push({command:v,args:[f,S,i[S],g]}));for(S in i)i.hasOwnProperty(S)&&!p.hasOwnProperty(S)&&(t.bv(p[S],i[S])||a.push({command:v,args:[f,S,i[S],g]}))}function As(p){return p.id}function or(p,i){return p[i.id]=i,p}class Tr{constructor(i,a){this.reset(i,a)}reset(i,a){this.points=i||[],this._distances=[0];for(let f=1;f<this.points.length;f++)this._distances[f]=this._distances[f-1]+this.points[f].dist(this.points[f-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(a||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(i){if(this.points.length===1)return this.points[0];i=t.aD(i,0,1);let a=1,f=this._distances[a],g=i*this.paddedLength+this.padding;for(;f<g&&a<this._distances.length;)f=this._distances[++a];let v=a-1,S=this._distances[v],C=f-S,z=C>0?(g-S)/C:0;return this.points[v].mult(1-z).add(this.points[a].mult(z))}}class Xc{constructor(i,a,f){let g=this.boxCells=[],v=this.circleCells=[];this.xCellCount=Math.ceil(i/f),this.yCellCount=Math.ceil(a/f);for(let S=0;S<this.xCellCount*this.yCellCount;S++)g.push([]),v.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=i,this.height=a,this.xScale=this.xCellCount/i,this.yScale=this.yCellCount/a,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(i,a,f,g,v){this._forEachCell(a,f,g,v,this._insertBoxCell,this.boxUid++),this.boxKeys.push(i),this.bboxes.push(a),this.bboxes.push(f),this.bboxes.push(g),this.bboxes.push(v)}insertCircle(i,a,f,g){this._forEachCell(a-g,f-g,a+g,f+g,this._insertCircleCell,this.circleUid++),this.circleKeys.push(i),this.circles.push(a),this.circles.push(f),this.circles.push(g)}_insertBoxCell(i,a,f,g,v,S){this.boxCells[v].push(S)}_insertCircleCell(i,a,f,g,v,S){this.circleCells[v].push(S)}_query(i,a,f,g,v,S){if(f<0||i>this.width||g<0||a>this.height)return!v&&[];let C=[];if(i<=0&&a<=0&&this.width<=f&&this.height<=g){if(v)return!0;for(let z=0;z<this.boxKeys.length;z++)C.push({key:this.boxKeys[z],x1:this.bboxes[4*z],y1:this.bboxes[4*z+1],x2:this.bboxes[4*z+2],y2:this.bboxes[4*z+3]});for(let z=0;z<this.circleKeys.length;z++){let N=this.circles[3*z],U=this.circles[3*z+1],$=this.circles[3*z+2];C.push({key:this.circleKeys[z],x1:N-$,y1:U-$,x2:N+$,y2:U+$})}return S?C.filter(S):C}return this._forEachCell(i,a,f,g,this._queryCell,C,{hitTest:v,seenUids:{box:{},circle:{}}},S),v?C.length>0:C}_queryCircle(i,a,f,g,v){let S=i-f,C=i+f,z=a-f,N=a+f;if(C<0||S>this.width||N<0||z>this.height)return!g&&[];let U=[];return this._forEachCell(S,z,C,N,this._queryCellCircle,U,{hitTest:g,circle:{x:i,y:a,radius:f},seenUids:{box:{},circle:{}}},v),g?U.length>0:U}query(i,a,f,g,v){return this._query(i,a,f,g,!1,v)}hitTest(i,a,f,g,v){return this._query(i,a,f,g,!0,v)}hitTestCircle(i,a,f,g){return this._queryCircle(i,a,f,!0,g)}_queryCell(i,a,f,g,v,S,C,z){let N=C.seenUids,U=this.boxCells[v];if(U!==null){let Z=this.bboxes;for(let X of U)if(!N.box[X]){N.box[X]=!0;let se=4*X;if(i<=Z[se+2]&&a<=Z[se+3]&&f>=Z[se+0]&&g>=Z[se+1]&&(!z||z(this.boxKeys[X]))){if(C.hitTest)return S.push(!0),!0;S.push({key:this.boxKeys[X],x1:Z[se],y1:Z[se+1],x2:Z[se+2],y2:Z[se+3]})}}}let $=this.circleCells[v];if($!==null){let Z=this.circles;for(let X of $)if(!N.circle[X]){N.circle[X]=!0;let se=3*X;if(this._circleAndRectCollide(Z[se],Z[se+1],Z[se+2],i,a,f,g)&&(!z||z(this.circleKeys[X]))){if(C.hitTest)return S.push(!0),!0;{let re=Z[se],he=Z[se+1],ae=Z[se+2];S.push({key:this.circleKeys[X],x1:re-ae,y1:he-ae,x2:re+ae,y2:he+ae})}}}}}_queryCellCircle(i,a,f,g,v,S,C,z){let N=C.circle,U=C.seenUids,$=this.boxCells[v];if($!==null){let X=this.bboxes;for(let se of $)if(!U.box[se]){U.box[se]=!0;let re=4*se;if(this._circleAndRectCollide(N.x,N.y,N.radius,X[re+0],X[re+1],X[re+2],X[re+3])&&(!z||z(this.boxKeys[se])))return S.push(!0),!0}}let Z=this.circleCells[v];if(Z!==null){let X=this.circles;for(let se of Z)if(!U.circle[se]){U.circle[se]=!0;let re=3*se;if(this._circlesCollide(X[re],X[re+1],X[re+2],N.x,N.y,N.radius)&&(!z||z(this.circleKeys[se])))return S.push(!0),!0}}}_forEachCell(i,a,f,g,v,S,C,z){let N=this._convertToXCellCoord(i),U=this._convertToYCellCoord(a),$=this._convertToXCellCoord(f),Z=this._convertToYCellCoord(g);for(let X=N;X<=$;X++)for(let se=U;se<=Z;se++)if(v.call(this,i,a,f,g,this.xCellCount*se+X,S,C,z))return}_convertToXCellCoord(i){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(i*this.xScale)))}_convertToYCellCoord(i){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(i*this.yScale)))}_circlesCollide(i,a,f,g,v,S){let C=g-i,z=v-a,N=f+S;return N*N>C*C+z*z}_circleAndRectCollide(i,a,f,g,v,S,C){let z=(S-g)/2,N=Math.abs(i-(g+z));if(N>z+f)return!1;let U=(C-v)/2,$=Math.abs(a-(v+U));if($>U+f)return!1;if(N<=z||$<=U)return!0;let Z=N-z,X=$-U;return Z*Z+X*X<=f*f}}let Fn={unknown:0,flipRequired:1,flipNotRequired:2},ic=Math.tan(85*Math.PI/180);function Bs(p,i,a,f,g,v,S){let C=t.bz();if(a)if(v.name==="globe"){let z=t.bA(g,i);t.az(C,C,z)}else{let z=t.bB([],S);C[0]=z[0],C[1]=z[1],C[4]=z[2],C[5]=z[3],f||t.by(C,C,g.angle)}else t.az(C,g.labelPlaneMatrix,p);return C}function Kc(p,i,a,f,g,v,S){let C=Bs(p,i,a,f,g,v,S);return v.name==="globe"&&a||(C[2]=C[6]=C[10]=C[14]=0),C}function ll(p,i,a,f,g,v,S){if(a){if(v.name==="globe"){let C=Bs(p,i,a,f,g,v,S);return t.bi(C,C),t.az(C,p,C),C}{let C=t.bw(p),z=t.bx([]);return z[0]=S[0],z[1]=S[1],z[4]=S[2],z[5]=S[3],t.az(C,C,z),f||t.by(C,C,-g.angle),C}}return g.glCoordMatrix}function za(p,i,a,f){let g=[p,i,a,1];a?t.aA(g,g,f):Ds(g,g,f);let v=g[3];return g[0]/=v,g[1]/=v,g[2]/=v,g}function Sa(p,i){return Math.min(.5+p/i*.5,1.5)}function Pp(p,i){let a=p[0]/p[3],f=p[1]/p[3];return a>=-i[0]&&a<=i[0]&&f>=-i[1]&&f<=i[1]}function Ap(p,i,a,f,g,v,S,C,z,N){let U=a.transform,$=f?p.textSizeData:p.iconSizeData,Z=t.bH($,a.transform.zoom),X=U.projection.name==="globe",se=[256/a.width*2+1,256/a.height*2+1],re=f?p.text.dynamicLayoutVertexArray:p.icon.dynamicLayoutVertexArray;re.clear();let he=null;X&&(he=f?p.text.globeExtVertexArray:p.icon.globeExtVertexArray);let ae=p.lineVertexArray,be=f?p.text.placedSymbolArray:p.icon.placedSymbolArray,Pe=a.transform.width/a.transform.height,Re,Ge=!1;for(let Ne=0;Ne<be.length;Ne++){let Ve=be.get(Ne),{numGlyphs:Oe,writingMode:Ke}=Ve;if(Ke!==t.bI.vertical||Ge||Re===t.bI.horizontal||(Ge=!0),Re=Ke,(Ve.hidden||Ke===t.bI.vertical)&&!Ge){sr(Oe,re);continue}Ge=!1;let Qe=new t.P(Ve.tileAnchorX,Ve.tileAnchorY),{x:It,y:gt,z:jt}=U.projection.projectTilePoint(Qe.x,Qe.y,N.canonical);if(z){let[ki,ji,zi]=z(Qe);It+=ki,gt+=ji,jt+=zi}let Ut=[It,gt,jt,1];if(t.aA(Ut,Ut,i),!Pp(Ut,se)){sr(Oe,re);continue}let fi=Ut[3],vt=Sa(a.transform.getCameraToCenterDistance(U.projection),fi),Ct=t.bJ($,Z,Ve),_t=S?Ct/vt:Ct*vt,qt=za(It,gt,jt,g);if(qt[3]<=0){sr(Oe,re);continue}let Pt={},ti=t.al(p.layers[0].layout.get("text-max-angle")),Gt=Math.cos(ti),ii=S?null:z,oi=hs(Ve,_t,!1,C,i,g,v,p.glyphOffsetArray,ae,re,he,qt,Qe,Pt,Pe,ii,U.projection,N,S,Gt);Ge=oi.useVertical,ii&&oi.needsFlipping&&(Pt={}),(oi.notEnoughRoom||Ge||oi.needsFlipping&&hs(Ve,_t,!0,C,i,g,v,p.glyphOffsetArray,ae,re,he,qt,Qe,Pt,Pe,ii,U.projection,N,S,Gt).notEnoughRoom)&&sr(Oe,re)}f?(p.text.dynamicLayoutVertexBuffer.updateData(re),he&&p.text.globeExtVertexBuffer&&p.text.globeExtVertexBuffer.updateData(he)):(p.icon.dynamicLayoutVertexBuffer.updateData(re),he&&p.icon.globeExtVertexBuffer&&p.icon.globeExtVertexBuffer.updateData(he))}function Ah(p,i,a,f,g,v,S,C,z,N,U,$,Z,X,se,re,he){let{lineStartIndex:ae,glyphStartIndex:be,segment:Pe}=C,Re=be+C.numGlyphs,Ge=ae+C.lineLength,Ne=i.getoffsetX(be),Ve=i.getoffsetX(Re-1),Oe=Jc(p*Ne,a,f,g,v,S,Pe,ae,Ge,z,N,U,$,Z,!0,X,se,re,he);if(!Oe)return null;let Ke=Jc(p*Ve,a,f,g,v,S,Pe,ae,Ge,z,N,U,$,Z,!0,X,se,re,he);return Ke?{first:Oe,last:Ke}:null}function nc(p,i,a,f){return p===t.bI.horizontal&&Math.abs(f)>Math.abs(a)?{useVertical:!0}:p===t.bI.vertical?f>0?{needsFlipping:!0}:null:i!==Fn.unknown&&function(g,v){return g===0||Math.abs(v/g)>ic}(a,f)?i===Fn.flipRequired?{needsFlipping:!0}:null:a<0?{needsFlipping:!0}:null}function hs(p,i,a,f,g,v,S,C,z,N,U,$,Z,X,se,re,he,ae,be,Pe){let Re=i/24,Ge=p.lineOffsetX*Re,Ne=p.lineOffsetY*Re,{lineStartIndex:Ve,glyphStartIndex:Oe,numGlyphs:Ke,segment:Qe,writingMode:It,flipState:gt}=p,jt=Ve+p.lineLength,Ut=fi=>{if(U){let[qt,Pt,ti]=fi.up,Gt=N.length;t.bK(U,Gt+0,qt,Pt,ti),t.bK(U,Gt+1,qt,Pt,ti),t.bK(U,Gt+2,qt,Pt,ti),t.bK(U,Gt+3,qt,Pt,ti)}let[vt,Ct,_t]=fi.point;t.bL(N,vt,Ct,_t,fi.angle)};if(Ke>1){let fi=Ah(Re,C,Ge,Ne,a,$,Z,p,z,v,X,re,!1,he,ae,be,Pe);if(!fi)return{notEnoughRoom:!0};if(f&&!a){let[vt,Ct,_t]=fi.first.point,[qt,Pt,ti]=fi.last.point;[vt,Ct]=za(vt,Ct,_t,S),[qt,Pt]=za(qt,Pt,ti,S);let Gt=nc(It,gt,(qt-vt)*se,Pt-Ct);if(p.flipState=Gt&&Gt.needsFlipping?Fn.flipRequired:Fn.flipNotRequired,Gt)return Gt}Ut(fi.first);for(let vt=Oe+1;vt<Oe+Ke-1;vt++){let Ct=Jc(Re*C.getoffsetX(vt),Ge,Ne,a,$,Z,Qe,Ve,jt,z,v,X,re,!1,!1,he,ae,be,Pe);if(!Ct)return N.length-=4*(vt-Oe),{notEnoughRoom:!0};Ut(Ct)}Ut(fi.last)}else{if(f&&!a){let vt=za(Z.x,Z.y,0,g),Ct=Ve+Qe+1,_t=new t.P(z.getx(Ct),z.gety(Ct)),qt=za(_t.x,_t.y,0,g),Pt=qt[3]>0?qt:Yc(Z,_t,vt,1,g,void 0,he,ae.canonical),ti=nc(It,gt,(Pt[0]-vt[0])*se,Pt[1]-vt[1]);if(p.flipState=ti&&ti.needsFlipping?Fn.flipRequired:Fn.flipNotRequired,ti)return ti}let fi=Jc(Re*C.getoffsetX(Oe),Ge,Ne,a,$,Z,Qe,Ve,jt,z,v,X,re,!1,!1,he,ae,be,Pe);if(!fi)return{notEnoughRoom:!0};Ut(fi)}return{}}function Ns(p,i,a,f,g){let{x:v,y:S,z:C}=f.projectTilePoint(p.x,p.y,i);if(!g)return za(v,S,C,a);let[z,N,U]=g(p);return za(v+z,S+N,C+U,a)}function Yc(p,i,a,f,g,v,S,C){let z=Ns(p.sub(i)._unit()._add(p),C,g,S,v);return t.at(z,a,z),t.au(z,z),t.bF(z,a,z,f)}function Jc(p,i,a,f,g,v,S,C,z,N,U,$,Z,X,se,re,he,ae,be){let Pe=f?p-i:p+i,Re=Pe>0?1:-1,Ge=0;f&&(Re*=-1,Ge=Math.PI),Re<0&&(Ge+=Math.PI);let Ne=C+S+(Re>0?0:1)|0,Ve=g,Oe=g,Ke=0,Qe=0,It=Math.abs(Pe),gt=[],jt=[],Ut=v,fi=Ut,vt=t.bC([]),Ct=()=>Yc(fi,Ut,Oe,It-Ke+1,U,Z,re,he.canonical);for(;Ke+Qe<=It;){if(Ne+=Re,Ne<C||Ne>=z)return null;if(Oe=Ve,fi=Ut,gt.push(Oe),X&&jt.push(fi),Ut=new t.P(N.getx(Ne),N.gety(Ne)),Ve=$[Ne],!Ve){let zi=Ns(Ut,he.canonical,U,re,Z);Ve=zi[3]>0?$[Ne]=zi:Ct()}Ke+=Qe;let ki=t.at([],Ve,Oe),ji=t.bD(Oe,Ve);if(a&&ji>0&&Qe>0&&t.bE(vt,ki)/(Qe*ji)<be)return null;Qe=ji,vt=ki}se&&Z&&($[Ne]&&(Ve=Ct(),Qe=t.bD(Oe,Ve),vt=t.at([],Ve,Oe)),$[Ne]=Ve);let _t=(It-Ke)/Qe,qt=Ut.sub(fi)._mult(_t)._add(fi),Pt=t.bF([],Oe,vt,_t),ti=[0,0,1],Gt=vt[0],ii=vt[1];if(ae&&(ti=re.upVector(he.canonical,qt.x,qt.y),ti[0]!==0||ti[1]!==0||ti[2]!==1)){let ki=[ti[2],0,-ti[0]],ji=t.bG([],ti,ki);t.au(ki,ki),t.au(ji,ji),Gt=t.bE(vt,ki),ii=t.bE(vt,ji)}if(a){let ki=t.bG([],ti,vt);t.au(ki,ki),t.bF(Pt,Pt,ki,a*Re)}let oi=Ge+Math.atan2(ii,Gt);return gt.push(Pt),X&&jt.push(qt),{point:Pt,angle:oi,path:gt,tilePath:jt,up:ti}}function sr(p,i){let a=i.length,f=a+4*p;i.resize(f),i.float32.fill(-1/0,4*a,4*f)}function Ds(p,i,a){let f=i[0],g=i[1];return p[0]=a[0]*f+a[4]*g+a[12],p[1]=a[1]*f+a[5]*g+a[13],p[3]=a[3]*f+a[7]*g+a[15],p}let en=100;class au{constructor(i,a,f=new Xc(i.width+200,i.height+200,25),g=new Xc(i.width+200,i.height+200,25)){this.transform=i,this.grid=f,this.ignoredGrid=g,this.pitchfactor=Math.cos(i._pitch)*i.cameraToCenterDistance,this.screenRightBoundary=i.width+en,this.screenBottomBoundary=i.height+en,this.gridRightBoundary=i.width+200,this.gridBottomBoundary=i.height+200,this.fogState=a}placeCollisionBox(i,a,f,g,v,S,C,z){let N=f.projectedAnchorX,U=f.projectedAnchorY,$=f.projectedAnchorZ,Z=f.elevation,X=f.tileID,se=i.getProjection();if(Z&&X){let[Ne,Ve,Oe]=se.upVector(X.canonical,f.tileAnchorX,f.tileAnchorY),Ke=se.upVectorScale(X.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;N+=Ne*Z*Ke,U+=Ve*Z*Ke,$+=Oe*Z*Ke}let re=this.projectAndGetPerspectiveRatio(C,N,U,$,f.tileID,se.name==="globe"||!!Z||this.transform.pitch>0,se),he=S*re.perspectiveRatio,ae=(f.x1*a+g.x-f.padding)*he+re.point.x,be=(f.y1*a+g.y-f.padding)*he+re.point.y,Pe=(f.x2*a+g.x+f.padding)*he+re.point.x,Re=(f.y2*a+g.y+f.padding)*he+re.point.y,Ge=re.perspectiveRatio<=.55||re.occluded;return!this.isInsideGrid(ae,be,Pe,Re)||!v&&this.grid.hitTest(ae,be,Pe,Re,z)||Ge?{box:[],offscreen:!1,occluded:re.occluded}:{box:[ae,be,Pe,Re],offscreen:this.isOffscreen(ae,be,Pe,Re),occluded:!1}}placeCollisionCircles(i,a,f,g,v,S,C,z,N,U,$,Z,X,se,re){let he=[],ae=this.transform.elevation,be=i.getProjection(),Pe=ae?ae.getAtTileOffsetFunc(re,this.transform.center.lat,this.transform.worldSize,be):null,Re=new t.P(f.tileAnchorX,f.tileAnchorY),{x:Ge,y:Ne,z:Ve}=be.projectTilePoint(Re.x,Re.y,re.canonical);if(Pe){let[ti,Gt,ii]=Pe(Re);Ge+=ti,Ne+=Gt,Ve+=ii}let Oe=be.name==="globe",Ke=this.projectAndGetPerspectiveRatio(C,Ge,Ne,Ve,re,Oe||!!ae||this.transform.pitch>0,be),{perspectiveRatio:Qe}=Ke,It=($?S/Qe:S*Qe)/t.bO,gt=za(Ge,Ne,Ve,z),jt=f.lineOffsetX*It,Ut=f.lineOffsetY*It,fi=t.al(i.layers[0].layout.get("text-max-angle")),vt=Math.cos(fi),Ct=Ke.signedDistanceFromCamera>0?Ah(It,v,jt,Ut,!1,gt,Re,f,g,z,{},ae&&!$?Pe:null,$&&!!ae,be,re,$,vt):null,_t=!1,qt=!1,Pt=!0;if(Ct&&!Ke.occluded){let ti=.5*X*Qe+se,Gt=new t.P(-100,-100),ii=new t.P(this.screenRightBoundary,this.screenBottomBoundary),oi=new Tr,{first:ki,last:ji}=Ct,zi=ki.path.length,$i=[];for(let xn=zi-1;xn>=1;xn--)$i.push(ki.path[xn]);for(let xn=1;xn<ji.path.length;xn++)$i.push(ji.path[xn]);let Oi=2.5*ti;N&&($i=$i.map(([xn,Bn,Er],zr)=>(Pe&&!Oe&&(Er=Pe(zr<zi-1?ki.tilePath[zi-1-zr]:ji.tilePath[zr-zi+2])[2]),za(xn,Bn,Er,N))),$i.some(xn=>xn[3]<=0)&&($i=[]));let nn=[];if($i.length>0){let xn=1/0,Bn=-1/0,Er=1/0,zr=-1/0;for(let Gn of $i)xn=Math.min(xn,Gn[0]),Er=Math.min(Er,Gn[1]),Bn=Math.max(Bn,Gn[0]),zr=Math.max(zr,Gn[1]);Bn>=Gt.x&&xn<=ii.x&&zr>=Gt.y&&Er<=ii.y&&(nn=[$i.map(Gn=>new t.P(Gn[0],Gn[1]))],(xn<Gt.x||Bn>ii.x||Er<Gt.y||zr>ii.y)&&(nn=t.bM(nn,Gt.x,Gt.y,ii.x,ii.y)))}for(let xn of nn){oi.reset(xn,.25*ti);let Bn=0;Bn=oi.length<=.5*ti?1:Math.ceil(oi.paddedLength/Oi)+1;for(let Er=0;Er<Bn;Er++){let zr=Er/Math.max(Bn-1,1),Gn=oi.lerp(zr),po=Gn.x+en,no=Gn.y+en;he.push(po,no,ti,0);let En=po-ti,cr=no-ti,pr=po+ti,Or=no+ti;if(Pt=Pt&&this.isOffscreen(En,cr,pr,Or),qt=qt||this.isInsideGrid(En,cr,pr,Or),!a&&this.grid.hitTestCircle(po,no,ti,Z)&&(_t=!0,!U))return{circles:[],offscreen:!1,collisionDetected:_t,occluded:!1}}}}return{circles:!U&&_t||!qt?[]:he,offscreen:Pt,collisionDetected:_t,occluded:Ke.occluded}}queryRenderedSymbols(i){if(i.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};let a=[],f=1/0,g=1/0,v=-1/0,S=-1/0;for(let U of i){let $=new t.P(U.x+en,U.y+en);f=Math.min(f,$.x),g=Math.min(g,$.y),v=Math.max(v,$.x),S=Math.max(S,$.y),a.push($)}let C=this.grid.query(f,g,v,S).concat(this.ignoredGrid.query(f,g,v,S)),z={},N={};for(let U of C){let $=U.key;if(z[$.bucketInstanceId]===void 0&&(z[$.bucketInstanceId]={}),z[$.bucketInstanceId][$.featureIndex])continue;let Z=[new t.P(U.x1,U.y1),new t.P(U.x2,U.y1),new t.P(U.x2,U.y2),new t.P(U.x1,U.y2)];t.bN(a,Z)&&(z[$.bucketInstanceId][$.featureIndex]=!0,N[$.bucketInstanceId]===void 0&&(N[$.bucketInstanceId]=[]),N[$.bucketInstanceId].push($.featureIndex))}return N}insertCollisionBox(i,a,f,g,v){(a?this.ignoredGrid:this.grid).insert({bucketInstanceId:f,featureIndex:g,collisionGroupID:v},i[0],i[1],i[2],i[3])}insertCollisionCircles(i,a,f,g,v){let S=a?this.ignoredGrid:this.grid,C={bucketInstanceId:f,featureIndex:g,collisionGroupID:v};for(let z=0;z<i.length;z+=4)S.insertCircle(C,i[z],i[z+1],i[z+2])}projectAndGetPerspectiveRatio(i,a,f,g,v,S,C){let z=[a,f,g,1],N=!1;g||this.transform.pitch>0?(t.aA(z,z,i),this.fogState&&v&&C.name!=="globe"&&(N=function(Z,X,se,re,he,ae){let be=ae.calculateFogTileMatrix(he),Pe=[X,se,re];return t.ad(Pe,Pe,be),Bt(Z,t.ae(Pe),ae.pitch,ae._fov)}(this.fogState,a,f,g,v.toUnwrapped(),this.transform)>.9)):Ds(z,z,i);let U=z[3];return{point:new t.P((z[0]/U+1)/2*this.transform.width+en,(-z[1]/U+1)/2*this.transform.height+en),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(C)/U*.5,1.5),signedDistanceFromCamera:U,occluded:S&&z[2]>U||N}}isOffscreen(i,a,f,g){return f<en||i>=this.screenRightBoundary||g<en||a>this.screenBottomBoundary}isInsideGrid(i,a,f,g){return f>=0&&i<this.gridRightBoundary&&g>=0&&a<this.gridBottomBoundary}getViewportMatrix(){let i=t.bx([]);return t.bo(i,i,[-100,-100,0]),i}}function Qc(p,i,a){let f=i.createTileMatrix(p,p.worldSize,a.toUnwrapped());return t.az(new Float32Array(16),p.projMatrix,f)}function Dp(p,i,a){if(i.projection.name===a.projection.name)return p.projMatrix;let f=a.clone();return f.setProjection(i.projection),Qc(f,i.getProjection(),p)}function Dl(p,i,a){return i.name===a.projection.name?p.projMatrix:Qc(a,i,p)}class La{constructor(i,a,f,g){this.opacity=i?Math.max(0,Math.min(1,i.opacity+(i.placed?a:-a))):g&&f?1:0,this.placed=f}isHidden(){return this.opacity===0&&!this.placed}}class eh{constructor(i,a,f,g,v,S=!1){this.text=new La(i?i.text:null,a,f,v),this.icon=new La(i?i.icon:null,a,g,v),this.clipped=S}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Dh{constructor(i,a,f,g=!1){this.text=i,this.icon=a,this.skipFade=f,this.clipped=g}}class Ri{constructor(){this.invProjMatrix=t.bz(),this.viewportMatrix=t.bz(),this.circles=[]}}class br{constructor(i,a,f,g,v){this.bucketInstanceId=i,this.featureIndex=a,this.sourceLayerIndex=f,this.bucketIndex=g,this.tileID=v}}class Xn{constructor(i){this.crossSourceCollisions=i,this.maxGroupID=0,this.collisionGroups={}}get(i){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[i]){let a=++this.maxGroupID;this.collisionGroups[i]={ID:a,predicate:f=>f.collisionGroupID===a}}return this.collisionGroups[i]}}function Do(p,i,a,f,g){let{horizontalAlign:v,verticalAlign:S}=t.bV(p),C=-(v-.5)*i,z=-(S-.5)*a,N=t.bU(p,f);return new t.P(C+N[0]*g,z+N[1]*g)}function bc(p,i,a,f,g){let v=new t.P(p,i);return a&&v._rotate(f?g:-g),v}class dr{constructor(i,a,f,g,v,S){this.transform=i.clone(),this.projection=i.projection.name,this.collisionIndex=new au(this.transform,v),this.buildingIndex=S,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=a,this.retainedQueryData={},this.collisionGroups=new Xn(f),this.collisionCircleArrays={},this.prevPlacement=g,g&&(g.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(i,a,f,g,v=1){let S=f.getBucket(a),C=f.latestFeatureIndex;if(!S||!C||a.fqid!==S.layerIds[0])return;let z=S.layers[0].layout,N=S.layers[0].paint,U=f.collisionBoxArray,$=Math.pow(2,this.transform.zoom-f.tileID.overscaledZ),Z=f.tileSize/t.aj,X=f.tileID.toUnwrapped();this.transform.setProjection(S.projection);let se=(re=f.tileID,he=S.getProjection(),ae=this.transform,he.name===this.projection?ae.calculateProjMatrix(re.toUnwrapped()):Qc(ae,he,re));var re,he,ae;let be=z.get("text-pitch-alignment")==="map",Pe=z.get("text-rotation-alignment")==="map";a.compileFilter(a.options);let Re=a.dynamicFilter(),Ge=a.dynamicFilterNeedsFeature(),Ne=this.transform.calculatePixelsToTileUnitsMatrix(f),Ve=Kc(se,f.tileID.canonical,be,Pe,this.transform,S.getProjection(),Ne),Oe=null;if(be){let Ct=ll(se,f.tileID.canonical,be,Pe,this.transform,S.getProjection(),Ne);Oe=t.az([],this.transform.labelPlaneMatrix,Ct)}let Ke=null;Re&&f.latestFeatureIndex&&(Ke={unwrappedTileID:X,dynamicFilter:Re,dynamicFilterNeedsFeature:Ge}),this.retainedQueryData[S.bucketInstanceId]=new br(S.bucketInstanceId,C,S.sourceLayerIndex,S.index,f.tileID);let[Qe,It]=S.layers[0].layout.get("text-size-scale-range"),gt=t.aD(v,Qe,It),[jt,Ut]=z.get("icon-size-scale-range"),fi=t.aD(v,jt,Ut),vt={bucket:S,layout:z,paint:N,posMatrix:se,textLabelPlaneMatrix:Ve,labelToScreenMatrix:Oe,clippingData:Ke,scale:$,textPixelRatio:Z,holdingForFade:f.holdingForFade(),collisionBoxArray:U,partiallyEvaluatedTextSize:t.bH(S.textSizeData,this.transform.zoom,gt),partiallyEvaluatedIconSize:t.bH(S.iconSizeData,this.transform.zoom,fi),collisionGroup:this.collisionGroups.get(S.sourceID),latestFeatureIndex:f.latestFeatureIndex};if(g)for(let Ct of S.sortKeyRanges){let{sortKey:_t,symbolInstanceStart:qt,symbolInstanceEnd:Pt}=Ct;i.push({sortKey:_t,symbolInstanceStart:qt,symbolInstanceEnd:Pt,parameters:vt})}else i.push({symbolInstanceStart:0,symbolInstanceEnd:S.symbolInstances.length,parameters:vt})}attemptAnchorPlacement(i,a,f,g,v,S,C,z,N,U,$,Z,X,se,re,he,ae,be){let{textOffset0:Pe,textOffset1:Re,crossTileID:Ge}=Z,Ne=[Pe,Re],Ve=Do(i,f,g,Ne,v),Oe=this.collisionIndex.placeCollisionBox(se,v,a,bc(Ve.x,Ve.y,S,C,this.transform.angle),$,z,N,U.predicate);if(he){let Ke=se.getSymbolInstanceIconSize(be,this.transform.zoom,Z.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(se,Ke,he,bc(Ve.x,Ve.y,S,C,this.transform.angle),$,z,N,U.predicate).box.length===0)return}if(Oe.box.length>0){let Ke;return this.prevPlacement&&this.prevPlacement.variableOffsets[Ge]&&this.prevPlacement.placements[Ge]&&this.prevPlacement.placements[Ge].text&&(Ke=this.prevPlacement.variableOffsets[Ge].anchor),this.variableOffsets[Ge]={textOffset:Ne,width:f,height:g,anchor:i,textScale:v,prevAnchor:Ke},this.markUsedJustification(se,i,Z,re),se.allowVerticalPlacement&&(this.markUsedOrientation(se,re,Z),this.placedOrientations[Ge]=re),{shift:Ve,placedGlyphBoxes:Oe}}}placeLayerBucketPart(i,a,f,g,v=1){let{bucket:S,layout:C,paint:z,posMatrix:N,textLabelPlaneMatrix:U,labelToScreenMatrix:$,clippingData:Z,textPixelRatio:X,holdingForFade:se,collisionBoxArray:re,partiallyEvaluatedTextSize:he,partiallyEvaluatedIconSize:ae,collisionGroup:be,latestFeatureIndex:Pe}=i.parameters,Re=C.get("text-optional"),Ge=C.get("icon-optional"),Ne=C.get("text-allow-overlap"),Ve=C.get("icon-allow-overlap"),Oe=C.get("text-rotation-alignment")==="map",Ke=C.get("text-pitch-alignment")==="map",Qe=z.get("symbol-z-offset"),It=C.get("symbol-elevation-reference")==="sea",[gt,jt]=C.get("text-size-scale-range"),[Ut,fi]=C.get("icon-size-scale-range"),vt=t.aD(v,gt,jt),Ct=t.aD(v,Ut,fi);this.transform.setProjection(S.projection);let _t=Ne&&(Ve||!S.hasIconData()||Ge),qt=Ve&&(Ne||!S.hasTextData()||Re),Pt=!Qe.isConstant();!S.collisionArrays&&re&&S.deserializeCollisionBoxes(re),f&&g&&S.updateCollisionDebugBuffers(this.transform.zoom,re,vt,Ct);let ti=(Gt,ii,oi)=>{let{crossTileID:ki,numVerticalGlyphVertices:ji}=Gt,zi=null;if(Z&&Z.dynamicFilterNeedsFeature||Pt){let fr=this.retainedQueryData[S.bucketInstanceId];zi=Pe.loadFeature({featureIndex:Gt.featureIndex,bucketIndex:fr.bucketIndex,sourceLayerIndex:fr.sourceLayerIndex,layoutVertexArrayOffset:0})}if(Z&&!(0,Z.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},zi,this.retainedQueryData[S.bucketInstanceId].tileID.canonical,new t.P(Gt.tileAnchorX,Gt.tileAnchorY),this.transform.calculateDistanceTileData(Z.unwrappedTileID)))return this.placements[ki]=new Dh(!1,!1,!1,!0),void a.add(ki);let $i=Qe.evaluate(zi,{});if(a.has(ki))return;if(se)return void(this.placements[ki]=new Dh(!1,!1,!1));let Oi=!1,nn=!1,xn=!0,Bn=!1,Er=!1,zr=null,Gn={box:null,offscreen:null,occluded:null},po={box:null,offscreen:null,occluded:null},no=null,En=null,cr=null,pr=0,Or=0,xs=0;oi.textFeatureIndex?pr=oi.textFeatureIndex:Gt.useRuntimeCollisionCircles&&(pr=Gt.featureIndex),oi.verticalTextFeatureIndex&&(Or=oi.verticalTextFeatureIndex);let Lo=fr=>{fr.tileID=this.retainedQueryData[S.bucketInstanceId].tileID;let so=this.transform.elevation;fr.elevation=It?$i:$i+(so?so.getAtTileOffset(fr.tileID,fr.tileAnchorX,fr.tileAnchorY):0),fr.elevation+=Gt.zOffset},ko=oi.textBox;if(ko){Lo(ko);let fr=Sr=>{let fo=t.bI.horizontal;if(S.allowVerticalPlacement&&!Sr&&this.prevPlacement){let js=this.prevPlacement.placedOrientations[ki];js&&(this.placedOrientations[ki]=js,fo=js,this.markUsedOrientation(S,fo,Gt))}return fo},so=(Sr,fo)=>{if(S.allowVerticalPlacement&&ji>0&&oi.verticalTextBox){for(let js of S.writingModes)if(js===t.bI.vertical?(Gn=fo(),po=Gn):Gn=Sr(),Gn&&Gn.box&&Gn.box.length)break}else Gn=Sr()};if(C.get("text-variable-anchor")){let Sr=C.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[ki]){let Gr=this.prevPlacement.variableOffsets[ki];Sr.indexOf(Gr.anchor)>0&&(Sr=Sr.filter(ea=>ea!==Gr.anchor),Sr.unshift(Gr.anchor))}let fo=(Gr,ea,Xo)=>{let ha=S.getSymbolInstanceTextSize(he,Gt,this.transform.zoom,ii),wh=(Gr.x2-Gr.x1)*ha+2*Gr.padding,Lc=(Gr.y2-Gr.y1)*ha+2*Gr.padding,Zl=Gt.hasIconTextFit&&!Ve?ea:null;Zl&&Lo(Zl);let fc={box:[],offscreen:!1,occluded:!1},Hh=Ne?2*Sr.length:Sr.length;for(let Xh=0;Xh<Hh;++Xh){let Th=this.attemptAnchorPlacement(Sr[Xh%Sr.length],Gr,wh,Lc,ha,Oe,Ke,X,N,be,Xh>=Sr.length,Gt,ii,S,Xo,Zl,he,ae);if(Th&&(fc=Th.placedGlyphBoxes,fc&&fc.box&&fc.box.length)){Oi=!0,zr=Th.shift;break}}return fc};so(()=>fo(ko,oi.iconBox,t.bI.horizontal),()=>{let Gr=oi.verticalTextBox;return Gr&&Lo(Gr),S.allowVerticalPlacement&&!(Gn&&Gn.box&&Gn.box.length)&&ji>0&&Gr?fo(Gr,oi.verticalIconBox,t.bI.vertical):{box:null,offscreen:null,occluded:null}}),Gn&&(Oi=Gn.box,xn=Gn.offscreen,Bn=Gn.occluded);let js=fr(!(!Gn||!Gn.box));if(!Oi&&this.prevPlacement){let Gr=this.prevPlacement.variableOffsets[ki];Gr&&(this.variableOffsets[ki]=Gr,this.markUsedJustification(S,Gr.anchor,Gt,js))}}else{let Sr=(fo,js)=>{let Gr=S.getSymbolInstanceTextSize(he,Gt,this.transform.zoom,ii,v),ea=this.collisionIndex.placeCollisionBox(S,Gr,fo,new t.P(0,0),Ne,X,N,be.predicate);return ea&&ea.box&&ea.box.length&&(this.markUsedOrientation(S,js,Gt),this.placedOrientations[ki]=js),ea};so(()=>Sr(ko,t.bI.horizontal),()=>{let fo=oi.verticalTextBox;return S.allowVerticalPlacement&&ji>0&&fo?(Lo(fo),Sr(fo,t.bI.vertical)):{box:null,offscreen:null,occluded:null}}),fr(!!(Gn&&Gn.box&&Gn.box.length))}}if(no=Gn,Oi=no&&no.box&&no.box.length>0,xn=no&&no.offscreen,Bn=no&&no.occluded,Gt.useRuntimeCollisionCircles){let fr=S.text.placedSymbolArray.get(Gt.centerJustifiedTextSymbolIndex>=0?Gt.centerJustifiedTextSymbolIndex:Gt.verticalPlacedTextSymbolIndex),so=t.bJ(S.textSizeData,he,fr),Sr=C.get("text-padding");En=this.collisionIndex.placeCollisionCircles(S,Ne,fr,S.lineVertexArray,S.glyphOffsetArray,so,N,U,$,f,Ke,be.predicate,Gt.collisionCircleDiameter*so/t.bO,Sr,this.retainedQueryData[S.bucketInstanceId].tileID),Oi=Ne||En.circles.length>0&&!En.collisionDetected,xn=xn&&En.offscreen,Bn=En.occluded}if(oi.iconFeatureIndex&&(xs=oi.iconFeatureIndex),oi.iconBox){let fr=so=>{Lo(so);let Sr=Gt.hasIconTextFit&&zr?bc(zr.x,zr.y,Oe,Ke,this.transform.angle):new t.P(0,0),fo=S.getSymbolInstanceIconSize(ae,this.transform.zoom,Gt.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(S,fo,so,Sr,Ve,X,N,be.predicate)};po&&po.box&&po.box.length&&oi.verticalIconBox?(cr=fr(oi.verticalIconBox),nn=cr.box.length>0):(cr=fr(oi.iconBox),nn=cr.box.length>0),xn=xn&&cr.offscreen,Er=cr.occluded}let ro=Re||Gt.numHorizontalGlyphVertices===0&&ji===0,Dn=Ge||Gt.numIconVertices===0;if(ro||Dn?Dn?ro||(nn=nn&&Oi):Oi=nn&&Oi:nn=Oi=nn&&Oi,Oi&&no&&no.box&&this.collisionIndex.insertCollisionBox(no.box,C.get("text-ignore-placement"),S.bucketInstanceId,po&&po.box&&Or?Or:pr,be.ID),nn&&cr&&this.collisionIndex.insertCollisionBox(cr.box,C.get("icon-ignore-placement"),S.bucketInstanceId,xs,be.ID),En&&(Oi&&this.collisionIndex.insertCollisionCircles(En.circles,C.get("text-ignore-placement"),S.bucketInstanceId,pr,be.ID),f)){let fr=S.bucketInstanceId,so=this.collisionCircleArrays[fr];so===void 0&&(so=this.collisionCircleArrays[fr]=new Ri);for(let Sr=0;Sr<En.circles.length;Sr+=4)so.circles.push(En.circles[Sr+0]),so.circles.push(En.circles[Sr+1]),so.circles.push(En.circles[Sr+2]),so.circles.push(En.collisionDetected?1:0)}let oo=S.projection.name!=="globe";_t=_t&&(oo||!Bn),qt=qt&&(oo||!Er),this.placements[ki]=new Dh(Oi||_t,nn||qt,xn||S.justReloaded),a.add(ki)};if(S.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(S,this.retainedQueryData[S.bucketInstanceId].tileID),S.elevationType==="road"&&S.updateRoadElevation(),S.updateZOffset(),S.sortFeaturesByY){let Gt=S.getSortedSymbolIndexes(this.transform.angle);for(let ii=Gt.length-1;ii>=0;--ii){let oi=Gt[ii];ti(S.symbolInstances.get(oi),oi,S.collisionArrays[oi])}S.hasAnyZOffset&&t.w(`${S.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(S.hasAnyZOffset){let Gt=S.getSortedIndexesByZOffset();for(let ii=0;ii<Gt.length;++ii){let oi=Gt[ii];ti(S.symbolInstances.get(oi),oi,S.collisionArrays[oi])}}else for(let Gt=i.symbolInstanceStart;Gt<i.symbolInstanceEnd;Gt++)ti(S.symbolInstances.get(Gt),Gt,S.collisionArrays[Gt]);if(f&&S.bucketInstanceId in this.collisionCircleArrays){let Gt=this.collisionCircleArrays[S.bucketInstanceId];t.bi(Gt.invProjMatrix,N),Gt.viewportMatrix=this.collisionIndex.getViewportMatrix()}S.justReloaded=!1}markUsedJustification(i,a,f,g){let{leftJustifiedTextSymbolIndex:v,centerJustifiedTextSymbolIndex:S,rightJustifiedTextSymbolIndex:C,verticalPlacedTextSymbolIndex:z,crossTileID:N}=f,U=t.bT(a),$=g===t.bI.vertical?z:U==="left"?v:U==="center"?S:U==="right"?C:-1;v>=0&&(i.text.placedSymbolArray.get(v).crossTileID=$>=0&&v!==$?0:N),S>=0&&(i.text.placedSymbolArray.get(S).crossTileID=$>=0&&S!==$?0:N),C>=0&&(i.text.placedSymbolArray.get(C).crossTileID=$>=0&&C!==$?0:N),z>=0&&(i.text.placedSymbolArray.get(z).crossTileID=$>=0&&z!==$?0:N)}markUsedOrientation(i,a,f){let g=a===t.bI.horizontal||a===t.bI.horizontalOnly?a:0,v=a===t.bI.vertical?a:0,{leftJustifiedTextSymbolIndex:S,centerJustifiedTextSymbolIndex:C,rightJustifiedTextSymbolIndex:z,verticalPlacedTextSymbolIndex:N}=f,U=i.text.placedSymbolArray;S>=0&&(U.get(S).placedOrientation=g),C>=0&&(U.get(C).placedOrientation=g),z>=0&&(U.get(z).placedOrientation=g),N>=0&&(U.get(N).placedOrientation=v)}commit(i){this.commitTime=i,this.zoomAtLastRecencyCheck=this.transform.zoom;let a=this.prevPlacement,f=!1;this.prevZoomAdjustment=a?a.zoomAdjustment(this.transform.zoom):0;let g=a?a.symbolFadeChange(i):1,v=a?a.opacities:{},S=a?a.variableOffsets:{},C=a?a.placedOrientations:{};for(let z in this.placements){let N=this.placements[z],U=v[z];U?(this.opacities[z]=new eh(U,g,N.text,N.icon,null,N.clipped),f=f||N.text!==U.text.placed||N.icon!==U.icon.placed):(this.opacities[z]=new eh(null,g,N.text,N.icon,N.skipFade,N.clipped),f=f||N.text||N.icon)}for(let z in v){let N=v[z];if(!this.opacities[z]){let U=new eh(N,g,!1,!1);U.isHidden()||(this.opacities[z]=U,f=f||N.text.placed||N.icon.placed)}}for(let z in S)this.variableOffsets[z]||!this.opacities[z]||this.opacities[z].isHidden()||(this.variableOffsets[z]=S[z]);for(let z in C)this.placedOrientations[z]||!this.opacities[z]||this.opacities[z].isHidden()||(this.placedOrientations[z]=C[z]);f?this.lastPlacementChangeTime=i:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=a?a.lastPlacementChangeTime:i)}updateLayerOpacities(i,a,f,g){let v=new Set;for(let S of a){let C=S.getBucket(i);C&&S.latestFeatureIndex&&i.fqid===C.layerIds[0]&&(this.updateBucketOpacities(C,v,S,S.collisionBoxArray,f,g,S.tileID,i.scope),C.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(C,S.tileID),C.elevationType==="road"&&C.updateRoadElevation(),C.updateZOffset())}}updateBucketOpacities(i,a,f,g,v,S,C,z){i.hasTextData()&&i.text.opacityVertexArray.clear(),i.hasIconData()&&i.icon.opacityVertexArray.clear(),i.hasIconCollisionBoxData()&&i.iconCollisionBox.collisionVertexArray.clear(),i.hasTextCollisionBoxData()&&i.textCollisionBox.collisionVertexArray.clear();let N=i.layers[0].layout,U=i.layers[0].paint,$=!!i.layers[0].dynamicFilter(),Z=new eh(null,0,!1,!1,!0),X=N.get("text-allow-overlap"),se=N.get("icon-allow-overlap"),re=N.get("text-variable-anchor"),he=N.get("text-rotation-alignment")==="map",ae=N.get("text-pitch-alignment")==="map",be=U.get("symbol-z-offset"),Pe=N.get("symbol-elevation-reference")==="sea",Re=!be.isConstant(),Ge=new eh(null,0,X&&(se||!i.hasIconData()||N.get("icon-optional")),se&&(X||!i.hasTextData()||N.get("text-optional")),!0);!i.collisionArrays&&g&&(i.hasIconCollisionBoxData()||i.hasTextCollisionBoxData())&&i.deserializeCollisionBoxes(g);let Ne=(Oe,Ke,Qe)=>{for(let It=0;It<Ke/4;It++)Oe.opacityVertexArray.emplaceBack(Qe)},Ve=0;S&&i.updateReplacement(C,S);for(let Oe=0;Oe<i.symbolInstances.length;Oe++){let Ke=i.symbolInstances.get(Oe),{numHorizontalGlyphVertices:Qe,numVerticalGlyphVertices:It,crossTileID:gt,numIconVertices:jt,tileAnchorX:Ut,tileAnchorY:fi}=Ke,vt=null,Ct=this.retainedQueryData[i.bucketInstanceId];Re&&Ke&&Ct&&(vt=f.latestFeatureIndex.loadFeature({featureIndex:Ke.featureIndex,bucketIndex:Ct.bucketIndex,sourceLayerIndex:Ct.sourceLayerIndex,layoutVertexArrayOffset:0}));let _t=be.evaluate(vt,{}),qt=a.has(gt),Pt=this.opacities[gt];qt?Pt=Z:Pt||(Pt=Ge,this.opacities[gt]=Pt),a.add(gt);let ti=Qe>0||It>0,Gt=jt>0,ii=this.placedOrientations[gt],oi=ii===t.bI.vertical,ki=ii===t.bI.horizontal||ii===t.bI.horizontalOnly;!ti&&!Gt||Pt.isHidden()||Ve++;let ji=!1;if((ti||Gt)&&S)for(let zi of i.activeReplacements){if(t.bP(zi,v,t.bQ.Symbol,z)||zi.min.x>Ut||Ut>zi.max.x||zi.min.y>fi||fi>zi.max.y)continue;let $i=t.bR(Ut,fi,C.canonical,zi.footprintTileId.canonical);if(ji=t.bS($i,zi.footprint),ji)break}if(ti){let zi=ji?zl:th(Pt.text);Ne(i.text,Qe,oi?zl:zi),Ne(i.text,It,ki?zl:zi);let $i=Pt.text.isHidden(),{leftJustifiedTextSymbolIndex:Oi,centerJustifiedTextSymbolIndex:nn,rightJustifiedTextSymbolIndex:xn,verticalPlacedTextSymbolIndex:Bn}=Ke,Er=i.text.placedSymbolArray,zr=$i||oi?1:0;Oi>=0&&(Er.get(Oi).hidden=zr),nn>=0&&(Er.get(nn).hidden=zr),xn>=0&&(Er.get(xn).hidden=zr),Bn>=0&&(Er.get(Bn).hidden=$i||ki?1:0);let Gn=this.variableOffsets[gt];Gn&&this.markUsedJustification(i,Gn.anchor,Ke,ii);let po=this.placedOrientations[gt];po&&(this.markUsedJustification(i,"left",Ke,po),this.markUsedOrientation(i,po,Ke))}if(Gt){let zi=ji?zl:th(Pt.icon),{placedIconSymbolIndex:$i,verticalPlacedIconSymbolIndex:Oi}=Ke,nn=i.icon.placedSymbolArray,xn=Pt.icon.isHidden()?1:0;$i>=0&&(Ne(i.icon,jt,oi?zl:zi),nn.get($i).hidden=xn),Oi>=0&&(Ne(i.icon,Ke.numVerticalIconVertices,ki?zl:zi),nn.get(Oi).hidden=xn)}if(i.hasIconCollisionBoxData()||i.hasTextCollisionBoxData()){let zi=i.collisionArrays[Oe];if(zi){let $i=new t.P(0,0),Oi=!0;if(zi.textBox||zi.verticalTextBox){if(re){let xn=this.variableOffsets[gt];xn?($i=Do(xn.anchor,xn.width,xn.height,xn.textOffset,xn.textScale),he&&$i._rotate(ae?this.transform.angle:-this.transform.angle)):Oi=!1}$&&(Oi=!Pt.clipped),zi.textBox&&Rl(i.textCollisionBox.collisionVertexArray,Pt.text.placed,!Oi||oi,_t,Pe,$i.x,$i.y),zi.verticalTextBox&&Rl(i.textCollisionBox.collisionVertexArray,Pt.text.placed,!Oi||ki,_t,Pe,$i.x,$i.y)}let nn=Oi&&!!(!ki&&zi.verticalIconBox);zi.iconBox&&Rl(i.iconCollisionBox.collisionVertexArray,Pt.icon.placed,nn,_t,Pe,Ke.hasIconTextFit?$i.x:0,Ke.hasIconTextFit?$i.y:0),zi.verticalIconBox&&Rl(i.iconCollisionBox.collisionVertexArray,Pt.icon.placed,!nn,_t,Pe,Ke.hasIconTextFit?$i.x:0,Ke.hasIconTextFit?$i.y:0)}}}if(i.fullyClipped=Ve===0,i.sortFeatures(this.transform.angle),this.retainedQueryData[i.bucketInstanceId]&&(this.retainedQueryData[i.bucketInstanceId].featureSortOrder=i.featureSortOrder),i.hasTextData()&&i.text.opacityVertexBuffer&&i.text.opacityVertexBuffer.updateData(i.text.opacityVertexArray),i.hasIconData()&&i.icon.opacityVertexBuffer&&i.icon.opacityVertexBuffer.updateData(i.icon.opacityVertexArray),i.hasIconCollisionBoxData()&&i.iconCollisionBox.collisionVertexBuffer&&i.iconCollisionBox.collisionVertexBuffer.updateData(i.iconCollisionBox.collisionVertexArray),i.hasTextCollisionBoxData()&&i.textCollisionBox.collisionVertexBuffer&&i.textCollisionBox.collisionVertexBuffer.updateData(i.textCollisionBox.collisionVertexArray),i.bucketInstanceId in this.collisionCircleArrays){let Oe=this.collisionCircleArrays[i.bucketInstanceId];i.placementInvProjMatrix=Oe.invProjMatrix,i.placementViewportMatrix=Oe.viewportMatrix,i.collisionCircleArray=Oe.circles,delete this.collisionCircleArrays[i.bucketInstanceId]}}symbolFadeChange(i){return this.fadeDuration===0?1:(i-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(i){return Math.max(0,(this.transform.zoom-i)/1.5)}hasTransitions(i){return this.stale||i-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(i,a){let f=this.zoomAtLastRecencyCheck===a?1-this.zoomAdjustment(a):1;return this.zoomAtLastRecencyCheck=a,this.commitTime+this.fadeDuration*f>i}setStale(){this.stale=!0}}function Rl(p,i,a,f,g,v,S){p.emplaceBack(i?1:0,a?1:0,v||0,S||0,f,g?1:0),p.emplaceBack(i?1:0,a?1:0,v||0,S||0,f,g?1:0),p.emplaceBack(i?1:0,a?1:0,v||0,S||0,f,g?1:0),p.emplaceBack(i?1:0,a?1:0,v||0,S||0,f,g?1:0)}let lu=Math.pow(2,25),Md=Math.pow(2,24),ka=Math.pow(2,17),us=Math.pow(2,16),Cm=Math.pow(2,9),Rh=Math.pow(2,8),ku=Math.pow(2,1);function th(p){if(p.opacity===0&&!p.placed)return 0;if(p.opacity===1&&p.placed)return 4294967295;let i=p.placed?1:0,a=Math.floor(127*p.opacity);return a*lu+i*Md+a*ka+i*us+a*Cm+i*Rh+a*ku+i}let zl=0;class Ou{constructor(i){this._sortAcrossTiles=i.layout.get("symbol-z-order")!=="viewport-y"&&i.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(i,a,f,g,v,S){let C=this._bucketParts;for(;this._currentTileIndex<i.length;)if(a.getBucketParts(C,g,i[this._currentTileIndex],this._sortAcrossTiles,S),this._currentTileIndex++,v())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,C.sort((z,N)=>z.sortKey-N.sortKey));this._currentPartIndex<C.length;){let z=C[this._currentPartIndex];if(a.placeLayerBucketPart(z,this._seenCrossTileIDs,f,z.symbolInstanceStart===0,S),this._currentPartIndex++,v())return!0}return!1}}class Ks{constructor(i,a,f,g,v,S,C,z,N){this.placement=new dr(i,v,S,C,z,N),this._currentPlacementIndex=a.length-1,this._forceFullPlacement=f,this._showCollisionBoxes=g,this._done=!1}isDone(){return this._done}continuePlacement(i,a,f,g,v){let S=t.q.now(),C=()=>{let z=t.q.now()-S;return!this._forceFullPlacement&&z>2};for(;this._currentPlacementIndex>=0;){let z=a[i[this._currentPlacementIndex]],N=this.placement.collisionIndex.transform.zoom;if(z.type==="symbol"&&(!z.minzoom||z.minzoom<=N)&&(!z.maxzoom||z.maxzoom>N)){let U=z,$=U.layout.get("symbol-z-elevate"),Z=U.layout.get("symbol-sort-key").constantOr(1)!==void 0,X=U.layout.get("symbol-z-order"),se=X==="viewport-y"||X==="auto"&&!(X!=="viewport-y"&&Z),re=U.layout.get("text-allow-overlap")||U.layout.get("icon-allow-overlap")||U.layout.get("text-ignore-placement")||U.layout.get("icon-ignore-placement"),he=se&&re,ae=this._inProgressLayer=this._inProgressLayer||new Ou(U),be=t.C(z.source,z.scope);if(ae.continuePlacement($||he?g[be]:f[be],this.placement,this._showCollisionBoxes,z,C,v))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(i){return this.placement.commit(i),this.placement}}let Vs=512/t.aj/2;class Xa{constructor(i,a,f){this.tileID=i,this.bucketInstanceId=f,this.index=new t.bW(a.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];let g=i.canonical.x*t.aj,v=i.canonical.y*t.aj;for(let S=0;S<a.length;S++){let{key:C,crossTileID:z,tileAnchorX:N,tileAnchorY:U}=a.get(S),$=Math.floor((g+N)*Vs),Z=Math.floor((v+U)*Vs);this.index.add($,Z),this.keys.push(C),this.crossTileIDs.push(z)}this.index.finish()}findMatches(i,a,f){let g=this.tileID.canonical.z<a.canonical.z?1:Math.pow(2,this.tileID.canonical.z-a.canonical.z),v=Vs/Math.pow(2,a.canonical.z-this.tileID.canonical.z),S=a.canonical.x*t.aj,C=a.canonical.y*t.aj;for(let z=0;z<i.length;z++){let N=i.get(z);if(N.crossTileID)continue;let{key:U,tileAnchorX:$,tileAnchorY:Z}=N,X=Math.floor((S+$)*v),se=Math.floor((C+Z)*v),re=this.index.range(X-g,se-g,X+g,se+g).sort((he,ae)=>he-ae);for(let he of re){let ae=this.crossTileIDs[he];if(this.keys[he]===U&&!f.has(ae)){f.add(ae),N.crossTileID=ae;break}}}}}class Rp{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class wc{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(i){let a=Math.round((i-this.lng)/360);if(a!==0)for(let f in this.indexes){let g=this.indexes[f],v={};for(let S in g){let C=g[S];C.tileID=C.tileID.unwrapTo(C.tileID.wrap+a),v[C.tileID.key]=C}this.indexes[f]=v}this.lng=i}addBucket(i,a,f){if(this.indexes[i.overscaledZ]&&this.indexes[i.overscaledZ][i.key]){if(this.indexes[i.overscaledZ][i.key].bucketInstanceId===a.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(i.overscaledZ,this.indexes[i.overscaledZ][i.key])}for(let v=0;v<a.symbolInstances.length;v++)a.symbolInstances.get(v).crossTileID=0;this.usedCrossTileIDs[i.overscaledZ]||(this.usedCrossTileIDs[i.overscaledZ]=new Set);let g=this.usedCrossTileIDs[i.overscaledZ];for(let v in this.indexes){let S=this.indexes[v];if(Number(v)>i.overscaledZ)for(let C in S){let z=S[C];z.tileID.isChildOf(i)&&z.findMatches(a.symbolInstances,i,g)}else{let C=S[i.scaledTo(Number(v)).key];C&&C.findMatches(a.symbolInstances,i,g)}}for(let v=0;v<a.symbolInstances.length;v++){let S=a.symbolInstances.get(v);S.crossTileID||(S.crossTileID=f.generate(),g.add(S.crossTileID))}return this.indexes[i.overscaledZ]===void 0&&(this.indexes[i.overscaledZ]={}),this.indexes[i.overscaledZ][i.key]=new Xa(i,a.symbolInstances,a.bucketInstanceId),!0}removeBucketCrossTileIDs(i,a){for(let f of a.crossTileIDs)this.usedCrossTileIDs[i].delete(f)}removeStaleBuckets(i){let a=!1;for(let f in this.indexes){let g=this.indexes[f];for(let v in g)i[g[v].bucketInstanceId]||(this.removeBucketCrossTileIDs(f,g[v]),delete g[v],a=!0)}return a}}class $o{constructor(){this.layerIndexes={},this.crossTileIDs=new Rp,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(i,a,f,g){let v=this.layerIndexes[i.fqid];v===void 0&&(v=this.layerIndexes[i.fqid]=new wc);let S=!1,C={};g.name!=="globe"&&v.handleWrapJump(f);for(let z of a){let N=z.getBucket(i);N&&i.fqid===N.layerIds[0]&&(N.bucketInstanceId||(N.bucketInstanceId=++this.maxBucketInstanceId),v.addBucket(z.tileID,N,this.crossTileIDs)&&(S=!0),C[N.bucketInstanceId]=!0)}return v.removeStaleBuckets(C)&&(S=!0),S}pruneUnusedLayers(i){let a={};i.forEach(f=>{a[f]=!0});for(let f in this.layerIndexes)a[f]||delete this.layerIndexes[f]}}let Ia=771;class Tn{constructor(i,a,f,g){this.blendFunction=i,this.blendColor=a,this.mask=f,this.blendEquation=g}}Tn.Replace=[1,0,1,0],Tn.disabled=new Tn(Tn.Replace,t.am.transparent,[!1,!1,!1,!1]),Tn.unblended=new Tn(Tn.Replace,t.am.transparent,[!0,!0,!0,!0]),Tn.alphaBlended=new Tn([1,Ia,1,Ia],t.am.transparent,[!0,!0,!0,!0]),Tn.alphaBlendedNonPremultiplied=new Tn([770,Ia,770,Ia],t.am.transparent,[!0,!0,!0,!0]),Tn.multiply=new Tn([774,0,774,0],t.am.transparent,[!0,!0,!0,!0]);class Li{constructor(i,a,f){this.func=i,this.mask=a,this.range=f}}Li.ReadOnly=!1,Li.ReadWrite=!0,Li.disabled=new Li(519,Li.ReadOnly,[0,1]);let Tc=7680;class hn{constructor(i,a,f,g,v,S){this.test=i,this.ref=a,this.mask=f,this.fail=g,this.depthFail=v,this.pass=S}}hn.disabled=new hn({func:519,mask:0},0,0,Tc,Tc,Tc);let zh=1029,Fu=2305;class ln{constructor(i,a,f){this.enable=i,this.mode=a,this.frontFace=f}}function zp(p,i){let a=t.c1(p,3);t.c3(p,i),t.c7(p,3,a)}function Ll(p,i){let a=t.bY([]);return t.bZ(a,a,-i),t.b_(a,a,-p),a}function lf(p,i){let a=[p[0],p[1],0],f=[i[0],i[1],0];if(t.ae(a)>=1e-15){let S=t.au([],a);t.b$(f,S,t.bE(f,S)),i[0]=f[0],i[1]=f[1]}let g=t.bG([],i,p);if(t.c0(g)<1e-15)return null;let v=Math.atan2(-g[1],g[0]);return Ll(Math.atan2(Math.sqrt(p[0]*p[0]+p[1]*p[1]),-p[2]),v)}ln.disabled=new ln(!1,zh,Fu),ln.backCCW=new ln(!0,zh,Fu),ln.backCW=new ln(!0,zh,2304),ln.frontCW=new ln(!0,1028,2304),ln.frontCCW=new ln(!0,1028,Fu);class Bu{constructor(i,a){this.position=i,this.orientation=a}get position(){return this._position}set position(i){if(i){let a=i instanceof t.ac?i:new t.ac(i[0],i[1],i[2]);this._renderWorldCopies&&(a.x=t.bX(a.x,0,1)),this._position=a}else this._position=null}lookAtPoint(i,a){if(this.orientation=null,!this.position)return;let f=this.position,g=this._elevation?this._elevation.getAtPointOrZero(t.ac.fromLngLat(i)):0,v=t.ac.fromLngLat(i,g),S=[v.x-f.x,v.y-f.y,v.z-f.z];a||(a=[0,0,1]),a[2]=Math.abs(a[2]),this.orientation=lf(S,a)}setPitchBearing(i,a){this.orientation=Ll(t.al(i),t.al(-a))}}class Ys{constructor(i,a){this._transform=t.bx([]),this.orientation=a,this.position=i}get mercatorPosition(){let i=this.position;return new t.ac(i[0],i[1],i[2])}get position(){let i=t.c1(this._transform,3);return[i[0],i[1],i[2]]}set position(i){var a;i&&t.c7(this._transform,3,[(a=i)[0],a[1],a[2],1])}get orientation(){return this._orientation}set orientation(i){this._orientation=i||t.bY([]),i&&zp(this._transform,this._orientation)}getPitchBearing(){let i=this.forward(),a=this.right();return{bearing:Math.atan2(-a[1],a[0]),pitch:Math.atan2(Math.sqrt(i[0]*i[0]+i[1]*i[1]),-i[2])}}setPitchBearing(i,a){this._orientation=Ll(i,a),zp(this._transform,this._orientation)}forward(){let i=t.c1(this._transform,2);return[-i[0],-i[1],-i[2]]}up(){let i=t.c1(this._transform,1);return[-i[0],-i[1],-i[2]]}right(){let i=t.c1(this._transform,0);return[i[0],i[1],i[2]]}getCameraToWorld(i,a){let f=new Float64Array(16);return t.bi(f,this.getWorldToCamera(i,a)),f}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(i,a,f){let g=this.position;t.b$(g,g,-i);let v=new Float64Array(16);return t.bn(v,[f,f,f]),t.bo(v,v,g),v[10]*=a,v}getWorldToCamera(i,a){let f=new Float64Array(16),g=new Float64Array(4),v=this.position;return t.c2(g,this._orientation),t.b$(v,v,-i),t.c3(f,g),t.bo(f,f,v),f[1]*=-1,f[5]*=-1,f[9]*=-1,f[13]*=-1,f[8]*=a,f[9]*=a,f[10]*=a,f[11]*=a,f}getCameraToClipPerspective(i,a,f,g){let v=new Float64Array(16);return t.c4(v,i,a,f,g),v}getCameraToClipOrthographic(i,a,f,g,v,S){let C=new Float64Array(16);return t.c5(C,i,a,f,g,v,S),C}getDistanceToElevation(i,a=!1){let f=i===0?0:t.c6(i,a?t.aY(this.position[1]):this.position[1]),g=this.forward();return(f-this.position[2])/g[2]}clone(){return new Ys([...this.position],[...this.orientation])}}let ws={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class cu{constructor(i=0,a=0,f=0,g=0){if(isNaN(i)||i<0||isNaN(a)||a<0||isNaN(f)||f<0||isNaN(g)||g<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=i,this.bottom=a,this.left=f,this.right=g}interpolate(i,a,f){return a.top!=null&&i.top!=null&&(this.top=t.ai(i.top,a.top,f)),a.bottom!=null&&i.bottom!=null&&(this.bottom=t.ai(i.bottom,a.bottom,f)),a.left!=null&&i.left!=null&&(this.left=t.ai(i.left,a.left,f)),a.right!=null&&i.right!=null&&(this.right=t.ai(i.right,a.right,f)),this}getCenter(i,a){let f=t.aD((this.left+i-this.right)/2,0,i),g=t.aD((this.top+a-this.bottom)/2,0,a);return new t.P(f,g)}equals(i){return this.top===i.top&&this.bottom===i.bottom&&this.left===i.left&&this.right===i.right}clone(){return new cu(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}let Sc=15;class kl{constructor(i,a,f,g,v,S,C){this.tileSize=512,this._renderWorldCopies=v===void 0||v,this._minZoom=i||0,this._maxZoom=a||22,this._minPitch=f??0,this._maxPitch=g??60,this.setProjection(S),this.setMaxBounds(C),this.width=0,this.height=0,this._center=new t.cd(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new cu,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Ys,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){let i=new kl(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return i._elevation=this._elevation,i._centerAltitude=this._centerAltitude,i._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,i.tileSize=this.tileSize,i.mercatorFromTransition=this.mercatorFromTransition,i.width=this.width,i.height=this.height,i.cameraElevationReference=this.cameraElevationReference,i._center=this._center,i._setZoom(this.zoom),i._seaLevelZoom=this._seaLevelZoom,i.angle=this.angle,i._fov=this._fov,i._pitch=this._pitch,i._nearZ=this._nearZ,i._farZ=this._farZ,i._averageElevation=this._averageElevation,i._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,i._unmodified=this._unmodified,i._edgeInsets=this._edgeInsets.clone(),i._camera=this._camera.clone(),i._calcMatrices(),i.freezeTileCoverage=this.freezeTileCoverage,i.frustumCorners=this.frustumCorners,i._allowWorldUnderZoom=this._allowWorldUnderZoom,i}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<Sc}get elevation(){return this._elevation}set elevation(i){this._elevation!==i&&(this._elevation=i,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(i,a=!1){let f=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||f)&&this._updateCameraOnTerrain(),(i||f)&&this._constrainCamera(a),this._calcMatrices()}getProjection(){return t.aF(this.projection,["name","center","parallels"])}setProjection(i){this.projectionOptions=i||{name:"mercator"};let a=this.projection?this.getProjection():void 0;this.projection=t.ce(this.projectionOptions);let f=this.getProjection(),g=!t.bv(a,f);return g&&this._calcMatrices(),this.mercatorFromTransition=!1,g}setOrthographicProjectionAtLowPitch(i){return this._orthographicProjectionAtLowPitch!==i&&(this._orthographicProjectionAtLowPitch=i,this._calcMatrices(),!0)}setMercatorFromTransition(){let i=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=t.ce({name:"mercator"});let a=i!==this.projection.name;return a&&this._calcMatrices(),a}get minZoom(){return this._minZoom}set minZoom(i){this._minZoom!==i&&(this._minZoom=i,this.zoom=Math.max(this.zoom,i))}get maxZoom(){return this._maxZoom}set maxZoom(i){this._maxZoom!==i&&(this._maxZoom=i,this.zoom=Math.min(this.zoom,i))}get minPitch(){return this._minPitch}set minPitch(i){this._minPitch!==i&&(this._minPitch=i,this.pitch=Math.max(this.pitch,i))}get maxPitch(){return this._maxPitch}set maxPitch(i){this._maxPitch!==i&&(this._maxPitch=i,this.pitch=Math.min(this.pitch,i))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(i){i===void 0?i=!0:i===null&&(i=!1),this._renderWorldCopies=i}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){let i=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(i))}get cameraWorldSize(){let i=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(i))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return t.c6(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new t.P(this.width,this.height)}get bearing(){return t.bX(this.rotation,-180,180)}set bearing(i){this.rotation=i}get rotation(){return-this.angle/Math.PI*180}set rotation(i){let a=-i*Math.PI/180;this.angle!==a&&(this._unmodified=!1,this.angle=a,this._calcMatrices(),this.rotationMatrix=t.cf(),t.cg(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(i){let a=t.aD(i,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==a&&(this._unmodified=!1,this._pitch=a,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(i){i=Math.max(.01,Math.min(60,i)),this._fov!==i&&(this._unmodified=!1,this._fov=t.al(i),this._calcMatrices())}get fovX(){return this._fov}get fovY(){let i=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/i)}get averageElevation(){return this._averageElevation}set averageElevation(i){this._averageElevation=i,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(i){let a=Math.min(Math.max(i,this.minZoom),this.maxZoom);this._zoom!==a&&(this._unmodified=!1,this._setZoom(a),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(i){this._zoom=i,this.scale=this.zoomScale(i),this.tileZoom=Math.floor(i),this.zoomFraction=i-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(i){this._tileCoverLift!==i&&(this._tileCoverLift=i)}_updateCameraOnTerrain(){let i=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,a=this.elevation&&i===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||i===Number.NEGATIVE_INFINITY&&(!a||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);let f=this._elevation;a||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&f.exaggeration()&&this._centerAltitudeValidForExaggeration!==f.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*f.exaggeration(),this._centerAltitudeValidForExaggeration=f.exaggeration()):(this._centerAltitude=i||0,this._centerAltitudeValidForExaggeration=f.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;let i=this._elevation,a=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],f=this.horizonLineFromTop(),g=0,v=0;for(let S=0;S<a.length;S++){let C=new t.P(a[S][0]*this.width,f+a[S][1]*(this.height-f)),z=i.pointCoordinate(C);if(!z)continue;let N=1/Math.hypot(z[0]-this._camera.position[0],z[1]-this._camera.position[1]);g+=z[3]*N,v+=N}return v===0?NaN:g/v}get center(){return this._center}set center(i){i.lat===this._center.lat&&i.lng===this._center.lng||(this._unmodified=!1,this._center=i,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;let i=this._seaLevelZoom,a=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),f=this.pixelsPerMeter/this.worldSize*a,g=this._mercatorZfromZoom(i),v=this._mercatorZfromZoom(this._maxZoom),S=Math.max(g-f,v);this._setZoom(this._zoomFromMercatorZ(S))}get padding(){return this._edgeInsets.toJSON()}set padding(i){this._edgeInsets.equals(i)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,i,1),this._calcMatrices())}computeZoomRelativeTo(i){let a=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,i.toAltitude())),f;f=i.z<this._camera.position[2]?[a.x,a.y,a.z]:[i.x,i.y,i.z];let g=t.ae(t.at([],this._camera.position,f));return t.aD(this._zoomFromMercatorZ(g),this._minZoom,this._maxZoom)}setFreeCameraOptions(i){if(!this.height||!i.position&&!i.orientation)return;this._updateCameraState();let a=!1;if(i.orientation&&!t.ch(i.orientation,this._camera.orientation)&&(a=this._setCameraOrientation(i.orientation)),i.position){let f=[i.position.x,i.position.y,i.position.z];t.ci(f,this._camera.position)||(this._setCameraPosition(f),a=!0)}a&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();let i=this._camera.position,a=new Bu;return a.position=new t.ac(i[0],i[1],i[2]),a.orientation=this._camera.orientation,a._elevation=this.elevation,a._renderWorldCopies=this.renderWorldCopies,a}_setCameraOrientation(i){if(!t.cj(i))return!1;t.ck(i,i);let a=t.cl([],[0,0,-1],i),f=t.cl([],[0,-1,0],i);if(f[2]<0)return!1;let g=lf(a,f);return!!g&&(this._camera.orientation=g,!0)}_setCameraPosition(i){let a=this.zoomScale(this.minZoom)*this.tileSize,f=this.zoomScale(this.maxZoom)*this.tileSize,g=this.cameraToCenterDistance;i[2]=t.aD(i[2],g/f,g/a),this._camera.position=i}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(i){return this._edgeInsets.equals(i)}interpolatePadding(i,a,f){this._unmodified=!1,this._edgeInsets.interpolate(i,a,f),this._constrain(),this._calcMatrices()}coveringZoomLevel(i){let a=(i.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/i.tileSize));return Math.max(0,a)}getVisibleUnwrappedCoordinates(i){let a=[new t.cm(0,i)];if(this.renderWorldCopies){let f=this.pointCoordinate(new t.P(0,0)),g=this.pointCoordinate(new t.P(this.width,0)),v=this.pointCoordinate(new t.P(this.width,this.height)),S=this.pointCoordinate(new t.P(0,this.height)),C=Math.floor(Math.min(f.x,g.x,v.x,S.x)),z=Math.floor(Math.max(f.x,g.x,v.x,S.x)),N=1;for(let U=C-N;U<=z+N;U++)U!==0&&a.push(new t.cm(U,i))}return a}isLODDisabled(i){return(!i||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(i,a,f){let g=[],v=f!=null,S=!v;if(S&&this.zoom<a||v&&f[0]===0&&f[1]===0)return g;let C=new Set,z=(U,$,Z,X,se)=>{let re=t.cK($,U,Z,X,se);C.has(re)||(g.push(new t.aM(U,$,Z,X,se)),C.add(re))};for(let U=0;U<i.length;U++){let $=i[U];if(S&&$.canonical.z!==a)continue;let Z=$.canonical,X=$.overscaledZ,se=$.wrap,re=1<<Z.z,he=Z.x+1<re,ae=Z.x>0,be=Z.y+1<re,Pe=Z.y>0,Re=$.wrap-(ae?0:1),Ge=$.wrap+(he?0:1),Ne=ae?Z.x-1:re-1,Ve=he?Z.x+1:0;if(v)f[0]<0?(z(X,Ge,Z.z,Ve,Z.y),f[1]<0&&be&&(z(X,se,Z.z,Z.x,Z.y+1),z(X,Ge,Z.z,Ve,Z.y+1)),f[1]>0&&Pe&&(z(X,se,Z.z,Z.x,Z.y-1),z(X,Ge,Z.z,Ve,Z.y-1))):f[0]>0?(z(X,Re,Z.z,Ne,Z.y),f[1]<0&&be&&(z(X,se,Z.z,Z.x,Z.y+1),z(X,Re,Z.z,Ne,Z.y+1)),f[1]>0&&Pe&&(z(X,se,Z.z,Z.x,Z.y-1),z(X,Re,Z.z,Ne,Z.y-1))):f[1]<0&&be?z(X,se,Z.z,Z.x,Z.y+1):Pe&&z(X,se,Z.z,Z.x,Z.y-1);else{let Oe=$.visibleQuadrants;1&Oe&&(z(X,Re,Z.z,Ne,Z.y),Pe&&(z(X,se,Z.z,Z.x,Z.y-1),z(X,Re,Z.z,Ne,Z.y-1))),2&Oe&&(z(X,Ge,Z.z,Ve,Z.y),Pe&&(z(X,se,Z.z,Z.x,Z.y-1),z(X,Ge,Z.z,Ve,Z.y-1))),4&Oe&&(z(X,Re,Z.z,Ne,Z.y),be&&(z(X,se,Z.z,Z.x,Z.y+1),z(X,Re,Z.z,Ne,Z.y+1))),8&Oe&&(z(X,Ge,Z.z,Ve,Z.y),be&&(z(X,se,Z.z,Z.x,Z.y+1),z(X,Ge,Z.z,Ve,Z.y+1)))}}let N=[];for(let U of g)g.some($=>U.isChildOf($))||N.push(U);if(g=N.filter(U=>!i.some($=>!!(U.overscaledZ<a&&$.isChildOf(U))||U.equals($)||U.isChildOf($))),S){let U=1<<a,$=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),Z=[U*$.x,U*$.y],X=4,se=X*X;g=g.filter(re=>{let he=re.canonical.x+.5-Z[0],ae=re.canonical.y+.5-Z[1];return he*he+ae*ae<se})}return g}coveringTiles(i){let a=this.coveringZoomLevel(i),f=a,g=this.elevation&&this.elevation.exaggeration(),v=g&&!i.isTerrainDEM,S=this.projection.name==="mercator";if(i.minzoom!==void 0&&a<i.minzoom)return[];i.maxzoom!==void 0&&a>i.maxzoom&&(a=i.maxzoom);let C=this.locationCoordinate(this.center),z=this.center.lat,N=1<<a,U=[N*C.x,N*C.y,0],$=this.projection.name==="globe",Z=!$,X=t.cn.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,a,Z),se=$?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),re=N*t.c6(1,this.center.lat),he=this._camera.position[2]/t.c6(1,this.center.lat),ae=[N*se.x,N*se.y,he*(Z?1:re)],be=$||g,Pe=this.cameraToCenterDistance/i.tileSize*(i.roundZoom?1:.502),Re=this.isLODDisabled(!0)?a:0,Ge;if(this._elevation&&i.isTerrainDEM)Ge=1e4*this._elevation.exaggeration();else if(this._elevation){let _t=this._elevation.getMinMaxForVisibleTiles();Ge=_t?_t.max:this._centerAltitude}else Ge=this._centerAltitude;let Ne=i.isTerrainDEM?-Ge:this._elevation?this._elevation.getMinElevationBelowMSL():0,Ve=this.projection.isReprojectedInTileSpace?t.co(this):1,Oe=_t=>{let Pt=new t.ac(_t.x+25e-6,_t.y,_t.z),ti=new t.ac(_t.x,_t.y+25e-6,_t.z),Gt=_t.toLngLat(),ii=Pt.toLngLat(),oi=ti.toLngLat(),ki=this.locationCoordinate(Gt),ji=this.locationCoordinate(ii),zi=this.locationCoordinate(oi),$i=Math.hypot(ji.x-ki.x,ji.y-ki.y),Oi=Math.hypot(zi.x-ki.x,zi.y-ki.y);return Math.sqrt($i*Oi)*Ve/25e-6},Ke=_t=>{let qt=Ge,Pt=Ne;return{aabb:t.cr(this,N,0,0,0,_t,Pt,qt,this.projection),zoom:0,x:0,y:0,minZ:Pt,maxZ:qt,wrap:_t,fullyVisible:!1}},Qe=[],It=[],gt=a,jt=i.reparseOverscaled?f:a,Ut=(he-this._centerAltitude)*re,fi=_t=>{if(!this._elevation||!_t.tileID||!S)return;let qt=this._elevation.getMinMaxForTile(_t.tileID),Pt=_t.aabb;qt?(Pt.min[2]=qt.min,Pt.max[2]=qt.max,Pt.center[2]=(Pt.min[2]+Pt.max[2])/2):(_t.shouldSplit=Ct(_t),_t.shouldSplit||(Pt.min[2]=Pt.max[2]=Pt.center[2]=this._centerAltitude))},vt=(_t,qt)=>{if(.707*qt<_t)return 1;let Pt=qt/_t;return Pt/(1.4144271570014144+(Math.pow(1.1,Pt-1.4144271570014144+1)-1)/(1.1-1)-1)},Ct=_t=>{if(_t.zoom<Re)return!0;if(_t.zoom===gt)return!1;if(_t.shouldSplit!=null)return _t.shouldSplit;let qt=_t.aabb.distanceX(ae),Pt=_t.aabb.distanceY(ae),ti=Ut,Gt=1;if($){ti=_t.aabb.distanceZ(ae);let Oi=Math.pow(2,_t.zoom),nn=t.aY((_t.y+1)/Oi),xn=t.aY(_t.y/Oi),Bn=Math.min(Math.max(z,nn),xn),Er=t.cP(Bn)/t.cP(z);if(Gt=Bn===z?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Er/this._mercatorScaleRatio),this.zoom<=t.cL&&_t.zoom===gt-1&&Er>=.9)return!0}else if(v&&(ti=_t.aabb.distanceZ(ae)*re),this.projection.isReprojectedInTileSpace&&f<=5){let Oi=Math.pow(2,_t.zoom),nn=Oe(new t.ac((_t.x+.5)/Oi,(_t.y+.5)/Oi));Gt=nn>.85?1:nn}if(!S){let Oi=Math.sqrt(qt*qt+Pt*Pt+ti*ti),nn=(1<<gt-_t.zoom)*Pe*Gt;return nn*=vt(Math.max(ti,Ut),Oi),Oi<nn}let ii=Number.MAX_VALUE,oi=0,ki=_t.aabb.getCorners(),ji=[];for(let Oi of ki){t.at(ji,Oi,ae),$||(v?ji[2]*=re:ji[2]=Ut);let nn=t.bE(ji,this._camera.forward());nn<ii&&(ii=nn,oi=Math.abs(ji[2]))}let zi=(1<<gt-_t.zoom)*Pe*Gt;if(zi*=vt(Math.max(oi,Ut),ii),ii<zi)return!0;let $i=_t.aabb.closestPoint(U);return $i[0]===U[0]&&$i[1]===U[1]};if(this.renderWorldCopies)for(let _t=1;_t<=3;_t++)Qe.push(Ke(-_t)),Qe.push(Ke(_t));for(Qe.push(Ke(0));Qe.length>0;){let _t=Qe.pop(),qt=_t.x,Pt=_t.y,ti=_t.fullyVisible,Gt=()=>this.projection.name==="globe"&&(_t.y===0||_t.y===(1<<_t.zoom)-1);if(!ti){let ii=be?_t.aabb.intersects(X):_t.aabb.intersectsFlat(X);if(ii===0&&Gt()){let oi=new t.cp(_t.zoom,qt,Pt);ii=t.cq(this,N,oi,!0).intersects(X)}if(ii===0)continue;ti=ii===2}if(_t.zoom!==gt&&Ct(_t))for(let ii=0;ii<4;ii++){let oi=(qt<<1)+ii%2,ki=(Pt<<1)+(ii>>1),ji={aabb:S?_t.aabb.quadrant(ii):t.cr(this,N,_t.zoom+1,oi,ki,_t.wrap,_t.minZ,_t.maxZ,this.projection),zoom:_t.zoom+1,x:oi,y:ki,wrap:_t.wrap,fullyVisible:ti,tileID:void 0,shouldSplit:void 0,minZ:_t.minZ,maxZ:_t.maxZ};v&&!$&&(ji.tileID=new t.aM(_t.zoom+1===gt?jt:_t.zoom+1,_t.wrap,_t.zoom+1,oi,ki),fi(ji)),Qe.push(ji)}else{let ii=_t.zoom===gt?jt:_t.zoom;if(i.minzoom&&i.minzoom>ii)continue;let oi=0;if(!ti){let $i=be?_t.aabb.intersectsPrecise(X):_t.aabb.intersectsPreciseFlat(X);if($i===0&&Gt()){let Oi=new t.cp(_t.zoom,qt,Pt);$i=t.cq(this,N,Oi,!0).intersectsPrecise(X)}if($i===0)continue;if(i.calculateQuadrantVisibility)if(X.containsPoint(_t.aabb.center))oi=15;else for(let Oi=0;Oi<4;Oi++)_t.aabb.quadrant(Oi).intersects(X)!==0&&(oi|=1<<Oi)}let ki=U[0]-(.5+qt+(_t.wrap<<_t.zoom))*(1<<a-_t.zoom),ji=U[1]-.5-Pt,zi=_t.tileID?_t.tileID:new t.aM(ii,_t.wrap,_t.zoom,qt,Pt);i.calculateQuadrantVisibility&&(zi.visibleQuadrants=oi),It.push({tileID:zi,distanceSq:ki*ki+ji*ji})}}if(this.fogCullDistSq){let _t=this.fogCullDistSq,qt=this.horizonLineFromTop();It=It.filter(Pt=>{let ti=[0,0,0,1],Gt=[t.aj,t.aj,0,1],ii=this.calculateFogTileMatrix(Pt.tileID.toUnwrapped());t.aA(ti,ti,ii),t.aA(Gt,Gt,ii);let oi=t.cs([],ti,Gt),ki=t.ct([],ti,Gt),ji=t.cM(oi,ki);if(ji===0)return!0;let zi=!1,$i=this._elevation;if($i&&ji>_t&&qt!==0){let Oi=this.calculateProjMatrix(Pt.tileID.toUnwrapped()),nn;i.isTerrainDEM||(nn=$i.getMinMaxForTile(Pt.tileID)),nn||(nn={min:Ne,max:Ge});let xn=t.cu(this.rotation),Bn=[xn[0]*t.aj,xn[1]*t.aj,nn.max];t.ad(Bn,Bn,Oi),zi=(1-Bn[1])*this.height*.5<qt}return ji<_t||zi})}return It.sort((_t,qt)=>_t.distanceSq-qt.distanceSq).map(_t=>_t.tileID)}resize(i,a){this.width=i,this.height=a,this.pixelsToGLUnits=[2/i,-2/a],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(i){return Math.pow(2,i)}scaleZoom(i){return Math.log(i)/Math.LN2}project(i){let a=t.aD(i.lat,-t.cv,t.cv),f=this.projection.project(i.lng,a);return new t.P(f.x*this.worldSize,f.y*this.worldSize)}unproject(i){return this.projection.unproject(i.x/this.worldSize,i.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/t.c6(1,this.center.lat)/this.worldSize}setLocationAtPoint(i,a){let f,g,v=this.centerPoint;if(this.projection.name==="globe"){let C=this.worldSize;f=(a.x-v.x)/C,g=(a.y-v.y)/C}else{let C=this.pointCoordinate(a),z=this.pointCoordinate(v);f=C.x-z.x,g=C.y-z.y}let S=this.locationCoordinate(i);this.setLocation(new t.ac(S.x-f,S.y-g))}setLocation(i){this.center=this.coordinateLocation(i),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(i,a){return this.projection.locationPoint(this,i,a)}locationPoint3D(i,a){return this.projection.locationPoint(this,i,a,!0)}pointLocation(i){return this.coordinateLocation(this.pointCoordinate(i))}pointLocation3D(i,a){return this.coordinateLocation(this.pointCoordinate3D(i,a))}locationCoordinate(i,a){let f=a?t.c6(a,i.lat):void 0,g=this.projection.project(i.lng,i.lat);return new t.ac(g.x,g.y,f)}coordinateLocation(i){return this.projection.unproject(i.x,i.y)}pointRayIntersection(i,a){let f=a??this._centerAltitude,g=[i.x,i.y,0,1],v=[i.x,i.y,1,1];t.aA(g,g,this.pixelMatrixInverse),t.aA(v,v,this.pixelMatrixInverse);let S=v[3];t.cw(g,g,1/g[3]),t.cw(v,v,1/S);let C=g[2],z=v[2];return{p0:g,p1:v,t:C===z?0:(f-C)/(z-C)}}screenPointToMercatorRay(i){let a=[i.x,i.y,0,1],f=[i.x,i.y,1,1];return t.aA(a,a,this.pixelMatrixInverse),t.aA(f,f,this.pixelMatrixInverse),t.cw(a,a,1/a[3]),t.cw(f,f,1/f[3]),a[2]=t.c6(a[2],this._center.lat)*this.worldSize,f[2]=t.c6(f[2],this._center.lat)*this.worldSize,t.cw(a,a,1/this.worldSize),t.cw(f,f,1/this.worldSize),new t.av([a[0],a[1],a[2]],t.au([],t.at([],f,a)))}rayIntersectionCoordinate(i){let{p0:a,p1:f,t:g}=i,v=t.c6(a[2],this._center.lat),S=t.c6(f[2],this._center.lat);return new t.ac(t.ai(a[0],f[0],g)/this.worldSize,t.ai(a[1],f[1],g)/this.worldSize,t.ai(v,S,g))}pointCoordinate(i,a=this._centerAltitude){return this.projection.pointCoordinate(this,i.x,i.y,a)}pointCoordinate3D(i,a){if(!this.elevation)return this.pointCoordinate(i,a);let f=this.projection.pointCoordinate3D(this,i.x,i.y);if(f)return new t.ac(f[0],f[1],f[2]);let g=0,v=this.horizonLineFromTop();if(i.y>v)return this.pointCoordinate(i,a);let S=.02*v,C=i.clone();for(let z=0;z<10&&v-g>S;z++){C.y=t.ai(g,v,.66);let N=this.projection.pointCoordinate3D(this,C.x,C.y);N?(v=C.y,f=N):g=C.y}return f?new t.ac(f[0],f[1],f[2]):this.pointCoordinate(i)}isPointAboveHorizon(i){return this.projection.isPointAboveHorizon(this,i)}isPointOnSurface(i){if(i.y<0||i.y>this.height||i.x<0||i.x>this.width)return!1;if(this.elevation||this.zoom>=t.cx)return!this.isPointAboveHorizon(i);let a=this.pointCoordinate(i);return a.y>=0&&a.y<=1}_coordinatePoint(i,a){let f=a&&this.elevation?this.elevation.getAtPointOrZero(i,this._centerAltitude):this._centerAltitude,g=[i.x*this.worldSize,i.y*this.worldSize,f+i.toAltitude(),1];return t.aA(g,g,this.pixelMatrix),g[3]>0?new t.P(g[0]/g[3],g[1]/g[3]):new t.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){let{top:i,left:a}=this._edgeInsets,f=this.height-this._edgeInsets.bottom,g=this.width-this._edgeInsets.right,v=this.pointLocation3D(new t.P(a,i)),S=this.pointLocation3D(new t.P(g,i)),C=this.pointLocation3D(new t.P(g,f)),z=this.pointLocation3D(new t.P(a,f)),N=Math.min(v.lng,S.lng,C.lng,z.lng),U=Math.max(v.lng,S.lng,C.lng,z.lng),$=Math.min(v.lat,S.lat,C.lat,z.lat),Z=Math.max(v.lat,S.lat,C.lat,z.lat),X=Math.pow(2,-this.zoom)/16*270,se=this.projection.name==="globe"?1:4,re=(he,ae,be,Pe,Re)=>{let Ge=(he+be)/2,Ne=(ae+Pe)/2,Ve=new t.P(Ge,Ne),{lng:Oe,lat:Ke}=this.pointLocation3D(Ve),Qe=Math.max(0,N-Oe,$-Ke,Oe-U,Ke-Z);N=Math.min(N,Oe),U=Math.max(U,Oe),$=Math.min($,Ke),Z=Math.max(Z,Ke),(Re<se||Qe>X)&&(re(he,ae,Ge,Ne,Re+1),re(Ge,Ne,be,Pe,Re+1))};if(re(a,i,g,i,1),re(g,i,g,f,1),re(g,f,a,f,1),re(a,f,a,i,1),this.projection.name==="globe"){let[he,ae]=t.cy(this);he?(Z=90,U=180,N=-180):ae&&($=-90,U=180,N=-180)}return new t.aG(new t.cd(N,$),new t.cd(U,Z))}_getBoundsRectangular(i,a){let{top:f,left:g}=this._edgeInsets,v=this.height-this._edgeInsets.bottom,S=this.width-this._edgeInsets.right,C=new t.P(g,f),z=new t.P(S,f),N=new t.P(S,v),U=new t.P(g,v),$=this.pointCoordinate(C,i),Z=this.pointCoordinate(z,i),X=this.pointCoordinate(N,a),se=this.pointCoordinate(U,a),re=(he,ae)=>(ae.y-he.y)/(ae.x-he.x);return $.y>1&&Z.y>=0?$=new t.ac((1-se.y)/re(se,$)+se.x,1):$.y<0&&Z.y<=1&&($=new t.ac(-se.y/re(se,$)+se.x,0)),Z.y>1&&$.y>=0?Z=new t.ac((1-X.y)/re(X,Z)+X.x,1):Z.y<0&&$.y<=1&&(Z=new t.ac(-X.y/re(X,Z)+X.x,0)),new t.aG().extend(this.coordinateLocation($)).extend(this.coordinateLocation(Z)).extend(this.coordinateLocation(se)).extend(this.coordinateLocation(X))}_getBoundsRectangularTerrain(){let i=this.elevation;if(!i.visibleDemTiles.length||i.isUsingMockSource())return this._getBoundsRectangular(0,0);let a=i.visibleDemTiles.reduce((f,g)=>{if(g.dem){let v=g.dem.tree;f.min=Math.min(f.min,v.minimums[0]),f.max=Math.max(f.max,v.maximums[0])}return f},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(a.min*i.exaggeration(),a.max*i.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(i=!0){let a=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,f=this.height/2-a*(1-this._horizonShift);return i?Math.max(0,f):f}getMaxBounds(){return this.maxBounds}setMaxBounds(i){this.maxBounds=i,this.minLat=-t.cv,this.maxLat=t.cv,this.minLng=-180,this.maxLng=180,i&&(this.minLat=i.getSouth(),this.maxLat=i.getNorth(),this.minLng=i.getWest(),this.maxLng=i.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=t.ay(this.minLng)*this.tileSize,this.worldMaxX=t.ay(this.maxLng)*this.tileSize,this.worldMinY=t.aH(this.maxLat)*this.tileSize,this.worldMaxY=t.aH(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(i,a){return this.projection.createTileMatrix(this,a,i)}calculateDistanceTileData(i){let a=i.key,f=this._distanceTileDataCache;if(f[a])return f[a];let g=i.canonical,v=1/this.height,S=this.cameraWorldSize,C=S/this.zoomScale(g.z),z=(g.x+Math.pow(2,g.z)*i.wrap)*C,N=g.y*C,U=this.point;U.x*=S/this.worldSize,U.y*=S/this.worldSize;let $=this.angle,Z=Math.sin(-$),X=-Math.cos(-$);return f[a]={bearing:[Z,X],center:[(U.x-z)*v,(U.y-N)*v],scale:C/t.aj*v},f[a]}calculateFogTileMatrix(i){let a=i.key,f=this._fogTileMatrixCache;if(f[a])return f[a];let g=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,i);return t.az(g,this.worldToFogMatrix,g),f[a]=new Float32Array(g),f[a]}calculateProjMatrix(i,a=!1,f=!1){let g=i.key,v;if(v=f?this._expandedProjMatrixCache:a?this._alignedProjMatrixCache:this._projMatrixCache,v[g])return v[g];let S=this.calculatePosMatrix(i,this.worldSize),C;return C=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:f?this.expandedFarZProjMatrix:a?this.alignedProjMatrix:this.projMatrix,t.az(S,C,S),v[g]=new Float32Array(S),v[g]}calculatePixelsToTileUnitsMatrix(i){let a=i.tileID.key,f=this._pixelsToTileUnitsCache;if(f[a])return f[a];let g=t.cz(i,this);return f[a]=g,f[a]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){let i=1/this.worldSize,a=t.bn([],[i,i,i]);return t.az(a,a,this.globeMatrix),a}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;let i=this._elevation;this._updateCameraState();let a=t.c6(1,this._center.lat)*this.worldSize,f=this._computeCameraPosition(a),g=this._camera.forward(),v=t.c6(1,this._center.lat);f[2]/=v,g[2]/=v,t.au(g,g);let S=i.raycast(f,g,i.exaggeration());if(S){let C=t.bF([],f,g,S),z=new t.ac(C[0],C[1],t.c6(C[2],t.aY(C[1]))),N=(z.z+t.ae([z.x-f[0],z.y-f[1],z.z-f[2]*v]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(N),this._centerAltitude=z.toAltitude(),this._center=this.coordinateLocation(z),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(i=!1){if(!this._elevation)return;let a=this._elevation,f=t.c6(1,this._center.lat)*this.worldSize,g=this._computeCameraPosition(f),v=a.getAtPointOrZero(new t.ac(...g)),S=this.pixelsPerMeter/this.worldSize*v,C=this._minimumHeightOverTerrain(),z=g[2]-S;if(z<=C)if(z<0||i){let N=this.locationCoordinate(this._center,this._centerAltitude),U=[g[0],g[1],N.z-g[2]],$=t.ae(U);U[2]-=(C-z)/this._pixelsPerMercatorPixel;let Z=t.ae(U);if(Z===0)return;t.b$(U,U,$/Z*this._pixelsPerMercatorPixel),this._camera.position=[g[0],g[1],N.z*this._pixelsPerMercatorPixel-U[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;let i=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||i){let Z=this.center;return Z.lat=t.aD(Z.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!i)&&(Z.lng=t.aD(Z.lng,this.minLng,this.maxLng)),this.center=Z,void(this._constraining=!1)}let a=this._unmodified,{x:f,y:g}=this.point,v=0,S=f,C=g,z=this.width/2,N=this.height/2,U=this.worldMinY*this.scale,$=this.worldMaxY*this.scale;if(g-N<U&&(C=U+N),g+N>$&&(C=$-N),$-U<this.height&&(v=Math.max(v,this.height/($-U)),C=($+U)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){let Z=this.worldMinX*this.scale,X=this.worldMaxX*this.scale,se=this.worldSize/2-(Z+X)/2;S=(f+se+this.worldSize)%this.worldSize-se,S-z<Z&&(S=Z+z),S+z>X&&(S=X-z),X-Z<this.width&&(v=Math.max(v,this.width/(X-Z)),S=(X+Z)/2)}S===f&&C===g||this._allowWorldUnderZoom||(this.center=this.unproject(new t.P(S,C))),v&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(v)),this._constrainCamera(),this._unmodified=a,this._constraining=!1}_minZoomForBounds(){let i=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(i=Math.max(i,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),i}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;let i=this.centerOffset,a=this.projection.name==="globe",f=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=t.c6(1,this.center.lat)/t.c6(1,t.cN));let g=t.cA(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,g),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;let v=this.projection.zAxisUnit==="meters"?f:1,S=this._camera.getWorldToCamera(this.worldSize,v),C,z=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(z[8]=2*-i.x/this.width,z[9]=2*i.y/this.height,this.isOrthographic){let Ke=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),Qe=Ke*this.aspect,It=-Qe,gt=-Ke;Qe-=i.x,It-=i.x,Ke+=i.y,gt+=i.y,C=this._camera.getCameraToClipOrthographic(It,Qe,gt,Ke,this._nearZ,this._farZ),((jt,Ut,fi,vt)=>{for(let Ct=0;Ct<16;Ct++)jt[Ct]=t.ai(Ut[Ct],fi[Ct],vt)})(C,C,z,t.cO(this.pitch>=Sc?1:this.pitch/Sc))}else C=z;let N=t.cB([],z,S),U=t.cB([],C,S);if(this.projection.isReprojectedInTileSpace){let Ke=this.locationCoordinate(this.center),Qe=t.bx([]);t.bo(Qe,Qe,[Ke.x*this.worldSize,Ke.y*this.worldSize,0]),t.az(Qe,Qe,t.cC(this)),t.bo(Qe,Qe,[-Ke.x*this.worldSize,-Ke.y*this.worldSize,0]),t.az(U,U,Qe),t.az(N,N,Qe),this.inverseAdjustmentMatrix=t.cD(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=t.cE([],U,[this.worldSize,this.worldSize,this.worldSize/v,1]),this.projMatrix=U,this.invProjMatrix=t.bi(new Float64Array(16),this.projMatrix),a){let Ke=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);Ke[8]=2*-i.x/this.width,Ke[9]=2*i.y/this.height,this.expandedFarZProjMatrix=t.cB([],Ke,S)}else this.expandedFarZProjMatrix=this.projMatrix;let $=t.bi([],C);this.frustumCorners=t.cF.fromInvProjectionMatrix($,this.horizonLineFromTop(),this.height),this.cameraFrustum=t.cn.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!a);let Z=new Float32Array(16);t.bx(Z),t.cE(Z,Z,[1,-1,1]),t.cG(Z,Z,this._pitch),t.by(Z,Z,this.angle);let X=t.c4(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=t.bw(X);let se=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;X[8]=2*-i.x/this.width,X[9]=2*(i.y+se)/this.height,this.skyboxMatrix=t.az(Z,X,Z);let re=this.point,he=re.x,ae=re.y,be=this.width%2/2,Pe=this.height%2/2,Re=Math.cos(this.angle),Ge=Math.sin(this.angle),Ne=he-Math.round(he)+Re*be+Ge*Pe,Ve=ae-Math.round(ae)+Re*Pe+Ge*be,Oe=new Float64Array(U);if(t.bo(Oe,Oe,[Ne>.5?Ne-1:Ne,Ve>.5?Ve-1:Ve,0]),this.alignedProjMatrix=Oe,U=t.bz(),t.cE(U,U,[this.width/2,-this.height/2,1]),t.bo(U,U,[1,-1,0]),this.labelPlaneMatrix=U,U=t.bz(),t.cE(U,U,[1,-1,1]),t.bo(U,U,[-1,-1,0]),t.cE(U,U,[2/this.width,2/this.height,1]),this.glCoordMatrix=U,this.pixelMatrix=t.az(new Float64Array(16),this.labelPlaneMatrix,N),this._calcFogMatrices(),this._distanceTileDataCache={},U=t.bi(new Float64Array(16),this.pixelMatrix),!U)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=U,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=t.cH(this);let Ke=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=t.ad(Ke,Ke,S),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=U;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};let i=this.cameraWorldSizeForFog,a=this.cameraPixelsPerMeter,f=this._camera.position,g=1/this.height/this._pixelsPerMercatorPixel,v=[i,i,a];t.b$(v,v,g),t.b$(f,f,-1),t.cI(f,f,v);let S=t.bz();t.bo(S,S,f),t.cE(S,S,v),this.mercatorFogMatrix=S,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(i,a,g)}_computeCameraPosition(i){let a=(i=i||this.pixelsPerMeter)/this.pixelsPerMeter,f=this._camera.forward(),g=this.point,v=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*a-i/this.worldSize*this._centerAltitude;return[g.x/this.worldSize-f[0]*v,g.y/this.worldSize-f[1]*v,i/this.worldSize*this._centerAltitude-f[2]*v]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(i){let a=this._maxCameraBoundsDistance()*Math.cos(this._pitch),f=this._camera.position[2],g=i[2],v=1;this.projection.wrap&&(this.center=this.center.wrap()),g>0&&(v=Math.min((a-f)/g,1)),this._camera.position=t.bF([],this._camera.position,i,v),this._updateStateFromCamera()}_updateStateFromCamera(){let i=this._camera.position,a=this._camera.forward(),{pitch:f,bearing:g}=this._camera.getPitchBearing(),v=t.c6(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,S=this._mercatorZfromZoom(this._maxZoom)*Math.cos(t.al(this._maxPitch)),C=Math.max((i[2]-v)/Math.cos(f),S),z=this._zoomFromMercatorZ(C);t.bF(i,i,a,C),this._pitch=t.aD(f,t.al(this.minPitch),t.al(this.maxPitch)),this.angle=t.bX(g,-Math.PI,Math.PI),this._setZoom(t.aD(z,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new t.ac(i[0],i[1],i[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(i){return Math.pow(2,i)*this.tileSize}_mercatorZfromZoom(i){return this.cameraToCenterDistance/this._worldSizeFromZoom(i)}_minimumHeightOverTerrain(){let i=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(i)}_zoomFromMercatorZ(i){return this.scaleZoom(this.cameraToCenterDistance/(i*this.tileSize))}zoomFromMercatorZAdjusted(i){let a=0,f=t.cx,g=0,v=1/0;for(;f-a>1e-6&&f>a;){let S=a+.5*(f-a),C=this.tileSize*Math.pow(2,S),z=this.getCameraToCenterDistance(this.projection,S,C),N=this.scaleZoom(z/(i*this.tileSize)),U=Math.abs(S-N);U<v&&(v=U,g=S),S<N?a=S:f=S}return g}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(t.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(i,a){let f=Math.min(i.x,a.x),g=Math.max(i.x,a.x),v=Math.min(i.y,a.y),S=Math.max(i.y,a.y);if(v<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;let C=[new t.P(f,v),new t.P(g,S),new t.P(f,S),new t.P(g,v)],z=this.renderWorldCopies?-3:0,N=this.renderWorldCopies?4:1;for(let U of C){let $=this.pointRayIntersection(U);if($.t<0)return!0;let Z=this.rayIntersectionCoordinate($);if(Z.x<z||Z.y<0||Z.x>N||Z.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+t.cJ(this.fovAboveCenter)>88||this.anyCornerOffEdge(new t.P(0,0),new t.P(this.width,this.height))}zoomDeltaToMovement(i,a){let f=t.ae(t.at([],this._camera.position,i)),g=this._zoomFromMercatorZ(f)+a;return f-this._mercatorZfromZoom(g)}getCameraPoint(){if(this.projection.name==="globe"){let i=function([a,f,g],v){let S=[a,f,g,1];t.aA(S,S,v);let C=S[3]=Math.max(S[3],1e-6);return S[0]/=C,S[1]/=C,S[2]/=C,S}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new t.P(i[0],i[1])}{let i=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new t.P(0,i))}}getCameraToCenterDistance(i,a=this.zoom,f=this.worldSize){let g=t.cA(i,a,this.width,this.height,1024),v=i.pixelSpaceConversion(this.center.lat,f,g),S=.5/Math.tan(.5*this._fov)*this.height*v;return this.isOrthographic&&(S=t.ai(1,S,t.cO(this.pitch>=Sc?1:this.pitch/Sc))),S}getWorldToCameraMatrix(){let i=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&t.az(i,i,this.globeMatrix),i}getFrustum(i){return t.cn.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,i,this.projection.zAxisUnit==="meters")}}let hu=(p,i)=>{if(i>0&&p.terrain&&t.w("Cutoff is currently disabled on terrain"),i<=0||p.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};let a=p.transform,f=Math.max(Math.abs(a._zoom-(p.minCutoffZoom-1)),1),g=a.isLODDisabled(!1)?t.af(60,45,a.pitch):t.af(30,15,a.pitch),v=a._farZ-a._nearZ,S=i*a.height,C=((1-(z=g))*a.cameraToCenterDistance+z*(a._farZ+S))*f;var z;return{shouldRenderCutoff:g<1,uniformValues:{u_cutoff_params:[a._nearZ,a._farZ,(C-a._nearZ)/v,(C-S-a._nearZ)/v]}}},Js={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class Pd{constructor(i,a){this.aabb=i,this.lastCascade=a}}class Nu{add(i,a){let f=this.receivers[i.key];f!==void 0?(f.aabb.min[0]=Math.min(f.aabb.min[0],a.min[0]),f.aabb.min[1]=Math.min(f.aabb.min[1],a.min[1]),f.aabb.min[2]=Math.min(f.aabb.min[2],a.min[2]),f.aabb.max[0]=Math.max(f.aabb.max[0],a.max[0]),f.aabb.max[1]=Math.max(f.aabb.max[1],a.max[1]),f.aabb.max[2]=Math.max(f.aabb.max[2],a.max[2])):this.receivers[i.key]=new Pd(a,null)}clear(){this.receivers={}}get(i){return this.receivers[i.key]}computeRequiredCascades(i,a,f){let g=t.cV.fromPoints(i.points),v=0;for(let S in this.receivers){let C=this.receivers[S];if(!C||!g.intersectsAabb(C.aabb))continue;C.aabb.min=g.closestPoint(C.aabb.min),C.aabb.max=g.closestPoint(C.aabb.max);let z=C.aabb.getCorners();for(let N=0;N<f.length;N++){let U=!0;for(let $ of z){let Z=[$[0]*a,$[1]*a,$[2]];if(t.ad(Z,Z,f[N].matrix),Z[0]<-1||Z[0]>1||Z[1]<-1||Z[1]>1){U=!1;break}}if(C.lastCascade=N,v=Math.max(v,N),U)break}}return v+1}}class Of{constructor(i){this.painter=i,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new Nu,this._depthMode=new Li(i.context.gl.LEQUAL,Li.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,i.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),i.tp.registerParameter(Js,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),i.tp.registerParameter(Js,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),i.tp.registerParameter(Js,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),i.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(let i of this._cascades)i.texture.destroy(),i.framebuffer.destroy();this._cascades=[]}updateShadowParameters(i,a){let f=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!a||!a.properties)return;let g=a.properties.get("shadow-intensity");if(!a.shadowsEnabled()||g<=0||(this._shadowLayerCount=f.style.order.reduce((se,re)=>{let he=f.style._mergedLayers[re];return se+(he.hasShadowPass()&&!he.isHidden(i.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;let v=f.context,S=Js.shadowMapResolution,C=Js.shadowMapResolution;if(this._cascades.length===0||Js.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let se=0;se<Js.cascadeCount;++se){let re=f._shadowMapDebug,he=v.gl,ae=v.createFramebuffer(S,C,re,"texture"),be=new t.T(v,{width:S,height:C,data:null},he.DEPTH_COMPONENT16);if(ae.depthAttachment.set(be.texture),re){let Pe=new t.T(v,{width:S,height:C,data:null},he.RGBA8);ae.colorAttachment.set(Pe.texture)}this._cascades.push({framebuffer:ae,texture:be,matrix:[],far:0,boundingSphereRadius:0,frustum:new t.cn,scale:0})}}this.shadowDirection=Lp(a);let z=0;if(i.elevation){let se=i.elevation,re=[1e4,-1e4];se.visibleDemTiles.filter(he=>he.dem).forEach(he=>{let ae=he.dem.tree;re[0]=Math.min(re[0],ae.minimums[0]),re[1]=Math.max(re[1],ae.maximums[0])}),re[0]!==1e4&&(z=(re[1]-re[0])*se.exaggeration())}let N=1.5*i.cameraToCenterDistance,U=3*N,$=new Float64Array(16);for(let se=0;se<this._cascades.length;++se){let re=this._cascades[se],he=i.height/50,ae=1;Js.cascadeCount===1?ae=U:se===0?ae=N:(he=N,ae=U);let[be,Pe]=Xr(i,this.shadowDirection,he,ae,Js.shadowMapResolution,z);re.scale=i.scale,re.matrix=be,re.boundingSphereRadius=Pe,t.bi($,re.matrix),re.frustum=t.cn.fromInvProjectionMatrix($,1,0,!0),re.far=ae}let Z=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[Z].far,this._cascades[Z].far],this._uniformValues.u_shadow_intensity=g,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Js.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Js.shadowMapResolution,this._uniformValues.u_shadowmap_0=ws.ShadowMap0,this._uniformValues.u_shadowmap_1=ws.ShadowMap0+1,this._groundShadowTiles=f.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});let X=f.transform.elevation;for(let se of this._groundShadowTiles){let re={min:0,max:0};if(X){let he=X.getMinMaxForTile(se);he&&(re=he)}this.addShadowReceiver(se.toUnwrapped(),re.min,re.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(i){this._enabled=i}drawShadowPass(i,a){if(!this.enabled)return;let f=this.painter,g=f.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(f.transform.getFrustum(0),f.transform.worldSize,this._cascades),g.viewport.set([0,0,Js.shadowMapResolution,Js.shadowMapResolution]);for(let v=0;v<this._numCascadesToRender;++v){f.currentShadowCascade=v,g.bindFramebuffer.set(this._cascades[v].framebuffer.framebuffer),g.clear({color:t.am.white,depth:1});for(let S of i.order){let C=i._mergedLayers[S];if(!C.hasShadowPass()||C.isHidden(f.transform.zoom))continue;let z=i.getLayerSourceCache(C),N=z?a[z.id]:void 0;(C.type==="model"||N&&N.length)&&f.renderLayer(f,z,C,N)}}f.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;let i=this.painter,a=i.style,f=i.context,g=a.directionalLight,v=a.ambientLight;if(!g||!v)return;let S=[],C=hu(i,i.longestCutoffRange);C.shouldRenderCutoff&&S.push("RENDER_CUTOFF"),S.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&S.push("NORMAL_OFFSET");let z=Ol(a,g,v),N=new Li(f.gl.LEQUAL,Li.ReadOnly,i.depthRangeFor3D);for(let U of this._groundShadowTiles){let $=U.toUnwrapped(),Z=i.isTileAffectedByFog(U),X=i.getOrCreateProgram("groundShadow",{defines:S,overrideFog:Z});this.setupShadows($,X),i.uploadCommonUniforms(f,X,$,null,C);let se={u_matrix:i.transform.calculateProjMatrix($),u_ground_shadow_factor:z};X.draw(i,f.gl.TRIANGLES,N,hn.disabled,Tn.multiply,ln.disabled,se,"ground_shadow",i.tileExtentBuffer,i.quadTriangleIndexBuffer,i.tileExtentSegments,null,i.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?Tn.unblended:Tn.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(i){let a=this.painter.transform,f=a.calculatePosMatrix(i,a.worldSize);return t.az(f,this._cascades[this.painter.currentShadowCascade].matrix,f),Float32Array.from(f)}calculateShadowPassMatrixFromMatrix(i){return t.az(i,this._cascades[this.painter.currentShadowCascade].matrix,i),Float32Array.from(i)}setupShadows(i,a,f,g=0){if(!this.enabled)return;let v=this.painter.transform,S=this.painter.context,C=S.gl,z=this._uniformValues,N=new Float64Array(16),U=v.calculatePosMatrix(i,v.worldSize);for(let $=0;$<this._cascades.length;$++)t.az(N,this._cascades[$].matrix,U),z[$===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(N),S.activeTexture.set(C.TEXTURE0+ws.ShadowMap0+$),this._cascades[$].texture.bind(C.NEAREST,C.CLAMP_TO_EDGE);if(this.useNormalOffset=!!f,this.useNormalOffset){let $=t.cT(i.canonical),Z=2/v.tileSize*t.aj/Js.shadowMapResolution,X=Z*this._cascades[0].boundingSphereRadius,se=Z*this._cascades[this._cascades.length-1].boundingSphereRadius,re=(f==="vector-tile"?1:3)/Math.pow(2,g-i.canonical.z-(1-v.zoom+Math.floor(v.zoom)));z.u_shadow_normal_offset=[$,X*re,se*re],z.u_shadow_bias=[6e-5,.0012,.012]}else z.u_shadow_bias=[36e-5,.0012,.012];a.setShadowUniformValues(S,z)}setupShadowsFromMatrix(i,a,f=!1){if(!this.enabled)return;let g=this.painter.context,v=g.gl,S=this._uniformValues,C=new Float64Array(16);for(let z=0;z<Js.cascadeCount;z++)t.az(C,this._cascades[z].matrix,i),S[z===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(C),g.activeTexture.set(v.TEXTURE0+ws.ShadowMap0+z),this._cascades[z].texture.bind(v.NEAREST,v.CLAMP_TO_EDGE);if(this.useNormalOffset=f,f){let z=Js.normalOffset;S.u_shadow_normal_offset=[1,z,z],S.u_shadow_bias=[6e-5,.0012,.012]}else S.u_shadow_bias=[36e-5,.0012,.012];a.setShadowUniformValues(g,S)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(i,a,f,g){if(g[2]>=0)return{};let v=function(z,N,U){let $=U/(1<<z.canonical.z);return new t.cV([z.canonical.x*$+z.wrap*U,z.canonical.y*$+z.wrap*U,0],[(z.canonical.x+1)*$+z.wrap*U,(z.canonical.y+1)*$+z.wrap*U,N])}(i,a,f).getCorners(),S=a/-g[2];g[0]<0?(t.cU(v[0],v[0],[g[0]*S,0,0]),t.cU(v[3],v[3],[g[0]*S,0,0])):g[0]>0&&(t.cU(v[1],v[1],[g[0]*S,0,0]),t.cU(v[2],v[2],[g[0]*S,0,0])),g[1]<0?(t.cU(v[0],v[0],[0,g[1]*S,0]),t.cU(v[1],v[1],[0,g[1]*S,0])):g[1]>0&&(t.cU(v[2],v[2],[0,g[1]*S,0]),t.cU(v[3],v[3],[0,g[1]*S,0]));let C={};return C.vertices=v,C.planes=[Ic(v[1],v[0],v[4]),Ic(v[2],v[1],v[5]),Ic(v[3],v[2],v[6]),Ic(v[0],v[3],v[7])],C}addShadowReceiver(i,a,f){this._receivers.add(i,t.cV.fromTileIdAndHeight(i,a,f))}getMaxCascadeForTile(i){let a=this._receivers.get(i);return a&&a.lastCascade?a.lastCascade:0}}function Ic(p,i,a){let f=t.at([],a,i),g=t.at([],p,i),v=t.bG([],f,g),S=t.ae(v);return S===0?[0,0,1,0]:(t.b$(v,v,1/S),[v[0],v[1],v[2],-t.bE(v,i)])}function Lp(p){let i=p.properties.get("direction"),a=t.cR(i.x,i.y,i.z);a[2]=t.aD(a[2],0,75);let f=t.cW([a[0],a[1],a[2]]);return t.cS(f.x,f.y,f.z)}function Ol(p,i,a){let f=i.properties.get("color-use-theme")==="none",g=i.properties.get("color"),v=i.properties.get("intensity"),S=i.properties.get("direction"),C=[S.x,S.y,S.z],z=a.properties.get("color-use-theme")==="none",N=a.properties.get("color"),U=a.properties.get("intensity"),$=Math.max(t.bE([0,0,1],C),0),Z=[0,0,0];t.b$(Z,N.toRenderColor(z?null:p.getLut(i.scope)).toArray01Linear().slice(0,3),U);let X=[0,0,0];return t.b$(X,g.toRenderColor(f?null:p.getLut(a.scope)).toArray01Linear().slice(0,3),$*v),t.cX([Z[0]>0?Z[0]/(Z[0]+X[0]):0,Z[1]>0?Z[1]/(Z[1]+X[1]):0,Z[2]>0?Z[2]/(Z[2]+X[2]):0])}function Xr(p,i,a,f,g,v){let S=p.zoom,C=p.scale,z=p.worldSize,N=1/z,U=p.aspect,$=Math.sqrt(1+U*U)*Math.tan(.5*p.fovX),Z=$*$,X=f-a,se=f+a,re,he;Z>X/se?(re=f,he=f*$):(re=.5*se*(1+Z),he=.5*Math.sqrt(X*X+2*(f*f+a*a)*Z+se*se*Z*Z));let ae=p.projection.pixelsPerMeter(p.center.lat,z),be=p._camera.getCameraToWorldMercator(),Pe=[0,0,-re*N];t.ad(Pe,Pe,be);let Re=he*N,Ge=p._edgeInsets;if(!(Ge.left===0&&Ge.top===0&&Ge.right===0&&Ge.bottom===0||Ge.left===Ge.right&&Ge.top===Ge.bottom)){let ti=p._camera.getWorldToCamera(p.worldSize,p.projection.zAxisUnit==="meters"?ae:1),Gt=p._camera.getCameraToClipPerspective(p._fov,p.width/p.height,a,f);Gt[8]=2*-p.centerOffset.x/p.width,Gt[9]=2*p.centerOffset.y/p.height;let ii=new Float64Array(16);t.cB(ii,Gt,ti);let oi=new Float64Array(16);t.bi(oi,ii);let ki=t.cn.fromInvProjectionMatrix(oi,z,S,!0);for(let ji of ki.points){let zi=((Ne=ji)[0]/=C,Ne[1]/=C,Ne[2]=t.c6(Ne[2],p._center.lat),Ne);Re=Math.max(Re,t.c0(t.cY([],Pe,zi)))}}var Ne;Re*=g/(g-1);let Ve=Math.acos(i[2]),Oe=Math.atan2(-i[0],-i[1]),Ke=new Ys;Ke.position=Pe,Ke.setPitchBearing(Ve,Oe);let Qe=Ke.getWorldToCamera(z,ae),It=Re*z,gt=Math.min(p._mercatorZfromZoom(17)*z*-2,-2*It),jt=Ke.getCameraToClipOrthographic(-It,It,-It,It,gt,(It+v*ae)/i[2]),Ut=new Float64Array(16);t.az(Ut,jt,Qe);let fi=t.cS(Math.floor(1e6*Pe[0])/1e6*z,Math.floor(1e6*Pe[1])/1e6*z,0),vt=.5*g,Ct=[0,0,0];t.ad(Ct,fi,Ut),t.b$(Ct,Ct,vt);let _t=[Math.floor(Ct[0]),Math.floor(Ct[1]),Math.floor(Ct[2])],qt=[0,0,0];t.at(qt,Ct,_t),t.b$(qt,qt,-1/vt);let Pt=new Float64Array(16);return t.bx(Pt),t.bo(Pt,Pt,qt),t.az(Ut,Pt,Ut),[Ut,It]}class rc extends t.E{constructor(i){super(),this.requestManager=i,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(i,a){return t.aS(this.requestManager.transformRequest(a,t.R.Model).url).then(f=>{if(!f)return;let g=t.aT(f),v=new t.aU(i,void 0,void 0,g);return v.computeBoundsAndApplyParent(),v}).catch(f=>{if(f&&f.status===404)return null;this.fire(new t.z(new Error(`Could not load model ${i} from ${a}: ${f.message}`)))})}load(i,a,f={forceReload:!1}){this.models[a]||(this.models[a]={});let g=Object.keys(i),v=[],S=[];for(let C of g){let z=i[C];this.hasURLBeenRequested(z)&&!f.forceReload||(this.modelByURL[z]={modelId:C,scope:a},v.push(this.loadModel(C,z)),S.push(C)),this.models[a][C]||(this.models[a][C]={model:null,numReferences:1})}this.numModelsLoading[a]=(this.numModelsLoading[a]||0)+S.length,Promise.allSettled(v).then(C=>{for(let z=0;z<C.length;z++){let{status:N}=C[z];if(N==="rejected")continue;let{value:U}=C[z];this.models[a][S[z]]||(this.models[a][S[z]]={model:null,numReferences:1}),this.models[a][S[z]].model=U}this.numModelsLoading[a]-=S.length,this.fire(new t.A("data",{dataType:"style"}))}).catch(C=>{this.fire(new t.z(new Error(`Could not load models: ${C.message}`)))})}isLoaded(){for(let i in this.numModelsLoading)if(this.numModelsLoading[i]>0)return!1;return!0}hasModel(i,a,f={exactIdMatch:!1}){return!!(f.exactIdMatch?this.getModel(i,a):this.getModelByURL(this.modelUris[a][i]))}getModel(i,a){return this.models[a]||(this.models[a]={}),this.models[a][i]?this.models[a][i].model:void 0}getModelByURL(i){if(!i)return null;let a=this.modelByURL[i];return a?this.models[a.scope][a.modelId].model:null}hasModelBeenAdded(i,a){return this.models[a]&&this.models[a][i]!==void 0}getModelURIs(i){return this.modelUris[i]||{}}addModel(i,a,f){this.models[f]||(this.models[f]={}),this.modelUris[f]||(this.modelUris[f]={});let g=this.requestManager.normalizeModelURL(a);if((this.hasModel(i,f,{exactIdMatch:!0})||this.hasModelBeenAdded(i,f))&&this.modelUris[f][i]===g)this.models[f][i].numReferences++;else if(this.hasURLBeenRequested(g)){let{scope:v,modelId:S}=this.modelByURL[g];this.models[v][S].numReferences++}else this.modelUris[f][i]=g,this.load({[i]:this.modelUris[f][i]},f)}addModelURLs(i,a){this.models[a]||(this.models[a]={}),this.modelUris[a]||(this.modelUris[a]={});let f=this.modelUris[a];for(let g in i)f[g]=this.requestManager.normalizeModelURL(i[g])}reloadModels(i){this.load(this.modelUris[i],i,{forceReload:!0})}addModelsFromBucket(i,a){this.models[a]||(this.models[a]={}),this.modelUris[a]||(this.modelUris[a]={});let f={};for(let g of i)this.hasModel(g,a,{exactIdMatch:!0})||this.hasURLBeenRequested(g)?this.models[a][g].numReferences++:this.modelUris[a][g]&&!this.hasURLBeenRequested(g)?f[g]=this.modelUris[a][g]:!this.hasURLBeenRequested(g)&&t.cZ(g,!1)&&(this.modelUris[a][g]=this.requestManager.normalizeModelURL(g),f[g]=this.modelUris[a][g]);this.load(f,a)}hasURLBeenRequested(i){return this.modelByURL[i]!==void 0}removeModel(i,a,f=!1){if(this.models[a]&&this.models[a][i]&&(this.models[a][i].numReferences--,this.models[a][i].numReferences===0)){let g=this.modelUris[a][i];f||delete this.modelUris[a][i],delete this.modelByURL[g];let v=this.models[a][i].model;if(!v)return;delete this.models[a][i],v.destroy()}}destroy(){for(let i of Object.keys(this.models))for(let a of Object.keys(this.models[i])){let f=this.models[i][a].model;delete this.models[i][a],f&&f.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(i){return this.models[i]||(this.models[i]={}),Object.keys(this.models[i])}upload(i,a){this.models[a]||(this.models[a]={});for(let f in this.models[a])this.models[a][f].model&&this.models[a][f].model.upload(i.context)}}let ih=new t.a7({data:new t.a8(t.a5.colorTheme.data)}),cf={"mbx-indoor-active-floorplans":{default:["literal",[]]},"mbx-indoor-underground":{default:["literal",!1]},"mbx-indoor-loaded-levels":{default:["literal",[]]},"mbx-indoor-level-height":{default:["literal",{}]},"mbx-indoor-level-base":{default:["literal",{}]},"mbx-indoor-level-selected":{default:["literal",{}]},"mbx-indoor-level-overlapped":{default:["literal",{}]}};function kp(p){return p=p||{},Object.assign(p,cf)}class Op extends t.E{constructor(i){super(),this.mergeFloors=!0,this._scope=void 0,this._queryFeatureSetId=void 0,this._buildingEntryFeatureSetId=void 0,this._selectedFloorplan=void 0,this._indoorData=void 0,this._selectedLevel=void 0,this._floorplanStates={},t.aV(["_onLoad","_onMove","_checkFloorplanVisible"],this),this._map=i,this._checkFloorplanVisible(!0),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=void 0}_onLoad(){this._map.style.forEachFragmentStyle(i=>{i.stylesheet.indoor&&(this._queryFeatureSetId?this.fire(new t.z(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._queryFeatureSetId=i.stylesheet.indoor.floorplanFeaturesetId,this._buildingEntryFeatureSetId=i.stylesheet.indoor.buildingFeaturesetId,this._scope=i.scope))}),this._queryFeatureSetId&&this._buildingEntryFeatureSetId&&this._map.addInteraction("mbx-indoor-buildingclick",{type:"click",target:{featuresetId:this._buildingEntryFeatureSetId,importId:this._scope},handler:i=>(i.feature&&i.feature.properties.floorplan&&this.selectFloorplan(i.feature.properties.floorplan),!0)}),this._checkFloorplanVisible(!0)}_onMove(){this._checkFloorplanVisible(!1)}_checkFloorplanVisible(i){if(!this._queryFeatureSetId||!this._map.isStyleLoaded()||this._map.transform.zoom<13)return;this._indoorData&&!function(S,C){let[z,N]=S,{center:U,radius:$}=C,[Z,X]=U,se=Math.abs(z-Z);return Math.sqrt((se>180?360-se:se)**2+(N-X)**2)<=$}([this._map.getCenter().lng,this._map.getCenter().lat],this._indoorData.circumCircle)&&(this._indoorData=void 0,this._selectedFloorplan=void 0,this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[]]),this.fire(new t.A("floorplangone")));let a={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},f=new t.P(this._map.transform.width/2,this._map.transform.height/2),g=[new t.P(0,0),new t.P(this._map.transform.width,this._map.transform.height)],v=this._map.queryRenderedFeatures(i?g:f,a);v.length>0&&(this._selectedFloorplan&&v[0].properties.id===this._selectedFloorplan.properties.id||(this._selectedFloorplan=v[0],this._floorplanSelected(!1)))}_floorplanSelected(i){this._indoorData=JSON.parse(this._selectedFloorplan.properties["indoor-data"]),this._indoorData.id=this._selectedFloorplan.properties.id,this._indoorData.circumCircle=function(v){let[[S,C],[z,N]]=v,U=(z-S+360)%360,$=U>180?360-U:U;return{center:[(S+$/2+360)%360,(C+N)/2],radius:Math.sqrt($**2+(N-C)**2)/2}}(this._indoorData.extent),this._floorplanStates[this._indoorData.id]||(this._floorplanStates[this._indoorData.id]={});let a=this._floorplanStates[this._indoorData.id].selectedBuilding,f=this._floorplanStates[this._indoorData.id].selectedLevel,g;if(this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",this._indoorData.floorplanIDs),this._selectedLevel)for(let v of this._indoorData.levels)v.id===this._selectedLevel.id&&(g=v.id);if(this.fire(new t.A("floorplanselected",{buildings:this._indoorData.buildings,levels:this._indoorData.levels,selectedLevelId:g})),a){let v=this._indoorData.buildings.find(S=>S.id===a);this._buildingSelected(v,!1)}else this._indoorData.buildings.length>0&&this._buildingSelected(this._indoorData.buildings[0],!1);if(f){let v=this._indoorData.levels.find(S=>S.id===f);this._updateLevels(v,i)}else i&&this._indoorData["default-levels"].length>0&&this.selectLevel(this._indoorData["default-levels"][0])}_buildingSelected(i,a){a&&i&&i.extent&&this._map.fitBounds(i.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),this._floorplanStates[this._indoorData.id].selectedBuilding=i?i.id:void 0;let f=this._indoorData.levels.filter(g=>i.levels.includes(g.id));this.fire(new t.A("buildingselected",{buildingId:i.id,levels:f}))}_levelSelected(i){if(i==="overview")this._updateLevels(void 0,!0);else{let a=this._indoorData.levels.find(f=>f.id===i);this._updateLevels(a,!0)}this.fire(new t.A("levelselected",{levelId:i==="overview"?void 0:i}))}_updateLevels(i,a){if(!i)return this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",[]]),this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._floorplanStates[this._indoorData.id].selectedLevel=void 0,void(a&&this._indoorData.extent&&this._map.fitBounds(this._indoorData.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}));function f(N){let U=N.indexOf("/floor/");if(U===-1)return N;let $=U+7,Z=N.indexOf("/",$);return Z===-1?N.slice($):N.slice($,Z)}this._selectedLevel=i,this._floorplanStates[this._indoorData.id].selectedLevel=i?i.id:void 0;let g=[],v={},S={},C={},z={};for(let N of this._indoorData.levels)if(g.push(N.id),v[N.id]=N.height,S[N.id]=N.base,i){if(this.mergeFloors){let U=f(i.id),$=f(N.id);C[N.id]=$===U?"true":"false"}else C[N.id]=N.id===i.id?"true":"false";z[N.id]=N.base<i.base?"true":"false"}else z[N.id]=!0;if(this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",g]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-height",["literal",v]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-base",["literal",S]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",C]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-overlapped",["literal",z]),i&&(this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!!i.isUnderground),a&&i.extent)){let N=this._map.cameraForBounds(i.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),U=this._map.getZoom(),$=N.zoom?Math.abs(U-N.zoom):0;this._map.fitBounds(i.extent,$>=1?{pitch:this._map.getPitch(),bearing:this._map.getBearing()}:{pitch:this._map.getPitch(),bearing:this._map.getBearing(),zoom:U})}}selectFloorplan(i){let a={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},f=[new t.P(0,0),new t.P(this._map.transform.width,this._map.transform.height)],g=this._map.queryRenderedFeatures(f,a);if(g.length>0){for(let v of g)if(JSON.parse(v.properties["indoor-data"]).floorplanIDs.includes(i)){this._selectedFloorplan=v,this._floorplanSelected(!0);break}}}selectBuilding(i){let a=this._indoorData.buildings.find(f=>f.id===i);this._buildingSelected(a,!0)}selectLevel(i){this._levelSelected(i)}}function Ff(p){if(!p.metadata||!p.metadata.content_area)return;let i=t.q.devicePixelRatio,{left:a,top:f,width:g,height:v}=p.metadata.content_area,S=a*i,C=f*i;return[S,C,S+g*i,C+v*i]}function Vu(p){if(p)return p.map(([i,a])=>[i*t.q.devicePixelRatio,a*t.q.devicePixelRatio])}class Lh{constructor(i,a,f){this.id=i,this.scope=a,this.sourceCache=f,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(i){this.missingRequests.has(i.name)||this.pendingRequests.has(i.name)||this.pendingRequests.add(i.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){let i=new Map;if(!this.sourceCache.loaded())return i;let a=this.sourceCache.getVisibleCoordinates();if(a.length===0)return i;let f=this.sourceCache.getSource();if(!(f instanceof Eh))return i;let g=a.map(S=>this.sourceCache.getTile(S)),v=f.getImages(g,Array.from(this.pendingRequests));for(let[S,C]of v)i.set(t.I.from({name:S,iconsetId:this.id}),C),this.pendingRequests.delete(S);for(let S of this.pendingRequests)this.missingRequests.add(S);return this.pendingRequests.clear(),i}}let Cc=(p,i)=>rt(p,i&&i.filter(a=>a.identifier!=="source.canvas")),Bf=t.aF(wn,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),Nf=t.aF(wn,["setCenter","setZoom","setBearing","setPitch"]),nh=new Set(["background","sky","slot","custom"]),Ad={version:8,layers:[],sources:{}},Fp={duration:300,delay:0};class Fl extends t.E{constructor(i,a={}){super(),this.map=i,this.scope=a.scope||"",this.globalId=null,this.fragments=[],this.importDepth=a.importDepth||0,this.importsCache=a.importsCache||new Map,this.resolvedImports=a.resolvedImports||new Set,this.transition=t.l({},Fp),this._buildingIndex=new Cd(this),this.crossTileSymbolIndex=new $o,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=a.styleChanges||new hr,this.dispatcher=a.dispatcher?a.dispatcher:new t.D(t.d0(),this),a.imageManager?this.imageManager=a.imageManager:(this.imageManager=new ra(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=a.glyphManager?a.glyphManager:new t.d1(i._requestManager,a.localFontFamily?t.d2.all:a.localIdeographFontFamily?t.d2.ideographs:t.d2.none,a.localFontFamily||a.localIdeographFontFamily),a.modelManager?this.modelManager=a.modelManager:(this.modelManager=new rc(i._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=a.configOptions?a.configOptions:new Map,this._configDependentLayers=a.configDependentLayers?a.configDependentLayers:new Set,this._config=a.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:a.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=a.initialConfig,this.dispatcher.broadcast("setReferrer",t.d3());let f=this;this._rtlTextPluginCallback=Fl.registerForPluginStateChange(g=>{f.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:g.pluginStatus,pluginURL:g.pluginURL},(v,S)=>{if(t.d4(v),S&&S.every(C=>C))for(let C in f._sourceCaches){let z=f._sourceCaches[C],N=z.getSource().type;N!=="vector"&&N!=="geojson"||z.reload()}})}),this.on("data",g=>{if(g.dataType!=="source"||g.sourceDataType!=="metadata")return;let v=this.getOwnSource(g.sourceId);if(v&&v.vectorLayerIds)for(let S in this._layers){let C=this._layers[S];C.source===v.id&&this._validateLayer(C)}})}load(i){return i?(typeof i=="string"?this.loadURL(i):this.loadJSON(i),this):this}_getGlobalId(i){if(!i)return null;if(typeof i=="string"){if(t.f(i))return i;let a=t.d5(i);if(!a.startsWith("http"))try{return new URL(a,location.href).toString()}catch{return a}return a}return`json://${t.d6(JSON.stringify(i))}`}_diffStyle(i,a,f){this.globalId=this._getGlobalId(i);let g=(v,S)=>{try{S(null,this.setState(v,f))}catch(C){S(C,!1)}};if(typeof i=="string"){let v=this.map._requestManager.normalizeStyleURL(i),S=this.map._requestManager.transformRequest(v,t.R.Style);t.n(S,(C,z)=>{C?this.fire(new t.z(C)):z&&g(z,a)})}else typeof i=="object"&&g(i,a)}loadURL(i,a={}){this.fire(new t.A("dataloading",{dataType:"style"}));let f=typeof a.validate=="boolean"?a.validate:!t.f(i);this.globalId=this._getGlobalId(i),i=this.map._requestManager.normalizeStyleURL(i,a.accessToken),this.resolvedImports.add(i);let g=this.importsCache.get(i);if(g)return this._load(g,f);let v=this.map._requestManager.transformRequest(i,t.R.Style);this._request=t.n(v,(S,C)=>{if(this._request=null,S)this.fire(new t.z(S));else if(C)return this.importsCache.set(i,C),this._load(C,f)})}loadJSON(i,a={}){this.fire(new t.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(i),this._request=t.q.frame(()=>{this._request=null,this._load(i,a.validate!==!1)})}loadEmpty(){this.fire(new t.A("dataloading",{dataType:"style"})),this._load(Ad,!1)}_loadImports(i,a,f){if(this.importDepth>=4)return t.w("Style doesn't support nesting deeper than 5"),Promise.resolve();let g=[];for(let v of i){let S=this._createFragmentStyle(v),C=new Promise(U=>{S.once("style.import.load",U),S.once("error",U)}).then(()=>this.mergeAll());if(g.push(C),this.resolvedImports.has(v.url)){S.loadEmpty();continue}let z=v.data||this.importsCache.get(v.url);z?(S.loadJSON(z,{validate:a}),this._isInternalStyle(z)&&(S.globalId=null)):v.url?S.loadURL(v.url,{validate:a}):S.loadEmpty();let N={style:S,id:v.id,config:v.config};if(f){let U=this.fragments.findIndex(({id:$})=>$===f);this.fragments=this.fragments.slice(0,U).concat(N).concat(this.fragments.slice(U))}else this.fragments.push(N)}return Promise.allSettled(g)}getImportGlobalIds(i=this,a=new Set){for(let f of i.fragments)f.style.globalId&&a.add(f.style.globalId),this.getImportGlobalIds(f.style,a);return[...a.values()]}_createFragmentStyle(i){let a=this.scope?t.C(i.id,this.scope):i.id,f,g=this._initialConfig&&this._initialConfig[a];(i.config||g)&&(f=t.l({},i.config,g));let v=new Fl(this.map,{scope:a,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:f,configOptions:this.options,colorThemeOverride:i["color-theme"],configDependentLayers:this._configDependentLayers});return v.setEventedParent(this.map,{style:v}),v}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(i){return this.isRootStyle()&&(i.fragment||!!i.schema&&i.fragment!==!1)}_load(i,a){let f=i.indoor?kp(i.schema):i.schema;if(this._isInternalStyle(i)){let S=t.l({},Ad,{imports:[{id:"basemap",data:i,url:""}]});return void this._load(S,a)}if(this.updateConfig(this._config,f),a&&Cc(this,di(i)))return;this._loaded=!0,this.stylesheet=t.d7(i);let g=()=>{for(let N in i.sources)this.addSource(N,i.sources[N],{validate:!1,isInitialLoad:!0});if(i.iconsets)for(let N in i.iconsets)this.addIconset(N,i.iconsets[N]);i.sprite?this._loadIconset(i.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.setGlyphsUrl(i.glyphs);let S=Xs(this.stylesheet.layers);if(this._order=S.map(N=>N.id),this.stylesheet.light&&t.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){let N=this.stylesheet.lights[0];this.light=new nt(N.properties,N.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new nt(this.stylesheet.light)),this._layers={};for(let N of S){let U=t.dc(N,this.scope,this._styleColorTheme.lut,this.options);U.configDependencies.size!==0&&this._configDependentLayers.add(U.fqid),U.setEventedParent(this,{layer:{id:U.id}}),this._layers[U.id]=U;let $=this.getOwnLayerSourceCache(U),Z=!!this.directionalLight&&this.directionalLight.shadowsEnabled();$&&U.canCastShadows()&&Z&&($.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);let C=this.stylesheet.terrain;C&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(C,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new t.A("data",{dataType:"style"}));let z=this.isRootStyle();i.imports?this._loadImports(i.imports,a).then(()=>{this._reloadImports(),this.fire(new t.A(z?"style.load":"style.import.load"))}).catch(N=>{this.fire(new t.z(new Error("Failed to load imports",N))),this.fire(new t.A(z?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new t.A(z?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];let v=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(v){let S=this._evaluateColorThemeData(v);this._loadColorTheme(S).then(()=>{g()}).catch(C=>{t.w(`Couldn't load color theme from the stylesheet: ${C}`),g()})}else this._styleColorTheme.lut=null,g()}isRootStyle(){return this.importDepth===0}mergeAll(){let i,a,f,g,v,S,C,z,N,U,$={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(Z=>{if(Z.stylesheet){if(Z.light!=null&&(i=Z.light),Z.stylesheet.lights)for(let X of Z.stylesheet.lights)X.type==="ambient"&&Z.ambientLight!=null&&(a=Z.ambientLight),X.type==="directional"&&Z.directionalLight!=null&&(f=Z.directionalLight);g=this._prioritizeTerrain(g,Z.terrain,Z.stylesheet.terrain),Z.stylesheet.fog&&Z.fog!=null&&(v=Z.fog),Z.stylesheet.snow&&Z.snow!=null&&(S=Z.snow),Z.stylesheet.rain&&Z.rain!=null&&(C=Z.rain),Z.stylesheet.camera!=null&&(U=Z.stylesheet.camera),Z.stylesheet.projection!=null&&(z=Z.stylesheet.projection),Z.stylesheet.transition!=null&&(N=Z.stylesheet.transition),$[Z.scope]=Z._styleColorTheme}}),this.light=i,this.ambientLight=a,this.directionalLight=f,this.fog=v,this.snow=S,this.rain=C,this._styleColorThemeForScope=$,g===null?delete this.terrain:this.terrain=g,this.camera=U||{"camera-projection":"perspective"},this.projection=z||{name:"mercator"},this.transition=t.l({},Fp,N),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(i){let a=f=>{for(let g of f.fragments)a(g.style);i(f)};a(this)}_prioritizeTerrain(i,a,f){let g=i&&i.drapeRenderMode===0;return f===null?a&&a.drapeRenderMode===0?a:g?i:null:a!=null&&(!i||g||a&&a.drapeRenderMode===1)?a:i}mergeTerrain(){let i;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(a=>{i=this._prioritizeTerrain(i,a.terrain,a.stylesheet.terrain)}),i===null?delete this.terrain:this.terrain=i}mergeProjection(){let i;this.forEachFragmentStyle(a=>{a.stylesheet.projection!=null&&(i=a.stylesheet.projection)}),this.projection=i||{name:"mercator"}}mergeSources(){let i={},a={},f={};this.forEachFragmentStyle(g=>{for(let v in g._sourceCaches){let S=t.C(v,g.scope);i[S]=g._sourceCaches[v]}for(let v in g._otherSourceCaches){let S=t.C(v,g.scope);a[S]=g._otherSourceCaches[v]}for(let v in g._symbolSourceCaches){let S=t.C(v,g.scope);f[S]=g._symbolSourceCaches[v]}}),this._mergedSourceCaches=i,this._mergedOtherSourceCaches=a,this._mergedSymbolSourceCaches=f}mergeLayers(){let i={},a=[],f={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(v=>{for(let S of v._order){let C=v._layers[S];if(C.type==="slot"){let z=t.d8(S);if(i[z])continue;i[z]=[]}C.slot&&i[C.slot]?i[C.slot].push(C):a.push(C)}}),this._mergedOrder=[];let g=(v=[])=>{for(let S of v)if(S.type==="slot"){let C=t.d8(S.id);i[C]&&g(i[C]),this._mergedSlots.push(C)}else{let C=t.C(S.id,S.scope);this._mergedOrder.push(C),f[C]=S,S.is3D(!!this.terrain)&&(this._has3DLayers=!0),S.type==="circle"&&(this._hasCircleLayers=!0),S.type==="symbol"&&(this._hasSymbolLayers=!0),S.type==="clip"&&(this._clipLayerPresent=!0)}};g(a),this._mergedOrder.sort((v,S)=>{let C=f[v],z=f[S];return C.hasInitialOcclusionOpacityProperties?z.is3D(!!this.terrain)?1:0:C.is3D(!!this.terrain)&&z.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=f,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(i){return this.stylesheet.camera=t.l({},this.stylesheet.camera,i),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(i){return i.data?function(a,f,g){let v=t.l({},f);for(let C of Object.keys(t.a5.colorTheme))v[C]===void 0&&(v[C]=t.a5.colorTheme[C].default);let S=new t.a6(ih,a,new Map(g));return S.setTransitionOrValue(v,g),S.untransitioned().possiblyEvaluate(new t.aa(0))}(this.scope,i,this.options).get("data"):null}_loadColorTheme(i){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;let a=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((f,g)=>{let v="data:image/png;base64,";if(!i||i.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void f();let S=i;S.startsWith(v)||(S=v+S);let C=t.I.from("mapbox-reserved-lut"),z=new Image;z.src=S,z.onerror=()=>{this._styleColorTheme.lutLoading=!1,g(new Error("Failed to load image data"))},z.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==a)return void f();this._styleColorTheme.lutLoading=!1;let{width:N,height:U,data:$}=t.q.getImageData(z);if(U>32)return void g(new Error("The height of the image must be less than or equal to 32 pixels."));if(N!==U*U)return void g(new Error("The width of the image must be equal to the height squared."));this.getImage(C)&&this.removeImage(C),this.addImage(C,{data:new t.r({width:N,height:U},$),pixelRatio:1,sdf:!1,usvg:!1,version:0});let Z=this.imageManager.getImage(C,this.scope);Z?(this._styleColorTheme.lut={image:Z.data,data:i},f()):g(new Error("Missing LUT image."))}})}getLut(i){let a=this._styleColorThemeForScope[i];return a?a.lut:null}setProjection(i){i?this.stylesheet.projection=i:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(i){this._spriteRequest=function(a,f,g){let v,S,C,z=t.q.devicePixelRatio>1?"@2x":"",N=t.n(f.transformRequest(f.normalizeSpriteURL(a,z,".json"),t.R.SpriteJSON),(Z,X)=>{N=null,C||(C=Z,v=X,$())}),U=t.o(f.transformRequest(f.normalizeSpriteURL(a,z,".png"),t.R.SpriteImage),(Z,X)=>{U=null,C||(C=Z,S=X,$())});function $(){if(C)g(C);else if(v&&S){let Z=t.q.getImageData(S),X={};for(let se in v){let{width:re,height:he,x:ae,y:be,sdf:Pe,pixelRatio:Re,stretchX:Ge,stretchY:Ne,content:Ve}=v[se],Oe=new t.r({width:re,height:he});t.r.copy(Z,Oe,{x:ae,y:be},{x:0,y:0},{width:re,height:he},null),X[se]={data:Oe,pixelRatio:Re,sdf:Pe,stretchX:Ge,stretchY:Ne,content:Ve,usvg:!1}}g(null,X)}}return{cancel(){N&&(N.cancel(),N=null),U&&(U.cancel(),U=null)}}}(i,this.map._requestManager,(a,f)=>{if(this._spriteRequest=null,a)this.fire(new t.z(a));else if(f){let g=new Map;for(let v in f)g.set(t.I.from(v),f[v]);this.addImages(g)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new t.A("data",{dataType:"style"}))})}addIconset(i,a){if(a.type==="sprite")return void this._loadSprite(a.url);let f=this.getOwnSourceCache(a.source);if(!f)return void this.fire(new t.z(new Error(`Source "${a.source}" as specified by iconset "${i}" does not exist and cannot be used as an iconset source`)));let g=f.getSource();if(g.type!=="raster-array")return void this.fire(new t.z(new Error(`Source "${a.source}" as specified by iconset "${i}" is not a "raster-array" source and cannot be used as an iconset source`)));g.partial=!1;let v=new Lh(i,this.scope,f);this.imageManager.addImageProvider(v,this.scope)}removeIconset(i){this.imageManager.removeImageProvider(i,this.scope)}_loadIconset(i){if(!t.f(i)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(i);let a=this.map._spriteFormat==="auto";var f,g;this._spriteRequest=(g=(v,S)=>{if(this._spriteRequest=null,v)a?this._loadSprite(i):this.fire(new t.z(v));else if(S){let C=new Map;for(let z in S)C.set(t.I.from(z),S[z]);this.addImages(C)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new t.A("data",{dataType:"style"}))},t.br((f=this.map._requestManager).transformRequest(f.normalizeIconsetURL(i),t.R.Iconset),(v,S)=>{if(v)return void g(v);let C={},z=t.c_(new t.bq(S));for(let N of z.icons){let U={version:1,pixelRatio:t.q.devicePixelRatio,content:Ff(N),stretchX:N.metadata?Vu(N.metadata.stretch_x_areas):void 0,stretchY:N.metadata?Vu(N.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:N};C[N.name]=U}g(null,C)}))}_validateLayer(i){let a=this.getOwnSource(i.source);if(!a)return;let f=i.sourceLayer;f&&(a.type==="geojson"||a.vectorLayerIds&&a.vectorLayerIds.indexOf(f)===-1)&&this.fire(new t.z(new Error(`Source layer "${f}" does not exist on source "${a.id}" as specified by style layer "${i.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(let i in this._sourceCaches)if(!this._sourceCaches[i].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(let{style:i}of this.fragments)if(!i.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((i,a)=>{let f=this.fragments[a];return f&&f.style&&(i.data=f.style.serialize()),i})}_serializeSources(){let i={};for(let a in this._sourceCaches){let f=this._sourceCaches[a].getSource();i[f.id]||(i[f.id]=f.serialize())}return i}_serializeLayers(i){let a=[];for(let f of i){let g=this._layers[f];g&&g.type!=="custom"&&a.push(g.serialize())}return a}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(let i in this._sourceCaches)if(this._sourceCaches[i].hasTransition())return!0;for(let i in this._layers)if(this._layers[i].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(i){return i?this.order:this._mergedOrder}isLayerDraped(i){return!!this.terrain&&i.isDraped(this.getLayerSourceCache(i))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(i){let a=this.getOwnLayer(i);if(a)return a;this.fire(new t.z(new Error(`The layer '${i}' does not exist in the map's style.`)))}_checkSource(i){let a=this.getOwnSource(i);if(a)return a;this.fire(new t.z(new Error(`The source '${i}' does not exist in the map's style.`)))}precompilePrograms(i,a){let f=this.map.painter;if(f)for(let g=i.minzoom||0;g<(i.maxzoom||25.5);g++){let v=i.getProgramIds();if(v)for(let S of v){let C=i.getDefaultProgramParams(S,a.zoom,this._styleColorTheme.lut);C&&(f.style=this,this.fog&&(f._fogVisible=!0,C.overrideFog=!0,f.getOrCreateProgram(S,C)),f._fogVisible=!1,C.overrideFog=!1,f.getOrCreateProgram(S,C),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(C.overrideRtt=!0,f.getOrCreateProgram(S,C)))}}}update(i){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(i),this.directionalLight&&this.directionalLight.recalculate(i);let a=this.calculateLightsBrightness();i.brightness=a||0,a!==this._brightness&&(this._brightness=a,this.dispatcher.broadcast("setBrightness",a));let f=this._changes.isDirty(),g=!1;if(this._changes.isDirty()){let C=this._changes.getLayerUpdatesByScope();for(let z in C){let{updatedIds:N,removedIds:U}=C[z];(N||U)&&(this._updateWorkerLayers(z,N,U),g=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(i),this.light&&this.light.updateTransitions(i),this.ambientLight&&this.ambientLight.updateTransitions(i),this.directionalLight&&this.directionalLight.updateTransitions(i),this.fog&&this.fog.updateTransitions(i),this.snow&&this.snow.updateTransitions(i),this.rain&&this.rain.updateTransitions(i),this._changes.reset()}let v={};for(let C in this._mergedSourceCaches){let z=this._mergedSourceCaches[C];v[C]=z.used,z.used=!1,z.tileCoverLift=0}for(let C of this._mergedOrder){let z=this._mergedLayers[C];if(z.recalculate(i,this._availableImages),!z.isHidden(i.zoom)){let N=this.getLayerSourceCache(z);N&&(N.used=!0,N.tileCoverLift=Math.max(N.tileCoverLift,z.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(z,i)}):this.precompilePrograms(z,i))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&g&&this.mergeLayers();let S=this.imageManager.getPendingImageProviders();for(let C of S)C.sourceCache.used=!0;for(let C in v){let z=this._mergedSourceCaches[C];v[C]!==z.used&&z.getSource().fire(new t.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:z.getSource().id}))}this.light&&this.light.recalculate(i),this.terrain&&this.terrain.recalculate(i),this.fog&&this.fog.recalculate(i),this.snow&&this.snow.recalculate(i),this.rain&&this.rain.recalculate(i),this.z=i.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),f&&this.fire(new t.A("data",{dataType:"style"}))}updateImageProviders(){let i=this.imageManager.getPendingImageProviders();for(let a of i){let f=a.resolvePendingRequests(),g=this.getFragmentStyle(a.scope);g&&g.addImages(f)}}_updateTilesForChangedImages(){let i={};for(let a in this._mergedSourceCaches){let f=this._mergedSourceCaches[a].getSource().scope;i[f]=i[f]||this._changes.getUpdatedImages(f),i[f].length!==0&&this._mergedSourceCaches[a].reloadTilesForDependencies(["icons","patterns"],i[f])}for(let a in i)this._changes.resetUpdatedImages(a)}_updateWorkerLayers(i,a,f){let g=this.getFragmentStyle(i);g&&this.dispatcher.broadcast("updateLayers",{layers:a?g._serializeLayers(a):[],scope:i,removedIds:f||[],options:g.options})}setState(i,a){if(this._checkLoaded(),Cc(this,di(i)))return!1;(i=t.d7(i)).layers=Xs(i.layers);let f=function(S,C){if(!S)return[{command:wn.setStyle,args:[C]}];let z=[];try{if(!t.bv(S.version,C.version))return[{command:wn.setStyle,args:[C]}];if(t.bv(S.center,C.center)||z.push({command:wn.setCenter,args:[C.center]}),t.bv(S.zoom,C.zoom)||z.push({command:wn.setZoom,args:[C.zoom]}),t.bv(S.bearing,C.bearing)||z.push({command:wn.setBearing,args:[C.bearing]}),t.bv(S.pitch,C.pitch)||z.push({command:wn.setPitch,args:[C.pitch]}),t.bv(S.sprite,C.sprite)||z.push({command:wn.setSprite,args:[C.sprite]}),t.bv(S.glyphs,C.glyphs)||z.push({command:wn.setGlyphs,args:[C.glyphs]}),t.bv(S.imports,C.imports)||function(X=[],se=[],re){se=se||[];let he=(X=X||[]).map(As),ae=se.map(As),be=X.reduce(or,{}),Pe=se.reduce(or,{}),Re=he.slice(),Ge,Ne,Ve,Oe;for(Ge=0,Ne=0;Ge<he.length;Ge++)Ve=he[Ge],Pe.hasOwnProperty(Ve)?Ne++:(re.push({command:wn.removeImport,args:[Ve]}),Re.splice(Re.indexOf(Ve,Ne),1));for(Ge=0,Ne=0;Ge<ae.length;Ge++)Ve=ae[ae.length-1-Ge],Re[Re.length-1-Ge]!==Ve&&(be.hasOwnProperty(Ve)?(re.push({command:wn.removeImport,args:[Ve]}),Re.splice(Re.lastIndexOf(Ve,Re.length-Ne),1)):Ne++,Oe=Re[Re.length-Ge],re.push({command:wn.addImport,args:[Pe[Ve],Oe]}),Re.splice(Re.length-Ge,0,Ve));for(let Ke of se){let Qe=be[Ke.id];Qe&&!t.bv(Qe,Ke)&&re.push({command:wn.updateImport,args:[Ke.id,Ke]})}}(S.imports,C.imports,z),t.bv(S.transition,C.transition)||z.push({command:wn.setTransition,args:[C.transition]}),t.bv(S.light,C.light)||z.push({command:wn.setLight,args:[C.light]}),t.bv(S.fog,C.fog)||z.push({command:wn.setFog,args:[C.fog]}),t.bv(S.snow,C.snow)||z.push({command:wn.setSnow,args:[C.snow]}),t.bv(S.rain,C.rain)||z.push({command:wn.setRain,args:[C.rain]}),t.bv(S.projection,C.projection)||z.push({command:wn.setProjection,args:[C.projection]}),t.bv(S.lights,C.lights)||z.push({command:wn.setLights,args:[C.lights]}),t.bv(S.camera,C.camera)||z.push({command:wn.setCamera,args:[C.camera]}),t.bv(S.iconsets,C.iconsets)||function(X,se,re){let he;for(he in se=se||{},X=X||{})X.hasOwnProperty(he)&&(se.hasOwnProperty(he)||re.push({command:wn.removeIconset,args:[he]}));for(he in se){if(!se.hasOwnProperty(he))continue;let ae=se[he];X.hasOwnProperty(he)?t.bv(X[he],ae)||(re.push({command:wn.removeIconset,args:[he]}),re.push({command:wn.addIconset,args:[he,ae]})):re.push({command:wn.addIconset,args:[he,ae]})}}(S.iconsets,C.iconsets,z),!t.bv(S["color-theme"],C["color-theme"]))return[{command:wn.setStyle,args:[C]}];let N={},U=[];(function(X,se,re,he){let ae;for(ae in se=se||{},X=X||{})X.hasOwnProperty(ae)&&(se.hasOwnProperty(ae)||gs(ae,re,he));for(ae in se){if(!se.hasOwnProperty(ae))continue;let be=se[ae];X.hasOwnProperty(ae)?t.bv(X[ae],be)||(X[ae].type==="geojson"&&be.type==="geojson"&&Ed(X,se,ae)?re.push({command:wn.setGeoJSONSourceData,args:[ae,be.data]}):cs(ae,se,re,he)):Ps(ae,se,re)}})(S.sources,C.sources,U,N);let $=[];S.layers&&S.layers.forEach(X=>{X.source&&N[X.source]?z.push({command:wn.removeLayer,args:[X.id]}):$.push(X)});let Z=S.terrain;Z&&N[Z.source]&&(z.push({command:wn.setTerrain,args:[void 0]}),Z=void 0),z=z.concat(U),t.bv(Z,C.terrain)||z.push({command:wn.setTerrain,args:[C.terrain]}),function(X,se,re){se=se||[];let he=(X=X||[]).map(As),ae=se.map(As),be=X.reduce(or,{}),Pe=se.reduce(or,{}),Re=he.slice(),Ge=Object.create(null),Ne,Ve,Oe,Ke,Qe,It,gt;for(Ne=0,Ve=0;Ne<he.length;Ne++)Oe=he[Ne],Pe.hasOwnProperty(Oe)?Ve++:(re.push({command:wn.removeLayer,args:[Oe]}),Re.splice(Re.indexOf(Oe,Ve),1));for(Ne=0,Ve=0;Ne<ae.length;Ne++)Oe=ae[ae.length-1-Ne],Re[Re.length-1-Ne]!==Oe&&(be.hasOwnProperty(Oe)?(re.push({command:wn.removeLayer,args:[Oe]}),Re.splice(Re.lastIndexOf(Oe,Re.length-Ve),1)):Ve++,It=Re[Re.length-Ne],re.push({command:wn.addLayer,args:[Pe[Oe],It]}),Re.splice(Re.length-Ne,0,Oe),Ge[Oe]=!0);for(Ne=0;Ne<ae.length;Ne++)if(Oe=ae[Ne],Ke=be[Oe],Qe=Pe[Oe],!Ge[Oe]&&!t.bv(Ke,Qe))if(t.bv(Ke.source,Qe.source)&&t.bv(Ke["source-layer"],Qe["source-layer"])&&t.bv(Ke.type,Qe.type)){for(gt in Cr(Ke.layout,Qe.layout,re,Oe,null,wn.setLayoutProperty),Cr(Ke.paint,Qe.paint,re,Oe,null,wn.setPaintProperty),t.bv(Ke.slot,Qe.slot)||re.push({command:wn.setSlot,args:[Oe,Qe.slot]}),t.bv(Ke.filter,Qe.filter)||re.push({command:wn.setFilter,args:[Oe,Qe.filter]}),t.bv(Ke.minzoom,Qe.minzoom)&&t.bv(Ke.maxzoom,Qe.maxzoom)||re.push({command:wn.setLayerZoomRange,args:[Oe,Qe.minzoom,Qe.maxzoom]}),Ke)Ke.hasOwnProperty(gt)&&gt!=="layout"&&gt!=="paint"&&gt!=="filter"&&gt!=="metadata"&&gt!=="minzoom"&&gt!=="maxzoom"&&gt!=="slot"&&(gt.indexOf("paint.")===0?Cr(Ke[gt],Qe[gt],re,Oe,gt.slice(6),wn.setPaintProperty):t.bv(Ke[gt],Qe[gt])||re.push({command:wn.setLayerProperty,args:[Oe,gt,Qe[gt]]}));for(gt in Qe)Qe.hasOwnProperty(gt)&&!Ke.hasOwnProperty(gt)&&gt!=="layout"&&gt!=="paint"&&gt!=="filter"&&gt!=="metadata"&&gt!=="minzoom"&&gt!=="maxzoom"&&gt!=="slot"&&(gt.indexOf("paint.")===0?Cr(Ke[gt],Qe[gt],re,Oe,gt.slice(6),wn.setPaintProperty):t.bv(Ke[gt],Qe[gt])||re.push({command:wn.setLayerProperty,args:[Oe,gt,Qe[gt]]}))}else re.push({command:wn.removeLayer,args:[Oe]}),It=Re[Re.lastIndexOf(Oe)+1],re.push({command:wn.addLayer,args:[Qe,It]})}($,C.layers,z)}catch(N){console.warn("Unable to compute style diff:",N),z=[{command:wn.setStyle,args:[C]}]}return z}(this.serialize(),i).filter(S=>!(S.command in Nf));if(f.length===0)return!1;let g=f.filter(S=>!(S.command in Bf));if(g.length>0)throw new Error(`Unimplemented: ${g.map(S=>S.command).join(", ")}.`);let v=[];return f.forEach(S=>{v.push(this[S.command](...S.args))}),a&&Promise.all(v).then(a).catch(a),this.stylesheet=i,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(i){for(let[a,f]of i.entries()){if(this.getImage(a))return this.fire(new t.z(new Error(`An image with the name "${a.name}" already exists.`)));this.imageManager.addImage(a,this.scope,f),this._changes.updateImage(a,this.scope)}return this._updateWorkerImages(),this.fire(new t.A("data",{dataType:"style"})),this}addImage(i,a){return this.getImage(i)?this.fire(new t.z(new Error(`An image with the name "${i.name}" already exists.`))):(this.imageManager.addImage(i,this.scope,a),this._changes.updateImage(i,this.scope),this._updateWorkerImages(),this.fire(new t.A("data",{dataType:"style"})),this)}updateImage(i,a,f=!1){this.imageManager.updateImage(i,this.scope,a),f&&(this._changes.updateImage(i,this.scope),this._updateWorkerImages(),this.fire(new t.A("data",{dataType:"style"})))}getImage(i){return this.imageManager.getImage(i,this.scope)}removeImage(i){return this.getImage(i)?(this.imageManager.removeImage(i,this.scope),this._changes.updateImage(i,this.scope),this._updateWorkerImages(),this.fire(new t.A("data",{dataType:"style"})),this):this.fire(new t.z(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(i){return this.modelManager.addModelURLs(i,this.scope),this._updateWorkerModels(),this.fire(new t.A("data",{dataType:"style"})),this}addModel(i,a,f={}){return this._checkLoaded(),this._validate(je,`models.${i}`,a,null,f)||(this.modelManager.addModel(i,a,this.scope),this.fire(new t.A("data",{dataType:"style"}))),this}hasModel(i){return this.modelManager.hasModel(i,this.scope)}removeModel(i){return this.hasModel(i)?(this.modelManager.removeModel(i,this.scope),this.fire(new t.A("data",{dataType:"style"})),this):this.fire(new t.z(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(i,a,f={}){if(this._checkLoaded(),this.getOwnSource(i)!==void 0)throw new Error(`There is already a source with ID "${i}".`);if(!a.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(a).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(a.type)>=0&&this._validate(li,`sources.${i}`,a,null,f))return;this.map&&this.map._collectResourceTiming&&(a.collectResourceTiming=!0);let g=ou(i,a,this.dispatcher,this);g.scope=this.scope,g.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(g.id),source:g.serialize(),sourceId:g.id}));let v=S=>{let C=(S?"symbol:":"other:")+g.id,z=t.C(C,this.scope),N=this._sourceCaches[C]=new Uo(z,g,S);(S?this._symbolSourceCaches:this._otherSourceCaches)[g.id]=N,N.onAdd(this.map)};v(!1),a.type!=="vector"&&a.type!=="geojson"||v(!0),g.onAdd&&g.onAdd(this.map),f.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(i){this._checkLoaded();let a=this.getOwnSource(i);if(!a)throw new Error("There is no source with this ID");for(let g in this._layers)if(this._layers[g].source===i)return this.fire(new t.z(new Error(`Source "${i}" cannot be removed while layer "${g}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===i)return this.fire(new t.z(new Error(`Source "${i}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){let g=Object.entries(this.stylesheet.iconsets).find(([v,S])=>S.type==="source"&&S.source===i);if(g)return this.fire(new t.z(new Error(`Source "${i}" cannot be removed while iconset "${g[0]}" is using it.`)))}let f=this.getOwnSourceCaches(i);for(let g of f){let v=t.d8(g.id);delete this._sourceCaches[v],this._changes.discardSourceCacheUpdate(g.id),g.fire(new t.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:g.getSource().id})),g.setEventedParent(null),g.clearTiles()}return delete this._otherSourceCaches[i],delete this._symbolSourceCaches[i],this.mergeSources(),a.setEventedParent(null),a.onRemove&&a.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(i,a){this._checkLoaded(),this.getOwnSource(i).setData(a),this._changes.setDirty()}getOwnSource(i){let a=this.getOwnSourceCache(i);return a&&a.getSource()}getOwnSources(){let i=[];for(let a in this._otherSourceCaches){let f=this.getOwnSourceCache(a);f&&i.push(f.getSource())}return i}areTilesLoaded(){let i=this._mergedSourceCaches;for(let a in i){let f=i[a]._tiles;for(let g in f){let v=f[g];if(v.state!=="loaded"&&v.state!=="errored")return!1}}return!0}setLights(i){if(this._checkLoaded(),!i)return delete this.ambientLight,void delete this.directionalLight;let a=this._getTransitionParameters();for(let g of i){if(this._validate(wi,"lights",g))return;switch(g.type){case"ambient":if(this.ambientLight){let v=this.ambientLight;v.set(g),v.updateTransitions(a)}else this.ambientLight=new go(g,yr||(yr=new t.a7({color:new t.a8(t.a5.properties_light_ambient.color),"color-use-theme":new t.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new t.a8(t.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){let v=this.directionalLight;v.set(g),v.updateTransitions(a)}else this.directionalLight=new go(g,Jn||(Jn=new t.a7({direction:new t.an(t.a5.properties_light_directional.direction),color:new t.a8(t.a5.properties_light_directional.color),"color-use-theme":new t.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new t.a8(t.a5.properties_light_directional.intensity),"cast-shadows":new t.a8(t.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new t.a8(t.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new t.a8(t.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}let f=new t.aa(this.z||0,a);this.ambientLight&&this.ambientLight.recalculate(f),this.directionalLight&&this.directionalLight.recalculate(f),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){let i=this.directionalLight,a=this.ambientLight;if(!i||!a)return;let f=Z=>.2126*(Z[0]<=.03928?Z[0]/12.92:Math.pow((Z[0]+.055)/1.055,2.4))+.7152*(Z[1]<=.03928?Z[1]/12.92:Math.pow((Z[1]+.055)/1.055,2.4))+.0722*(Z[2]<=.03928?Z[2]/12.92:Math.pow((Z[2]+.055)/1.055,2.4)),g=i.properties.get("color").toRenderColor(null).toArray01(),v=i.properties.get("intensity"),S=i.properties.get("direction"),C=1-t.cR(S.x,S.y,S.z)[2]/90,z=f(g)*v*C,N=a.properties.get("color").toRenderColor(null).toArray01(),U=a.properties.get("intensity"),$=f(N)*U;return Number(((z+$)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;let i=[];return this.directionalLight&&i.push(this.directionalLight.get()),this.ambientLight&&i.push(this.ambientLight.get()),i}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(i){if(i==null||i===""&&this.isRootStyle())return this;if(t.d9(i)){let a=t.da(i),f=this.fragments.find(({id:v})=>v===a);if(!f)return;let g=t.d8(i);return f.style.getFragmentStyle(g)}{let a=this.fragments.find(({id:f})=>f===i);return a?a.style:void 0}}setFeaturesetSelectors(i){if(!i)return;let a={},f=(g,v="")=>`${g}::${v}`;this._featuresetSelectors={};for(let g in i){let v=this._featuresetSelectors[g]=[];for(let S of i[g].selectors){if(S.featureNamespace){let z=this.getOwnLayer(S.layer);if(!z){t.w(`Layer is undefined for selector: ${S.layer}`);continue}let N=f(z.source,z.sourceLayer);if(N in a&&a[N]!==S.featureNamespace){t.w(`"featureNamespace ${S.featureNamespace} of featureset ${g}'s selector is not associated to the same source, skip this selector`);continue}a[N]=S.featureNamespace}let C;if(S.properties)for(let z in S.properties){let N=t.X(S.properties[z]);N.result==="success"&&(C=C||{},C[z]=N.value)}v.push({layerId:S.layer,namespace:S.featureNamespace,properties:C,uniqueFeatureID:S._uniqueFeatureID})}}}getFeaturesetDescriptors(i){let a=this.getFragmentStyle(i);if(!a||!a.stylesheet.featuresets)return[];let f=[];for(let g in a.stylesheet.featuresets)f.push({featuresetId:g,importId:a.scope?a.scope:void 0});return f}getFeaturesetLayers(i,a){let f=this.getFragmentStyle(a),g=f.stylesheet.featuresets;if(!g||!g[i])return this.fire(new t.z(new Error(`The featureset '${i}' does not exist in the map's style and cannot be queried.`))),[];let v=[];for(let S of g[i].selectors){let C=f.getOwnLayer(S.layer);C&&v.push(C)}return v}getConfigProperty(i,a){let f=this.getFragmentStyle(i);if(!f)return null;let g=t.C(a,f.scope),v=f.options.get(g),S=v?v.value||v.default:null;return S?S.serialize():null}setConfigProperty(i,a,f){let g=this.getFragmentStyle(i);if(!g)return;let v=g.stylesheet.indoor?kp(g.stylesheet.schema):g.stylesheet.schema;if(!v||!v[a])return;let S=t.X(f);if(S.result!=="success")return void Cc(this,S.value);let C=S.value.expression,z=t.C(a,g.scope),N=g.options.get(z);if(!N)return;let U,{minValue:$,maxValue:Z,stepValue:X,type:se,values:re}=v[a],he=t.X(v[a].default);he.result==="success"&&(U=he.value.expression),U?(this.options.set(z,Object.assign({},N,{value:C,default:U,minValue:$,maxValue:Z,stepValue:X,type:se,values:re})),this.updateConfigDependencies(a)):this.fire(new t.z(new Error(`No schema defined for the config option "${a}" in the "${i}" fragment.`)))}getConfig(i){let a=this.getFragmentStyle(i);if(!a)return null;let f=a.stylesheet.schema;if(!f)return null;let g={};for(let v in f){let S=t.C(v,a.scope),C=a.options.get(S),z=C?C.value||C.default:null;g[v]=z?z.serialize():null}return g}setConfig(i,a){let f=this.getFragmentStyle(i);f&&(f.updateConfig(a,f.stylesheet.schema),this.updateConfigDependencies())}getSchema(i){let a=this.getFragmentStyle(i);return a?a.stylesheet.schema:null}setSchema(i,a){let f=this.getFragmentStyle(i);f&&(f.stylesheet.schema=a,f.updateConfig(f._config,a),this.updateConfigDependencies())}updateConfig(i,a){if(this._config=i,i||a)if(a)for(let f in a){let g,v,S=t.X(a[f].default);if(S.result==="success"&&(g=S.value.expression),i&&i[f]!==void 0){let Z=t.X(i[f]);Z.result==="success"&&(v=Z.value.expression)}let{minValue:C,maxValue:z,stepValue:N,type:U,values:$}=a[f];if(g){let Z=t.C(f,this.scope);this.options.set(Z,{default:g,value:v,minValue:C,maxValue:z,stepValue:N,type:U,values:$})}else this.fire(new t.z(new Error(`No schema defined for config option "${f}".`)))}else this.fire(new t.z(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(i){for(let a of this._configDependentLayers){let f=this.getLayer(a);if(f){if(i&&!f.configDependencies.has(i))continue;f.possiblyEvaluateVisibility(),this._updateLayer(f)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(a=>{let f=a._styleColorTheme.colorThemeOverride?a._styleColorTheme.colorThemeOverride:a._styleColorTheme.colorTheme;if(f){let g=a._evaluateColorThemeData(f);(!a._styleColorTheme.lut&&g!==""||a._styleColorTheme.lut&&g!==a._styleColorTheme.lut.data)&&a.setColorTheme(f)}}),this._changes.setDirty()}addLayer(i,a,f={}){this._checkLoaded();let g=i.id;if(this._layers[g])return void this.fire(new t.z(new Error(`Layer with id "${g}" already exists on this map`)));let v;if(i.type==="custom"){if(Cc(this,t.db(i)))return;v=t.dc(i,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof i.source=="object"&&(this.addSource(g,i.source),i=t.d7(i),i=t.l(i,{source:g})),this._validate(te,`layers.${g}`,i,{arrayIndex:-1},f))return;v=t.dc(i,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(v),v.setEventedParent(this,{layer:{id:g}})}v.configDependencies.size!==0&&this._configDependentLayers.add(v.fqid);let S=this._order.length;if(a){let U=this._order.indexOf(a);if(U===-1)return void this.fire(new t.z(new Error(`Layer with id "${a}" does not exist on this map.`)));v.slot===this._layers[a].slot?S=U:t.w(`Layer with id "${a}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(S,0,g),this._layerOrderChanged=!0,this._layers[g]=v;let C=this.getOwnLayerSourceCache(v),z=!!this.directionalLight&&this.directionalLight.shadowsEnabled();C&&v.canCastShadows()&&z&&(C.castsShadows=!0);let N=this._changes.getRemovedLayer(v);if(N&&v.source&&C&&v.type!=="custom"){this._changes.discardLayerRemoval(v);let U=t.C(v.source,v.scope);N.type!==v.type?this._changes.updateSourceCache(U,"clear"):(this._changes.updateSourceCache(U,"reload"),C.pause())}this._updateLayer(v),v.onAdd&&v.onAdd(this.map),v.scope=this.scope,this.mergeLayers()}moveLayer(i,a){this._checkLoaded();let f=this._checkLayer(i);if(!f||i===a)return;let g=this._order.indexOf(i);this._order.splice(g,1);let v=this._order.length;if(a){let S=this._order.indexOf(a);if(S===-1)return void this.fire(new t.z(new Error(`Layer with id "${a}" does not exist on this map.`)));f.slot===this._layers[a].slot?v=S:t.w(`Layer with id "${a}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(v,0,i),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(i){this._checkLoaded();let a=this._checkLayer(i);if(!a)return;a.setEventedParent(null);let f=this._order.indexOf(i);this._order.splice(f,1),delete this._layers[i],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(a.fqid),this._changes.removeLayer(a);let g=this.getOwnLayerSourceCache(a);if(g&&g.castsShadows){let v=!1;for(let S in this._layers)if(this._layers[S].source===a.source&&this._layers[S].canCastShadows()){v=!0;break}g.castsShadows=v}a.onRemove&&a.onRemove(this.map),this.mergeLayers()}getOwnLayer(i){return this._layers[i]}hasLayer(i){return i in this._mergedLayers}hasLayerType(i){for(let a in this._layers)if(this._layers[a].type===i)return!0;return!1}setLayerZoomRange(i,a,f){this._checkLoaded();let g=this._checkLayer(i);g&&(g.minzoom===a&&g.maxzoom===f||(a!=null&&(g.minzoom=a),f!=null&&(g.maxzoom=f),this._updateLayer(g)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(i,a){this._checkLoaded();let f=this._checkLayer(i);f&&f.slot!==a&&(f.slot=a,this._updateLayer(f))}setFilter(i,a,f={}){this._checkLoaded();let g=this._checkLayer(i);if(g&&!t.bv(g.filter,a))return a==null?(g.filter=void 0,void this._updateLayer(g)):void(this._validate(fe,`layers.${g.id}.filter`,a,{layerType:g.type},f)||(g.filter=t.d7(a),this._updateLayer(g)))}getFilter(i){let a=this._checkLayer(i);if(a)return t.d7(a.filter)}setLayoutProperty(i,a,f,g={}){this._checkLoaded();let v=this._checkLayer(i);if(v&&!t.bv(v.getLayoutProperty(a),f)){if(f!=null&&(!g||g.validate!==!1)&&Cc(v,qe.call(di,{key:`layers.${i}.layout.${a}`,layerType:v.type,objectKey:a,value:f,styleSpec:t.a5,style:{glyphs:!0,sprite:!0}})))return;v.setLayoutProperty(a,f),v.configDependencies.size!==0&&this._configDependentLayers.add(v.fqid),this._updateLayer(v)}}getLayoutProperty(i,a){let f=this._checkLayer(i);if(f)return f.getLayoutProperty(a)}setPaintProperty(i,a,f,g={}){this._checkLoaded();let v=this._checkLayer(i);if(!v||t.bv(v.getPaintProperty(a),f)||f!=null&&(!g||g.validate!==!1)&&Cc(v,Ae.call(di,{key:`layers.${i}.paint.${a}`,layerType:v.type,objectKey:a,value:f,styleSpec:t.a5})))return;let S=v.setPaintProperty(a,f);v.configDependencies.size!==0&&this._configDependentLayers.add(v.fqid),S&&this._updateLayer(v),this._changes.updatePaintProperties(v)}getPaintProperty(i,a){let f=this._checkLayer(i);if(f)return f.getPaintProperty(a)}setFeatureState(i,a){if(this._checkLoaded(),"target"in i){if("featuresetId"in i.target){let{featuresetId:z,importId:N}=i.target,U=this.getFragmentStyle(N),$=U.getFeaturesetLayers(z);for(let{source:Z,sourceLayer:X}of $)U.setFeatureState({id:i.id,source:Z,sourceLayer:X},a)}else if("layerId"in i.target){let{layerId:z}=i.target,N=this.getLayer(z);this.setFeatureState({id:i.id,source:N.source,sourceLayer:N.sourceLayer},a)}return}let f=i.source,g=i.sourceLayer,v=this._checkSource(f);if(!v)return;let S=v.type;if(S==="geojson"&&g)return void this.fire(new t.z(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(S==="vector"&&!g)return void this.fire(new t.z(new Error("The sourceLayer parameter must be provided for vector source types.")));i.id===void 0&&this.fire(new t.z(new Error("The feature id parameter must be provided.")));let C=this.getOwnSourceCaches(f);for(let z of C)z.setFeatureState(g,i.id,a)}removeFeatureState(i,a){if(this._checkLoaded(),"target"in i){if("featuresetId"in i.target){let{featuresetId:z,importId:N}=i.target,U=this.getFragmentStyle(N),$=U.getFeaturesetLayers(z);for(let{source:Z,sourceLayer:X}of $)U.removeFeatureState({id:i.id,source:Z,sourceLayer:X},a)}else if("layerId"in i.target){let{layerId:z}=i.target,N=this.getLayer(z);this.removeFeatureState({id:i.id,source:N.source,sourceLayer:N.sourceLayer},a)}return}let f=i.source,g=this._checkSource(f);if(!g)return;let v=g.type,S=v==="vector"?i.sourceLayer:void 0;if(v==="vector"&&!S)return void this.fire(new t.z(new Error("The sourceLayer parameter must be provided for vector source types.")));if(a&&typeof i.id!="string"&&typeof i.id!="number")return void this.fire(new t.z(new Error("A feature id is required to remove its specific state property.")));let C=this.getOwnSourceCaches(f);for(let z of C)z.removeFeatureState(S,i.id,a)}getFeatureState(i){if(this._checkLoaded(),"target"in i){let v;if("featuresetId"in i.target){let{featuresetId:S,importId:C}=i.target,z=this.getFragmentStyle(C),N=z.getFeaturesetLayers(S);for(let{source:U,sourceLayer:$}of N){let Z=z.getFeatureState({id:i.id,source:U,sourceLayer:$});if(Z&&!v)v=Z;else if(!t.bv(v,Z))return void this.fire(new t.z(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in i.target){let{layerId:S}=i.target,C=this.getLayer(S);v=this.getFeatureState({id:i.id,source:C.source,sourceLayer:C.sourceLayer})}return v}let a=i.source,f=i.sourceLayer,g=this._checkSource(a);if(g){if(g.type!=="vector"||f)return i.id===void 0&&this.fire(new t.z(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(a)[0].getFeatureState(f,i.id);this.fire(new t.z(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(i){return this.stylesheet.transition=t.l({},this.stylesheet.transition,i),this.transition=this.stylesheet.transition,this}getTransition(){return t.l({},this.stylesheet.transition)}serialize(){this._checkLoaded();let i=this.getTerrain(),a=i&&this.terrain&&this.terrain.scope===this.scope?i:this.stylesheet.terrain;return t.dd({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:a,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},f=>f!==void 0)}_updateFilteredLayers(i){for(let a of Object.values(this._mergedLayers))i(a)&&this._updateLayer(a)}_updateLayer(i){this._changes.updateLayer(i);let a=this.getLayerSourceCache(i),f=t.C(i.source,i.scope),g=this._changes.getUpdatedSourceCaches();i.source&&!g[f]&&a&&a.getSource().type!=="raster"&&(this._changes.updateSourceCache(f,"reload"),a.pause()),i.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(i){let a=C=>this._mergedLayers[C].is3D(!!this.terrain),f=this.order,g={},v=[];for(let C=f.length-1;C>=0;C--){let z=f[C];if(a(z)){g[z]=C;for(let N of i){let U=N[z];if(U)for(let $ of U)v.push($)}}}v.sort((C,z)=>z.intersectionZ-C.intersectionZ);let S=[];for(let C=f.length-1;C>=0;C--){let z=f[C];if(a(z))for(let N=v.length-1;N>=0;N--){let U=v[N].feature;if(U.layer&&g[U.layer.id]<C)break;S.push(U),v.pop()}else for(let N of i){let U=N[z];if(U)for(let $ of U)S.push($.feature)}}return S}queryRenderedFeatures(i,a,f){let g;a&&!Array.isArray(a)&&a.filter&&(this._validate(fe,"queryRenderedFeatures.filter",a.filter,null,a),g=t.b3(a.filter));let v={},S=U=>{if(nh.has(U.type))return;let $=this.getOwnLayerSourceCache(U),Z=v[$.id]=v[$.id]||{sourceCache:$,layers:{},has3DLayers:!1};U.is3D(!!this.terrain)&&(Z.has3DLayers=!0),Z.layers[U.fqid]=Z.layers[U.fqid]||{styleLayer:U,targets:[]},Z.layers[U.fqid].targets.push({filter:g})};if(a&&a.layers){if(!Array.isArray(a.layers))return this.fire(new t.z(new Error("parameters.layers must be an Array."))),[];for(let U of a.layers){let $=this._layers[U];if(!$)return this.fire(new t.z(new Error(`The layer '${U}' does not exist in the map's style and cannot be queried for features.`))),[];S($)}}else for(let U in this._layers)S(this._layers[U]);let C=this._queryRenderedFeatures(i,v,f),z=this._flattenAndSortRenderedFeatures(C),N=[];for(let U of z)t.de(U.layer.id)===this.scope&&N.push(U);return N}queryRenderedFeatureset(i,a,f){let g;a&&!Array.isArray(a)&&a.filter&&(this._validate(fe,"queryRenderedFeatures.filter",a.filter,null,a),g=t.b3(a.filter));let v="mock",S=[];if(a&&a.target)S.push(Object.assign({},a,{targetId:v,filter:g}));else{let U=this.getFeaturesetDescriptors();for(let $ of U)S.push({targetId:v,filter:g,target:$});for(let{style:$}of this.fragments){let Z=$.getFeaturesetDescriptors();for(let X of Z)S.push({targetId:v,filter:g,target:X})}}let C=this.queryRenderedTargets(i,S,f),z=[],N=new Set;for(let U of C)for(let $ of U.variants[v])zu($,U,N)||z.push(new t.df(U,$));return z}queryRenderedTargets(i,a,f){let g={},v=(C,z,N,U)=>{let $=g[z.id]=g[z.id]||{sourceCache:z,layers:{},has3DLayers:!1};if($.layers[C.fqid]=$.layers[C.fqid]||{styleLayer:C,targets:[]},C.is3D(!!this.terrain)&&($.has3DLayers=!0),!U)return N.uniqueFeatureID=!1,void $.layers[C.fqid].targets.push(N);$.layers[C.fqid].targets.push(Object.assign({},N,{namespace:U.namespace,properties:U.properties,uniqueFeatureID:U.uniqueFeatureID}))};for(let C of a)if("featuresetId"in C.target){let{featuresetId:z,importId:N}=C.target,U=this.getFragmentStyle(N);if(!U||!U._featuresetSelectors)continue;let $=U._featuresetSelectors[z];if(!$){this.fire(new t.z(new Error(`The featureset '${z}' does not exist in the map's style and cannot be queried for features.`)));continue}for(let Z of $){let X=U.getOwnLayer(Z.layerId);X&&!nh.has(X.type)&&v(X,U.getOwnLayerSourceCache(X),C,Z)}}else if("layerId"in C.target){let{layerId:z}=C.target,N=this.getLayer(z);if(!N||nh.has(N.type))continue;v(N,this.getLayerSourceCache(N),C)}let S=this._queryRenderedFeatures(i,g,f);return this._flattenAndSortRenderedFeatures(S)}_queryRenderedFeatures(i,a,f){let g=[],v=!!this.map._showQueryGeometry,S=yo.createFromScreenPoints(i,f);for(let C in a){let z=Mh(S,a[C],this._availableImages,f,v);Object.keys(z).length&&g.push(z)}if(this.placement)for(let C in a){if(!a[C].sourceCache._onlySymbols)continue;let z=Hc(S.screenGeometry,a[C],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData);Object.keys(z).length&&g.push(z)}return g}querySourceFeatures(i,a){let f=a&&a.filter;f&&this._validate(fe,"querySourceFeatures.filter",f,null,a);let g=[],v=this.getOwnSourceCaches(i);for(let S of v)g=g.concat(af(S,a));return g}addSourceType(i,a,f){return Fl.getSourceType(i)?f(new Error(`A source type called "${i}" already exists.`)):(Fl.setSourceType(i,a),a.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:i,url:a.workerSourceURL},f):f(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(i,a,f={}){this._checkLoaded();let g=this.light.getLight(),v=!1;for(let C in i)if(!t.bv(i[C],g[C])){v=!0;break}if(!v)return;let S=this._getTransitionParameters();this.light.setLight(i,a,f),this.light.updateTransitions(S)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=t.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&t.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(i,a=1){if(this._checkLoaded(),!i)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),a===0&&delete this.terrain,i===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let f=i,g=i.source==null;if(a===1){if(this.disableElevatedTerrain)return;if(typeof f.source=="object"){let C="terrain-dem-src";this.addSource(C,f.source),f=t.d7(f),f=t.l(f,{source:C})}let v=t.l({},f),S={};if(this.terrain&&g){v.source=this.terrain.get().source;let C=this.terrain?this.getFragmentStyle(this.terrain.scope):null;C&&(S.style=C.serialize())}if(this._validate(Ue,"terrain",v,S))return}if(!this.terrain||this.terrain.scope!==this.scope&&!g||this.terrain&&a!==this.terrain.drapeRenderMode){if(!f)return;this._createTerrain(f,a),this.fire(new t.A("data",{dataType:"style"}))}else{let v=this.terrain,S=v.get();for(let C of Object.keys(t.a5.terrain))!f.hasOwnProperty(C)&&t.a5.terrain[C].default&&(f[C]=t.a5.terrain[C].default);for(let C in i)if(!t.bv(i[C],S[C])){v.set(i,this.options),this.stylesheet.terrain=i;let z=this._getTransitionParameters({duration:0});v.updateTransitions(z),this.fire(new t.A("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(i){let a=this.fog=new An(i,this.map.transform,this.scope,this.options);this.stylesheet.fog=a.get();let f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}_createSnow(i){let a=this.snow=new Un(i,this.map.transform,this.scope,this.options);this.stylesheet.snow=a.get();let f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}_createRain(i){let a=this.rain=new Ar(i,this.map.transform,this.scope,this.options);this.stylesheet.rain=a.get();let f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(let i of this.map._markers)i._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(i){if(this._checkLoaded(),!i)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){let a=this.fog;if(!t.bv(a.get(),i)){a.set(i,this.options),this.stylesheet.fog=a.get();let f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}}else this._createFog(i);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(i){if(this._checkLoaded(),!i)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){let a=this.snow;if(!t.bv(a.get(),i)){a.set(i,this.options),this.stylesheet.snow=a.get();let f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}}else this._createSnow(i);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(i){if(this._checkLoaded(),!i)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){let a=this.rain;if(!t.bv(a.get(),i)){a.set(i,this.options),this.stylesheet.rain=a.get();let f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}}else this._createRain(i);this._markersNeedUpdate=!0}_reloadColorTheme(){let i=()=>{for(let g in this._layers)this._layers[g].lut=this._styleColorTheme.lut;for(let g in this._sourceCaches)this._sourceCaches[g].clearTiles()},a=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!a)return this._styleColorTheme.lut=null,void i();let f=this._evaluateColorThemeData(a);this._loadColorTheme(f).then(()=>{this.fire(new t.A("colorthemeset")),i()}).catch(g=>{t.w(`Couldn't set color theme: ${g}`)})}setColorTheme(i){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&t.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=i,this._reloadColorTheme()}setImportColorTheme(i,a){let f=this.getFragmentStyle(i);f&&(f._styleColorTheme.colorThemeOverride=a,f._reloadColorTheme())}_getTransitionParameters(i){return{now:t.q.now(),transition:t.l(this.transition,i)}}updateDrapeFirstLayers(){if(!this.terrain)return;let i=[],a=[];for(let f of this._mergedOrder)this.isLayerDraped(this._mergedLayers[f])?i.push(f):a.push(f);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...i),this._drapedFirstOrder.push(...a)}_createTerrain(i,a){let f=this.terrain=new Ot(i,a,this.scope,this.options);a===1&&(this.stylesheet.terrain=i),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();let g=this._getTransitionParameters({duration:0});f.updateTransitions(g)}_force3DLayerUpdate(){for(let i in this._layers){let a=this._layers[i];a.type==="fill-extrusion"&&this._updateLayer(a)}}_forceSymbolLayerUpdate(){for(let i in this._layers){let a=this._layers[i];a.type==="symbol"&&this._updateLayer(a)}}_validate(i,a,f,g,v={}){if(v&&v.validate===!1)return!1;let S=t.l({},this.serialize());return Cc(this,i.call(di,t.l({key:a,style:S,value:f,styleSpec:t.a5},g)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),t.dg.off("pluginStateChange",this._rtlTextPluginCallback);for(let i in this._mergedLayers)this._mergedLayers[i].setEventedParent(null);for(let i in this._mergedSourceCaches)this._mergedSourceCaches[i].clearTiles(),this._mergedSourceCaches[i].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(i){let a=this.getSourceCaches(i);for(let f of a)f.clearTiles()}clearSources(){for(let i in this._mergedSourceCaches)this._mergedSourceCaches[i].clearTiles()}reloadSource(i){let a=this.getSourceCaches(i);for(let f of a)f.resume(),f.reload()}reloadSources(){for(let i of this.getSources())i.reload&&i.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(i=>{i.modelManager.reloadModels(i.scope)})}updateSources(i){let a;this.directionalLight&&(a=Lp(this.directionalLight));let f=new Set;for(let g in this._mergedLayers){let v=this._mergedLayers[g];v.hasElevation()&&!f.has(v.source)&&f.add(v.source)}for(let g in this._mergedSourceCaches){let v=this._mergedSourceCaches[g],S=f.has(v._source.id);v.update(i,void 0,void 0,a,S)}}_generateCollisionBoxes(){for(let i in this._sourceCaches){let a=this._sourceCaches[i];a.resume(),a.reload()}}_updatePlacement(i,a,f,g,v,S,C=!1){let z=!1,N=!1,U={},$={};for(let Z of this._mergedOrder){let X=this._mergedLayers[Z];if(X.type!=="symbol")continue;let se=t.C(X.source,X.scope),re=U[se];if(!re){let ae=this.getLayerSourceCache(X);if(!ae)continue;let be=ae.getRenderableIds(!0).map(Pe=>ae.getTileByID(Pe));$[se]=be.slice(),re=U[se]=be.sort((Pe,Re)=>Re.tileID.overscaledZ-Pe.tileID.overscaledZ||(Pe.tileID.isLessThan(Re.tileID)?-1:1))}let he=this.crossTileSymbolIndex.addLayer(X,re,a.center.lng,a.projection);z=z||he}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),C=C||this._layerOrderChanged||g===0,this._layerOrderChanged&&this.fire(new t.A("neworder")),(C||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(t.q.now(),a.zoom))&&(this.pauseablePlacement=new Ks(a,this._mergedOrder,C,f,g,v,this.placement,this.fog&&a.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,U,$,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(t.q.now()),N=!0),z&&this.pauseablePlacement.placement.setStale()),N||z){this._buildingIndex.onNewFrame(a.zoom);for(let Z=0;Z<this._mergedOrder.length;Z++){let X=this._mergedLayers[this._mergedOrder[Z]];if(X.type!=="symbol")continue;let se=this.isLayerClipped(X);this.placement.updateLayerOpacities(X,U[t.C(X.source,X.scope)],Z,se?S:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(t.q.now())}}_releaseSymbolFadeTiles(){for(let i in this._sourceCaches)this._sourceCaches[i].releaseSymbolFadeTiles()}addImport(i,a){this._checkLoaded();let f=this.stylesheet.imports=this.stylesheet.imports||[];if(f.findIndex(({id:v})=>v===i.id)!==-1)return void this.fire(new t.z(new Error(`Import with id '${i.id}' already exists in the map's style.`)));if(!a)return f.push(i),this._loadImports([i],!0);let g=f.findIndex(({id:v})=>v===a);return g===-1&&this.fire(new t.z(new Error(`Import with id "${a}" does not exist on this map.`))),this.stylesheet.imports=f.slice(0,g).concat(i).concat(f.slice(g)),this._loadImports([i],!0,a)}updateImport(i,a){this._checkLoaded();let f=this.stylesheet.imports||[],g=this.getImportIndex(i);return g===-1?this:typeof a=="string"?(this.setImportUrl(i,a),this):(a.url&&a.url!==f[g].url&&this.setImportUrl(i,a.url),t.bv(a.config,f[g].config)||this.setImportConfig(i,a.config,a.data.schema),t.bv(a.data,f[g].data)||this.setImportData(i,a.data),this)}moveImport(i,a){this._checkLoaded();let f=this.stylesheet.imports||[],g=this.getImportIndex(i);if(g===-1)return this;let v=this.getImportIndex(a);if(v===-1)return this;let S=f[g],C=this.fragments[g];return f=f.filter(({id:z})=>z!==i),this.fragments=this.fragments.filter(({id:z})=>z!==i),this.stylesheet.imports=f.slice(0,v).concat(S).concat(f.slice(v)),this.fragments=this.fragments.slice(0,v).concat(C).concat(this.fragments.slice(v)),this.mergeLayers(),this}setImportUrl(i,a){this._checkLoaded();let f=this.stylesheet.imports||[],g=this.getImportIndex(i);if(g===-1)return this;f[g].url=a;let v=this.fragments[g];return v.style=this._createFragmentStyle(f[g]),v.style.on("style.import.load",()=>this.mergeAll()),v.style.loadURL(a),this}setImportData(i,a){this._checkLoaded();let f=this.getImportIndex(i),g=this.stylesheet.imports||[];return f===-1?this:a?(this.fragments[f].style.setState(a),this._reloadImports(),this):(delete g[f].data,this.setImportUrl(i,g[f].url))}setImportConfig(i,a,f){this._checkLoaded();let g=this.getImportIndex(i),v=this.stylesheet.imports||[];if(g===-1)return this;a?v[g].config=a:delete v[g].config;let S=this.fragments[g];f&&S.style.stylesheet&&(S.style.stylesheet.schema=f);let C=S.style.stylesheet&&S.style.stylesheet.schema;return S.config=a,S.style.updateConfig(a,C),this.updateConfigDependencies(),this}removeImport(i){this._checkLoaded();let a=this.stylesheet.imports||[],f=this.getImportIndex(i);f!==-1&&(a.splice(f,1),this.fragments[f].style._remove(),this.fragments.splice(f,1),this._reloadImports())}getImportIndex(i){let a=(this.stylesheet.imports||[]).findIndex(f=>f.id===i);return a===-1&&this.fire(new t.z(new Error(`Import '${i}' does not exist in the map's style and cannot be updated.`))),a}getLayer(i){return this._mergedLayers[i]}getSources(){let i=[];for(let a in this._mergedOtherSourceCaches){let f=this._mergedOtherSourceCaches[a];f&&i.push(f.getSource())}return i}getSource(i,a){let f=this.getSourceCache(i,a);return f&&f.getSource()}getLayerSource(i){let a=this.getLayerSourceCache(i);return a&&a.getSource()}getSourceCache(i,a){let f=t.C(i,a);return this._mergedOtherSourceCaches[f]}getLayerSourceCache(i){let a=t.C(i.source,i.scope);return i.type==="symbol"?this._mergedSymbolSourceCaches[a]:this._mergedOtherSourceCaches[a]}getSourceCaches(i){if(i==null)return Object.values(this._mergedSourceCaches);let a=[];return this._mergedOtherSourceCaches[i]&&a.push(this._mergedOtherSourceCaches[i]),this._mergedSymbolSourceCaches[i]&&a.push(this._mergedSymbolSourceCaches[i]),a}updateSourceCaches(){let i=this._changes.getUpdatedSourceCaches();for(let a in i){let f=i[a];f==="reload"?this.reloadSource(a):f==="clear"&&this.clearSource(a)}}updateLayers(i){let a=this._changes.getUpdatedPaintProperties();for(let f of a){let g=this.getLayer(f);g&&g.updateTransitions(i)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(i){this.stylesheet.glyphs=i,this.glyphManager.setURL(i,this.scope)}getImages(i,a,f){this.imageManager.getImages(a.images,a.scope,f),this._updateTilesForChangedImages();let g=S=>{if(S){let C=a.images.map(z=>t.I.toString(z));S.setDependencies(a.tileID.key,a.type,C)}},v=t.C(a.source,a.scope);g(this._mergedOtherSourceCaches[v]),g(this._mergedSymbolSourceCaches[v])}rasterizeImages(i,a,f){this.imageManager.rasterizeImages(a,f)}getGlyphs(i,a,f){this.glyphManager.getGlyphs(a.stacks,a.scope,f)}getResource(i,a,f){return t.dh(a,f)}getOwnSourceCache(i){return this._otherSourceCaches[i]}getOwnLayerSourceCache(i){return i.type==="symbol"?this._symbolSourceCaches[i.source]:this._otherSourceCaches[i.source]}getOwnSourceCaches(i){let a=[];return this._otherSourceCaches[i]&&a.push(this._otherSourceCaches[i]),this._symbolSourceCaches[i]&&a.push(this._symbolSourceCaches[i]),a}_isSourceCacheLoaded(i){let a=this.getOwnSourceCaches(i);return a.length===0?(this.fire(new t.z(new Error(`There is no source with ID '${i}'`))),!1):a.every(f=>f.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(i,a){if(!this._clipLayerPresent&&i.type!=="fill-extrusion")return!1;let f=i.type==="fill-extrusion"&&i.sourceLayer==="building";if(i.is3D(!!this.terrain)){if(f||a&&a.type==="batched-model"||i.type==="model")return!0}else if(i.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(i=>{i.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Fl.getSourceType=function(p){return Ru[p]},Fl.setSourceType=function(p,i){Ru[p]=i},Fl.registerForPluginStateChange=t.c$;var uu=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,rh=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,Uu=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,du="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Ka=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,Ec=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,xi=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,kh=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Ya=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,Dd=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,Bp=`#ifdef RENDER_SHADOWS
#ifdef DEPTH_TEXTURE
uniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;
#else
uniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;
#endif
uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_1,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_0,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;
#ifdef TEXTURE_GATHER
highp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));
#else
highp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(
shadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)
);
#endif
vec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return clamp(mix(lerpx.x,lerpx.y,f.y),0.0,1.0);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {
#ifdef SHADOWS_SINGLE_CASCADE
light_view_pos0.xyz/=light_view_pos0.w;vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);
#else
light_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;let oh=[];pu(uu,oh),pu(Uu,oh),pu(rh,oh);let sa={"_prelude_fog.vertex.glsl":Ec,"_prelude_terrain.vertex.glsl":Ka,"_prelude_shadow.vertex.glsl":Dd,"_prelude_fog.fragment.glsl":xi,"_prelude_shadow.fragment.glsl":Bp,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":kh,"_prelude_raster_particle.glsl":Ya},sh={};Wn("",Ka),Wn(xi,Ec),Wn(Bp,Dd),Wn(kh,""),Wn(Ya,"");let oc=Wn(rh,Uu),ah=uu;var Bl={background:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in highp vec3 v_normal;in highp float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
uniform lowp float u_opacity;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 apply_lighting_linear(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec4 color=vec4(v_color.rgb,1.0);vec3 normal=normalize(v_normal);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
shadowed_lighting_factor=dot(normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=mix(color.rgb,v_color.rgb,v_color.a);color*=u_opacity;
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_height));
#endif
#ifdef RENDER_CUTOFF
color*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_height);
#endif
glFragColor=vec4(linearTosRGB(color.rgb),color.a);
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3f;out vec4 v_color;out highp vec3 v_normal;out highp float v_height;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));vec3 pos=a_pos_3f;v_height=pos.z;gl_Position=u_matrix*vec4(pos,1.0);
#ifdef RENDER_SHADOWS
vec3 shadow_pos=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),buildingDepth:Wn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:Wn("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Wn(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:Wn(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Wn("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:Wn("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:Wn("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:Wn(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:Wn(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
void main() {vec3 color=vec3(241.0/255.0,236.0/255.0,225.0/255.0);
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,normal);
#endif
if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(v_normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:Wn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:Wn(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:Wn(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:Wn(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:Wn("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:Wn("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:Wn(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:Wn(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(abs(v_z_offset) > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef Z_OFFSET
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
#endif
}`),terrainRaster:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:Wn("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:Wn(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,du),skyboxGradient:Wn(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,du),skyboxCapture:Wn(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:Wn(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:Wn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:Wn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:Wn(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:Wn("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:Wn("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:Wn("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:Wn("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function pu(p,i){let a=p.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let f of a)if(f=f.trim(),f[0]==="#"&&f.includes("if")&&!f.includes("endif")){f=f.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();let g=f.split(" ");for(let v of g)i.includes(v)||i.push(v)}}function Wn(p,i){let a=/#include\s+"([^"]+)"/g,f=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,g=i.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);g&&(g=g.map(N=>{let U=N.split(" ");return U[U.length-1]}),g=[...new Set(g)]);let v={},S=[],C=[];if(p=p.replace(a,(N,U)=>(C.push(U),"")),(i=i.replace(a,(N,U)=>(S.push(U),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let z=[...oh];pu(p,z),pu(i,z);for(let N of[...S,...C])sa[N]||console.error(`Undefined include: ${N}`),sh[N]||(sh[N]=[],pu(sa[N],sh[N])),z=[...z,...sh[N]];return{fragmentSource:p=p.replace(f,(N,U,$,Z,X)=>(v[X]=!0,U==="define"?`
#ifndef HAS_UNIFORM_u_${X}
in ${$} ${Z} ${X};
#else
uniform ${$} ${Z} u_${X};
#endif
`:U==="initialize"?`
#ifdef HAS_UNIFORM_u_${X}
    ${$} ${Z} ${X} = u_${X};
#endif
`:U==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${X}
    in ${$} ${Z} ${X};
#endif
`:U==="initialize-attribute"?"":void 0)),vertexSource:i=i.replace(f,(N,U,$,Z,X)=>{let se=Z==="float"?"vec2":Z,re=X.match(/color/)?"color":se;return U==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${X}
in ${$} ${Z} a_${X};
#endif
`:v[X]?U==="define"?`
#ifndef HAS_UNIFORM_u_${X}
uniform lowp float u_${X}_t;
in ${$} ${se} a_${X};
out ${$} ${Z} ${X};
#else
uniform ${$} ${Z} u_${X};
#endif
`:U==="initialize"?re==="vec4"?`
#ifndef HAS_UNIFORM_u_${X}
    ${X} = a_${X};
#else
    ${$} ${Z} ${X} = u_${X};
#endif
`:`
#ifndef HAS_UNIFORM_u_${X}
    ${X} = unpack_mix_${re}(a_${X}, u_${X}_t);
#else
    ${$} ${Z} ${X} = u_${X};
#endif
`:U==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${X}
    in ${$} ${Z} a_${X};
    out ${$} ${Z} ${X};
#endif
`:U==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${X}
    ${X} = a_${X};
#endif
`:void 0:U==="define"?`
#ifndef HAS_UNIFORM_u_${X}
uniform lowp float u_${X}_t;
in ${$} ${se} a_${X};
#else
uniform ${$} ${Z} u_${X};
#endif
`:U==="define-instanced"?re==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${X}0;
in vec4 a_${X}1;
in vec4 a_${X}2;
in vec4 a_${X}3;
#else
uniform ${$} ${Z} u_${X};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${$} ${se} a_${X};
#else
uniform ${$} ${Z} u_${X};
#endif
`:U==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${X}
    ${$} ${Z} ${X} = a_${X};
#endif
`:re==="vec4"?`
#ifndef HAS_UNIFORM_u_${X}
    ${$} ${Z} ${X} = a_${X};
#else
    ${$} ${Z} ${X} = u_${X};
#endif
`:`
#ifndef HAS_UNIFORM_u_${X}
    ${$} ${Z} ${X} = unpack_mix_${re}(a_${X}, u_${X}_t);
#else
    ${$} ${Z} ${X} = u_${X};
#endif
`}),staticAttributes:g,usedDefines:z,vertexIncludes:S,fragmentIncludes:C}}class Oh{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(i,a,f,g,v,S,C,z){this.context=i;let N=this.boundPaintVertexBuffers.length!==g.length;for(let $=0;!N&&$<g.length;$++)this.boundPaintVertexBuffers[$]!==g[$]&&(N=!0);let U=this.boundDynamicVertexBuffers.length!==C.length;for(let $=0;!U&&$<C.length;$++)this.boundDynamicVertexBuffers[$]!==C[$]&&(U=!0);if(!this.vao||this.boundProgram!==a||this.boundLayoutVertexBuffer!==f||N||U||this.boundIndexBuffer!==v||this.boundVertexOffset!==S)this.freshBind(a,f,g,v,S,C,z);else{i.bindVertexArrayOES.set(this.vao);for(let $ of C)$&&($.bind(),z&&$.instanceCount&&$.setVertexAttribDivisor(i.gl,a,z));v&&v.dynamicDraw&&v.bind()}}freshBind(i,a,f,g,v,S,C){let z=i.numAttributes,N=this.context,U=N.gl;this.vao&&this.destroy(),this.vao=N.gl.createVertexArray(),N.bindVertexArrayOES.set(this.vao),this.boundProgram=i,this.boundLayoutVertexBuffer=a,this.boundPaintVertexBuffers=f,this.boundIndexBuffer=g,this.boundVertexOffset=v,this.boundDynamicVertexBuffers=S,a.enableAttributes(U,i),a.bind(),a.setVertexAttribPointers(U,i,v);for(let $ of f)$.enableAttributes(U,i),$.bind(),$.setVertexAttribPointers(U,i,v);for(let $ of S)$&&($.enableAttributes(U,i),$.bind(),$.setVertexAttribPointers(U,i,v),C&&$.instanceCount&&$.setVertexAttribDivisor(U,i,C));g&&g.bind(),N.currentNumAttributes=z}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function hf(p,i){let a=Math.pow(2,i.canonical.z),f=i.canonical.y;return[new t.ac(0,f/a).toLngLat().lat,new t.ac(0,(f+1)/a).toLngLat().lat]}function Np(p,i,a,f,g,v,S){let C=p.context,z=C.gl,N=a.hillshadeFBO;if(!N)return;p.prepareDrawTile();let U=p.isTileAffectedByFog(i),$=p.getOrCreateProgram("hillshade",{overrideFog:U});C.activeTexture.set(z.TEXTURE0),z.bindTexture(z.TEXTURE_2D,N.colorAttachment.get());let Z=((he,ae,be,Pe)=>{let Re=be.paint.get("hillshade-shadow-color"),Ge=be.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",Ne=be.paint.get("hillshade-highlight-color"),Ve=be.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",Oe=be.paint.get("hillshade-accent-color"),Ke=be.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",Qe=be.paint.get("hillshade-emissive-strength"),It=t.al(be.paint.get("hillshade-illumination-direction"));if(be.paint.get("hillshade-illumination-anchor")==="viewport")It-=he.transform.angle;else if(he.style&&he.style.enable3dLights()&&he.style.directionalLight){let jt=he.style.directionalLight.properties.get("direction"),Ut=t.cR(jt.x,jt.y,jt.z);It=t.al(Ut[1])}let gt=!he.options.moving;return{u_matrix:Pe||he.transform.calculateProjMatrix(ae.tileID.toUnwrapped(),gt),u_image:0,u_latrange:hf(0,ae.tileID),u_light:[be.paint.get("hillshade-exaggeration"),It],u_shadow:Re.toRenderColor(Ge?null:be.lut),u_highlight:Ne.toRenderColor(Ve?null:be.lut),u_emissive_strength:Qe,u_accent:Oe.toRenderColor(Ke?null:be.lut)}})(p,a,f,p.terrain?i.projMatrix:null);p.uploadCommonUniforms(C,$,i.toUnwrapped());let{tileBoundsBuffer:X,tileBoundsIndexBuffer:se,tileBoundsSegments:re}=p.getTileBoundsBuffers(a);$.draw(p,z.TRIANGLES,g,v,S,ln.disabled,Z,f.id,X,se,re)}function Dr(p,i,a){if(!i.needsDEMTextureUpload)return;let f=p.context,g=f.gl;f.pixelStoreUnpackPremultiplyAlpha.set(!1),i.demTexture=i.demTexture||p.getTileTexture(a.stride);let v=a.getPixels();i.demTexture?i.demTexture.update(v,{premultiply:!1}):i.demTexture=new t.T(f,v,g.R32F,{premultiply:!1}),i.needsDEMTextureUpload=!1}function lh(p,i,a){let f=p.context,g=f.gl;if(!i.dem)return;let v=i.dem;if(f.activeTexture.set(g.TEXTURE1),Dr(p,i,v),!i.demTexture)return;i.demTexture.bind(g.NEAREST,g.CLAMP_TO_EDGE);let S=v.dim;f.activeTexture.set(g.TEXTURE0);let C=i.hillshadeFBO;if(!C){let Z=new t.T(f,{width:S,height:S,data:null},g.RGBA8);Z.bind(g.LINEAR,g.CLAMP_TO_EDGE),C=i.hillshadeFBO=f.createFramebuffer(S,S,!0,"renderbuffer"),C.colorAttachment.set(Z.texture)}f.bindFramebuffer.set(C.framebuffer),f.viewport.set([0,0,S,S]);let{tileBoundsBuffer:z,tileBoundsIndexBuffer:N,tileBoundsSegments:U}=p.getMercatorTileBoundsBuffers(),$=[];p.linearFloatFilteringSupported()&&$.push("TERRAIN_DEM_FLOAT_FORMAT"),p.getOrCreateProgram("hillshadePrepare",{defines:$}).draw(p,g.TRIANGLES,Li.disabled,hn.disabled,Tn.unblended,ln.disabled,((Z,X)=>{let se=X.stride,re=t.bz();return t.c5(re,0,t.aj,-t.aj,0,0,1),t.bo(re,re,[0,-t.aj,0]),{u_matrix:re,u_image:1,u_dimension:[se,se],u_zoom:Z.overscaledZ}})(i.tileID,v),a.id,z,N,U),i.needsHillshadePrepare=!1}class uo{constructor(i){this.gl=i.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(i){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Vf extends uo{getDefault(){return t.am.transparent}set(i){let a=this.current;(i.r!==a.r||i.g!==a.g||i.b!==a.b||i.a!==a.a||this.dirty)&&(this.gl.clearColor(i.r,i.g,i.b,i.a),this.current=i,this.dirty=!1)}}class Rd extends uo{getDefault(){return 1}set(i){(i!==this.current||this.dirty)&&(this.gl.clearDepth(i),this.current=i,this.dirty=!1)}}class Em extends uo{getDefault(){return 0}set(i){(i!==this.current||this.dirty)&&(this.gl.clearStencil(i),this.current=i,this.dirty=!1)}}class Uf extends uo{getDefault(){return[!0,!0,!0,!0]}set(i){let a=this.current;(i[0]!==a[0]||i[1]!==a[1]||i[2]!==a[2]||i[3]!==a[3]||this.dirty)&&(this.gl.colorMask(i[0],i[1],i[2],i[3]),this.current=i,this.dirty=!1)}}class jf extends uo{getDefault(){return!0}set(i){(i!==this.current||this.dirty)&&(this.gl.depthMask(i),this.current=i,this.dirty=!1)}}class zd extends uo{getDefault(){return 255}set(i){(i!==this.current||this.dirty)&&(this.gl.stencilMask(i),this.current=i,this.dirty=!1)}}class Vp extends uo{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(i){let a=this.current;(i.func!==a.func||i.ref!==a.ref||i.mask!==a.mask||this.dirty)&&(this.gl.stencilFunc(i.func,i.ref,i.mask),this.current=i,this.dirty=!1)}}class Ld extends uo{getDefault(){let i=this.gl;return[i.KEEP,i.KEEP,i.KEEP]}set(i){let a=this.current;(i[0]!==a[0]||i[1]!==a[1]||i[2]!==a[2]||this.dirty)&&(this.gl.stencilOp(i[0],i[1],i[2]),this.current=i,this.dirty=!1)}}class ju extends uo{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;let a=this.gl;i?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),this.current=i,this.dirty=!1}}class Fh extends uo{getDefault(){return[0,1]}set(i){let a=this.current;(i[0]!==a[0]||i[1]!==a[1]||this.dirty)&&(this.gl.depthRange(i[0],i[1]),this.current=i,this.dirty=!1)}}class Gu extends uo{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;let a=this.gl;i?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),this.current=i,this.dirty=!1}}class ch extends uo{getDefault(){return this.gl.LESS}set(i){(i!==this.current||this.dirty)&&(this.gl.depthFunc(i),this.current=i,this.dirty=!1)}}class fu extends uo{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;let a=this.gl;i?a.enable(a.BLEND):a.disable(a.BLEND),this.current=i,this.dirty=!1}}class mu extends uo{getDefault(){let i=this.gl;return[i.ONE,i.ZERO,i.ONE,i.ZERO]}set(i){let a=this.current;(i[0]!==a[0]||i[1]!==a[1]||i[2]!==a[2]||i[3]!==a[3]||this.dirty)&&(this.gl.blendFuncSeparate(i[0],i[1],i[2],i[3]),this.current=i,this.dirty=!1)}}class sc extends uo{getDefault(){return t.am.transparent}set(i){let a=this.current;(i.r!==a.r||i.g!==a.g||i.b!==a.b||i.a!==a.a||this.dirty)&&(this.gl.blendColor(i.r,i.g,i.b,i.a),this.current=i,this.dirty=!1)}}class hh extends uo{getDefault(){return this.gl.FUNC_ADD}set(i){(i!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(i,i),this.current=i,this.dirty=!1)}}class Zu extends uo{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;let a=this.gl;i?a.enable(a.CULL_FACE):a.disable(a.CULL_FACE),this.current=i,this.dirty=!1}}class ac extends uo{getDefault(){return this.gl.BACK}set(i){(i!==this.current||this.dirty)&&(this.gl.cullFace(i),this.current=i,this.dirty=!1)}}class qu extends uo{getDefault(){return this.gl.CCW}set(i){(i!==this.current||this.dirty)&&(this.gl.frontFace(i),this.current=i,this.dirty=!1)}}let kd=class extends uo{getDefault(){return null}set(p){(p!==this.current||this.dirty)&&(this.gl.useProgram(p),this.current=p,this.dirty=!1)}};class $u extends uo{getDefault(){return this.gl.TEXTURE0}set(i){(i!==this.current||this.dirty)&&(this.gl.activeTexture(i),this.current=i,this.dirty=!1)}}class Up extends uo{getDefault(){let i=this.gl;return[0,0,i.drawingBufferWidth,i.drawingBufferHeight]}set(i){let a=this.current;(i[0]!==a[0]||i[1]!==a[1]||i[2]!==a[2]||i[3]!==a[3]||this.dirty)&&(this.gl.viewport(i[0],i[1],i[2],i[3]),this.current=i,this.dirty=!1)}}class jp extends uo{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;let a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,i),this.current=i,this.dirty=!1}}class Od extends uo{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;let a=this.gl;a.bindRenderbuffer(a.RENDERBUFFER,i),this.current=i,this.dirty=!1}}class uh extends uo{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;let a=this.gl;a.bindTexture(a.TEXTURE_2D,i),this.current=i,this.dirty=!1}}class Fd extends uo{getDefault(){return null}set(i){if(i===this.current&&!this.dirty)return;let a=this.gl;a.bindBuffer(a.ARRAY_BUFFER,i),this.current=i,this.dirty=!1}}class Bd extends uo{getDefault(){return null}set(i){let a=this.gl;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,i),this.current=i,this.dirty=!1}}class uf extends uo{getDefault(){return null}set(i){this.gl&&(i!==this.current||this.dirty)&&(this.gl.bindVertexArray(i),this.current=i,this.dirty=!1)}}class Ro extends uo{getDefault(){return 4}set(i){if(i===this.current&&!this.dirty)return;let a=this.gl;a.pixelStorei(a.UNPACK_ALIGNMENT,i),this.current=i,this.dirty=!1}}class dh extends uo{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;let a=this.gl;a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i),this.current=i,this.dirty=!1}}class Nl extends uo{getDefault(){return!1}set(i){if(i===this.current&&!this.dirty)return;let a=this.gl;a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,i),this.current=i,this.dirty=!1}}class Wu extends uo{constructor(i,a){super(i),this.context=i,this.parent=a}getDefault(){return null}}class Nd extends Wu{setDirty(){this.dirty=!0}set(i){if(i===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let a=this.gl;a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,i,0),this.current=i,this.dirty=!1}}class ph extends Wu{attachment(){return this.gl.DEPTH_ATTACHMENT}set(i){if(i===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let a=this.gl;a.framebufferRenderbuffer(a.FRAMEBUFFER,this.attachment(),a.RENDERBUFFER,i),this.current=i,this.dirty=!1}}class Bh extends Wu{attachment(){return this.gl.DEPTH_ATTACHMENT}set(i){if(i===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let a=this.gl;a.framebufferTexture2D(a.FRAMEBUFFER,this.attachment(),a.TEXTURE_2D,i,0),this.current=i,this.dirty=!1}}class Vd extends ph{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}let _u=(p,i,a)=>({u_matrix:p,u_image0:0,u_skirt_height:i,u_ground_shadow_factor:a}),Ud=(p,i,a,f,g,v,S,C,z,N,U,$,Z,X,se,re)=>({u_proj_matrix:Float32Array.from(p),u_globe_matrix:i,u_normalize_matrix:Float32Array.from(f),u_merc_matrix:a,u_zoom_transition:g,u_merc_center:v,u_image0:0,u_frustum_tl:S,u_frustum_tr:C,u_frustum_br:z,u_frustum_bl:N,u_globe_pos:U,u_globe_radius:$,u_viewport:Z,u_grid_matrix:re?Float32Array.from(re):new Float32Array(9),u_skirt_height:X,u_far_z_cutoff:se});function Gp(p,i){return p!=null&&i!=null&&!(!p.hasData()||!i.hasData())&&p.demTexture!=null&&i.demTexture!=null&&p.tileID.key!==i.tileID.key}let gu=new class{constructor(){this.operations={}}newMorphing(p,i,a,f,g){if(p in this.operations){let v=this.operations[p];v.to.tileID.key!==a.tileID.key&&(v.queued=a)}else this.operations[p]={startTime:f,phase:0,duration:g,from:i,to:a,queued:null}}getMorphValuesForProxy(p){if(!(p in this.operations))return null;let i=this.operations[p];return{from:i.from,to:i.to,phase:i.phase}}update(p){for(let i in this.operations){let a=this.operations[i];for(a.phase=(p-a.startTime)/a.duration;a.phase>=1||!this._validOp(a);)if(!this._nextOp(a,p)){delete this.operations[i];break}}}_nextOp(p,i){return!!p.queued&&(p.from=p.to,p.to=p.queued,p.queued=null,p.phase=0,p.startTime=i,!0)}_validOp(p){return p.from.hasData()&&p.to.hasData()}},lc={0:null,1:"TERRAIN_VERTEX_MORPHING"};function cc(p,i,a){if(i===0)return 0;let f=i<1&&a===514?.25/i:1;return 6*Math.pow(1.5,22-p)*Math.max(i,1)*f}function Ja(p,i){let a=1<<p.z;return!i&&(p.x===0||p.x===a-1)||p.y===0||p.y===a-1}let es=p=>({u_matrix:p});function yu(p,i,a,f,g){if(g>0){let v=t.q.now(),S=(v-p.timeAdded)/g,C=i?(v-i.timeAdded)/g:-1,z=a.getSource(),N=f.coveringZoomLevel({tileSize:z.tileSize,roundZoom:z.roundZoom}),U=!i||Math.abs(i.tileID.overscaledZ-N)>Math.abs(p.tileID.overscaledZ-N),$=U&&p.refreshedUponExpiration?1:t.aD(U?S:1-C,0,1);return p.refreshedUponExpiration&&S>=1&&(p.refreshedUponExpiration=!1),i?{opacity:1,mix:1-$}:{opacity:$,mix:0}}return{opacity:1,mix:0}}class jd extends Uo{constructor(i){let a={type:"raster-dem",maxzoom:i.transform.maxZoom},f=new t.D(t.d0(),null),g=ou("mock-dem",a,f,i.style);super("mock-dem",g,!1),g.setEventedParent(this),this._sourceLoaded=!0}_loadTile(i,a){i.state="loaded",a(null)}}class Gd extends Uo{constructor(i){let a=ou("proxy",{type:"geojson",maxzoom:i.transform.maxZoom},new t.D(t.d0(),null),i.style);super("proxy",a,!1),a.setEventedParent(this),this.map=this.getSource().map=i,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(i,a,f){if(i.freezeTileCoverage)return;this.transform=i;let g=i.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((v,S)=>{if(v[S.key]="",!this._tiles[S.key]){let C=new Ta(S,this._source.tileSize*S.overscaleFactor(),i.tileZoom);C.state="loaded",this._tiles[S.key]=C}return v},{});for(let v in this._tiles)v in g||(this.freeFBO(v),this._tiles[v].unloadVectorData(),delete this._tiles[v])}freeFBO(i){let a=this.proxyCachedFBO[i];if(a!==void 0){let f=Object.values(a);this.renderCachePool.push(...f),delete this.proxyCachedFBO[i]}}deallocRenderCache(){this.renderCache.forEach(i=>i.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class fh extends t.aM{constructor(i,a,f){super(i.overscaledZ,i.wrap,i.canonical.z,i.canonical.x,i.canonical.y),this.proxyTileKey=a,this.projMatrix=f}}class Hu extends t.dt{constructor(i,a){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},i.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),i.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),i.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=i,this.terrainTileForTile={},this.prevTerrainTileForTile={};let[f,g,v]=function(z){let N=new t.ba,U=new t.a_,$=131;N.reserve(17161),U.reserve(33800);let Z=t.aj/128,X=t.aj+Z/2,se=X+Z;for(let he=-Z;he<se;he+=Z)for(let ae=-Z;ae<se;ae+=Z){let be=ae<0||ae>X||he<0||he>X?24575:0,Pe=t.aD(Math.round(ae),0,t.aj),Re=t.aD(Math.round(he),0,t.aj);N.emplaceBack(Pe+be,Re)}let re=(he,ae)=>{let be=ae*$+he;U.emplaceBack(be+1,be,be+$),U.emplaceBack(be+$,be+$+1,be+1)};for(let he=1;he<129;he++)for(let ae=1;ae<129;ae++)re(ae,he);return[0,129].forEach(he=>{for(let ae=0;ae<130;ae++)re(ae,he),re(he,ae)}),[N,U,32768]}(),S=i.context;this.gridBuffer=S.createVertexBuffer(f,t.bc.members),this.gridIndexBuffer=S.createIndexBuffer(g),this.gridSegments=t.bd.simpleSegment(0,0,f.length,g.length),this.gridNoSkirtSegments=t.bd.simpleSegment(0,0,f.length,v),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Gd(a.map),this.orthoMatrix=t.bz(),t.c5(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,t.aj,0,t.aj,0,1);let C=S.gl;this._overlapStencilMode=new hn({func:C.GEQUAL,mask:255},0,255,C.KEEP,C.KEEP,C.REPLACE),this._previousZoom=i.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=a,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new jd(a.map),this._pendingGroundEffectLayers=[]}set style(i){i.on("data",this._onStyleDataEvent.bind(this)),this._style=i,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(i,a,f){if(i&&i.terrain){this._style!==i&&(this.style=i,this._evaluationZoom=void 0);let g=i.terrain.properties,v=i.terrain.drapeRenderMode===0,S=i.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=t.q.now();let C=i.terrain&&i.terrain.scope,z=g.get("source"),N=v?this._mockSourceCache:i.getSourceCache(z,C);if(!N)return void t.w(`Couldn't find terrain source "${z}".`);if(this.sourceCache=N,this._attenuationRange=i.terrain.getAttenuationRange(),this._exaggeration=S?this.calculateExaggeration(a):g.get("exaggeration"),!a.projection.requiresDraping&&S&&this._exaggeration===0)return void this._disable();this.enabled=!0;let U=()=>{this.sourceCache.used&&t.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);let $=this.getScaledDemTileSize();this.sourceCache.update(a,$,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,U(),this._initializing=!0),U(),a.updateElevation(!0,f),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(a),this._emptyDEMTextureDirty=!0,this._previousZoom=a.zoom}else this._disable()}calculateExaggeration(i){if(this._attenuationRange&&i.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(i.zoom);let a=this._previousCameraAltitude,f=i.getFreeCameraOptions().position.z/i.pixelsPerMeter*i.worldSize;this._previousCameraAltitude=f;let g=a!=null?f-a:Number.MAX_VALUE;if(Math.abs(g)<2)return this._exaggeration;let v=i.zoom,S=this._style.terrain;if(!this._previousUpdateTimestamp)return S.getExaggeration(v);let C=v-this._previousZoom,z=this._previousUpdateTimestamp,N=v;this._evaluationZoom!=null&&(N=this._evaluationZoom,Math.abs(v-N)>.5&&(C=.5*(v-N+C)),C*g<0&&(N+=C)),this._evaluationZoom=N;let U=S.getExaggeration(N),$=U===S.getExaggeration(Math.max(0,N-.1));if($&&Math.abs(U-this._exaggeration)<.01)return U;let Z=Math.min(.1,.00375*(this._updateTimestamp-z));return($||U<.1||Math.abs(C)<1e-4)&&(Z=Math.min(.2,4*Z)),t.ai(this._exaggeration,U,Z)}resetTileLookupCache(i){this._findCoveringTileCache[i]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(i){i.coord&&i.dataType==="source"?this._clearRenderCacheForTile(i.sourceCacheId,i.coord):i.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(let i in this._style._mergedSourceCaches)this._style._mergedSourceCaches[i].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(i=>i.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){let i=2*this.proxySourceCache.getSource().tileSize;return[i,i]}set useVertexMorphing(i){this._useVertexMorphing=i}updateTileBinding(i){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;let a=this.proxySourceCache,f=this.painter.transform;this._initializing&&(this._initializing=f._centerAltitude===0&&this.getAtPointOrZero(t.ac.fromLngLat(f.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);let g=this.proxyCoords=a.getIds().map(z=>{let N=a.getTileByID(z).tileID;return N.projMatrix=f.calculateProjMatrix(N.toUnwrapped()),N});(function(z,N){let U=N.transform.pointCoordinate(N.transform.getCameraPoint()),$=new t.P(U.x,U.y);z.sort((Z,X)=>{if(X.overscaledZ-Z.overscaledZ)return X.overscaledZ-Z.overscaledZ;let se=new t.P(Z.canonical.x+(1<<Z.canonical.z)*Z.wrap,Z.canonical.y),re=new t.P(X.canonical.x+(1<<X.canonical.z)*X.wrap,X.canonical.y),he=$.mult(1<<Z.canonical.z);return he.x-=.5,he.y-=.5,he.distSqr(se)-he.distSqr(re)})})(g,this.painter);let v=this.proxyToSource||{};this.proxyToSource={},g.forEach(z=>{this.proxyToSource[z.key]={}}),this.terrainTileForTile={};let S=this._style._mergedSourceCaches;for(let z in S){let N=S[z];if(!N.used||(N!==this.sourceCache&&this.resetTileLookupCache(N.id),this._setupProxiedCoordsForOrtho(N,i[z],v),N.usedForTerrain))continue;let U=i[z];N.getSource().reparseOverscaled&&this._assignTerrainTiles(U)}this.proxiedCoords[a.id]=g.map(z=>new fh(z,z.key,this.orthoMatrix)),this._assignTerrainTiles(g),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(v),this.renderingToTexture=!1;let C={};this._visibleDemTiles=[];for(let z of this.proxyCoords){let N=this.terrainTileForTile[z.key];if(!N)continue;let U=N.tileID.key;U in C||(this._visibleDemTiles.push(N),C[U]=U)}}_assignTerrainTiles(i){this._initializing||i.forEach(a=>{if(this.terrainTileForTile[a.key])return;let f=this._findTileCoveringTileID(a,this.sourceCache);f&&(this.terrainTileForTile[a.key]=f)})}_prepareDEMTextures(){let i=this.painter.context,a=i.gl;for(let f in this.terrainTileForTile){let g=this.terrainTileForTile[f],v=g.dem;!v||g.demTexture&&!g.needsDEMTextureUpload||(i.activeTexture.set(a.TEXTURE1),Dr(this.painter,g,v))}}_prepareDemTileUniforms(i,a,f,g){if(!a||a.demTexture==null)return!1;let v=i.tileID.canonical,S=Math.pow(2,a.tileID.canonical.z-v.z),C=g||"";return f[`u_dem_tl${C}`]=[v.x*S%1,v.y*S%1],f[`u_dem_scale${C}`]=S,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let i=0,a=this._visibleDemTiles.reduce((f,g)=>{if(!g.dem)return f;let v=g.dem.tree.minimums[0];return v>0&&i++,f+v},0);return i?a/i:0}_updateEmptyDEMTexture(){let i=this.painter.context,a=i.gl;i.activeTexture.set(a.TEXTURE2);let f=this._getLoadedAreaMinimum(),g=new t.du({width:1,height:1},new Float32Array([f]));this._emptyDEMTextureDirty=!1;let v=this._emptyDEMTexture;return v?v.update(g,{premultiply:!1}):v=this._emptyDEMTexture=new t.T(i,g,a.R32F,{premultiply:!1}),v}setupElevationDraw(i,a,f){let g=this.painter.context,v=g.gl,S={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};S.u_exaggeration=this.exaggeration();let C=null,z=null,N=1;if(f&&f.morphing&&this._useVertexMorphing){let X=f.morphing.srcDemTile,se=f.morphing.dstDemTile;N=f.morphing.phase,X&&se&&(this._prepareDemTileUniforms(i,X,S,"_prev")&&(z=X),this._prepareDemTileUniforms(i,se,S)&&(C=se))}let U=X=>X&&X.demTexture&&this.painter.linearFloatFilteringSupported()?v.LINEAR:v.NEAREST,$=null;var Z;if(this.enabled?z&&C?($=C.demTexture,g.activeTexture.set(v.TEXTURE4),z.demTexture.bind(U(z),v.CLAMP_TO_EDGE),S.u_dem_lerp=N):(C=this.terrainTileForTile[i.tileID.key],$=this._prepareDemTileUniforms(i,C,S)?C.demTexture:this.emptyDEMTexture):$=this.emptyDEMTexture,g.activeTexture.set(v.TEXTURE2),$&&(S.u_dem_size=(Z=$).size[0]===1?1:Z.size[0]-2,$.bind(U(C),v.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(f&&f.useDepthForOcclusion,a,S),f&&f.useMeterToDem&&C){let X=(1<<C.tileID.canonical.z)*t.c6(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;S.u_meter_to_dem=X}if(f&&f.labelPlaneMatrixInv&&(S.u_label_plane_matrix_inv=f.labelPlaneMatrixInv),a.setTerrainUniformValues(g,S),this.painter.transform.projection.name==="globe"){let X=this.globeUniformValues(this.painter.transform,i.tileID.canonical,f&&f.useDenormalizedUpVectorScale);a.setGlobeUniformValues(g,X)}}globeUniformValues(i,a,f){let g=i.projection;return{u_tile_tl_up:g.upVector(a,0,0),u_tile_tr_up:g.upVector(a,t.aj,0),u_tile_br_up:g.upVector(a,t.aj,t.aj),u_tile_bl_up:g.upVector(a,0,t.aj),u_tile_up_scale:f?t.dv(1):g.upVectorScale(a,i.center.lat,i.worldSize).metersToTile}}renderToBackBuffer(i){let a=this.painter,f=this.painter.context;i.length!==0&&(f.bindFramebuffer.set(null),f.viewport.set([0,0,a.width,a.height]),a.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(g,v,S,C,z){if(g.transform.projection.name==="globe")(function(N,U,$,Z,X){let se=N.context,re=se.gl,he,ae,be=N.transform,Pe=t.dl(N,se,be),Re=(jt,Ut)=>{if(ae===Ut)return;let fi=[lc[Ut],"PROJECTION_GLOBE_VIEW"];Pe&&fi.push("CUSTOM_ANTIALIASING");let vt=N.isTileAffectedByFog(jt);he=N.getOrCreateProgram("globeRaster",{defines:fi,overrideFog:vt}),ae=Ut},Ge=N.colorModeForRenderPass(),Ne=new Li(re.LEQUAL,Li.ReadWrite,N.depthRangeFor3D);gu.update(X);let Ve=t.dm(be),Oe=[t.ay(be.center.lng),t.aH(be.center.lat)],Ke=N.globeSharedBuffers,Qe=[be.width*t.q.devicePixelRatio,be.height*t.q.devicePixelRatio],It=Float32Array.from(be.globeMatrix),gt={useDenormalizedUpVectorScale:!0};{let jt=N.transform,Ut=cc(jt.zoom,U.exaggeration(),U.sourceCache._source.tileSize);ae=-1;let fi=re.TRIANGLES;for(let vt of Z){let Ct=$.getTile(vt),_t=hn.disabled,qt=U.prevTerrainTileForTile[vt.key],Pt=U.terrainTileForTile[vt.key];Gp(qt,Pt)&&gu.newMorphing(vt.key,qt,Pt,X,250),se.activeTexture.set(re.TEXTURE0),Ct.texture&&Ct.texture.bind(re.LINEAR,re.CLAMP_TO_EDGE);let ti=gu.getMorphValuesForProxy(vt.key),Gt=ti?1:0;ti&&t.L(gt,{morphing:{srcDemTile:ti.from,dstDemTile:ti.to,phase:t.dk(ti.phase)}});let ii=t.dn(vt.canonical),oi=t.dp(ii.getCenter().lat),ki=t.dq(vt.canonical,ii,oi,jt.worldSize/jt._pixelsPerMercatorPixel),ji=t.bh(t.dr(vt.canonical)),zi=Ud(jt.expandedFarZProjMatrix,It,Ve,ji,t.ah(jt.zoom),Oe,jt.frustumCorners.TL,jt.frustumCorners.TR,jt.frustumCorners.BR,jt.frustumCorners.BL,jt.globeCenterInViewSpace,jt.globeRadius,Qe,Ut,jt._farZ,ki);if(Re(vt,Gt),he&&(U.setupElevationDraw(Ct,he,gt),N.uploadCommonUniforms(se,he,vt.toUnwrapped()),Ke)){let[$i,Oi,nn]=Ke.getGridBuffers(oi,Ut!==0);he.draw(N,fi,Ne,_t,Ge,ln.backCCW,zi,"globe_raster",$i,Oi,nn)}}}if(Ke&&(N.renderDefaultNorthPole||N.renderDefaultSouthPole)){let jt=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];Pe&&jt.push("CUSTOM_ANTIALIASING"),he=N.getOrCreateProgram("globeRaster",{defines:jt});for(let Ut of Z){let{x:fi,y:vt,z:Ct}=Ut.canonical,_t=vt===0,qt=vt===(1<<Ct)-1,[Pt,ti,Gt,ii]=Ke.getPoleBuffers(Ct,!1);if(ii&&(_t||qt)){let oi=$.getTile(Ut);se.activeTexture.set(re.TEXTURE0),oi.texture&&oi.texture.bind(re.LINEAR,re.CLAMP_TO_EDGE);let ki=t.ds(Ct,fi,be),ji=t.bh(t.dr(Ut.canonical)),zi=($i,Oi)=>$i.draw(N,re.TRIANGLES,Ne,hn.disabled,Ge,ln.disabled,Ud(be.expandedFarZProjMatrix,ki,ki,ji,0,Oe,be.frustumCorners.TL,be.frustumCorners.TR,be.frustumCorners.BR,be.frustumCorners.BL,be.globeCenterInViewSpace,be.globeRadius,Qe,0,be._farZ),"globe_pole_raster",Oi,Gt,ii);U.setupElevationDraw(oi,he,gt),N.uploadCommonUniforms(se,he,Ut.toUnwrapped()),_t&&N.renderDefaultNorthPole&&zi(he,Pt),qt&&N.renderDefaultSouthPole&&(ki=t.cE(t.bz(),ki,[1,-1,1]),zi(he,ti))}}}})(g,v,S,C,z);else{let N=g.context,U=N.gl,$,Z,X=g.shadowRenderer,se=hu(g,g.longestCutoffRange),re=Ge=>{if(Z===Ge)return;let Ne=[];Ne.push(lc[Ge]),se.shouldRenderCutoff&&Ne.push("RENDER_CUTOFF"),X&&(Ne.push("RENDER_SHADOWS","DEPTH_TEXTURE"),X.useNormalOffset&&Ne.push("NORMAL_OFFSET")),$=g.getOrCreateProgram("terrainRaster",{defines:Ne}),Z=Ge},he=g.colorModeForRenderPass(),ae=new Li(U.LEQUAL,Li.ReadWrite,g.depthRangeFor3D);gu.update(z);let be=g.transform,Pe=cc(be.zoom,v.exaggeration(),v.sourceCache._source.tileSize),Re=[0,0,0];if(X){let Ge=g.style.directionalLight,Ne=g.style.ambientLight;Ge&&Ne&&(Re=Ol(g.style,Ge,Ne))}{Z=-1;let Ge=U.TRIANGLES,[Ne,Ve]=[v.gridIndexBuffer,v.gridSegments];for(let Oe of C){let Ke=S.getTile(Oe),Qe=hn.disabled,It=v.prevTerrainTileForTile[Oe.key],gt=v.terrainTileForTile[Oe.key];Gp(It,gt)&&gu.newMorphing(Oe.key,It,gt,z,250),N.activeTexture.set(U.TEXTURE0),Ke.texture&&Ke.texture.bind(U.LINEAR,U.CLAMP_TO_EDGE);let jt=gu.getMorphValuesForProxy(Oe.key),Ut=jt?1:0,fi;jt&&(fi={morphing:{srcDemTile:jt.from,dstDemTile:jt.to,phase:t.dk(jt.phase)}});let vt=_u(Oe.projMatrix,Ja(Oe.canonical,be.renderWorldCopies)?Pe/10:Pe,Re);if(re(Ut),!$)continue;v.setupElevationDraw(Ke,$,fi);let Ct=Oe.toUnwrapped();X&&X.setupShadows(Ct,$),g.uploadCommonUniforms(N,$,Ct,null,se),$.draw(g,Ge,ae,Qe,he,ln.backCCW,vt,"terrain_raster",v.gridBuffer,Ne,Ve)}}}}(a,this,this.proxySourceCache,i,this._updateTimestamp),this.renderingToTexture=!0,a.gpuTimingDeferredRenderEnd(),i.splice(0,i.length))}renderBatch(i){if(this._drapedRenderBatches.length===0)return i+1;this.renderingToTexture=!0;let a=this.painter,f=this.painter.context,g=this.proxySourceCache,v=this.proxiedCoords[g.id],S=this._drapedRenderBatches.shift(),C=a.style.order,z=[],N=0;for(let U of v){let $=g.getTileByID(U.proxyTileKey),Z=g.proxyCachedFBO[U.key]?g.proxyCachedFBO[U.key][i]:void 0,X=Z!==void 0?g.renderCache[Z]:this.pool[N++],se=Z!==void 0;if($.texture=X.tex,se&&!X.dirty){z.push($.tileID);continue}let re;f.bindFramebuffer.set(X.fb.framebuffer),this.renderedToTile=!1,X.dirty&&(f.clear({color:t.am.transparent,stencil:0}),X.dirty=!1);for(let he=S.start;he<=S.end;++he){let ae=a.style._mergedLayers[C[he]];if(ae.isHidden(a.transform.zoom))continue;let be=a.style.getLayerSourceCache(ae),Pe=be?this.proxyToSource[U.key][be.id]:[U];if(!Pe)continue;let Re=Pe;f.viewport.set([0,0,X.fb.width,X.fb.height]),re!==(be?be.id:null)&&(this._setupStencil(X,Pe,ae,be),re=be?be.id:null),a.renderLayer(a,be,ae,Re)}if(this._drapedRenderBatches.length===0)for(let he of this._pendingGroundEffectLayers){let ae=a.style._mergedLayers[C[he]];if(ae.isHidden(a.transform.zoom))continue;let be=a.style.getLayerSourceCache(ae),Pe=be?this.proxyToSource[U.key][be.id]:[U];if(!Pe)continue;let Re=Pe;f.viewport.set([0,0,X.fb.width,X.fb.height]),re!==(be?be.id:null)&&(this._setupStencil(X,Pe,ae,be),re=be?be.id:null),a.renderLayer(a,be,ae,Re)}this.renderedToTile?(X.dirty=!0,z.push($.tileID)):se||--N,N===5&&(N=0,this.renderToBackBuffer(z))}return this.renderToBackBuffer(z),this.renderingToTexture=!1,f.bindFramebuffer.set(null),f.viewport.set([0,0,a.width,a.height]),S.end+1}postRender(){}isLayerOrderingCorrect(i){let a=i.order.length,f=-1,g=a;for(let v=0;v<a;++v)this._style.isLayerDraped(i._mergedLayers[i.order[v]])?f=Math.max(f,v):g=Math.min(g,v);return g>f}getMinElevationBelowMSL(){let i=0;return this._visibleDemTiles.filter(a=>a.dem).forEach(a=>{i=Math.min(i,a.dem.tree.minimums[0])}),i===0?i:(i-30)*this._exaggeration}raycast(i,a,f){if(!this._visibleDemTiles)return null;let g=this._visibleDemTiles.filter(v=>v.dem).map(v=>{let S=v.tileID,C=1<<S.overscaledZ,{x:z,y:N}=S.canonical,U=z/C,$=(z+1)/C,Z=N/C,X=(N+1)/C;return{minx:U,miny:Z,maxx:$,maxy:X,t:v.dem.tree.raycastRoot(U,Z,$,X,i,a,f),tile:v}});g.sort((v,S)=>(v.t!==null?v.t:Number.MAX_VALUE)-(S.t!==null?S.t:Number.MAX_VALUE));for(let v of g){if(v.t==null)return null;let S=v.tile.dem.tree.raycast(v.minx,v.miny,v.maxx,v.maxy,i,a,f);if(S!=null)return S}return null}_createFBO(){let i=this.painter.context,a=i.gl,f=this.drapeBufferSize;i.activeTexture.set(a.TEXTURE0);let g=new t.T(i,{width:f[0],height:f[1],data:null},a.RGBA8);g.bind(a.LINEAR,a.CLAMP_TO_EDGE);let v=i.createFramebuffer(f[0],f[1],!0,null);return v.colorAttachment.set(g.texture),v.depthAttachment=new Vd(i,v.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=i.createRenderbuffer(i.gl.DEPTH_STENCIL,f[0],f[1]),this._stencilRef=0,v.depthAttachment.set(this._sharedDepthStencil),i.clear({stencil:0})):v.depthAttachment.set(this._sharedDepthStencil),i.extTextureFilterAnisotropic&&a.texParameterf(a.TEXTURE_2D,i.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,i.extTextureFilterAnisotropicMax),{fb:v,tex:g,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(let i in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[i].hasTransition())return!0;return this._style.order.some(i=>{let a=this._style._mergedLayers[i],f=a.isHidden(this.painter.transform.zoom);return a.type==="hillshade"||a.type==="custom"?!f&&a.shouldRedrape():!f&&a.hasTransition()})}_clearLineLayersFromRenderCache(){let i=!1;for(let f of this._style.getSources())if(f instanceof ls){i=!0;break}if(!i)return;let a={};for(let f=0;f<this._style.order.length;++f){let g=this._style._mergedLayers[this._style.order[f]],v=this._style.getLayerSourceCache(g);if(v&&!a[v.id]&&!g.isHidden(this.painter.transform.zoom)&&g.type==="line"&&g.widthExpression()instanceof t.ab){a[v.id]=!0;for(let S of this.proxyCoords){let C=this.proxyToSource[S.key][v.id];if(C)for(let z of C)this._clearRenderCacheForTile(v.id,z)}}}}_clearRasterLayersFromRenderCache(){let i=!1;for(let f in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[f]._source instanceof wa){i=!0;break}if(!i)return;let a={};for(let f=0;f<this._style.order.length;++f){let g=this._style._mergedLayers[this._style.order[f]],v=this._style.getLayerSourceCache(g);if(!v||a[v.id]||g.isHidden(this.painter.transform.zoom)||g.type!=="raster")continue;let S=g.paint.get("raster-fade-duration");for(let C of this.proxyCoords){let z=this.proxyToSource[C.key][v.id];if(z)for(let N of z){let U=yu(v.getTile(N),v.findLoadedParent(N,0),v,this.painter.transform,S);(U.opacity!==1||U.mix!==0)&&this._clearRenderCacheForTile(v.id,N)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();let i=this._style.order,a=i.length;if(a===0)return;let f=[];this._pendingGroundEffectLayers=[];let g,v=0,S=this._style._mergedLayers[i[v]];for(;!this._style.isLayerDraped(S)&&S.isHidden(this.painter.transform.zoom)&&++v<a;)S=this._style._mergedLayers[i[v]];for(;v<a;++v){let C=this._style._mergedLayers[i[v]];C.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(C)?g===void 0&&(g=v):(C.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(v),g!==void 0&&(f.push({start:g,end:v-1}),g=void 0)))}if(g!==void 0&&f.push({start:g,end:v-1}),f.length!==0){let C=f[f.length-1];this._pendingGroundEffectLayers.every(z=>z>C.end)||t.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=f}_setupRenderCache(i){let a=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,a.renderCache.length>a.renderCachePool.length){let S=Object.values(a.proxyCachedFBO);a.proxyCachedFBO={};for(let C=0;C<S.length;++C){let z=Object.values(S[C]);a.renderCachePool.push(...z)}}return}this._clearRasterLayersFromRenderCache();let f=this.proxyCoords,g=this._tilesDirty;for(let S=f.length-1;S>=0;S--){let C=f[S];if(a.getTileByID(C.key),a.proxyCachedFBO[C.key]!==void 0){let z=i[C.key],N=this.proxyToSource[C.key],U=0;for(let $ in N){let Z=N[$],X=z[$];if(!X||X.length!==Z.length||Z.some((se,re)=>se!==X[re]||g[$]&&g[$].hasOwnProperty(se.key))){U=-1;break}++U}for(let $ in a.proxyCachedFBO[C.key])a.renderCache[a.proxyCachedFBO[C.key][$]].dirty=U<0||U!==Object.values(z).length}}let v=[...this._drapedRenderBatches];v.sort((S,C)=>C.end-C.start-(S.end-S.start));for(let S of v)for(let C of f){if(a.proxyCachedFBO[C.key])continue;let z=a.renderCachePool.pop();z===void 0&&a.renderCache.length<50&&(z=a.renderCache.length,a.renderCache.push(this._createFBO())),z!==void 0&&(a.proxyCachedFBO[C.key]={},a.proxyCachedFBO[C.key][S.start]=z,a.renderCache[z].dirty=!0)}this._tilesDirty={}}_setupStencil(i,a,f,g){if(!g||!this._sourceTilesOverlap[g.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));let v=this.painter.context,S=v.gl;if(a.length<=1)return void(this._overlapStencilType=!1);let C;if(f.isTileClipped())C=a.length,this._overlapStencilMode.test={func:S.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(a[0].overscaledZ>a[a.length-1].overscaledZ))return void(this._overlapStencilType=!1);C=1,this._overlapStencilMode.test={func:S.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+C>255&&(v.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=C,this._overlapStencilMode.ref=this._stencilRef,f.isTileClipped()&&this._renderTileClippingMasks(a,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(i){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[i.key]),this._overlapStencilMode):hn.disabled}_renderTileClippingMasks(i,a){let f=this.painter,g=this.painter.context,v=g.gl;f._tileClippingMaskIDs={},g.setColorMode(Tn.disabled),g.setDepthMode(Li.disabled);let S=f.getOrCreateProgram("clippingMask");for(let C of i){let z=f._tileClippingMaskIDs[C.key]=--a;S.draw(f,v.TRIANGLES,Li.disabled,new hn({func:v.ALWAYS,mask:0},z,255,v.KEEP,v.KEEP,v.REPLACE),Tn.disabled,ln.disabled,es(C.projMatrix),"$clipping",f.tileExtentBuffer,f.quadTriangleIndexBuffer,f.tileExtentSegments)}}pointCoordinate(i){let a=this.painter.transform;if(i.x<0||i.x>a.width||i.y<0||i.y>a.height)return null;let f=[i.x,i.y,1,1];t.aA(f,f,a.pixelMatrixInverse),t.cw(f,f,1/f[3]),f[0]/=a.worldSize,f[1]/=a.worldSize;let g=a._camera.position,v=t.c6(1,a.center.lat),S=[g[0],g[1],g[2]/v,0],C=t.cY([],f.slice(0,3),S);t.au(C,C);let z=this.raycast(S,C,this._exaggeration);return z!==null&&z?(t.bF(S,S,C,z),S[3]=S[2],S[2]*=v,S):null}_setupProxiedCoordsForOrtho(i,a,f){if(i.getSource()instanceof t.aP)return this._setupProxiedCoordsForImageSource(i,a,f);this._findCoveringTileCache[i.id]=this._findCoveringTileCache[i.id]||{};let g=this.proxiedCoords[i.id]=[],v=this.proxyCoords;for(let z=0;z<v.length;z++){let N=v[z],U=this._findTileCoveringTileID(N,i);if(U){let $=this._createProxiedId(N,U,f[N.key]&&f[N.key][i.id]);g.push($),this.proxyToSource[N.key][i.id]=[$]}}let S=!1,C=new Set;for(let z=0;z<a.length;z++){let N=i.getTile(a[z]);if(!N||!N.hasData())continue;let U=this._findTileCoveringTileID(N.tileID,this.proxySourceCache);if(U&&U.tileID.canonical.z!==N.tileID.canonical.z){let $=this.proxyToSource[U.tileID.key][i.id],Z=this._createProxiedId(U.tileID,N,f[U.tileID.key]&&f[U.tileID.key][i.id]);$?$.splice($.length-1,0,Z):this.proxyToSource[U.tileID.key][i.id]=[Z];let X=this.proxyToSource[U.tileID.key][i.id];C.has(X)||C.add(X),g.push(Z),S=!0}}if(this._sourceTilesOverlap[i.id]=S,S&&this._debugParams.sortTilesHiZFirst)for(let z of C)z.sort((N,U)=>U.overscaledZ-N.overscaledZ)}_setupProxiedCoordsForImageSource(i,a,f){if(!i.getSource().loaded())return;let g=this.proxiedCoords[i.id]=[],v=this.proxyCoords,S=i.getSource(),C=S.tileID;if(!C)return;let z=new t.P(C.x,C.y)._div(1<<C.z),N=S.coordinates.map(t.ac.fromLngLat).reduce(($,Z)=>($.min.x=Math.min($.min.x,Z.x-z.x),$.min.y=Math.min($.min.y,Z.y-z.y),$.max.x=Math.max($.max.x,Z.x-z.x),$.max.y=Math.max($.max.y,Z.y-z.y),$),{min:new t.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new t.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),U=($,Z)=>{let X=$.wrap+$.canonical.x/(1<<$.canonical.z),se=$.canonical.y/(1<<$.canonical.z),re=t.aj/(1<<$.canonical.z),he=Z.wrap+Z.canonical.x/(1<<Z.canonical.z),ae=Z.canonical.y/(1<<Z.canonical.z);return X+re<he+N.min.x||X>he+N.max.x||se+re<ae+N.min.y||se>ae+N.max.y};for(let $=0;$<v.length;$++){let Z=v[$];for(let X=0;X<a.length;X++){let se=i.getTile(a[X]);if(!se||!se.hasData()||U(Z,se.tileID))continue;let re=this._createProxiedId(Z,se,f[Z.key]&&f[Z.key][i.id]),he=this.proxyToSource[Z.key][i.id];he?he.push(re):this.proxyToSource[Z.key][i.id]=[re],g.push(re)}}}_createProxiedId(i,a,f){let g=this.orthoMatrix;if(f){let v=f.find(S=>S.key===a.tileID.key);if(v)return v}if(a.tileID.key!==i.key){let v=i.canonical.z-a.tileID.canonical.z,S,C,z;g=t.bz();let N=a.tileID.wrap-i.wrap<<i.overscaledZ;v>0?(S=t.aj>>v,C=S*((a.tileID.canonical.x<<v)-i.canonical.x+N),z=S*((a.tileID.canonical.y<<v)-i.canonical.y)):(S=t.aj<<-v,C=t.aj*(a.tileID.canonical.x-(i.canonical.x+N<<-v)),z=t.aj*(a.tileID.canonical.y-(i.canonical.y<<-v))),t.c5(g,0,S,0,S,0,1),t.bo(g,g,[C,z,0])}return new fh(a.tileID,i.key,g)}_findTileCoveringTileID(i,a){let f=a.getTile(i);if(f&&f.hasData())return f;let g=this._findCoveringTileCache[a.id],v=g[i.key];if(f=v?a.getTileByID(v):null,f&&f.hasData()||v===null)return f;let S=f?f.tileID:i,C=S.overscaledZ,z=a.getSource().minzoom,N=[];if(!v){let $=a.getSource().maxzoom;if(i.canonical.z>=$){let Z=i.canonical.z-$;a.getSource().reparseOverscaled?(C=Math.max(i.canonical.z+2,a.transform.tileZoom),S=new t.aM(C,i.wrap,$,i.canonical.x>>Z,i.canonical.y>>Z)):Z!==0&&(C=$,S=new t.aM(C,i.wrap,$,i.canonical.x>>Z,i.canonical.y>>Z))}S.key!==i.key&&(N.push(S.key),f=a.getTile(S))}let U=$=>{N.forEach(Z=>{g[Z]=$}),N.length=0};for(C-=1;C>=z&&(!f||!f.hasData());C--){f&&U(f.tileID.key);let $=S.calculateScaledKey(C);if(f=a.getTileByID($),f&&f.hasData())break;let Z=g[$];if(Z===null)break;Z===void 0?N.push($):f=a.getTileByID(Z)}return U(f?f.tileID.key:null),f&&f.hasData()?f:null}findDEMTileFor(i){return this.enabled?this._findTileCoveringTileID(i,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(i,a){let f=this._tilesDirty[i];f||(f=this._tilesDirty[i]={}),f[a.key]=!0}}function Xu(p,i,a){let f=function(C,z,N){let U=t.bE(z,C),$=t.bE(N,[.2126,.7152,.0722]),Z=(se,re,he)=>(1-he)*se+he*re,X=Z(1-.3*Math.min($,1),1,Math.min(U+1,1));return Z(.92,1,Math.asin(t.aD(z[2],-1,1))/Math.PI+.5)*X}(p,[0,0,1],i),g=[0,0,0];t.b$(g,a.slice(0,3),f);let v=[0,0,0];t.b$(v,i.slice(0,3),p[2]);let S=[0,0,0];return t.cU(S,g,v),t.cX(S)}let Zd=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],Ku=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class xu{static cacheKey(i,a,f,g){let v=`${a}${g?g.cacheKey:""}`;for(let S of f)i.usedDefines.includes(S)&&(v+=`/${S}`);return v}constructor(i,a,f,g,v,S){let C=i.gl;this.program=C.createProgram(),this.configuration=g,this.name=a,this.fixedDefines=[...S];let z=g?g.getBinderAttributes():[],N=(f.staticAttributes||[]).concat(z),U=g?g.defines():[];U=U.concat(S.map(he=>`#define ${he}`));let $=`#version 300 es
`,Z=$+U.concat("precision mediump float;",ah,oc.fragmentSource).join(`
`);for(let he of f.fragmentIncludes)Z+=`
${sa[he]}`;Z+=`
${f.fragmentSource}`;let X=$+U.concat("precision highp float;",ah,oc.vertexSource).join(`
`);for(let he of f.vertexIncludes)X+=`
${sa[he]}`;this.forceManualRenderingForInstanceIDShaders=i.forceManualRenderingForInstanceIDShaders&&f.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(X+=`
uniform int u_instanceID;
`),X+=`
${f.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(X=X.replaceAll("gl_InstanceID","u_instanceID"));let se=C.createShader(C.FRAGMENT_SHADER);if(C.isContextLost())return void(this.failedToCreate=!0);C.shaderSource(se,Z),C.compileShader(se),C.attachShader(this.program,se);let re=C.createShader(C.VERTEX_SHADER);if(C.isContextLost())this.failedToCreate=!0;else{C.shaderSource(re,X),C.compileShader(re),C.attachShader(this.program,re),this.attributes={},this.numAttributes=N.length;for(let he=0;he<this.numAttributes;he++)if(N[he]){let ae=N[he].startsWith("a_")?N[he]:`a_${N[he]}`;C.bindAttribLocation(this.program,he,ae),this.attributes[ae]=he}C.linkProgram(this.program),C.deleteShader(re),C.deleteShader(se),this.fixedUniforms=v(i),this.binderUniforms=g?g.getUniforms(i):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(he=>({u_instanceID:new t.cc(he)}))(i)),(S.includes("TERRAIN")||a.indexOf("symbol")!==-1||a.indexOf("circle")!==-1)&&(this.terrainUniforms=(he=>({u_dem:new t.cc(he),u_dem_prev:new t.cc(he),u_dem_tl:new t.c9(he),u_dem_scale:new t.cb(he),u_dem_tl_prev:new t.c9(he),u_dem_scale_prev:new t.cb(he),u_dem_size:new t.cb(he),u_dem_lerp:new t.cb(he),u_exaggeration:new t.cb(he),u_depth:new t.cc(he),u_depth_size_inv:new t.c9(he),u_depth_range_unpack:new t.c9(he),u_occluder_half_size:new t.cb(he),u_occlusion_depth_offset:new t.cb(he),u_meter_to_dem:new t.cb(he),u_label_plane_matrix_inv:new t.c8(he)}))(i)),S.includes("GLOBE")&&(this.globeUniforms=(he=>({u_tile_tl_up:new t.ca(he),u_tile_tr_up:new t.ca(he),u_tile_br_up:new t.ca(he),u_tile_bl_up:new t.ca(he),u_tile_up_scale:new t.cb(he)}))(i)),S.includes("FOG")&&(this.fogUniforms=(he=>({u_fog_matrix:new t.c8(he),u_fog_range:new t.c9(he),u_fog_color:new t.cQ(he),u_fog_horizon_blend:new t.cb(he),u_fog_vertical_limit:new t.c9(he),u_fog_temporal_offset:new t.cb(he),u_frustum_tl:new t.ca(he),u_frustum_tr:new t.ca(he),u_frustum_br:new t.ca(he),u_frustum_bl:new t.ca(he),u_globe_pos:new t.ca(he),u_globe_radius:new t.cb(he),u_globe_transition:new t.cb(he),u_is_globe:new t.cc(he),u_viewport:new t.c9(he)}))(i)),S.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(he=>({u_cutoff_params:new t.cQ(he)}))(i)),S.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(he=>({u_lighting_ambient_color:new t.ca(he),u_lighting_directional_dir:new t.ca(he),u_lighting_directional_color:new t.ca(he),u_ground_radiance:new t.ca(he)}))(i)),S.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(he=>({u_light_matrix_0:new t.c8(he),u_light_matrix_1:new t.c8(he),u_fade_range:new t.c9(he),u_shadow_normal_offset:new t.ca(he),u_shadow_intensity:new t.cb(he),u_shadow_texel_size:new t.cb(he),u_shadow_map_resolution:new t.cb(he),u_shadow_direction:new t.ca(he),u_shadow_bias:new t.ca(he),u_shadowmap_0:new t.cc(he),u_shadowmap_1:new t.cc(he)}))(i))}}setTerrainUniformValues(i,a){if(!this.terrainUniforms)return;let f=this.terrainUniforms;if(!this.failedToCreate){i.program.set(this.program);for(let g in a)f[g]&&f[g].set(this.program,g,a[g])}}setGlobeUniformValues(i,a){if(!this.globeUniforms)return;let f=this.globeUniforms;if(!this.failedToCreate){i.program.set(this.program);for(let g in a)f[g]&&f[g].set(this.program,g,a[g])}}setFogUniformValues(i,a){if(!this.fogUniforms)return;let f=this.fogUniforms;if(!this.failedToCreate){i.program.set(this.program);for(let g in a)f[g].set(this.program,g,a[g])}}setCutoffUniformValues(i,a){if(!this.cutoffUniforms)return;let f=this.cutoffUniforms;if(!this.failedToCreate){i.program.set(this.program);for(let g in a)f[g].set(this.program,g,a[g])}}setLightsUniformValues(i,a){if(!this.lightsUniforms)return;let f=this.lightsUniforms;if(!this.failedToCreate){i.program.set(this.program);for(let g in a)f[g].set(this.program,g,a[g])}}setShadowUniformValues(i,a){if(this.failedToCreate||!this.shadowUniforms)return;let f=this.shadowUniforms;i.program.set(this.program);for(let g in a)f[g].set(this.program,g,a[g])}_drawDebugWireframe(i,a,f,g,v,S,C,z,N,U){let $=i.options.wireframe;if($.terrain===!1&&$.layers2D===!1&&$.layers3D===!1)return;let Z=i.context;if(!(!(!$.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!$.layers2D||i._terrain&&i._terrain.renderingToTexture||!Zd.includes(this.name))||!(!$.layers3D||!Ku.includes(this.name))))return;let X=Z.gl,se=i.wireframeDebugCache.getLinesFromTrianglesBuffer(i.frameCounter,v,Z);if(!se)return;let re=[...this.fixedDefines];re.push("DEBUG_WIREFRAME");let he=i.getOrCreateProgram(this.name,{config:this.configuration,defines:re});Z.program.set(he.program);let ae=(Re,Ge,Ne)=>{if(Ge[Re]&&Ne[Re])for(let Ve in Ge[Re])Ne[Re][Ve]&&Ne[Re][Ve].set(Ne.program,Ve,Ge[Re][Ve].current)};N&&N.setUniforms(he.program,Z,he.binderUniforms,C,{zoom:z}),ae("fixedUniforms",this,he),ae("terrainUniforms",this,he),ae("globeUniforms",this,he),ae("fogUniforms",this,he),ae("lightsUniforms",this,he),ae("shadowUniforms",this,he),se.bind(),Z.setColorMode(new Tn([X.ONE,X.ONE_MINUS_SRC_ALPHA,X.ZERO,X.ONE],t.am.transparent,[!0,!0,!0,!1])),Z.setDepthMode(new Li(a.func===X.LESS?X.LEQUAL:a.func,Li.ReadOnly,a.range)),Z.setStencilMode(hn.disabled);let be=3*S.primitiveLength*2,Pe=3*S.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){let Re=U||1;for(let Ge=0;Ge<Re;++Ge)he.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Ge),X.drawElements(X.LINES,be,X.UNSIGNED_SHORT,Pe)}else U&&U>1?X.drawElementsInstanced(X.LINES,be,X.UNSIGNED_SHORT,Pe,U):X.drawElements(X.LINES,be,X.UNSIGNED_SHORT,Pe);v.bind(),Z.program.set(this.program),Z.setDepthMode(a),Z.setStencilMode(f),Z.setColorMode(g)}checkUniforms(i,a,f){if(this.fixedDefines.includes(a)){for(let g of Object.keys(f))if(!f[g].initialized)throw new Error(`Program '${this.name}', from draw '${i}': uniform ${g} not set but required by ${a} being defined`)}}draw(i,a,f,g,v,S,C,z,N,U,$,Z,X,se,re,he){let ae=i.context,be=ae.gl;if(this.failedToCreate)return;ae.program.set(this.program),ae.setDepthMode(f),ae.setStencilMode(g),ae.setColorMode(v),ae.setCullFace(S);for(let Ge of Object.keys(this.fixedUniforms))this.fixedUniforms[Ge].set(this.program,Ge,C[Ge]);se&&se.setUniforms(this.program,ae,this.binderUniforms,Z,{zoom:X});let Pe={[be.POINTS]:1,[be.LINES]:2,[be.TRIANGLES]:3,[be.LINE_STRIP]:1}[a];this.checkUniforms(z,"RENDER_SHADOWS",this.shadowUniforms);let Re=he&&he>0?1:void 0;for(let Ge of $.get()){let Ne=Ge.vaos||(Ge.vaos={});if((Ne[z]||(Ne[z]=new Oh)).bind(ae,this,N,se?se.getPaintVertexBuffers():[],U,Ge.vertexOffset,re||[],Re),this.forceManualRenderingForInstanceIDShaders){let Ve=he||1;for(let Oe=0;Oe<Ve;++Oe)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Oe),U?be.drawElements(a,Ge.primitiveLength*Pe,be.UNSIGNED_SHORT,Ge.primitiveOffset*Pe*2):be.drawArrays(a,Ge.vertexOffset,Ge.vertexLength)}else he&&he>1?be.drawElementsInstanced(a,Ge.primitiveLength*Pe,be.UNSIGNED_SHORT,Ge.primitiveOffset*Pe*2,he):U?be.drawElements(a,Ge.primitiveLength*Pe,be.UNSIGNED_SHORT,Ge.primitiveOffset*Pe*2):be.drawArrays(a,Ge.vertexOffset,Ge.vertexLength);a===be.TRIANGLES&&U&&this._drawDebugWireframe(i,f,g,v,U,Ge,Z,X,se,he)}}}function Mc(p,i,a=0){let f=Math.pow(2,i.tileID.overscaledZ),g=i.tileSize*Math.pow(2,p.transform.tileZoom)/f,v=g*(i.tileID.canonical.x+i.tileID.wrap*f),S=g*i.tileID.canonical.y;return{u_image:0,u_texsize:i.imageAtlasTexture?i.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/t.aw(i,1,p.transform.tileZoom),u_pixel_coord_upper:[v>>16,S>>16],u_pixel_coord_lower:[65535&v,65535&S],u_pattern_transition:a}}let Oa={terrain:0,flat:1},Vl=t.bz(),Nh=(p,i,a,f,g,v,S,C,z,N,U,$,Z,X,se,re,he,ae)=>{let be=i.style.light,Pe=be.properties.get("position"),Re=[Pe.x,Pe.y,Pe.z],Ge=t.dx();be.properties.get("anchor")==="viewport"&&(t.dy(Ge,-i.transform.angle),t.dz(Re,Re,Ge));let Ne=be.properties.get("color"),Ve=i.transform,Oe={u_matrix:p,u_lightpos:Re,u_lightintensity:be.properties.get("intensity"),u_lightcolor:[Ne.r,Ne.g,Ne.b],u_vertical_gradient:+a,u_opacity:f,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Vl,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:Oa[N],u_base_type:Oa[U],u_ao:g,u_edge_radius:v,u_width_scale:S,u_flood_light_color:se,u_vertical_scale:re,u_flood_light_intensity:he,u_ground_shadow_factor:ae};return Ve.projection.name==="globe"&&(Oe.u_tile_id=[C.canonical.x,C.canonical.y,1<<C.canonical.z],Oe.u_zoom_transition=$,Oe.u_inv_rot_matrix=X,Oe.u_merc_center=Z,Oe.u_up_dir=Ve.projection.upVector(new t.cp(0,0,0),Z[0]*t.aj,Z[1]*t.aj),Oe.u_height_lift=z),Oe},Qa=(p,i,a,f,g,v)=>({u_matrix:p,u_edge_radius:i,u_width_scale:a,u_vertical_scale:f,u_height_type:Oa[g],u_base_type:Oa[v]}),Yu=(p,i,a,f,g,v,S,C,z,N,U,$,Z,X,se,re,he,ae)=>{let be=Nh(p,i,a,f,g,v,S,C,N,U,$,Z,X,se,re,he,1,[0,0,0]),Pe={u_height_factor:-Math.pow(2,C.overscaledZ)/z.tileSize/8};return t.l(be,Mc(i,z,ae),Pe)},Gf=(p,i,a)=>({u_matrix:p,u_emissive_strength:i,u_ground_shadow_factor:a}),qd=(p,i,a,f,g,v=0)=>t.l(Gf(p,i,g),Mc(a,f,v)),Mm=(p,i,a,f)=>({u_matrix:p,u_world:a,u_emissive_strength:i,u_ground_shadow_factor:f}),df=(p,i,a,f,g,v,S=0)=>t.l(qd(p,i,a,f,v,S),{u_world:g}),vu=(p,i)=>({u_matrix:p,u_ground_shadow_factor:i}),Pc=(p,i,a,f,g)=>({u_matrix:p,u_camera_pos:[i[0],i[1],i[2]],u_depth_bias:a,u_height_scale:f,u_reset_depth:g}),hc=(p,i,a,f)=>{let g=t.aj/a.tileSize;return{u_matrix:p,u_camera_to_center_distance:i.getCameraToCenterDistance(f),u_extrude_scale:[i.pixelsToGLUnits[0]/g,i.pixelsToGLUnits[1]/g]}},sn=(p,i,a=1)=>({u_matrix:p,u_color:i.toRenderColor(null),u_overlay:0,u_overlay_scale:a}),Zp=t.bz(),Ju=(p,i,a,f,g,v,S)=>{let C=p.transform,z=C.projection.name==="globe",N=z?t.dA(C.zoom,i.canonical)*C._pixelsPerMercatorPixel:t.aw(a,1,v),U={u_matrix:i.projMatrix,u_extrude_scale:N,u_intensity:S,u_inv_rot_matrix:Zp,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(z){U.u_inv_rot_matrix=f,U.u_merc_center=g,U.u_tile_id=[i.canonical.x,i.canonical.y,1<<i.canonical.z],U.u_zoom_transition=t.ah(C.zoom);let $=g[0]*t.aj,Z=g[1]*t.aj;U.u_up_dir=C.projection.upVector(new t.cp(0,0,0),$,Z)}return U};function $d(p,[i,a,f,g],[v,S]){if(v===S)return[0,0,0,0];let C=255*(p-1)/(p*(S-v));return[i*C,a*C,f*C,g*C]}function Vh(p,i,[a,f]){return a===f?0:.5/p+(i-a)*(p-1)/(p*(f-a))}let gl=(p,i,a,f,g,v,S,C,z,N,U,$,Z,X,se,re,he,ae,be,Pe,Re)=>({u_matrix:p,u_normalize_matrix:i,u_globe_matrix:a,u_merc_matrix:f,u_grid_matrix:g,u_tl_parent:v,u_scale_parent:N,u_fade_t:U.mix,u_opacity:U.opacity*$.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:$.paint.get("raster-brightness-min"),u_brightness_high:$.paint.get("raster-brightness-max"),u_saturation_factor:t.dB($.paint.get("raster-saturation")),u_contrast_factor:t.dC($.paint.get("raster-contrast")),u_spin_weights:qp($.paint.get("raster-hue-rotate")),u_perspective_transform:Z,u_raster_elevation:X,u_zoom_transition:S,u_merc_center:C,u_cutoff_params:z,u_colorization_mix:$d(t.dD,re,ae),u_colorization_offset:Vh(t.dD,he,ae),u_color_ramp:se,u_texture_offset:[Pe/(be+2*Pe),be/(be+2*Pe)],u_texture_res:[be+2*Pe,be+2*Pe],u_emissive_strength:Re});function qp(p){p*=Math.PI/180;let i=Math.sin(p),a=Math.cos(p);return[(2*a+1)/3,(-Math.sqrt(3)*i-a+1)/3,(Math.sqrt(3)*i-a+1)/3]}let ar=.05,Wd=(p,i,a,f,g,v,S,C,z,N,U,$)=>({u_matrix:p,u_normalize_matrix:i,u_globe_matrix:a,u_merc_matrix:f,u_grid_matrix:g,u_tl_parent:v,u_scale_parent:N,u_fade_t:U.mix,u_opacity:U.opacity,u_image0:0,u_image1:1,u_raster_elevation:$,u_zoom_transition:S,u_merc_center:C,u_cutoff_params:z}),Hd=(p,i,a,f,g,v,S,C,z,N)=>({u_particle_texture:p,u_particle_texture_side_len:i,u_tile_offset:a,u_velocity:f,u_color_ramp:v,u_velocity_res:g,u_max_speed:S,u_uv_offset:C,u_data_scale:[255*z[0],255*z[1]],u_data_offset:N,u_particle_pos_scale:1.1,u_particle_pos_offset:[ar,ar]}),Xd=(p,i,a,f,g,v,S,C,z,N)=>({u_particle_texture:p,u_particle_texture_side_len:i,u_velocity:a,u_velocity_res:f,u_max_speed:g,u_speed_factor:v,u_reset_rate:S,u_rand_seed:Math.random(),u_uv_offset:C,u_data_scale:[255*z[0],255*z[1]],u_data_offset:N,u_particle_pos_scale:1.1,u_particle_pos_offset:[ar,ar]}),pf=t.bz(),$p=(p,i,a,f,g,v,S,C,z,N,U,$,Z,X,se,re,he,ae,be,Pe,Re,Ge,Ne)=>{let Ve=g.transform,Oe={u_is_size_zoom_constant:+(p==="constant"||p==="source"),u_is_size_feature_constant:+(p==="constant"||p==="camera"),u_size_t:i?i.uSizeT:0,u_size:i?i.uSize:0,u_camera_to_center_distance:Ve.getCameraToCenterDistance(be),u_rotate_symbol:+a,u_aspect_ratio:Ve.width/Ve.height,u_fade_change:g.options.fadeDuration?g.symbolFadeChange:1,u_matrix:v,u_label_plane_matrix:S,u_coord_matrix:C,u_is_text:+N,u_elevation_from_sea:z?1:0,u_pitch_with_map:+f,u_texsize:U,u_texsize_icon:$,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:pf,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:pf,u_up_vector:[0,-1,0],u_color_adj_mat:Re,u_icon_transition:Ge||0,u_gamma_scale:f?g.transform.getCameraToCenterDistance(be)*Math.cos(g.terrain?0:g.transform._pitch):1,u_device_pixel_ratio:t.q.devicePixelRatio,u_is_halo:+Z,u_scale_factor:Ne||1,u_ground_shadow_factor:Pe,u_inv_matrix:t.bi(t.bz(),S)};return be.name==="globe"&&(Oe.u_tile_id=[X.canonical.x,X.canonical.y,1<<X.canonical.z],Oe.u_zoom_transition=se,Oe.u_inv_rot_matrix=he,Oe.u_merc_center=re,Oe.u_camera_forward=Ve._camera.forward(),Oe.u_ecef_origin=t.dE(Ve.globeMatrix,X.toUnwrapped()),Oe.u_tile_matrix=Float32Array.from(Ve.globeMatrix),Oe.u_up_vector=ae),Oe},Qu=(p,i,a,f)=>({u_matrix:p,u_emissive_strength:i,u_opacity:a,u_color:f}),Kd=(p,i,a,f,g,v,S,C,z)=>t.l(function(N,U,$,Z,X,se){let{width:re,height:he}=Z.imageManager.getPixelSize(U),ae=Math.pow(2,se.tileID.overscaledZ),be=se.tileSize*Math.pow(2,Z.transform.tileZoom)/ae,Pe=be*(se.tileID.canonical.x+se.tileID.wrap*ae),Re=be*se.tileID.canonical.y;return{u_image:0,u_pattern_tl:$.tl,u_pattern_br:$.br,u_texsize:[re,he],u_pattern_size:$.displaySize,u_pattern_units_to_pixels:X?[Z.transform.width,-1*Z.transform.height]:[1/t.aw(se,1,Z.transform.tileZoom),1/t.aw(se,1,Z.transform.tileZoom)],u_pixel_coord_upper:[Pe>>16,Re>>16],u_pixel_coord_lower:[65535&Pe,65535&Re]}}(0,v,S,f,C,z),{u_matrix:p,u_emissive_strength:i,u_opacity:a}),ed=new Float32Array(t.bx([])),Uh=(p,i,a,f,g,v,S,C,z,N,U,$,Z,X=[0,0,0],se)=>{let re=g.style.light,he=re.properties.get("position"),ae=[-he.x,-he.y,he.z],be=t.dx();re.properties.get("anchor")==="viewport"&&(t.dy(be,-g.transform.angle),t.dz(ae,ae,be));let Pe=U.alphaMode==="MASK",Re=re.properties.get("color").toRenderColor(null),Ge=Z.paint.get("model-ambient-occlusion-intensity"),Ne=Z.paint.get("model-color").constantOr(t.am.white).toRenderColor(null),Ve=Z.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:p,u_lighting_matrix:i,u_normal_matrix:a,u_node_matrix:f||ed,u_lightpos:ae,u_lightintensity:re.properties.get("intensity"),u_lightcolor:[Re.r,Re.g,Re.b],u_camera_pos:X,u_opacity:v,u_baseTextureIsAlpha:0,u_alphaMask:+Pe,u_alphaCutoff:U.alphaCutoff,u_baseColorFactor:[S.r,S.g,S.b,S.a],u_emissiveFactor:[C[0],C[1],C[2],1],u_metallicFactor:z,u_roughnessFactor:N,u_baseColorTexture:ws.BaseColor,u_metallicRoughnessTexture:ws.MetallicRoughness,u_normalTexture:ws.Normal,u_occlusionTexture:ws.Occlusion,u_emissionTexture:ws.Emission,u_lutTexture:ws.LUT,u_color_mix:[Ne.r,Ne.g,Ne.b,Ve],u_aoIntensity:Ge,u_emissive_strength:$,u_occlusionTextureTransform:se||[0,0,0,0]}},td=(p,i=ed,a=ed)=>({u_matrix:p,u_instance:i,u_node_matrix:a}),Pm={fillExtrusion:p=>({u_matrix:new t.c8(p),u_lightpos:new t.ca(p),u_lightintensity:new t.cb(p),u_lightcolor:new t.ca(p),u_vertical_gradient:new t.cb(p),u_opacity:new t.cb(p),u_edge_radius:new t.cb(p),u_width_scale:new t.cb(p),u_ao:new t.c9(p),u_height_type:new t.cc(p),u_base_type:new t.cc(p),u_tile_id:new t.ca(p),u_zoom_transition:new t.cb(p),u_inv_rot_matrix:new t.c8(p),u_merc_center:new t.c9(p),u_up_dir:new t.ca(p),u_height_lift:new t.cb(p),u_flood_light_color:new t.ca(p),u_vertical_scale:new t.cb(p),u_flood_light_intensity:new t.cb(p),u_ground_shadow_factor:new t.ca(p)}),fillExtrusionDepth:p=>({u_matrix:new t.c8(p),u_edge_radius:new t.cb(p),u_width_scale:new t.cb(p),u_vertical_scale:new t.cb(p),u_height_type:new t.cc(p),u_base_type:new t.cc(p)}),fillExtrusionPattern:p=>({u_matrix:new t.c8(p),u_lightpos:new t.ca(p),u_lightintensity:new t.cb(p),u_lightcolor:new t.ca(p),u_vertical_gradient:new t.cb(p),u_height_factor:new t.cb(p),u_edge_radius:new t.cb(p),u_width_scale:new t.cb(p),u_ao:new t.c9(p),u_height_type:new t.cc(p),u_base_type:new t.cc(p),u_tile_id:new t.ca(p),u_zoom_transition:new t.cb(p),u_inv_rot_matrix:new t.c8(p),u_merc_center:new t.c9(p),u_up_dir:new t.ca(p),u_height_lift:new t.cb(p),u_image:new t.cc(p),u_texsize:new t.c9(p),u_pixel_coord_upper:new t.c9(p),u_pixel_coord_lower:new t.c9(p),u_tile_units_to_pixels:new t.cb(p),u_opacity:new t.cb(p),u_pattern_transition:new t.cb(p)}),fillExtrusionGroundEffect:p=>({u_matrix:new t.c8(p),u_opacity:new t.cb(p),u_ao_pass:new t.cb(p),u_meter_to_tile:new t.cb(p),u_ao:new t.c9(p),u_flood_light_intensity:new t.cb(p),u_flood_light_color:new t.ca(p),u_attenuation:new t.cb(p),u_edge_radius:new t.cb(p),u_fb:new t.cc(p),u_fb_size:new t.cb(p),u_dynamic_offset:new t.cb(p)}),fill:p=>({u_matrix:new t.c8(p),u_emissive_strength:new t.cb(p),u_ground_shadow_factor:new t.ca(p)}),fillPattern:p=>({u_matrix:new t.c8(p),u_emissive_strength:new t.cb(p),u_image:new t.cc(p),u_texsize:new t.c9(p),u_pixel_coord_upper:new t.c9(p),u_pixel_coord_lower:new t.c9(p),u_tile_units_to_pixels:new t.cb(p),u_ground_shadow_factor:new t.ca(p),u_pattern_transition:new t.cb(p)}),fillOutline:p=>({u_matrix:new t.c8(p),u_emissive_strength:new t.cb(p),u_world:new t.c9(p),u_ground_shadow_factor:new t.ca(p)}),fillOutlinePattern:p=>({u_matrix:new t.c8(p),u_emissive_strength:new t.cb(p),u_world:new t.c9(p),u_image:new t.cc(p),u_texsize:new t.c9(p),u_pixel_coord_upper:new t.c9(p),u_pixel_coord_lower:new t.c9(p),u_tile_units_to_pixels:new t.cb(p),u_ground_shadow_factor:new t.ca(p),u_pattern_transition:new t.cb(p)}),building:p=>({u_matrix:new t.c8(p),u_normal_matrix:new t.c8(p),u_opacity:new t.cb(p)}),buildingDepth:p=>({u_matrix:new t.c8(p)}),elevatedStructuresDepth:p=>({u_matrix:new t.c8(p),u_depth_bias:new t.cb(p)}),elevatedStructures:p=>({u_matrix:new t.c8(p),u_ground_shadow_factor:new t.ca(p)}),elevatedStructuresDepthReconstruct:p=>({u_matrix:new t.c8(p),u_camera_pos:new t.ca(p),u_depth_bias:new t.cb(p),u_height_scale:new t.cb(p),u_reset_depth:new t.cb(p)}),circle:t.dF,collisionBox:p=>({u_matrix:new t.c8(p),u_camera_to_center_distance:new t.cb(p),u_extrude_scale:new t.c9(p)}),collisionCircle:p=>({u_matrix:new t.c8(p),u_inv_matrix:new t.c8(p),u_camera_to_center_distance:new t.cb(p),u_viewport_size:new t.c9(p)}),debug:p=>({u_color:new t.di(p),u_matrix:new t.c8(p),u_overlay:new t.cc(p),u_overlay_scale:new t.cb(p)}),clippingMask:p=>({u_matrix:new t.c8(p)}),heatmap:p=>({u_extrude_scale:new t.cb(p),u_intensity:new t.cb(p),u_matrix:new t.c8(p),u_inv_rot_matrix:new t.c8(p),u_merc_center:new t.c9(p),u_tile_id:new t.ca(p),u_zoom_transition:new t.cb(p),u_up_dir:new t.ca(p)}),heatmapTexture:p=>({u_image:new t.cc(p),u_color_ramp:new t.cc(p),u_opacity:new t.cb(p)}),hillshade:p=>({u_matrix:new t.c8(p),u_image:new t.cc(p),u_latrange:new t.c9(p),u_light:new t.c9(p),u_shadow:new t.di(p),u_highlight:new t.di(p),u_emissive_strength:new t.cb(p),u_accent:new t.di(p)}),hillshadePrepare:p=>({u_matrix:new t.c8(p),u_image:new t.cc(p),u_dimension:new t.c9(p),u_zoom:new t.cb(p)}),line:t.dG,linePattern:t.dH,raster:p=>({u_matrix:new t.c8(p),u_normalize_matrix:new t.c8(p),u_globe_matrix:new t.c8(p),u_merc_matrix:new t.c8(p),u_grid_matrix:new t.dj(p),u_tl_parent:new t.c9(p),u_scale_parent:new t.cb(p),u_fade_t:new t.cb(p),u_opacity:new t.cb(p),u_image0:new t.cc(p),u_image1:new t.cc(p),u_brightness_low:new t.cb(p),u_brightness_high:new t.cb(p),u_saturation_factor:new t.cb(p),u_contrast_factor:new t.cb(p),u_spin_weights:new t.ca(p),u_perspective_transform:new t.c9(p),u_raster_elevation:new t.cb(p),u_zoom_transition:new t.cb(p),u_merc_center:new t.c9(p),u_cutoff_params:new t.cQ(p),u_colorization_mix:new t.cQ(p),u_colorization_offset:new t.cb(p),u_color_ramp:new t.cc(p),u_texture_offset:new t.c9(p),u_texture_res:new t.c9(p),u_emissive_strength:new t.cb(p)}),rasterParticle:p=>({u_matrix:new t.c8(p),u_normalize_matrix:new t.c8(p),u_globe_matrix:new t.c8(p),u_merc_matrix:new t.c8(p),u_grid_matrix:new t.dj(p),u_tl_parent:new t.c9(p),u_scale_parent:new t.cb(p),u_fade_t:new t.cb(p),u_opacity:new t.cb(p),u_image0:new t.cc(p),u_image1:new t.cc(p),u_raster_elevation:new t.cb(p),u_zoom_transition:new t.cb(p),u_merc_center:new t.c9(p),u_cutoff_params:new t.cQ(p)}),rasterParticleTexture:p=>({u_texture:new t.cc(p),u_opacity:new t.cb(p)}),rasterParticleDraw:p=>({u_particle_texture:new t.cc(p),u_particle_texture_side_len:new t.cb(p),u_tile_offset:new t.c9(p),u_velocity:new t.cc(p),u_color_ramp:new t.cc(p),u_velocity_res:new t.c9(p),u_max_speed:new t.cb(p),u_uv_offset:new t.c9(p),u_data_scale:new t.c9(p),u_data_offset:new t.cb(p),u_particle_pos_scale:new t.cb(p),u_particle_pos_offset:new t.c9(p)}),rasterParticleUpdate:p=>({u_particle_texture:new t.cc(p),u_particle_texture_side_len:new t.cb(p),u_velocity:new t.cc(p),u_velocity_res:new t.c9(p),u_max_speed:new t.cb(p),u_speed_factor:new t.cb(p),u_reset_rate:new t.cb(p),u_rand_seed:new t.cb(p),u_uv_offset:new t.c9(p),u_data_scale:new t.c9(p),u_data_offset:new t.cb(p),u_particle_pos_scale:new t.cb(p),u_particle_pos_offset:new t.c9(p)}),symbol:p=>({u_is_size_zoom_constant:new t.cc(p),u_is_size_feature_constant:new t.cc(p),u_size_t:new t.cb(p),u_size:new t.cb(p),u_camera_to_center_distance:new t.cb(p),u_rotate_symbol:new t.cc(p),u_aspect_ratio:new t.cb(p),u_fade_change:new t.cb(p),u_matrix:new t.c8(p),u_label_plane_matrix:new t.c8(p),u_coord_matrix:new t.c8(p),u_is_text:new t.cc(p),u_elevation_from_sea:new t.cc(p),u_pitch_with_map:new t.cc(p),u_texsize:new t.c9(p),u_texsize_icon:new t.c9(p),u_texture:new t.cc(p),u_texture_icon:new t.cc(p),u_gamma_scale:new t.cb(p),u_device_pixel_ratio:new t.cb(p),u_tile_id:new t.ca(p),u_zoom_transition:new t.cb(p),u_inv_rot_matrix:new t.c8(p),u_merc_center:new t.c9(p),u_camera_forward:new t.ca(p),u_tile_matrix:new t.c8(p),u_up_vector:new t.ca(p),u_ecef_origin:new t.ca(p),u_is_halo:new t.cc(p),u_icon_transition:new t.cb(p),u_color_adj_mat:new t.c8(p),u_scale_factor:new t.cb(p),u_ground_shadow_factor:new t.ca(p),u_inv_matrix:new t.c8(p)}),background:p=>({u_matrix:new t.c8(p),u_emissive_strength:new t.cb(p),u_opacity:new t.cb(p),u_color:new t.di(p)}),backgroundPattern:p=>({u_matrix:new t.c8(p),u_emissive_strength:new t.cb(p),u_opacity:new t.cb(p),u_image:new t.cc(p),u_pattern_tl:new t.c9(p),u_pattern_br:new t.c9(p),u_texsize:new t.c9(p),u_pattern_size:new t.c9(p),u_pixel_coord_upper:new t.c9(p),u_pixel_coord_lower:new t.c9(p),u_pattern_units_to_pixels:new t.c9(p)}),terrainRaster:p=>({u_matrix:new t.c8(p),u_image0:new t.cc(p),u_skirt_height:new t.cb(p),u_ground_shadow_factor:new t.ca(p)}),skybox:p=>({u_matrix:new t.c8(p),u_sun_direction:new t.ca(p),u_cubemap:new t.cc(p),u_opacity:new t.cb(p),u_temporal_offset:new t.cb(p)}),skyboxGradient:p=>({u_matrix:new t.c8(p),u_color_ramp:new t.cc(p),u_center_direction:new t.ca(p),u_radius:new t.cb(p),u_opacity:new t.cb(p),u_temporal_offset:new t.cb(p)}),skyboxCapture:p=>({u_matrix_3f:new t.dj(p),u_sun_direction:new t.ca(p),u_sun_intensity:new t.cb(p),u_color_tint_r:new t.cQ(p),u_color_tint_m:new t.cQ(p),u_luminance:new t.cb(p)}),globeRaster:p=>({u_proj_matrix:new t.c8(p),u_globe_matrix:new t.c8(p),u_normalize_matrix:new t.c8(p),u_merc_matrix:new t.c8(p),u_zoom_transition:new t.cb(p),u_merc_center:new t.c9(p),u_image0:new t.cc(p),u_grid_matrix:new t.dj(p),u_skirt_height:new t.cb(p),u_far_z_cutoff:new t.cb(p),u_frustum_tl:new t.ca(p),u_frustum_tr:new t.ca(p),u_frustum_br:new t.ca(p),u_frustum_bl:new t.ca(p),u_globe_pos:new t.ca(p),u_globe_radius:new t.cb(p),u_viewport:new t.c9(p)}),globeAtmosphere:p=>({u_frustum_tl:new t.ca(p),u_frustum_tr:new t.ca(p),u_frustum_br:new t.ca(p),u_frustum_bl:new t.ca(p),u_horizon:new t.cb(p),u_transition:new t.cb(p),u_fadeout_range:new t.cb(p),u_color:new t.cQ(p),u_high_color:new t.cQ(p),u_space_color:new t.cQ(p),u_temporal_offset:new t.cb(p),u_horizon_angle:new t.cb(p)}),model:p=>({u_matrix:new t.c8(p),u_lighting_matrix:new t.c8(p),u_normal_matrix:new t.c8(p),u_node_matrix:new t.c8(p),u_lightpos:new t.ca(p),u_lightintensity:new t.cb(p),u_lightcolor:new t.ca(p),u_camera_pos:new t.ca(p),u_opacity:new t.cb(p),u_baseColorFactor:new t.cQ(p),u_emissiveFactor:new t.cQ(p),u_metallicFactor:new t.cb(p),u_roughnessFactor:new t.cb(p),u_baseTextureIsAlpha:new t.cc(p),u_alphaMask:new t.cc(p),u_alphaCutoff:new t.cb(p),u_baseColorTexture:new t.cc(p),u_metallicRoughnessTexture:new t.cc(p),u_normalTexture:new t.cc(p),u_occlusionTexture:new t.cc(p),u_emissionTexture:new t.cc(p),u_lutTexture:new t.cc(p),u_color_mix:new t.cQ(p),u_aoIntensity:new t.cb(p),u_emissive_strength:new t.cb(p),u_occlusionTextureTransform:new t.cQ(p)}),modelDepth:p=>({u_matrix:new t.c8(p),u_instance:new t.c8(p),u_node_matrix:new t.c8(p)}),groundShadow:p=>({u_matrix:new t.c8(p),u_ground_shadow_factor:new t.ca(p)}),stars:p=>({u_matrix:new t.c8(p),u_up:new t.ca(p),u_right:new t.ca(p),u_intensity_multiplier:new t.cb(p)}),snowParticle:p=>({u_modelview:new t.c8(p),u_projection:new t.c8(p),u_time:new t.cb(p),u_cam_pos:new t.ca(p),u_velocityConeAperture:new t.cb(p),u_velocity:new t.cb(p),u_horizontalOscillationRadius:new t.cb(p),u_horizontalOscillationRate:new t.cb(p),u_boxSize:new t.cb(p),u_billboardSize:new t.cb(p),u_simpleShapeParameters:new t.c9(p),u_screenSize:new t.c9(p),u_thinningCenterPos:new t.c9(p),u_thinningShape:new t.ca(p),u_thinningAffectedRatio:new t.cb(p),u_thinningParticleOffset:new t.cb(p),u_particleColor:new t.cQ(p),u_direction:new t.ca(p)}),rainParticle:p=>({u_modelview:new t.c8(p),u_projection:new t.c8(p),u_time:new t.cb(p),u_cam_pos:new t.ca(p),u_texScreen:new t.cc(p),u_velocityConeAperture:new t.cb(p),u_velocity:new t.cb(p),u_boxSize:new t.cb(p),u_rainDropletSize:new t.c9(p),u_distortionStrength:new t.cb(p),u_rainDirection:new t.ca(p),u_color:new t.cQ(p),u_screenSize:new t.c9(p),u_thinningCenterPos:new t.c9(p),u_thinningShape:new t.ca(p),u_thinningAffectedRatio:new t.cb(p),u_thinningParticleOffset:new t.cb(p),u_shapeDirectionalPower:new t.cb(p),u_shapeNormalPower:new t.cb(p),u_mode:new t.cb(p)}),vignette:p=>({u_vignetteShape:new t.ca(p),u_vignetteColor:new t.cQ(p)}),occlusion:p=>({u_matrix:new t.c8(p),u_anchorPos:new t.ca(p),u_screenSizePx:new t.c9(p),u_occluderSizePx:new t.c9(p),u_color:new t.cQ(p)})},Yd=(()=>{class p{constructor(a,f,g,v){this.id=p.uniqueIdxCounter,p.uniqueIdxCounter++,this.context=a;let S=a.gl;this.buffer=S.createBuffer(),this.dynamicDraw=!!g,this.context.unbindVAO(),a.bindElementBuffer.set(this.buffer),S.bufferData(S.ELEMENT_ARRAY_BUFFER,f.arrayBuffer,this.dynamicDraw?S.DYNAMIC_DRAW:S.STATIC_DRAW),this.dynamicDraw||v||f.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(a){this.id=p.uniqueIdxCounter,p.uniqueIdxCounter++;let f=this.context.gl;this.context.unbindVAO(),this.bind(),f.bufferSubData(f.ELEMENT_ARRAY_BUFFER,0,a.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}return p.uniqueIdxCounter=0,p})(),jh={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class jo{constructor(i,a,f,g,v,S){this.length=a.length,this.attributes=f,this.itemSize=a.bytesPerElement,this.dynamicDraw=g,this.instanceCount=S,this.context=i;let C=i.gl;this.buffer=C.createBuffer(),i.bindVertexBuffer.set(this.buffer),C.bufferData(C.ARRAY_BUFFER,a.arrayBuffer,this.dynamicDraw?C.DYNAMIC_DRAW:C.STATIC_DRAW),this.dynamicDraw||v||a.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(i){let a=this.context.gl;this.bind(),a.bufferSubData(a.ARRAY_BUFFER,0,i.arrayBuffer)}enableAttributes(i,a){for(let f=0;f<this.attributes.length;f++){let g=a.attributes[this.attributes[f].name];g!==void 0&&i.enableVertexAttribArray(g)}}setVertexAttribPointers(i,a,f){for(let g=0;g<this.attributes.length;g++){let v=this.attributes[g],S=a.attributes[v.name];S!==void 0&&i.vertexAttribPointer(S,v.components,i[jh[v.type]],!1,this.itemSize,v.offset+this.itemSize*(f||0))}}setVertexAttribDivisor(i,a,f){for(let g=0;g<this.attributes.length;g++){let v=a.attributes[this.attributes[g].name];v!==void 0&&this.instanceCount&&this.instanceCount>0&&i.vertexAttribDivisor(v,f)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Gh{constructor(i,a,f,g,v){this.context=i,this.width=a,this.height=f;let S=this.framebuffer=i.gl.createFramebuffer();g&&(this.colorAttachment=new Nd(i,S)),v&&(this.depthAttachmentType=v,this.depthAttachment=v==="renderbuffer"?new ph(i,S):new Bh(i,S))}destroy(){let i=this.context.gl;if(this.colorAttachment){let a=this.colorAttachment.get();a&&i.deleteTexture(a)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){let a=this.depthAttachment.get();a&&i.deleteRenderbuffer(a)}else{let a=this.depthAttachment.get();a&&i.deleteTexture(a)}i.deleteFramebuffer(this.framebuffer)}}class mh{constructor(i,a){this.gl=i,this.clearColor=new Vf(this),this.clearDepth=new Rd(this),this.clearStencil=new Em(this),this.colorMask=new Uf(this),this.depthMask=new jf(this),this.stencilMask=new zd(this),this.stencilFunc=new Vp(this),this.stencilOp=new Ld(this),this.stencilTest=new ju(this),this.depthRange=new Fh(this),this.depthTest=new Gu(this),this.depthFunc=new ch(this),this.blend=new fu(this),this.blendFunc=new mu(this),this.blendColor=new sc(this),this.blendEquation=new hh(this),this.cullFace=new Zu(this),this.cullFaceSide=new ac(this),this.frontFace=new qu(this),this.program=new kd(this),this.activeTexture=new $u(this),this.viewport=new Up(this),this.bindFramebuffer=new jp(this),this.bindRenderbuffer=new Od(this),this.bindTexture=new uh(this),this.bindVertexBuffer=new Fd(this),this.bindElementBuffer=new Bd(this),this.bindVertexArrayOES=new uf(this),this.pixelStoreUnpack=new Ro(this),this.pixelStoreUnpackPremultiplyAlpha=new dh(this),this.pixelStoreUnpackFlipY=new Nl(this),this.options=a?Object.assign({},a):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=i.getExtension("EXT_texture_filter_anisotropic")||i.getExtension("MOZ_EXT_texture_filter_anisotropic")||i.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=i.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=i.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=i.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=i.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=a&&!!a.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=i.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=i.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=i.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),this.maxPointSize=i.getParameter(i.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(i,a,f){return new Yd(this,i,a,f)}createVertexBuffer(i,a,f,g,v){return new jo(this,i,a,f,g,v)}createRenderbuffer(i,a,f){let g=this.gl,v=g.createRenderbuffer();return this.bindRenderbuffer.set(v),g.renderbufferStorage(g.RENDERBUFFER,i,a,f),this.bindRenderbuffer.set(null),v}createFramebuffer(i,a,f,g){return new Gh(this,i,a,f,g)}clear({color:i,depth:a,stencil:f,colorMask:g}){let v=this.gl,S=0;i&&(S|=v.COLOR_BUFFER_BIT,this.clearColor.set(i),this.colorMask.set(g||[!0,!0,!0,!0])),a!==void 0&&(S|=v.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(a),this.depthMask.set(!0)),f!==void 0&&(S|=v.STENCIL_BUFFER_BIT,this.clearStencil.set(f),this.stencilMask.set(255)),v.clear(S)}setCullFace(i){i.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(i.mode),this.frontFace.set(i.frontFace))}setDepthMode(i){i.func!==this.gl.ALWAYS||i.mask?(this.depthTest.set(!0),this.depthFunc.set(i.func),this.depthMask.set(i.mask),this.depthRange.set(i.range)):this.depthTest.set(!1)}setStencilMode(i){i.test.func!==this.gl.ALWAYS||i.mask?(this.stencilTest.set(!0),this.stencilMask.set(i.mask),this.stencilOp.set([i.fail,i.depthFail,i.pass]),this.stencilFunc.set({func:i.test.func,ref:i.ref,mask:i.test.mask})):this.stencilTest.set(!1)}setColorMode(i){t.bv(i.blendFunction,Tn.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(i.blendFunction),this.blendColor.set(i.blendColor),i.blendEquation?this.blendEquation.set(i.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(i.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let _h;function bu(p,i,a,f,g,v,S){let C=p.context,z=C.gl,N=p.transform,U=p.getOrCreateProgram("collisionBox"),$=[],Z=0,X=0;for(let Re=0;Re<f.length;Re++){let Ge=f[Re],Ne=i.getTile(Ge),Ve=Ne.getBucket(a);if(!Ve)continue;let Oe=Dp(Ge,Ve,N),Ke=Oe;g[0]===0&&g[1]===0||(Ke=p.translatePosMatrix(Oe,Ne,g,v));let Qe=S?Ve.textCollisionBox:Ve.iconCollisionBox,It=Ve.collisionCircleArray;if(It.length>0){let gt=t.bz(),jt=Ke;t.cB(gt,Ve.placementInvProjMatrix,N.glCoordMatrix),t.cB(gt,gt,Ve.placementViewportMatrix),$.push({circleArray:It,circleOffset:X,transform:jt,invTransform:gt,projection:Ve.getProjection()}),Z+=It.length/4,X=Z}Qe&&(p.terrain&&p.terrain.setupElevationDraw(Ne,U),U.draw(p,z.LINES,Li.disabled,hn.disabled,p.colorModeForRenderPass(),ln.disabled,hc(Ke,N,Ne,Ve.getProjection()),a.id,Qe.layoutVertexBuffer,Qe.indexBuffer,Qe.segments,null,N.zoom,null,[Qe.collisionVertexBuffer,Qe.collisionVertexBufferExt]))}if(!S||!$.length)return;let se=p.getOrCreateProgram("collisionCircle"),re=new t.dI;re.resize(4*Z),re._trim();let he=0;for(let Re of $)for(let Ge=0;Ge<Re.circleArray.length/4;Ge++){let Ne=4*Ge,Ve=Re.circleArray[Ne+0],Oe=Re.circleArray[Ne+1],Ke=Re.circleArray[Ne+2],Qe=Re.circleArray[Ne+3];re.emplace(he++,Ve,Oe,Ke,Qe,0),re.emplace(he++,Ve,Oe,Ke,Qe,1),re.emplace(he++,Ve,Oe,Ke,Qe,2),re.emplace(he++,Ve,Oe,Ke,Qe,3)}(!_h||_h.length<2*Z)&&(_h=function(Re){let Ge=2*Re,Ne=new t.a_;Ne.resize(Ge),Ne._trim();for(let Ve=0;Ve<Ge;Ve++){let Oe=6*Ve;Ne.uint16[Oe+0]=4*Ve+0,Ne.uint16[Oe+1]=4*Ve+1,Ne.uint16[Oe+2]=4*Ve+2,Ne.uint16[Oe+3]=4*Ve+2,Ne.uint16[Oe+4]=4*Ve+3,Ne.uint16[Oe+5]=4*Ve+0}return Ne}(Z));let ae=C.createIndexBuffer(_h,!0),be=C.createVertexBuffer(re,t.dJ.members,!0);for(let Re of $){let Ge={u_matrix:Re.transform,u_inv_matrix:Re.invTransform,u_camera_to_center_distance:(Pe=N).getCameraToCenterDistance(Re.projection),u_viewport_size:[Pe.width,Pe.height]};se.draw(p,z.TRIANGLES,Li.disabled,hn.disabled,p.colorModeForRenderPass(),ln.disabled,Ge,a.id,be,ae,t.bd.simpleSegment(0,2*Re.circleOffset,Re.circleArray.length,Re.circleArray.length/2),null,N.zoom)}var Pe;be.destroy(),ae.destroy()}let id=t.bz();function Jd(p){let i=p._camera.getWorldToCamera(p.worldSize,1),a=t.az([],i,p.globeMatrix);t.bi(a,a);let f=[0,0,0],g=[0,1,0,0];return t.aA(g,g,a),f[0]=g[0],f[1]=g[1],f[2]=g[2],t.au(f,f),f}function yl({width:p,height:i,anchor:a,textOffset:f,textScale:g},v){let{horizontalAlign:S,verticalAlign:C}=t.bV(a),z=-(S-.5)*p,N=-(C-.5)*i,U=t.bU(a,f);return new t.P((z/g+U[0])*v,(N/g+U[1])*v)}function nd(p,i,a,f,g,v,S,C,z,N){let U=p.text.placedSymbolArray,$=p.text.dynamicLayoutVertexArray,Z=p.icon.dynamicLayoutVertexArray,X={},se=p.getProjection(),re=Dl(S,se,g),he=g.elevation,ae=se.upVectorScale(S.canonical,g.center.lat,g.worldSize).metersToTile;$.clear();for(let be=0;be<U.length;be++){let Pe=U.get(be),{tileAnchorX:Re,tileAnchorY:Ge,numGlyphs:Ne}=Pe,Ve=Pe.hidden||!Pe.crossTileID||p.allowVerticalPlacement&&!Pe.placedOrientation?null:f[Pe.crossTileID];if(Ve){let Oe=0,Ke=0,Qe=0;if(he){let qt=he?he.getAtTileOffset(S,Re,Ge):0,[Pt,ti,Gt]=se.upVector(S.canonical,Re,Ge);Oe=qt*Pt*ae,Ke=qt*ti*ae,Qe=qt*Gt*ae}let[It,gt,jt,Ut]=za(Pe.projectedAnchorX+Oe,Pe.projectedAnchorY+Ke,Pe.projectedAnchorZ+Qe,a?re:v),fi=Sa(g.getCameraToCenterDistance(se),Ut),vt=t.bJ(p.textSizeData,z,Pe)*fi/t.bO;a&&(vt*=p.tilePixelRatio/C);let Ct=yl(Ve,vt);a?({x:It,y:gt,z:jt}=se.projectTilePoint(Re+Ct.x,Ge+Ct.y,S.canonical),[It,gt,jt]=za(It+Oe,gt+Ke,jt+Qe,v)):(i&&Ct._rotate(-g.angle),It+=Ct.x,gt+=Ct.y,jt=0);let _t=p.allowVerticalPlacement&&Pe.placedOrientation===t.bI.vertical?Math.PI/2:0;for(let qt=0;qt<Ne;qt++)t.bL($,It,gt,jt,_t);N&&Pe.associatedIconIndex>=0&&(X[Pe.associatedIconIndex]={x:It,y:gt,z:jt,angle:_t})}else sr(Ne,$)}if(N){Z.clear();let be=p.icon.placedSymbolArray;for(let Pe=0;Pe<be.length;Pe++){let Re=be.get(Pe),{numGlyphs:Ge}=Re,Ne=X[Pe];if(Re.hidden||!Ne)sr(Ge,Z);else{let{x:Ve,y:Oe,z:Ke,angle:Qe}=Ne;for(let It=0;It<Ge;It++)t.bL(Z,Ve,Oe,Ke,Qe)}}p.icon.dynamicLayoutVertexBuffer.updateData(Z)}p.text.dynamicLayoutVertexBuffer.updateData($)}function pn(p,i,a,f,g,v,S={}){let C=a.paint.get("icon-translate"),z=a.paint.get("text-translate"),N=a.paint.get("icon-translate-anchor"),U=a.paint.get("text-translate-anchor"),$=a.layout.get("icon-rotation-alignment"),Z=a.layout.get("text-rotation-alignment"),X=a.layout.get("icon-pitch-alignment"),se=a.layout.get("text-pitch-alignment"),re=a.layout.get("icon-keep-upright"),he=a.layout.get("text-keep-upright"),ae=a.paint.get("icon-color-saturation"),be=a.paint.get("icon-color-contrast"),Pe=a.paint.get("icon-color-brightness-min"),Re=a.paint.get("icon-color-brightness-max"),Ge=a.layout.get("symbol-elevation-reference")==="sea",Ne=p.context,Ve=Ne.gl,Oe=p.transform,Ke=$==="map",Qe=Z==="map",It=X==="map",gt=se==="map",jt=a.layout.get("symbol-sort-key").constantOr(1)!==void 0,Ut=!1,fi=p.depthModeForSublayer(0,Li.ReadOnly),vt=new Li(p.context.gl.LEQUAL,Li.ReadOnly,p.depthRangeFor3D),Ct=[t.ay(Oe.center.lng),t.aH(Oe.center.lat)],_t=a.layout.get("text-variable-anchor"),qt=Oe.projection.name==="globe",Pt=[],ti=[0,-1,0];for(let Gt of f){let ii=i.getTile(Gt),oi=ii.getBucket(a);if(!oi||oi.projection.name==="mercator"&&qt||oi.fullyClipped)continue;let ki=oi.projection.name==="globe",ji=ki?t.ah(Oe.zoom):0,zi=Dl(Gt,oi.getProjection(),Oe),$i=Oe.calculatePixelsToTileUnitsMatrix(ii),Oi=_t&&oi.hasTextData(),nn=oi.hasIconTextFit()&&Oi&&oi.hasIconData(),xn=oi.elevationType==="road"?vt:fi,Bn=oi.getProjection().createInversionMatrix(Oe,Gt.canonical),Er=p.shadowRenderer,zr=oi.elevationType==="road"&&!!Er&&Er.enabled,Gn=[0,0,0];if(zr){let ro=p.style.directionalLight,Dn=p.style.ambientLight;ro&&Dn&&(Gn=Ol(p.style,ro,Dn))}let po=ro=>{Oe.depthOcclusionForSymbolsAndCircles&&(a.hasInitialOcclusionOpacityProperties||p.terrain)&&(ro.push("DEPTH_D24"),ro.push("DEPTH_OCCLUSION"))},no=()=>{let ro=Ke&&a.layout.get("symbol-placement")!=="point",Dn=[];po(Dn);let oo=ro||nn,fr=a.paint.get("icon-image-cross-fade");p.terrainRenderModeElevated()&&It&&Dn.push("PITCH_WITH_MAP_TERRAIN"),ki&&(Dn.push("PROJECTION_GLOBE_VIEW"),oo&&Dn.push("PROJECTED_POS_ON_VIEWPORT")),fr>0&&Dn.push("ICON_TRANSITION"),oi.icon.zOffsetVertexBuffer&&Dn.push("Z_OFFSET"),ae===0&&be===0&&Pe===0&&Re===1||Dn.push("COLOR_ADJUSTMENT"),oi.sdfIcons&&Dn.push("RENDER_SDF"),zr&&Dn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");let so=oi.icon.programConfigurations.get(a.id),Sr=p.getOrCreateProgram("symbol",{config:so,defines:Dn}),fo=ii.imageAtlasTexture?ii.imageAtlasTexture.size:[0,0],js=oi.iconSizeData,Gr=t.bH(js,Oe.zoom),ea=It||Oe.pitch!==0,Xo=Bs(zi,ii.tileID.canonical,It,Ke,Oe,oi.getProjection(),$i),ha=ll(zi,ii.tileID.canonical,It,Ke,Oe,oi.getProjection(),$i),wh=p.translatePosMatrix(ha,ii,C,N,!0),Lc=p.translatePosMatrix(zi,ii,C,N),Zl=oo?id:Xo,fc=Ke&&!It&&!ro,Hh=ti;!qt&&!Oe.mercatorFromTransition||Ke||(Hh=Jd(Oe));let Xh=ki?Hh:ti,Th=a.getColorAdjustmentMatrix(ae,be,Pe,Re),up=$p(js.kind,Gr,fc,It,p,Lc,Zl,wh,Ge,!1,fo,[0,0],!0,Gt,ji,Ct,Bn,Xh,oi.getProjection(),Gn,Th,fr),dp=ii.imageAtlasTexture?ii.imageAtlasTexture:null,Kf=a.layout.get("icon-size").constantOr(0)!==1||oi.iconsNeedLinear,hd=oi.sdfIcons||p.options.rotating||p.options.zooming||Kf||ea?Ve.LINEAR:Ve.NEAREST,wf=oi.sdfIcons&&a.paint.get("icon-halo-width").constantOr(1)!==0,pp=p.terrain&&It&&ro?t.bi(t.bz(),Xo):id;if(ro&&oi.icon){let Jr=Oe.elevation,vs=Jr?Jr.getAtTileOffsetFunc(Gt,Oe.center.lat,Oe.worldSize,oi.getProjection()):null,Tf=Kc(zi,ii.tileID.canonical,It,Ke,Oe,oi.getProjection(),$i);Ap(oi,zi,p,!1,Tf,ha,It,re,vs,Gt)}return{program:Sr,buffers:oi.icon,uniformValues:up,atlasTexture:dp,atlasTextureIcon:null,atlasInterpolation:hd,atlasInterpolationIcon:null,isSDF:oi.sdfIcons,hasHalo:wf,depthMode:xn,tile:ii,renderWithShadows:zr,labelPlaneMatrixInv:pp}},En=()=>{let ro=Qe&&a.layout.get("symbol-placement")!=="point",Dn=[],oo=ro||_t||nn;p.terrainRenderModeElevated()&&gt&&Dn.push("PITCH_WITH_MAP_TERRAIN"),ki&&(Dn.push("PROJECTION_GLOBE_VIEW"),oo&&Dn.push("PROJECTED_POS_ON_VIEWPORT")),oi.text.zOffsetVertexBuffer&&Dn.push("Z_OFFSET"),oi.iconsInText&&Dn.push("RENDER_TEXT_AND_SYMBOL"),Dn.push("RENDER_SDF"),zr&&Dn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),po(Dn);let fr=oi.text.programConfigurations.get(a.id),so=p.getOrCreateProgram("symbol",{config:fr,defines:Dn}),Sr,fo=[0,0],js=null,Gr=oi.textSizeData;oi.iconsInText&&(fo=ii.imageAtlasTexture?ii.imageAtlasTexture.size:[0,0],js=ii.imageAtlasTexture?ii.imageAtlasTexture:null,Sr=gt||Oe.pitch!==0||p.options.rotating||p.options.zooming||Gr.kind==="composite"||Gr.kind==="camera"?Ve.LINEAR:Ve.NEAREST);let ea=ii.glyphAtlasTexture?ii.glyphAtlasTexture.size:[0,0],Xo=a.layout.get("text-size-scale-range"),ha=t.aD(p.scaleFactor,Xo[0],Xo[1]),wh=t.bH(Gr,Oe.zoom,ha),Lc=Bs(zi,ii.tileID.canonical,gt,Qe,Oe,oi.getProjection(),$i),Zl=ll(zi,ii.tileID.canonical,gt,Qe,Oe,oi.getProjection(),$i),fc=p.translatePosMatrix(Zl,ii,z,U,!0),Hh=p.translatePosMatrix(zi,ii,z,U),Xh=oo?id:Lc,Th=Qe&&!gt&&!ro,up=ti;!qt&&!Oe.mercatorFromTransition||Qe||(up=Jd(Oe));let dp=$p(Gr.kind,wh,Th,gt,p,Hh,Xh,fc,Ge,!0,ea,fo,!0,Gt,ji,Ct,Bn,ki?up:ti,oi.getProjection(),Gn,null,null,ha),Kf=ii.glyphAtlasTexture?ii.glyphAtlasTexture:null,hd=Ve.LINEAR,wf=a.paint.get("text-halo-width").constantOr(1)!==0,pp=p.terrain&&gt&&ro?t.bi(t.bz(),Lc):id;if(ro&&oi.text){let Jr=Oe.elevation,vs=Jr?Jr.getAtTileOffsetFunc(Gt,Oe.center.lat,Oe.worldSize,oi.getProjection()):null,Tf=Kc(zi,ii.tileID.canonical,gt,Qe,Oe,oi.getProjection(),$i);Ap(oi,zi,p,!0,Tf,Zl,gt,he,vs,Gt)}return{program:so,buffers:oi.text,uniformValues:dp,atlasTexture:Kf,atlasTextureIcon:js,atlasInterpolation:hd,atlasInterpolationIcon:Sr,isSDF:!0,hasHalo:wf,depthMode:xn,tile:ii,renderWithShadows:zr,labelPlaneMatrixInv:pp}},cr=oi.icon.segments.get().length,pr=oi.text.segments.get().length,Or=cr&&!S.onlyText?no():null,xs=pr&&!S.onlyIcons?En():null,Lo=a.paint.get("icon-opacity").constantOr(1),ko=a.paint.get("text-opacity").constantOr(1);if(jt&&oi.canOverlap){Ut=!0;let ro=Lo&&!S.onlyText?oi.icon.segments.get():[],Dn=ko&&!S.onlyIcons?oi.text.segments.get():[];for(let oo of ro)Pt.push({segments:new t.bd([oo]),sortKey:oo.sortKey,state:Or});for(let oo of Dn)Pt.push({segments:new t.bd([oo]),sortKey:oo.sortKey,state:xs})}else S.onlyText||Pt.push({segments:Lo?oi.icon.segments:new t.bd([]),sortKey:0,state:Or}),S.onlyIcons||Pt.push({segments:ko?oi.text.segments:new t.bd([]),sortKey:0,state:xs})}Ut&&Pt.sort((Gt,ii)=>Gt.sortKey-ii.sortKey);for(let Gt of Pt){let ii=Gt.state;if(ii)if(p.terrain?p.terrain.setupElevationDraw(ii.tile,ii.program,{useDepthForOcclusion:Oe.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:ii.labelPlaneMatrixInv}):p.setupDepthForOcclusion(Oe.depthOcclusionForSymbolsAndCircles,ii.program),Ne.activeTexture.set(Ve.TEXTURE0),ii.atlasTexture&&ii.atlasTexture.bind(ii.atlasInterpolation,Ve.CLAMP_TO_EDGE,!0),ii.atlasTextureIcon&&(Ne.activeTexture.set(Ve.TEXTURE1),ii.atlasTextureIcon&&ii.atlasTextureIcon.bind(ii.atlasInterpolationIcon,Ve.CLAMP_TO_EDGE,!0)),ii.renderWithShadows&&p.shadowRenderer.setupShadows(ii.tile.tileID.toUnwrapped(),ii.program,"vector-tile",ii.tile.tileID.overscaledZ),p.uploadCommonLightUniforms(p.context,ii.program),ii.hasHalo){let oi=ii.uniformValues;oi.u_is_halo=1,jn(ii.buffers,Gt.segments,a,p,ii.program,ii.depthMode,g,v,oi,2),oi.u_is_halo=0}else{if(ii.isSDF){let oi=ii.uniformValues;ii.hasHalo&&(oi.u_is_halo=1,jn(ii.buffers,Gt.segments,a,p,ii.program,ii.depthMode,g,v,oi,1)),oi.u_is_halo=0}jn(ii.buffers,Gt.segments,a,p,ii.program,ii.depthMode,g,v,ii.uniformValues,1)}}}function jn(p,i,a,f,g,v,S,C,z,N){let U=[p.dynamicLayoutVertexBuffer,p.opacityVertexBuffer,p.iconTransitioningVertexBuffer,p.globeExtVertexBuffer,p.zOffsetVertexBuffer];g.draw(f,f.context.gl.TRIANGLES,v,S,C,ln.disabled,z,a.id,p.layoutVertexBuffer,p.indexBuffer,i,a.paint,f.transform.zoom,p.programConfigurations.get(a.id),U,N)}function gh(p,i){let a=1<<p.canonical.z,f=(i.x*a-p.canonical.x-p.wrap*a)*t.aj,g=(i.y*a-p.canonical.y)*t.aj,v=t.dS(i.z,i.y);return t.cS(f,g,v)}function wu(p,i,a,f,g){if(!a.layout||a.layout.get("fill-elevation-reference")==="none")return;let v=p.context.gl,S=new Li(p.context.gl.LEQUAL,Li.ReadWrite,p.depthRangeFor3D),C=new Li(p.context.gl.GREATER,Li.ReadWrite,p.depthRangeFor3D),z=function(X){let se=t.cJ(X.pitch),re=.01;return X.isOrthographic&&(re=t.ai(1e-4,re,t.cO(se>=Sc?1:se/Sc))),2*re}(p.transform),N=p.transform.getFreeCameraOptions().position,U="elevatedStructuresDepthReconstruct",$=p.getOrCreateProgram(U,{defines:["DEPTH_RECONSTRUCTION"]}),Z=p.getOrCreateProgram(U);for(let X of f){let se=i.getTile(X),re=se.getBucket(a);if(!re)continue;let he=re.elevatedStructures;if(!he)continue;let ae=re.elevationBufferData.heightRange,be=gh(X.toUnwrapped(),N),Pe=p.translatePosMatrix(X.projMatrix,se,a.paint.get("fill-translate"),a.paint.get("fill-translate-anchor")),Re,Ge,Ne,Ve;if(g==="initialize"){if(!ae||ae.min>=1||he.depthSegments.segments[0].primitiveLength===0)continue;Re=Pc(Pe,be,z,1,0),Ge=S,Ne=he.depthSegments,Ve=$}else if(g==="reset"){if(!ae||ae.min>=0||he.maskSegments.segments[0].primitiveLength===0)continue;Re=Pc(Pe,be,0,0,1),Ge=C,Ne=he.maskSegments,Ve=$}else if(g==="geometry"){if(he.depthSegments.segments[0].primitiveLength===0)continue;Re=Pc(Pe,be,z,1,0),Ge=S,Ne=he.depthSegments,Ve=Z}Ve.draw(p,v.TRIANGLES,Ge,hn.disabled,Tn.disabled,ln.disabled,Re,a.id,he.vertexBuffer,he.indexBuffer,Ne,a.paint,p.transform.zoom)}}function Ei(p,i,a){let{painter:f,sourceCache:g,layer:v,coords:S,colorMode:C,elevationType:z,terrainEnabled:N,pass:U}=p,$=f.context.gl,Z=v.paint.get("fill-pattern"),X=v.paint.get("fill-pattern-cross-fade"),se=Z.constantOr(null),re=z;z!=="road"||i&&!N||(re="none");let he=re==="road",ae=p.painter.shadowRenderer,be=he&&!!ae&&ae.enabled,Pe=new Li(f.context.gl.LEQUAL,Li.ReadOnly,f.depthRangeFor3D),Re=[0,0,0];if(be){let Ve=f.style.directionalLight,Oe=f.style.ambientLight;Ve&&Oe&&(Re=Ol(f.style,Ve,Oe))}let Ge=Z&&Z.constantOr(1),Ne=(Ve,Oe)=>{let Ke,Qe,It,gt,jt;Oe?(Ke=Ge&&!v.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",It=$.LINES):(Ke=Ge?"fillPattern":"fill",It=$.TRIANGLES);for(let Ut of S){let fi=g.getTile(Ut);if(Ge&&!fi.patternsLoaded())continue;let vt=fi.getBucket(v);if(!vt)continue;let Ct=i?vt.elevationBufferData:vt.bufferData;if(Ct.isEmpty())continue;f.prepareDrawTile();let _t=Ct.programConfigurations.get(v.id),qt=f.isTileAffectedByFog(Ut),Pt=[],ti=[];he&&(Pt.push("ELEVATED_ROADS"),ti.push(Ct.elevatedLayoutVertexBuffer)),be&&Pt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Ge&&(f.context.activeTexture.set($.TEXTURE0),fi.imageAtlasTexture&&fi.imageAtlasTexture.bind($.LINEAR,$.CLAMP_TO_EDGE),_t.updatePaintBuffers());let Gt=!1;if(se&&fi.imageAtlas){let zi=fi.imageAtlas,$i=t.dN.from(se),Oi=$i.getPrimary().scaleSelf(t.q.devicePixelRatio).toString(),nn=$i.getSecondary(),xn=zi.patternPositions.get(Oi),Bn=nn?zi.patternPositions.get(nn.scaleSelf(t.q.devicePixelRatio).toString()):null;Gt=!!xn&&!!Bn,xn&&_t.setConstantPatternPositions(xn,Bn)}X>0&&(Gt||_t.getPatternTransitionVertexBuffer("fill-pattern"))&&Pt.push("FILL_PATTERN_TRANSITION");let ii=f.getOrCreateProgram(Ke,{config:_t,overrideFog:qt,defines:Pt}),oi=f.translatePosMatrix(Ut.projMatrix,fi,v.paint.get("fill-translate"),v.paint.get("fill-translate-anchor"));be&&ae.setupShadows(fi.tileID.toUnwrapped(),ii,"vector-tile",fi.tileID.overscaledZ);let ki=v.paint.get("fill-emissive-strength");if(Oe){gt=Ct.lineIndexBuffer,jt=Ct.lineSegments;let zi=f.terrain&&f.terrain.renderingToTexture?f.terrain.drapeBufferSize:[$.drawingBufferWidth,$.drawingBufferHeight];Qe=Ke==="fillOutlinePattern"&&Ge?df(oi,ki,f,fi,zi,Re,X):Mm(oi,ki,zi,Re)}else gt=Ct.indexBuffer,jt=Ct.triangleSegments,Qe=Ge?qd(oi,ki,f,fi,Re,X):Gf(oi,ki,Re);f.uploadCommonUniforms(f.context,ii,Ut.toUnwrapped());let ji=Ve;(z==="road"&&!N||z==="offset")&&(ji=Pe),ii.draw(f,It,ji,a||f.stencilModeForClipping(Ut),C,ln.disabled,Qe,v.id,Ct.layoutVertexBuffer,gt,jt,v.paint,f.transform.zoom,_t,ti)}};f.renderPass===U&&Ne(f.depthModeForSublayer(1,f.renderPass==="opaque"?Li.ReadWrite:Li.ReadOnly),!1),re==="none"&&f.renderPass==="translucent"&&v.paint.get("fill-antialias")&&Ne(f.depthModeForSublayer(v.getPaintProperty("fill-outline-color")?2:0,Li.ReadOnly),!0)}function Qs(p,i,a,f,g,v,S,C){a.resetLayerRenderingStats(p);let z=p.context,N=z.gl,U=p.transform,$=a.paint.get("fill-extrusion-pattern"),Z=a.paint.get("fill-extrusion-pattern-cross-fade"),X=$.constantOr(null),se=$.constantOr(1),re=a.paint.get("fill-extrusion-opacity"),he=p.style.enable3dLights(),ae=a.paint.get(he&&!se?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),be=[a.paint.get("fill-extrusion-ambient-occlusion-intensity"),ae],Pe=a.layout.get("fill-extrusion-edge-radius"),Re=Pe>0&&!a.paint.get("fill-extrusion-rounded-roof"),Ge=Re?0:Pe,Ne=U.projection.name==="globe"?t.dT():0,Ve=U.projection.name==="globe",Oe=Ve?t.ah(U.zoom):0,Ke=[t.ay(U.center.lng),t.aH(U.center.lat)],Qe=a.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",It=a.paint.get("fill-extrusion-flood-light-color").toRenderColor(Qe?null:a.lut).toArray01().slice(0,3),gt=a.paint.get("fill-extrusion-flood-light-intensity"),jt=a.paint.get("fill-extrusion-vertical-scale"),Ut=a.paint.get("fill-extrusion-line-width").constantOr(1)!==0,fi=a.paint.get("fill-extrusion-height-alignment"),vt=a.paint.get("fill-extrusion-base-alignment"),Ct=hu(p,a.paint.get("fill-extrusion-cutoff-fade-range")),_t=[],qt;Ve&&_t.push("PROJECTION_GLOBE_VIEW"),be[0]>0&&_t.push("FAUX_AO"),Re&&_t.push("ZERO_ROOF_RADIUS"),C&&_t.push("HAS_CENTROID"),gt>0&&_t.push("FLOOD_LIGHT"),Ct.shouldRenderCutoff&&_t.push("RENDER_CUTOFF"),Ut&&_t.push("RENDER_WALL_MODE");let Pt=p.renderPass==="shadow",ti=p.shadowRenderer,Gt=Pt&&!!ti,ii=Pt?ln.disabled:ln.backCCW;p.shadowRenderer&&(p.shadowRenderer.useNormalOffset=!0);let oi=[0,0,0];if(ti){let zi=p.style.directionalLight,$i=p.style.ambientLight;zi&&$i&&(oi=Ol(p.style,zi,$i)),Pt||(_t.push("RENDER_SHADOWS","DEPTH_TEXTURE"),ti.useNormalOffset&&_t.push("NORMAL_OFFSET")),qt=_t.concat(["SHADOWS_SINGLE_CASCADE"])}let ki=Gt?"fillExtrusionDepth":se?"fillExtrusionPattern":"fillExtrusion",ji=a.getLayerRenderingStats();for(let zi of f){let $i=i.getTile(zi),Oi=$i.getBucket(a);if(!Oi||Oi.projection.name!==U.projection.name)continue;let nn=!1;ti&&(nn=ti.getMaxCascadeForTile(zi.toUnwrapped())===0);let xn=p.isTileAffectedByFog(zi),Bn=Oi.programConfigurations.get(a.id),Er=!1;if(X&&$i.imageAtlas){let pr=$i.imageAtlas,Or=t.dN.from(X),xs=Or.getPrimary().scaleSelf(t.q.devicePixelRatio).toString(),Lo=Or.getSecondary(),ko=pr.patternPositions.get(xs),ro=Lo?pr.patternPositions.get(Lo.scaleSelf(t.q.devicePixelRatio).toString()):null;Er=!!ko&&!!ro,ko&&Bn.setConstantPatternPositions(ko,ro)}Z>0&&(Er||Bn.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&_t.push("FILL_EXTRUSION_PATTERN_TRANSITION");let zr=p.getOrCreateProgram(ki,{config:Bn,defines:nn?qt:_t,overrideFog:xn});if(p.terrain&&p.terrain.setupElevationDraw($i,zr,{useMeterToDem:!0}),!Oi.centroidVertexBuffer){let pr=zr.attributes.a_centroid_pos;pr!==void 0&&N.vertexAttrib2f(pr,0,0)}!Pt&&ti&&ti.setupShadows($i.tileID.toUnwrapped(),zr,"vector-tile",$i.tileID.overscaledZ),se&&(p.context.activeTexture.set(N.TEXTURE0),$i.imageAtlasTexture&&$i.imageAtlasTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE),Bn.updatePaintBuffers());let Gn=a.paint.get("fill-extrusion-vertical-gradient"),po=1/Oi.tileToMeter,no;if(Pt&&ti){if(ys($i.tileID,Oi,p))continue;let pr=ti.calculateShadowPassMatrixFromTile($i.tileID.toUnwrapped());no=Qa(pr,Ge,po,jt,fi,vt)}else{let pr=p.translatePosMatrix(zi.expandedProjMatrix,$i,a.paint.get("fill-extrusion-translate"),a.paint.get("fill-extrusion-translate-anchor")),Or=U.projection.createInversionMatrix(U,zi.canonical);no=se?Yu(pr,p,Gn,re,be,Ge,po,zi,$i,Ne,fi,vt,Oe,Ke,Or,It,jt,Z):Nh(pr,p,Gn,re,be,Ge,po,zi,Ne,fi,vt,Oe,Ke,Or,It,jt,gt,oi)}p.uploadCommonUniforms(z,zr,zi.toUnwrapped(),null,Ct);let En=Oi.segments;if(U.projection.name==="mercator"&&!Pt&&(En=Oi.getVisibleSegments($i.tileID,p.terrain,p.transform.getFrustum(0)),!En.get().length))continue;if(ji)if(Pt)for(let pr of En.get())ji.numRenderedVerticesInShadowPass+=pr.primitiveLength;else for(let pr of En.get())ji.numRenderedVerticesInTransparentPass+=pr.primitiveLength;let cr=[];(p.terrain||C)&&cr.push(Oi.centroidVertexBuffer),Ve&&cr.push(Oi.layoutVertexExtBuffer),Ut&&cr.push(Oi.wallVertexBuffer),zr.draw(p,z.gl.TRIANGLES,g,v,S,ii,no,a.id,Oi.layoutVertexBuffer,Oi.indexBuffer,En,a.paint,p.transform.zoom,Bn,cr)}p.shadowRenderer&&(p.shadowRenderer.useNormalOffset=!1)}function Zh(p,i,a,f,g,v,S,C,z,N,U,$,Z,X,se,re,he,ae,be){let Pe=p.context,Re=Pe.gl,Ge=p.transform,Ne=p.transform.zoom,Ve=[],Oe=hu(p,a.paint.get("fill-extrusion-cutoff-fade-range"));N==="clear"?(Ve.push("CLEAR_SUBPASS"),be&&(Ve.push("CLEAR_FROM_TEXTURE"),Pe.activeTexture.set(Re.TEXTURE0),be.bind(Re.LINEAR,Re.CLAMP_TO_EDGE))):N==="sdf"&&Ve.push("SDF_SUBPASS"),he&&Ve.push("HAS_CENTROID"),Oe.shouldRenderCutoff&&Ve.push("RENDER_CUTOFF");let Ke=a.layout.get("fill-extrusion-edge-radius"),Qe=(It,gt,jt,Ut,fi)=>{let vt=gt.programConfigurations.get(a.id),Ct=p.isTileAffectedByFog(It),_t=p.getOrCreateProgram("fillExtrusionGroundEffect",{config:vt,defines:Ve,overrideFog:Ct}),qt=((ti,Gt,ii,oi,ki,ji,zi,$i,Oi,nn,xn)=>({u_matrix:Gt,u_opacity:ii,u_ao_pass:oi?1:0,u_meter_to_tile:ki,u_ao:ji,u_flood_light_intensity:zi,u_flood_light_color:$i,u_attenuation:Oi,u_edge_radius:nn,u_fb:0,u_fb_size:xn,u_dynamic_offset:1}))(0,Ut,U,z,fi,[$,Z*fi],X,se,re,Ne>=17?0:Ke*fi,be?be.size[0]:0),Pt=[];he&&Pt.push(gt.hiddenByLandmarkVertexBuffer),p.uploadCommonUniforms(Pe,_t,It.toUnwrapped(),null,Oe),_t.draw(p,Pe.gl.TRIANGLES,g,v,S,C,qt,a.id,gt.vertexBuffer,gt.indexBuffer,jt,a.paint,Ne,vt,Pt)};for(let It of f){let gt=i.getTile(It),jt=gt.getBucket(a);if(!jt||jt.projection.name!==Ge.projection.name||!jt.groundEffect||jt.groundEffect&&!jt.groundEffect.hasData())continue;let Ut=jt.groundEffect,fi=1/jt.tileToMeter;{let vt=p.translatePosMatrix(It.projMatrix,gt,a.paint.get("fill-extrusion-translate"),a.paint.get("fill-extrusion-translate-anchor")),Ct=Ut.getDefaultSegment();Qe(It,Ut,Ct,vt,fi)}if(ae)for(let vt=0;vt<4;vt++){let Ct=t.dU[vt](It),_t=i.getTile(Ct);if(!_t)continue;let qt=_t.getBucket(a);if(!qt||qt.projection.name!==Ge.projection.name||!qt.groundEffect||qt.groundEffect&&!qt.groundEffect.hasData())continue;let Pt=qt.groundEffect,ti,Gt;vt===0?(ti=[-t.aj,0,0],Gt=1):vt===1?(ti=[t.aj,0,0],Gt=0):vt===2?(ti=[0,-t.aj,0],Gt=3):(ti=[0,t.aj,0],Gt=2);let ii=Pt.regionSegments[Gt];if(!ii)continue;let oi=new Float32Array(16);t.bo(oi,It.projMatrix,ti),Qe(It,Pt,ii,p.translatePosMatrix(oi,gt,a.paint.get("fill-extrusion-translate"),a.paint.get("fill-extrusion-translate-anchor")),fi)}}}function ds(p,i,a,f,g,v,S){f.centroidVertexArray.length===0&&f.createCentroidsBuffer();let C=v?v.findDEMTileFor(a):null;if(!(C&&C.dem||S))return;v&&C&&C.dem&&f.selfDEMTileTimestamp!==C.dem._timestamp&&(f.borderDoneWithNeighborZ=[-1,-1,-1,-1],f.selfDEMTileTimestamp=C.dem._timestamp);let z=ae=>new t.P(Math.ceil((ae+t.dX)*t.dY),0),N=ae=>{let be=i.getSource().minzoom,Pe=Ge=>{let Ne=i.getTileByID(Ge);if(Ne&&Ne.hasData())return Ne.getBucket(g)},Re=[0,-1,1];for(let Ge of Re){if(ae.overscaledZ+Ge<be)continue;let Ne=Pe(ae.calculateScaledKey(ae.overscaledZ+Ge));if(Ne)return Ne}},U=[0,0,0],$=(ae,be)=>(U[0]=Math.min(ae.min.y,be.min.y),U[1]=Math.max(ae.max.y,be.max.y),U[2]=t.aj-be.min.x>ae.max.x?be.min.x-t.aj:ae.max.x,U),Z=(ae,be)=>(U[0]=Math.min(ae.min.x,be.min.x),U[1]=Math.max(ae.max.x,be.max.x),U[2]=t.aj-be.min.y>ae.max.y?be.min.y-t.aj:ae.max.y,U),X=[(ae,be)=>$(ae,be),(ae,be)=>$(be,ae),(ae,be)=>Z(ae,be),(ae,be)=>Z(be,ae)],se=(ae,be,Pe,Re,Ge,Ne,Ve)=>{if(!v)return 0;let Oe=[[Ne?Pe:ae,Ne?ae:Pe,0],[Ne?Pe:be,Ne?be:Pe,0]],Ke=Ve<0?t.aj+Ve:Ve,Qe=[Ne?Ke:(ae+be)/2,Ne?(ae+be)/2:Ke,0];return Pe===0&&Ve<0||Pe!==0&&Ve>0?v.getForTilePoints(Ge,[Qe],!0,Re):Oe.push(Qe),v.getForTilePoints(a,Oe,!0,C),Math.max(Oe[0][2],Oe[1][2],Qe[2])/v.exaggeration()};for(let ae=0;ae<4;ae++){let be=f.borderFeatureIndices[ae];if(be.length===0)continue;let Pe=t.dU[ae](a),Re=N(Pe);if(!(Re&&Re instanceof t.dV))continue;let Ge=v?v.findDEMTileFor(Pe):null;if(!(Ge&&Ge.dem||S)||(v&&Ge&&Ge.dem&&f.borderDEMTileTimestamp[ae]!==Ge.dem._timestamp&&(f.borderDoneWithNeighborZ[ae]=-1,f.borderDEMTileTimestamp[ae]=Ge.dem._timestamp),f.borderDoneWithNeighborZ[ae]===Re.canonical.z))continue;Re.centroidVertexArray.length===0&&Re.createCentroidsBuffer();let Ne=(ae<2?1:5)-ae,Ve=Re.borderDoneWithNeighborZ[Ne]!==f.canonical.z,Oe=Re.borderFeatureIndices[Ne],Ke=0;if(f.canonical.z!==Re.canonical.z){for(let Qe of be)f.showCentroid(f.featuresOnBorder[Qe]);if(Ve)for(let Qe of Oe)Re.showCentroid(Re.featuresOnBorder[Qe]);f.borderDoneWithNeighborZ[ae]=Re.canonical.z,Re.borderDoneWithNeighborZ[Ne]=f.canonical.z}for(let Qe of be){let It=f.featuresOnBorder[Qe],gt=f.centroidData[It.centroidDataIndex],jt=It.borders[ae],Ut;for(;Ke<Oe.length;){Ut=Re.featuresOnBorder[Oe[Ke]];let fi=Ut.borders[Ne];if(fi[1]>jt[0]+3||fi[0]>jt[0]-3)break;Re.showCentroid(Ut),Ke++}if(Ut&&Ke<Oe.length){let fi=Ke,vt=0;for(;!(Ut.borders[Ne][0]>jt[1]-3)&&(vt++,++Ke!==Oe.length);)Ut=Re.featuresOnBorder[Oe[Ke]];Ut=Re.featuresOnBorder[Oe[fi]];let Ct=!1;if(vt>=1){let Pt=Ut.borders[Ne];Math.abs(jt[0]-Pt[0])<3&&Math.abs(jt[1]-Pt[1])<3&&(vt=1,Ct=!0,Ke=fi+1)}else if(vt===0){f.showCentroid(It);continue}let _t=Re.centroidData[Ut.centroidDataIndex];S&&Ct&&(((re=gt).flags|(he=_t).flags)&t.dW?(re.flags|=t.dW,he.flags|=t.dW):(re.flags&=~t.dW,he.flags&=~t.dW));let qt=It.intersectsCount()>1||Ut.intersectsCount()>1;if(vt>1)Ke=fi,gt.centroidXY=_t.centroidXY=new t.P(0,0);else if(Ge&&Ge.dem&&!qt){let Pt=X[ae](gt,_t),ti=ae%2?t.aj-1:0,Gt=se(Pt[0],Math.min(t.aj-1,Pt[1]),ti,Ge,Pe,ae<2,Pt[2]);gt.centroidXY=_t.centroidXY=z(Gt)}else qt?gt.centroidXY=_t.centroidXY=new t.P(0,0):(gt.centroidXY=f.encodeBorderCentroid(It),_t.centroidXY=Re.encodeBorderCentroid(Ut));f.writeCentroidToBuffer(gt),Re.writeCentroidToBuffer(_t)}else f.showCentroid(It)}f.borderDoneWithNeighborZ[ae]=Re.canonical.z,Re.borderDoneWithNeighborZ[Ne]=f.canonical.z}var re,he;(f.needsCentroidUpdate||!f.centroidVertexBuffer&&f.centroidVertexArray.length!==0)&&f.uploadCentroid(p)}let yh=[1,0,0],tn=[0,1,0],Wo=[0,0,1];function ys(p,i,a){let f=a.transform,g=a.shadowRenderer;if(!g)return!0;let v=p.toUnwrapped(),S=f.tileSize*g._cascades[a.currentShadowCascade].scale,C=i.maxHeight;if(f.elevation){let re=f.elevation.getMinMaxForTile(p);re&&(C+=re.max)}let z=[...g.shadowDirection];z[2]=-z[2];let N=g.computeSimplifiedTileShadowVolume(v,C,S,z);if(!N)return!1;let U=[yh,tn,Wo,z,[z[0],0,z[2]],[0,z[1],z[2]]],$=f.projection.name==="globe",Z=f.scaleZoom(S),X=t.cn.fromInvProjectionMatrix(f.invProjMatrix,f.worldSize,Z,!$),se=g.getCurrentCascadeFrustum();return X.intersectsPrecise(N.vertices,N.planes,U)===0||se.intersectsPrecise(N.vertices,N.planes,U)===0}function ff(p){return[p[0]*t.dZ,p[1]*t.dZ,p[2]*t.dZ,0]}function Ul(p,i,a,f,g,v,S,C,z){let N=f.getSource(),U=a.globeSharedBuffers;if(!U)return;let $,Z,X;if(i&&($=f.getTile(i)),N instanceof t.aP?(Z=N.texture,X=t.ds(0,0,a.transform)):$&&i&&(Z=$.texture,X=t.ds(i.canonical.z,i.canonical.x,a.transform)),!Z||!X)return;p||(X=t.cE(t.bz(),X,[1,-1,1]));let se=a.context,re=se.gl,he=g.paint.get("raster-resampling")==="nearest"?re.NEAREST:re.LINEAR,ae=a.colorModeForDrapableLayerRenderPass(v),be=S.defines;be.push("GLOBE_POLES");let Pe=new Li(re.LEQUAL,Li.ReadWrite,a.depthRangeFor3D),Re=Float32Array.from(a.transform.expandedFarZProjMatrix),Ge=Float32Array.from(t.bh(t.dr(new t.cp(0,0,0))));a.terrain&&a.terrain.prepareDrawTile(),se.activeTexture.set(re.TEXTURE0),Z.bind(he,re.CLAMP_TO_EDGE),se.activeTexture.set(re.TEXTURE1),Z.bind(he,re.CLAMP_TO_EDGE),"useMipmap"in Z&&se.extTextureFilterAnisotropic&&a.transform.pitch>20&&re.texParameterf(re.TEXTURE_2D,se.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,se.extTextureFilterAnisotropicMax);let[Ne,Ve,Oe,Ke]=i?U.getPoleBuffers(i.canonical.z,!1):U.getPoleBuffers(0,!0),Qe=g.paint.get("raster-elevation"),It;p?(It=Ne,a.renderDefaultNorthPole=Qe!==0):(It=Ve,a.renderDefaultSouthPole=Qe!==0);let gt=ff(S.mix),jt=((fi,vt,Ct,_t,qt,Pt,ti,Gt,ii,oi,ki,ji,zi)=>gl(fi,vt,Ct,new Float32Array(16),new Float32Array(9),[0,0],_t,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Pt,[0,0],Gt,2,oi,ki,ji,1,0,zi))(Re,Ge,X,t.ah(a.transform.zoom),0,g,0,Qe,0,gt,S.offset,S.range,v),Ut=a.getOrCreateProgram("raster",{defines:be});a.uploadCommonUniforms(se,Ut,null),Ut.draw(a,re.TRIANGLES,Pe,z,ae,C,jt,g.id,It,Oe,Ke)}function xh(p){let i=p._nearZ,a=p.projection.farthestPixelDistance(p),f=a-i,g=.2*p.height,v=i+g;return[i,a,(v-g-i)/f,(v-i)/f]}function mf(p,i,a,f){if(p)return i instanceof Eh&&p instanceof tc?i.getTextureDescriptor(p,a,!0):{texture:p.texture,mix:ff(f.mix),offset:f.offset,buffer:0,tileSize:1}}var Qd=t.d_([{name:"a_index",type:"Int16",components:1}]);class Tu{constructor(i,a,f,g){let v={width:f[0],height:f[1],data:null},S=i.gl;this.targetColorTexture=new t.T(i,v,S.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new t.T(i,v,S.RGBA8,{useMipmap:!1}),this.context=i,this.updateParticleTexture(a,g),this.lastInvalidatedAt=0}updateParticleTexture(i,a){if(this.particleTextureDimension===a.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());let f=this.context.gl,g=a.width*a.height;this.particleTexture0=new t.T(this.context,a,f.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new t.T(this.context,a,f.RGBA8,{premultiply:!1,useMipmap:!1});let v=new t.d$;v.reserve(g);for(let S=0;S<g;S++)v.emplaceBack(S);this.particleIndexBuffer=this.context.createVertexBuffer(v,Qd.members,!0),this.particleSegment=t.bd.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=a.width}update(i){return!(this.lastInvalidatedAt<i&&(this.lastInvalidatedAt=t.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function ep(p,i,a){if(!p)return null;let f=i.getTextureDescriptor(p,a,!0);if(!f)return null;let{texture:g,mix:v,offset:S,tileSize:C,buffer:z,format:N}=f;if(!g||!N)return null;let U=!1;return N==="uint32"&&(U=!0,v[3]=0,v=$d(t.e0,v,[0,a.paint.get("raster-particle-max-speed")]),S=Vh(t.e0,S,[0,a.paint.get("raster-particle-max-speed")])),{texture:g,textureOffset:[z/(C+2*z),C/(C+2*z)],tileSize:C,scalarData:U,scale:v,offset:S,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[N]]}}function tp(p){let i=p._nearZ,a=p.projection.farthestPixelDistance(p),f=a-i,g=.2*p.height,v=i+g;return[i,a,(v-g-i)/f,(v-i)/f]}let rd=new t.am(1,0,0,1),ip=new t.am(0,1,0,1),M=new t.am(0,0,1,1),r=new t.am(1,0,1,1),h=new t.am(0,1,1,1);function x(p,i,a,f,g,v,S){let C=p.context,z=p.transform,N=C.gl,U=z.projection.name==="globe",$=U?["PROJECTION_GLOBE_VIEW"]:[],Z=t.bw(a.projMatrix);if(U&&t.ah(z.zoom)>0){let gt=t.bg(a.canonical,z),jt=t.e1(gt);Z=t.az(new Float32Array(16),z.globeMatrix,jt),t.az(Z,z.projMatrix,Z)}let X=t.bz();X[12]+=2*g/(t.q.devicePixelRatio*z.width),X[13]+=2*v/(t.q.devicePixelRatio*z.height),t.az(Z,X,Z);let se=p.getOrCreateProgram("debug",{defines:$}),re=i.getTileByID(a.key);p.terrain&&p.terrain.setupElevationDraw(re,se);let he=Li.disabled,ae=hn.disabled,be=p.colorModeForRenderPass(),Pe="$debug";C.activeTexture.set(N.TEXTURE0),p.emptyTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE),U?re._makeGlobeTileDebugBuffers(p.context,z):re._makeDebugTileBoundsBuffers(p.context,z.projection);let Re=re._tileDebugBuffer||p.debugBuffer,Ge=re._tileDebugIndexBuffer||p.debugIndexBuffer,Ne=re._tileDebugSegments||p.debugSegments;if(se.draw(p,N.LINE_STRIP,he,ae,be,ln.disabled,sn(Z,f),Pe,Re,Ge,Ne,null,null,null,[re._globeTileDebugBorderBuffer]),S){let gt=re.latestRawTileData,jt=Math.floor((gt&&gt.byteLength||0)/1024),Ut=a.canonical.toString();a.overscaledZ!==a.canonical.z&&(Ut+=` => ${a.overscaledZ}`),Ut+=` ${re.state}`,Ut+=` ${jt}kb`,function(fi,vt){fi.initDebugOverlayCanvas();let Ct=fi.debugOverlayCanvas,_t=fi.context.gl,qt=fi.debugOverlayCanvas.getContext("2d");qt.clearRect(0,0,Ct.width,Ct.height),qt.shadowColor="white",qt.shadowBlur=2,qt.lineWidth=1.5,qt.strokeStyle="white",qt.textBaseline="top",qt.font="bold 36px Open Sans, sans-serif",qt.fillText(vt,5,5),qt.strokeText(vt,5,5),fi.debugOverlayTexture.update(Ct),fi.debugOverlayTexture.bind(_t.LINEAR,_t.CLAMP_TO_EDGE)}(p,Ut)}let Ve=i.getTile(a).tileSize,Oe=512/Math.min(Ve,512)*(a.overscaledZ/z.zoom)*.5,Ke=re._tileDebugTextBuffer||p.debugBuffer,Qe=re._tileDebugTextIndexBuffer||p.quadTriangleIndexBuffer,It=re._tileDebugTextSegments||p.debugSegments;se.draw(p,N.TRIANGLES,he,ae,Tn.alphaBlended,ln.disabled,sn(Z,t.am.transparent,Oe),Pe,Ke,Qe,It,null,null,null,[re._globeTileDebugTextBuffer])}function w(p,i,a,f){k(p,0,i+a/2,p.transform.width,a,f)}function A(p,i,a,f){k(p,i-a/2,0,a,p.transform.height,f)}function k(p,i,a,f,g,v){let S=p.context,C=S.gl;C.enable(C.SCISSOR_TEST),C.scissor(i*t.q.devicePixelRatio,a*t.q.devicePixelRatio,f*t.q.devicePixelRatio,g*t.q.devicePixelRatio),S.clear({color:v}),C.disable(C.SCISSOR_TEST)}let j=t.d_([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:q}=j;function J(p,i,a,f){p.emplaceBack(i,a,f)}class ne{constructor(i){this.vertexArray=new t.e2,this.indices=new t.a_,J(this.vertexArray,-1,-1,1),J(this.vertexArray,1,-1,1),J(this.vertexArray,-1,1,1),J(this.vertexArray,1,1,1),J(this.vertexArray,-1,-1,-1),J(this.vertexArray,1,-1,-1),J(this.vertexArray,-1,1,-1),J(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=i.createVertexBuffer(this.vertexArray,q),this.indexBuffer=i.createIndexBuffer(this.indices),this.segment=t.bd.simpleSegment(0,0,36,12)}}function pe(p,i,a,f,g,v){let S=p.context.gl,C=i.paint.get("sky-atmosphere-color"),z=i.paint.get("sky-atmosphere-halo-color"),N=i.paint.get("sky-atmosphere-sun-intensity"),U=(($,Z,X,se,re)=>({u_matrix_3f:$,u_sun_direction:Z,u_sun_intensity:X,u_color_tint_r:[se.r,se.g,se.b,se.a],u_color_tint_m:[re.r,re.g,re.b,re.a],u_luminance:5e-5}))(t.e4(t.dx(),f),g,N,C,z);S.framebufferTexture2D(S.FRAMEBUFFER,S.COLOR_ATTACHMENT0,S.TEXTURE_CUBE_MAP_POSITIVE_X+v,i.skyboxTexture,0),a.draw(p,S.TRIANGLES,Li.disabled,hn.disabled,Tn.unblended,ln.frontCW,U,"skyboxCapture",i.skyboxGeometry.vertexBuffer,i.skyboxGeometry.indexBuffer,i.skyboxGeometry.segment)}let ue=t.d_([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class ge{constructor(i){let a=new t.e5;a.emplaceBack(-1,1,1,0,0),a.emplaceBack(1,1,1,1,0),a.emplaceBack(1,-1,1,1,1),a.emplaceBack(-1,-1,1,0,1);let f=new t.a_;f.emplaceBack(0,1,2),f.emplaceBack(2,3,0),this.vertexBuffer=i.createVertexBuffer(a,ue.members),this.indexBuffer=i.createIndexBuffer(f),this.segments=t.bd.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}let Ee=t.d_([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class tt{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Xe{constructor(i){this.colorModeAlphaBlendedWriteRGB=new Tn([1,Ia,1,Ia],t.am.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new Tn([1,0,1,0],t.am.transparent,[!1,!1,!1,!0]),this.params=new tt,this.updateNeeded=!0,i.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),i.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),i.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),i.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(i){let a=i.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new ge(a);let f=this.params.sizeRange,g=this.params.intensityRange,v=function(U){let $=t.ea(30),Z=[];for(let X=0;X<U;++X){let se=2*Math.PI*$(),re=Math.acos(1-2*$())-.5*Math.PI;Z.push(t.cS(Math.cos(re)*Math.cos(se),Math.cos(re)*Math.sin(se),Math.sin(re)))}return Z}(this.params.starsCount),S=t.ea(300),C=new t.e6,z=new t.a_,N=0;for(let U=0;U<v.length;++U){let $=t.b$([],v[U],200),Z=Math.max(0,1+.01*f*(1*S()-.5)),X=Math.max(0,1+.01*g*(1*S()-.5));C.emplaceBack($[0],$[1],$[2],-1,-1,Z,X),C.emplaceBack($[0],$[1],$[2],1,-1,Z,X),C.emplaceBack($[0],$[1],$[2],1,1,Z,X),C.emplaceBack($[0],$[1],$[2],-1,1,Z,X),z.emplaceBack(N+0,N+1,N+2),z.emplaceBack(N+0,N+2,N+3),N+=4}this.starsVx=a.createVertexBuffer(C,Ee.members),this.starsIdx=a.createIndexBuffer(z),this.starsSegments=t.bd.simpleSegment(0,0,C.length,z.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(i,a){let f=i.context,g=f.gl,v=i.transform,S=new Li(g.LEQUAL,Li.ReadOnly,[0,1]),C=t.ah(v.zoom),z=i.style.getLut(a.scope),N=a.properties.get("color-use-theme")==="none",U=a.properties.get("color").toRenderColor(N?null:z).toArray01(),$=a.properties.get("high-color-use-theme")==="none",Z=a.properties.get("high-color").toRenderColor($?null:z).toArray01(),X=a.properties.get("space-color-use-theme")==="none",se=a.properties.get("space-color").toRenderColor(X?null:z).toArray01PremultipliedAlpha(),re=5e-4,he=t.e7(a.properties.get("horizon-blend"),0,1,re,.25),ae=t.dl(i,f,v)&&he===re?v.worldSize/(2*Math.PI*1.025)-1:v.globeRadius,be=i.frameCounter/1e3%1,Pe=t.ae(v.globeCenterInViewSpace),Re=Math.sqrt(Math.pow(Pe,2)-Math.pow(ae,2)),Ge=Math.acos(Re/Pe),Ne=Ve=>{let Oe=v.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];Ve&&Oe.push("ALPHA_PASS");let Ke=i.getOrCreateProgram("globeAtmosphere",{defines:Oe}),Qe=((gt,jt,Ut,fi,vt,Ct,_t,qt,Pt,ti,Gt,ii)=>({u_frustum_tl:gt,u_frustum_tr:jt,u_frustum_br:Ut,u_frustum_bl:fi,u_horizon:vt,u_transition:Ct,u_fadeout_range:_t,u_color:qt,u_high_color:Pt,u_space_color:ti,u_temporal_offset:Gt,u_horizon_angle:ii}))(v.frustumCorners.TL,v.frustumCorners.TR,v.frustumCorners.BR,v.frustumCorners.BL,v.frustumCorners.horizon,C,he,U,Z,se,be,Ge);i.uploadCommonUniforms(f,Ke);let It=this.atmosphereBuffer;It&&Ke.draw(i,g.TRIANGLES,S,hn.disabled,Ve?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,ln.backCW,Qe,Ve?"atmosphere_glow_alpha":"atmosphere_glow",It.vertexBuffer,It.indexBuffer,It.segments)};Ne(!1),Ne(!0)}drawStars(i,a){let f=t.aD(a.properties.get("star-intensity"),0,1);if(f===0)return;let g=i.context,v=g.gl,S=i.transform,C=i.getOrCreateProgram("stars"),z=t.bY([]);t.b_(z,z,-S._pitch),t.bZ(z,z,-S.angle),t.b_(z,z,t.al(S._center.lat)),t.e8(z,z,-t.al(S._center.lng));let N=t.c3(new Float32Array(16),z),U=t.az([],S.starsProjMatrix,N),$=t.e4([],N),Z=t.e9([],$),X=[0,1,0];t.dz(X,X,Z),t.b$(X,X,this.params.sizeMultiplier);let se=[1,0,0];t.dz(se,se,Z),t.b$(se,se,this.params.sizeMultiplier);let re=(he=X,ae=se,be=f,{u_matrix:Float32Array.from(U),u_up:he,u_right:ae,u_intensity_multiplier:be});var he,ae,be;i.uploadCommonUniforms(g,C),this.starsVx&&this.starsIdx&&C.draw(i,v.TRIANGLES,Li.disabled,hn.disabled,this.colorModeAlphaBlendedWriteRGB,ln.disabled,re,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function et(p,i){let a=[...p],f=i.cameraWorldSizeForFog/i.worldSize,g=t.bx([]);return t.cE(g,g,[f,f,1]),t.az(a,g,a),t.az(a,i.worldToFogMatrix,a),a}function Se(p,i,a,f,g){let v=a.material,S=f.context,{baseColorTexture:C,metallicRoughnessTexture:z}=v.pbrMetallicRoughness,{normalTexture:N,occlusionTexture:U,emissionTexture:$}=v;function Z(se,re,he){if(se&&(p.push(re),S.activeTexture.set(S.gl.TEXTURE0+he),se.gfxTexture)){let{minFilter:ae,magFilter:be,wrapS:Pe,wrapT:Re}=se.sampler;se.gfxTexture.bindExtraParam(ae,be,Pe,Re)}}Z(C,"HAS_TEXTURE_u_baseColorTexture",ws.BaseColor),Z(z,"HAS_TEXTURE_u_metallicRoughnessTexture",ws.MetallicRoughness),Z(N,"HAS_TEXTURE_u_normalTexture",ws.Normal),Z(U,"HAS_TEXTURE_u_occlusionTexture",ws.Occlusion),Z($,"HAS_TEXTURE_u_emissionTexture",ws.Emission),g&&(g.texture||(g.texture=new t.ed(f.context,g.image,[g.image.height,g.image.height,g.image.height],S.gl.RGBA8)),S.activeTexture.set(S.gl.TEXTURE0+ws.LUT),g.texture&&g.texture.bind(S.gl.LINEAR,S.gl.CLAMP_TO_EDGE),p.push("APPLY_LUT_ON_GPU")),a.texcoordBuffer&&(p.push("HAS_ATTRIBUTE_a_uv_2f"),i.push(a.texcoordBuffer)),a.colorBuffer&&(p.push(a.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),i.push(a.colorBuffer)),a.normalBuffer&&(p.push("HAS_ATTRIBUTE_a_normal_3f"),i.push(a.normalBuffer)),a.pbrBuffer&&(p.push("HAS_ATTRIBUTE_a_pbr"),p.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),i.push(a.pbrBuffer)),v.alphaMode!=="OPAQUE"&&v.alphaMode!=="MASK"||p.push("UNPREMULT_TEXTURE_IN_SHADER"),v.defined||p.push("DIFFUSE_SHADED");let X=f.shadowRenderer;X&&(p.push("RENDER_SHADOWS","DEPTH_TEXTURE"),X.useNormalOffset&&p.push("NORMAL_OFFSET"))}function Be(p,i,a,f,g,v){let S=a.paint.get("model-opacity").constantOr(1),C=i.context,z=new Li(i.context.gl.LEQUAL,Li.ReadWrite,i.depthRangeFor3D),N=i.transform,U=p.mesh,$=U.material,Z=$.pbrMetallicRoughness,X=i.style.fog,se;se=i.transform.projection.zAxisUnit==="pixels"?[...p.nodeModelMatrix]:t.az([],f.zScaleMatrix,p.nodeModelMatrix),t.az(se,f.negCameraPosMatrix,se);let re=t.bi([],se);t.ee(re,re);let he=a.paint.get("model-color-use-theme").constantOr("default")==="none",ae=a.paint.get("model-emissive-strength").constantOr(0),be=Uh(new Float32Array(p.worldViewProjection),new Float32Array(se),new Float32Array(re),null,i,S,Z.baseColorFactor.toRenderColor(null),$.emissiveFactor,Z.metallicFactor,Z.roughnessFactor,$,ae,a),Pe={defines:[]},Re=[],Ge=i.shadowRenderer;Ge&&(Ge.useNormalOffset=!1),Se(Pe.defines,Re,U,i,he?null:a.lut);let Ne=null;if(X){let Ke=et(p.nodeModelMatrix,i.transform);if(Ne=new Float32Array(Ke),N.projection.name!=="globe"){let Qe=U.aabb.min,It=U.aabb.max,[gt,jt]=X.getOpacityForBounds(Ke,Qe[0],Qe[1],It[0],It[1]);Pe.overrideFog=gt>=Ii||jt>=Ii}}let Ve=hu(i,a.paint.get("model-cutoff-fade-range"));Ve.shouldRenderCutoff&&Pe.defines.push("RENDER_CUTOFF");let Oe=i.getOrCreateProgram("model",Pe);i.uploadCommonUniforms(C,Oe,null,Ne,Ve),i.renderPass!=="shadow"&&Ge&&Ge.setupShadowsFromMatrix(p.nodeModelMatrix,Oe),Oe.draw(i,C.gl.TRIANGLES,z,g,v,U.material.doubleSided?ln.disabled:ln.backCCW,be,a.id,U.vertexBuffer,U.indexBuffer,U.segments,a.paint,i.transform.zoom,void 0,Re)}function ft(p,i,a,f,g,v,S){let C;C=p.projection.name==="globe"?t.ef(a,p):[...a],t.az(C,C,i.matrix);let z=t.az([],f,C);if(i.meshes)for(let N of i.meshes){if(N.material.alphaMode!=="BLEND"){S.push({mesh:N,depth:0,modelIndex:g,worldViewProjection:z,nodeModelMatrix:C});continue}let U=t.ad([],N.centroid,z);!p.isOrthographic&&U[2]<=0||v.push({mesh:N,depth:U[2],modelIndex:g,worldViewProjection:z,nodeModelMatrix:C})}if(i.children)for(let N of i.children)ft(p,N,a,f,g,v,S)}function dt(p,i,a,f){let g=a.shadowRenderer;if(!g)return;let v=g.getShadowPassDepthMode(),S=g.getShadowPassColorMode(),C=g.calculateShadowPassMatrixFromMatrix(i),z=td(C);a.getOrCreateProgram("modelDepth",{defines:a._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(a,a.context.gl.TRIANGLES,v,hn.disabled,S,ln.backCCW,z,f.id,p.vertexBuffer,p.indexBuffer,p.segments,f.paint,a.transform.zoom,void 0,void 0)}function xe(p,i,a){let f=i.updateZoomBasedPaintProperties(),g=function(v,S,C){let z,N,U,$=v.terrain?v.terrain.exaggeration():0;if(v.terrain&&$>0){let Z=v.terrain,X=Z.findDEMTileFor(C);X&&X.dem?z=t.el.create(Z,C,X):$=0}if($===0&&(S.terrainElevationMin=0,S.terrainElevationMax=0),$===S.validForExaggeration&&($===0||z&&z._demTile&&z._demTile.tileID===S.validForDEMTile.id&&z._dem._timestamp===S.validForDEMTile.timestamp))return!1;for(let Z in S.instancesPerModel){let X=S.instancesPerModel[Z];for(let se=0;se<X.instancedDataArray.length;++se){let re=(z?$*z.getElevationAt(0|X.instancedDataArray.float32[16*se],0|X.instancedDataArray.float32[16*se+1],!0,!0):0)+X.instancesEvaluatedElevation[se];X.instancedDataArray.float32[16*se+6]=re,N=N?Math.min(S.terrainElevationMin,re):re,U=U?Math.max(S.terrainElevationMax,re):re}}return S.terrainElevationMin=N||0,S.terrainElevationMax=U||0,S.validForExaggeration=$,S.validForDEMTile=z&&z._demTile?{id:z._demTile.tileID,timestamp:z._dem._timestamp}:{id:void 0,timestamp:0},!0}(p,i,a);(f||g)&&(i.uploaded=!1,i.upload(p.context))}let pt={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new t.cV([0,0,0],[t.aj,t.aj,0])};function zt(p,i){let a=1<<p.canonical.z,f=i.getFreeCameraOptions().position,g=i.elevation,v=p.canonical.x/a,S=(p.canonical.x+1)/a,C=p.canonical.y/a,z=(p.canonical.y+1)/a,N=i._centerAltitude;if(g){let X=g.getMinMaxForTile(p);X&&X.max>N&&(N=X.max)}let U=t.aD(f.x,v,S)-f.x,$=t.aD(f.y,C,z)-f.y,Z=t.c6(N,i.center.lat)-f.z;return i._zoomFromMercatorZ(Math.sqrt(U*U+$*$+Z*Z))}function ei(p,i,a,f,g,v,S){let C=p.context,z=p.renderPass==="shadow",N=p.shadowRenderer,U=z&&N?N.getShadowPassDepthMode():new Li(C.gl.LEQUAL,Li.ReadWrite,p.depthRangeFor3D),$=p.isTileAffectedByFog(v);if(a.meshes)for(let Z of a.meshes){let X=["MODEL_POSITION_ON_GPU"],se=[],re,he,ae;f.instancedDataArray.length>20&&X.push("INSTANCED_ARRAYS");let be=hu(p,i.paint.get("model-cutoff-fade-range"));if(be.shouldRenderCutoff&&X.push("RENDER_CUTOFF"),z&&N)re=p.getOrCreateProgram("modelDepth",{defines:X}),he=td(S.shadowTileMatrix,S.shadowTileMatrix,Float32Array.from(a.matrix)),ae=N.getShadowPassColorMode();else{Se(X,se,Z,p,i.paint.get("model-color-use-theme").constantOr("default")==="none"?null:i.lut),re=p.getOrCreateProgram("model",{defines:X,overrideFog:$});let Re=Z.material,Ge=Re.pbrMetallicRoughness,Ne=i.paint.get("model-opacity").constantOr(1),Ve=i.paint.get("model-emissive-strength").constantOr(0);he=Uh(v.expandedProjMatrix,Float32Array.from(a.matrix),new Float32Array(16),null,p,Ne,Ge.baseColorFactor.toRenderColor(null),Re.emissiveFactor,Ge.metallicFactor,Ge.roughnessFactor,Re,Ve,i,g),N&&(S.shadowUniformsInitialized?re.setShadowUniformValues(C,N.getShadowUniformValues()):(N.setupShadows(v.toUnwrapped(),re,"model-tile",v.overscaledZ),S.shadowUniformsInitialized=!0)),ae=be.shouldRenderCutoff||Ne<1||Re.alphaMode!=="OPAQUE"?Tn.alphaBlended:Tn.unblended}p.uploadCommonUniforms(C,re,v.toUnwrapped(),null,be);let Pe=Z.material.doubleSided?ln.disabled:ln.backCCW;if(f.instancedDataArray.length>20)se.push(f.instancedDataBuffer),re.draw(p,C.gl.TRIANGLES,U,hn.disabled,ae,Pe,he,i.id,Z.vertexBuffer,Z.indexBuffer,Z.segments,i.paint,p.transform.zoom,void 0,se,f.instancedDataArray.length);else{let Re=z?"u_instance":"u_normal_matrix";for(let Ge=0;Ge<f.instancedDataArray.length;++Ge)he[Re]=new Float32Array(f.instancedDataArray.arrayBuffer,64*Ge,16),re.draw(p,C.gl.TRIANGLES,U,hn.disabled,ae,Pe,he,i.id,Z.vertexBuffer,Z.indexBuffer,Z.segments,i.paint,p.transform.zoom,void 0,se)}}if(a.children)for(let Z of a.children)ei(p,i,Z,f,g,v,S)}let Kt=[1,-1,1];function Jt(p,i,a,f){if(!a.modelManager)return!0;let g=a.modelManager;if(!a.shadowRenderer)return!0;let v=a.shadowRenderer,S=i.aabb,C=!0,z=p.maxHeight;if(z===0){let U=0;for(let $ in p.instancesPerModel){let Z=g.getModel($,f);Z?U=Math.max(U,Math.max(Math.max(Z.aabb.max[0],Z.aabb.max[1]),Z.aabb.max[2])):C=!1}z=p.maxScale*U*1.41+p.maxVerticalOffset,C&&(p.maxHeight=z)}S.max[2]=z,S.min[2]+=p.terrainElevationMin,S.max[2]+=p.terrainElevationMax,t.ad(S.min,S.min,i.tileMatrix),t.ad(S.max,S.max,i.tileMatrix);let N=S.intersects(v.getCurrentCascadeFrustum());return a.currentShadowCascade===0&&(p.isInsideFirstShadowMapFrustum=N===2),N===0}function si(p,i){let a=p.uniformValues.u_cutoff_params[0],f=p.uniformValues.u_cutoff_params[1],g=p.uniformValues.u_cutoff_params[2],v=p.uniformValues.u_cutoff_params[3];return f===a||v===g?1:t.aD(((i-a)/(f-a)-g)/(v-g),0,1)}function Xi(p,i,a,f){if(i.pitch<20)return 1;let g=i.getWorldToCameraMatrix();t.az(g,g,p);let v=t.ei(a.min[0],a.min[1],a.min[2],1),S=t.aA(t.ej(),v,g),C=S,z=S;v[1]=a.max[1],S=t.aA(t.ej(),v,g),C=S[1]<C[1]?S:C,z=S[1]>z[1]?S:z,v[0]=a.max[0],S=t.aA(t.ej(),v,g),C=S[1]<C[1]?S:C,z=S[1]>z[1]?S:z,v[1]=a.min[1],S=t.aA(t.ej(),v,g),C=S[1]<C[1]?S:C,z=S[1]>z[1]?S:z;let N=t.aD(f[0],0,1),U=100*i.pixelsPerMeter*t.aD(f[1],0,1),$=t.aD(f[2],0,1),Z=t.ek(t.ej(),C,z,N),X=Math.tan(.5*i.fovX),se=-Z[2]*X;if(U===0)return Z[1]<-Math.abs(se)?$:1;let re=(-Math.abs(se)-Z[1])/U,he=(be,Pe,Re)=>(1-Re)*be+Re*Pe,ae=t.aD(he(1,$,re),$,1);return he(1,ae,t.aD((i.pitch-20)/20,0,1))}class Ki{}class Pi{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(i,a,f){{let $=this._storage.get(a.id);if($)return $.lastUsedFrameIdx=i,$.buf}let g=f.gl,v=g.getBufferParameter(g.ELEMENT_ARRAY_BUFFER,g.BUFFER_SIZE),S=new ArrayBuffer(v),C=new Int16Array(S);g.getBufferSubData(g.ELEMENT_ARRAY_BUFFER,0,new Int16Array(S));let z=new t.en;for(let $=0;$<v/2;$+=3){let Z=C[$],X=C[$+1],se=C[$+2];z.emplaceBack(Z,X),z.emplaceBack(X,se),z.emplaceBack(se,Z)}let N=f.bindVertexArrayOES.current,U=new Ki;return U.buf=new Yd(f,z),U.lastUsedFrameIdx=i,this._storage.set(a.id,U),f.bindVertexArrayOES.set(N),U.buf}update(i){for(let[a,f]of this._storage)i-f.lastUsedFrameIdx>30&&(f.buf.destroy(),this._storage.delete(a))}destroy(){for(let[i,a]of this._storage)a.buf.destroy(),this._storage.delete(i)}}class yn{constructor(i){this.occluderSize=30,this.depthOffset=-1e-4,i.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),i.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}let xr=t.d_([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Kr{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class Ho{constructor(i,a){this.revealStart=11,this.revealRange=2,i.registerParameter(this,[...a,"Reveal"],"revealStart",{min:0,max:17,step:.05}),i.registerParameter(this,[...a,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}let Eo=t.d_([{type:"Float32",name:"a_pos_2f",components:2}]);class Go{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(i,a){let f=i.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){let S=new t.eo,C=new t.a_;S.emplaceBack(-1,-1),S.emplaceBack(1,-1),S.emplaceBack(1,1),S.emplaceBack(-1,1),C.emplaceBack(0,1,2),C.emplaceBack(0,2,3),this.vignetteVx=i.context.createVertexBuffer(S,Eo.members),this.vignetteIdx=i.context.createIndexBuffer(C)}let g=t.bd.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){i.uploadCommonUniforms(i.context,f);let S={u_vignetteShape:(v={vignetteShape:[a.start,a.range,Math.pow(10,a.fadePower)],vignetteColor:[a.color.r,a.color.g,a.color.b,a.color.a*a.strength]}).vignetteShape,u_vignetteColor:v.vignetteColor};f.draw(i,i.context.gl.TRIANGLES,Li.disabled,hn.disabled,Tn.alphaBlended,ln.disabled,S,"vignette",this.vignetteVx,this.vignetteIdx,g)}var v}}class vo{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(i,a){let f=i.getFreeCameraOptions().position,g=f.toAltitude(),v=f.toLngLat(),S=t.al(v.lng),C=t.al(v.lat),z=i.pixelsPerMeter/a,N=S*t.eq,U=t.eq*Math.log(Math.tan(Math.PI/4+C/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{let $=-this._offsetYPrev+U,Z=-this._elevationPrev+g;this._accumulatedOffsetX+=(-this._offsetXPrev+N)*z,this._accumulatedOffsetY+=$*z,this._accumulatedElevation+=Z*z,this._offsetXPrev=N,this._offsetYPrev=U,this._elevationPrev=g}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function Yr(p,i){return[-(p[0]-Math.floor(p[0]/i)*i),-(p[1]-Math.floor(p[1]/i)*i),-(p[2]-Math.floor(p[2]/i)*i)]}function Mo(p){let i=t.ea(1323123451230),a=[];for(let f=0;f<p;++f){let g=2*i()-1,v=2*i()-1,S=2*i()-1;a.push(t.cS(g,v,S))}return a}function ps(p,i,a,f,g){let v=t.aD((g-a)/(f-a),0,1);return(1-v)*p+v*i}class lr{constructor(i){this._movement=new vo,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new Go,this._ppmScaleFactor=i}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(i,a){let f=i.transform;this._movement.update(f,this._ppmScaleFactor);let g=f.starsProjMatrix,v=t.bY([]);t.b_(v,v,t.al(90)-f._pitch),t.bZ(v,v,-f.angle);let S=t.c3(new Float32Array(16),v),C=t.ep(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),z=t.ee([],C),N=t.az([],z,S),U=Date.now()/1e3;return this._accumulatedTimeFromStart+=(U-this._prevTime)*a,this._prevTime=U,{projectionMatrix:g,modelviewMatrix:N}}}class aa extends lr{constructor(i){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Ho(i.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(i){let a=i.context;if(!this.particlesVx){let f=Mo(this.particlesCount),g=new t.er,v=new t.a_,S=0,C=t.ea(1323123451230);for(let z=0;z<f.length;++z){let N=f[z],U=[2*C()-1,C(),C(),C()];g.emplaceBack(N[0],N[1],N[2],-1,-1,...U),g.emplaceBack(N[0],N[1],N[2],1,-1,...U),g.emplaceBack(N[0],N[1],N[2],1,1,...U),g.emplaceBack(N[0],N[1],N[2],-1,1,...U),v.emplaceBack(S+0,S+1,S+2),v.emplaceBack(S+0,S+2,S+3),S+=4}this.particlesVx=a.createVertexBuffer(g,xr.members),this.particlesIdx=a.createIndexBuffer(v)}}draw(i){if(!this._params.overrideStyleParameters&&!i.style.rain)return;let a=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},f=i.transform.zoom;if(a.revealStart>f)return;let g=ps(0,1,a.revealStart,a.revealStart+a.revealRange,f);if(!this.particlesVx||!this.particlesIdx)return;let v=structuredClone(this._params),S=[-v.direction.x,v.direction.y,-100];t.au(S,S);let C=structuredClone(this._vignetteParams);C.strength*=g,v.overrideStyleParameters||(v.intensity=i.style.rain.state.density,v.timeFactor=i.style.rain.state.intensity,v.color=structuredClone(i.style.rain.state.color),S=structuredClone(i.style.rain.state.direction),v.screenThinning.intensity=i.style.rain.state.centerThinning,v.dropletSizeX=i.style.rain.state.dropletSize[0],v.dropletSizeYScale=i.style.rain.state.dropletSize[1]/i.style.rain.state.dropletSize[0],v.distortionStrength=100*i.style.rain.state.distortionStrength,C.strength=1,C.color=structuredClone(i.style.rain.state.vignetteColor));let z=this.updateOnRender(i,v.timeFactor),N=i.context,U=N.gl,$=i.transform;this.screenTexture&&this.screenTexture.size[0]===i.width&&this.screenTexture.size[1]===i.height||(this.screenTexture=new t.T(N,{width:i.width,height:i.height,data:null},U.RGBA8)),v.distortionStrength>0&&(N.activeTexture.set(U.TEXTURE0),this.screenTexture.bind(U.LINEAR,U.CLAMP_TO_EDGE),U.copyTexSubImage2D(U.TEXTURE_2D,0,0,0,0,0,i.width,i.height));let Z=i.getOrCreateProgram("rainParticle");i.uploadCommonUniforms(N,Z),N.activeTexture.set(U.TEXTURE0),this.screenTexture.bind(U.LINEAR,U.CLAMP_TO_EDGE);let X=[v.color.r,v.color.g,v.color.b,v.color.a],se=(re,he)=>{let ae=Yr(this._movement.getPosition(),re),be=v.dropletSizeX,Pe=v.dropletSizeX*v.dropletSizeYScale,Re=i.width/2,Ge=i.height/2,Ne=ps(0,v.screenThinning.start,0,1,v.screenThinning.intensity),Ve=ps(.001,v.screenThinning.range,0,1,v.screenThinning.intensity),Oe=ps(0,v.screenThinning.particleOffset,0,1,v.screenThinning.intensity),Ke=(Qe={modelview:z.modelviewMatrix,projection:z.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:ae,velocityConeAperture:v.velocityConeAperture,velocity:v.velocity,boxSize:re,rainDropletSize:[be,Pe],distortionStrength:v.distortionStrength,rainDirection:S,color:X,screenSize:[$.width,$.height],thinningCenterPos:[Re,Ge],thinningShape:[Ne,Ve,Math.pow(10,v.screenThinning.fadePower)],thinningAffectedRatio:v.screenThinning.affectedRatio,thinningParticleOffset:Oe,shapeDirectionalPower:v.shapeDirPower,shapeNormalPower:v.shapeNormalPower,mode:he?0:1},{u_modelview:Float32Array.from(Qe.modelview),u_projection:Float32Array.from(Qe.projection),u_time:Qe.time,u_cam_pos:Qe.camPos,u_texScreen:0,u_velocityConeAperture:Qe.velocityConeAperture,u_velocity:Qe.velocity,u_boxSize:Qe.boxSize,u_rainDropletSize:Qe.rainDropletSize,u_distortionStrength:Qe.distortionStrength,u_rainDirection:Qe.rainDirection,u_color:Qe.color,u_screenSize:Qe.screenSize,u_thinningCenterPos:Qe.thinningCenterPos,u_thinningShape:Qe.thinningShape,u_thinningAffectedRatio:Qe.thinningAffectedRatio,u_thinningParticleOffset:Qe.thinningParticleOffset,u_shapeDirectionalPower:Qe.shapeDirectionalPower,u_shapeNormalPower:Qe.shapeNormalPower,u_mode:Qe.mode});var Qe;let It=Math.round(v.intensity*this.particlesCount),gt=t.bd.simpleSegment(0,0,4*It,2*It);Z.draw(i,U.TRIANGLES,Li.disabled,hn.disabled,Tn.alphaBlended,ln.disabled,Ke,"rain_particles",this.particlesVx,this.particlesIdx,gt)};v.distortionStrength>0&&se(v.boxSize,!0),se(v.boxSize,!1),this._vignette.draw(i,C)}}let Rs=t.d_([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class Rr extends lr{constructor(i){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Ho(i.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(i){let a=i.context;if(!this.particlesVx){let f=Mo(this.particlesCount),g=new t.es,v=new t.a_,S=0,C=t.ea(1323123451230);for(let z=0;z<f.length;++z){let N=f[z],U=C(),$=C(),Z=C(),X=[z/f.length,U,$,Z],se=[C(),C()];g.emplaceBack(N[0],N[1],N[2],-1,-1,...X,...se),g.emplaceBack(N[0],N[1],N[2],1,-1,...X,...se),g.emplaceBack(N[0],N[1],N[2],1,1,...X,...se),g.emplaceBack(N[0],N[1],N[2],-1,1,...X,...se),v.emplaceBack(S+0,S+1,S+2),v.emplaceBack(S+0,S+2,S+3),S+=4}this.particlesVx=a.createVertexBuffer(g,Rs.members),this.particlesIdx=a.createIndexBuffer(v)}}draw(i){if(!this._params.overrideStyleParameters&&!i.style.snow)return;let a=structuredClone(this._params),f=[-a.direction.x,a.direction.y,-100];t.au(f,f);let g=structuredClone(this._vignetteParams),v=a.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},S=i.transform.zoom;if(v.revealStart>S)return;let C=ps(0,1,v.revealStart,v.revealStart+v.revealRange,S);g.strength*=C,a.overrideStyleParameters||(a.intensity=i.style.snow.state.density,a.timeFactor=i.style.snow.state.intensity,a.color=structuredClone(i.style.snow.state.color),f=structuredClone(i.style.snow.state.direction),a.screenThinning.intensity=i.style.snow.state.centerThinning,a.billboardSize=2.79*i.style.snow.state.flakeSize,g.strength=1,g.color=structuredClone(i.style.snow.state.vignetteColor));let z=this.updateOnRender(i,a.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;let N=i.context,U=N.gl,$=i.transform,Z=i.getOrCreateProgram("snowParticle");i.uploadCommonUniforms(N,Z),((X,se,re)=>{let he=Yr(this._movement.getPosition(),X),ae=$.width/2,be=$.height/2,Pe=ps(0,re.screenThinning.start,0,1,re.screenThinning.intensity),Re=ps(.001,re.screenThinning.range,0,1,re.screenThinning.intensity),Ge=ps(0,re.screenThinning.particleOffset,0,1,re.screenThinning.intensity),Ne=(Ve={modelview:z.modelviewMatrix,projection:z.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:he,velocityConeAperture:re.velocityConeAperture,velocity:re.velocity,horizontalOscillationRadius:re.horizontalOscillationRadius,horizontalOscillationRate:re.horizontalOscillationRate,boxSize:X,billboardSize:1*re.billboardSize,simpleShapeParameters:[re.shapeFadeStart,re.shapeFadePower],screenSize:[$.width,$.height],thinningCenterPos:[ae,be],thinningShape:[Pe,Re,Math.pow(10,re.screenThinning.fadePower)],thinningAffectedRatio:re.screenThinning.affectedRatio,thinningParticleOffset:Ge,color:[re.color.r,re.color.g,re.color.b,re.color.a],direction:f},{u_modelview:Float32Array.from(Ve.modelview),u_projection:Float32Array.from(Ve.projection),u_time:Ve.time,u_cam_pos:Ve.camPos,u_velocityConeAperture:Ve.velocityConeAperture,u_velocity:Ve.velocity,u_horizontalOscillationRadius:Ve.horizontalOscillationRadius,u_horizontalOscillationRate:Ve.horizontalOscillationRate,u_boxSize:Ve.boxSize,u_billboardSize:Ve.billboardSize,u_simpleShapeParameters:Ve.simpleShapeParameters,u_screenSize:Ve.screenSize,u_thinningCenterPos:Ve.thinningCenterPos,u_thinningShape:Ve.thinningShape,u_thinningAffectedRatio:Ve.thinningAffectedRatio,u_thinningParticleOffset:Ve.thinningParticleOffset,u_particleColor:Ve.color,u_direction:Ve.direction});var Ve;let Oe=Math.round(re.intensity*this.particlesCount),Ke=t.bd.simpleSegment(0,0,4*Oe,2*Oe);this.particlesVx&&this.particlesIdx&&Z.draw(i,U.TRIANGLES,Li.disabled,hn.disabled,Tn.alphaBlended,ln.disabled,Ne,"snow_particles",this.particlesVx,this.particlesIdx,Ke)})(a.boxSize,0,a),this._vignette.draw(i,g)}}let Kn={symbol:function(p,i,a,f,g){if(p.renderPass!=="translucent")return;let v=hn.disabled,S=p.colorModeForRenderPass(),C=a.layout.get("text-variable-anchor"),z=a.layout.get("text-size-scale-range"),N=t.aD(p.scaleFactor,z[0],z[1]);C&&function(Z,X,se,re,he,ae,be,Pe){let Re=X.transform,Ge=he==="map",Ne=ae==="map";for(let Ve of Z){let Oe=re.getTile(Ve),Ke=Oe.getBucket(se);if(!Ke||!Ke.text||!Ke.text.segments.get().length)continue;let Qe=t.bH(Ke.textSizeData,Re.zoom,Pe),It=Dl(Ve,Ke.getProjection(),Re),gt=Re.calculatePixelsToTileUnitsMatrix(Oe),jt=Bs(It,Oe.tileID.canonical,Ne,Ge,Re,Ke.getProjection(),gt),Ut=Ke.hasIconTextFit()&&Ke.hasIconData();Qe&&nd(Ke,Ge,Ne,be,Re,jt,Ve,Math.pow(2,Re.zoom-Oe.tileID.overscaledZ),Qe,Ut)}}(f,p,a,i,a.layout.get("text-rotation-alignment"),a.layout.get("text-pitch-alignment"),g,N);let U=a.paint.get("icon-opacity").constantOr(1)!==0,$=a.paint.get("text-opacity").constantOr(1)!==0;a.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(U||$)?pn(p,i,a,f,v,S):(U&&pn(p,i,a,f,v,S,{onlyIcons:!0}),$&&pn(p,i,a,f,v,S,{onlyText:!0})),i.map.showCollisionBoxes&&(bu(p,i,a,f,a.paint.get("text-translate"),a.paint.get("text-translate-anchor"),!0),bu(p,i,a,f,a.paint.get("icon-translate"),a.paint.get("icon-translate-anchor"),!1))},circle:function(p,i,a,f){if(p.renderPass!=="translucent")return;let g=a.paint.get("circle-opacity"),v=a.paint.get("circle-stroke-width"),S=a.paint.get("circle-stroke-opacity"),C=a.layout.get("circle-sort-key").constantOr(1)!==void 0,z=a.paint.get("circle-emissive-strength");if(g.constantOr(1)===0&&(v.constantOr(1)===0||S.constantOr(1)===0))return;let N=p.context,U=N.gl,$=p.transform,Z=p.depthModeForSublayer(0,Li.ReadOnly),X=hn.disabled,se=p.colorModeForDrapableLayerRenderPass(z),re=$.projection.name==="globe",he=[t.ay($.center.lng),t.aH($.center.lat)],ae=[];for(let Pe=0;Pe<f.length;Pe++){let Re=f[Pe],Ge=i.getTile(Re),Ne=Ge.getBucket(a);if(!Ne||Ne.projection.name!==$.projection.name)continue;let Ve=Ne.programConfigurations.get(a.id),Oe=t.dK(a),Ke=p.isTileAffectedByFog(Re);re&&Oe.push("PROJECTION_GLOBE_VIEW"),Oe.push("DEPTH_D24"),p.terrain&&$.depthOcclusionForSymbolsAndCircles&&Oe.push("DEPTH_OCCLUSION");let Qe=p.getOrCreateProgram("circle",{config:Ve,defines:Oe,overrideFog:Ke}),It=Ne.layoutVertexBuffer,gt=Ne.globeExtVertexBuffer,jt=Ne.indexBuffer,Ut=$.projection.createInversionMatrix($,Re.canonical),fi={programConfiguration:Ve,program:Qe,layoutVertexBuffer:It,globeExtVertexBuffer:gt,indexBuffer:jt,uniformValues:t.dL(p,Re,Ge,Ut,he,a),tile:Ge};if(C){let vt=Ne.segments.get();for(let Ct of vt)ae.push({segments:new t.bd([Ct]),sortKey:Ct.sortKey,state:fi})}else ae.push({segments:Ne.segments,sortKey:0,state:fi})}C&&ae.sort((Pe,Re)=>Pe.sortKey-Re.sortKey);let be={useDepthForOcclusion:$.depthOcclusionForSymbolsAndCircles};for(let Pe of ae){let{programConfiguration:Re,program:Ge,layoutVertexBuffer:Ne,globeExtVertexBuffer:Ve,indexBuffer:Oe,uniformValues:Ke,tile:Qe}=Pe.state,It=Pe.segments;p.terrain&&p.terrain.setupElevationDraw(Qe,Ge,be),p.uploadCommonUniforms(N,Ge,Qe.tileID.toUnwrapped()),Ge.draw(p,U.TRIANGLES,Z,X,se,ln.disabled,Ke,a.id,Ne,Oe,It,a.paint,$.zoom,Re,[Ve])}},heatmap:function(p,i,a,f){if(a.paint.get("heatmap-opacity")!==0)if(p.renderPass==="offscreen"){let g=p.context,v=g.gl,S=hn.disabled,C=new Tn([v.ONE,v.ONE,v.ONE,v.ONE],t.am.transparent,[!0,!0,!0,!0]);(function(X,se,re,he){let ae=X.gl,be=se.width*he,Pe=se.height*he;X.activeTexture.set(ae.TEXTURE1),X.viewport.set([0,0,be,Pe]);let Re=re.heatmapFbo;if(!Re||Re&&(Re.width!==be||Re.height!==Pe)){Re&&Re.destroy();let Ge=ae.createTexture();ae.bindTexture(ae.TEXTURE_2D,Ge),ae.texParameteri(ae.TEXTURE_2D,ae.TEXTURE_WRAP_S,ae.CLAMP_TO_EDGE),ae.texParameteri(ae.TEXTURE_2D,ae.TEXTURE_WRAP_T,ae.CLAMP_TO_EDGE),ae.texParameteri(ae.TEXTURE_2D,ae.TEXTURE_MIN_FILTER,ae.LINEAR),ae.texParameteri(ae.TEXTURE_2D,ae.TEXTURE_MAG_FILTER,ae.LINEAR),Re=re.heatmapFbo=X.createFramebuffer(be,Pe,!0,null),function(Ne,Ve,Oe,Ke,Qe,It){let gt=Ne.gl;gt.texImage2D(gt.TEXTURE_2D,0,Ne.extRenderToTextureHalfFloat?gt.RGBA16F:gt.RGBA,Qe,It,0,gt.RGBA,Ne.extRenderToTextureHalfFloat?gt.HALF_FLOAT:gt.UNSIGNED_BYTE,null),Ke.colorAttachment.set(Oe)}(X,0,Ge,Re,be,Pe)}else ae.bindTexture(ae.TEXTURE_2D,Re.colorAttachment.get()),X.bindFramebuffer.set(Re.framebuffer)})(g,p,a,p.transform.projection.name==="globe"?.5:.25),g.clear({color:t.am.transparent});let z=p.transform,N=z.projection.name==="globe",U=N?["PROJECTION_GLOBE_VIEW"]:[],$=N?ln.frontCCW:ln.disabled,Z=[t.ay(z.center.lng),t.aH(z.center.lat)];for(let X=0;X<f.length;X++){let se=f[X];if(i.hasRenderableParent(se))continue;let re=i.getTile(se),he=re.getBucket(a);if(!he||he.projection.name!==z.projection.name)continue;let ae=p.isTileAffectedByFog(se),be=he.programConfigurations.get(a.id),Pe=p.getOrCreateProgram("heatmap",{config:be,defines:U,overrideFog:ae}),{zoom:Re}=p.transform;p.terrain&&p.terrain.setupElevationDraw(re,Pe),p.uploadCommonUniforms(g,Pe,se.toUnwrapped());let Ge=z.projection.createInversionMatrix(z,se.canonical);Pe.draw(p,v.TRIANGLES,Li.disabled,S,C,$,Ju(p,se,re,Ge,Z,Re,a.paint.get("heatmap-intensity")),a.id,he.layoutVertexBuffer,he.indexBuffer,he.segments,a.paint,p.transform.zoom,be,N?[he.globeExtVertexBuffer]:null)}g.viewport.set([0,0,p.width,p.height])}else p.renderPass==="translucent"&&(p.context.setColorMode(p.colorModeForRenderPass()),function(g,v){let S=g.context,C=S.gl,z=v.heatmapFbo;if(!z)return;S.activeTexture.set(C.TEXTURE0),C.bindTexture(C.TEXTURE_2D,z.colorAttachment.get()),S.activeTexture.set(C.TEXTURE1);let N=v.colorRampTexture;N||(N=v.colorRampTexture=new t.T(S,v.colorRamp,C.RGBA8)),N.bind(C.LINEAR,C.CLAMP_TO_EDGE),g.getOrCreateProgram("heatmapTexture").draw(g,C.TRIANGLES,Li.disabled,hn.disabled,g.colorModeForRenderPass(),ln.disabled,((U,$,Z,X)=>({u_image:0,u_color_ramp:1,u_opacity:$.paint.get("heatmap-opacity")}))(0,v),v.id,g.viewportBuffer,g.quadTriangleIndexBuffer,g.viewportSegments,v.paint,g.transform.zoom)}(p,a))},line:function(p,i,a,f){if(p.renderPass!=="translucent")return;let g=a.paint.get("line-opacity"),v=a.paint.get("line-width");if(g.constantOr(1)===0||v.constantOr(1)===0)return;let S=a.paint.get("line-emissive-strength"),C=a.paint.get("line-occlusion-opacity"),z=a.layout.get("line-elevation-reference"),N=a.layout.get("line-width-unit")==="meters",U=z==="sea",$=!(!p.terrain||!p.terrain.enabled),Z=p.context,X=Z.gl;if(a.hasElevatedBuckets&&p.transform.projection.name==="globe")return;let se=a.layout.get("line-cross-slope"),re=se!==void 0,he=se<1,ae=p.colorModeForDrapableLayerRenderPass(S),be=p.terrain&&p.terrain.renderingToTexture,Pe=be?1:t.q.devicePixelRatio,Re=a.paint.get("line-dasharray"),Ge=Re.constantOr(1),Ne=a.layout.get("line-cap"),Ve=Re.constantOr(null),Oe=Ne.constantOr(null),Ke=a.paint.get("line-pattern"),Qe=Ke.constantOr(1),It=a.paint.get("line-pattern-cross-fade"),gt=Ke.constantOr(null),jt=a.paint.get("line-opacity").constantOr(1),Ut=!Qe&&jt!==1||p.depthOcclusion&&C>0&&C<1,fi=a.paint.get("line-gradient"),vt=Qe?"linePattern":"line",Ct=t.dM(a),_t;if(be&&p.terrain&&p.terrain.clipOrMaskOverlapStencilType()&&(Ut=!1),C!==0&&p.depthOcclusion){let Gt=a.paint._values["line-opacity"];Gt&&Gt.value&&Gt.value.kind==="constant"?_t=Gt.value:t.w(`Occlusion opacity for layer ${a.id} is supported only when line-opacity isn't data-driven.`)}v.value.kind!=="constant"&&v.value.isLineProgressConstant===!1&&Ct.push("VARIABLE_LINE_WIDTH");let qt=(Gt,ii,oi,ki,ji,zi)=>{for(let $i of Gt){let Oi=i.getTile($i);if(Qe&&!Oi.patternsLoaded())continue;let nn=Oi.getBucket(a);if(!nn||nn.elevationType!=="none"&&!ji||nn.elevationType==="none"&&ji)continue;p.prepareDrawTile();let xn=[...ii],Bn=p.shadowRenderer,Er=nn.elevationType==="road"&&!!Bn&&Bn.enabled,zr=[0,0,0];if(Er){let Dn=p.style.directionalLight,oo=p.style.ambientLight;Dn&&oo&&(zr=Ol(p.style,Dn,oo)),xn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}let Gn=nn.programConfigurations.get(a.id),po=!1;if(gt&&Oi.imageAtlas){let Dn=t.dN.from(gt),oo=Dn.getPrimary().scaleSelf(Pe).toString(),fr=Oi.imageAtlas.patternPositions.get(oo),so=Dn.getSecondary(),Sr=so?Oi.imageAtlas.patternPositions.get(so.scaleSelf(Pe).toString()):null;po=!!fr&&!!Sr,fr&&Gn.setConstantPatternPositions(fr,Sr)}It>0&&(po||Gn.getPatternTransitionVertexBuffer("line-pattern"))&&xn.push("LINE_PATTERN_TRANSITION");let no=p.isTileAffectedByFog($i),En=p.getOrCreateProgram(vt,{config:Gn,defines:xn,overrideFog:no,overrideRtt:!ji&&void 0});if(!Qe&&Ve&&Oe&&Oi.lineAtlas){let Dn=Oi.lineAtlas.getDash(Ve,Oe);Dn&&Gn.setConstantPatternPositions(Dn)}Er&&Bn.setupShadows(Oi.tileID.toUnwrapped(),En,"vector-tile",Oi.tileID.overscaledZ);let[cr,pr]=a.paint.get("line-trim-offset");(Oe==="round"||Oe==="square")&&cr!==pr&&(cr===0&&(cr-=1),pr===1&&(pr+=1));let Or=be?$i.projMatrix:null,xs=N?1/nn.tileToMeter/t.aw(Oi,1,p.transform.zoom):1,Lo=N?1/nn.tileToMeter/t.aw(Oi,1,Math.floor(p.transform.zoom)):1,ko=Qe?t.dO(p,Oi,a,Or,Pe,xs,Lo,[cr,pr],zr,It):t.dP(p,Oi,a,Or,nn.lineClipsArray.length,Pe,xs,Lo,[cr,pr],zr);if(fi){let Dn=nn.gradients[a.id],oo=Dn.texture;if(a.gradientVersion!==Dn.version){let fr=256;if(a.stepInterpolant){let so=i.getSource().maxzoom,Sr=$i.canonical.z===so?Math.ceil(1<<p.transform.maxZoom-$i.canonical.z):1;fr=t.aD(t.dQ(nn.maxLineLength/t.aj*1024*Sr),256,Z.maxTextureSize)}Dn.gradient=t.dR({expression:a.gradientExpression(),evaluationKey:"lineProgress",resolution:fr,image:Dn.gradient||void 0,clips:nn.lineClipsArray}),Dn.texture?Dn.texture.update(Dn.gradient):Dn.texture=new t.T(Z,Dn.gradient,X.RGBA8),Dn.version=a.gradientVersion,oo=Dn.texture}Z.activeTexture.set(X.TEXTURE1),oo.bind(a.stepInterpolant?X.NEAREST:X.LINEAR,X.CLAMP_TO_EDGE)}Ge&&(Z.activeTexture.set(X.TEXTURE0),Oi.lineAtlasTexture&&Oi.lineAtlasTexture.bind(X.LINEAR,X.REPEAT),Gn.updatePaintBuffers()),Qe&&(Z.activeTexture.set(X.TEXTURE0),Oi.imageAtlasTexture&&Oi.imageAtlasTexture.bind(X.LINEAR,X.CLAMP_TO_EDGE),Gn.updatePaintBuffers()),ji&&!U&&p.terrain.setupElevationDraw(Oi,En),p.uploadCommonUniforms(Z,En,$i.toUnwrapped());let ro=Dn=>{_t!=null&&(_t.value=jt*C),En.draw(p,X.TRIANGLES,oi,Dn,ae,ln.disabled,ko,a.id,nn.layoutVertexBuffer,nn.indexBuffer,nn.segments,a.paint,p.transform.zoom,Gn,[nn.layoutVertexBuffer2,nn.patternVertexBuffer,nn.zOffsetVertexBuffer]),_t!=null&&(_t.value=jt)};if(Ut&&!ji){let Dn=p.stencilModeForClipping($i).ref;Dn===0&&be&&Z.clear({stencil:0});let oo={func:X.EQUAL,mask:255};ko.u_alpha_discard_threshold=.8,ro(new hn(oo,Dn,255,X.KEEP,X.KEEP,X.INVERT)),ko.u_alpha_discard_threshold=0,ro(new hn(oo,Dn,255,X.KEEP,X.KEEP,X.KEEP))}else ko.u_alpha_discard_threshold=Ut&&ji&&zi?.8:0,ro(ji?ki:p.stencilModeForClipping($i))}},Pt=p.depthModeForSublayer(0,Li.ReadOnly),ti=new Li(p.depthOcclusion?X.GREATER:X.LEQUAL,Li.ReadOnly,p.depthRangeFor3D);if(a.hasNonElevatedBuckets){let Gt=!be&&p.terrain;C!==0&&Gt?t.w(`Occlusion opacity for layer ${a.id} is supported on terrain only if the layer has line-z-offset enabled.`):Gt?t.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${a.id}.`):qt(f,Ct,Pt,hn.disabled,!1,!0)}if(a.hasElevatedBuckets){z==="hd-road-markup"?$||(Pt=ti,Ct.push("ELEVATED_ROADS")):(Ct.push("ELEVATED"),Pt=ti,re&&Ct.push(he?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),U&&Ct.push("ELEVATION_REFERENCE_SEA"));let Gt=Ut?p.stencilModeFor3D():hn.disabled;p.forceTerrainMode=!0,qt(f,Ct,Pt,Gt,!0,!0),Ut&&qt(f,Ct,Pt,Gt,!0,!1),p.forceTerrainMode=!1}Ut&&(p.resetStencilClippingMasks(),be&&Z.clear({stencil:0})),C===0||p.depthOcclusion||be||p.layersWithOcclusionOpacity.push(p.currentLayer)},fill:function(p,i,a,f){let g=a.paint.get("fill-color"),v=a.paint.get("fill-opacity");if(v.constantOr(1)===0)return;let S=a.paint.get("fill-emissive-strength"),C=p.colorModeForDrapableLayerRenderPass(S),z=a.paint.get("fill-pattern"),N=p.opaquePassEnabledForLayer()&&!z.constantOr(1)&&g.constantOr(t.am.transparent).a===1&&v.constantOr(0)===1?"opaque":"translucent",U="none";a.layout.get("fill-elevation-reference")!=="none"?U="road":a.paint.get("fill-z-offset").constantOr(1)!==0&&(U="offset");let $=!(!p.terrain||!p.terrain.enabled),Z={painter:p,sourceCache:i,layer:a,coords:f,colorMode:C,elevationType:U,terrainEnabled:$,pass:N};if(p.renderPass!=="shadow")if(U!=="offset"){if(Ei(Z,!1),U==="road"){let X=!$&&p.renderPass==="translucent";X&&wu(p,i,a,f,"geometry"),Ei(Z,!0,hn.disabled),X&&function(se){let{painter:re,sourceCache:he,layer:ae,coords:be,colorMode:Pe}=se,Re=re.context.gl,Ge=se.painter.shadowRenderer,Ne=!!Ge&&Ge.enabled,Ve=new Li(re.context.gl.LEQUAL,Li.ReadOnly,re.depthRangeFor3D),Oe=[0,0,0];if(Ne){let Ke=re.style.directionalLight,Qe=re.style.ambientLight;Ke&&Qe&&(Oe=Ol(re.style,Ke,Qe))}for(let Ke of be){let Qe=he.getTile(Ke),It=Qe.getBucket(ae);if(!It)continue;let gt=It.elevatedStructures;if(!gt||!gt.renderableSegments||gt.renderableSegments.segments[0].primitiveLength===0)continue;re.prepareDrawTile();let jt=It.bufferData.programConfigurations.get(ae.id),Ut=re.isTileAffectedByFog(Ke),fi=[];Ne&&fi.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");let vt=re.getOrCreateProgram("elevatedStructures",{config:jt,overrideFog:Ut,defines:fi}),Ct=re.translatePosMatrix(Ke.projMatrix,Qe,ae.paint.get("fill-translate"),ae.paint.get("fill-translate-anchor"));Ne&&Ge.setupShadows(Qe.tileID.toUnwrapped(),vt,"vector-tile",Qe.tileID.overscaledZ);let _t=vu(Ct,Oe);re.uploadCommonUniforms(re.context,vt,Ke.toUnwrapped()),vt.draw(re,Re.TRIANGLES,Ve,hn.disabled,Pe,ln.backCCW,_t,ae.id,gt.vertexBuffer,gt.indexBuffer,gt.renderableSegments,ae.paint,re.transform.zoom,jt,[gt.vertexBufferNormal])}}(Z)}}else Ei(Z,!1,p.stencilModeFor3D());else p.shadowRenderer&&U==="road"&&!$&&function(X){let{painter:se,sourceCache:re,layer:he,coords:ae}=X,be=se.context.gl,Pe=X.painter.shadowRenderer;for(let Re of ae){let Ge=re.getTile(Re),Ne=Ge.getBucket(he);if(!Ne)continue;let Ve=Ne.elevatedStructures;if(!Ve||!Ve.shadowCasterSegments||Ve.shadowCasterSegments.segments[0].primitiveLength===0)continue;se.prepareDrawTile();let Oe=Ne.bufferData.programConfigurations.get(he.id),Ke=se.isTileAffectedByFog(Re),Qe=se.getOrCreateProgram("elevatedStructuresDepth",{config:Oe,overrideFog:Ke}),It=Pe.calculateShadowPassMatrixFromTile(Ge.tileID.toUnwrapped());se.uploadCommonUniforms(se.context,Qe,Re.toUnwrapped());let gt={u_matrix:It,u_depth_bias:.001};Qe.draw(se,be.TRIANGLES,Pe.getShadowPassDepthMode(),hn.disabled,Pe.getShadowPassColorMode(),ln.disabled,gt,he.id,Ve.vertexBuffer,Ve.indexBuffer,Ve.shadowCasterSegments,he.paint,se.transform.zoom,Oe)}}(Z)},"fill-extrusion":function(p,i,a,f){let g=a.paint.get("fill-extrusion-opacity"),v=p.context,S=v.gl,C=p.terrain,z=C&&C.renderingToTexture;if(g===0)return;let N=p.conflationActive&&p.style.isLayerClipped(a,i.getSource()),U=p.style.order.indexOf(a.fqid);if(N&&function($,Z,X,se,re){for(let he of se){let ae=Z.getTile(he).getBucket(X);ae&&(ae.updateReplacement(he,$.replacementSource,re),ae.uploadCentroid($.context))}}(p,i,a,f,U),C||N)for(let $ of f){let Z=i.getTile($).getBucket(a);Z&&ds(p.context,i,$,Z,a,C,N)}if(p.renderPass==="shadow"&&p.shadowRenderer){let $=p.shadowRenderer;if(C&&g<.65&&a._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof t.ab)return;let Z=$.getShadowPassDepthMode(),X=$.getShadowPassColorMode();Qs(p,i,a,f,Z,hn.disabled,X,N)}else if(p.renderPass==="translucent"){let $=!a.paint.get("fill-extrusion-pattern").constantOr(1),Z=a.paint.get("fill-extrusion-color").constantOr(t.am.white);if(!z&&Z.a!==0){let X=new Li(p.context.gl.LEQUAL,Li.ReadWrite,p.depthRangeFor3D);g===1&&$?Qs(p,i,a,f,X,hn.disabled,Tn.unblended,N):(Qs(p,i,a,f,X,hn.disabled,Tn.disabled,N),Qs(p,i,a,f,X,p.stencilModeFor3D(),p.colorModeForRenderPass(),N),p.resetStencilClippingMasks())}if(p.style.enable3dLights()&&$&&(!C&&p.transform.projection.name!=="globe"||z)){let X=a.paint.get("fill-extrusion-opacity"),se=a.paint.get("fill-extrusion-ambient-occlusion-intensity"),re=a.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),he=a.paint.get("fill-extrusion-flood-light-intensity"),ae=a.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",be=a.paint.get("fill-extrusion-flood-light-color").toRenderColor(ae?null:a.lut).toArray01().slice(0,3),Pe=se>0&&re>0,Re=he>0,Ge=(Ve,Oe,Ke)=>(1-Ke)*Ve+Ke*Oe,Ne=Ve=>{let Oe=p.depthModeForSublayer(1,Li.ReadOnly,S.LEQUAL,!0),Ke=a.paint.get(Ve?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Qe=Ge(.1,3,Ke),It=p._showOverdrawInspector;if(!It){let gt=new hn({func:S.ALWAYS,mask:255},255,255,S.KEEP,S.KEEP,S.REPLACE),jt=new Tn([S.ONE,S.ONE,S.ONE,S.ONE],t.am.transparent,[!1,!1,!1,!0],S.MIN);Zh(p,i,a,f,Oe,gt,jt,ln.disabled,Ve,"sdf",X,se,re,he,be,Qe,N,!1)}{let gt=It?hn.disabled:new hn({func:S.EQUAL,mask:255},255,255,S.KEEP,S.DECR,S.DECR),jt=It?p.colorModeForRenderPass():new Tn([S.ONE_MINUS_DST_ALPHA,S.DST_ALPHA,S.ONE,S.ONE],t.am.transparent,[!0,!0,!0,!0]);Zh(p,i,a,f,Oe,gt,jt,ln.disabled,Ve,"color",X,se,re,he,be,Qe,N,!1)}};if(z){let Ve=(Oe,Ke,Qe)=>{let It=p.depthModeForSublayer(1,Li.ReadOnly,S.LEQUAL,!1),gt=a.paint.get(Oe?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),jt=Ge(.1,3,gt);{let Ut=new Tn([S.ONE,S.ONE,S.ONE,S.ONE],t.am.transparent,[!1,!1,!1,!0]);Zh(p,i,a,f,It,hn.disabled,Ut,ln.disabled,Oe,"clear",X,se,re,he,be,jt,N,Ke)}{let Ut=new hn({func:S.ALWAYS,mask:255},255,255,S.KEEP,S.KEEP,S.REPLACE),fi=new Tn([S.ONE,S.ONE,S.ONE,S.ONE],t.am.transparent,[!1,!1,!1,!0],S.MIN);Zh(p,i,a,f,It,Ut,fi,ln.disabled,Oe,"sdf",X,se,re,he,be,jt,N,Ke)}{let Ut=Oe?S.ZERO:S.ONE_MINUS_DST_ALPHA,fi=new hn({func:S.EQUAL,mask:255},255,255,S.KEEP,S.DECR,S.DECR),vt=new Tn([Ut,S.DST_ALPHA,S.ONE_MINUS_DST_ALPHA,S.ZERO],t.am.transparent,[!0,!0,!0,!0]);Zh(p,i,a,f,It,fi,vt,ln.disabled,Oe,"color",X,se,re,he,be,jt,N,Ke)}{let Ut=new Tn([S.ONE,S.ONE,S.ONE,Oe?S.ZERO:S.ONE],t.am.transparent,[!1,!1,!1,!0],Oe?S.FUNC_ADD:S.MAX);Zh(p,i,a,f,It,hn.disabled,Ut,ln.disabled,Oe,"clear",X,se,re,he,be,jt,N,Ke,Qe)}};if(Pe||Re){let Oe;if(p.prepareDrawTile(),C){let Ke=C.drapeBufferSize[0],Qe=C.drapeBufferSize[1];Oe=C.framebufferCopyTexture,Oe&&(!Oe||Oe.size[0]===Ke&&Oe.size[1]===Qe)||(Oe&&Oe.destroy(),Oe=C.framebufferCopyTexture=new t.T(v,new t.r({width:Ke,height:Qe}),S.RGBA8)),Oe.bind(S.LINEAR,S.CLAMP_TO_EDGE),S.copyTexSubImage2D(S.TEXTURE_2D,0,0,0,0,0,Ke,Qe)}Pe&&Ve(!0,!1,Oe),Re&&Ve(!1,!0,Oe)}}else Pe&&Ne(!0),Re&&Ne(!1),(Pe||Re)&&p.resetStencilClippingMasks()}}},hillshade:function(p,i,a,f){if(p.renderPass!=="offscreen"&&p.renderPass!=="translucent"||p.style.disableElevatedTerrain)return;let g=p.context,v=p.terrain&&p.terrain.renderingToTexture,[S,C]=p.renderPass!=="translucent"||v?[{},f]:p.stencilConfigForOverlap(f);for(let z of C){let N=i.getTile(z);if(N.needsHillshadePrepare&&p.renderPass==="offscreen")lh(p,N,a);else if(p.renderPass==="translucent"){let U=p.depthModeForSublayer(0,Li.ReadOnly),$=a.paint.get("hillshade-emissive-strength"),Z=p.colorModeForDrapableLayerRenderPass($),X=v&&p.terrain?p.terrain.stencilModeForRTTOverlap(z):S[z.overscaledZ];Np(p,z,N,a,U,X,Z)}}g.viewport.set([0,0,p.width,p.height]),p.resetStencilClippingMasks()},raster:function(p,i,a,f,g,v){if(p.renderPass!=="translucent"||a.paint.get("raster-opacity")===0)return;let S=p.transform.projection.name==="globe",C=a.paint.get("raster-elevation")!==0,z=C&&S;if(p.renderElevatedRasterBackface&&!z)return;let N=p.context,U=N.gl,$=i.getSource(),Z=function(Ne,Ve,Oe,Ke){let Qe=Ve.paint.get("raster-color"),It=Ne.type==="raster-array",gt=[],jt=Ve.paint.get("raster-resampling"),Ut=Ve.paint.get("raster-color-mix"),fi=Ve.paint.get("raster-color-range"),vt=[Ut[0],Ut[1],Ut[2],0],Ct=Ut[3],_t=jt==="nearest"?Ke.NEAREST:Ke.LINEAR;if(It&&(gt.push("RASTER_ARRAY"),Qe||gt.push("RASTER_COLOR"),jt==="linear"&&gt.push("RASTER_ARRAY_LINEAR"),_t=Ke.NEAREST,!fi&&Ne.rasterLayers)){let qt=Ne.rasterLayers.find(({id:Pt})=>Pt===Ve.sourceLayer);qt&&qt.fields&&qt.fields.range&&(fi=qt.fields.range)}if(fi=fi||[0,1],Qe){gt.push("RASTER_COLOR"),Oe.activeTexture.set(Ke.TEXTURE2),Ve.updateColorRamp(fi);let qt=Ve.colorRampTexture;qt||(qt=Ve.colorRampTexture=new t.T(Oe,Ve.colorRamp,Ke.RGBA8)),qt.bind(Ke.LINEAR,Ke.CLAMP_TO_EDGE)}return{mix:vt,range:fi,offset:Ct,defines:gt,resampling:_t}}($,a,N,U);if($ instanceof t.aP&&!f.length&&!S)return;let X=a.paint.get("raster-emissive-strength"),se=p.colorModeForDrapableLayerRenderPass(X),re=p.terrain&&p.terrain.renderingToTexture,he=!p.options.moving,ae=a.paint.get("raster-resampling")==="nearest"?U.NEAREST:U.LINEAR;if($ instanceof t.aP&&!f.length&&($.onNorthPole||$.onSouthPole)){let Ne=C?p.stencilModeFor3D():hn.disabled;return void Ul(!!$.onNorthPole,null,p,i,a,X,Z,ln.disabled,Ne)}if(!f.length)return;let[be,Pe]=$ instanceof t.aP||re?[{},f]:p.stencilConfigForOverlap(f),Re=Pe[Pe.length-1].overscaledZ;z&&Z.defines.push("PROJECTION_GLOBE_VIEW"),C&&Z.defines.push("RENDER_CUTOFF");let Ge=(Ne,Ve,Oe)=>{for(let Ke of Ne){let Qe=Ke.toUnwrapped(),It=i.getTile(Ke);if(re&&(!It||!It.hasData()))continue;N.activeTexture.set(U.TEXTURE0);let gt=mf(It,$,a,Z);if(!gt||!gt.texture)continue;let{texture:jt,mix:Ut,offset:fi,tileSize:vt,buffer:Ct}=gt,_t,qt;re?(_t=Li.disabled,qt=Ke.projMatrix):C?(_t=new Li(U.LEQUAL,Li.ReadWrite,p.depthRangeFor3D),qt=S?Float32Array.from(p.transform.expandedFarZProjMatrix):p.transform.calculateProjMatrix(Qe,he)):(_t=p.depthModeForSublayer(Ke.overscaledZ-Re,a.paint.get("raster-opacity")===1?Li.ReadWrite:Li.ReadOnly,U.LESS),qt=p.transform.calculateProjMatrix(Qe,he));let Pt=p.terrain&&re?p.terrain.stencilModeForRTTOverlap(Ke):be[Ke.overscaledZ],ti=v?0:a.paint.get("raster-fade-duration");It.registerFadeDuration(ti);let Gt=i.findLoadedParent(Ke,0),ii=yu(It,Gt,i,p.transform,ti),oi,ki;p.terrain&&p.terrain.prepareDrawTile(),N.activeTexture.set(U.TEXTURE0),jt.bind(ae,U.CLAMP_TO_EDGE),N.activeTexture.set(U.TEXTURE1),Gt?(Gt.texture&&Gt.texture.bind(ae,U.CLAMP_TO_EDGE),oi=Math.pow(2,Gt.tileID.overscaledZ-It.tileID.overscaledZ),ki=[It.tileID.canonical.x*oi%1,It.tileID.canonical.y*oi%1]):jt.bind(ae,U.CLAMP_TO_EDGE),"useMipmap"in jt&&N.extTextureFilterAnisotropic&&p.transform.pitch>20&&U.texParameterf(U.TEXTURE_2D,N.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,N.extTextureFilterAnisotropicMax);let ji=p.transform,zi,$i=C?xh(ji):[0,0,0,0],Oi,nn,xn,Bn,Er,zr=0;if(z&&$ instanceof t.aP&&$.coordinates.length>3)Oi=Float32Array.from(t.bh(t.dr(new t.cp(0,0,0)))),nn=Float32Array.from(ji.globeMatrix),xn=Float32Array.from(t.dm(ji)),Bn=[t.ay(ji.center.lng),t.aH(ji.center.lat)],zi=$.elevatedGlobePerspectiveTransform,Er=$.elevatedGlobeGridMatrix||new Float32Array(9);else if(z){let En=t.dn(Ke.canonical);zr=t.dp(En.getCenter().lat),Oi=Float32Array.from(t.bh(t.dr(Ke.canonical))),nn=Float32Array.from(ji.globeMatrix),xn=Float32Array.from(t.dm(ji)),Bn=[t.ay(ji.center.lng),t.aH(ji.center.lat)],zi=[0,0],Er=Float32Array.from(t.dq(Ke.canonical,En,zr,ji.worldSize/ji._pixelsPerMercatorPixel))}else zi=$ instanceof t.aP?$.perspectiveTransform:[0,0],Oi=new Float32Array(16),nn=new Float32Array(9),xn=new Float32Array(16),Bn=[0,0],Er=new Float32Array(9);let Gn=gl(qt,Oi,nn,xn,Er,ki||[0,0],t.ah(p.transform.zoom),Bn,$i,oi||1,ii,a,zi,C?a.paint.get("raster-elevation"):0,2,Ut,fi,Z.range,vt,Ct,X),po=p.isTileAffectedByFog(Ke),no=p.getOrCreateProgram("raster",{defines:Z.defines,overrideFog:po});if(p.uploadCommonUniforms(N,no,Qe),$ instanceof t.aP){let En=$.elevatedGlobeVertexBuffer,cr=$.elevatedGlobeIndexBuffer;if(re||!S)$.boundsBuffer&&$.boundsSegments&&no.draw(p,U.TRIANGLES,_t,hn.disabled,se,ln.disabled,Gn,a.id,$.boundsBuffer,p.quadTriangleIndexBuffer,$.boundsSegments);else if(En&&cr){let pr=ji.zoom<=t.cL?$.elevatedGlobeSegments:$.getSegmentsForLongitude(ji.center.lng);pr&&no.draw(p,U.TRIANGLES,_t,hn.disabled,se,Ve,Gn,a.id,En,cr,pr)}}else if(z){_t=new Li(U.LEQUAL,Li.ReadOnly,p.depthRangeFor3D);let En=p.globeSharedBuffers;if(En){let[cr,pr,Or]=En.getGridBuffers(zr,!1);no.draw(p,U.TRIANGLES,_t,Oe||Pt,p.colorModeForRenderPass(),Ve,Gn,a.id,cr,pr,Or)}}else{let{tileBoundsBuffer:En,tileBoundsIndexBuffer:cr,tileBoundsSegments:pr}=p.getTileBoundsBuffers(It);no.draw(p,U.TRIANGLES,_t,Pt,se,ln.disabled,Gn,a.id,En,cr,pr)}}if(!($ instanceof t.aP)&&z)for(let Ke of Ne){let Qe=Ke.canonical.y===(1<<Ke.canonical.z)-1;Ke.canonical.y===0&&Ul(!0,Ke,p,i,a,X,Z,Ve,Oe||hn.disabled),Qe&&Ul(!1,Ke,p,i,a,X,Z,Ve===ln.frontCW?ln.backCW:ln.frontCW,Oe||hn.disabled)}};z?Ge(Pe,p.renderElevatedRasterBackface?ln.backCW:ln.frontCW,p.stencilModeFor3D()):Ge(Pe,ln.disabled,void 0),p.resetStencilClippingMasks()},"raster-particle":function(p,i,a,f,g,v){p.renderPass==="offscreen"&&function(S,C,z,N){if(!N.length)return;let U=S.context,$=U.gl,Z=C.getSource();if(!(Z instanceof Eh))return;let X=Math.ceil(Math.sqrt(z.paint.get("raster-particle-count"))),se=z.particlePositionRGBAImage;if(!se||se.width!==X){let Pe=function(Re){let Ge=Re*Re,Ne=new Uint8Array(4*Ge),Ve=function(Ke){return Ke|=0,Ke=Math.imul(2747636419^Ke,2654435769),Ke=Math.imul(Ke^Ke>>>16,2654435769),((Ke=Math.imul(Ke^Ke>>>16,2654435769))>>>0)/4294967296},Oe=1/1.1;for(let Ke=0;Ke<Ge;Ke++){let Qe=Oe*(Ve(2*Ke+0)+ar),It=Oe*(Ve(2*Ke+1)+ar),gt=255*Qe%1,jt=255*It%1,Ut=gt,fi=It-jt/255,vt=jt;Ne[4*Ke+0]=255*(Qe-gt/255),Ne[4*Ke+1]=255*Ut,Ne[4*Ke+2]=255*fi,Ne[4*Ke+3]=255*vt}return Ne}(X);se=z.particlePositionRGBAImage=new t.r({width:X,height:X},Pe)}let re=z.particleFramebuffer;re?re.width!==X&&(re.destroy(),re=z.particleFramebuffer=U.createFramebuffer(X,X,!0,null)):re=z.particleFramebuffer=U.createFramebuffer(X,X,!0,null);let he=[];for(let Pe of N){let Re=C.getTile(Pe);if(!(Re instanceof tc))continue;let Ge=ep(Re,Z,z);if(!Ge)continue;let Ne=[Re.tileSize,Re.tileSize],Ve=z.tileFramebuffer;Ve||(Ve=z.tileFramebuffer=U.createFramebuffer(Ne[0],Ne[1],!0,null));let Oe=Re.rasterParticleState;Oe||(Oe=Re.rasterParticleState=new Tu(U,Pe,Ne,se));let Ke=Oe.update(z.lastInvalidatedAt);Oe.particleTextureDimension!==X&&Oe.updateParticleTexture(Pe,se);let Qe=Oe.targetColorTexture;Oe.targetColorTexture=Oe.backgroundColorTexture,Oe.backgroundColorTexture=Qe;let It=Oe.particleTexture0;Oe.particleTexture0=Oe.particleTexture1,Oe.particleTexture1=It,he.push([Pe,Ge,Oe,Ke])}if(he.length===0)return;let ae=t.q.now(),be=z.previousDrawTimestamp?.001*(ae-z.previousDrawTimestamp):.0167;if(z.previousDrawTimestamp=ae,z.hasColorMap()){U.activeTexture.set($.TEXTURE0+2);let Pe=z.colorRampTexture;Pe||(Pe=z.colorRampTexture=new t.T(U,z.colorRamp,$.RGBA8)),Pe.bind($.LINEAR,$.CLAMP_TO_EDGE)}U.bindFramebuffer.set(z.tileFramebuffer.framebuffer),function(Pe,Re,Ge){let Ne=Pe.context,Ve=Ne.gl,Oe=Re.tileFramebuffer;Ne.activeTexture.set(Ve.TEXTURE0);let Ke={u_texture:0,u_opacity:1.05*(It=Re.paint.get("raster-particle-fade-opacity-factor"))/(It+.05)},Qe=Pe.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var It;for(let gt of Ge){let[,,jt,Ut]=gt;Oe.colorAttachment.set(jt.targetColorTexture.texture),Ne.viewport.set([0,0,Oe.width,Oe.height]),Ne.clear({color:t.am.transparent}),Ut&&(jt.backgroundColorTexture.bind(Ve.NEAREST,Ve.CLAMP_TO_EDGE),Qe.draw(Pe,Ve.TRIANGLES,Li.disabled,hn.disabled,Tn.alphaBlended,ln.disabled,Ke,Re.id,Pe.viewportBuffer,Pe.quadTriangleIndexBuffer,Pe.viewportSegments))}}(S,z,he),function(Pe,Re,Ge,Ne){let Ve=Pe.context,Oe=Ve.gl,Ke=Ge.tileFramebuffer,Qe=Pe.transform.projection.name==="globe",It=Ge.paint.get("raster-particle-max-speed");for(let gt of Ne){let[jt,Ut,fi]=gt;Ve.activeTexture.set(Oe.TEXTURE0+0),Ut.texture.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE),Ke.colorAttachment.set(fi.targetColorTexture.texture);let vt=Pe.getOrCreateProgram("rasterParticleDraw",{defines:Ut.defines,overrideFog:!1});Ve.activeTexture.set(Oe.TEXTURE0+1);let Ct=Ut.scalarData?[]:[0,1,2,3].map(Pt=>t.dU[Pt](jt));Ct.push(jt);let _t=jt.canonical.x,qt=jt.canonical.y;for(let Pt of Ct){let ti=Re.getTile(Qe?Pt.wrapped():Pt);if(!ti)continue;let Gt=ti.rasterParticleState;if(!Gt)continue;let ii=Pt.canonical.x+(1<<Pt.canonical.z)*(Pt.wrap-jt.wrap),oi=Pt.canonical.y;Gt.particleTexture0.bind(Oe.NEAREST,Oe.CLAMP_TO_EDGE);let ki=Hd(1,Gt.particleTexture0.size[0],[ii-_t,oi-qt],0,Ut.texture.size,2,It,Ut.textureOffset,Ut.scale,Ut.offset);vt.draw(Pe,Oe.POINTS,Li.disabled,hn.disabled,Tn.alphaBlended,ln.disabled,ki,Ge.id,Gt.particleIndexBuffer,void 0,Gt.particleSegment)}}}(S,C,z,he),U.bindFramebuffer.set(z.particleFramebuffer.framebuffer),function(Pe,Re,Ge,Ne){let Ve=Pe.context,Oe=Ve.gl,Ke=Re.paint.get("raster-particle-max-speed"),Qe=Ne*Re.paint.get("raster-particle-speed-factor")*.15,It=function(jt){return Math.pow(jt,6)}(.01+1*Re.paint.get("raster-particle-reset-rate-factor")),gt=Re.particleFramebuffer;Ve.viewport.set([0,0,gt.width,gt.height]);for(let jt of Ge){let[,Ut,fi]=jt;Ve.activeTexture.set(Oe.TEXTURE0+0),Ut.texture.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE),Ve.activeTexture.set(Oe.TEXTURE0+1);let vt=fi.particleTexture0;vt.bind(Oe.NEAREST,Oe.CLAMP_TO_EDGE);let Ct=Xd(1,vt.size[0],0,Ut.texture.size,Ke,Qe,It,Ut.textureOffset,Ut.scale,Ut.offset);gt.colorAttachment.set(fi.particleTexture1.texture),Ve.clear({color:t.am.transparent}),Pe.getOrCreateProgram("rasterParticleUpdate",{defines:Ut.defines}).draw(Pe,Oe.TRIANGLES,Li.disabled,hn.disabled,Tn.unblended,ln.disabled,Ct,Re.id,Pe.viewportBuffer,Pe.quadTriangleIndexBuffer,Pe.viewportSegments)}}(S,z,he,be)}(p,i,a,f),p.renderPass==="translucent"&&(function(S,C,z,N,U){let $=S.context,Z=$.gl,X=C.getSource().tileSize,se=5*(1-t.af(t.cx,t.cx+1,S.transform.zoom))*X+z.paint.get("raster-particle-elevation"),re=!S.options.moving,he=S.transform.projection.name==="globe";if(!N.length)return;let[ae,be]=S.stencilConfigForOverlap(N),Pe=[];he&&Pe.push("PROJECTION_GLOBE_VIEW");let Re=S.stencilModeFor3D();for(let Ge of be){let Ne=Ge.toUnwrapped(),Ve=C.getTile(Ge);if(!Ve.rasterParticleState)continue;let Oe=Ve.rasterParticleState,Ke=100;Ve.registerFadeDuration(Ke);let Qe=C.findLoadedParent(Ge,0),It=yu(Ve,Qe,C,S.transform,Ke),gt,jt;S.terrain&&S.terrain.prepareDrawTile(),$.activeTexture.set(Z.TEXTURE0),Oe.targetColorTexture.bind(Z.LINEAR,Z.CLAMP_TO_EDGE),$.activeTexture.set(Z.TEXTURE1),Qe&&Qe.rasterParticleState?(Qe.rasterParticleState.targetColorTexture.bind(Z.LINEAR,Z.CLAMP_TO_EDGE),gt=Math.pow(2,Qe.tileID.overscaledZ-Ve.tileID.overscaledZ),jt=[Ve.tileID.canonical.x*gt%1,Ve.tileID.canonical.y*gt%1]):Oe.targetColorTexture.bind(Z.LINEAR,Z.CLAMP_TO_EDGE);let Ut=he?Float32Array.from(S.transform.expandedFarZProjMatrix):S.transform.calculateProjMatrix(Ne,re),fi=S.transform,vt=tp(fi),Ct=t.dn(Ge.canonical),_t=t.dp(Ct.getCenter().lat),qt,Pt,ti,Gt,ii;he?(qt=Float32Array.from(t.bh(t.dr(Ge.canonical))),Pt=Float32Array.from(fi.globeMatrix),ti=Float32Array.from(t.dm(fi)),Gt=[t.ay(fi.center.lng),t.aH(fi.center.lat)],ii=Float32Array.from(t.dq(Ge.canonical,Ct,_t,fi.worldSize/fi._pixelsPerMercatorPixel))):(qt=new Float32Array(16),Pt=new Float32Array(9),ti=new Float32Array(16),Gt=[0,0],ii=new Float32Array(9));let oi=Wd(Ut,qt,Pt,ti,ii,jt||[0,0],t.ah(S.transform.zoom),Gt,vt,gt||1,It,se),ki=S.isTileAffectedByFog(Ge),ji=S.getOrCreateProgram("rasterParticle",{defines:Pe,overrideFog:ki});if(S.uploadCommonUniforms($,ji,Ne),he){let zi=new Li(Z.LEQUAL,Li.ReadOnly,S.depthRangeFor3D),$i=0,Oi=S.globeSharedBuffers;if(Oi){let[nn,xn,Bn]=Oi.getGridBuffers(_t,$i!==0);ji.draw(S,Z.TRIANGLES,zi,Re,Tn.alphaBlended,S.renderElevatedRasterBackface?ln.frontCCW:ln.backCCW,oi,z.id,nn,xn,Bn)}}else{let zi=S.depthModeForSublayer(0,Li.ReadOnly),$i=ae[Ge.overscaledZ],{tileBoundsBuffer:Oi,tileBoundsIndexBuffer:nn,tileBoundsSegments:xn}=S.getTileBoundsBuffers(Ve);ji.draw(S,Z.TRIANGLES,zi,$i,Tn.alphaBlended,ln.disabled,oi,z.id,Oi,nn,xn)}}S.resetStencilClippingMasks()}(p,i,a,f),p.style.map.triggerRepaint())},background:function(p,i,a,f){let g=a.paint.get("background-color"),v=a.paint.get("background-color-use-theme").constantOr("default")==="none",S=a.paint.get("background-opacity"),C=a.paint.get("background-emissive-strength"),z=a.paint.get("background-pitch-alignment")==="viewport";if(S===0)return;let N=p.context,U=N.gl,$=p.transform,Z=$.tileSize,X=a.paint.get("background-pattern"),se;if(X!==void 0&&(X===null||(se=p.imageManager.getPattern(t.I.from(X.toString()),a.scope,p.style.getLut(a.scope)),!se)))return;let re=!X&&g.a===1&&S===1&&p.opaquePassEnabledForLayer()?"opaque":"translucent";if(p.renderPass!==re)return;let he=hn.disabled,ae=p.depthModeForSublayer(0,re==="opaque"?Li.ReadWrite:Li.ReadOnly),be=p.colorModeForDrapableLayerRenderPass(C),Pe=X?"backgroundPattern":"background",Re,Ge=f;if(Ge||(Re=p.getBackgroundTiles(),Ge=Object.values(Re).map(Ne=>Ne.tileID)),X&&(N.activeTexture.set(U.TEXTURE0),p.imageManager.bind(p.context,a.scope)),z){let Ne=p.getOrCreateProgram(Pe,{overrideFog:!1,overrideRtt:!0}),Ve=new Float32Array(t.bx([])),Oe=new t.aM(0,0,0,0,0),Ke=X?Kd(Ve,C,S,p,0,a.scope,se,z,{tileID:Oe,tileSize:Z}):Qu(Ve,C,S,g.toRenderColor(v?null:a.lut));Ne.draw(p,U.TRIANGLES,ae,he,be,ln.disabled,Ke,a.id,p.viewportBuffer,p.quadTriangleIndexBuffer,p.viewportSegments)}else for(let Ne of Ge){let Ve=p.isTileAffectedByFog(Ne),Oe=p.getOrCreateProgram(Pe,{overrideFog:Ve}),Ke=Ne.toUnwrapped(),Qe=f?Ne.projMatrix:p.transform.calculateProjMatrix(Ke);p.prepareDrawTile();let It=i?i.getTile(Ne):Re?Re[Ne.key]:new Ta(Ne,Z,$.zoom,p),gt=X?Kd(Qe,C,S,p,0,a.scope,se,z,{tileID:Ne,tileSize:Z}):Qu(Qe,C,S,g.toRenderColor(v?null:a.lut));p.uploadCommonUniforms(N,Oe,Ke);let{tileBoundsBuffer:jt,tileBoundsIndexBuffer:Ut,tileBoundsSegments:fi}=p.getTileBoundsBuffers(It);Oe.draw(p,U.TRIANGLES,ae,he,be,ln.disabled,gt,a.id,jt,Ut,fi)}},sky:function(p,i,a){let f=p._atmosphere?t.ah(p.transform.zoom):1,g=a.paint.get("sky-opacity")*f;if(g===0)return;let v=p.context,S=a.paint.get("sky-type"),C=new Li(v.gl.LEQUAL,Li.ReadOnly,[0,1]),z=p.frameCounter/1e3%1;S==="atmosphere"?p.renderPass==="offscreen"?a.needsSkyboxCapture(p)&&(function(N,U,$,Z){let X=N.context,se=X.gl,re=U.skyboxFbo;if(!re){re=U.skyboxFbo=X.createFramebuffer(32,32,!0,null),U.skyboxGeometry=new ne(X),U.skyboxTexture=X.gl.createTexture(),se.bindTexture(se.TEXTURE_CUBE_MAP,U.skyboxTexture),se.texParameteri(se.TEXTURE_CUBE_MAP,se.TEXTURE_WRAP_S,se.CLAMP_TO_EDGE),se.texParameteri(se.TEXTURE_CUBE_MAP,se.TEXTURE_WRAP_T,se.CLAMP_TO_EDGE),se.texParameteri(se.TEXTURE_CUBE_MAP,se.TEXTURE_MIN_FILTER,se.LINEAR),se.texParameteri(se.TEXTURE_CUBE_MAP,se.TEXTURE_MAG_FILTER,se.LINEAR);for(let Pe=0;Pe<6;++Pe)se.texImage2D(se.TEXTURE_CUBE_MAP_POSITIVE_X+Pe,0,se.RGBA,32,32,0,se.RGBA,se.UNSIGNED_BYTE,null)}X.bindFramebuffer.set(re.framebuffer),X.viewport.set([0,0,32,32]);let he=U.getCenter(N,!0),ae=N.getOrCreateProgram("skyboxCapture"),be=new Float64Array(16);t.bx(be),t.e3(be,be,.5*-Math.PI),pe(N,U,ae,be,he,0),t.bx(be),t.e3(be,be,.5*Math.PI),pe(N,U,ae,be,he,1),t.bx(be),t.cG(be,be,.5*-Math.PI),pe(N,U,ae,be,he,2),t.bx(be),t.cG(be,be,.5*Math.PI),pe(N,U,ae,be,he,3),t.bx(be),pe(N,U,ae,be,he,4),t.bx(be),t.e3(be,be,Math.PI),pe(N,U,ae,be,he,5),X.viewport.set([0,0,N.width,N.height])}(p,a),a.markSkyboxValid(p)):p.renderPass==="sky"&&function(N,U,$,Z,X){let se=N.context,re=se.gl,he=N.transform,ae=N.getOrCreateProgram("skybox");se.activeTexture.set(re.TEXTURE0),re.bindTexture(re.TEXTURE_CUBE_MAP,U.skyboxTexture);let be=((Pe,Re,Ge,Ne,Ve)=>({u_matrix:Pe,u_sun_direction:Re,u_cubemap:0,u_opacity:Ne,u_temporal_offset:Ve}))(he.skyboxMatrix,U.getCenter(N,!1),0,Z,X);N.uploadCommonUniforms(se,ae),ae.draw(N,re.TRIANGLES,$,hn.disabled,N.colorModeForRenderPass(),ln.backCW,be,"skybox",U.skyboxGeometry.vertexBuffer,U.skyboxGeometry.indexBuffer,U.skyboxGeometry.segment)}(p,a,C,g,z):S==="gradient"&&p.renderPass==="sky"&&function(N,U,$,Z,X){let se=N.context,re=se.gl,he=N.transform,ae=N.getOrCreateProgram("skyboxGradient");U.skyboxGeometry||(U.skyboxGeometry=new ne(se)),se.activeTexture.set(re.TEXTURE0);let be=U.colorRampTexture;be||(be=U.colorRampTexture=new t.T(se,U.colorRamp,re.RGBA8)),be.bind(re.LINEAR,re.CLAMP_TO_EDGE);let Pe=((Re,Ge,Ne,Ve,Oe)=>({u_matrix:Re,u_color_ramp:0,u_center_direction:Ge,u_radius:t.al(Ne),u_opacity:Ve,u_temporal_offset:Oe}))(he.skyboxMatrix,U.getCenter(N,!1),U.paint.get("sky-gradient-radius"),Z,X);N.uploadCommonUniforms(se,ae),ae.draw(N,re.TRIANGLES,$,hn.disabled,N.colorModeForRenderPass(),ln.backCW,Pe,"skyboxGradient",U.skyboxGeometry.vertexBuffer,U.skyboxGeometry.indexBuffer,U.skyboxGeometry.segment)}(p,a,C,g,z)},debug:function(p,i,a,f,g,v){for(let S=0;S<a.length;S++)if(g){let N=new t.am(f.r*.8,f.g*.8,f.b*.8,1);x(p,i,a[S],f,-1,-1,v),x(p,i,a[S],f,-1,1,v),x(p,i,a[S],f,1,1,v),x(p,i,a[S],f,1,-1,v),x(p,i,a[S],N,0,0,v)}else x(p,i,a[S],f,0,0,v)},custom:function(p,i,a,f){let g=p.context,v=a.implementation;if(!p.transform.projection.unsupportedLayers||!p.transform.projection.unsupportedLayers.includes("custom")||p.terrain&&(p.terrain.renderingToTexture||p.renderPass==="offscreen")&&a.isDraped(i)){if(p.renderPass==="offscreen"){let S=v.prerender;if(S){if(p.setCustomLayerDefaults(),g.setColorMode(p.colorModeForRenderPass()),p.transform.projection.name==="globe"){let C=p.transform.pointMerc;S.call(v,g.gl,p.transform.customLayerMatrix(),p.transform.getProjection(),p.transform.globeToMercatorMatrix(),t.ah(p.transform.zoom),[C.x,C.y],p.transform.pixelsPerMeterRatio)}else S.call(v,g.gl,p.transform.customLayerMatrix());g.setDirty(),p.setBaseState()}}else if(p.renderPass==="translucent"){if(p.terrain&&p.terrain.renderingToTexture){let C=v.renderToTile;if(C){let z=f[0].canonical,N={x:z.x+f[0].wrap*(v.wrapTileId?0:1<<z.z),y:z.y,z:z.z};g.setDepthMode(Li.disabled),g.setStencilMode(hn.disabled),g.setColorMode(p.colorModeForRenderPass()),p.setCustomLayerDefaults(),C.call(v,g.gl,N),g.setDirty(),p.setBaseState()}return}p.setCustomLayerDefaults(),g.setColorMode(p.colorModeForRenderPass()),g.setStencilMode(hn.disabled);let S=v.renderingMode==="3d"?new Li(p.context.gl.LEQUAL,Li.ReadWrite,p.depthRangeFor3D):p.depthModeForSublayer(0,Li.ReadOnly);if(g.setDepthMode(S),p.transform.projection.name==="globe"){let C=p.transform.pointMerc;v.render(g.gl,p.transform.customLayerMatrix(),p.transform.getProjection(),p.transform.globeToMercatorMatrix(),t.ah(p.transform.zoom),[C.x,C.y],p.transform.pixelsPerMeterRatio)}else v.render(g.gl,p.transform.customLayerMatrix());g.setDirty(),p.setBaseState(),g.bindFramebuffer.set(null)}}else t.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(p,i,a,f){if(p.renderPass==="opaque")return;let g=a.paint.get("model-opacity").constantOr(1);if(g===0)return;let v=a.paint.get("model-cast-shadows");if(p.renderPass==="shadow"&&(!v||p.terrain&&g<.65&&a._transitionablePaint._values["model-opacity"].value.expression instanceof t.ab))return;let S=p.shadowRenderer,C=a.paint.get("model-receive-shadows");S&&(S.useNormalOffset=!0,C||(S.enabled=!1));let z=()=>{S&&(S.useNormalOffset=!0,C||(S.enabled=!0))},N=i.getSource();if(p.renderPass==="light-beam"&&N.type!=="batched-model")return;if(N.type==="vector"||N.type==="geojson")return function(ae,be,Pe,Re,Ge){let Ne=ae.transform;if(Ne.projection.name!=="mercator")return void t.w(`Drawing 3D models for ${Ne.projection.name} projection is not yet implemented`);let Ve=Ne.getFreeCameraOptions().position;if(!ae.modelManager)return;let Oe=ae.modelManager;Pe.modelManager=Oe;let Ke=ae.shadowRenderer;if(!Pe._unevaluatedLayout._values.hasOwnProperty("model-id"))return;let Qe=Pe._unevaluatedLayout._values["model-id"],It=Object.assign({},Pe.layout.get("model-id").parameters),gt=ae.style.order.indexOf(Pe.fqid);for(let jt of Re){let Ut=be.getTile(jt).getBucket(Pe);if(!Ut||Ut.projection.name!==Ne.projection.name)continue;let fi=Ut.getModelUris();fi&&!Ut.modelsRequested&&(Oe.addModelsFromBucket(fi,Ge),Ut.modelsRequested=!0);let vt=zt(jt,Ne);It.zoom=vt;let Ct=Qe.possiblyEvaluate(It);if(xe(ae,Ut,jt),pt.shadowUniformsInitialized=!1,pt.useSingleShadowCascade=!!Ke&&Ke.getMaxCascadeForTile(jt.toUnwrapped())===0,ae.renderPass==="shadow"&&Ke){if(ae.currentShadowCascade===1&&Ut.isInsideFirstShadowMapFrustum)continue;let Pt=Ne.calculatePosMatrix(jt.toUnwrapped(),Ne.worldSize);if(pt.tileMatrix.set(Pt),pt.shadowTileMatrix=Float32Array.from(Ke.calculateShadowPassMatrixFromMatrix(Pt)),pt.aabb.min.fill(0),pt.aabb.max[0]=pt.aabb.max[1]=t.aj,pt.aabb.max[2]=0,Jt(Ut,pt,ae,Pe.scope))continue}let _t=1<<jt.canonical.z,qt=[((Ve.x-jt.wrap)*_t-jt.canonical.x)*t.aj,(Ve.y*_t-jt.canonical.y)*t.aj,Ve.z*_t*t.aj];ae.conflationActive&&Object.keys(Ut.instancesPerModel).length>0&&ae.style.isLayerClipped(Pe,be.getSource())&&Ut.updateReplacement(jt,ae.replacementSource,gt,Ge)&&(Ut.uploaded=!1,Ut.upload(ae.context));for(let Pt in Ut.instancesPerModel){let ti=Ut.instancesPerModel[Pt];ti.features.length>0&&(Pt=Ct.evaluate(ti.features[0].feature,{}));let Gt=Oe.getModel(Pt,Ge);if(Gt||Oe.hasURLBeenRequested(Pt)||Ut.modelUris.includes(Pt)||(Ut.modelUris.push(Pt),Ut.modelsRequested=!1),Gt&&Gt.uploaded)for(let ii of Gt.nodes)ei(ae,Pe,ii,ti,qt,jt,pt)}}}(p,i,a,f,N.type==="vector"?a.scope:""),void z();if(!N.loaded())return;if(N.type==="batched-model")return function(ae,be,Pe,Re){Pe.resetLayerRenderingStats(ae);let Ge=ae.context,Ne=ae.transform,Ve=ae.style.fog,Oe=ae.shadowRenderer;if(Ne.projection.name!=="mercator")return void t.w(`Drawing 3D landmark models for ${Ne.projection.name} projection is not yet implemented`);let Ke=ae.transform.getFreeCameraOptions().position,Qe=t.b$([],[Ke.x,Ke.y,Ke.z],ae.transform.worldSize),It=t.eb([],Qe),gt=t.bx([]),jt=t.ec(Ne.center.lat,Ne.zoom),Ut=t.bn([],[1,1,1/jt]);t.bo(gt,gt,It);let fi=Pe.paint.get("model-opacity").constantOr(1),vt=new Li(Ge.gl.LEQUAL,Li.ReadWrite,ae.depthRangeFor3D),Ct=new Li(Ge.gl.LEQUAL,Li.ReadOnly,ae.depthRangeFor3D),_t=new t.cV([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),qt=ae.renderPass==="shadow",Pt=qt&&Oe?Oe.getCurrentCascadeFrustum():Ne.getFrustum(Ne.scaleZoom(Ne.worldSize)),ti=Pe.paint.get("model-front-cutoff"),Gt=ti[2]<1,ii=hu(ae,Pe.paint.get("model-cutoff-fade-range")),oi=Pe.getLayerRenderingStats();(function(ki,ji,zi,$i){let Oi=ki.terrain?ki.terrain.exaggeration():0,nn=ki.transform.zoom;for(let xn of $i){let Bn=ji.getTile(xn).getBucket(zi);Bn&&(Bn.setFilter(zi.filter),ki.conflationActive&&Bn.updateReplacement(xn,ki.replacementSource),Bn.evaluateScale(ki,zi),ki.terrain&&Oi>0&&Bn.elevationUpdate(ki.terrain,Oi,xn,zi.source),Bn.needsReEvaluation(ki,nn,zi)&&Bn.evaluate(zi))}})(ae,be,Pe,Re),function(){let ki,ji,zi;Gt?(ki=Re.length-1,ji=-1,zi=-1):(ki=0,ji=Re.length,zi=1);let $i=new Float64Array(16),Oi=t.eg(),nn=new t.P(0,0);for(let xn=ki;xn!==ji;xn+=zi){let Bn=Re[xn],Er=be.getTile(Bn).getBucket(Pe);if(!Er||!Er.uploaded)continue;let zr=!1;Oe&&(zr=Oe.getMaxCascadeForTile(Bn.toUnwrapped())===0);let Gn=Ne.calculatePosMatrix(Bn.toUnwrapped(),Ne.worldSize),po=Er.modelTraits;!qt&&Gt&&(t.bi($i,Gn),t.ad(Oi,Qe,$i),nn.x=Oi[0],nn.y=Oi[1]);let no=[];Er.setFilter(Pe.filter);for(let En of Er.getNodesInfo()){if(En.hiddenByReplacement||!En.node.meshes)continue;let cr=En.node,pr=0;ae.terrain&&cr.elevation&&(pr=cr.elevation*ae.terrain.exaggeration());let Or=(()=>{let fo=En.aabb;return _t.min=[...fo.min],_t.max=[...fo.max],_t.min[2]+=pr,_t.max[2]+=pr,t.ad(_t.min,_t.min,Gn),t.ad(_t.max,_t.max,Gn),_t})(),xs=En.evaluatedScale;if(xs[0]<=1&&xs[1]<=1&&xs[2]<=1&&Or.intersects(Pt)===0)continue;if(!qt&&Gt){let fo=.16666666666666666;En.cameraCollisionOpacity=Qe[0]>Or.min[0]&&Qe[0]<Or.max[0]&&Qe[1]>Or.min[1]&&Qe[1]<Or.max[1]&&Qe[2]*jt<Or.max[2]&&cr.footprint&&t.bS(nn,cr.footprint)?Math.max(En.cameraCollisionOpacity-fo,0):Math.min(1,En.cameraCollisionOpacity+fo)}let Lo=[...Gn],ko=cr.anchor?cr.anchor[0]:0,ro=cr.anchor?cr.anchor[1]:0;t.bo(Lo,Lo,[ko*(xs[0]-1),ro*(xs[1]-1),pr]),t.ci(xs,t.eh)||t.cE(Lo,Lo,xs);let Dn=t.az([],Lo,cr.matrix),oo=t.az([],Ne.expandedFarZProjMatrix,Dn),fr=t.az([],Ne.expandedFarZProjMatrix,Lo),so=t.aA([],[ko,ro,pr,1],oo)[2];cr.hidden=!1;let Sr=fi;qt||(Gt&&(Sr*=En.cameraCollisionOpacity,Sr*=Xi(Lo,Ne,En.aabb,ti)),Sr*=si(ii,so)),Sr!==0?no.push({nodeInfo:En,depth:so,opacity:Sr,wvpForNode:oo,wvpForTile:fr,nodeModelMatrix:Dn,tileModelMatrix:Lo}):cr.hidden=!0}qt||no.sort((En,cr)=>!Gt||En.opacity===1&&cr.opacity===1?En.depth<cr.depth?-1:1:En.opacity===1?-1:cr.opacity===1?1:En.depth>cr.depth?-1:1);for(let En of no){let cr=En.nodeInfo,pr=cr.node,Or=t.az([],Ut,En.tileModelMatrix);t.az(Or,gt,Or);let xs=t.bi([],Or);t.ee(xs,xs),t.cE(xs,xs,Kt),Or=t.az(Or,Or,pr.matrix);let Lo=ae.renderPass==="light-beam",ko=Pe.paint.get("model-color-use-theme").constantOr("default")==="none",ro=po&t.em.HasMapboxMeshFeatures,Dn=ro?0:cr.evaluatedRMEA[0][2];for(let oo=0;oo<pr.meshes.length;++oo){let fr=pr.meshes[oo],so=oo===pr.lightMeshIndex,Sr=En.wvpForNode;if(so){if(!Lo&&!ae.terrain&&ae.shadowRenderer){ae.currentLayer<ae.firstLightBeamLayer&&(ae.firstLightBeamLayer=ae.currentLayer);continue}Sr=En.wvpForTile}else if(Lo)continue;let fo={defines:[]},js=[];if(!qt&&Oe&&(Oe.useNormalOffset=!!fr.normalBuffer),Se(fo.defines,js,fr,ae,ko?null:Pe.lut),ro||fo.defines.push("DIFFUSE_SHADED"),zr&&fo.defines.push("SHADOWS_SINGLE_CASCADE"),oi&&(qt?oi.numRenderedVerticesInShadowPass+=fr.vertexArray.length:oi.numRenderedVerticesInTransparentPass+=fr.vertexArray.length),qt){dt(fr,En.nodeModelMatrix,ae,Pe);continue}let Gr=null;if(Ve){let Zl=et(En.nodeModelMatrix,ae.transform);if(Gr=new Float32Array(Zl),Ne.projection.name!=="globe"){let fc=fr.aabb.min,Hh=fr.aabb.max,[Xh,Th]=Ve.getOpacityForBounds(Zl,fc[0],fc[1],Hh[0],Hh[1]);fo.overrideFog=Xh>=Ii||Th>=Ii}}let ea=fr.material,Xo;ea.occlusionTexture&&ea.occlusionTexture.offsetScale&&(Xo=ea.occlusionTexture.offsetScale,fo.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));let ha=ae.getOrCreateProgram("model",fo);!qt&&Oe&&Oe.setupShadowsFromMatrix(En.tileModelMatrix,ha,Oe.useNormalOffset),ae.uploadCommonUniforms(Ge,ha,null,Gr);let wh=ea.pbrMetallicRoughness;wh.metallicFactor=.9,wh.roughnessFactor=.5;let Lc=Uh(new Float32Array(Sr),new Float32Array(Or),new Float32Array(xs),new Float32Array(pr.matrix),ae,En.opacity,wh.baseColorFactor.toRenderColor(null),ea.emissiveFactor,wh.metallicFactor,wh.roughnessFactor,ea,Dn,Pe,[0,0,0],Xo);!so&&(cr.hasTranslucentParts||En.opacity<1)&&ha.draw(ae,Ge.gl.TRIANGLES,vt,hn.disabled,Tn.disabled,ln.backCCW,Lc,Pe.id,fr.vertexBuffer,fr.indexBuffer,fr.segments,Pe.paint,ae.transform.zoom,void 0,js),ha.draw(ae,Ge.gl.TRIANGLES,so?Ct:vt,hn.disabled,so||En.opacity<1||cr.hasTranslucentParts?Tn.alphaBlended:Tn.unblended,ln.backCCW,Lc,Pe.id,fr.vertexBuffer,fr.indexBuffer,fr.segments,Pe.paint,ae.transform.zoom,void 0,js)}}}}()}(p,i,a,f),void z();if(N.type!=="model")return;let U=N.getModels(),$=[],Z=p.transform.getFreeCameraOptions().position,X=t.b$([],[Z.x,Z.y,Z.z],p.transform.worldSize);t.eb(X,X);let se=[],re=[],he=0;for(let ae of U){let be=a.paint.get("model-rotation").constantOr(null),Pe=a.paint.get("model-scale").constantOr(null),Re=a.paint.get("model-translation").constantOr(null);ae.computeModelMatrix(p,be,Pe,Re,!0,!0,!1);let Ge=t.bx([]),Ne=t.ec(ae.position.lat,p.transform.zoom),Ve=t.bn([],[1,1,1/Ne]);t.bo(Ge,Ge,X),$.push({zScaleMatrix:Ve,negCameraPosMatrix:Ge});for(let Oe of ae.nodes)ft(p.transform,Oe,ae.matrix,p.transform.expandedFarZProjMatrix,he,se,re);he++}if(se.sort((ae,be)=>be.depth-ae.depth),p.renderPass!=="shadow"){if(g===1)for(let ae of re)Be(ae,p,a,$[ae.modelIndex],hn.disabled,p.colorModeForRenderPass());else{for(let ae of re)Be(ae,p,a,$[ae.modelIndex],hn.disabled,Tn.disabled);for(let ae of re)Be(ae,p,a,$[ae.modelIndex],p.stencilModeFor3D(),p.colorModeForRenderPass());p.resetStencilClippingMasks()}for(let ae of se)Be(ae,p,a,$[ae.modelIndex],hn.disabled,p.colorModeForRenderPass());z()}else{for(let ae of re)dt(ae.mesh,ae.nodeModelMatrix,p,a);for(let ae of se)dt(ae.mesh,ae.nodeModelMatrix,p,a);z()}}},Ac={line:function(p,i,a){if(p.hasElevatedBuckets=!1,p.hasNonElevatedBuckets=!1,p._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||p._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(i){let f=i.getVisibleCoordinates();for(let g of f){let v=i.getTile(g).getBucket(p);if(v&&(v.elevationType!=="none"?p.hasElevatedBuckets=!0:p.hasNonElevatedBuckets=!0,p.hasElevatedBuckets&&p.hasNonElevatedBuckets))break}}}else p.hasNonElevatedBuckets=!0},model:function(p,i,a){let f=i.getSource();if(!f.loaded())return;if(f.type==="vector"||f.type==="geojson")return void(a.modelManager&&a.modelManager.upload(a,f.type==="vector"?p.scope:""));if(f.type==="batched-model"||f.type!=="model")return;let g=f.getModels();for(let v of g)v.upload(a.context)},raster:function(p,i,a){let f=i.getSource();if(!(f instanceof Eh&&f.loaded()))return;let g=p.sourceLayer||f.rasterLayerIds&&f.rasterLayerIds[0];if(!g)return;let v=p.paint.get("raster-array-band")||f.getInitialBand(g);if(v==null)return;let S=i.getIds().map(C=>i.getTileByID(C));for(let C of S)C.updateNeeded(g,v)&&f.prepareTile(C,g,v)},"raster-particle":function(p,i,a){let f=i.getSource();if(!(f instanceof Eh&&f.loaded()))return;let g=p.sourceLayer||f.rasterLayerIds&&f.rasterLayerIds[0];if(!g)return;let v=p.paint.get("raster-particle-array-band")||f.getInitialBand(g);if(v==null)return;let S=i.getIds().map(C=>i.getTileByID(C));for(let C of S)C.updateNeeded(g,v)&&f.prepareTile(C,g,v)}},la={fill:wu};class qh{constructor(i,a,f,g,v){this.context=new mh(i,a),this.transform=f,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=v,this._timeStamp=t.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};let S=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(let z of S)this._debugParams.enabledLayers[z]=!0;v.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),v.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),v.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),v.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),v.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),v.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(let z of S)v.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],z);this.occlusionParams=new yn(v),this.setup(),this.numSublayers=Uo.maxUnderzooming+Uo.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new t.et,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new Of(this),this._wireframeDebugCache=new Pi,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];let C=new t.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new t.T(this.context,C,i.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=g}updateTerrain(i,a){let f=!!i&&!!i.terrain&&this.transform.projection.supportsTerrain;if(!(f||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Hu(this,i));let g=this._terrain;this.transform.elevation=f?g:null,g.update(i,this.transform,a),this.transform.elevation&&!g.enabled&&(this.transform.elevation=null)}_updateFog(i){let a=i.fog;if(!a||this.transform.projection.name==="globe"||a.getOpacity(this.transform.pitch)<1||a.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);let[f,g]=a.getFovAdjustedRange(this.transform._fov);if(f>g)return void(this.transform.fogCullDistSq=null);let v=f+.78*(g-f);this.transform.fogCullDistSq=v*v}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(i){i&&!this._terrain&&(this._terrain=new Hu(this,this.style)),this._forceTerrainMode=i}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(i,a){if(this.width=i*t.q.devicePixelRatio,this.height=a*t.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(let f of this.style.order)this.style._mergedLayers[f].resize()}setup(){let i=this.context,a=new t.ba;a.emplaceBack(0,0),a.emplaceBack(t.aj,0),a.emplaceBack(0,t.aj),a.emplaceBack(t.aj,t.aj),this.tileExtentBuffer=i.createVertexBuffer(a,t.bc.members),this.tileExtentSegments=t.bd.simpleSegment(0,0,4,2);let f=new t.ba;f.emplaceBack(0,0),f.emplaceBack(t.aj,0),f.emplaceBack(0,t.aj),f.emplaceBack(t.aj,t.aj),this.debugBuffer=i.createVertexBuffer(f,t.bc.members),this.debugSegments=t.bd.simpleSegment(0,0,4,5);let g=new t.ba;g.emplaceBack(-1,-1),g.emplaceBack(1,-1),g.emplaceBack(-1,1),g.emplaceBack(1,1),this.viewportBuffer=i.createVertexBuffer(g,t.bc.members),this.viewportSegments=t.bd.simpleSegment(0,0,4,2);let v=new t.aZ;v.emplaceBack(0,0,0,0),v.emplaceBack(t.aj,0,t.aj,0),v.emplaceBack(0,t.aj,0,t.aj),v.emplaceBack(t.aj,t.aj,t.aj,t.aj),this.mercatorBoundsBuffer=i.createVertexBuffer(v,t.bf.members),this.mercatorBoundsSegments=t.bd.simpleSegment(0,0,4,2);let S=new t.a_;S.emplaceBack(0,1,2),S.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=i.createIndexBuffer(S);let C=new t.bb;for(let N of[0,1,3,2,0])C.emplaceBack(N);this.debugIndexBuffer=i.createIndexBuffer(C),this.emptyTexture=new t.T(i,new t.r({width:1,height:1},Uint8Array.of(0,0,0,0)),i.gl.RGBA8),this.identityMat=t.bz();let z=this.context.gl;this.stencilClearMode=new hn({func:z.ALWAYS,mask:0},0,255,z.ZERO,z.ZERO,z.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(i){return i._makeTileBoundsBuffers(this.context,this.transform.projection),i._tileBoundsBuffer?{tileBoundsBuffer:i._tileBoundsBuffer,tileBoundsIndexBuffer:i._tileBoundsIndexBuffer,tileBoundsSegments:i._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){let i=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,i.TRIANGLES,Li.disabled,this.stencilClearMode,Tn.disabled,ln.disabled,es(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(i,a,f){if(!a||this.currentStencilSource===a.id||!i.isTileClipped()||!f||f.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let C=!1;for(let z of f)if(this._tileClippingMaskIDs[z.key]===void 0){C=!0;break}if(!C)return}this.currentStencilSource=a.id;let g=this.context,v=g.gl;this.nextStencilID+f.length>256&&this.clearStencil(),g.setColorMode(Tn.disabled),g.setDepthMode(Li.disabled);let S=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(let C of f){let z=a.getTile(C),N=this._tileClippingMaskIDs[C.key]=this.nextStencilID++,{tileBoundsBuffer:U,tileBoundsIndexBuffer:$,tileBoundsSegments:Z}=this.getTileBoundsBuffers(z);S.draw(this,v.TRIANGLES,Li.disabled,new hn({func:v.ALWAYS,mask:0},N,255,v.KEEP,v.KEEP,v.REPLACE),Tn.disabled,ln.disabled,es(C.projMatrix),"$clipping",U,$,Z)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();let i=this.nextStencilID++,a=this.context.gl;return new hn({func:a.NOTEQUAL,mask:255},i,255,a.KEEP,a.KEEP,a.REPLACE)}stencilModeForClipping(i){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(i);let a=this.context.gl;return new hn({func:a.EQUAL,mask:255},this._tileClippingMaskIDs[i.key],0,a.KEEP,a.KEEP,a.REPLACE)}stencilConfigForOverlap(i){let a=this.context.gl,f=i.sort((S,C)=>C.overscaledZ-S.overscaledZ),g=f[f.length-1].overscaledZ,v=f[0].overscaledZ-g+1;if(v>1){this.currentStencilSource=void 0,this.nextStencilID+v>256&&this.clearStencil();let S={};for(let C=0;C<v;C++)S[C+g]=new hn({func:a.GEQUAL,mask:255},C+this.nextStencilID,255,a.KEEP,a.KEEP,a.REPLACE);return this.nextStencilID+=v,[S,f]}return[{[g]:hn.disabled},f]}colorModeForRenderPass(){let i=this.context.gl;return this._showOverdrawInspector?new Tn([i.CONSTANT_COLOR,i.ONE,i.CONSTANT_COLOR,i.ONE],new t.am(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Tn.unblended:Tn.alphaBlended}colorModeForDrapableLayerRenderPass(i){let a=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new Tn([a.ONE,a.ONE_MINUS_SRC_ALPHA,a.CONSTANT_ALPHA,a.ONE_MINUS_SRC_ALPHA],new t.am(0,0,0,i===void 0?0:i),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(i,a,f,g=!1){if(this.depthOcclusion)return new Li(this.context.gl.GREATER,Li.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!g)return Li.disabled;let v=1-((1+this.currentLayer)*this.numSublayers+i)*this.depthEpsilon;return new Li(f||this.context.gl.LEQUAL,a,[v,v])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){let i=this.context.gl,a=Math.ceil(this.width),f=Math.ceil(this.height),g=this.context.bindFramebuffer.get(),v=i.getParameter(i.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===a&&this.depthFBO.height===f||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),a!==0&&f!==0&&(this.depthFBO=new Gh(this.context,a,f,!1,"texture"),this.depthTexture=new t.T(this.context,{width:a,height:f,data:null},i.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(g),i.bindTexture(i.TEXTURE_2D,v),this.depthFBO&&(i.bindFramebuffer(i.READ_FRAMEBUFFER,null),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),i.blitFramebuffer(0,0,a,f,0,0,a,f,i.DEPTH_BUFFER_BIT,i.NEAREST),i.bindFramebuffer(i.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((i,a)=>i+a/this._fpsHistory.length,0))}render(i,a){let f=t.q.now();this._dt=f-this._timeStamp,this._timeStamp=f,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=i.map.repaint,this.style=i,this.options=a;let g=this.style._mergedLayers,v=!(!this.terrain||!this.terrain.enabled),S=()=>this.style._getOrder(v).filter(vt=>{let Ct=g[vt];return!(Ct.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[Ct.type]}),C=S(),z=!1,N=!1;for(let vt of C){let Ct=g[vt];Ct.type==="circle"&&(z=!0),Ct.type==="symbol"&&(Ct.hasInitialOcclusionOpacityProperties?N=!0:z=!0)}let U=C.map(vt=>g[vt]),$=this.style._mergedSourceCaches;this.imageManager=i.imageManager,this.modelManager=i.modelManager,this.symbolFadeChange=i.placement.symbolFadeChange(t.q.now()),this.imageManager.beginFrame();let Z=0,X=!1;for(let vt in $){let Ct=$[vt];Ct.used&&(Ct.prepare(this.context),Ct.getSource().usedInConflation&&++Z)}let se=!1;for(let vt of U)vt.isHidden(this.transform.zoom)||(vt.type==="clip"&&(se=!0),this.prepareLayer(vt));let re={},he={},ae={},be={},Pe={};for(let vt in $){let Ct=$[vt];re[vt]=Ct.getVisibleCoordinates(),he[vt]=re[vt].slice().reverse(),ae[vt]=Ct.getVisibleCoordinates(!0).reverse(),be[vt]=Ct.getShadowCasterCoordinates(),Pe[vt]=Ct.sortCoordinatesByDistance(re[vt])}let Re=vt=>{let Ct=this.style.getLayerSourceCache(vt);return Ct&&Ct.used?Ct.getSource():null};if(Z||se||this._clippingActiveLastFrame){let vt=[],Ct=[],_t=0;for(let qt of U)this.isSourceForClippingOrConflation(qt,Re(qt))&&(vt.push(qt),Ct.push(_t)),_t++;if(vt&&(se||vt.length>1)||this._clippingActiveLastFrame){se=!1;let qt=[];for(let Pt=0;Pt<vt.length;Pt++){let ti=vt[Pt],Gt=Ct[Pt],ii=this.style.getLayerSourceCache(ti);if(!ii||!ii.used||!ii.getSource().usedInConflation&&ti.type!=="clip")continue;let oi=t.ev,ki=t.bQ.None,ji=[],zi=!0;if(ti.type==="clip"){oi=Gt;for(let $i of ti.layout.get("clip-layer-types"))ki|=$i==="model"?t.bQ.Model:$i==="symbol"?t.bQ.Symbol:t.bQ.FillExtrusion;for(let $i of ti.layout.get("clip-layer-scope"))ji.push($i);ti.isHidden(this.transform.zoom)?zi=!1:se=!0}zi&&qt.push({layer:ti.fqid,cache:ii,order:oi,clipMask:ki,clipScope:ji})}this.replacementSource.setSources(qt),X=!0}}this._clippingActiveLastFrame=se,X||this.replacementSource.clear(),this.conflationActive=X,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let vt=0;vt<U.length;vt++){let Ct=U[vt],_t=Ct.cutoffRange();if(this.longestCutoffRange=Math.max(_t,this.longestCutoffRange),_t>0){let qt=Re(Ct);qt&&(this.minCutoffZoom=Math.max(qt.minzoom,this.minCutoffZoom)),Ct.minzoom&&(this.minCutoffZoom=Math.max(Ct.minzoom,this.minCutoffZoom))}Ct.is3D(v)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=vt),this._lastOcclusionLayer=vt)}let Ge=this.style&&this.style.fog;Ge?(this._fogVisible=Ge.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=Ge.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(ae),this.opaquePassCutoff=0,C=S(),U=C.map(vt=>g[vt]));let Ne=this._shadowRenderer;if(Ne){Ne.updateShadowParameters(this.transform,this.style.directionalLight);for(let vt in $)for(let Ct of re[vt]){let _t={min:0,max:0};this.terrain&&(_t=this.terrain.getMinMaxForTile(Ct)||_t),Ne.addShadowReceiver(Ct.toUnwrapped(),_t.min,_t.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new t.eu(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Xe(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);let Ve=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),Oe=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(Ve&&!this._snow&&(this._snow=new Rr(this)),!Ve&&this._snow&&(this._snow.destroy(),delete this._snow),Oe&&!this._rain&&(this._rain=new aa(this)),!Oe&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),!Os.has(this.context.gl))return;this.renderPass="offscreen";for(let vt of U){let Ct=i.getLayerSourceCache(vt);if(!vt.hasOffscreenPass()||vt.isHidden(this.transform.zoom))continue;let _t=Ct?he[Ct.id]:void 0;(vt.type==="custom"||vt.type==="raster"||vt.type==="raster-particle"||vt.isSky()||_t&&_t.length)&&this.renderLayer(this,Ct,vt,_t)}this.depthRangeFor3D=[0,1-(U.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,be)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let Ke=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),Qe=(()=>{if(a.showOverdrawInspector)return t.am.black;let vt=this.style.fog;if(vt&&this.transform.projection.supportsFog){let Ct=this.style.getLut(vt.scope);if(!Ke){let _t=vt.properties.get("color-use-theme")==="none",qt=vt.properties.get("color").toRenderColor(_t?null:Ct).toArray01();return new t.am(...qt)}if(Ke){let _t=vt.properties.get("space-color-use-theme")==="none",qt=vt.properties.get("space-color").toRenderColor(_t?null:Ct).toArray01();return new t.am(...qt)}}return t.am.transparent})();if(this.context.clear({color:Qe,depth:1}),this.clearStencil(),this._showOverdrawInspector=a.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&Ke&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=C.length-1;this.currentLayer>=0;this.currentLayer--){let vt=U[this.currentLayer],Ct=i.getLayerSourceCache(vt);if(vt.isSky())continue;let _t=Ct?(vt.is3D(v)?Pe:he)[Ct.id]:void 0;this._renderTileClippingMasks(vt,Ct,_t),this.renderLayer(this,Ct,vt,_t)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&Ke&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||t.ah(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<C.length;this.currentLayer++){let vt=U[this.currentLayer],Ct=i.getLayerSourceCache(vt);vt.isSky()&&this.renderLayer(this,Ct,vt,Ct?he[Ct.id]:void 0)}function It(vt,Ct){let _t;return Ct&&(_t=(vt.type==="symbol"?ae:vt.is3D(v)?Pe:he)[Ct.id]),_t}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<C.length;){let vt=U[this.currentLayer];if(vt.type==="raster"||vt.type==="raster-particle"){let Ct=i.getLayerSourceCache(vt);this.renderLayer(this,Ct,vt,It(vt,Ct))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let gt=0;Ne&&(gt=Ne.getShadowCastingLayerCount());let jt=!1,Ut=-1;for(let vt=0;vt<C.length;++vt){let Ct=U[vt];Ct.isHidden(this.transform.zoom)||Ct.is3D(v)&&(Ut=vt)}N&&Ut===-1&&(z=!0);let fi=!1;for(;this.currentLayer<C.length;){let vt=U[this.currentLayer],Ct=i.getLayerSourceCache(vt);if(vt.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(vt)){if(vt.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!fi&&vt.is3D(v)&&!v){let _t=this.currentLayer,qt=Pt=>{for(this.currentLayer=0;this.currentLayer<U.length;this.currentLayer++){let ti=U[this.currentLayer];if(la[ti.type]){let Gt=this.style.getLayerSourceCache(ti);la[ti.type](this,Gt,ti,It(ti,Gt),Pt)}}};qt("initialize"),qt("reset"),this.currentLayer=_t,fi=!0}if(z&&!jt&&this.terrain&&!this.transform.isOrthographic&&(jt=!0,this.blitDepth()),N&&Ut!==-1&&this.currentLayer===Ut+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(vt,Ct,Ct?re[Ct.id]:void 0),this.renderLayer(this,Ct,vt,It(vt,Ct)),!this.terrain&&Ne&&gt>0&&vt.hasShadowPass()&&--gt==0&&(Ne.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){let _t=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=_t;this.currentLayer++){let qt=U[this.currentLayer];if(!qt.hasLightBeamPass())continue;let Pt=i.getLayerSourceCache(qt);this.renderLayer(this,Pt,qt,Pt?he[Pt.id]:void 0)}this.currentLayer=_t,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){let _t=this.currentLayer;this.depthOcclusion=!0;for(let qt of this.layersWithOcclusionOpacity){this.currentLayer=qt;let Pt=U[this.currentLayer],ti=i.getLayerSourceCache(Pt),Gt=ti?he[ti.id]:void 0;this.terrain||this._renderTileClippingMasks(Pt,ti,ti?re[ti.id]:void 0),this.renderLayer(this,ti,Pt,Gt)}this.depthOcclusion=!1,this.currentLayer=_t,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let vt=null;U.forEach(Ct=>{let _t=i.getLayerSourceCache(Ct);_t&&!Ct.isHidden(this.transform.zoom)&&_t.getVisibleCoordinates().length&&(!vt||vt.getSource().maxzoom<_t.getSource().maxzoom)&&(vt=_t)}),vt&&this.options.showTileBoundaries&&Kn.debug(this,vt,vt.getVisibleCoordinates(),t.am.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&Kn.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new t.am(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(vt){let Ct=vt.transform.padding;w(vt,vt.transform.height-(Ct.top||0),3,rd),w(vt,Ct.bottom||0,3,ip),A(vt,Ct.left||0,3,M),A(vt,vt.transform.width-(Ct.right||0),3,r);let _t=vt.transform.centerPoint;(function(qt,Pt,ti,Gt){k(qt,Pt-1,ti-10,2,20,Gt),k(qt,Pt-10,ti-1,20,2,Gt)})(vt,_t.x,vt.transform.height-_t.y,h)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),X||(this.conflationActive=!1)}prepareLayer(i){this.gpuTimingStart(i);let{unsupportedLayers:a}=this.transform.projection,f=!a||!a.includes(i.type);if(Ac[i.type]&&(f||this.terrain&&i.type==="custom")){let g=this.style.getLayerSourceCache(i);Ac[i.type](i,g,this)}this.gpuTimingEnd()}renderLayer(i,a,f,g){f.isHidden(this.transform.zoom)||(f.type==="background"||f.type==="sky"||f.type==="custom"||f.type==="model"||f.type==="raster"||f.type==="raster-particle"||g&&g.length)&&(this.id=f.id,this.gpuTimingStart(f),i.transform.projection.unsupportedLayers&&i.transform.projection.unsupportedLayers.includes(f.type)&&(!i.terrain||f.type!=="custom")||f.type==="clip"||Kn[f.type](i,a,f,g,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(i){if(!this.options.gpuTiming)return;let a=this.context.extTimerQuery,f=this.context.gl,g=this.gpuTimers[i.id];g||(g=this.gpuTimers[i.id]={calls:0,cpuTime:0,query:f.createQuery()}),g.calls++,f.beginQuery(a.TIME_ELAPSED_EXT,g.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){let i=this.context.extTimerQuery,a=this.context.gl,f=a.createQuery();this.deferredRenderGpuTimeQueries.push(f),a.beginQuery(i.TIME_ELAPSED_EXT,f)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){let i=this.gpuTimers;return this.gpuTimers={},i}collectDeferredRenderGpuQueries(){let i=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],i}queryGpuTimers(i){let a={};for(let f in i){let g=i[f],v=this.context.extTimerQuery,S=v.getQueryParameter(g.query,this.context.gl.QUERY_RESULT)/1e6;v.deleteQueryEXT(g.query),a[f]=S}return a}queryGpuTimeDeferredRender(i){if(!this.options.gpuTimingDeferredRender)return 0;let a=this.context.gl,f=0;for(let g of i)f+=a.getQueryParameter(g,a.QUERY_RESULT)/1e6,a.deleteQuery(g);return f}translatePosMatrix(i,a,f,g,v){if(!f[0]&&!f[1])return i;let S=v?g==="map"?this.transform.angle:0:g==="viewport"?-this.transform.angle:0;if(S){let N=Math.sin(S),U=Math.cos(S);f=[f[0]*U-f[1]*N,f[0]*N+f[1]*U]}let C=[v?f[0]:t.aw(a,f[0],this.transform.zoom),v?f[1]:t.aw(a,f[1],this.transform.zoom),0],z=new Float32Array(16);return t.bo(z,i,C),z}saveTileTexture(i){let a=i.size[0],f=this._tileTextures[a];f?f.push(i):this._tileTextures[a]=[i]}getTileTexture(i){let a=this._tileTextures[i];return a&&a.length>0?a.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(i,a,f){let g=f===void 0?this.terrain&&this.terrain.renderingToTexture:f,v=[];return this.style&&this.style.enable3dLights()&&(i==="globeRaster"||i==="terrainRaster"?(v.push("LIGHTING_3D_MODE"),v.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):g||v.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||v.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(v.push("TERRAIN"),this.linearFloatFilteringSupported()&&v.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&v.push("GLOBE"),!this._fogVisible||g||a!==void 0&&!a||v.push("FOG","FOG_DITHERING"),g&&v.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&v.push("OVERDRAW_INSPECTOR"),v}getOrCreateProgram(i,a){this.cache=this.cache||{};let f=a&&a.defines||[],g=a&&a.config,v=this.currentGlobalDefines(i,a&&a.overrideFog,a&&a.overrideRtt).concat(f),S=xu.cacheKey(Bl[i],i,v,g);return this.cache[S]||(this.cache[S]=new xu(this.context,i,Bl[i],g,Pm[i],v)),this.cache[S]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){let i=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(i.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new t.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(i,a){if(this.style.enable3dLights()){let f=this.style.directionalLight,g=this.style.ambientLight;if(f&&g){let v=((S,C,z)=>{let N=S.properties.get("direction"),U=S.properties.get("color-use-theme")==="none",$=S.properties.get("color").toRenderColor(U?null:z.getLut(S.scope)).toArray01(),Z=S.properties.get("intensity"),X=C.properties.get("color-use-theme")==="none",se=C.properties.get("color").toRenderColor(X?null:z.getLut(C.scope)).toArray01(),re=C.properties.get("intensity"),he=[N.x,N.y,N.z],ae=t.dw(se,re),be=t.dw($,Z);return{u_lighting_ambient_color:ae,u_lighting_directional_dir:he,u_lighting_directional_color:be,u_ground_radiance:Xu(he,be,ae)}})(f,g,this.style);a.setLightsUniformValues(i,v)}}}uploadCommonUniforms(i,a,f,g,v){if(this.uploadCommonLightUniforms(i,a),this.terrain&&this.terrain.renderingToTexture)return;let S=this.style.fog;if(S){let C=S.getOpacity(this.transform.pitch),z=((N,U,$,Z,X,se,re,he,ae,be,Pe,Re)=>{let Ge=N.transform,Ne=U.properties.get("color-use-theme")==="none",Ve=U.properties.get("color").toRenderColor(Ne?null:N.style.getLut(U.scope)).toArray01();Ve[3]=Z;let Oe=N.frameCounter/1e3%1,[Ke,Qe]=U.properties.get("vertical-range");return{u_fog_matrix:$?Ge.calculateFogTileMatrix($):Re||N.identityMat,u_fog_range:U.getFovAdjustedRange(Ge._fov),u_fog_color:Ve,u_fog_horizon_blend:U.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(Ke,Qe),Qe],u_fog_temporal_offset:Oe,u_frustum_tl:X,u_frustum_tr:se,u_frustum_br:re,u_frustum_bl:he,u_globe_pos:ae,u_globe_radius:be,u_viewport:Pe,u_globe_transition:t.ah(Ge.zoom),u_is_globe:+(Ge.projection.name==="globe")}})(this,S,f,C,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*t.q.devicePixelRatio,this.transform.height*t.q.devicePixelRatio],g);a.setFogUniformValues(i,z)}v&&a.setCutoffUniformValues(i,v.uniformValues)}setTileLoadedFlag(i){this.tileLoaded=i}saveCanvasCopy(){let i=this.canvasCopy();i&&(this.frameCopies.push(i),this.tileLoaded=!1)}canvasCopy(){let i=this.context.gl,a=i.createTexture();return i.bindTexture(i.TEXTURE_2D,a),i.copyTexImage2D(i.TEXTURE_2D,0,i.RGBA,0,0,i.drawingBufferWidth,i.drawingBufferHeight,0),a}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;let i=this.style&&this.style.fog;return!!i&&i.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){let i=this._backgroundTiles,a=this._backgroundTiles={},f=this.transform.coveringTiles({tileSize:512});for(let g of f)a[g.key]=i[g.key]||new Ta(g,512,this.transform.tileZoom,this);return a}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(i,a){return!(!i.is3D(!(!this.terrain||!this.terrain.enabled))||i.type!=="clip"&&(i.minzoom&&i.minzoom>this.transform.zoom||(this.style._clipLayerPresent||i.sourceLayer!=="building")&&(!a||a.type!=="batched-model")))}isTileAffectedByFog(i){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let a=this._cachedTileFogOpacities[i.key];return a||(this._cachedTileFogOpacities[i.key]=a=this.style.fog.getOpacityForTile(i)),a[0]>=Ii||a[1]>=Ii}setupDepthForOcclusion(i,a,f){let g=this.context,v=g.gl,S=!!f;var C;f||(f={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),g.activeTexture.set(v.TEXTURE3),i&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(v.NEAREST,v.CLAMP_TO_EDGE),f.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],f.u_depth_range_unpack=[2/((C=this.depthRangeFor3D)[1]-C[0]),-1-2*C[0]/(C[1]-C[0])],f.u_occluder_half_size=.5*this.occlusionParams.occluderSize,f.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(v.NEAREST,v.CLAMP_TO_EDGE),g.activeTexture.set(v.TEXTURE0),S||a.setTerrainUniformValues(g,f)}}function uc(p,i){let a=!1,f=null,g=()=>{f=null,a&&(p(),f=setTimeout(g,i),a=!1)};return()=>(a=!0,f||g(),f)}class dc{constructor(i){this._hashName=i&&encodeURIComponent(i),t.aV(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=uc(this._updateHashUnthrottled.bind(this),300)}addTo(i){return this._map=i,window.addEventListener("hashchange",this._onHashChange,!1),i.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){let i=this._map;if(!i)return"";let a=Ca(i);if(this._hashName){let f=this._hashName,g=!1,v=location.hash.slice(1).split("&").map(S=>{let C=S.split("=")[0];return C===f?(g=!0,`${C}=${a}`):S}).filter(S=>S);return g||v.push(`${f}=${a}`),`#${v.join("&")}`}return`#${a}`}_getCurrentHash(){let i=location.hash.replace("#","");if(this._hashName){let a;return i.split("&").map(f=>f.split("=")).forEach(f=>{f[0]===this._hashName&&(a=f)}),(a&&a[1]||"").split("/")}return i.split("/")}_onHashChange(){let i=this._map;if(!i)return!1;let a=this._getCurrentHash();if(a.length>=3&&!a.some(f=>isNaN(Number(f)))){let f=i.dragRotate.isEnabled()&&i.touchZoomRotate.isEnabled()?+(a[3]||0):i.getBearing();return i.jumpTo({center:[+a[2],+a[1]],zoom:+a[0],bearing:f,pitch:+(a[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Ca(p,i){let a=p.getCenter(),f=Math.round(100*p.getZoom())/100,g=Math.ceil((f*Math.LN2+Math.log(512/360/.5))/Math.LN10),v=Math.pow(10,g),S=Math.round(a.lng*v)/v,C=Math.round(a.lat*v)/v,z=p.getBearing(),N=p.getPitch(),U=i?`/${S}/${C}/${f}`:`${f}/${C}/${S}`;return(z||N)&&(U+="/"+Math.round(10*z)/10),N&&(U+=`/${Math.round(N)}`),U}let Fa={linearity:.3,easing:t.ew(0,0,.3,1)},Dc=t.l({deceleration:2500,maxSpeed:1400},Fa),vh=t.l({deceleration:20,maxSpeed:1400},Fa),So=t.l({deceleration:1e3,maxSpeed:360},Fa),io=t.l({deceleration:1e3,maxSpeed:90},Fa);class ca{constructor(i){this._map=i,this.clear()}clear(){this._inertiaBuffer=[]}record(i){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:t.q.now(),settings:i})}_drainInertiaBuffer(){let i=this._inertiaBuffer,a=t.q.now();for(;i.length>0&&a-i[0].time>160;)i.shift()}_onMoveEnd(i){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;let a={zoom:0,bearing:0,pitch:0,pan:new t.P(0,0),pinchAround:void 0,around:void 0};for(let{settings:v}of this._inertiaBuffer)a.zoom+=v.zoomDelta||0,a.bearing+=v.bearingDelta||0,a.pitch+=v.pitchDelta||0,v.panDelta&&a.pan._add(v.panDelta),v.around&&(a.around=v.around),v.pinchAround&&(a.pinchAround=v.pinchAround);let f=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,g={};if(a.pan.mag()){let v=Su(a.pan.mag(),f,t.l({},Dc,i||{}));g.offset=a.pan.mult(v.amount/a.pan.mag()),g.center=this._map.transform.center,ts(g,v)}if(a.zoom){let v=Su(a.zoom,f,vh);g.zoom=this._map.transform.zoom+v.amount,ts(g,v)}if(a.bearing){let v=Su(a.bearing,f,So);g.bearing=this._map.transform.bearing+t.aD(v.amount,-179,179),ts(g,v)}if(a.pitch){let v=Su(a.pitch,f,io);g.pitch=this._map.transform.pitch+v.amount,ts(g,v)}if(g.zoom||g.bearing){let v=a.pinchAround===void 0?a.around:a.pinchAround;g.around=v?this._map.unproject(v):this._map.getCenter()}return this.clear(),g.noMoveStart=!0,g}}function ts(p,i){(!p.duration||p.duration<i.duration)&&(p.duration=i.duration,p.easing=i.easing)}function Su(p,i,a){let{maxSpeed:f,linearity:g,deceleration:v}=a,S=t.aD(p*g/(i/1e3),-f,f),C=Math.abs(S)/(v*g);return{easing:a.easing,duration:1e3*C,amount:S*(C/2)}}class el extends t.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(i,a,f,g={}){let v=ga(a.getCanvasContainer(),f),S=a.unproject(v);super(i,t.l({point:v,lngLat:S,originalEvent:f},g)),this._defaultPrevented=!1,this.target=a}}class jl extends t.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(i,a,f){let g=i==="touchend"?f.changedTouches:f.touches,v=Aa(a.getCanvasContainer(),g),S=v.map(z=>a.unproject(z)),C=v.reduce((z,N,U,$)=>z.add(N.div($.length)),new t.P(0,0));super(i,{points:v,point:C,lngLats:S,lngLat:a.unproject(C),originalEvent:f}),this._defaultPrevented=!1}}class Iu extends t.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(i,a){super("wheel",{originalEvent:a}),this._defaultPrevented=!1}}class xl{constructor(i,a){this._map=i,this._clickTolerance=a.clickTolerance}reset(){this._mousedownPos=void 0}wheel(i){return this._firePreventable(new Iu(this._map,i))}mousedown(i,a){return this._mousedownPos=a,this._firePreventable(new el(i.type,this._map,i))}mouseup(i){this._map.fire(new el(i.type,this._map,i))}preclick(i){let a=t.l({},i);a.type="preclick",this._map.fire(new el(a.type,this._map,a))}click(i,a){this._mousedownPos&&this._mousedownPos.dist(a)>=this._clickTolerance||(this.preclick(i),this._map.fire(new el(i.type,this._map,i)))}dblclick(i){return this._firePreventable(new el(i.type,this._map,i))}mouseover(i){this._map.fire(new el(i.type,this._map,i))}mouseout(i){this._map.fire(new el(i.type,this._map,i))}touchstart(i){return this._firePreventable(new jl(i.type,this._map,i))}touchmove(i){this._map.fire(new jl(i.type,this._map,i))}touchend(i){this._map.fire(new jl(i.type,this._map,i))}touchcancel(i){this._map.fire(new jl(i.type,this._map,i))}_firePreventable(i){if(this._map.fire(i),i.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class pc{constructor(i){this._map=i}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(i){this._map.fire(new el(i.type,this._map,i))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new el("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(i){this._delayContextMenu?this._contextMenuEvent=i:this._map.fire(new el(i.type,this._map,i)),this._map.listens("contextmenu")&&i.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Us{constructor(i,a){this._map=i,this._el=i.getCanvasContainer(),this._container=i.getContainer(),this._clickTolerance=a.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(i,a){this.isEnabled()&&i.shiftKey&&i.button===0&&(qo(),this._startPos=this._lastPos=a,this._active=!0)}mousemoveWindow(i,a){if(!this._active)return;let f=a,g=this._startPos,v=this._lastPos;if(!g||!v||v.equals(f)||!this._box&&f.dist(g)<this._clickTolerance)return;this._lastPos=f,this._box||(this._box=on("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",i));let S=Math.min(g.x,f.x),C=Math.max(g.x,f.x),z=Math.min(g.y,f.y),N=Math.max(g.y,f.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${S}px,${z}px)`,this._box.style.width=C-S+"px",this._box.style.height=N-z+"px")})}mouseupWindow(i,a){if(!this._active)return;let f=this._startPos,g=a;if(f&&i.button===0){if(this.reset(),os(),f.x!==g.x||f.y!==g.y)return this._map.fire(new t.A("boxzoomend",{originalEvent:i})),{cameraAnimation:v=>v.fitScreenCoordinates(f,g,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",i)}}keydown(i){this._active&&i.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",i))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),to(),delete this._startPos,delete this._lastPos}_fireEvent(i,a){return this._map.fire(new t.A(i,{originalEvent:a}))}}function vl(p,i){let a={};for(let f=0;f<p.length;f++)a[p[f].identifier]=i[f];return a}class np{constructor(i){this.reset(),this.numTouches=i.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(i,a,f){(this.centroid||f.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=i.timeStamp),f.length===this.numTouches&&(this.centroid=function(g){let v=new t.P(0,0);for(let S of g)v._add(S);return v.div(g.length)}(a),this.touches=vl(f,a)))}touchmove(i,a,f){if(this.aborted||!this.centroid)return;let g=vl(f,a);for(let v in this.touches){let S=g[v];(!S||S.dist(this.touches[v])>30)&&(this.aborted=!0)}}touchend(i,a,f){if((!this.centroid||i.timeStamp-this.startTime>500)&&(this.aborted=!0),f.length===0){let g=!this.aborted&&this.centroid;if(this.reset(),g)return g}}}class zo{constructor(i){this.singleTap=new np(i),this.numTaps=i.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(i,a,f){this.singleTap.touchstart(i,a,f)}touchmove(i,a,f){this.singleTap.touchmove(i,a,f)}touchend(i,a,f){let g=this.singleTap.touchend(i,a,f);if(g){let v=i.timeStamp-this.lastTime<500,S=!this.lastTap||this.lastTap.dist(g)<30;if(v&&S||this.reset(),this.count++,this.lastTime=i.timeStamp,this.lastTap=g,this.count===this.numTaps)return this.reset(),g}}}class rp{constructor(){this._zoomIn=new zo({numTouches:1,numTaps:2}),this._zoomOut=new zo({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(i,a,f){this._zoomIn.touchstart(i,a,f),this._zoomOut.touchstart(i,a,f)}touchmove(i,a,f){this._zoomIn.touchmove(i,a,f),this._zoomOut.touchmove(i,a,f)}touchend(i,a,f){let g=this._zoomIn.touchend(i,a,f),v=this._zoomOut.touchend(i,a,f);return g?(this._active=!0,i.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:S=>S.easeTo({duration:300,zoom:S.getZoom()+1,around:S.unproject(g)},{originalEvent:i})}):v?(this._active=!0,i.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:S=>S.easeTo({duration:300,zoom:S.getZoom()-1,around:S.unproject(v)},{originalEvent:i})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}let op={0:1,2:2},Gl={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class Wp{constructor(i){this.reset(),this._clickTolerance=i.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(i,a){return!1}_move(i,a){return{}}mousedown(i,a){if(this._lastPoint)return;let f=Ql(i);this._correctButton(i,f)&&(this._lastPoint=a,this._eventButton=f)}mousemoveWindow(i,a){let f=this._lastPoint;if(f){if(i.preventDefault(),this._eventButton!=null&&function(g,v){let S=op[v];return g.buttons===void 0||(g.buttons&S)!==S}(i,this._eventButton))this.reset();else if(this._moved||!(a.dist(f)<this._clickTolerance))return this._moved=!0,this._lastPoint=a,this._move(f,a)}}mouseupWindow(i){this._lastPoint&&Ql(i)===this._eventButton&&(this._moved&&os(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Cu extends Wp{mousedown(i,a){super.mousedown(i,a),this._lastPoint&&(this._active=!0)}_correctButton(i,a){return a===0&&!i.ctrlKey}_move(i,a){return{around:a,panDelta:a.sub(i)}}}class $h extends Wp{constructor(i){super(i),this._pitchRotateKey=i.pitchRotateKey?Gl[i.pitchRotateKey]:void 0}_correctButton(i,a){return this._pitchRotateKey?a===0&&i[this._pitchRotateKey]:a===0&&i.ctrlKey||a===2}_move(i,a){let f=.8*(a.x-i.x);if(f)return this._active=!0,{bearingDelta:f}}contextmenu(i){this._pitchRotateKey||i.preventDefault()}}class od extends Wp{constructor(i){super(i),this._pitchRotateKey=i.pitchRotateKey?Gl[i.pitchRotateKey]:void 0}_correctButton(i,a){return this._pitchRotateKey?a===0&&i[this._pitchRotateKey]:a===0&&i.ctrlKey||a===2}_move(i,a){let f=-.5*(a.y-i.y);if(f)return this._active=!0,{pitchDelta:f}}contextmenu(i){this._pitchRotateKey||i.preventDefault()}}class Am{constructor(i,a){this._map=i,this._el=i.getCanvasContainer(),this._minTouches=1,this._clickTolerance=a.clickTolerance||1,this.reset(),t.aV(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new t.P(0,0)}touchstart(i,a,f){return this._calculateTransform(i,a,f)}touchmove(i,a,f){if(this._active&&!(f.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(f.length===1&&!t.ex())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return i.cancelable&&i.preventDefault(),this._calculateTransform(i,a,f)}}touchend(i,a,f){this._calculateTransform(i,a,f),this._active&&f.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(i,a,f){f.length>0&&(this._active=!0);let g=vl(f,a),v=new t.P(0,0),S=new t.P(0,0),C=0;for(let N in g){let U=g[N],$=this._touches[N];$&&(v._add(U),S._add(U.sub($)),C++,g[N]=U)}if(this._touches=g,C<this._minTouches||!S.mag())return;let z=S.div(C);return this._sum._add(z),this._sum.mag()<this._clickTolerance?void 0:{around:v.div(C),panDelta:z}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=on("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class sp{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(i){}_move(i,a,f){return{}}touchstart(i,a,f){this._firstTwoTouches||f.length<2||(this._firstTwoTouches=[f[0].identifier,f[1].identifier],this._start([a[0],a[1]]))}touchmove(i,a,f){let g=this._firstTwoTouches;if(!g)return;i.preventDefault();let[v,S]=g,C=ap(f,a,v),z=ap(f,a,S);if(!C||!z)return;let N=this._aroundCenter?null:C.add(z).div(2);return this._move([C,z],N,i)}touchend(i,a,f){if(!this._firstTwoTouches)return;let[g,v]=this._firstTwoTouches,S=ap(f,a,g),C=ap(f,a,v);S&&C||(this._active&&os(),this.reset())}touchcancel(){this.reset()}enable(i){this._enabled=!0,this._aroundCenter=!!i&&i.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function ap(p,i,a){for(let f=0;f<p.length;f++)if(p[f].identifier===a)return i[f]}function _f(p,i){return Math.log(p/i)/Math.LN2}class Zf extends sp{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(i){this._startDistance=this._distance=i[0].dist(i[1])}_move(i,a){let f=this._distance;if(this._distance=i[0].dist(i[1]),this._active||!(Math.abs(_f(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:_f(this._distance,f),pinchAround:a}}}function qf(p,i){return 180*p.angleWith(i)/Math.PI}class $f extends sp{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(i){this._startVector=this._vector=i[0].sub(i[1]),this._minDiameter=i[0].dist(i[1])}_move(i,a){let f=this._vector;if(this._vector=i[0].sub(i[1]),f&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:qf(this._vector,f),pinchAround:a}}_isBelowThreshold(i){this._minDiameter=Math.min(this._minDiameter,i.mag());let a=25/(Math.PI*this._minDiameter)*360,f=this._startVector;if(!f)return!1;let g=qf(i,f);return Math.abs(g)<a}}function Wf(p){return Math.abs(p.y)>Math.abs(p.x)}class Hf extends sp{constructor(i){super(),this._map=i}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(i){this._lastPoints=i,Wf(i[0].sub(i[1]))&&(this._valid=!1)}_move(i,a,f){let g=this._lastPoints;if(!g)return;let v=i[0].sub(g[0]),S=i[1].sub(g[1]);return this._map._cooperativeGestures&&!t.ex()&&f.touches.length<3||(this._valid=this.gestureBeginsVertically(v,S,f.timeStamp),!this._valid)?void 0:(this._lastPoints=i,this._active=!0,{pitchDelta:(v.y+S.y)/2*-.5})}gestureBeginsVertically(i,a,f){if(this._valid!==void 0)return this._valid;let g=i.mag()>=2,v=a.mag()>=2;if(!g&&!v)return;if(!g||!v)return this._firstMove==null&&(this._firstMove=f),f-this._firstMove<100&&void 0;let S=i.y>0==a.y>0;return Wf(i)&&Wf(a)&&S}}let Dm={panStep:100,bearingStep:15,pitchStep:10};class Rm{constructor(){let i=Dm;this._panStep=i.panStep,this._bearingStep=i.bearingStep,this._pitchStep=i.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(i){if(i.altKey||i.ctrlKey||i.metaKey)return;let a=0,f=0,g=0,v=0,S=0;switch(i.keyCode){case 61:case 107:case 171:case 187:a=1;break;case 189:case 109:case 173:a=-1;break;case 37:i.shiftKey?f=-1:(i.preventDefault(),v=-1);break;case 39:i.shiftKey?f=1:(i.preventDefault(),v=1);break;case 38:i.shiftKey?g=1:(i.preventDefault(),S=-1);break;case 40:i.shiftKey?g=-1:(i.preventDefault(),S=1);break;default:return}return this._rotationDisabled&&(f=0,g=0),{cameraAnimation:C=>{let z=C.getZoom();C.easeTo({duration:300,easeId:"keyboardHandler",easing:lp,zoom:a?Math.round(z)+a*(i.shiftKey?2:1):z,bearing:C.getBearing()+f*this._bearingStep,pitch:C.getPitch()+g*this._pitchStep,offset:[-v*this._panStep,-S*this._panStep],center:C.getCenter()},{originalEvent:i})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function lp(p){return p*(2-p)}let zm=4.000244140625,Hp=1/450;class gf{constructor(i,a){this._map=i,this._el=i.getCanvasContainer(),this._handler=a,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Hp,t.aV(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(i){this._defaultZoomRate=i}setWheelZoomRate(i){this._wheelZoomRate=i}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(i){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!i&&i.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(i){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(i.ctrlKey||i.metaKey||this.isZooming()||t.ex()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let a=i.deltaMode===WheelEvent.DOM_DELTA_LINE?40*i.deltaY:i.deltaY,f=t.q.now(),g=f-(this._lastWheelEventTime||0);this._lastWheelEventTime=f,a!==0&&a%zm==0?this._type="wheel":a!==0&&Math.abs(a)<4?this._type="trackpad":g>400?(this._type=null,this._lastValue=a,this._timeout=window.setTimeout(this._onTimeout,40,i)):this._type||(this._type=Math.abs(g*a)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,a+=this._lastValue)),i.shiftKey&&a&&(a/=4),this._type&&(this._lastWheelEvent=i,this._delta-=a,this._active||this._start(i)),i.preventDefault()}_onTimeout(i){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(i)}_start(i){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);let a=ga(this._el,i);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:a,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;let i=this._map.transform;this._type==="wheel"&&i.projection.wrap&&(i._center.lng>=180||i._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);let a=()=>i._terrainEnabled()&&this._aroundCoord?i.computeZoomRelativeTo(this._aroundCoord):i.zoom;if(this._delta!==0){let N=this._type==="wheel"&&Math.abs(this._delta)>zm?this._wheelZoomRate:this._defaultZoomRate,U=2/(1+Math.exp(-Math.abs(this._delta*N)));this._delta<0&&U!==0&&(U=1/U);let $=a(),Z=Math.pow(2,$),X=typeof this._targetZoom=="number"?i.zoomScale(this._targetZoom):Z;this._targetZoom=Math.min(i.maxZoom,Math.max(i.minZoom,i.scaleZoom(X*U))),this._type==="wheel"&&(this._startZoom=$,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}let f=typeof this._targetZoom=="number"?this._targetZoom:a(),g=this._startZoom,v=this._easing,S,C=!1;if(this._type==="wheel"&&g&&v){let N=Math.min((t.q.now()-this._lastWheelEventTime)/200,1),U=v(N);S=t.ai(g,f,U),N<1?this._frameId||(this._frameId=!0):C=!0}else S=f,C=!0;this._active=!0,C&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let z=S-a();return z*this._lastDelta<0&&(z=0),{noInertia:!0,needsRenderFrame:!C,zoomDelta:z,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(i){let a=t.ey;if(this._prevEase){let f=this._prevEase,g=(t.q.now()-f.start)/f.duration,v=f.easing(g+.01)-f.easing(g),S=.27/Math.sqrt(v*v+1e-4)*.01,C=Math.sqrt(.0729-S*S);a=t.ew(S,C,.25,1)}return this._prevEase={start:t.q.now(),duration:i,easing:a},a}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=on("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class yf{constructor(i,a){this._clickZoom=i,this._tapZoom=a}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Lm{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(i,a){return i.preventDefault(),{cameraAnimation:f=>{f.easeTo({duration:300,zoom:f.getZoom()+(i.shiftKey?-1:1),around:f.unproject(a)},{originalEvent:i})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class km{constructor(){this._tap=new zo({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(i,a,f){this._swipePoint||(this._tapTime&&i.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?f.length>0&&(this._swipePoint=a[0],this._swipeTouch=f[0].identifier):this._tap.touchstart(i,a,f))}touchmove(i,a,f){if(this._tapTime){if(this._swipePoint){if(f[0].identifier!==this._swipeTouch)return;let g=a[0],v=g.y-this._swipePoint.y;return this._swipePoint=g,i.preventDefault(),this._active=!0,{zoomDelta:v/128}}}else this._tap.touchmove(i,a,f)}touchend(i,a,f){this._tapTime?this._swipePoint&&f.length===0&&this.reset():this._tap.touchend(i,a,f)&&(this._tapTime=i.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class c_{constructor(i,a,f){this._el=i,this._mousePan=a,this._touchPan=f}enable(i){this._inertiaOptions=i||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class sg{constructor(i,a,f){this._pitchWithRotate=i.pitchWithRotate,this._mouseRotate=a,this._mousePitch=f}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class h_{constructor(i,a,f,g){this._el=i,this._touchZoom=a,this._touchRotate=f,this._tapDragZoom=g,this._rotationDisabled=!1,this._enabled=!0}enable(i){this._touchZoom.enable(i),this._rotationDisabled||this._touchRotate.enable(i),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}let bo=p=>p.zoom||p.drag||p.pitch||p.rotate;class Om extends t.A{}class ag{constructor(){this.constants=[1,1,.01],this.radius=0}setup(i,a){let f=t.at([],a,i);this.radius=t.ae(f[2]<0?t.eA([],f,this.constants):[f[0],f[1],0])}projectRay(i){t.eA(i,i,this.constants),t.au(i,i),t.eB(i,i,this.constants);let a=t.b$([],i,this.radius);if(a[2]>0){let f=t.b$([],[0,0,1],t.bE(a,[0,0,1])),g=t.b$([],t.au([],[a[0],a[1],0]),this.radius),v=t.cU([],a,t.b$([],t.at([],t.cU([],g,f),a),2));a[0]=v[0],a[1]=v[1]}return a}}function sd(p){return p.panDelta&&p.panDelta.mag()||p.zoomDelta||p.bearingDelta||p.pitchDelta}class u_{constructor(i,a){this._map=i,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new ca(i),this._bearingSnap=a.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new ag,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(a),t.aV(["handleEvent","handleWindowEvent"],this);let f=this._el;this._listeners=[[f,"touchstart",{passive:!0}],[f,"touchmove",{passive:!1}],[f,"touchend",void 0],[f,"touchcancel",void 0],[f,"mousedown",void 0],[f,"mousemove",void 0],[f,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[f,"mouseover",void 0],[f,"mouseout",void 0],[f,"dblclick",void 0],[f,"click",void 0],[f,"keydown",{capture:!1}],[f,"keyup",void 0],[f,"wheel",{passive:!1}],[f,"contextmenu",void 0],[window,"blur",void 0]];for(let[g,v,S]of this._listeners){let C=g===document?this.handleWindowEvent:this.handleEvent;g.addEventListener(v,C,S)}}destroy(){for(let[i,a,f]of this._listeners){let g=i===document?this.handleWindowEvent:this.handleEvent;i.removeEventListener(a,g,f)}}_addDefaultHandlers(i){let a=this._map,f=a.getCanvasContainer();this._add("mapEvent",new xl(a,i));let g=a.boxZoom=new Us(a,i);this._add("boxZoom",g);let v=new rp,S=new Lm;a.doubleClickZoom=new yf(S,v),this._add("tapZoom",v),this._add("clickZoom",S);let C=new km;this._add("tapDragZoom",C);let z=a.touchPitch=new Hf(a);this._add("touchPitch",z);let N=new $h(i),U=new od(i);a.dragRotate=new sg(i,N,U),this._add("mouseRotate",N,["mousePitch"]),this._add("mousePitch",U,["mouseRotate"]);let $=new Cu(i),Z=new Am(a,i);a.dragPan=new c_(f,$,Z),this._add("mousePan",$),this._add("touchPan",Z,["touchZoom","touchRotate"]);let X=new $f,se=new Zf;a.touchZoomRotate=new h_(f,se,X,C),this._add("touchRotate",X,["touchPan","touchZoom"]),this._add("touchZoom",se,["touchPan","touchRotate"]),this._add("blockableMapEvent",new pc(a));let re=a.scrollZoom=new gf(a,this);this._add("scrollZoom",re,["mousePan"]);let he=a.keyboard=new Rm;this._add("keyboard",he);for(let ae of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])i.interactive&&i[ae]&&a[ae].enable(i[ae])}_add(i,a,f){this._handlers.push({handlerName:i,handler:a,allowed:f}),this._handlersById[i]=a}stop(i){if(!this._updatingCamera){for(let{handler:a}of this._handlers)a.reset();this._inertia.clear(),this._fireEvents({},{},i),this._changes=[],this._originalZoom=void 0}}isActive(){for(let{handler:i}of this._handlers)if(i.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!bo(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(i,a,f){for(let g in i)if(g!==f&&(!a||a.indexOf(g)<0))return!0;return!1}handleWindowEvent(i){this.handleEvent(i,`${i.type}Window`)}_getMapTouches(i){let a=[];for(let f of i)this._el.contains(f.target)&&a.push(f);return a}handleEvent(i,a){this._updatingCamera=!0;let f=i.type==="renderFrame",g=f?void 0:i,v={needsRenderFrame:!1},S={},C={},z=i.touches?this._getMapTouches(i.touches):void 0,N=z?Aa(this._el,z):f?void 0:ga(this._el,i);for(let{handlerName:Z,handler:X,allowed:se}of this._handlers){if(!X.isEnabled())continue;let re;this._blockedByActive(C,se,Z)?X.reset():X[a||i.type]&&(re=X[a||i.type](i,N,z),this.mergeHandlerResult(v,S,re,Z,g),re&&re.needsRenderFrame&&this._triggerRenderFrame()),(re||X.isActive())&&(C[Z]=X)}let U={};for(let Z in this._previousActiveHandlers)C[Z]||(U[Z]=g);this._previousActiveHandlers=C,(Object.keys(U).length||sd(v))&&(this._changes.push([v,S,U]),this._triggerRenderFrame()),(Object.keys(C).length||sd(v))&&this._map._stop(!0),this._updatingCamera=!1;let{cameraAnimation:$}=v;$&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],$(this._map))}mergeHandlerResult(i,a,f,g,v){if(!f)return;t.l(i,f);let S={handlerName:g,originalEvent:f.originalEvent||v};f.zoomDelta!==void 0&&(a.zoom=S),f.panDelta!==void 0&&(a.drag=S),f.pitchDelta!==void 0&&(a.pitch=S),f.bearingDelta!==void 0&&(a.rotate=S)}_applyChanges(){let i={},a={},f={};for(let[g,v,S]of this._changes)g.panDelta&&(i.panDelta=(i.panDelta||new t.P(0,0))._add(g.panDelta)),g.zoomDelta&&(i.zoomDelta=(i.zoomDelta||0)+g.zoomDelta),g.bearingDelta&&(i.bearingDelta=(i.bearingDelta||0)+g.bearingDelta),g.pitchDelta&&(i.pitchDelta=(i.pitchDelta||0)+g.pitchDelta),g.around!==void 0&&(i.around=g.around),g.aroundCoord!==void 0&&(i.aroundCoord=g.aroundCoord),g.pinchAround!==void 0&&(i.pinchAround=g.pinchAround),g.noInertia&&(i.noInertia=g.noInertia),t.l(a,v),t.l(f,S);this._updateMapTransform(i,a,f),this._changes=[]}_updateMapTransform(i,a,f){let g=this._map,v=g.transform,S=be=>[be.x,be.y,be.z];if((be=>{let Pe=this._eventsInProgress.drag;return Pe&&!this._handlersById[Pe.handlerName].isActive()})()&&!sd(i)){let be=v.zoom;v.cameraElevationReference="sea",this._originalZoom!=null&&v._orthographicProjectionAtLowPitch&&v.projection.name!=="globe"&&v.pitch===0?(v.cameraElevationReference="ground",v.zoom=this._originalZoom):(v.recenterOnTerrain(),v.cameraElevationReference="ground"),be!==v.zoom&&this._map._update(!0)}if(v._isCameraConstrained&&g._stop(!0),!sd(i))return void this._fireEvents(a,f,!0);let{panDelta:C,zoomDelta:z,bearingDelta:N,pitchDelta:U,around:$,aroundCoord:Z,pinchAround:X}=i;v._isCameraConstrained&&(z>0&&(z=0),v._isCameraConstrained=!1),X!==void 0&&($=X),(z||(be=>a[be]&&!this._eventsInProgress[be])("drag"))&&$&&(this._dragOrigin=S(v.pointCoordinate3D($)),this._originalZoom=v.zoom,this._trackingEllipsoid.setup(v._camera.position,this._dragOrigin)),v.cameraElevationReference="sea",g._stop(!0),$=$||g.transform.centerPoint,N&&(v.bearing+=N),U&&(v.pitch+=U),v._updateCameraState();let se=[0,0,0];if(C)if(v.projection.name==="mercator"){let be=this._trackingEllipsoid.projectRay(v.screenPointToMercatorRay($).dir),Pe=this._trackingEllipsoid.projectRay(v.screenPointToMercatorRay($.sub(C)).dir);se[0]=Pe[0]-be[0],se[1]=Pe[1]-be[1]}else{let be=v.pointCoordinate($);if(v.projection.name==="globe"){C=C.rotate(-v.angle);let Pe=v._pixelsPerMercatorPixel/v.worldSize;se[0]=-C.x*t.ez(t.aY(be.y))*Pe,se[1]=-C.y*t.ez(v.center.lat)*Pe}else{let Pe=v.pointCoordinate($.sub(C));be&&Pe&&(se[0]=Pe.x-be.x,se[1]=Pe.y-be.y)}}let re=v.zoom,he=[0,0,0];if(z){let be=S(Z||v.pointCoordinate3D($)),Pe={dir:t.au([],t.at([],be,v._camera.position))};if(Pe.dir[2]<0){let Re=v.zoomDeltaToMovement(be,z);t.b$(he,Pe.dir,Re)}}let ae=t.cU(se,se,he);v._translateCameraConstrained(ae),z&&Math.abs(v.zoom-re)>1e-4&&v.recenterOnTerrain(),v.cameraElevationReference="ground",this._map._update(),i.noInertia||this._inertia.record(i),this._fireEvents(a,f,!0)}_fireEvents(i,a,f){let g=bo(this._eventsInProgress),v=bo(i),S={};for(let U in i){let{originalEvent:$}=i[U];this._eventsInProgress[U]||(S[`${U}start`]=$),this._eventsInProgress[U]=i[U]}!g&&v&&this._fireEvent("movestart",v.originalEvent);for(let U in S)this._fireEvent(U,S[U]);v&&this._fireEvent("move",v.originalEvent);for(let U in i){let{originalEvent:$}=i[U];this._fireEvent(U,$)}let C={},z;for(let U in this._eventsInProgress){let{handlerName:$,originalEvent:Z}=this._eventsInProgress[U];this._handlersById[$].isActive()||(delete this._eventsInProgress[U],z=a[$]||Z,C[`${U}end`]=z)}for(let U in C)this._fireEvent(U,C[U]);let N=bo(this._eventsInProgress);if(f&&(g||v)&&!N){this._updatingCamera=!0;let U=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),$=Z=>Z!==0&&-this._bearingSnap<Z&&Z<this._bearingSnap;U?($(U.bearing||this._map.getBearing())&&(U.bearing=0),this._map.easeTo(U,{originalEvent:z})):(this._map.fire(new t.A("moveend",{originalEvent:z})),$(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(i,a){this._map.fire(new t.A(i,a?{originalEvent:a}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(i=>{this._frameId=void 0,this.handleEvent(new Om("renderFrame",{timeStamp:i})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}let ad="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Xp extends t.E{constructor(i,a){super(),this._moving=!1,this._zooming=!1,this.transform=i,this._bearingSnap=a.bearingSnap,this._respectPrefersReducedMotion=a.respectPrefersReducedMotion!==!1,t.aV(["_renderFrameCallback"],this)}getCenter(){return new t.cd(this.transform.center.lng,this.transform.center.lat)}setCenter(i,a){return this.jumpTo({center:i},a)}panBy(i,a,f){return i=t.P.convert(i).mult(-1),this.panTo(this.transform.center,t.l({offset:i},a),f)}panTo(i,a,f){return this.easeTo(t.l({center:i},a),f)}getZoom(){return this.transform.zoom}setZoom(i,a){return this.jumpTo({zoom:i},a),this}zoomTo(i,a,f){return this.easeTo(t.l({zoom:i},a),f)}zoomIn(i,a){return this.zoomTo(this.getZoom()+1,i,a),this}zoomOut(i,a){return this.zoomTo(this.getZoom()-1,i,a),this}getBearing(){return this.transform.bearing}setBearing(i,a){return this.jumpTo({bearing:i},a),this}getPadding(){return this.transform.padding}setPadding(i,a){return this.jumpTo({padding:i},a),this}rotateTo(i,a,f){return this.easeTo(t.l({bearing:i},a),f)}resetNorth(i,a){return this.rotateTo(0,t.l({duration:1e3},i),a),this}resetNorthPitch(i,a){return this.easeTo(t.l({bearing:0,pitch:0,duration:1e3},i),a),this}snapToNorth(i,a){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(i,a):this}getPitch(){return this.transform.pitch}setPitch(i,a){return this.jumpTo({pitch:i},a),this}cameraForBounds(i,a){i=t.aG.convert(i);let f=a&&a.bearing||0,g=a&&a.pitch||0,v=i.getNorthWest(),S=i.getSouthEast();return this._cameraForBounds(this.transform,v,S,f,g,a)}_extendPadding(i){let a={top:0,right:0,bottom:0,left:0};return i==null?t.l({},a,this.transform.padding):typeof i=="number"?{top:i,bottom:i,right:i,left:i}:t.l({},a,i)}_extendCameraOptions(i){return(i=t.l({offset:[0,0],maxZoom:this.transform.maxZoom},i)).padding=this._extendPadding(i.padding),i}_minimumAABBFrustumDistance(i,a){let f=a.max[0]-a.min[0],g=a.max[1]-a.min[1];return f/g>i.aspect?f/(2*Math.tan(.5*i.fovX)*i.aspect):g/(2*Math.tan(.5*i.fovY)*i.aspect)}_cameraForBoundsOnGlobe(i,a,f,g,v,S){let C=i.clone(),z=this._extendCameraOptions(S);C.bearing=g,C.pitch=v;let N=t.cd.convert(a),U=t.cd.convert(f),$=.5*(N.lat+U.lat),Z=.5*(N.lng+U.lng),X=t.eC($,Z),se=t.au([],X),re=t.au([],t.bG([],se,[0,1,0])),he=t.bG([],re,se),ae=[re[0],re[1],re[2],0,he[0],he[1],he[2],0,se[0],se[1],se[2],0,0,0,0,1],be=[X,t.eC(N.lat,N.lng),t.eC(U.lat,N.lng),t.eC(U.lat,U.lng),t.eC(N.lat,U.lng),t.eC($,N.lng),t.eC($,U.lng),t.eC(N.lat,Z),t.eC(U.lat,Z)],Pe=t.cV.fromPoints(be.map(Pt=>[t.bE(re,Pt),t.bE(he,Pt),t.bE(se,Pt)])),Re=t.ad([],Pe.center,ae);t.eD(Re)===0&&t.eE(Re,0,0,1),t.au(Re,Re),t.b$(Re,Re,t.aE),C.center=t.eF(Re);let Ge=C.getWorldToCameraMatrix(),Ne=t.bi(new Float64Array(16),Ge);Pe=t.cV.applyTransform(Pe,t.az([],Ge,ae));let Ve=this._extendAABB(Pe,C,z,g);if(!Ve)return void t.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Pe=Ve,t.ad(Re,Re,Ge);let Oe=.5*(Pe.max[2]-Pe.min[2]),Ke=this._minimumAABBFrustumDistance(C,Pe),Qe=t.b$([],[0,0,1],Oe),It=t.cU(Qe,Re,Qe),gt=Ke+(C.pitch===0?0:t.bD(Re,It)),jt=C.globeCenterInViewSpace,Ut=t.at([],Re,[jt[0],jt[1],jt[2]]);t.au(Ut,Ut),t.b$(Ut,Ut,gt);let fi=t.cU([],Re,Ut);t.ad(fi,fi,Ne);let vt=t.eq/t.aE,Ct=t.ae(fi),_t=t.c6(Math.max(Ct*vt-t.eq,Number.EPSILON),0),qt=Math.min(C.zoomFromMercatorZAdjusted(_t),z.maxZoom);return qt>.5*(t.cL+t.cx)?(C.setProjection({name:"mercator"}),C.zoom=qt,this._cameraForBounds(C,a,f,g,v,S)):{center:C.center,zoom:qt,bearing:g,pitch:v}}_extendAABB(i,a,f,g){let v=.5*((f.padding.left||0)+(f.padding.right||0)),S=.5*((f.padding.top||0)+(f.padding.bottom||0)),C=S,z=v,N=v,U=S,$=a.width-(z+N),Z=a.height-(C+U),X=t.at([],i.max,i.min),se=Math.min($/X[0],Z/X[1]),re=Math.min(a.scaleZoom(a.scale*se),f.maxZoom);if(isNaN(re))return null;let he=a.scale/a.zoomScale(re),ae=new t.cV([i.min[0]-z*he,i.min[1]-U*he,i.min[2]],[i.max[0]+N*he,i.max[1]+C*he,i.max[2]]),be=(typeof f.offset.x=="number"&&typeof f.offset.y=="number"?new t.P(f.offset.x,f.offset.y):t.P.convert(f.offset)).rotate(-t.al(g));return ae.center[0]-=be.x*he,ae.center[1]+=be.y*he,ae}queryTerrainElevation(i,a){let f=this.transform.elevation;return f?(a=t.l({},{exaggerated:!0},a),f.getAtPoint(t.ac.fromLngLat(i),null,a.exaggerated)):null}_cameraForBounds(i,a,f,g,v,S){if(i.projection.name==="globe")return this._cameraForBoundsOnGlobe(i,a,f,g,v,S);let C=i.clone(),z=this._extendCameraOptions(S);C.bearing=g,C.pitch=v;let N=t.cd.convert(a),U=t.cd.convert(f),$=new t.cd(N.lng,U.lat),Z=new t.cd(U.lng,N.lat),X=C.project(N),se=C.project(U),re=this.queryTerrainElevation(N),he=this.queryTerrainElevation(U),ae=this.queryTerrainElevation($),be=this.queryTerrainElevation(Z),Pe=[[X.x,X.y,Math.min(re||0,he||0,ae||0,be||0)],[se.x,se.y,Math.max(re||0,he||0,ae||0,be||0)]],Re=t.cV.fromPoints(Pe),Ge=C.getWorldToCameraMatrix(),Ne=t.bi(new Float64Array(16),Ge);Re=t.cV.applyTransform(Re,Ge);let Ve=this._extendAABB(Re,C,z,g);if(!Ve)return void t.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Re=Ve;let Oe=.5*t.at([],Re.max,Re.min)[2],Ke=this._minimumAABBFrustumDistance(C,Re),Qe=[0,0,1,0];t.aA(Qe,Qe,Ge),t.eG(Qe,Qe);let It=t.b$([],Qe,Ke+Oe),gt=t.cU([],Re.center,It);t.ad(Re.center,Re.center,Ne),t.ad(gt,gt,Ne);let jt=C.unproject(new t.P(Re.center[0],Re.center[1])),Ut=t.eH(C.projection,jt),fi=Math.pow(2,Ut),vt=Math.min(C._zoomFromMercatorZ(gt[2]*C.pixelsPerMeter*fi/C.worldSize),z.maxZoom);return C.mercatorFromTransition&&vt<.5*(t.cL+t.cx)?(C.setProjection({name:"globe"}),C.zoom=vt,this._cameraForBounds(C,a,f,g,v,S)):{center:jt,zoom:vt,bearing:g,pitch:v}}fitBounds(i,a,f){let g=this.cameraForBounds(i,a);return this._fitInternal(g,a,f)}fitScreenCoordinates(i,a,f,g,v){let S=t.P.convert(i),C=t.P.convert(a),z=new t.P(Math.min(S.x,C.x),Math.min(S.y,C.y)),N=new t.P(Math.max(S.x,C.x),Math.max(S.y,C.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(S,C))return this;let U=this.transform.pointLocation3D(z),$=this.transform.pointLocation3D(N),Z=this.transform.pointLocation3D(new t.P(z.x,N.y)),X=this.transform.pointLocation3D(new t.P(N.x,z.y)),se=[Math.min(U.lng,$.lng,Z.lng,X.lng),Math.min(U.lat,$.lat,Z.lat,X.lat)],re=[Math.max(U.lng,$.lng,Z.lng,X.lng),Math.max(U.lat,$.lat,Z.lat,X.lat)],he=g&&g.pitch?g.pitch:this.getPitch(),ae=this._cameraForBounds(this.transform,se,re,f,he,g);return this._fitInternal(ae,g,v)}_fitInternal(i,a,f){return i?(a=t.l(i,a)).linear?this.easeTo(a,f):this.flyTo(a,f):this}jumpTo(i,a){this.stop();let f=i.preloadOnly?this.transform.clone():this.transform,g=!1,v=!1,S=!1;"zoom"in i&&f.zoom!==+i.zoom&&(g=!0,f.zoom=+i.zoom),i.center!==void 0&&(f.center=t.cd.convert(i.center)),"bearing"in i&&f.bearing!==+i.bearing&&(v=!0,f.bearing=+i.bearing),"pitch"in i&&f.pitch!==+i.pitch&&(S=!0,f.pitch=+i.pitch);let C=typeof i.padding=="number"?this._extendPadding(i.padding):i.padding;if(i.padding!=null&&!f.isPaddingEqual(C))if(i.retainPadding===!1){let z=f.clone();z.padding=C,f.setLocationAtPoint(f.center,z.centerPoint)}else f.padding=C;return i.preloadOnly?(this._preloadTiles(f),this):(this.fire(new t.A("movestart",a)).fire(new t.A("move",a)),g&&this.fire(new t.A("zoomstart",a)).fire(new t.A("zoom",a)).fire(new t.A("zoomend",a)),v&&this.fire(new t.A("rotatestart",a)).fire(new t.A("rotate",a)).fire(new t.A("rotateend",a)),S&&this.fire(new t.A("pitchstart",a)).fire(new t.A("pitch",a)).fire(new t.A("pitchend",a)),this.fire(new t.A("moveend",a)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||t.w(ad),this.transform.getFreeCameraOptions()}setFreeCameraOptions(i,a){let f=this.transform;if(!f.projection.supportsFreeCamera)return t.w(ad),this;this.stop();let g=f.zoom,v=f.pitch,S=f.bearing;f.setFreeCameraOptions(i);let C=g!==f.zoom,z=v!==f.pitch,N=S!==f.bearing;return this.fire(new t.A("movestart",a)).fire(new t.A("move",a)),C&&this.fire(new t.A("zoomstart",a)).fire(new t.A("zoom",a)).fire(new t.A("zoomend",a)),N&&this.fire(new t.A("rotatestart",a)).fire(new t.A("rotate",a)).fire(new t.A("rotateend",a)),z&&this.fire(new t.A("pitchstart",a)).fire(new t.A("pitch",a)).fire(new t.A("pitchend",a)),this.fire(new t.A("moveend",a)),this}easeTo(i,a){this._stop(!1,i.easeId),((i=t.l({offset:[0,0],duration:500,easing:t.ey},i)).animate===!1||this._prefersReducedMotion(i))&&(i.duration=0);let f=this.transform,g=this.getZoom(),v=this.getBearing(),S=this.getPitch(),C=this.getPadding(),z="zoom"in i?+i.zoom:g,N="bearing"in i?this._normalizeBearing(i.bearing,v):v,U="pitch"in i?+i.pitch:S,$=this._extendPadding(i.padding),Z=t.P.convert(i.offset),X,se,re;if(f.projection.name==="globe"){let Qe=t.ac.fromLngLat(f.center),It=Z.rotate(-f.angle);Qe.x+=It.x/f.worldSize,Qe.y+=It.y/f.worldSize;let gt=Qe.toLngLat(),jt=t.cd.convert(i.center||gt);this._normalizeCenter(jt),X=f.centerPoint.add(It),se=new t.P(Qe.x,Qe.y).mult(f.worldSize),re=new t.P(t.ay(jt.lng),t.aH(jt.lat)).mult(f.worldSize).sub(se)}else{X=f.centerPoint.add(Z);let Qe=f.pointLocation(X),It=t.cd.convert(i.center||Qe);this._normalizeCenter(It),se=f.project(Qe),re=f.project(It).sub(se)}let he=f.zoomScale(z-g),ae,be;i.around&&(ae=t.cd.convert(i.around),be=f.locationPoint(ae));let Pe=this._zooming||z!==g,Re=this._rotating||v!==N,Ge=this._pitching||U!==S,Ne=!f.isPaddingEqual($),Ve=i.retainPadding===!1?f.clone():f,Oe=Qe=>It=>{if(Pe&&(Qe.zoom=t.ai(g,z,It)),Re&&(Qe.bearing=t.ai(v,N,It)),Ge&&(Qe.pitch=t.ai(S,U,It)),Ne&&(Ve.interpolatePadding(C,$,It),X=Ve.centerPoint.add(Z)),ae)Qe.setLocationAtPoint(ae,be);else{let gt=Qe.zoomScale(Qe.zoom-g),jt=z>g?Math.min(2,he):Math.max(.5,he),Ut=Math.pow(jt,1-It),fi=Qe.unproject(se.add(re.mult(It*Ut)).mult(gt));Qe.setLocationAtPoint(Qe.renderWorldCopies?fi.wrap():fi,X)}return i.preloadOnly||this._fireMoveEvents(a),Qe};if(i.preloadOnly){let Qe=this._emulate(Oe,i.duration,f);return this._preloadTiles(Qe),this}let Ke={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Pe,this._rotating=Re,this._pitching=Ge,this._padding=Ne,this._easeId=i.easeId,this._prepareEase(a,i.noMoveStart,Ke),this._ease(Oe(f),Qe=>{f.cameraElevationReference==="sea"&&f.recenterOnTerrain(),this._afterEase(a,Qe)},i),this}_prepareEase(i,a,f={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),a||f.moving||this.fire(new t.A("movestart",i)),this._zooming&&!f.zooming&&this.fire(new t.A("zoomstart",i)),this._rotating&&!f.rotating&&this.fire(new t.A("rotatestart",i)),this._pitching&&!f.pitching&&this.fire(new t.A("pitchstart",i))}_fireMoveEvents(i){this.fire(new t.A("move",i)),this._zooming&&this.fire(new t.A("zoom",i)),this._rotating&&this.fire(new t.A("rotate",i)),this._pitching&&this.fire(new t.A("pitch",i))}_afterEase(i,a){if(this._easeId&&a&&this._easeId===a)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";let f=this._zooming,g=this._rotating,v=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,f&&this.fire(new t.A("zoomend",i)),g&&this.fire(new t.A("rotateend",i)),v&&this.fire(new t.A("pitchend",i)),this.fire(new t.A("moveend",i))}flyTo(i,a){if(this._prefersReducedMotion(i)){let Pt=t.aF(i,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Pt,a)}this.stop(),i=t.l({offset:[0,0],speed:1.2,curve:1.42,easing:t.ey},i);let f=this.transform,g=this.getZoom(),v=this.getBearing(),S=this.getPitch(),C=this.getPadding(),z="zoom"in i?t.aD(+i.zoom,f.minZoom,f.maxZoom):g,N="bearing"in i?this._normalizeBearing(i.bearing,v):v,U="pitch"in i?+i.pitch:S,$=this._extendPadding(i.padding),Z=f.zoomScale(z-g),X=t.P.convert(i.offset),se=f.centerPoint.add(X),re=f.pointLocation(se),he=t.cd.convert(i.center||re);this._normalizeCenter(he);let ae=f.project(re),be=f.project(he).sub(ae),Pe=i.curve,Re=Math.max(f.width,f.height),Ge=Re/Z,Ne=be.mag();if("minZoom"in i){let Pt=t.aD(Math.min(i.minZoom,g,z),f.minZoom,f.maxZoom),ti=Re/f.zoomScale(Pt-g);Pe=Math.sqrt(ti/Ne*2)}let Ve=Pe*Pe;function Oe(Pt){let ti=(Ge*Ge-Re*Re+(Pt?-1:1)*Ve*Ve*Ne*Ne)/(2*(Pt?Ge:Re)*Ve*Ne);return Math.log(Math.sqrt(ti*ti+1)-ti)}function Ke(Pt){return(Math.exp(Pt)-Math.exp(-Pt))/2}function Qe(Pt){return(Math.exp(Pt)+Math.exp(-Pt))/2}let It=Oe(0),gt=function(Pt){return Qe(It)/Qe(It+Pe*Pt)},jt=function(Pt){return Re*((Qe(It)*(Ke(ti=It+Pe*Pt)/Qe(ti))-Ke(It))/Ve)/Ne;var ti},Ut=(Oe(1)-It)/Pe;if(Math.abs(Ne)<1e-6||!isFinite(Ut)){if(Math.abs(Re-Ge)<1e-6)return this.easeTo(i,a);let Pt=Ge<Re?-1:1;Ut=Math.abs(Math.log(Ge/Re))/Pe,jt=function(){return 0},gt=function(ti){return Math.exp(Pt*Pe*ti)}}i.duration="duration"in i?+i.duration:1e3*Ut/("screenSpeed"in i?+i.screenSpeed/Pe:+i.speed),i.maxDuration&&i.duration>i.maxDuration&&(i.duration=0);let fi=v!==N,vt=U!==S,Ct=!f.isPaddingEqual($),_t=i.retainPadding===!1?f.clone():f,qt=Pt=>ti=>{let Gt=ti*Ut,ii=1/gt(Gt);Pt.zoom=ti===1?z:g+Pt.scaleZoom(ii),fi&&(Pt.bearing=t.ai(v,N,ti)),vt&&(Pt.pitch=t.ai(S,U,ti)),Ct&&(_t.interpolatePadding(C,$,ti),se=_t.centerPoint.add(X));let oi=ti===1?he:Pt.unproject(ae.add(be.mult(jt(Gt))).mult(ii));return Pt.setLocationAtPoint(Pt.renderWorldCopies?oi.wrap():oi,se),Pt._updateCameraOnTerrain(),i.preloadOnly||this._fireMoveEvents(a),Pt};if(i.preloadOnly){let Pt=this._emulate(qt,i.duration,f);return this._preloadTiles(Pt),this}return this._zooming=!0,this._rotating=fi,this._pitching=vt,this._padding=Ct,this._prepareEase(a,!1),this._ease(qt(f),()=>this._afterEase(a),i),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(i){}_cancelRenderFrame(i){}_stop(i,a){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){let f=this._onEaseEnd;this._onEaseEnd=void 0,f.call(this,a)}if(!i){let f=this.handlers;f&&f.stop(!1)}return this}_ease(i,a,f){f.animate===!1||f.duration===0?(i(1),a()):(this._easeStart=t.q.now(),this._easeOptions=f,this._onEaseFrame=i,this._onEaseEnd=a,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){let i=Math.min((t.q.now()-this._easeStart)/this._easeOptions.duration,1),a=this._onEaseFrame;a&&a(this._easeOptions.easing(i)),i<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(i,a){i=t.bX(i,-180,180);let f=Math.abs(i-a);return Math.abs(i-360-a)<f&&(i-=360),Math.abs(i+360-a)<f&&(i+=360),i}_normalizeCenter(i){let a=this.transform;if(a.maxBounds||a.projection.name!=="globe"&&!a.renderWorldCopies)return;let f=i.lng-a.center.lng;i.lng+=f>180?-360:f<-180?360:0}_prefersReducedMotion(i){return this._respectPrefersReducedMotion&&t.q.prefersReducedMotion&&!(i&&i.essential)}_emulate(i,a,f){let g=Math.ceil(15*a/1e3),v=[],S=i(f.clone());for(let C=0;C<=g;C++){let z=S(C/g);v.push(z.clone())}return v}_preloadTiles(i,a){}}class Ba{constructor(i={}){this.options=i,t.aV(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(i){let a=this.options&&this.options.compact,f=i._getUIString("AttributionControl.ToggleAttribution");this._map=i,this._container=on("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=on("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",f);let g=on("span","mapboxgl-ctrl-icon",this._compactButton);return g.setAttribute("aria-hidden","true"),g.setAttribute("title",f),this._innerContainer=on("div","mapboxgl-ctrl-attrib-inner",this._container),a&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),a===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let i=this._editLink;i||(i=this._editLink=this._container.querySelector(".mapbox-improve-map"));let a=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||t.e.ACCESS_TOKEN}];if(i){let f=a.reduce((g,v,S)=>(v.value&&(g+=`${v.key}=${v.value}${S<a.length-1?"&":""}`),g),"?");i.href=`${t.e.FEEDBACK_URL}/${f}#${Ca(this._map,!0)}`,i.rel="noopener nofollow"}}_updateData(i){!i||i.sourceDataType!=="metadata"&&i.sourceDataType!=="visibility"&&i.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let i=[];if(this._map.style.stylesheet){let g=this._map.style.stylesheet;this.styleOwner=g.owner,this.styleId=g.id}let a=this._map.style._mergedSourceCaches;for(let g in a){let v=a[g];if(v.used){let S=v.getSource();S.attribution&&i.indexOf(S.attribution)<0&&i.push(S.attribution)}}i.sort((g,v)=>g.length-v.length),i=i.filter((g,v)=>{for(let S=v+1;S<i.length;S++)if(i[S].indexOf(g)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?i=[...this.options.customAttribution,...i]:i.unshift(this.options.customAttribution));let f=i.join(" | ");f!==this._attribHTML&&(this._attribHTML=f,i.length?(this._innerContainer.innerHTML=f,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Kp{constructor(){t.aV(["_updateLogo","_updateCompact"],this)}onAdd(i){this._map=i,this._container=on("div","mapboxgl-ctrl");let a=on("a","mapboxgl-ctrl-logo");return a.target="_blank",a.rel="noopener nofollow",a.href="https://www.mapbox.com/",a.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),a.setAttribute("rel","noopener nofollow"),this._container.appendChild(a),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(i){i&&i.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;let i=this._map.style._sourceCaches;if(Object.entries(i).length===0)return!0;for(let a in i){let f=i[a].getSource();if(f.hasOwnProperty("mapbox_logo")&&!f.mapbox_logo)return!1}return!0}_updateCompact(){let i=this._container.children;if(i.length){let a=i[0];this._map.getCanvasContainer().offsetWidth<250?a.classList.add("mapboxgl-compact"):a.classList.remove("mapboxgl-compact")}}}class Rc{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(i){let a=++this._id;return this._queue.push({callback:i,id:a,cancelled:!1}),a}remove(i){let a=this._currentlyRunning,f=a?this._queue.concat(a):this._queue;for(let g of f)if(g.id===i)return void(g.cancelled=!0)}run(i=0){let a=this._currentlyRunning=this._queue;this._queue=[];for(let f of a)if(!f.cancelled&&(f.callback(i),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Xf{constructor(i){this.jumpTo(i)}getValue(i){if(i<=this._startTime)return this._start;if(i>=this._endTime)return this._end;let a=t.dk((i-this._startTime)/(this._endTime-this._startTime));return this._start*(1-a)+this._end*a}isEasing(i){return i>=this._startTime&&i<=this._endTime}jumpTo(i){this._startTime=-1/0,this._endTime=-1/0,this._start=i,this._end=i}easeTo(i,a,f){this._start=this.getValue(a),this._end=i,this._startTime=a,this._endTime=a+f}}let is={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class bh extends t.A{constructor(i,a,f,g){let{point:v,lngLat:S,originalEvent:C,target:z}=i;super(i.type,{point:v,lngLat:S,originalEvent:C,target:z}),this.preventDefault=()=>{i.preventDefault()},this.id=a,this.interaction=f,this.feature=g}}class xf{constructor(i){this.map=i,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(i,a){if(this.typeById.has(i))throw new Error(`Interaction id "${i}" already exists.`);let f=a.filter,g=a.type;f&&this.filters.set(i,t.b3(f)),g==="mouseover"&&(g="mouseenter"),g==="mouseout"&&(g="mouseleave");let v=this.interactionsByType.get(g)||new Map;g==="mouseenter"||g==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(i,a)):v.size===0&&this.map.on(g,this.handleType),v.size===0&&this.interactionsByType.set(g,v),v.set(i,a),this.typeById.set(i,g)}get(i){let a=this.typeById.get(i);if(!a)return;let f=this.interactionsByType.get(a);return f?f.get(i):void 0}remove(i){let a=this.typeById.get(i);if(!a)return;this.typeById.delete(i),this.filters.delete(i);let f=this.interactionsByType.get(a);f&&(f.delete(i),a==="mouseenter"||a==="mouseleave"?(this.delegatedInteractions.delete(i),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):f.size===0&&this.map.off(a,this.handleType))}queryTargets(i,a){let f=[];for(let[g,v]of a)v.target&&f.push({targetId:g,target:v.target,filter:this.filters.get(g)});return this.map.style.queryRenderedTargets(i,f,this.map.transform)}handleMove(i){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;let a=this.queryTargets(i.point,Array.from(this.delegatedInteractions).reverse());a.length&&(i.type="mouseenter",this.handleType(i,a));let f=new Map;for(let[g,{feature:v}]of this.prevHoveredFeatures)this.hoveredFeatures.has(g)||f.set(v.id,v);f.size&&(i.type="mouseleave",this.handleType(i,Array.from(f.values())))}handleOut(i){let a=Array.from(this.hoveredFeatures.values()).map(({feature:f})=>f);a.length&&(i.type="mouseleave",this.handleType(i,a)),this.hoveredFeatures.clear()}handleType(i,a){let f=Array.from(this.interactionsByType.get(i.type)).reverse(),g=!!a;a=a||this.queryTargets(i.point,f);let v=i.type==="mouseenter",S=!1,C=new Set;for(let z of a){for(let[N,U]of f){if(!U.target)continue;let $=z.variants?z.variants[N]:null;if($){for(let Z of $){if(zu(Z,z,C,N))continue;let X=new t.df(z,Z),se=Wc(Z,z,N);g&&(X.state=this.map.getFeatureState(X));let re=v?this.prevHoveredFeatures.get(se):null,he=new bh(i,N,U,X),ae=re?re.stop:U.handler(he);if(v&&this.hoveredFeatures.set(se,{feature:z,stop:ae}),ae!==!1){S=!0;break}}if(S)break}}if(S)break}if(!S)for(let[z,N]of f){let{handler:U,target:$}=N;if(!$&&U(new bh(i,z,N,null))!==!1)break}}}function vf(p,i){if(Array.isArray(p)&&Array.isArray(i)){let a=new Set(p),f=new Set(i);return a.size===f.size&&p.every(g=>f.has(g))}return t.bv(p,i)}let d_={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},Fm={showCompass:!0,showZoom:!0,visualizePitch:!1};class Yp{constructor(i,a,f=!1){this._clickTolerance=10,this.element=a,this.mouseRotate=new $h({clickTolerance:i.dragRotate._mouseRotate._clickTolerance}),this.map=i,f&&(this.mousePitch=new od({clickTolerance:i.dragRotate._mousePitch._clickTolerance})),t.aV(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),a.addEventListener("mousedown",this.mousedown),a.addEventListener("touchstart",this.touchstart,{passive:!1}),a.addEventListener("touchmove",this.touchmove),a.addEventListener("touchend",this.touchend),a.addEventListener("touchcancel",this.reset)}down(i,a){this.mouseRotate.mousedown(i,a),this.mousePitch&&this.mousePitch.mousedown(i,a),qo()}move(i,a){let f=this.map,g=this.mouseRotate.mousemoveWindow(i,a),v=g&&g.bearingDelta;if(v&&f.setBearing(f.getBearing()+v),this.mousePitch){let S=this.mousePitch.mousemoveWindow(i,a),C=S&&S.pitchDelta;C&&f.setPitch(f.getPitch()+C)}}off(){let i=this.element;i.removeEventListener("mousedown",this.mousedown),i.removeEventListener("touchstart",this.touchstart),i.removeEventListener("touchmove",this.touchmove),i.removeEventListener("touchend",this.touchend),i.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){to(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(i){this.down(t.l({},i,{ctrlKey:!0,preventDefault:()=>i.preventDefault()}),ga(this.element,i)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(i){this.move(i,ga(this.element,i))}mouseup(i){this.mouseRotate.mouseupWindow(i),this.mousePitch&&this.mousePitch.mouseupWindow(i),this.offTemp()}touchstart(i){i.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Aa(this.element,i.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>i.preventDefault()},this._startPos))}touchmove(i){i.targetTouches.length!==1?this.reset():(this._lastPos=Aa(this.element,i.targetTouches)[0],this.move({preventDefault:()=>i.preventDefault()},this._lastPos))}touchend(i){i.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function Bm(p,i,a){if(p=new t.cd(p.lng,p.lat),i){let f=new t.cd(p.lng-360,p.lat),g=new t.cd(p.lng+360,p.lat),v=360*Math.ceil(Math.abs(p.lng-a.center.lng)/360),S=a.locationPoint3D(p).distSqr(i),C=i.x<0||i.y<0||i.x>a.width||i.y>a.height;a.locationPoint3D(f).distSqr(i)<S&&(C||Math.abs(f.lng-a.center.lng)<v)?p=f:a.locationPoint3D(g).distSqr(i)<S&&(C||Math.abs(g.lng-a.center.lng)<v)&&(p=g)}for(;Math.abs(p.lng-a.center.lng)>180;){let f=a.locationPoint3D(p);if(f.x>=0&&f.y>=0&&f.x<=a.width&&f.y<=a.height)break;p.lng>a.center.lng?p.lng-=360:p.lng+=360}return p}let Nm={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},zc={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class bf extends t.E{constructor(i,a){super(),(i instanceof HTMLElement||a)&&(i=t.l({element:i},a)),t.aV(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);let{anchor:f="center",color:g="#3FB1CE",scale:v=1,draggable:S=!1,clickTolerance:C=0,rotation:z=zc.rotation,rotationAlignment:N=zc.rotationAlignment,pitchAlignment:U=zc.pitchAlignment,occludedOpacity:$=zc.occludedOpacity,altitude:Z=zc.altitude}=i||{};this._anchor=f,this._color=g,this._scale=v,this._draggable=S,this._clickTolerance=C,this._rotation=z,this._rotationAlignment=N,this._pitchAlignment=U,this._occludedOpacity=$,this._altitude=Z,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),i&&i.element?(this._element=i.element,this._offset=t.P.convert(i&&i.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=t.P.convert(i&&i.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",re=>{re.preventDefault()}),this._element.addEventListener("mousedown",re=>{re.preventDefault()});let X=this._element.classList;for(let re in Nm)X.remove(`mapboxgl-marker-anchor-${re}`);X.add(`mapboxgl-marker-anchor-${this._anchor}`);let se=i&&i.className?i.className.trim().split(/\s+/):[];X.add(...se),this._popup=null}_createDefaultMarker(){let i=on("div"),a=vn("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},i);if(this._altitude===0){let f=vn("radialGradient",{id:"shadowGradient"},vn("defs",{},a));vn("stop",{offset:"10%","stop-opacity":.4},f),vn("stop",{offset:"100%","stop-opacity":.05},f),vn("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},a)}return vn("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},a),vn("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},a),vn("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},a),i}addTo(i){return i===this._map||(this.remove(),this._map=i,i.getCanvasContainer().appendChild(this._element),i.on("move",this._updateMoving),i.on("moveend",this._update),i.on("remove",this._clearFadeTimer),i._addMarker(this),this.setDraggable(this._draggable),this._update(),i.on("click",this._onMapClick)),this}remove(){let i=this._map;return i&&(i.off("click",this._onMapClick),i.off("move",this._updateMoving),i.off("moveend",this._update),i.off("mousedown",this._addDragHandler),i.off("touchstart",this._addDragHandler),i.off("mouseup",this._onUp),i.off("touchend",this._onUp),i.off("mousemove",this._onMove),i.off("touchmove",this._onMove),i.off("remove",this._clearFadeTimer),i._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(i){return this._lngLat=t.cd.convert(i),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(i){return i===this._altitude||(this._defaultMarker&&(this._altitude===0&&i!==0||this._altitude!==0&&i===0)&&(this._element=this._createDefaultMarker()),this._altitude=i||zc.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(i){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),i){if(!("offset"in i.options)){let g=Math.sqrt(Math.pow(13.5,2)/2);i.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[g,-1*(38.1-13.5+g)],"bottom-right":[-g,-1*(38.1-13.5+g)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=i,i._marker=this,i._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(i){let a=i.code,f=i.charCode||i.keyCode;a!=="Space"&&a!=="Enter"&&f!==32&&f!==13||this.togglePopup()}_onMapClick(i){let a=i.originalEvent.target,f=this._element;this._popup&&(a===f||f.contains(a))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){let i=this._popup;return i?(i.isOpen()?(i.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(i.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){let i=this._map,a=this._pos;if(!i||!a)return!1;let f=i.unproject(a,this._altitude),g=i.getFreeCameraOptions();if(!g.position)return!1;let v=g.position.toLngLat();return v.distanceTo(f)<.9*v.distanceTo(this._lngLat)}_evaluateOpacity(){let i=this._map;if(!i)return;let a=this._pos;if(!a||a.x<0||a.x>i.transform.width||a.y<0||a.y>i.transform.height)return void this._clearFadeTimer();let f=i.unproject(a,this._altitude),g;i._showingGlobe()&&t.eK(i.transform,this._lngLat)?g=0:(g=1-i._queryFogOpacity(f),i.transform._terrainEnabled()&&i.getTerrain()&&this._behindTerrain()&&(g*=this._occludedOpacity)),this._element.style.opacity=`${g}`,this._element.style.pointerEvents=g>0?"auto":"none",this._popup&&this._popup._setOpacity(g),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){let i=this._pos;if(!i||!this._map)return;let a=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${i.x}px,${i.y}px)
            ${Nm[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${a.x}px,${a.y}px)
        `}_calculateXYTransform(){let i=this._pos,a=this._map,f=this.getPitchAlignment();if(!a||!i||f!=="map")return"";if(!a._showingGlobe()){let z=a.getPitch();return z?`rotateX(${z}deg)`:""}let g=t.cJ(t.eL(a.transform,this._lngLat)),v=i.sub(t.eM(a.transform)),S=Math.abs(v.x)+Math.abs(v.y);if(S===0)return"";let C=g/S;return`rotateX(${-v.y*C}deg) rotateY(${v.x*C}deg)`}_calculateZTransform(){let i=this._pos,a=this._map;if(!a||!i)return"";let f=0,g=this.getRotationAlignment();if(g==="map")if(a._showingGlobe()){let v=a.project(new t.cd(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),S=a.project(new t.cd(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(v);f=t.cJ(Math.atan2(S.y,S.x))-90}else f=-a.getBearing();else if(g==="horizon"){let v=t.af(4,6,a.getZoom()),S=t.eM(a.transform);S.y+=v*a.transform.height;let C=i.sub(S),z=t.cJ(Math.atan2(C.y,C.x));f=(z>90?z-270:z+90)*(1-v)}return f+=this._rotation,f?`rotateZ(${f}deg)`:""}_update(i){cancelAnimationFrame(this._updateFrameId);let a=this._map;a&&(a.transform.renderWorldCopies&&(this._lngLat=Bm(this._lngLat,this._pos,a.transform)),this._pos=a.project(this._lngLat,this._altitude),i===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),a._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(a._showingGlobe()||a.getTerrain()||a.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(i){return this._offset=t.P.convert(i),this._update(),this}addClassName(i){return this._element.classList.add(i),this}removeClassName(i){return this._element.classList.remove(i),this}toggleClassName(i){return this._element.classList.toggle(i)}_onMove(i){let a=this._map;if(!a)return;let f=this._pointerdownPos,g=this._positionDelta;if(f&&g){if(!this._isDragging){let v=this._clickTolerance||a._clickTolerance;if(i.point.dist(f)<v)return;this._isDragging=!0}this._pos=i.point.sub(g),this._lngLat=a.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new t.A("dragstart"))),this.fire(new t.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;let i=this._map;i&&(i.off("mousemove",this._onMove),i.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new t.A("dragend")),this._state="inactive"}_addDragHandler(i){let a=this._map,f=this._pos;a&&f&&this._element.contains(i.originalEvent.target)&&(i.preventDefault(),this._positionDelta=i.point.sub(f),this._pointerdownPos=i.point,this._state="pending",a.on("mousemove",this._onMove),a.on("touchmove",this._onMove),a.once("mouseup",this._onUp),a.once("touchend",this._onUp))}setDraggable(i){this._draggable=!!i;let a=this._map;return a&&(i?(a.on("mousedown",this._addDragHandler),a.on("touchstart",this._addDragHandler)):(a.off("mousedown",this._addDragHandler),a.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(i){return this._rotation=i||zc.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(i){return this._rotationAlignment=i||zc.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(i){return this._pitchAlignment=i||zc.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(i){return this._occludedOpacity=i||zc.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}let cp={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},ld={maxWidth:100,unit:"metric"},Wh={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},tl={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},bl=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function cd(p=new t.P(0,0),i="bottom"){if(typeof p=="number"){let a=Math.round(Math.sqrt(.5*Math.pow(p,2)));switch(i){case"top":return new t.P(0,p);case"top-left":return new t.P(a,a);case"top-right":return new t.P(-a,a);case"bottom":return new t.P(0,-p);case"bottom-left":return new t.P(a,-a);case"bottom-right":return new t.P(-a,-a);case"left":return new t.P(p,0);case"right":return new t.P(-p,0)}return new t.P(0,0)}return p instanceof t.P||Array.isArray(p)?t.P.convert(p):t.P.convert(p[i]||[0,0])}return{version:at,supported:Wi.supported,setRTLTextPlugin:t.eN,getRTLTextPluginStatus:t.eO,Map:class extends Xp{constructor(p){Cn.mark(yi.create);let i=p;if((p=t.l({},d_,p)).minZoom!=null&&p.maxZoom!=null&&p.minZoom>p.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(p.minPitch!=null&&p.maxPitch!=null&&p.minPitch>p.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(p.minPitch!=null&&p.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(p.maxPitch!=null&&p.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(p.antialias&&t.eI(window)&&(p.antialias=!1,t.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new kl(p.minZoom,p.maxZoom,p.minPitch,p.maxPitch,p.renderWorldCopies,null,null),p),this._repaint=!!p.repaint,this._interactive=p.interactive,this._minTileCacheSize=p.minTileCacheSize,this._maxTileCacheSize=p.maxTileCacheSize,this._failIfMajorPerformanceCaveat=p.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=p.preserveDrawingBuffer,this._antialias=p.antialias,this._trackResize=p.trackResize,this._bearingSnap=p.bearingSnap,this._refreshExpiredTiles=p.refreshExpiredTiles,this._fadeDuration=p.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=p.crossSourceCollisions,this._collectResourceTiming=p.collectResourceTiming,this._language=this._parseLanguage(p.language),this._worldview=p.worldview,this._renderTaskQueue=new Rc,this._domRenderTaskQueue=new Rc,this._controls=[],this._markers=[],this._popups=[],this._mapId=t.a$(),this._locale=t.l({},is,p.locale),this._clickTolerance=p.clickTolerance,this._cooperativeGestures=p.cooperativeGestures,this._performanceMetricsCollection=p.performanceMetricsCollection,this._tessellationStep=p.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=p.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Xf(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=p.scaleFactor,this._requestManager=new Ur(p.transformRequest,p.accessToken,p.testMode),this._silenceAuthErrors=!!p.testMode,this._contextCreateOptions=p.contextCreateOptions?Object.assign({},p.contextCreateOptions):{},typeof p.container=="string"){let a=document.getElementById(p.container);if(!a)throw new Error(`Container '${p.container.toString()}' not found.`);this._container=a}else{if(!(p.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=p.container}if(this._container.childNodes.length>0&&t.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),p.maxBounds&&this.setMaxBounds(p.maxBounds),this._spriteFormat=p.spriteFormat,t.aV(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Kr),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new u_(this,p),this._localFontFamily=p.localFontFamily,this._localIdeographFontFamily=p.localIdeographFontFamily,(p.style||!p.testMode)&&this.setStyle(p.style||t.e.DEFAULT_STYLE,{config:p.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),p.projection&&this.setProjection(p.projection),this.indoor=new Op(this),p.hash&&(this._hash=new dc(typeof p.hash=="string"&&p.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){i.center==null&&i.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:p.center,zoom:p.zoom,bearing:p.bearing,pitch:p.pitch});let a=p.bounds;a&&(this.resize(),this.fitBounds(a,t.l({},p.fitBoundsOptions,{duration:0})))}this.resize(),p.attributionControl&&this.addControl(new Ba({customAttribution:p.customAttribution})),this._logoControl=new Kp,this.addControl(this._logoControl,p.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",a=>{this._update(a.dataType==="style"),this.fire(new t.A(`${a.dataType}data`,a))}),this.on("dataloading",a=>{this.fire(new t.A(`${a.dataType}dataloading`,a))}),this._interactions=new xf(this)}_getMapId(){return this._mapId}addControl(p,i){if(i===void 0&&(i=p.getDefaultPosition?p.getDefaultPosition():"top-right"),!p||!p.onAdd)return this.fire(new t.z(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));let a=p.onAdd(this);this._controls.push(p);let f=this._controlPositions[i];return i.indexOf("bottom")!==-1?f.insertBefore(a,f.firstChild):f.appendChild(a),this}removeControl(p){if(!p||!p.onRemove)return this.fire(new t.z(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));let i=this._controls.indexOf(p);return i>-1&&this._controls.splice(i,1),p.onRemove(this),this}hasControl(p){return this._controls.indexOf(p)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(p){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));let i=!this._moving;return i&&this.fire(new t.A("movestart",p)).fire(new t.A("move",p)),this.fire(new t.A("resize",p)),i&&this.fire(new t.A("moveend",p)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(p){return this.transform.setMaxBounds(t.aG.convert(p)),this._update()}setMinZoom(p){if((p=p??-2)>=-2&&p<=this.transform.maxZoom)return this.transform.minZoom=p,this._update(),this.getZoom()<p?this.setZoom(p):this.fire(new t.A("zoomstart")).fire(new t.A("zoom")).fire(new t.A("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(p){if((p=p??22)>=this.transform.minZoom)return this.transform.maxZoom=p,this._update(),this.getZoom()>p?this.setZoom(p):this.fire(new t.A("zoomstart")).fire(new t.A("zoom")).fire(new t.A("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(p){if((p=p??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(p>=0&&p<=this.transform.maxPitch)return this.transform.minPitch=p,this._update(),this.getPitch()<p?this.setPitch(p):this.fire(new t.A("pitchstart")).fire(new t.A("pitch")).fire(new t.A("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(p){if((p=p??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(p>=this.transform.minPitch)return this.transform.maxPitch=p,this._update(),this.getPitch()>p?this.setPitch(p):this.fire(new t.A("pitchstart")).fire(new t.A("pitch")).fire(new t.A("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(p){return this._scaleFactor=p,this.painter.scaleFactor=p,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(i=>i.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(p){return this.transform.renderWorldCopies=p,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(p){return p==="auto"?navigator.language:Array.isArray(p)?p.length===0?void 0:p.map(i=>i==="auto"?navigator.language:i):p}setLanguage(p){let i=this._parseLanguage(p);if(!this.style||i===this._language)return this;this._language=i,this.style.reloadSources();for(let a of this._controls)a._setLanguage&&a._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(p){return this.style&&p!==this._worldview?(this._worldview=p,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(p){return this._lazyInitEmptyStyle(),p?typeof p=="string"&&(p={name:p}):p=null,this._useExplicitProjection=!!p,this._prioritizeAndUpdateProjection(p,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;let p=this.transform,i=p.projection.name,a;i==="globe"&&p.zoom>=t.cx?(p.setMercatorFromTransition(),a=!0):i==="mercator"&&p.zoom<t.cx&&(p.setProjection({name:"globe"}),a=!0),a&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(p,i){return this._updateProjection(p||i||{name:"mercator"})}_updateProjection(p){let i;return i=p.name==="globe"&&this.transform.zoom>=t.cx?this.transform.setMercatorFromTransition():this.transform.setProjection(p),this.style.applyProjectionUpdate(),i&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(p,i){return this.transform.locationPoint3D(t.cd.convert(p),i)}unproject(p,i){return this.transform.pointLocation3D(t.P.convert(p),i)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(p,i,a){let f=g=>{let v=[];if(Array.isArray(i)){let S=i.filter(C=>this.getLayer(C));v=S.length?this.queryRenderedFeatures(g,{layers:S}):[]}else v=this.queryRenderedFeatures(g,{target:i});return v};if(p==="mouseenter"||p==="mouseover"){let g=!1;return{listener:a,targets:i,delegates:{mousemove:S=>{let C=f(S.point);C.length?g||(g=!0,a.call(this,new el(p,this,S.originalEvent,{features:C}))):g=!1},mouseout:()=>{g=!1}}}}if(p==="mouseleave"||p==="mouseout"){let g=!1;return{listener:a,targets:i,delegates:{mousemove:C=>{f(C.point).length?g=!0:g&&(g=!1,a.call(this,new el(p,this,C.originalEvent)))},mouseout:C=>{g&&(g=!1,a.call(this,new el(p,this,C.originalEvent)))}}}}{let g=v=>{let S=f(v.point);S.length&&(v.features=S,a.call(this,v),delete v.features)};return{listener:a,targets:i,delegates:{[p]:g}}}}on(p,i,a){if(typeof i=="function"||a===void 0)return super.on(p,i);if(typeof i=="string"&&(i=[i]),!this._areTargetsValid(i))return this;let f=this._createDelegatedListener(p,i,a);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[p]=this._delegatedListeners[p]||[],this._delegatedListeners[p].push(f);for(let g in f.delegates)this.on(g,f.delegates[g]);return this}once(p,i,a){if(typeof i=="function"||a===void 0)return super.once(p,i);if(typeof i=="string"&&(i=[i]),!this._areTargetsValid(i))return this;let f=this._createDelegatedListener(p,i,a);for(let g in f.delegates)this.once(g,f.delegates[g]);return this}off(p,i,a){if(typeof i=="function"||a===void 0)return super.off(p,i);if(typeof i=="string"&&(i=[i]),!this._areTargetsValid(i))return this;let f=this._delegatedListeners?this._delegatedListeners[p]:void 0;return f&&(g=>{for(let v=0;v<g.length;v++){let S=g[v];if(S.listener===a&&vf(S.targets,i)){for(let C in S.delegates)this.off(C,S.delegates[C]);return g.splice(v,1),this}}})(f),this}queryRenderedFeatures(p,i){if(!this.style)return[];if(p===void 0||p instanceof t.P||Array.isArray(p)||i!==void 0||(i=p,p=void 0),p=p||[[0,0],[this.transform.width,this.transform.height]],!i){let v=this.style.queryRenderedFeatures(p,void 0,this.transform),S=this.style.queryRenderedFeatureset(p,void 0,this.transform);return v.concat(S)}let a=!0;if(i.target&&(a=this._isTargetValid(i.target),a&&!i.layers))return this.style.queryRenderedFeatureset(p,i,this.transform);let f=!0;if(i.layers&&Array.isArray(i.layers)){for(let v of i.layers)if(!this._isValidId(v)){f=!1;break}if(f&&!i.target)return this.style.queryRenderedFeatures(p,i,this.transform)}let g=[];return f&&(g=g.concat(this.style.queryRenderedFeatures(p,i,this.transform))),a&&(g=g.concat(this.style.queryRenderedFeatureset(p,i,this.transform))),g}querySourceFeatures(p,i){return!p||typeof p=="string"&&!this._isValidId(p)?[]:this.style.querySourceFeatures(p,i)}isPointOnSurface(p){let{name:i}=this.transform.projection;return i!=="globe"&&i!=="mercator"&&t.w(`${i} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(t.P.convert(p))}addInteraction(p,i){return this._interactions.add(p,i),this}removeInteraction(p){return this._interactions.remove(p),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(p){return this._cooperativeGestures=p,this}setStyle(p,i){return i=t.l({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},i),this.style&&p&&i.diff!==!1&&i.localFontFamily===this._localFontFamily&&i.localIdeographFontFamily===this._localIdeographFontFamily&&!i.config?(this.style._diffStyle(p,(a,f)=>{if(a){let g=typeof a=="string"?a:a instanceof Error?a.message:a.error;t.w(`Unable to perform style diff: ${g}. Rebuilding the style from scratch.`),this._updateStyle(p,i)}else f&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=i.localIdeographFontFamily,this._localFontFamily=i.localFontFamily,this._updateStyle(p,i))}_getUIString(p){let i=this._locale[p];if(i==null)throw new Error(`Missing UI string '${p}'`);return i}_updateStyle(p,i){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),p){let a=t.l({},i);i&&i.config&&(a.initialConfig=i.config,delete a.config),this.style=new Fl(this,a).load(p),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Fl(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(t.w("There is no style added to the map."),!1)}_isValidId(p){return p==null?(this.fire(new t.z(new Error("IDs can't be empty."))),!1):!t.d9(p)||(this.fire(new t.z(new Error(`IDs can't contain special symbols: "${p}".`))),!1)}_isTargetValid(p){return"featuresetId"in p?this._isValidId("importId"in p?p.importId:p.featuresetId):"layerId"in p&&this._isValidId(p.layerId)}_areTargetsValid(p){if(Array.isArray(p)){for(let i of p)if(!this._isValidId(i))return!1;return!0}return this._isTargetValid(p)}addSource(p,i){return this._isValidId(p)?(this._lazyInitEmptyStyle(),this.style.addSource(p,i),this._update(!0)):this}isSourceLoaded(p){return!!this._isValidId(p)&&!!this.style&&this.style._isSourceCacheLoaded(p)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(p,i,a){this._lazyInitEmptyStyle(),this.style.addSourceType(p,i,a)}removeSource(p){return this._isValidId(p)?(this.style.removeSource(p),this._updateTerrain(),this._update(!0)):this}getSource(p){return this._isValidId(p)?this.style.getOwnSource(p):null}addImage(p,i,{pixelRatio:a=1,sdf:f=!1,stretchX:g,stretchY:v,content:S}={}){this._lazyInitEmptyStyle();let C=t.I.from(p);if(i instanceof HTMLImageElement||ImageBitmap&&i instanceof ImageBitmap){let{width:z,height:N,data:U}=t.q.getImageData(i);this.style.addImage(C,{data:new t.r({width:z,height:N},U),pixelRatio:a,stretchX:g,stretchY:v,content:S,sdf:f,version:0,usvg:!1})}else if(i.width===void 0||i.height===void 0)this.fire(new t.z(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{let{width:z,height:N}=i,U=i;this.style.addImage(C,{data:new t.r({width:z,height:N},new Uint8Array(U.data)),pixelRatio:a,stretchX:g,stretchY:v,content:S,sdf:f,usvg:!1,version:0,userImage:U}),U.onAdd&&U.onAdd(this,p)}}updateImage(p,i){this._lazyInitEmptyStyle();let a=t.I.from(p),f=this.style.getImage(a);if(!f)return void this.fire(new t.z(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));let g=i instanceof HTMLImageElement||ImageBitmap&&i instanceof ImageBitmap?t.q.getImageData(i):i,{width:v,height:S,data:C}=g;if(v===void 0||S===void 0)return void this.fire(new t.z(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(v!==(f.usvg?f.icon.usvg_tree.width:f.data.width)||S!==(f.usvg?f.icon.usvg_tree.height:f.data.height))return void this.fire(new t.z(new Error(`The width and height of the updated image (${v}, ${S})
                must be that same as the previous version of the image
                (${f.data.width}, ${f.data.height})`)));let z=!(i instanceof HTMLImageElement||ImageBitmap&&i instanceof ImageBitmap),N=!1;f.usvg?(f.data=new t.r({width:v,height:S},new Uint8Array(C)),f.usvg=!1,f.icon=void 0,N=!0):f.data.replace(C,z),this.style.updateImage(a,f,N)}hasImage(p){return p?!!this.style&&!!this.style.getImage(t.I.from(p)):(this.fire(new t.z(new Error("Missing required image id"))),!1)}removeImage(p){this.style.removeImage(t.I.from(p))}loadImage(p,i){t.o(this._requestManager.transformRequest(p,t.R.Image),(a,f)=>{i(a,f instanceof HTMLImageElement?t.q.getImageData(f):f)})}listImages(){return this.style.listImages().map(p=>p.name)}addModel(p,i){this._lazyInitEmptyStyle(),this.style.addModel(p,i)}hasModel(p){return p?this.style.hasModel(p):(this.fire(new t.z(new Error("Missing required model id"))),!1)}removeModel(p){this.style.removeModel(p)}listModels(){return this.style.listModels()}addLayer(p,i){return this._isValidId(p.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(p,i),this._update(!0)):this}getSlot(p){let i=this.getLayer(p);return i&&i.slot||null}setSlot(p,i){return this.style.setSlot(p,i),this.style.mergeLayers(),this._update(!0)}addImport(p,i){return this.style.addImport(p,i).catch(a=>this.fire(new t.z(new Error("Failed to add import",a)))),this}updateImport(p,i){return typeof i!="string"&&i.id!==p?(this.removeImport(p),this.addImport(i)):(this.style.updateImport(p,i),this._update(!0))}removeImport(p){return this.style.removeImport(p),this}moveImport(p,i){return this.style.moveImport(p,i),this._update(!0)}moveLayer(p,i){return this._isValidId(p)?(this.style.moveLayer(p,i),this._update(!0)):this}removeLayer(p){return this._isValidId(p)?(this.style.removeLayer(p),this._update(!0)):this}getLayer(p){if(!this._isValidId(p))return null;let i=this.style.getOwnLayer(p);return i?i.type==="custom"?i.implementation:i.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(p,i,a){return this._isValidId(p)?(this.style.setLayerZoomRange(p,i,a),this._update(!0)):this}setFilter(p,i,a={}){return this._isValidId(p)?(this.style.setFilter(p,i,a),this._update(!0)):this}getFilter(p){return this._isValidId(p)?this.style.getFilter(p):null}setPaintProperty(p,i,a,f={}){return this._isValidId(p)?(this.style.setPaintProperty(p,i,a,f),this._update(!0)):this}getPaintProperty(p,i){return this._isValidId(p)?this.style.getPaintProperty(p,i):null}setLayoutProperty(p,i,a,f={}){return this._isValidId(p)?(this.style.setLayoutProperty(p,i,a,f),this._update(!0)):this}getLayoutProperty(p,i){return this._isValidId(p)?this.style.getLayoutProperty(p,i):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(p){return this.style.setGlyphsUrl(p),this._update(!0)}getSchema(p){return this.style.getSchema(p)}setSchema(p,i){return this.style.setSchema(p,i),this._update(!0)}getConfig(p){return this.style.getConfig(p)}setConfig(p,i){return this.style.setConfig(p,i),this._update(!0)}getConfigProperty(p,i){return this.style.getConfigProperty(p,i)}setConfigProperty(p,i,a){return this.style.setConfigProperty(p,i,a),this._update(!0)}getFeaturesetDescriptors(p){return this.style.getFeaturesetDescriptors(p)}setLights(p){if(this._lazyInitEmptyStyle(),p&&p.length===1&&p[0].type==="flat"){let i=p[0];i.properties?this.style.setFlatLight(i.properties,i.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(p),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){let p=this.style.getLights()||[];return p.length===0&&p.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),p}setLight(p,i={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:p}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(p){return this._lazyInitEmptyStyle(),!p&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(p),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(p){return this._lazyInitEmptyStyle(),this.style.setFog(p),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(p){return this._lazyInitEmptyStyle(),this.style.setSnow(p),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(p){return this._lazyInitEmptyStyle(),this.style.setRain(p),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(p){return this._lazyInitEmptyStyle(),this.style.setColorTheme(p),this._update(!0)}setImportColorTheme(p,i){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(p,i),this._update(!0)}setCamera(p){return this.style.setCamera(p),this._triggerCameraUpdate(p)}_triggerCameraUpdate(p){return this._update(this.transform.setOrthographicProjectionAtLowPitch(p["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(p){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(t.cd.convert(p),this.transform):0}setFeatureState(p,i){return p.source&&!this._isValidId(p.source)?this:(this.style.setFeatureState(p,i),this._update())}removeFeatureState(p,i){return p.source&&!this._isValidId(p.source)?this:(this.style.removeFeatureState(p,i),this._update())}getFeatureState(p){return p.source&&!this._isValidId(p.source)?null:this.style.getFeatureState(p)}_updateContainerDimensions(){if(!this._container)return;let p=this._container.getBoundingClientRect().width||400,i=this._container.getBoundingClientRect().height||300,a,f,g,v=this._container;for(;v&&(!f||!g);){let S=window.getComputedStyle(v).transform;S&&S!=="none"&&(a=S.match(/matrix.*\((.+)\)/)[1].split(", "),a[0]&&a[0]!=="0"&&a[0]!=="1"&&(f=a[0]),a[3]&&a[3]!=="0"&&a[3]!=="1"&&(g=a[3])),v=v.parentElement}this._containerWidth=f?Math.abs(p/f):p,this._containerHeight=g?Math.abs(i/g):i}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&t.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){let p=this._container;p.classList.add("mapboxgl-map"),(this._missingCSSCanary=on("div","mapboxgl-canary",p)).style.visibility="hidden",this._detectMissingCSS();let i=this._canvasContainer=on("div","mapboxgl-canvas-container",p);this._canvas=on("canvas","mapboxgl-canvas",i),this._interactive&&(i.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);let a=this._controlContainer=on("div","mapboxgl-control-container",p),f=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(g=>{f[g]=on("div",`mapboxgl-ctrl-${g}`,a)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(p,i){let a=t.q.devicePixelRatio||1;this._canvas.width=a*Math.ceil(p),this._canvas.height=a*Math.ceil(i),this._canvas.style.width=`${p}px`,this._canvas.style.height=`${i}px`}_addMarker(p){this._markers.push(p)}_removeMarker(p){let i=this._markers.indexOf(p);i!==-1&&this._markers.splice(i,1)}_addPopup(p){this._popups.push(p)}_removePopup(p){let i=this._popups.indexOf(p);i!==-1&&this._popups.splice(i,1)}_setupPainter(){let p=t.l({},Wi.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),i=this._canvas.getContext("webgl2",p);i?(va(i,!0),this.painter=new qh(i,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp),this.on("data",a=>{a.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),t.m.testSupport(i)):this.fire(new t.z(new Error("Failed to initialize WebGL")))}_contextLost(p){p.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new t.A("webglcontextlost",{originalEvent:p}))}_contextRestored(p){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new t.A("webglcontextrestored",{originalEvent:p}))}_onMapScroll(p){if(p.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(p){return this.style?(this._styleDirty=this._styleDirty||p,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(p){return this._update(),this._renderTaskQueue.add(p)}_cancelRenderFrame(p){this._renderTaskQueue.remove(p)}_requestDomTask(p){!this.loaded()||this.loaded()&&!this.isMoving()?p():this._domRenderTaskQueue.add(p)}_render(p){let i;this.fire(new t.A("renderstart")),++this._frameId;let a=this.painter.context.extTimerQuery,f=t.q.now(),g=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(i=g.createQuery(),g.beginQuery(a.TIME_ELAPSED_EXT,i)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(p),this._domRenderTaskQueue.run(p),this._removed)return;this._updateProjectionTransition();let v=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;let N=this.transform.zoom,U=this.transform.pitch,$=t.q.now(),Z=new t.aa(N,{now:$,fadeDuration:v,pitch:U,transition:this.style.transition});this.style.update(Z)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let S=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),S=this._updateAverageElevation(f),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):S=this._updateAverageElevation(f);let C=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,v,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),C&&(this._placementDirty=C.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:v,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new t.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,Cn.mark(yi.load),this.fire(new t.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),i){let N=t.q.now()-f;g.endQuery(a.TIME_ELAPSED_EXT),setTimeout(()=>{let U=g.getQueryParameter(i,g.QUERY_RESULT)/1e6;g.deleteQuery(i),this.fire(new t.A("gpu-timing-frame",{cpuTime:N,gpuTime:U}))},50)}if(this.listens("gpu-timing-layer")){let N=this.painter.collectGpuTimers();setTimeout(()=>{let U=this.painter.queryGpuTimers(N);this.fire(new t.A("gpu-timing-layer",{layerTimes:U}))},50)}if(this.listens("gpu-timing-deferred-render")){let N=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{let U=this.painter.queryGpuTimeDeferredRender(N);this.fire(new t.A("gpu-timing-deferred-render",{gpuTime:U}))},50)}let z=this._sourcesDirty||this._styleDirty||this._placementDirty||S;if(z||this._repaint)this.triggerRepaint();else{let N=this.idle();if(N&&(S=this._updateAverageElevation(f,!0)),S)this.triggerRepaint();else if(this._triggerFrame(!1),N&&(this.fire(new t.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){let U=this._calculateSpeedIndex();this.fire(new t.A("speedindexcompleted",{speedIndex:U})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||z||(this._fullyLoaded=!0,Cn.mark(yi.fullLoad),this._performanceMetricsCollection&&$c(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(p){for(let i of this._markers)p&&!this.getRenderWorldCopies()&&(i._lngLat=i._lngLat.wrap()),i._update();for(let i of this._popups)!p||this.getRenderWorldCopies()||i._trackPointer||(i._lngLat=i._lngLat.wrap()),i._update()}_updateAverageElevation(p,i=!1){let a=g=>(this.transform.averageElevation=g,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&a(0);let f=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(f||(i||p-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(p)){let g=this.transform.averageElevation,v=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(v)?v=0:this._averageElevationLastSampledAt=p;let S=Math.abs(g-v);if(S>1){if(this._isInitialLoad||f)return this._averageElevation.jumpTo(v),a(v);this._averageElevation.easeTo(v,p,300)}else if(S>1e-4)return this._averageElevation.jumpTo(v),a(v)}return!!this._averageElevation.isEasing(p)&&a(this._averageElevation.getValue(p))}_authenticate(){yc(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,p=>{if(p&&(p.message===No||p.status===401)){let i=this.painter.context.gl;va(i,!1),this._logoControl instanceof Kp&&this._logoControl._updateLogo(),i&&i.clear(i.DEPTH_BUFFER_BIT|i.COLOR_BUFFER_BIT|i.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new t.z(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),xa(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&jr(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){let p=this._isDragging();this.painter.updateTerrain(this.style,p)}_calculateSpeedIndex(){let p=this.painter.canvasCopy(),i=this.painter.getCanvasCopiesAndTimestamps();i.timeStamps.push(performance.now());let a=this.painter.context.gl,f=a.createFramebuffer();function g(v){a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,v,0);let S=new Uint8Array(a.drawingBufferWidth*a.drawingBufferHeight*4);return a.readPixels(0,0,a.drawingBufferWidth,a.drawingBufferHeight,a.RGBA,a.UNSIGNED_BYTE,S),S}return a.bindFramebuffer(a.FRAMEBUFFER,f),this._canvasPixelComparison(g(p),i.canvasCopies.map(g),i.timeStamps)}_canvasPixelComparison(p,i,a){let f=a[1]-a[0],g=p.length/4;for(let v=0;v<i.length;v++){let S=i[v],C=0;for(let z=0;z<S.length;z+=4)S[z]===p[z]&&S[z+1]===p[z+1]&&S[z+2]===p[z+2]&&S[z+3]===p[z+3]&&(C+=1);f+=(a[v+2]-a[v+1])*(1-C/g)}return f}remove(){this._hash&&this._hash.remove();for(let i of this._controls)i.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);let p=this.painter.context.gl.getExtension("WEBGL_lose_context");p&&p.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Os.delete(this.painter.context.gl),gr.remove(),Da.remove(),this._removed=!0,this.fire(new t.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(p){this._renderNextFrame=this._renderNextFrame||p,this.style&&!this._frame&&(this._frame=t.q.frame(i=>{let a=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,a&&this._render(i)}))}_preloadTiles(p){let i=this.style?this.style.getSourceCaches():[];return t.bt(i,(a,f)=>a._preloadTiles(p,f),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(p){this._trackResize&&this.resize({originalEvent:p})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(p){this._showTileBoundaries!==p&&(this._showTileBoundaries=p,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(p){this._showParseStatus!==p&&(this._showParseStatus=p,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(p){this._showTerrainWireframe!==p&&(this._showTerrainWireframe=p,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(p){this._showLayers2DWireframe!==p&&(this._showLayers2DWireframe=p,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(p){this._showLayers3DWireframe!==p&&(this._showLayers3DWireframe=p,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(p){this._speedIndexTiming!==p&&(this._speedIndexTiming=p,this._update())}get showPadding(){return!!this._showPadding}set showPadding(p){this._showPadding!==p&&(this._showPadding=p,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(p){this._showCollisionBoxes!==p&&(this._showCollisionBoxes=p,this._tp.refreshUI(),p?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(p){this._showOverdrawInspector!==p&&(this._showOverdrawInspector=p,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(p){this._repaint!==p&&(this._repaint=p,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(p){this._vertices=p,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(p){this._showTileAABBs!==p&&(this._showTileAABBs=p,this._tp.refreshUI(),p&&this._update())}_setCacheLimits(p,i){t.eJ(p,i)}get version(){return at}},NavigationControl:class{constructor(p={}){this.options=t.l({},Fm,p),this._container=on("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",i=>i.preventDefault()),this.options.showZoom&&(t.aV(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",i=>{this._map&&this._map.zoomIn({},{originalEvent:i})}),on("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",i=>{this._map&&this._map.zoomOut({},{originalEvent:i})}),on("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(t.aV(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",i=>{let a=this._map;a&&(this.options.visualizePitch?a.resetNorthPitch({},{originalEvent:i}):a.resetNorth({},{originalEvent:i}))}),this._compassIcon=on("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){let p=this._map;if(!p)return;let i=p.getZoom(),a=i===p.getMaxZoom(),f=i===p.getMinZoom();this._zoomInButton.disabled=a,this._zoomOutButton.disabled=f,this._zoomInButton.setAttribute("aria-disabled",a.toString()),this._zoomOutButton.setAttribute("aria-disabled",f.toString())}_rotateCompassArrow(){let p=this._map;if(!p)return;let i=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(p.transform.pitch*(Math.PI/180)),.5)}) rotateX(${p.transform.pitch}deg) rotateZ(${p.transform.angle*(180/Math.PI)}deg)`:`rotate(${p.transform.angle*(180/Math.PI)}deg)`;p._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=i)})}onAdd(p){return this._map=p,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),p.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&p.on("pitch",this._rotateCompassArrow),p.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Yp(p,this._compass,this.options.visualizePitch)),this._container}onRemove(){let p=this._map;p&&(this._container.remove(),this.options.showZoom&&p.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&p.off("pitch",this._rotateCompassArrow),p.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(p,i){let a=on("button",p,this._container);return a.type="button",a.addEventListener("click",i),a}_setButtonTitle(p,i){if(!this._map)return;let a=this._map._getUIString(`NavigationControl.${i}`);p.setAttribute("aria-label",a),p.firstElementChild&&p.firstElementChild.setAttribute("title",a)}},GeolocateControl:class extends t.E{constructor(p={}){super();let i=navigator.geolocation;this.options=t.l({geolocation:i},cp,p),t.aV(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=uc(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(p){return this._map=p,this._container=on("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(p){let i=(a=!!this.options.geolocation)=>{this._supportsGeolocation=a,p(a)};this._supportsGeolocation!==void 0?p(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(a=>i(a.state!=="denied")).catch(()=>i()):i()}_isOutOfMapMaxBounds(p){let i=this._map.getMaxBounds(),a=p.coords;return!!i&&(a.longitude<i.getWest()||a.longitude>i.getEast()||a.latitude<i.getSouth()||a.latitude>i.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(p){if(this._map){if(this._isOutOfMapMaxBounds(p))return this._setErrorState(),this.fire(new t.A("outofmaxbounds",p)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=p,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(p),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(p),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new t.A("geolocate",p)),this._finish()}}_updateCamera(p){let i=new t.cd(p.coords.longitude,p.coords.latitude),a=p.coords.accuracy,f=this._map.getBearing(),g=t.l({bearing:f},this.options.fitBoundsOptions);this._map.fitBounds(i.toBounds(a),g,{geolocateSource:!0})}_updateMarker(p){if(p){let i=new t.cd(p.coords.longitude,p.coords.latitude);this._accuracyCircleMarker.setLngLat(i).addTo(this._map),this._userLocationDotMarker.setLngLat(i).addTo(this._map),this._accuracy=p.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){let p=this._map.transform,i=t.c6(1,p._center.lat)*p.worldSize,a=Math.ceil(2*this._accuracy*i);this._circleElement.style.width=`${a}px`,this._circleElement.style.height=`${a}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(p){if(this._map){if(this.options.trackUserLocation)if(p.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;let i=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",i),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",i),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(p.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new t.A("error",p)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(p){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",i=>i.preventDefault()),this._geolocateButton=on("button","mapboxgl-ctrl-geolocate",this._container),on("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",p===!1){t.w("Geolocation support is not available so the GeolocateControl will be disabled.");let i=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",i),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",i)}else{let i=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",i),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",i)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=on("div","mapboxgl-user-location"),this._dotElement.appendChild(on("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(on("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new bf({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=on("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new bf({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",i=>{i.geolocateSource||this._watchState!=="ACTIVE_LOCK"||i.originalEvent&&i.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new t.A("trackuserlocationend")))})}}_onDeviceOrientation(p){this._userLocationDotMarker&&(p.webkitCompassHeading?this._heading=p.webkitCompassHeading:p.absolute===!0&&(this._heading=-1*p.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return t.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new t.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new t.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new t.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let p;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(p={maximumAge:6e5,timeout:0},this._noTimeout=!0):(p=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,p),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){let p=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"&&p()}).catch(console.error):p()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Ba,ScaleControl:class{constructor(p={}){this.options=t.l({},ld,p),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),t.aV(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){let p=this.options.maxWidth||100,i=this._map,a=i._containerHeight/2,f=i._containerWidth/2-p/2,g=i.unproject([f,a]),v=i.unproject([f+p,a]),S=g.distanceTo(v);if(this.options.unit==="imperial"){let C=3.2808*S;C>5280?this._setScale(p,C/5280,"mile"):this._setScale(p,C,"foot")}else this.options.unit==="nautical"?this._setScale(p,S/1852,"nautical-mile"):S>=1e3?this._setScale(p,S/1e3,"kilometer"):this._setScale(p,S,"meter")}_setScale(p,i,a){this._map._requestDomTask(()=>{let f=function(v){let S=Math.pow(10,`${Math.floor(v)}`.length-1),C=v/S;return C=C>=10?10:C>=5?5:C>=3?3:C>=2?2:C>=1?1:function(z){let N=Math.pow(10,Math.ceil(-Math.log(z)/Math.LN10));return Math.round(z*N)/N}(C),S*C}(i),g=f/i;this._container.innerHTML=this._isNumberFormatSupported&&a!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:a}).format(f):`${f}&nbsp;${Wh[a]}`,this._container.style.width=p*g+"px"})}onAdd(p){return this._map=p,this._language=p.getLanguage(),this._container=on("div","mapboxgl-ctrl mapboxgl-ctrl-scale",p.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(p){this._language=p,this._update()}setUnit(p){this.options.unit=p,this._update()}},FullscreenControl:class{constructor(p={}){this._fullscreen=!1,p&&p.container&&(p.container instanceof HTMLElement?this._container=p.container:t.w("Full screen control 'container' must be a DOM element.")),t.aV(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(p){return this._map=p,this._container||(this._container=this._map.getContainer()),this._controlContainer=on("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",t.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){let p=this._fullscreenButton=on("button","mapboxgl-ctrl-fullscreen",this._controlContainer);on("span","mapboxgl-ctrl-icon",p).setAttribute("aria-hidden","true"),p.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){let p=this._getTitle();this._fullscreenButton.setAttribute("aria-label",p),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",p)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends t.E{constructor(p){super(),this.options=t.l(Object.create(tl),p),this._altitude=this.options.altitude,t.aV(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(p&&p.className?p.className.trim().split(/\s+/):[])}addTo(p){return this._map&&this.remove(),this._map=p,this.options.closeOnClick&&p.on("preclick",this._onClose),this.options.closeOnMove&&p.on("move",this._onClose),p.on("remove",this.remove),this._update(),p._addPopup(this),this._focusFirstElement(),this._trackPointer?(p.on("mousemove",this._onMouseEvent),p.on("mouseup",this._onMouseEvent),p._canvasContainer.classList.add("mapboxgl-track-pointer")):p.on("move",this._update),this.fire(new t.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);let p=this._map;return p&&(p.off("move",this._update),p.off("move",this._onClose),p.off("preclick",this._onClose),p.off("click",this._onClose),p.off("remove",this.remove),p.off("mousemove",this._onMouseEvent),p.off("mouseup",this._onMouseEvent),p.off("drag",this._onMouseEvent),p._canvasContainer&&p._canvasContainer.classList.remove("mapboxgl-track-pointer"),p._removePopup(this),this._map=void 0),this.fire(new t.A("close")),this}getLngLat(){return this._lngLat}setLngLat(p){this._lngLat=t.cd.convert(p),this._pos=null,this._trackPointer=!1,this._update();let i=this._map;return i&&(i.on("move",this._update),i.off("mousemove",this._onMouseEvent),i._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(p){return this._altitude=p,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();let p=this._map;return p&&(p.off("move",this._update),p.on("mousemove",this._onMouseEvent),p.on("drag",this._onMouseEvent),p._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(p){return this.setDOMContent(document.createTextNode(p))}setHTML(p){let i=document.createDocumentFragment(),a=document.createElement("body"),f;for(a.innerHTML=p;f=a.firstChild,f;)i.appendChild(f);return this.setDOMContent(i)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(p){return this.options.maxWidth=p,this._update(),this}setDOMContent(p){let i=this._content;if(i)for(;i.hasChildNodes();)i.firstChild&&i.removeChild(i.firstChild);else i=this._content=on("div","mapboxgl-popup-content",this._container||void 0);if(i.appendChild(p),this.options.closeButton){let a=this._closeButton=on("button","mapboxgl-popup-close-button",i);a.type="button",a.setAttribute("aria-label","Close popup"),a.innerHTML='<span aria-hidden="true">&#215;</span>',a.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(p){return this._classList.add(p),this._updateClassList(),this}removeClassName(p){return this._classList.delete(p),this._updateClassList(),this}setOffset(p){return this.options.offset=p,this._update(),this}toggleClassName(p){let i;return this._classList.delete(p)?i=!1:(this._classList.add(p),i=!0),this._updateClassList(),i}_onMouseEvent(p){this._update(p.point)}_getAnchor(p){if(this.options.anchor)return this.options.anchor;let i=this._map,a=this._container,f=this._pos;if(!i||!a||!f)return"bottom";let g=a.offsetWidth,v=a.offsetHeight,S=f.x<g/2,C=f.x>i.transform.width-g/2;if(f.y+p<v)return S?"top-left":C?"top-right":"top";if(f.y>i.transform.height-v){if(S)return"bottom-left";if(C)return"bottom-right"}return S?"left":C?"right":"bottom"}_updateClassList(){let p=this._container;if(!p)return;let i=[...this._classList];i.push("mapboxgl-popup"),this._anchor&&i.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&i.push("mapboxgl-popup-track-pointer"),p.className=i.join(" ")}_update(p){let i=this._map,a=this._content;if(!i||!this._lngLat&&!this._trackPointer||!a)return;let f=this._container;if(f||(f=this._container=on("div","mapboxgl-popup",i.getContainer()),this._tip=on("div","mapboxgl-popup-tip",f),f.appendChild(a)),this.options.maxWidth&&f.style.maxWidth!==this.options.maxWidth&&(f.style.maxWidth=this.options.maxWidth),i.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Bm(this._lngLat,this._pos,i.transform)),!this._trackPointer||p){let g=this._pos=this._trackPointer&&p instanceof t.P?p:i.project(this._lngLat,this._altitude),v=cd(this.options.offset),S=this._anchor=this._getAnchor(v.y),C=cd(this.options.offset,S),z=g.add(C).round();i._requestDomTask(()=>{this._container&&S&&(this._container.style.transform=`${Nm[S]} translate(${z.x}px,${z.y}px)`)})}if(!this._marker&&i._showingGlobe()){let g=t.eK(i.transform,this._lngLat)?0:1;this._setOpacity(g)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;let p=this._container.querySelector(bl);p&&p.focus()}_onClose(){this.remove()}_setOpacity(p){this._container&&(this._container.style.opacity=`${p}`),this._content&&(this._content.style.pointerEvents=p?"auto":"none")}},Marker:bf,Style:Fl,LngLat:t.cd,LngLatBounds:t.aG,Point:t.P,MercatorCoordinate:t.ac,FreeCameraOptions:Bu,Evented:t.E,config:t.e,prewarm:t.eP,clearPrewarmedResources:t.eQ,get accessToken(){return t.e.ACCESS_TOKEN},set accessToken(p){t.e.ACCESS_TOKEN=p},get baseApiUrl(){return t.e.API_URL},set baseApiUrl(p){t.e.API_URL=p},get workerCount(){return t.eR.workerCount},set workerCount(p){t.eR.workerCount=p},get maxParallelImageRequests(){return t.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(p){t.e.MAX_PARALLEL_IMAGE_REQUESTS=p},clearStorage(p){t.eS(p)},get workerUrl(){return t.eT.workerUrl},set workerUrl(p){t.eT.workerUrl=p},get workerClass(){return t.eT.workerClass},set workerClass(p){t.eT.workerClass=p},get workerParams(){return t.eT.workerParams},set workerParams(p){t.eT.workerParams=p},get dracoUrl(){return t.eU()},set dracoUrl(p){t.eV(p)},get meshoptUrl(){return t.eW()},set meshoptUrl(p){t.eX(p)},setNow:t.q.setNow,restoreNow:t.q.restoreNow}});var O=P;return O})});var ks=function(oe){return oe[oe.VERBOSE=0]="VERBOSE",oe[oe.INFO=1]="INFO",oe[oe.WARNING=2]="WARNING",oe[oe.ERROR=3]="ERROR",oe}(ks||{}),Yo=(()=>{class oe{logLevel;constructor(){this.logLevel=ks.VERBOSE,Il.production&&(this.logLevel=ks.INFO)}log(P,Y=ks.VERBOSE){console&&console.log&&Y>=this.logLevel&&console.log("["+ks[Y]+"] {"+new Date().toLocaleTimeString()+"} "+P)}static \u0275fac=function(Y){return new(Y||oe)};static \u0275prov=rs({token:oe,factory:oe.\u0275fac,providedIn:"root"})}return oe})();var vm=(()=>{class oe{http;logging;referenceData;filteredReferenceData;constructor(P,Y){this.http=P,this.logging=Y,this.loadCachedRefData()}refreshReferenceData(P){return On(this,null,function*(){try{let Y=yield P.fetchCoreReferenceData(null).toPromise();return this.setCoreReferenceData(Y),this.setFilteredReferenceData(Y),this.logging.log("Got refreshed core ref data.",ks.VERBOSE),this.sortCoreReferenceData(),this.cacheCurrentRefData(),!0}catch(Y){return this.logging.log("Error fetching core ref data:"+Y),!1}})}refreshFilteredReferenceData(P,Y){P.fetchCoreReferenceData(Y).subscribe(O=>{this.setFilteredReferenceData(O),this.sortCoreReferenceData(),this.logging.log("Got refreshed filtered reference data.",ks.VERBOSE)},O=>{this.logging.log("Error fetching filtered reference data:"+O)})}setCoreReferenceData(P){this.referenceData=P}setFilteredReferenceData(P){this.filteredReferenceData=P}referenceDataLoaded(){return this.referenceData!=null}getCountries(P=!1){return P==!0?this.filteredReferenceData.Countries:this.referenceData.Countries}getCountryByID(P){return this.getRefDataByID(this.referenceData.Countries,P)}getConnectionTypes(P=!1){return P==!0?this.filteredReferenceData.ConnectionTypes:this.referenceData.ConnectionTypes}getConnectionTypeByID(P){return this.getRefDataByID(this.referenceData.ConnectionTypes,P)}getUsageTypes(P=!1){return P==!0?this.filteredReferenceData.UsageTypes:this.referenceData.UsageTypes.filter(Y=>Y.ID>0)}getUsageTypeByID(P){return this.getRefDataByID(this.referenceData.UsageTypes,P)}getStatusTypes(P=!1){return P==!0?this.filteredReferenceData.StatusTypes:this.referenceData.StatusTypes.filter(Y=>Y.ID>0)}getStatusTypeByID(P){return this.getRefDataByID(this.referenceData.StatusTypes,P)}getNetworkOperators(P=!1){return P==!0?this.filteredReferenceData.Operators:this.referenceData.Operators}getNetworkOperatorByID(P){return this.getRefDataByID(this.referenceData.Operators,P)}getDataProviders(P=!1){return P==!0?this.filteredReferenceData.DataProviders:this.referenceData.DataProviders}getDataProviderByID(P){return this.getRefDataByID(this.referenceData.DataProviders,P)}getCheckinStatusTypes(P=!1,Y=!0){let O=null;return P==!0?O=this.filteredReferenceData.CheckinStatusTypes:O=this.referenceData.CheckinStatusTypes,Y&&(O=O.filter(t=>t.IsAutomatedCheckin===!1)),O}getCheckinStatusTypeByID(P){return this.getRefDataByID(this.referenceData.CheckinStatusTypes,P)}getCommentTypes(P=!1,Y=!0){let O;return P==!0?O=this.filteredReferenceData.UserCommentTypes:O=this.referenceData.UserCommentTypes,Y&&(O=O.filter(t=>t.ID!==100&&t.ID!==110)),O}getCommentTypeByID(P){return this.getRefDataByID(this.referenceData.UserCommentTypes,P)}getSubmissionStatusTypes(P=!1){return P==!0?this.filteredReferenceData.SubmissionStatusTypes:this.referenceData.SubmissionStatusTypes}getSubmissionStatusTypesByID(P){return this.getRefDataByID(this.referenceData.SubmissionStatusTypes,P)}getChargingLevelTypes(P=!1){return P==!0?this.filteredReferenceData.ChargerTypes:this.referenceData.ChargerTypes}getChargingLevelTypeByID(P){return this.getRefDataByID(this.referenceData.ChargerTypes,P)}getOutputCurrentTypes(P=!1){return P?this.referenceData.CurrentTypes:this.filteredReferenceData.CurrentTypes}getOutputCurrentTypeByID(P){return this.getRefDataByID(this.referenceData.CurrentTypes,P)}loadCachedRefData(){let P=localStorage.getItem("referenceData");if(P==null)this.http.get("./assets/data/CoreReferenceData.json").subscribe(Y=>{this.logging.log("Using bundled reference data as cached ref data."),this.setCoreReferenceData(Y),this.setFilteredReferenceData(Y)});else{let Y=JSON.parse(P);this.setCoreReferenceData(Y)}this.setFilteredReferenceData(this.referenceData)}cacheCurrentRefData(){this.referenceData!=null&&(this.referenceData.CacheDate=new Date,localStorage.setItem("referenceData",JSON.stringify(this.referenceData)))}getRefDataByID(P,Y){if(Y!==""&&(Y=parseInt(Y,10)),P!=null){for(let O=0;O<P.length;O++)if(P[O].ID===Y)return P[O]}return null}sortCoreReferenceData(){this.sortReferenceData(this.referenceData.ConnectionTypes),this.sortReferenceData(this.referenceData.Countries),this.sortReferenceData(this.referenceData.Operators),this.sortReferenceData(this.referenceData.DataProviders),this.sortReferenceData(this.referenceData.UsageTypes),this.sortReferenceData(this.referenceData.StatusTypes),this.sortReferenceData(this.referenceData.CheckinStatusTypes),this.sortReferenceData(this.referenceData.SubmissionStatusTypes),this.filteredReferenceData&&(this.sortReferenceData(this.filteredReferenceData.ConnectionTypes),this.sortReferenceData(this.filteredReferenceData.Operators))}sortReferenceData(P){P.sort(this.sortListByTitle)}sortListByTitle(P,Y){return P.Title<Y.Title?-1:P.Title>Y.Title?1:0}getMetadataValueByMetadataFieldID(P,Y){if(Y!==""&&(Y=parseInt(Y,10)),P!=null){for(let O=0;O<P.length;O++)if(P[O].ID===Y)return P[O]}return null}hydrateCompactPOI(P,Y=!1){let O=this;if(P.DataProviderID!=null&&(Y||P.DataProvider==null)&&(P.DataProvider=O.getDataProviderByID(P.DataProviderID)),P.OperatorID!=null&&(Y||P.OperatorInfo==null)&&(P.OperatorInfo=O.getNetworkOperatorByID(P.OperatorID)),P.UsageTypeID!=null&&(Y||P.UsageType==null)&&(P.UsageType=O.getUsageTypeByID(P.UsageTypeID)),P.AddressInfo.CountryID!=null&&(Y||P.AddressInfo.Country==null)&&(P.AddressInfo.Country=O.getCountryByID(P.AddressInfo.CountryID)),P.StatusTypeID!=null&&(Y||P.StatusType==null)&&(P.StatusType=O.getStatusTypeByID(P.StatusTypeID)),P.SubmissionStatusTypeID!=null&&(Y||P.SubmissionStatusType==null)&&(P.SubmissionStatusType=O.getSubmissionStatusTypesByID(P.SubmissionStatusTypeID)),P.Connections!=null)for(let t=0;t<P.Connections.length;t++){let at=P.Connections[t];at.ConnectionTypeID!=null&&(Y||at.ConnectionType==null)&&(at.ConnectionType=O.getConnectionTypeByID(at.ConnectionTypeID)),at.LevelID!=null&&(Y||at.Level==null)&&(at.Level=O.getChargingLevelTypeByID(at.LevelID)),at.CurrentTypeID!=null&&(Y||at.CurrentType==null)&&(at.CurrentType=O.getOutputCurrentTypeByID(at.CurrentTypeID)),at.StatusTypeID!=null&&(Y||at.StatusType==null)&&(at.StatusType=O.getStatusTypeByID(at.StatusTypeID)),P.Connections[t]=at}if(P.UserComments!=null)for(let t=0;t<P.UserComments.length;t++){let at=P.UserComments[t];at.CommentTypeID!=null&&(Y||at.CommentType==null)&&(at.CommentType=O.getCommentTypeByID(at.CommentTypeID)),at.CheckinStatusTypeID!=null&&(Y||at.CheckinStatusType==null)&&(at.CheckinStatusType=O.getCheckinStatusTypeByID(at.CheckinStatusTypeID)),P.UserComments[t]=at}return P}hydrateCompactPOIList(P){for(let Y=0;Y<P.length;Y++)P[Y]=this.hydrateCompactPOI(P[Y]);return P}static \u0275fac=function(Y){return new(Y||oe)(ur(Xl),ur(Yo))};static \u0275prov=rs({token:oe,factory:oe.\u0275fac,providedIn:"root"})}return oe})();var ly=class{ID;SubmissionType;Data;Attempts;DateQueued;IsSubmitted;IsInProgress;IsCancelled;IsFailure;FailureReason;constructor(Ht,P){this.SubmissionType=Ht,this.Data=P,this.DateQueued=new Date,this.IsSubmitted=!1,this.IsInProgress=!1,this.IsCancelled=!1,this.IsFailure=!1,this.Attempts=0,this.ID=new Date+"_"+Math.random()*100}};var Du=function(oe){return oe[oe.POI=0]="POI",oe[oe.Comment=1]="Comment",oe[oe.Media=2]="Media",oe}(Du||{});var cy=class oe{itemType;itemId;version;schemaVersion;syncTimeStamp;constructor(Ht,P){this.itemType=Ht,this.itemId=oe.getNewItemId(),this.version=1,this.schemaVersion=P,this.syncTimeStamp=oe.getNewSyncTimeStamp()}static getNewSyncTimeStamp(){return Date.now().toString()}static getNewItemId(){return"_syncitem_"+Date.now().toString()}};var eg=class{Title;Notes;_sync;constructor(Ht,P){this._sync=new cy(Ht,P)}},s_=class extends eg{PoiID;Type;Poi;Photos},kf=class extends eg{Stage;Position;PoiIDs;PoiList;constructor(){super("waypoint",1)}},a_=class extends eg{WayPoints;constructor(){super("journey_stage",1),this.WayPoints=[]}},bm=class extends eg{ID;Stages;constructor(){super("journey",1),this.ID=""+Date.now(),this.Stages=[]}},hy=class{Title;DistanceKM;DurationMinutes;StartElevation;EndElevation;EnergyConsumptionkWh},uy=class{Title;JourneyRouteLegs;TotalDistanceKM;TotalDurationMinutes;TotalEnergykWh};var Mp=class{Location;Title;Address;Type;ReferenceID;Attribution;AddressInfo};var Is=class{altitudeAccuracy;longitude;latitude;speed;heading;altitude;accuracy;constructor(Ht=null,P=null){this.latitude=Ht,this.longitude=P}toJSON(){JSON.stringify({latitude:this.latitude,longitude:this.longitude,altitude:this.altitude,accuracy:this.accuracy,altitudeAccuracy:this.altitudeAccuracy,speed:this.speed,heading:this.heading})}},wd=class oe{coords;timestamp;attribution;constructor(Ht=null,P=null){this.coords=new Is,this.coords.latitude=Ht,this.coords.longitude=P}static fromPosition(Ht){return new oe(Ht.coords.latitude,Ht.coords.longitude)}},dy=class{northEast;southWest;constructor(Ht,P){this.northEast=Ht,this.southWest=P}};var tg=class{OperatorList;ConnectionTypeList;CountryList;UsageTypeList;StatusTypeList;MinPowerKW;MaxPowerKW;UseDistanceInKM;HasActiveFilters;LastSearchPosition;StartSearchPosition;StartViewPoiId;Language;FilterOptionsByCountryId;MapType;EnableAdvancedEditorFeatures;EnablePOIPendingApproval;MaxResults;constructor(){this.OperatorList=[],this.ConnectionTypeList=[],this.CountryList=[],this.UsageTypeList=[],this.StatusTypeList=[],this.MaxPowerKW=null,this.MinPowerKW=null,this.HasActiveFilters=!1,this.FilterOptionsByCountryId=null,this.UseDistanceInKM=!0,this.MapType="ROADMAP",this.EnableAdvancedEditorFeatures=!1,this.EnablePOIPendingApproval=!1,this.MaxResults=500}LoadSettings(){}SaveSettings(){}ClearActiveFilters(){this.OperatorList=[],this.ConnectionTypeList=[],this.CountryList=[],this.UsageTypeList=[],this.StatusTypeList=[],this.MinPowerKW=null,this.MaxPowerKW=null}CheckForActiveFilters(){return this.OperatorList.length>0||this.ConnectionTypeList.length>0||this.CountryList.length>0||this.UsageTypeList.length>0||this.StatusTypeList.length>0||this.MinPowerKW>0||this.MaxPowerKW>0||this.MaxPowerKW!=null&&this.MaxPowerKW<1e3?this.HasActiveFilters=!0:this.HasActiveFilters=!1,this.HasActiveFilters}};var wm=class{poiIdList=null;countryCode=null;latitude=null;longitude=null;locationTitle=null;distance=null;distanceUnit=null;connectionTypeIdList=null;operatorIdList=null;levelIdList=null;countryIdList=null;usageTypeIdList=null;statusTypeIdList=null;minPowerKW=null;maxPowerKW=null;submissionStatusTypeIdList=null;maxResults=500;additionalParams=null;includeComments=!1;compact=!0;enableCaching=!0;levelOfDetail=1;polyline=null;boundingbox=null};var ig=(()=>{class oe{http;refData;logging;serviceBase="https://api.openchargemap.io";serviceBaseURL=this.serviceBase+"/v4";hasAuthorizationError=!1;ATTRIBUTION_METADATAFIELDID=4;authResponse;clientName="ocm.api.default";authorizationErrorCallback;generalErrorCallback;allowMirror=!1;lastPOIApiCallURL="";constructor(P,Y,O){this.http=P,this.refData=Y,this.logging=O,this.serviceBaseURL=Il.apiBase+"/v3"}getNumberListString(P){let Y="";for(let O=0;O<P.length;O++)Y+=P[O],O<P.length&&(Y+=",");return Y}fetchPOIListByParam(P){return On(this,null,function*(){let Y=this.serviceBaseURL+"/poi/?client="+this.clientName+(this.allowMirror?" &allowmirror=true":"")+"&verbose=false&output=json";P.compact=!0;let O="";P.countryCode!=null&&(O+="&countrycode="+P.countryCode),P.latitude!=null&&(O+="&latitude="+P.latitude),P.longitude!=null&&(O+="&longitude="+P.longitude),P.distance!=null&&(O+="&distance="+P.distance),P.distanceUnit!=null&&(O+="&distanceunit="+P.distanceUnit),P.includeComments!=null&&(O+="&includecomments="+P.includeComments),P.maxResults!=null&&(O+="&maxresults="+P.maxResults),P.countryIdList!=null&&(O+="&countryid="+this.getNumberListString(P.countryIdList)),P.levelIdList!=null&&(O+="&levelid="+this.getNumberListString(P.levelIdList)),P.connectionTypeIdList!=null&&P.connectionTypeIdList.length>0&&(O+="&connectiontypeid="+this.getNumberListString(P.connectionTypeIdList)),P.operatorIdList!=null&&P.operatorIdList.length>0&&(O+="&operatorid="+this.getNumberListString(P.operatorIdList)),P.usageTypeIdList!=null&&P.usageTypeIdList.length>0&&(O+="&usagetypeid="+this.getNumberListString(P.usageTypeIdList)),P.statusTypeIdList!=null&&P.statusTypeIdList.length>0&&(O+="&statustypeid="+this.getNumberListString(P.statusTypeIdList)),P.locationTitle!=null&&(O+="&locationtitle="+P.locationTitle),P.minPowerKW!=null&&P.minPowerKW>0&&(O+="&minpowerkw="+P.minPowerKW),P.maxPowerKW!=null&&P.maxPowerKW>0&&(O+="&maxpowerkw="+P.maxPowerKW),P.submissionStatusTypeIdList!=null&&(O+="&submissionstatustypeid="+this.getNumberListString(P.submissionStatusTypeIdList)),P.poiIdList!=null&&P.poiIdList.length>0&&(O+="&chargepointid="+this.getNumberListString(P.poiIdList)),P.enableCaching==!1&&(O+="&enablecaching=false"),P.compact!=null&&(O+="&compact="+P.compact),P.levelOfDetail>1&&(O+="&levelofdetail="+P.levelOfDetail),P.polyline!=null&&(O+="&polyline="+P.polyline),P.boundingbox!=null&&(O+="&boundingbox="+P.boundingbox),P.additionalParams!=null&&(O+="&"+P.additionalParams);let t=Y+O;if(this.lastPOIApiCallURL!==t||P.enableCaching==!1){this.lastPOIApiCallURL=t,this.logging.log("API Call:"+t,ks.VERBOSE);try{let at=yield this.http.get(t,this.getHttpRequestOptions()).toPromise();return this.refData.hydrateCompactPOIList(at)}catch(at){let yi=at.message||"Could not fetch POI list from server.";throw this.logging.log("API Client: "+JSON.stringify(at),ks.ERROR),yi}}else return this.logging.log("Skipped API call due to same query being repeated."),[]})}getHttpRequestOptions(P=!0){let Y=new $b;return P&&(Y=Y.append("Content-Type","application/json")),this.authResponse&&this.authResponse.Data&&this.authResponse.Data.access_token&&(Y=Y.append("Authorization","Bearer "+this.authResponse.Data.access_token)),Y=Y.append("X-API-Key",Il.apiKey),{headers:Y}}fetchCoreReferenceData(P){let Y=this.serviceBaseURL+"/referencedata/?client="+this.clientName+"&output=json"+(this.allowMirror?"&allowmirror=true":"")+"&verbose=false&compact=true";return P!=null&&P.CountryIds!=null&&(Y+="&countryid="+this.getNumberListString(P.CountryIds)),this.logging.log("API Call:"+Y,ks.VERBOSE),this.http.get(Y,this.getHttpRequestOptions())}performSignIn(P,Y){let O=this.serviceBaseURL+"/profile/authenticate/",t={emailaddress:P,password:Y};return this.http.post(O,JSON.stringify(t),this.getHttpRequestOptions()).toPromise().then(at=>(this.authResponse=at,this.authResponse))}performRegister(P,Y,O){let t=this.serviceBaseURL+"/profile/register/",at={username:P,emailaddress:Y,password:O};return this.http.post(t,JSON.stringify(at),this.getHttpRequestOptions()).toPromise().then(yi=>(this.authResponse=yi,this.authResponse))}performSubmission(P,Y){if(P===Du.POI)return this.submitPOI(Y);if(P===Du.Comment)return this.submitUserComment(Y);if(P===Du.Media)return this.submitMediaItem(Y)}submitUserComment(P){let Y=JSON.stringify(P);return this.logging.log("[api] Submitting user comment"),this.http.post(this.serviceBaseURL+"/comment/",Y,this.getHttpRequestOptions()).toPromise()}submitMediaItem(P){let Y=JSON.stringify(P);return this.http.post(this.serviceBaseURL+"/mediaitem/",Y,this.getHttpRequestOptions()).toPromise()}submitPOI(P){let Y=JSON.stringify(P);return this.http.post(this.serviceBaseURL+"/poi/",Y,this.getHttpRequestOptions()).toPromise()}getPanoramioLocationPhotos(P){return new Promise(Y=>{let t="https://www.panoramio.com/map/get_panoramas.php?set=public&from=0&to=2&minx="+(P.longitude-.001)+"&miny="+(P.latitude-.001)+"&maxx="+(P.longitude+.001)+"maxy="+(P.latitude+.001)+"&size=medium&mapfilter=true&callback=?";return console.log(t),this.http.get(t).toPromise()})}fetchReverseGeocodeResult(P,Y){let O=this.serviceBaseURL+"/geocode/?client="+this.clientName+"&output=json&camelcase=false&latitude="+P+"&longitude="+Y;return this.http.get(O,this.getHttpRequestOptions()).toPromise()}isLocalStorageAvailable(){return typeof window.localStorage<"u"}setCachedDataObject(P,Y){this.isLocalStorageAvailable()&&(typeof Y>"u"&&(Y=null),Y===null?localStorage.removeItem(P):localStorage.setItem(P,JSON.stringify(Y)))}getCachedDataObject(P){if(this.isLocalStorageAvailable()){let Y=localStorage.getItem(P);if(Y!=null&&Y.length>0)return JSON.parse(Y)}return null}static \u0275fac=function(Y){return new(Y||oe)(ur(Xl),ur(vm),ur(Yo))};static \u0275prov=rs({token:oe,factory:oe.\u0275fac,providedIn:"root"})}return oe})();var Zc=(()=>{class oe{c=new Map;constructor(){}subscribe(P,...Y){let O=this.c.get(P);O||this.c.set(P,O=[]),O.push(...Y)}unsubscribe(P,Y){if(!Y)return this.c.delete(P);let O=this.c.get(P);if(!O)return!1;let t=O.indexOf(Y);return t<0?!1:(O.splice(t,1),O.length===0&&this.c.delete(P),!0)}publish(P,...Y){let O=this.c.get(P);return O?O.map(t=>{try{return t(...Y)}catch(at){return console.error(at),null}}):null}static \u0275fac=function(Y){return new(Y||oe)};static \u0275prov=rs({token:oe,factory:oe.\u0275fac,providedIn:"root"})}return oe})();var U0=(()=>{class oe{logger;platform;isCordova=!1;ga=null;constructor(P,Y){this.logger=P,this.platform=Y,Y.is("cordova")||Y.is("capacitor")?this.isCordova=!0:this.isCordova=!1}init(P){return On(this,null,function*(){this.isCordova&&this.ga?yield this.ga.startTrackerWithId(P):this.logger.log("Could not initialise analytics")})}setAppVersion(P){return On(this,null,function*(){if(this.isCordova&&this.ga)return this.ga.setAppVersion(P);this.logger.log(P)})}appEvent(P,Y){return On(this,null,function*(){if(this.isCordova&&this.ga)return this.ga.trackEvent(P,Y);this.logger.log(Y)})}viewEvent(P){return On(this,null,function*(){if(this.isCordova&&this.ga)return this.ga.trackView(P);this.logger.log(P)})}static \u0275fac=function(Y){return new(Y||oe)(ur(Yo),ur(G_))};static \u0275prov=rs({token:oe,factory:oe.\u0275fac,providedIn:"root"})}return oe})();var ng=(()=>{class oe{api;events;logging;analytics;poiList;isRequestInProgress=!1;constructor(P,Y,O,t){this.api=P,this.events=Y,this.logging=O,this.analytics=t}refreshPOIList(P){return On(this,null,function*(){try{return this.poiList=yield this.fetchPOIList(P),this.events.publish("ocm:poiList:updated"),this.analytics.appEvent("Search","Fetched Results"),this.poiList.length}catch{return 0}})}fetchPOIList(P){return On(this,null,function*(){this.isRequestInProgress=!0;try{let Y=yield this.api.fetchPOIListByParam(P);return this.isRequestInProgress=!1,Y&&Y.length&&this.logging.log("fetched POI list ["+Y.length+"]"),Y}catch{return this.isRequestInProgress=!1,[]}})}clearResults(){this.poiList=[],this.events.publish("ocm:poiList:cleared"),this.logging.log("clearing results after settings change",ks.VERBOSE)}getPOIById(P,Y=!1,O=!1){return On(this,null,function*(){if(!O&&this.poiList!=null){let yi=this.poiList.find(Cn=>Cn.ID==P);if(yi)return yi}let t={poiIdList:[P],enableCaching:!O,includeComments:!0},at=yield this.api.fetchPOIListByParam(t);return at&&at.length>0?(this.poiList&&at[0].ID==P&&(this.poiList=this.poiList.filter(yi=>yi.ID!=P),this.poiList.push(at[0]),this.logging.log("POI refreshed in cache "+P)),at[0]):null})}static \u0275fac=function(Y){return new(Y||oe)(ur(ig),ur(Zc),ur(Yo),ur(U0))};static \u0275prov=rs({token:oe,factory:oe.\u0275fac,providedIn:"root"})}return oe})();var Sm=(()=>{class oe{api;poiManager;logging;journeys;favourites;routePolyline;constructor(P,Y,O){this.api=P,this.poiManager=Y,this.logging=O,this.journeys=[],this.favourites=[]}loadJourneys(){let P=localStorage.getItem("journeys");if(P!=null&&(this.journeys=JSON.parse(P)),this.journeys!=null)for(let Y of this.journeys)this.fetchAllJourneyPOIDetails(Y)}fetchAllJourneyPOIDetails(P){this.logging.log("Journeys - fetching poi details for Journey "+P.Title);let Y=new wm;Y.poiIdList=[];for(let O of P.Stages)for(let t of O.WayPoints)for(let at of t.PoiIDs)Y.poiIdList.push(at);this.api.fetchPOIListByParam(Y).then(O=>{for(let t of O)this.updateStoredPOI(t)})}updateStoredPOI(P){if(this.journeys.forEach(Y=>{Y.Stages.forEach(O=>{O.WayPoints.forEach(t=>{t.PoiIDs.forEach(at=>{if(at==P.ID)if(t.PoiList==null){t.PoiList=[];let yi=new s_("charging",1);yi.Poi=P,yi.PoiID=P.ID,t.PoiList.push(yi)}else for(let yi of t.PoiList)yi.PoiID==P.ID&&(yi.Poi=P)})})})}),this.favourites!=null)for(let Y of this.favourites)Y.Type=="charging"&&Y.PoiID==P.ID&&(Y.Poi=P)}saveJourneys(){let P=JSON.parse(JSON.stringify(this.journeys));for(let O of P)for(let t of O.Stages)for(let at of t.WayPoints)for(let yi of at.PoiList)yi.Poi=null,yi.Photos=null;let Y=JSON.stringify(P);localStorage.setItem("journeys",Y)}addJourney(P,Y){let O=new a_;O.Title="Stage 1",Y!=null&&O.WayPoints.push(Y),P.Stages.push(O),this.journeys.push(P)}deleteJourney(P){this.journeys=this.journeys.filter(Y=>Y.ID!=P),this.saveJourneys()}getJourney(P){let Y=this.journeys.filter(O=>O.ID==P);return Y.length>0?Y[0]:null}getJourneyStages(P){return this.getJourney(P).Stages}addJourneyWaypoint(P,Y,O){let t=this.getJourney(P);if(Y==null){let at=new a_;at.Title="Stage "+(t.Stages.length+1),at.WayPoints.push(O),t.Stages.push(at)}else{let at=t.Stages[Y];at.WayPoints==null&&(at.WayPoints=[]),at.WayPoints.push(O)}}addJourneyStage(P,Y){return this.getJourney(P).Stages.push(Y)-1}setupTestJourneys(){this.journeys=[];let P=new bm;P.Title="New York to Brooklyn",P.Notes="A little jaunt to Brooklyn",P.Stages=[];let Y=new a_,O=new kf;O.Notes="Starting point",O.Position=new Is(40,1.2),O.Title="Start",Y.WayPoints.push(O);let t=new kf;t.Notes="Middle point",t.Position=new Is(40,1.33),t.Title="Middle",Y.WayPoints.push(t);let at=new kf;at.Notes="End point",at.Position=new Is(40,1.33),at.Title="End",Y.WayPoints.push(at),P.Stages.push(Y),this.journeys.push(P);let yi=new bm;yi.Title="Aberdeen to London",yi.Notes="Roadtrip",yi.Stages=[],this.journeys.push(yi)}calculateEnergyConsumptionkWh(P,Y,O=0,t){return P*t}setRoutePolyline(P){this.routePolyline=P}getRoutePolyline(){return this.routePolyline}static \u0275fac=function(Y){return new(Y||oe)(ur(ig),ur(ng),ur(Yo))};static \u0275prov=rs({token:oe,factory:oe.\u0275fac,providedIn:"root"})}return oe})();var dw=(()=>{class oe{events;isQueueProcessing;appManager;constructor(P){this.events=P,this.isQueueProcessing=!1}setAppManager(P){this.appManager=P}add(P,Y){let O=this.getQueueItems();O.push(new ly(P,Y)),this.saveQueueItems(O)}update(P){let Y=this.getQueueItems(),O=new Array;return Y.forEach(t=>{t.ID==P.ID?O.push(P):O.push(t)}),O}processNextQueueItem(){let P=this.getNextQueueItem();P!=null&&this.appManager!=null&&this.appManager.api.performSubmission(P.SubmissionType,P.Data).then(()=>{P.IsSubmitted=!0,P.Attempts++,this.update(P),this.clear()})}getNextQueueItem(){let P=this.getQueueItems(),Y=null;return P.forEach(O=>{Y==null&&!O.IsCancelled&&!O.IsInProgress&&!O.IsSubmitted&&(Y=O)}),Y}hasPendingItems(){let P=!1;return this.getQueueItems().forEach(O=>{!O.IsFailure&&!O.IsCancelled&&!O.IsSubmitted&&(P=!0)}),P}isCompleted(){let P=this.getQueueItems(),Y=!0;return P.forEach(O=>{(O.IsInProgress||O.IsFailure)&&(Y=!1)}),Y}clear(P=!1){let Y=this.getQueueItems(),O=new Array;P||Y.forEach(t=>{(t.IsInProgress||t.IsFailure)&&O.push(t)}),this.saveQueueItems(O)}saveQueueItems(P){localStorage.setItem("submissionQueue",JSON.stringify(P))}getQueueItems(){let P=localStorage.getItem("submissionQueue");return P!=null?JSON.parse(P):new Array}static \u0275fac=function(Y){return new(Y||oe)(ur(Zc))};static \u0275prov=rs({token:oe,factory:oe.\u0275fac,providedIn:"root"})}return oe})();var nv=new zb("JWT_OPTIONS"),G0=(()=>{class oe{constructor(P=null){this.tokenGetter=P&&P.tokenGetter||function(){}}urlBase64Decode(P){let Y=P.replace(/-/g,"+").replace(/_/g,"/");switch(Y.length%4){case 0:break;case 2:{Y+="==";break}case 3:{Y+="=";break}default:throw new Error("Illegal base64url string!")}return this.b64DecodeUnicode(Y)}b64decode(P){let Y="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",O="";if(P=String(P).replace(/=+$/,""),P.length%4===1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let t=0,at,yi,Cn=0;yi=P.charAt(Cn++);~yi&&(at=t%4?at*64+yi:yi,t++%4)?O+=String.fromCharCode(255&at>>(-2*t&6)):0)yi=Y.indexOf(yi);return O}b64DecodeUnicode(P){return decodeURIComponent(Array.prototype.map.call(this.b64decode(P),Y=>"%"+("00"+Y.charCodeAt(0).toString(16)).slice(-2)).join(""))}decodeToken(P=this.tokenGetter()){return P instanceof Promise?P.then(Y=>this._decodeToken(Y)):this._decodeToken(P)}_decodeToken(P){if(!P||P==="")return null;let Y=P.split(".");if(Y.length!==3)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");let O=this.urlBase64Decode(Y[1]);if(!O)throw new Error("Cannot decode the token.");return JSON.parse(O)}getTokenExpirationDate(P=this.tokenGetter()){return P instanceof Promise?P.then(Y=>this._getTokenExpirationDate(Y)):this._getTokenExpirationDate(P)}_getTokenExpirationDate(P){let Y;if(Y=this.decodeToken(P),!Y||!Y.hasOwnProperty("exp"))return null;let O=new Date(0);return O.setUTCSeconds(Y.exp),O}isTokenExpired(P=this.tokenGetter(),Y){return P instanceof Promise?P.then(O=>this._isTokenExpired(O,Y)):this._isTokenExpired(P,Y)}_isTokenExpired(P,Y){if(!P||P==="")return!0;let O=this.getTokenExpirationDate(P);return Y=Y||0,O===null?!1:!(O.valueOf()>new Date().valueOf()+Y*1e3)}getAuthScheme(P,Y){return typeof P=="function"?P(Y):P}}return oe.\u0275fac=function(P){return new(P||oe)(ur(nv))},oe.\u0275prov=rs({token:oe,factory:oe.\u0275fac}),oe})(),pw=oe=>oe instanceof Promise?Rb(()=>oe):M0(oe),LT=(()=>{class oe{constructor(P,Y,O){this.jwtHelper=Y,this.document=O,this.standardPorts=["80","443"],this.tokenGetter=P.tokenGetter,this.headerName=P.headerName||"Authorization",this.authScheme=P.authScheme||P.authScheme===""?P.authScheme:"Bearer ",this.allowedDomains=P.allowedDomains||[],this.disallowedRoutes=P.disallowedRoutes||[],this.throwNoTokenError=P.throwNoTokenError||!1,this.skipWhenExpired=P.skipWhenExpired}isAllowedDomain(P){let Y=new URL(P.url,this.document.location.origin);if(Y.host===this.document.location.host)return!0;let O=`${Y.hostname}${Y.port&&!this.standardPorts.includes(Y.port)?":"+Y.port:""}`;return this.allowedDomains.findIndex(t=>typeof t=="string"?t===O:t instanceof RegExp?t.test(O):!1)>-1}isDisallowedRoute(P){let Y=new URL(P.url,this.document.location.origin);return this.disallowedRoutes.findIndex(O=>{if(typeof O=="string"){let t=new URL(O,this.document.location.origin);return t.hostname===Y.hostname&&t.pathname===Y.pathname}return O instanceof RegExp?O.test(P.url):!1})>-1}handleInterception(P,Y,O){let t=this.jwtHelper.getAuthScheme(this.authScheme,Y);if(!P&&this.throwNoTokenError)throw new Error("Could not get token from tokenGetter function.");let at=M0(!1);return this.skipWhenExpired&&(at=P?pw(this.jwtHelper.isTokenExpired(P)):M0(!0)),P?at.pipe(Db(yi=>yi&&this.skipWhenExpired?Y.clone():Y.clone({setHeaders:{[this.headerName]:`${t}${P}`}})),ev(yi=>O.handle(yi))):O.handle(Y)}intercept(P,Y){if(!this.isAllowedDomain(P)||this.isDisallowedRoute(P))return Y.handle(P);let O=this.tokenGetter(P);return pw(O).pipe(ev(t=>this.handleInterception(t,P,Y)))}}return oe.\u0275fac=function(P){return new(P||oe)(ur(nv),ur(G0),ur(Lb))},oe.\u0275prov=rs({token:oe,factory:oe.\u0275fac}),oe})(),pE=(()=>{class oe{constructor(P){if(P)throw new Error("JwtModule is already loaded. It should only be imported in your application's main module.")}static forRoot(P){return{ngModule:oe,providers:[{provide:Wb,useClass:LT,multi:!0},P.jwtOptionsProvider||{provide:nv,useValue:P.config},G0]}}}return oe.\u0275fac=function(P){return new(P||oe)(ur(oe,12))},oe.\u0275mod=D0({type:oe}),oe.\u0275inj=P0({}),oe})();var ru=(()=>{class oe{http;events;api;submissionQueue;platform;referenceDataManager;journeyManager;translateService;toastController;loadingController;jwtHelper;logging;analytics;enableSubmissionQueue;searchSettings;platformMode;journeys;isDebugMode;clientWidth;clientHeight;isRequestInProgress=!1;title="Open Charge Map";_isUserAuthenticated=null;isEmbeddedMode=!1;isOffline=!1;constructor(P,Y,O,t,at,yi,Cn,_r,an,Dt,Wi,on,vn){this.http=P,this.events=Y,this.api=O,this.submissionQueue=t,this.platform=at,this.referenceDataManager=yi,this.journeyManager=Cn,this.translateService=_r,this.toastController=an,this.loadingController=Dt,this.jwtHelper=Wi,this.logging=on,this.analytics=vn,this.api.clientName="ocm.app.ionic."+Il.version,this.isDebugMode=!1,this.enableSubmissionQueue=!1,this.submissionQueue.setAppManager(this),at.is("cordova")?this.platformMode="cordova":this.platformMode="web",this.initAppManager(),this.searchSettings=new tg,this.loadSearchSettings(),this.applyURLQueryStringOptions(),this.searchSettings.CheckForActiveFilters(),this.journeyManager.loadJourneys()}loadSearchSettings(){if(localStorage.getItem("searchSettings")!=null){this.searchSettings=new tg;try{let P=JSON.parse(localStorage.getItem("searchSettings"));Object.assign(this.searchSettings,P)}catch{}}}savePushRegistration(P){localStorage.setItem("_pushToken",P.toString())}getPushRegistration(){localStorage.getItem("_pushToken")}getQueryVariable(P){let O=window.location.search.substring(1).split("&");for(let t=0;t<O.length;t++){let at=O[t].split("=");if(decodeURIComponent(at[0])==P)return at[1].split(",").map(_r=>decodeURIComponent(_r))}return null}applyURLQueryStringOptions(){if(this.getQueryVariable("mode")&&this.getQueryVariable("mode")[0]=="embedded"&&(this.isEmbeddedMode=!0),this.getQueryVariable("operatorid")){let P=this.getQueryVariable("operatorid");for(let Y of P)this.searchSettings.OperatorList.unshift(parseInt(Y,10))}if(this.getQueryVariable("latitude")&&this.getQueryVariable("longitude")){let P=this.getQueryVariable("latitude")[0],Y=this.getQueryVariable("longitude")[0];this.searchSettings.StartSearchPosition=new Is(parseFloat(P),parseFloat(Y))}this.getQueryVariable("title")&&(this.title=this.getQueryVariable("title")[0]),this.getQueryVariable("languagecode")&&this.setLanguage(this.getQueryVariable("languagecode")[0]),this.getQueryVariable("id")&&(this.searchSettings.StartViewPoiId=this.getQueryVariable("id")[0])}saveSearchSettings(){this.searchSettings.CheckForActiveFilters(),localStorage.setItem("searchSettings",JSON.stringify(this.searchSettings))}getLanguages(){return[{code:"ar",title:"\u0627\u0644\u0639\u0631\u0628\u064A\u0629 / Arabic"},{code:"bg",title:"Bulgarian / \u0411\u044A\u043B\u0433\u0430\u0440\u0441\u043A\u0438"},{code:"cs",title:"Czech / \u010Ce\u0161tina"},{code:"de",title:"German / Deutsch"},{code:"el",title:"Greek / \u0395\u03BB\u03BB\u03B7\u03BD\u03B9\u03BA\u03AE"},{code:"en",title:"English"},{code:"es",title:"Spanish / Espa\xF1ol"},{code:"et",title:"Estonian / Eesti"},{code:"fi",title:"Finnish / Suomi"},{code:"fr",title:"French / Fran\xE7ais"},{code:"fy",title:"West Frisian / Frysk"},{code:"hu",title:"Hungarian / Magyar"},{code:"it",title:"Italian / Italiano"},{code:"ja",title:"Japanese / \u65E5\u672C\u8A9E"},{code:"lt",title:"Lithuanian / Lietuvi\u0173"},{code:"nl",title:"Dutch / Nederlands"},{code:"pt",title:"Portuguese / portugu\xEAs"},{code:"ro",title:"Romanian / Rom\xE2n\u0103"},{code:"ru",title:"Russian / P\u0443\u0441\u0441\u043A\u0438\u0439"},{code:"sk",title:"Slovak / Sloven\u010Dina"},{code:"tr",title:"Turkish / T\xFCrk\xE7e"},{code:"zh",title:"Chinese / \u4E2D\u56FD\u7684"}]}setLanguage(P){(P==null||P=="")&&(P="en"),this.logging.log("Changing language: "+P),this.translateService.use(P)}initAppManager(){this.initAuthFromStorage(),this.isUserAuthenticated(!0)&&this.enableSubmissionQueue&&this.submissionQueue!=null&&this.submissionQueue.hasPendingItems()&&this.submissionQueue.processNextQueueItem()}initAuthFromStorage(){let P=localStorage.getItem("authResponse");if(P!=null){let Y=JSON.parse(P);if(Y?.Data!=null&&Y?.Data?.access_token!=null){let O=this.jwtHelper.decodeToken(Y.Data.access_token);this.jwtHelper.isTokenExpired(Y.Data.access_token)?localStorage.removeItem("authResponse"):(this.api.authResponse=Y,this.logging.log("User has valid auth token in local storage",ks.VERBOSE))}else this.logging.log("User has invalid auth token in local storage",ks.VERBOSE),localStorage.removeItem("authResponse")}}isUserAuthenticated(P=!1){if(P===!1&&this._isUserAuthenticated!=null)return this._isUserAuthenticated;if(this._isUserAuthenticated=!1,this.api.authResponse!=null){let Y=this.api.authResponse;this.jwtHelper.isTokenExpired(Y.Data.access_token)||(this._isUserAuthenticated=!0)}return this._isUserAuthenticated}getCurrentAuthToken(){return this.api.authResponse!=null?this.api.authResponse.Data.access_token:null}getUserProfile(){return this.api.authResponse!=null?this.api.authResponse.Data.UserProfile:null}signOutCurrentUser(){localStorage.removeItem("authResponse"),this.api.authResponse=null,this._isUserAuthenticated=!1}submitComment(P){if(this.enableSubmissionQueue)this.submissionQueue.add(Du.Comment,P),this.submissionQueue.processNextQueueItem();else return this.api.performSubmission(Du.Comment,P)}submitMediaItem(P){if(this.enableSubmissionQueue)this.submissionQueue.add(Du.Media,P),this.submissionQueue.processNextQueueItem();else return this.api.performSubmission(Du.Media,P)}submitPOI(P){if(this.enableSubmissionQueue)this.submissionQueue.add(Du.POI,P),this.submissionQueue.processNextQueueItem();else return this.api.performSubmission(Du.POI,P)}showToastNotification(P){return On(this,null,function*(){yield(yield this.toastController.create({message:P,duration:3e3})).present()})}showLoadingProgress(P){return On(this,null,function*(){yield(yield this.loadingController.create({message:P})).present()})}dismissLoadingProgress(){return On(this,null,function*(){return this.loadingController.dismiss()})}launchOCMWebPage(P){this.isUserAuthenticated(!0)&&(P.indexOf("?")===-1&&(P+="?"),P+="&auth="+this.getCurrentAuthToken()),P="https://openchargemap.org/site"+P,window.open(P,"_system")}launchWebPage(P){window.open(P,"_system")}isPlatform(P){return this.platform.is(P)}static \u0275fac=function(Y){return new(Y||oe)(ur(Xl),ur(Zc),ur(ig),ur(dw),ur(G_),ur(vm),ur(Sm),ur(ym),ur(lw),ur(gm),ur(G0),ur(Yo),ur(U0))};static \u0275prov=rs({token:oe,factory:oe.\u0275fac,providedIn:"root"})}return oe})();function OT(oe,Ht){if(oe&1&&($e(0,"ion-select-option",13),At(1),it()),oe&2){let P=Ht.$implicit;ai("value",P.ID),ot(),Qn(P.Title)}}function FT(oe,Ht){if(oe&1&&($e(0,"ion-select-option",16),At(1),it()),oe&2){let P=Ht.$implicit,Y=Ht.index;ai("value",Y),ot(),Qn(P.Title)}}function BT(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-item")(1,"ion-label",2),At(2,"Journey Stage"),it(),$e(3,"ion-select",3),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.selectedStageIndex,O)||(t.selectedStageIndex=O),Ji(O)}),$e(4,"ion-select-option",14),At(5,"Create a Journey Stage"),it(),_n(6,FT,2,2,"ion-select-option",15),it()()}if(oe&2){let P=Wt();ot(3),er("ngModel",P.selectedStageIndex),ot(3),ai("ngForOf",P.journeyManager.getJourneyStages(P.selectedJourneyID))}}function NT(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-item")(1,"ion-label",2),At(2,"New Journey Name"),it(),$e(3,"ion-input",7),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.newJourneyName,O)||(t.newJourneyName=O),Ji(O)}),it()()}if(oe&2){let P=Wt();ot(3),er("ngModel",P.newJourneyName)}}var fw=(()=>{class oe{appManager;navParams;journeyManager;modalController;selectedJourneyID;selectedStageIndex;newJourneyName;waypoint;poi;constructor(P,Y,O,t){this.appManager=P,this.navParams=Y,this.journeyManager=O,this.modalController=t,this.poi=this.navParams.get("poi"),this.waypoint=new kf,this.waypoint.Title=this.poi.AddressInfo.Title,this.waypoint.PoiIDs=[this.poi.ID],this.waypoint.PoiList=[];let at=new s_("charging",1);at.Poi=this.poi,at.PoiID=this.poi.ID,this.waypoint.PoiList.push(at),this.newJourneyName="Trip to "+this.poi.AddressInfo.Title}cancel(){this.modalController.dismiss()}add(){if(this.selectedJourneyID!=null&&this.selectedJourneyID!=="")this.journeyManager.addJourneyWaypoint(this.selectedJourneyID,this.selectedStageIndex,this.waypoint);else{let P=new bm;P.ID=Date.now().toString(),this.newJourneyName===""&&(this.newJourneyName="New Journey"),P.Title=this.newJourneyName,this.journeyManager.addJourney(P,this.waypoint)}this.journeyManager.saveJourneys(),this.modalController.dismiss()}static \u0275fac=function(Y){return new(Y||oe)(Mn(ru),Mn(q_),Mn(Sm),Mn(iu))};static \u0275cmp=$s({type:oe,selectors:[["ng-component"]],standalone:!1,decls:39,vars:8,consts:[[1,"journeys-page","ion-padding"],[1,"banner"],["position","stacked"],[3,"ngModelChange","ngModel"],["value","","checked",""],[3,"value",4,"ngFor","ngForOf"],[4,"ngIf"],["type","text",3,"ngModelChange","ngModel"],["slot","secondary"],[3,"click"],["name","close","slot","start"],["slot","primary"],["name","add","slot","end"],[3,"value"],["value",""],["checked","",3,"value",4,"ngFor","ngForOf"],["checked","",3,"value"]],template:function(Y,O){Y&1&&($e(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),At(3," Edit Favourite "),it()()(),$e(4,"ion-content",0)(5,"div",1)(6,"h1"),At(7),it(),$e(8,"p"),At(9),it()(),$e(10,"p"),At(11," Add Charging Location as a Journey Waypoint "),it(),$e(12,"ion-item")(13,"ion-label",2),At(14,"Add to a Journey"),it(),$e(15,"ion-select",3),tr("ngModelChange",function(at){return Yn(O.selectedJourneyID,at)||(O.selectedJourneyID=at),at}),$e(16,"ion-select-option",4),At(17,"Create a New Journey"),it(),_n(18,OT,2,2,"ion-select-option",5),it()(),_n(19,BT,7,2,"ion-item",6)(20,NT,4,1,"ion-item",6),$e(21,"ion-item")(22,"ion-label",2),At(23,"Name for this step of your journey"),it(),$e(24,"ion-input",7),tr("ngModelChange",function(at){return Yn(O.waypoint.Title,at)||(O.waypoint.Title=at),at}),it()(),$e(25,"ion-item")(26,"ion-label",2),At(27,"Other Notes"),it(),$e(28,"ion-textarea",3),tr("ngModelChange",function(at){return Yn(O.waypoint.Notes,at)||(O.waypoint.Notes=at),at}),it()()(),$e(29,"ion-footer")(30,"ion-toolbar")(31,"ion-buttons",8)(32,"ion-button",9),In("click",function(){return O.cancel()}),rn(33,"ion-icon",10),At(34," Cancel "),it()(),$e(35,"ion-buttons",11)(36,"ion-button",9),In("click",function(){return O.add()}),At(37," Add "),rn(38,"ion-icon",12),it()()()()),Y&2&&(ot(7),Qn(O.poi.AddressInfo.Title),ot(2),Qn(O.poi.AddressInfo.AddressLine1),ot(6),er("ngModel",O.selectedJourneyID),ot(3),ai("ngForOf",O.journeyManager.journeys),ot(),ai("ngIf",O.selectedJourneyID),ot(),ai("ngIf",!O.selectedJourneyID),ot(4),er("ngModel",O.waypoint.Title),ot(4),er("ngModel",O.waypoint.Notes))},dependencies:[Hl,Ga,Kl,Yl,ma,Vc,yd,xd,vd,_a,tu,Za,Jl,of,sf,ow,bd,jc,eu,Nc],encapsulation:2})}return oe})();function VT(oe,Ht){if(oe&1){let P=wr();Oo(0),$e(1,"p",13),At(2," Sign in using your Open Charge Map account. "),it(),$e(3,"ion-list")(4,"ion-item")(5,"ion-input",14),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.email,O)||(t.email=O),Ji(O)}),it()(),$e(6,"ion-item")(7,"ion-input",15),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.password,O)||(t.password=O),Ji(O)}),it()()(),$e(8,"p")(9,"a",8),In("click",function(){Yi(P);let O=Wt();return Ji(O.appManager.launchWebPage("https://openchargemap.org/site/loginprovider/passwordreset"))}),At(10,"Reset your password"),it()(),Fo()}if(oe&2){let P=Wt();ot(5),er("ngModel",P.email),ot(2),er("ngModel",P.password)}}function UT(oe,Ht){if(oe&1){let P=wr();Oo(0),$e(1,"p",13),At(2," Create a new Open Charge Map account. "),it(),$e(3,"ion-list")(4,"ion-item")(5,"ion-label",16),At(6,"Email"),it(),$e(7,"ion-input",17),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.email,O)||(t.email=O),Ji(O)}),it()(),$e(8,"ion-item")(9,"ion-label",16),At(10,"Display Name or Nickname"),it(),$e(11,"ion-input",17),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.username,O)||(t.username=O),Ji(O)}),it()(),$e(12,"ion-item")(13,"ion-label",16),At(14,"Password"),it(),$e(15,"ion-input",18),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.password,O)||(t.password=O),Ji(O)}),it()(),$e(16,"ion-item")(17,"ion-label",16),At(18,"Confirm Password"),it(),$e(19,"ion-input",18),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.confirmpassword,O)||(t.confirmpassword=O),Ji(O)}),it()()(),Fo()}if(oe&2){let P=Wt();ot(7),er("ngModel",P.email),ot(4),er("ngModel",P.username),ot(4),er("ngModel",P.password),ot(4),er("ngModel",P.confirmpassword)}}var Z0=(()=>{class oe{appManager;modalController;translate;alertController;loadingController;logging;router;location;email;password;username;confirmpassword;mode="signin";constructor(P,Y,O,t,at,yi,Cn,_r){this.appManager=P,this.modalController=Y,this.translate=O,this.alertController=t,this.loadingController=at,this.logging=yi,this.router=Cn,this.location=_r,this.email=""}cancelSignIn(){this.modalController.dismiss()}performRegister(){return On(this,null,function*(){if(this.password!=this.confirmpassword){alert("Your password and the confirmed password do not match, please try again.");return}if(this.password.length<6){alert("Your password should be at least 6 characters.");return}let P=yield this.loadingController.create({message:"Registering .."});yield P.present();let Y=!1;try{let O=yield this.appManager.api.performRegister(this.username,this.email,this.password);P.dismiss(),localStorage.setItem("authResponse",JSON.stringify(this.appManager.api.authResponse)),this.appManager.isUserAuthenticated(!0),this.modalController.dismiss(),this.appManager.analytics.appEvent("Profile","SignedIn")}catch(O){Y=!0,P.dismiss(),yield(yield this.alertController.create({header:"Open Charge Map",subHeader:"Email or Password not recognised",buttons:["Ok"]})).present(),this.logging.log("Error logging in:"+O)}})}performSignIn(){return On(this,null,function*(){if(this.mode=="register")return this.performRegister();let P=yield this.loadingController.create({message:"Signing In.."});yield P.present();let Y=!1;try{let O=yield this.appManager.api.performSignIn(this.email,this.password);P.dismiss(),localStorage.setItem("authResponse",JSON.stringify(this.appManager.api.authResponse)),this.appManager.isUserAuthenticated(!0),this.modalController.dismiss(),this.appManager.analytics.appEvent("Profile","SignedIn")}catch(O){Y=!0,P.dismiss(),yield(yield this.alertController.create({header:"Open Charge Map",subHeader:"Email or Password not recognised",buttons:["Ok"]})).present(),this.logging.log("Error logging in:"+O)}})}static \u0275fac=function(Y){return new(Y||oe)(Mn(ru),Mn(iu),Mn(ym),Mn(N0),Mn(gm),Mn(Yo),Mn(j_),Mn(Gb))};static \u0275cmp=$s({type:oe,selectors:[["ng-component"]],standalone:!1,decls:28,vars:9,consts:[[1,"signin-page","ion-padding"],["item-left",""],["src","assets/images/icons/branding/AppIcon_128x128.png"],[3,"ngModelChange","ngModel"],["value","signin"],["value","register"],[4,"ngIf"],["slot","secondary"],[3,"click"],["name","close","slot","start"],["slot","primary"],["type","submit","color","primary",3,"click"],["name","log-in","slot","start"],[1,"ion-padding"],["label","Email","label-placement","floating","type","text",3,"ngModelChange","ngModel"],["label","Password","label-placement","floating","type","password",3,"ngModelChange","ngModel"],["position","floating"],["type","text",3,"ngModelChange","ngModel"],["type","password",3,"ngModelChange","ngModel"]],template:function(Y,O){Y&1&&($e(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),At(3),na(4,"translate"),it()()(),$e(5,"ion-content",0)(6,"ion-avatar",1),rn(7,"img",2),it(),$e(8,"ion-segment",3),tr("ngModelChange",function(at){return Yn(O.mode,at)||(O.mode=at),at}),$e(9,"ion-segment-button",4)(10,"ion-label"),At(11,"Sign In"),it()(),$e(12,"ion-segment-button",5)(13,"ion-label"),At(14,"Create Account"),it()()(),_n(15,VT,11,2,"ng-container",6)(16,UT,20,4,"ng-container",6),it(),$e(17,"ion-footer")(18,"ion-toolbar")(19,"ion-buttons",7)(20,"ion-button",8),In("click",function(){return O.cancelSignIn()}),rn(21,"ion-icon",9),At(22," Cancel"),it()(),$e(23,"ion-buttons",10)(24,"ion-button",11),In("click",function(){return O.performSignIn()}),rn(25,"ion-icon",12),At(26),na(27,"translate"),it()()()()),Y&2&&(ot(3),qn(" ",Sl(4,5,"ocm.general.signIn")," "),ot(5),er("ngModel",O.mode),ot(7),ai("ngIf",O.mode=="signin"),ot(),ai("ngIf",O.mode=="register"),ot(10),qn(" ",Sl(27,7,"ocm.general.signIn")))},dependencies:[Ga,Kl,Yl,_m,ma,Vc,yd,xd,vd,_a,tu,Za,Jl,Uc,Y_,J_,bd,jc,eu,Nc,Q_],encapsulation:2})}return oe})();var ol=(()=>{class oe{static isFeatureEnabled(P){return!!Il.enabledFeatures.find(Y=>Y===P)}static getClientHeight(){let P=document.body,Y=document.documentElement;return Math.max(P.scrollHeight,P.offsetHeight,Y.clientHeight,Y.scrollHeight,Y.offsetHeight)}static getClientWidth(){let P=document.body,Y=document.documentElement;return Math.max(P.scrollWidth,P.offsetWidth,Y.clientWidth,Y.scrollWidth,Y.offsetWidth)}static getMaxLevelOfPOI(P){let Y=0;if(P.StatusTypeID==150)return 0;if(P.Connections!=null)for(let O=0;O<P.Connections.length;O++)P.Connections[O].Level!=null&&P.Connections[O].Level.ID>Y&&(Y=P.Connections[O].Level.ID);return Y===4&&(Y=2),Y>4&&(Y=3),Y}static getIconForPOI(P){let O="assets/images/icons/map/level"+oe.getMaxLevelOfPOI(P);return P.UsageType!=null&&P.UsageType.Title.indexOf("Private")>-1?O+="_private":P.StatusType!=null&&P.StatusType.IsOperational!==!0?O+="_nonoperational":O+="_operational",O+="_icon.png",O}static getColorForPOI(P){let Y=oe.getMaxLevelOfPOI(P),O="#c0c0c0";return P.UsageType!=null&&P.UsageType.Title.indexOf("Private")>-1?O="#FF0000":P.StatusType!=null&&P.StatusType.IsOperational!==!0?O="#a0a0a0":Y==2?O="#72EB0D":Y==3&&(O="#EB800D"),O}static getIconForConnector(P){let Y="assets/images/icons/connectors/";return P===1?Y+="Type1_J1772.svg":P===2?Y+="Chademo_type4.svg":P===25?Y+="Type2_socket.svg":P===32?Y+="Type1_CCS.svg":P===33?Y+="Type2_CCS.svg":P===1036?Y+="Type2_tethered.svg":P===26?Y+="Type3c.svg":P===28?Y+="schuko.svg":Y+="Unknown.svg",Y}static getFormattedDistance(P){return P&&P.AddressInfo&&P.AddressInfo.Distance?P.AddressInfo.Distance.toFixed(1)+" "+(P.AddressInfo.DistanceUnit===1?"km":"miles"):""}static fixJSONDate(P){if(P==null)return null;if(P.indexOf("/")==0){let O=/Date\(([^)]+)\)/.exec(P);P=new Date(parseFloat(O[1]))}else P=new Date(P);return P}static formatMapLinkFromPosition(P,Y,O,t,at){return'<a href="https://maps.google.com/maps?saddr='+Y+","+O+"&daddr="+P.AddressInfo.Latitude+","+P.AddressInfo.Longitude+'">Map ('+Math.ceil(t)+" "+at+")</a>"}static formatSystemWebLink(P,Y){return`<a href='#' onclick="window.open('`+P+`', '_system');return false;">`+Y+"</a>"}static formatMapLink(P,Y,O){return O?device&&device.platform=="WinCE"?this.formatSystemWebLink("maps:"+P.AddressInfo.Latitude+","+P.AddressInfo.Longitude,Y):device&&device.platform==="iOS"?this.formatSystemWebLink("https://maps.apple.com/?q="+P.AddressInfo.Latitude+","+P.AddressInfo.Longitude,Y):this.formatSystemWebLink("https://maps.google.com/maps?q="+P.AddressInfo.Latitude+","+P.AddressInfo.Longitude,Y):'<a target="_blank"  href="https://maps.google.com/maps?q='+P.AddressInfo.Latitude+","+P.AddressInfo.Longitude+'">'+Y+"</a>"}static formatURL(P,Y=null){return P==null||P==""?"":(P.indexOf("http")==-1&&(P="https://"+P),'<a target="_blank" href="'+P+'">'+(Y??P)+"</a>")}static formatPOIAddress=function(P,Y=!0){let O="";return Y?O=""+this.formatTextField(P.AddressInfo.AddressLine1)+this.formatTextField(P.AddressInfo.AddressLine2)+this.formatTextField(P.AddressInfo.Town)+this.formatTextField(P.AddressInfo.StateOrProvince)+this.formatTextField(P.AddressInfo.Postcode)+(P.AddressInfo.Country!=null?this.formatTextField(P.AddressInfo.Country.Title):""):O=this.formatStringArray([P.AddressInfo.AddressLine1,P.AddressInfo.AddressLine2,P.AddressInfo.Town,P.AddressInfo.StateOrProvince,P.AddressInfo.Postcode,P.AddressInfo.Country!=null?P.AddressInfo.Country.Title:""]),O};static formatStringArray=function(P,Y=", "){if(P==null)return"";let O="";for(let t=0;t<P.length;t++)P[t]!=null&&P[t].trim()!=""&&(t==P.length-1?O+=P[t]:O+=P[t]+Y);return O};static formatString(P){return P==null?"":P.toString()}static formatTextField(P,Y=null,O=!1,t=!1,at=null){if(P==null||P==""||P==null)return"";let yi=(Y!=null?"<strong class='ocm-label' "+(at!=null?"data-localize='"+at+"' ":"")+">"+Y+"</strong>: ":"")+(O?"<br/>":"")+P.toString().replace(`
`,"<br/>")+"<br/>";return t==!0&&(yi="<p>"+yi+"</p>"),yi}static formatEmailAddress(P){return P!=null&&P!=null&&P!=""?`<i class='fa fa-envelope fa-fw'></i> <a href="mailto:`+P+'">'+P+"</a><br/>":""}static formatPhone(P,Y=null){return P!=null&&P!=null&&P!=""?(Y==null?Y="<i class='fa fa-phone fa-fw '></i> ":Y+=": ",Y+'<a href="tel:'+P+'">'+P+"</a><br/>"):""}static formatPOIDetails(P,Y){let O=864e5,t=new Date;Y==null&&(Y=!1);let at=this.formatPOIAddress(P,!1),yi="";yi+=this.formatPhone(P.AddressInfo.ContactTelephone1),yi+=this.formatPhone(P.AddressInfo.ContactTelephone2),yi+=this.formatEmailAddress(P.AddressInfo.ContactEmail);let Cn="";if(P.AddressInfo.Distance!=null){let vn="https://maps.google.com/maps?saddr=&daddr="+P.AddressInfo.Latitude+","+P.AddressInfo.Longitude;Cn+="<strong id='addr_distance'><span data-localize='details.approxDistance'>Distance</span>: "+P.AddressInfo.Distance.toFixed(1)+" "+(P.AddressInfo.DistanceUnit==2?"Miles":"KM")+"</strong>",Cn+="<p>"+this.formatSystemWebLink(vn,"Get Directions")+"</p>"}if(P.AddressInfo.RelatedURL!=null&&P.AddressInfo.RelatedURL!=""){let vn=P.AddressInfo.RelatedURL;vn=vn.replace(/.*?:\/\//g,""),vn.length>40&&(vn=vn.substr(0,40)+".."),yi+="<i class='fa fa-fw fa-external-link'></i>  "+this.formatSystemWebLink(P.AddressInfo.RelatedURL,"<span data-localize='details.addressRelatedURL'>"+vn+"</span>")}yi+="</p>";let _r=this.formatTextField(P.GeneralComments,null,!1,!0)+this.formatTextField(P.AddressInfo.AccessComments,"Access",!0,!0,"details.accessComments"),an="";P.NumberOfPoints!=null&&(an+=this.formatTextField(P.NumberOfPoints,"Bays",!1,!0,"details.numberOfPoints")),P.UsageType!=null&&(an+=this.formatTextField(P.UsageType.Title,"Usage",!1,!0,"details.usageType")),P.UsageCost!=null&&(an+=this.formatTextField(P.UsageCost,"Usage Cost",!1,!0,"details.usageCost")),P.OperatorInfo!=null&&P.OperatorInfo.ID!=1&&(an+=this.formatTextField(P.OperatorInfo.Title,"Operator",!1,!0,"details.operatorTitle"),P.OperatorInfo.WebsiteURL!=null&&(an+=this.formatTextField(this.formatURL(P.OperatorInfo.WebsiteURL),"Operator Website",!0,!0,"details.operatorWebsite")));let Dt="";if(P.StatusType!=null&&(Dt+=this.formatTextField(P.StatusType.Title,"Status",!1,!0,"details.operationalStatus"),P.DateLastStatusUpdate!=null&&(Dt+=this.formatTextField(Math.round((t-this.fixJSONDate(P.DateLastStatusUpdate))/O)+" days ago","Last Updated",!1,!0,"details.lastUpdated"))),P.Connections!=null&&P.Connections.length>0){Dt+="<table class='table table-striped'>",Dt+="<tr><th data-localize='details.equipment.connectionType'>Connection</th><th data-localize='details.equipment.powerLevel'>Power Level</th><th data-localize='details.operationalStatus'>Status</th></tr>";for(let vn=0;vn<P.Connections.length;vn++){let gn=P.Connections[vn];gn.Amps==""&&(gn.Amps=null),gn.Voltage==""&&(gn.Voltage=null),gn.Quantity==""&&(gn.Quantity=null),gn.PowerKW==""&&(gn.PowerKW=null),Dt+="<tr><td>"+(gn.ConnectionType!=null?gn.ConnectionType.Title:"")+"</td><td>"+(gn.Level!=null?"<strong>"+gn.Level.Title+"</strong><br/>":"")+(gn.Amps!=null?this.formatString(gn.Amps)+"A/ ":"")+(gn.Voltage!=null?this.formatString(gn.Voltage)+"V/ ":"")+(gn.PowerKW!=null?this.formatString(gn.PowerKW)+"kW <br/>":"")+(gn.CurrentType!=null?gn.CurrentType.Title:"")+"<br/>"+(gn.Quantity!=null?this.formatString(gn.Quantity):"1")+" Present</td><td>"+(gn.StatusType!=null?gn.StatusType.Title:"-")+"</td></tr>"}Dt+="</table>"}let Wi="";return Wi+=this.formatTextField("<a target='_blank' href='https://openchargemap.org/site/poi/details/"+P.ID+"'>OCM-"+P.ID+"</a>","OpenChargeMap Ref",!1,!0,"details.refNumber"),P.DataProvider!=null&&(Wi+=this.formatTextField(P.DataProvider.Title,"Data Provider",!1,!0,"details.dataProviderTitle"),P.DataProvider.WebsiteURL!=null&&(Wi+=this.formatTextField(this.formatURL(P.DataProvider.WebsiteURL),"Website",!1,!0,"details.dataProviderWebsite")),Wi+=this.formatTextField(P.AddressInfo.Latitude,"Latitude",!1,!0,null),Wi+=this.formatTextField(P.AddressInfo.Longitude,"Longitude",!1,!0,null)),{address:at,drivingInfo:Cn,contactInfo:yi,additionalInfo:_r+an+Dt,advancedInfo:Wi}}static debounce(P,Y,O){let t;return function(){let at=this,yi=arguments,Cn=function(){t=null,O||P.apply(at,yi)},_r=O&&!t;clearTimeout(t),t=setTimeout(Cn,Y),_r&&P.apply(at,yi)}}static getRandomInt(P){return Math.floor(Math.random()*Math.floor(P))}}return oe})();var Sd=function(oe){return oe[oe.GOOGLE_WEB=1]="GOOGLE_WEB",oe[oe.GOOGLE_NATIVE=2]="GOOGLE_NATIVE",oe[oe.LEAFLET=3]="LEAFLET",oe[oe.MAPBOX=4]="MAPBOX",oe[oe.MAPKIT_JS=5]="MAPKIT_JS",oe[oe.MAPTILER=6]="MAPTILER",oe[oe.MAPLIBRE=7]="MAPLIBRE",oe}(Sd||{}),rg=class{enableClustering;resultBatchID;useMarkerIcons;useMarkerAnimation;enableTrackingMapCentre;enableSearchByWatchingLocation;mapCentre;searchDistanceKM;iconSet;mapAPI;mapMoveQueryRefreshMS;requestSearchUpdate;enableSearchRadiusIndicator;mapType;minZoomLevel;onMapMoveCompleted;constructor(){this.enableClustering=!1,this.resultBatchID=-1,this.useMarkerIcons=!0,this.useMarkerAnimation=!0,this.enableTrackingMapCentre=!1,this.enableSearchByWatchingLocation=!1,this.mapCentre=null,this.mapAPI=Il.defaultMapProvider,this.mapType="ROADMAP",this.searchDistanceKM=1e3*100,this.mapMoveQueryRefreshMS=300,this.enableSearchRadiusIndicator=!1,this.minZoomLevel=2}};var Ch=Ab(gw());var q0=(()=>{class oe{events;logging;http;mapAPIType;mapReady;providerError;mapCanvasID;map;markerList;polylinePath;_isMapAnimating=!1;searchMarker;mapTileSet;constructor(P,Y,O){this.events=P,this.logging=Y,this.http=O,this.events=P,this.mapAPIType=Sd.MAPLIBRE,this.mapReady=!1,this.markerList=new Map}initAPI(){}disposeMap(){this.map&&(this.logging.log("Disposing map",ks.INFO),this.map.remove())}getCurrentMapTileSet(P){return"https://raw.githubusercontent.com/go2garret/maps/main/src/assets/json/openStreetMap.json"}flyAroundPoint(P){if(this._isMapAnimating){this.map.rotateTo(P/100%360,{duration:0});let Y=this;requestAnimationFrame(function(O){Y.flyAroundPoint(O)})}}initMap(P,Y,O){this.mapCanvasID=P;let t=!0;if(typeof Ch.default>"u"?t=!1:t=!0,t){if(this.map==null){let an=function(Wi){return Wi*(2-Wi)},yi=document.getElementById(P);this.initAPI();var at={version:8,sources:{osm:{type:"raster",tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"&copy; OpenStreetMap Contributors",maxzoom:19}},layers:[{id:"osm",type:"raster",source:"osm"}]};this.map=new Ch.default.Map({container:P,style:at,zoom:15,attributionControl:!1}),this.map.addControl(new Ch.default.AttributionControl({compact:!0,customAttribution:["Open Charge Map Contributors"]})),this.map.addControl(new Ch.default.NavigationControl),this.mapReady=!0,this.map.getCanvas().focus();let Cn=100,_r=25;this.map.getCanvas().addEventListener("keydown",Wi=>{Wi.preventDefault(),Wi.which===38?this.map.panBy([0,-Cn],{easing:an}):Wi.which===40?this.map.panBy([0,Cn],{easing:an}):Wi.which===37?this.map.easeTo({bearing:this.map.getBearing()-_r,easing:an}):Wi.which===39?this.map.easeTo({bearing:this.map.getBearing()+_r,easing:an}):Wi.which===32&&(this._isMapAnimating?this._isMapAnimating=!1:(this._isMapAnimating=!0,this.flyAroundPoint(0)))},!0),this.map.on("load",()=>{this.events.publish("ocm:mapping:ready")});let Dt=ol.debounce(()=>{this.getMapCenter().subscribe(Wi=>{this.searchMarker.setLngLat(new Ch.default.LngLat(Wi.coords.longitude,Wi.coords.latitude))})},500,!1);this.map.on("move",()=>{this.searchMarker&&Dt()}),this.map.on("moveend",()=>{this.events.publish("ocm:mapping:dragend"),Y.onMapMoveCompleted&&Y.onMapMoveCompleted()}),this.map.on("zoomend",()=>{this.events.publish("ocm:mapping:zoom")})}}else return this.logging.log("Call to initMap before API is ready:"+Sd[this.mapAPIType],ks.ERROR),this.mapReady=!1,!1}clearMarkers(){this.markerList!=null&&this.markerList.forEach((P,Y)=>{P.remove()}),this.markerList=new Map}showPOIListOnMap(P,Y,O=!0){let t=!1,at=this.map,yi=new Ch.default.LngLatBounds,Cn=0,_r=this;t&&this.clearMarkers();let an=at.getZoom();if(P!=null){let Wi=P.length;for(let on=0;on<P.length;on++)if(P[on].AddressInfo!=null&&P[on].AddressInfo.Latitude!=null&&P[on].AddressInfo.Longitude!=null){let vn=P[on],gn=!0;if(!t&&this.markerList!=null&&this.markerList.has(vn.ID)){gn=!1;let vr=this.markerList.get(vn.ID);vr&&vr.poi&&vr.poi.DateLastStatusUpdate!=vn.DateLastStatusUpdate&&(vr.remove(),gn=!0)}if(gn){let vr=null,Bo=null;O?(vr=document.createElement("img"),vr.src=ol.getIconForPOI(vn),vr.width=34,vr.height=50):(vr=null,Bo=ol.getColorForPOI(vn));let qo={element:vr,color:Bo,anchor:"bottom"},to=(O?"OCM-":"EXT-")+vn.ID+": "+vn.AddressInfo.Title+":";vn.UsageType!=null&&(to+=" "+vn.UsageType.Title),vn.StatusType!=null&&(to+=" "+vn.StatusType.Title);let Br=new Ch.default.Marker(qo).setLngLat([vn.AddressInfo.Longitude,vn.AddressInfo.Latitude]).addTo(at);Br.poi=vn;let os=Br.getElement();os.poi=vn,os.addEventListener("click",ga=>{let Aa=ga.currentTarget.poi;this.events.publish("ocm:poi:selected",{poiId:Aa.ID,poi:Aa})}),yi.extend(Br.getLngLat()),this.markerList.set(vn.ID,Br),Cn++}}this.logging.log(Cn+" new map markers added out of a total "+this.markerList.size)}let Dt=this;if(P!=null&&P.length>0)if(Y!=null&&!Y.appConfig.enableLiveMapQuerying){this.logging.log("Fitting to marker bounds:"+yi),at.setCenter(yi.getCenter()),this.logging.log("zoom before fit bounds:"+at.getZoom()),at.fitBounds(yi);let Wi=at.getZoom();at.setZoom(Wi<6?6:Wi)}else at.getCenter()==null&&at.setCenter(yi.getCenter())}refreshMapLayout(){this.map!=null&&setTimeout(()=>{this.logging.log("maplibreGL: refreshMapLayout",ks.VERBOSE),this.map.resize()},200)}setMapCenter(P){this.mapReady&&(this.map.setCenter(new Ch.default.LngLat(P.coords.longitude,P.coords.latitude)),this.searchMarker||(this.searchMarker=new Ch.default.Marker({color:"#99ccff",anchor:"bottom"}).setLngLat(new Ch.default.LngLat(P.coords.longitude,P.coords.latitude)).addTo(this.map),this.searchMarker.getElement().addEventListener("click",()=>{let Y=this.searchMarker.getLngLat();this.events.publish("ocm:mapping:addpoi",new Is(Y.lat,Y.lng))})))}getMapCenter(){return new fm(Y=>{if(this.map!=null){let O=this.map.getCenter();O!=null&&(Y.next(new wd(O.lat,O.lng)),Y.complete())}})}setMapZoom(P){this.map.setZoom(P)}getMapZoom(){return new fm(Y=>{let O=this.map.getZoom();Y.next(O),Y.complete()})}setMapType(P){this.map.setStyle(this.getCurrentMapTileSet(P))}getMapBounds(){return new fm(Y=>{let O=new Array,t=this.map.getBounds();O.push(new Is(t.getSouthWest().lat,t.getSouthWest().lng)),O.push(new Is(t.getNorthEast().lat,t.getNorthEast().lng)),Y.next(O),Y.complete()})}moveToMapBounds(P){this.map.fitBounds(new Ch.default.LngLatBounds(new Ch.default.LngLat(P.southWest.longitude,P.southWest.latitude),new Ch.default.LngLat(P.northEast.longitude,P.northEast.latitude)))}renderMap(P,Y,O){return document.getElementById(this.mapCanvasID).style.height=Y+"px",this.mapReady&&this.showPOIListOnMap(P,O),!0}renderPolyline(P){this.clearPolyline()}clearPolyline(){this.polylinePath!=null&&this.polylinePath.setMap(null)}focusMap(){}unfocusMap(){}placeSearch(P,Y,O){return On(this,null,function*(){let t=`https://api.maplibre.com/geocoding/v5/maplibre.places/${P||O+","+Y}.json?access_token=${Il.mapBoxToken}`;return new Promise((at,yi)=>On(this,null,function*(){this.http.get(t).toPromise().then(Cn=>{let _r=[];_r=[],Cn.features&&Cn.features.map(an=>{let Dt=new Mp;Dt.Title=an.place_name,Dt.Address=an.place_name,Dt.Type="place",Dt.Location=new Is(an.center[1],an.center[0]),Dt.Attribution=Cn.attribution,_r.push(Dt)}),at(_r)})}))})}addPOILayer(P){this.logging.log("Add POI Layer not implemented in this provider."),this.showPOIListOnMap(P,null,!1)}static \u0275fac=function(Y){return new(Y||oe)(ur(Zc),ur(Yo),ur(Xl))};static \u0275prov=rs({token:oe,factory:oe.\u0275fac})}return oe})();var og=(()=>{class oe{logging;http;map;mapCentreMarker;mapsInitialised;mapAPIReady;mapOptions;searchMarker;errorMessage;parentAppContext;mapProvider;debouncedMapPositionUpdate;events;isFocused=!1;constructor(P,Y,O){this.logging=Y,this.http=O,this.events=P,this.mapOptions=new rg,this.mapAPIReady=!1,this.mapsInitialised=!1,this.setMapAPI(this.mapOptions.mapAPI);let t=this;this.debouncedMapPositionUpdate=ol.debounce(()=>{this.logging.log("signaling map position change:"),t.mapProvider.mapReady&&t.getMapCenter().subscribe(at=>{at!=null?(this.logging.log("Map centre/zoom changed, updating search position:"+at),this.updateMapCentrePos(at.coords.latitude,at.coords.longitude,!1)):this.logging.log("Map centre/zoom changed - map not ready to change centre pos:")})},300,!1)}setParentAppContext(P){this.parentAppContext=P}setMapAPI(P){this.mapOptions.mapAPI=P,this.mapOptions.mapAPI==Sd.MAPLIBRE&&(this.mapProvider=new q0(this.events,this.logging,this.http))}isMapReady(){return this.mapProvider!=null?this.mapProvider.mapReady:!1}externalAPILoaded(P){this.mapAPIReady=!0,this.logging.log("Mapping API Loaded: "+Sd[P])}initMap(P){if(!this.isMapReady())if(this.mapProvider!=null)this.mapsInitialised&&this.logging.log("initMap: Map provider already initialised"),this.logging.log("Mapping Manager: Init "+Sd[this.mapProvider.mapAPIType]),this.mapProvider.initMap(P,this.mapOptions,this);else if(this.mapsInitialised){this.logging.log("initMap: map already initialised");return}else this.logging.log("initMap: "+this.mapOptions.mapAPI)}mapManipulationPerformed(P){this.logging.log("map manipulated:"+P);let Y=this;(P=="drag"||P=="zoom")&&this.debouncedMapPositionUpdate()}updateMapSize(){this.mapProvider&&this.mapProvider.refreshMapLayout()}updateMapCentrePos(P,Y,O,t){O&&this.mapProvider!=null&&this.mapProvider.setMapCenter(new wd(P,Y),t),this.mapOptions.mapCentre=new wd(P,Y)}moveToMapBounds(P){this.mapProvider.moveToMapBounds(P)}refreshMapView(P,Y,O){return this.mapProvider!=null?(this.logging.log("Mapping Manager: renderMap "+Sd[this.mapProvider.mapAPIType]),this.isMapReady()?this.mapProvider.renderMap(Y,P,this.parentAppContext):this.logging.log("refreshMapView: map provider not initialised..")):this.logging.log("Unsupported Map API: refreshMapView",ks.ERROR),!0}setMapType(P){this.mapOptions.mapType!=P&&(this.mapOptions.mapType=P,this.isMapReady()&&this.mapProvider!=null?(this.logging.log("Changing map type:"+P),this.mapProvider.setMapType(P)):this.logging.log("Map type set, maps not initialised yet."))}unfocusMap(){this.logging.log("[mapping] Unfocus Map."),this.isFocused=!1,this.mapProvider.unfocusMap()}focusMap(){this.logging.log("[mapping] Focus Map."),this.isFocused=!0,this.mapProvider.focusMap()}getMapBounds(){return this.mapProvider.getMapBounds()}getMapZoom(){return this.mapProvider.getMapZoom()}setMapZoom(P){this.mapProvider.setMapZoom(P)}getMapCenter(){return this.mapProvider.getMapCenter()}showPOIOnStaticMap(P,Y,O=!1,t=!1,at=200,yi=200){let Cn=document.getElementById(P);if(Cn!=null){let _r=Y.AddressInfo.Title,an=Y.AddressInfo.Latitude,Dt=Y.AddressInfo.Longitude;at>640&&(at=640),yi>640&&(yi=640);let Wi=at,on=yi,vn="https://maps.googleapis.com/maps/api/staticmap?center="+an+","+Dt+"&zoom=14&size="+Wi+"x"+on+"&maptype=roadmap&markers=color:blue%7Clabel:A%7C"+an+","+Dt+"&sensor=false",gn="";O==!0?gn+="<div>"+ol.formatMapLink(Y,'<div><img width="'+Wi+'" height="'+on+'" src="'+vn+'" /></div>',t)+"</div>":gn+='<div><img width="'+Wi+'" height="'+on+'" src="'+vn+'" /></div>',Cn.innerHTML=gn}}renderPolyline(P){this.mapProvider.renderPolyline(P)}clearPolyline(){this.mapProvider.clearPolyline()}clearMarkers(){this.logging.log("mapping: clearing markers"),this.mapProvider.clearMarkers()}addPOILayer(P){this.mapProvider.addPOILayer(P)}static \u0275fac=function(Y){return new(Y||oe)(ur(Zc),ur(Yo),ur(Xl))};static \u0275prov=rs({token:oe,factory:oe.\u0275fac,providedIn:"root"})}return oe})();function jT(oe,Ht){if(oe&1){let P=wr();Oo(0),$e(1,"ion-note")(2,"p"),At(3," The closest address to this position is: "),it(),$e(4,"p")(5,"strong"),At(6),it(),rn(7,"br"),At(8),rn(9,"br"),$e(10,"ion-button",3),In("click",function(){Yi(P);let O=Wt();return Ji(O.useAddressSelection())}),At(11,"Use this address below "),rn(12,"ion-icon",4),it()()(),Fo()}if(oe&2){let P=Wt();ot(6),Qn(P.suggestedAddress.AddressLine1),ot(2),jb(" ",P.suggestedAddress.AddressLine2," ",P.suggestedAddress.Town," ",P.suggestedAddress.StateOrProvince," ",P.suggestedAddress.Postcode," ")}}var $0=(()=>{class oe{mapping;events;logging;http;appManager;latitude;latitudeChange=new gc;longitude;longitudeChange=new gc;suggestedAddress=null;suggestedAddressChange=new gc;onUseSuggestedAddress=new gc;suggestedAddressAttribution=null;suggestedAddressAttributionChange=new gc;originalMarkerPos;mapService;mapOptions;debouncedGecode;isMapInitialised=!1;constructor(P,Y,O,t,at){this.mapping=P,this.events=Y,this.logging=O,this.http=t,this.appManager=at}ngOnInit(){this.mapService=new q0(this.events,this.logging,this.http),this.mapService.initAPI(),this.mapOptions=new rg,this.mapOptions.mapType=this.appManager.searchSettings.MapType,this.mapOptions.onMapMoveCompleted=()=>{let P;P=this.mapService.getMapCenter(),P.subscribe(Y=>{Y&&(this.latitude=Y.coords.latitude,this.longitude=Y.coords.longitude,this.latitudeChange.emit(this.latitude),this.longitudeChange.emit(this.longitude),this.getAddressForCurrentLatLng())})}}ngAfterContentInit(){this.focusMap()}ngOnDestroy(){this.mapService.disposeMap()}focusMap(){this.isMapInitialised==!1&&this.mapService&&this.latitude!=0&&this.longitude!=0&&(this.isMapInitialised=!0,this.mapService.initMap("editor-map",this.mapOptions,null),this.mapService.setMapCenter(new wd(this.latitude,this.longitude)),this.originalMarkerPos=new Is(this.latitude,this.longitude))}ngOnChanges(P){this.focusMap()}getAddressForCurrentLatLng(){return On(this,null,function*(){this.latitude&&this.longitude&&this.appManager.api.fetchReverseGeocodeResult(this.latitude,this.longitude).then(P=>{P.AddressInfo&&(this.suggestedAddress=P.AddressInfo)})})}useAddressSelection(){this.onUseSuggestedAddress.emit({suggestedAddress:this.suggestedAddress,attribution:this.suggestedAddressAttribution}),this.suggestedAddress=null,this.suggestedAddressAttribution=null}static \u0275fac=function(Y){return new(Y||oe)(Mn(og),Mn(Zc),Mn(Yo),Mn(Xl),Mn(ru))};static \u0275cmp=$s({type:oe,selectors:[["app-poi-location-editor"]],inputs:{latitude:"latitude",longitude:"longitude"},outputs:{latitudeChange:"latitudeChange",longitudeChange:"longitudeChange",suggestedAddressChange:"suggestedAddressChange",onUseSuggestedAddress:"onUseSuggestedAddress",suggestedAddressAttributionChange:"suggestedAddressAttributionChange"},standalone:!1,features:[A0],decls:4,vars:1,consts:[[1,"instruction"],["id","editor-map"],[4,"ngIf"],["size","small",3,"click"],["slot","end","name","copy"]],template:function(Y,O){Y&1&&($e(0,"p",0),At(1,"Drag the map to center the marker on the charging location:"),it(),rn(2,"div",1),_n(3,jT,13,5,"ng-container",2)),Y&2&&(ot(3),ai("ngIf",O.suggestedAddress))},dependencies:[Ga,ma,_a,X_],styles:["#editor-map[_ngcontent-%COMP%]{border:1px solid gainsboro;background-color:gray;width:100%;height:128px}"]})}return oe})();function ZT(oe,Ht){if(oe&1&&($e(0,"ion-select-option",18),At(1),it()),oe&2){let P=Ht.$implicit;ai("value",P.ID),ot(),Qn(P.Title)}}function qT(oe,Ht){if(oe&1&&($e(0,"ion-select-option",18),At(1),it()),oe&2){let P=Ht.$implicit;ai("value",P.ID),ot(),Qn(P.Title)}}function $T(oe,Ht){if(oe&1&&($e(0,"ion-select-option",18),At(1),it()),oe&2){let P=Ht.$implicit;ai("value",P.ID),ot(),Qn(P.Title)}}var lv=(()=>{class oe{modalController;referenceDataManager;conn;useFilteredConnectionTypes=!0;useFilteredOperators=!0;constructor(P,Y){this.modalController=P,this.referenceDataManager=Y}get isAddMode(){return!(this.conn!=null&&this.conn.ID>0)}get connectionTypes(){return this.referenceDataManager.getConnectionTypes(this.useFilteredConnectionTypes)}get currentTypes(){return this.referenceDataManager.getOutputCurrentTypes()}get statusTypes(){return this.referenceDataManager.getStatusTypes().filter(P=>P.IsUserSelectable==!0)}ngOnInit(){}save(){var P=!0;this.conn.Quantity!=null&&(this.conn.Quantity<0||this.conn.Quantity>100||!Number.isInteger(this.conn.Quantity))&&(alert("Quantity must be a whole number, or leave it blank."),P=!1),P&&this.modalController.dismiss({item:this.conn})}cancel(){this.modalController.dismiss()}static \u0275fac=function(Y){return new(Y||oe)(Mn(iu),Mn(vm))};static \u0275cmp=$s({type:oe,selectors:[["app-poi-equipment-editor"]],standalone:!1,decls:42,vars:13,consts:[[1,"ion-padding"],["label","Connection Type","label-placement","floating",3,"ngModelChange","ngModel"],["value","0"],[3,"value",4,"ngFor","ngForOf"],["label","Supply Type","label-placement","floating",3,"ngModelChange","ngModel"],["label","Power (kW)","label-placement","floating","type","number",3,"ngModelChange","ngModel"],["label","Amps","label-placement","floating","type","number",3,"ngModelChange","ngModel"],["label","Voltage","label-placement","floating","type","number",3,"ngModelChange","ngModel"],["label","Status","label-placement","floating",3,"ngModelChange","ngModel"],["label","Quantity Available","label-placement","floating","type","number",3,"ngModelChange","ngModel"],["label","Comment","label-placement","floating","type","text","placeholder","(optional) other comments",3,"ngModelChange","ngModel"],["label","Operators Reference","label-placement","floating","type","text","placeholder","(optional)",3,"ngModelChange","ngModel"],["slot","start"],[3,"click"],["name","close","slot","start"],["slot","end"],["color","success",3,"click"],["name","send","slot","end"],[3,"value"]],template:function(Y,O){Y&1&&($e(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),At(3),it()()(),$e(4,"ion-content",0)(5,"p"),At(6,"Please provide as much information as you can about the equipment. If you don't know then leave the field blank. At a minimum you should include the Connection Type and approximate Power kW (max)."),it(),$e(7,"ion-item")(8,"ion-select",1),tr("ngModelChange",function(at){return Yn(O.conn.ConnectionTypeID,at)||(O.conn.ConnectionTypeID=at),at}),$e(9,"ion-select-option",2),At(10,"Unknown"),it(),_n(11,ZT,2,2,"ion-select-option",3),it()(),$e(12,"ion-item")(13,"ion-select",4),tr("ngModelChange",function(at){return Yn(O.conn.CurrentTypeID,at)||(O.conn.CurrentTypeID=at),at}),$e(14,"ion-select-option",2),At(15,"Unknown"),it(),_n(16,qT,2,2,"ion-select-option",3),it()(),$e(17,"ion-item")(18,"ion-input",5),tr("ngModelChange",function(at){return Yn(O.conn.PowerKW,at)||(O.conn.PowerKW=at),at}),it()(),$e(19,"ion-item")(20,"ion-input",6),tr("ngModelChange",function(at){return Yn(O.conn.Amps,at)||(O.conn.Amps=at),at}),it()(),$e(21,"ion-item")(22,"ion-input",7),tr("ngModelChange",function(at){return Yn(O.conn.Voltage,at)||(O.conn.Voltage=at),at}),it()(),$e(23,"ion-item")(24,"ion-select",8),tr("ngModelChange",function(at){return Yn(O.conn.StatusTypeID,at)||(O.conn.StatusTypeID=at),at}),_n(25,$T,2,2,"ion-select-option",3),it()(),$e(26,"ion-item")(27,"ion-input",9),tr("ngModelChange",function(at){return Yn(O.conn.Quantity,at)||(O.conn.Quantity=at),at}),it()(),$e(28,"ion-item")(29,"ion-input",10),tr("ngModelChange",function(at){return Yn(O.conn.Comments,at)||(O.conn.Comments=at),at}),it()(),$e(30,"ion-item")(31,"ion-input",11),tr("ngModelChange",function(at){return Yn(O.conn.Reference,at)||(O.conn.Reference=at),at}),it()()(),$e(32,"ion-footer")(33,"ion-toolbar")(34,"ion-buttons",12)(35,"ion-button",13),In("click",function(){return O.cancel()}),rn(36,"ion-icon",14),At(37," Cancel "),it()(),$e(38,"ion-buttons",15)(39,"ion-button",16),In("click",function(){return O.save()}),At(40," OK "),rn(41,"ion-icon",17),it()()()()),Y&2&&(ot(3),Qn(O.isAddMode?"Add Equipment":"Edit Equipment"),ot(5),er("ngModel",O.conn.ConnectionTypeID),ot(3),ai("ngForOf",O.connectionTypes),ot(2),er("ngModel",O.conn.CurrentTypeID),ot(3),ai("ngForOf",O.currentTypes),ot(2),er("ngModel",O.conn.PowerKW),ot(2),er("ngModel",O.conn.Amps),ot(2),er("ngModel",O.conn.Voltage),ot(2),er("ngModel",O.conn.StatusTypeID),ot(),ai("ngForOf",O.statusTypes),ot(2),er("ngModel",O.conn.Quantity),ot(2),er("ngModel",O.conn.Comments),ot(2),er("ngModel",O.conn.Reference))},dependencies:[Hl,ma,Vc,yd,xd,vd,_a,tu,Za,of,sf,bd,jc,$_,eu,Nc,Kl,Yl],encapsulation:2})}return oe})();var cv=function(oe){return oe[oe.Unknown=0]="Unknown",oe[oe.CurrentlyAvailable=10]="CurrentlyAvailable",oe[oe.CurrentlyInUse=20]="CurrentlyInUse",oe[oe.TemporarilyUnavailable=30]="TemporarilyUnavailable",oe[oe.Operational=50]="Operational",oe[oe.PartlyOperational=75]="PartlyOperational",oe[oe.NotOperational=100]="NotOperational",oe[oe.PlannedForFutureDate=150]="PlannedForFutureDate",oe[oe.RemovedDecomissioned=200]="RemovedDecomissioned",oe}(cv||{}),hv=function(oe){return oe[oe.UnknownOperator=1]="UnknownOperator",oe[oe.SiteOwner=45]="SiteOwner",oe}(hv||{});function WT(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-button",5),In("click",function(){Yi(P);let O=Wt().$implicit,t=Wt();return Ji(t.onCopyCommand(O))}),At(1,"Copy"),it()}}function HT(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-button",5),In("click",function(){Yi(P);let O=Wt().$implicit,t=Wt();return Ji(t.onEditCommand(O))}),At(1,"Edit"),it()}}function XT(oe,Ht){if(oe&1&&($e(0,"ion-item",1)(1,"ion-grid")(2,"ion-row")(3,"ion-col"),At(4),it()(),$e(5,"ion-row")(6,"ion-col",2)(7,"p"),rn(8,"img",3),it(),$e(9,"ion-note"),At(10),it(),_n(11,WT,2,0,"ion-button",4)(12,HT,2,0,"ion-button",4),it(),$e(13,"ion-col")(14,"ion-row")(15,"ion-col")(16,"p"),At(17),it(),$e(18,"ion-note"),At(19),it()()(),$e(20,"ion-row")(21,"ion-col"),At(22),it(),$e(23,"ion-col"),At(24),it()()()()()()),oe&2){let P=Ht.$implicit,Y=Wt();ot(4),qn(" ",P.AddressInfo.Title," "),ot(4),ai("src",Y.getIconForPOI(P),t_),ot(2),qn(" ",Y.getFormattedDistance(P)," "),ot(),ai("ngIf",Y.enableCopyOption),ot(),ai("ngIf",Y.enableEditOption),ot(5),qn(" ",Y.getFormattedAddress(P)," "),ot(2),qn(" ",Y.getFormattedConnectorList(P)," "),ot(3),qn(" ",P.UsageType==null?null:P.UsageType.Title," "),ot(2),qn(" ",P.OperatorInfo==null?null:P.OperatorInfo.Title," ")}}var yw=(()=>{class oe{enableCopyOption=!1;enableEditOption=!1;poiList=[];onCopy=new gc;onEdit=new gc;constructor(){}ngOnInit(){}onCopyCommand(P){this.onCopy.emit(P)}onEditCommand(P){this.onEdit.emit(P)}getFormattedAddress(P){let Y="";return P.AddressInfo.Title!=P.AddressInfo.AddressLine1?Y+=P.AddressInfo.Title:Y+=P.AddressInfo.Town,Y}getFormattedConnectorList(P){if(!P.Connections)return;let Y=[];for(let O of P.Connections)O.ConnectionType!=null&&(Y.find(t=>t==O.ConnectionType.Title)||Y.push(O.ConnectionType.Title));return Y.join(", ")}getIconForPOI(P){return ol.getIconForPOI(P)}getFormattedDistance(P){return ol.getFormattedDistance(P)}static \u0275fac=function(Y){return new(Y||oe)};static \u0275cmp=$s({type:oe,selectors:[["app-poi-list"]],inputs:{enableCopyOption:"enableCopyOption",enableEditOption:"enableEditOption",poiList:"poiList"},outputs:{onCopy:"onCopy",onEdit:"onEdit"},standalone:!1,decls:2,vars:1,consts:[["style","max-width:400px;",4,"ngFor","ngForOf"],[2,"max-width","400px"],["size","3"],[2,"width","24px",3,"src"],["size","small",3,"click",4,"ngIf"],["size","small",3,"click"]],template:function(Y,O){Y&1&&($e(0,"ion-list"),_n(1,XT,25,9,"ion-item",0),it()),Y&2&&(ot(),ai("ngForOf",O.poiList))},dependencies:[Hl,Ga,ma,W_,H_,Za,Uc,X_,K_],encapsulation:2})}return oe})();function YT(oe,Ht){if(oe&1&&($e(0,"ion-badge",7),At(1),it()),oe&2){let P=Wt().$implicit;ot(),qn("",P.Quantity," x")}}function JT(oe,Ht){if(oe&1&&($e(0,"strong"),At(1),it()),oe&2){let P=Wt().$implicit;ot(),qn("",P.PowerKW," kW ")}}function QT(oe,Ht){if(oe&1&&($e(0,"div"),At(1),it()),oe&2){let P=Wt().$implicit;ot(),qn("",P.CurrentType==null?null:P.CurrentType.Title," ")}}function eS(oe,Ht){if(oe&1&&($e(0,"span"),At(1),it()),oe&2){let P=Wt().$implicit;ot(),qn("",P.Amps,"A ")}}function tS(oe,Ht){if(oe&1&&($e(0,"span"),At(1),it()),oe&2){let P=Wt().$implicit;ot(),qn("",P.Voltage,"V ")}}function iS(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-col")(1,"ion-button",8),In("click",function(){Yi(P);let O=Wt().$implicit,t=Wt();return Ji(t.editConnection(O))}),rn(2,"ion-icon",9),it(),rn(3,"br"),$e(4,"ion-button",10),In("click",function(){Yi(P);let O=Wt().$implicit,t=Wt();return Ji(t.deleteConnection(O))}),rn(5,"ion-icon",11),it()()}}function nS(oe,Ht){if(oe&1&&($e(0,"ion-row")(1,"ion-col")(2,"ion-row")(3,"ion-col",1),rn(4,"div",2),_n(5,YT,2,1,"ion-badge",3),$e(6,"div",4),At(7),it()(),$e(8,"ion-col")(9,"ion-row")(10,"ion-col")(11,"ion-note")(12,"div")(13,"strong",5),At(14),it()(),_n(15,JT,2,1,"strong",6)(16,QT,2,1,"div",6),it(),$e(17,"ion-note"),_n(18,eS,2,1,"span",6)(19,tS,2,1,"span",6),it()()(),$e(20,"ion-row")(21,"ion-col",4),At(22),it(),$e(23,"ion-col",4),At(24),it()()(),_n(25,iS,6,0,"ion-col",6),it()()()),oe&2){let P=Ht.$implicit,Y=Wt();ot(4),R0("mask-image","url("+Y.getConnectorTypeIcon(P.ConnectionTypeID)+")"),ot(),ai("ngIf",P.Quantity),ot(2),Qn(P.StatusType==null?null:P.StatusType.Title),ot(6),ai("title",n_(P.ConnectionType==null?null:P.ConnectionType.FormalName)),ot(),qn("",P.ConnectionType==null?null:P.ConnectionType.Title," "),ot(),ai("ngIf",P.PowerKW),ot(),ai("ngIf",P.CurrentTypeID),ot(2),ai("ngIf",P.Amps),ot(),ai("ngIf",P.Voltage),ot(3),Qn(P.Reference),ot(2),Qn(P.Comments),ot(),ai("ngIf",Y.enableEdit)}}var W0=(()=>{class oe{item;enableEdit=!1;onEdit=new gc;onDelete=new gc;constructor(){}ngOnInit(){}editConnection(P){this.onEdit.emit(P)}deleteConnection(P){this.onDelete.emit(P)}getConnectorTypeIcon(P){return ol.getIconForConnector(P)}static \u0275fac=function(Y){return new(Y||oe)};static \u0275cmp=$s({type:oe,selectors:[["app-equipment-details"]],inputs:{item:"item",enableEdit:"enableEdit"},outputs:{onEdit:"onEdit",onDelete:"onDelete"},standalone:!1,decls:2,vars:1,consts:[[4,"ngFor","ngForOf"],["size","3"],[1,"connector-icon"],["color","primary",4,"ngIf"],[1,"info"],[3,"title"],[4,"ngIf"],["color","primary"],["size","small","color","secondary",3,"click"],["name","create","slot","icon-only"],["size","small","color","danger",3,"click"],["name","trash","slot","icon-only"]],template:function(Y,O){Y&1&&($e(0,"ion-grid"),_n(1,nS,26,14,"ion-row",0),it()),Y&2&&(ot(),ai("ngForOf",O.item.Connections))},dependencies:[Hl,Ga,z0,ma,W_,H_,_a,X_,K_],styles:[".connector-icon[_ngcontent-%COMP%]{-webkit-mask-size:100%;mask-size:100%;-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;-webkit-mask-position:center;mask-position:center;width:64px;height:64px;background-color:currentColor;-webkit-mask-image:none;mask-image:none}"]})}return oe})();function rS(oe,Ht){if(oe&1&&($e(0,"ion-select-option",5),At(1),it()),oe&2){let P=Ht.$implicit;ai("value",P.ID),ot(),Qn(P.Title)}}function oS(oe,Ht){oe&1&&($e(0,"ion-select-option",6),At(1,"Other..."),it())}function sS(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-item")(1,"ion-label",1),At(2,"Network Operator"),it(),$e(3,"ion-select",2),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.operatorId,O)||(t.operatorId=O),Ji(O)}),In("ionChange",function(){Yi(P);let O=Wt();return Ji(O.onOperatorChange())}),_n(4,rS,2,2,"ion-select-option",3)(5,oS,2,0,"ion-select-option",4),it()()}if(oe&2){let P=Wt();ot(3),er("ngModel",P.operatorId),ot(),ai("ngForOf",P.operators),ot(),ai("ngIf",P.useFilteredOperators)}}function aS(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-item")(1,"ion-searchbar",7),In("ionCancel",function(){Yi(P);let O=Wt();return Ji(O.cancelOperatorLookup())}),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.operatorSearchKeyword,O)||(t.operatorSearchKeyword=O),Ji(O)}),In("ionInput",function(O){Yi(P);let t=Wt();return Ji(t.searchOperators(O))}),it()()}if(oe&2){let P=Wt();ot(),er("ngModel",P.operatorSearchKeyword)}}function lS(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-item",9),In("click",function(){let O=Yi(P).$implicit,t=Wt(2);return Ji(t.onOperatorChange(O))}),$e(1,"ion-avatar",10),rn(2,"ion-icon",11),it(),$e(3,"ion-label")(4,"p"),At(5),it(),$e(6,"p"),At(7),it()()()}if(oe&2){let P=Ht.$implicit;ot(5),Qn(P.Title),ot(2),Qn(P.WebsiteURL)}}function cS(oe,Ht){if(oe&1&&(Oo(0),$e(1,"ion-list"),_n(2,lS,8,2,"ion-item",8),it(),Fo()),oe&2){let P=Wt();ot(2),ai("ngForOf",P.operatorSearchResults)}}function hS(oe,Ht){if(oe&1){let P=wr();Oo(0),$e(1,"ion-item")(2,"ion-avatar",10),rn(3,"ion-icon",12),it(),$e(4,"ion-label")(5,"p"),At(6),it(),$e(7,"p"),At(8),it(),$e(9,"ion-button",9),In("click",function(){Yi(P);let O=Wt();return Ji(O.selectedOperator=null)}),At(10,"Change"),it()()(),Fo()}if(oe&2){let P=Wt();ot(6),Qn(P.selectedOperator.Title),ot(2),Qn(P.selectedOperator.WebsiteURL)}}function uS(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-chip")(1,"ion-label"),At(2),it(),$e(3,"ion-icon",14),In("click",function(){let O=Yi(P).$implicit,t=Wt(2);return Ji(t.removeOperator(O))}),it()()}if(oe&2){let P=Ht.$implicit,Y=Wt(2);ot(2),Qn(Y.getOperatorInfo(P).Title)}}function dS(oe,Ht){if(oe&1&&(Oo(0),_n(1,uS,4,1,"ion-chip",13),Fo()),oe&2){let P=Wt();ot(),ai("ngForOf",P.operatorList)}}var vw=(()=>{class oe{referenceDataManager;changeDetector;operatorId=null;operatorList=null;mode="single";useFilteredOperators=null;operatorChanged=new gc;operatorRemoved=new gc;operatorCache=[];operatorSearchResults=[];operatorSearchKeyword="";selectedOperator=null;get operators(){return this.referenceDataManager.getNetworkOperators(this.useFilteredOperators)}constructor(P,Y){this.referenceDataManager=P,this.changeDetector=Y}ngOnInit(){this.operatorCache=this.referenceDataManager.getNetworkOperators(!1),this.operatorId!=null&&(this.selectedOperator=this.operatorCache.find(P=>P.ID==this.operatorId))}searchOperators(){this.operatorSearchResults=[],this.operatorSearchKeyword.length!=0&&(this.operatorCache?this.operatorSearchResults=this.operatorCache.filter(P=>P.Title.toLowerCase().startsWith(this.operatorSearchKeyword.toLowerCase())||P.Title.toLowerCase().startsWith("("+this.operatorSearchKeyword.toLowerCase())).slice(0,10):this.operatorSearchResults=[])}getOperatorInfo(P){if(this.operatorCache)return this.operatorCache.find(Y=>Y.ID==P)}onOperatorChange(P=null){return On(this,null,function*(){P==null&&this.operatorId&&(P=this.operatorCache.find(Y=>Y.ID==this.operatorId)),P!=null&&(this.operatorSearchResults=[],this.selectedOperator=P,this.operatorId=P.ID),this.operatorId?(this.operatorChanged.emit(this.selectedOperator),this.mode!="single"&&(this.selectedOperator=null,this.operatorSearchKeyword="")):this.useFilteredOperators=!1})}removeOperator(P){return On(this,null,function*(){this.operatorId=null,this.operatorRemoved.emit(P)})}cancelOperatorLookup(){this.selectedOperator=null}static \u0275fac=function(Y){return new(Y||oe)(Mn(vm),Mn(mm))};static \u0275cmp=$s({type:oe,selectors:[["app-operator-lookup"]],inputs:{operatorId:"operatorId",operatorList:"operatorList",mode:"mode",useFilteredOperators:"useFilteredOperators"},outputs:{operatorChanged:"operatorChanged",operatorRemoved:"operatorRemoved"},standalone:!1,decls:5,vars:5,consts:[[4,"ngIf"],["position","floating"],[3,"ngModelChange","ionChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],["value","",4,"ngIf"],[3,"value"],["value",""],["placeholder","Search network operators","showCancelButton","focus","autocomplete","on",3,"ionCancel","ngModelChange","ionInput","ngModel"],[3,"click",4,"ngFor","ngForOf"],[3,"click"],["item-left",""],["name","card"],["name","locate"],[4,"ngFor","ngForOf"],["name","close-circle",3,"click"]],template:function(Y,O){Y&1&&_n(0,sS,6,3,"ion-item",0)(1,aS,2,1,"ion-item",0)(2,cS,3,1,"ng-container",0)(3,hS,11,2,"ng-container",0)(4,dS,2,1,"ng-container",0),Y&2&&(ai("ngIf",O.useFilteredOperators&&!O.selectedOperator),ot(),ai("ngIf",!O.useFilteredOperators&&!O.selectedOperator),ot(),ai("ngIf",O.operatorSearchResults.length>0),ot(),ai("ngIf",O.selectedOperator!=null),ot(),ai("ngIf",(O.operatorList==null?null:O.operatorList.length)>0))},dependencies:[Hl,Ga,_m,ma,Yb,_a,Za,Jl,Uc,O0,of,sf,eu,Nc,Kl,Yl],encapsulation:2})}return oe})();function fS(oe,Ht){oe&1&&rn(0,"ion-icon",14)}function mS(oe,Ht){oe&1&&rn(0,"ion-icon",14)}function _S(oe,Ht){oe&1&&rn(0,"ion-icon",14)}function gS(oe,Ht){if(oe&1&&($e(0,"ion-select-option",26),At(1),it()),oe&2){let P=Ht.$implicit;ai("value",P.ID),ot(),Qn(P.Title)}}function yS(oe,Ht){if(oe&1){let P=wr();Oo(0),$e(1,"app-poi-location-editor",15,0),tr("latitudeChange",function(O){Yi(P);let t=Wt(2);return Yn(t.item.AddressInfo.Latitude,O)||(t.item.AddressInfo.Latitude=O),Ji(O)})("longitudeChange",function(O){Yi(P);let t=Wt(2);return Yn(t.item.AddressInfo.Longitude,O)||(t.item.AddressInfo.Longitude=O),Ji(O)}),In("onUseSuggestedAddress",function(O){Yi(P);let t=Wt(2);return Ji(t.useSuggestedAddress(O))}),it(),$e(3,"ion-list")(4,"ion-item")(5,"ion-input",16),tr("ngModelChange",function(O){Yi(P);let t=Wt(2);return Yn(t.item.AddressInfo.Title,O)||(t.item.AddressInfo.Title=O),Ji(O)}),it()(),$e(6,"ion-item")(7,"ion-input",17),tr("ngModelChange",function(O){Yi(P);let t=Wt(2);return Yn(t.item.AddressInfo.AddressLine1,O)||(t.item.AddressInfo.AddressLine1=O),Ji(O)}),it()(),$e(8,"ion-item")(9,"ion-input",18),tr("ngModelChange",function(O){Yi(P);let t=Wt(2);return Yn(t.item.AddressInfo.AddressLine2,O)||(t.item.AddressInfo.AddressLine2=O),Ji(O)}),it()(),$e(10,"ion-item")(11,"ion-input",19),tr("ngModelChange",function(O){Yi(P);let t=Wt(2);return Yn(t.item.AddressInfo.Town,O)||(t.item.AddressInfo.Town=O),Ji(O)}),it()(),$e(12,"ion-item")(13,"ion-input",20),tr("ngModelChange",function(O){Yi(P);let t=Wt(2);return Yn(t.item.AddressInfo.StateOrProvince,O)||(t.item.AddressInfo.StateOrProvince=O),Ji(O)}),it()(),$e(14,"ion-item")(15,"ion-input",21),tr("ngModelChange",function(O){Yi(P);let t=Wt(2);return Yn(t.item.AddressInfo.Postcode,O)||(t.item.AddressInfo.Postcode=O),Ji(O)}),it()(),$e(16,"ion-item")(17,"ion-select",22),tr("ngModelChange",function(O){Yi(P);let t=Wt(2);return Yn(t.item.AddressInfo.CountryID,O)||(t.item.AddressInfo.CountryID=O),Ji(O)}),In("ionChange",function(){Yi(P);let O=Wt(2);return Ji(O.onCountryChange())}),_n(18,gS,2,2,"ion-select-option",23),it()(),$e(19,"ion-item")(20,"ion-input",24),tr("ngModelChange",function(O){Yi(P);let t=Wt(2);return Yn(t.item.AddressInfo.Latitude,O)||(t.item.AddressInfo.Latitude=O),Ji(O)}),it()(),$e(21,"ion-item")(22,"ion-input",25),tr("ngModelChange",function(O){Yi(P);let t=Wt(2);return Yn(t.item.AddressInfo.Longitude,O)||(t.item.AddressInfo.Longitude=O),Ji(O)}),it()()(),Fo()}if(oe&2){let P=Wt(2);ot(),er("latitude",P.item.AddressInfo.Latitude)("longitude",P.item.AddressInfo.Longitude),ot(4),er("ngModel",P.item.AddressInfo.Title),ot(2),er("ngModel",P.item.AddressInfo.AddressLine1),ot(2),er("ngModel",P.item.AddressInfo.AddressLine2),ot(2),er("ngModel",P.item.AddressInfo.Town),ot(2),er("ngModel",P.item.AddressInfo.StateOrProvince),ot(2),er("ngModel",P.item.AddressInfo.Postcode),ot(2),er("ngModel",P.item.AddressInfo.CountryID),ot(),ai("ngForOf",P.countries),ot(2),er("ngModel",P.item.AddressInfo.Latitude),ot(2),er("ngModel",P.item.AddressInfo.Longitude)}}function xS(oe,Ht){if(oe&1){let P=wr();Oo(0),$e(1,"h3"),At(2,"Locations Nearby"),it(),$e(3,"p")(4,"strong"),At(5,"The following locations already exist nearby."),it()(),$e(6,"div",27)(7,"p"),At(8,"Ensure you are not adding a duplicate site unless it is for different equipment from another network operator."),it(),$e(9,"p"),At(10,"You can edit any of these listings if required instead:"),it()(),$e(11,"app-poi-list",28),In("onEdit",function(O){Yi(P);let t=Wt(2);return Ji(t.editPOI(O))}),it(),Fo()}if(oe&2){let P=Wt(2);ot(11),ai("poiList",P.nearbySites)("enableEditOption",!0)}}function vS(oe,Ht){if(oe&1&&(Oo(0),_n(1,yS,23,12,"ng-container",10)(2,xS,12,2,"ng-container",10),Fo()),oe&2){let P=Wt();ot(),ai("ngIf",P.step=="location"),ot(),ai("ngIf",P.step=="poi-nearby")}}function bS(oe,Ht){if(oe&1){let P=wr();Oo(0),$e(1,"p"),At(2,"Copied the equipment configuration from:"),it(),$e(3,"ion-item")(4,"ion-label"),At(5),rn(6,"br"),At(7),rn(8,"br"),At(9),rn(10,"br"),At(11),rn(12,"br"),At(13),it(),$e(14,"ion-button",30),In("click",function(){Yi(P);let O=Wt(5);return Ji(O.changeTemplatePOI())}),At(15,"Change.."),it()(),Fo()}if(oe&2){let P=Wt(5);ot(5),qn(" ",P.selectedTemplatePOI.AddressInfo.Title," "),ot(2),qn(" ",P.selectedTemplatePOI.AddressInfo.AddressLine1," "),ot(2),qn(" ",P.selectedTemplatePOI.Connections[0].ConnectionType==null?null:P.selectedTemplatePOI.Connections[0].ConnectionType.Title," "),ot(2),qn(" ",P.selectedTemplatePOI.Connections[0].PowerKW," "),ot(2),qn(" ",P.selectedTemplatePOI.DateCreated," ")}}function wS(oe,Ht){if(oe&1){let P=wr();Oo(0),$e(1,"h4"),At(2,"Similar Sites"),it(),$e(3,"app-poi-list",31),In("onCopy",function(O){Yi(P);let t=Wt(6);return Ji(t.useTemplatePOI(O))}),it(),Fo()}if(oe&2){let P=Wt(6);ot(3),ai("enableCopyOption",!0)("poiList",P.templateSites)}}function TS(oe,Ht){oe&1&&(Oo(0),$e(1,"p"),At(2," There are no suggested sites to copy for this network operator. "),it(),Fo())}function SS(oe,Ht){if(oe&1&&(Oo(0),_n(1,wS,4,2,"ng-container",10)(2,TS,3,0,"ng-container",10),Fo()),oe&2){let P=Wt(5);ot(),ai("ngIf",P.templateSites.length>0),ot(),ai("ngIf",P.templateSites.length==0)}}function IS(oe,Ht){if(oe&1&&(Oo(0),_n(1,bS,16,5,"ng-container",10)(2,SS,3,2,"ng-container",10),Fo()),oe&2){let P=Wt(4);ot(),ai("ngIf",P.selectedTemplatePOI),ot(),ai("ngIf",!P.selectedTemplatePOI)}}function CS(oe,Ht){if(oe&1){let P=wr();Oo(0),$e(1,"p",27),At(2,"You can copy the equipment settings from other sites operated by the same network operator or choose 'Next' to skip this step: "),it(),$e(3,"app-operator-lookup",29),In("operatorChanged",function(O){Yi(P);let t=Wt(3);return Ji(t.onOperatorChange(O))}),it(),_n(4,IS,3,2,"ng-container",10),Fo()}if(oe&2){let P=Wt(3);ot(3),ai("operatorId",P.item.OperatorID),ot(),ai("ngIf",P.item.AddressInfo.CountryID&&P.item.OperatorID)}}function ES(oe,Ht){if(oe&1&&(Oo(0),_n(1,CS,5,2,"ng-container",10),Fo()),oe&2){let P=Wt(2);ot(),ai("ngIf",!P.skipPOICopy)}}function MS(oe,Ht){if(oe&1){let P=wr();Oo(0),$e(1,"app-operator-lookup",32),In("operatorChanged",function(O){Yi(P);let t=Wt(2);return Ji(t.onOperatorChange(O))}),it(),$e(2,"ion-item")(3,"ion-input",33),tr("ngModelChange",function(O){Yi(P);let t=Wt(2);return Yn(t.item.NumberOfPoints,O)||(t.item.NumberOfPoints=O),Ji(O)}),it()(),$e(4,"h4"),At(5,"Equipment"),it(),$e(6,"ion-button",34),In("click",function(){Yi(P);let O=Wt(2);return Ji(O.addConnection())}),rn(7,"ion-icon",35),it(),$e(8,"app-equipment-details",36),In("onEdit",function(O){Yi(P);let t=Wt(2);return Ji(t.editConnection(O))})("onDelete",function(O){Yi(P);let t=Wt(2);return Ji(t.deleteConnection(O))}),it(),Fo()}if(oe&2){let P=Wt(2);ot(),ai("operatorId",P.item.OperatorID)("useFilteredOperators",!1),ot(2),er("ngModel",P.item.NumberOfPoints),ot(5),ai("item",P.item)("enableEdit",!0)}}function PS(oe,Ht){if(oe&1&&(Oo(0),_n(1,ES,2,1,"ng-container",10)(2,MS,9,5,"ng-container",10),Fo()),oe&2){let P=Wt();ot(),ai("ngIf",P.step=="copy-equipment"),ot(),ai("ngIf",P.step=="edit-equipment")}}function AS(oe,Ht){if(oe&1&&($e(0,"p",46)(1,"strong"),At(2,"Your changes cannot be saved until the following issues are resolved:"),it(),$e(3,"ion-label",47),At(4),it()()),oe&2){let P=Wt(2);ot(4),qn(" ",P.validationMsg)}}function DS(oe,Ht){if(oe&1&&($e(0,"ion-select-option",26),At(1),it()),oe&2){let P=Ht.$implicit;ai("value",P.ID),ot(),Qn(P.Title)}}function RS(oe,Ht){if(oe&1&&($e(0,"ion-select-option",26),At(1),it()),oe&2){let P=Ht.$implicit;ai("value",P.ID),ot(),Qn(P.Title)}}function zS(oe,Ht){if(oe&1){let P=wr();Oo(0),_n(1,AS,5,1,"p",37),$e(2,"p"),At(3,"Please provide any other facts related to this site. Additional comments (your charging experiences etc) can be added as check-in comments once the site is listed."),it(),$e(4,"ion-item")(5,"ion-select",38),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.item.StatusTypeID,O)||(t.item.StatusTypeID=O),Ji(O)}),_n(6,DS,2,2,"ion-select-option",23),it()(),$e(7,"ion-item")(8,"ion-select",39),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.item.UsageTypeID,O)||(t.item.UsageTypeID=O),Ji(O)}),_n(9,RS,2,2,"ion-select-option",23),it()(),$e(10,"ion-item")(11,"ion-input",40),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.item.UsageCost,O)||(t.item.UsageCost=O),Ji(O)}),it()(),$e(12,"ion-item")(13,"ion-input",41),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.item.GeneralComments,O)||(t.item.GeneralComments=O),Ji(O)}),it()(),$e(14,"ion-item")(15,"ion-input",42),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.item.AddressInfo.ContactTelephone1,O)||(t.item.AddressInfo.ContactTelephone1=O),Ji(O)}),it()(),$e(16,"ion-item")(17,"ion-input",43),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.item.AddressInfo.ContactTelephone2,O)||(t.item.AddressInfo.ContactTelephone2=O),Ji(O)}),it()(),$e(18,"ion-item")(19,"ion-input",44),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.item.AddressInfo.AccessComments,O)||(t.item.AddressInfo.AccessComments=O),Ji(O)}),it()(),$e(20,"ion-item")(21,"ion-input",45),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.item.AddressInfo.RelatedURL,O)||(t.item.AddressInfo.RelatedURL=O),Ji(O)}),it()(),Fo()}if(oe&2){let P=Wt();ot(),ai("ngIf",P.validationMsg),ot(4),er("ngModel",P.item.StatusTypeID),ot(),ai("ngForOf",P.statusTypes),ot(2),er("ngModel",P.item.UsageTypeID),ot(),ai("ngForOf",P.usageTypes),ot(2),er("ngModel",P.item.UsageCost),ot(2),er("ngModel",P.item.GeneralComments),ot(2),er("ngModel",P.item.AddressInfo.ContactTelephone1),ot(2),er("ngModel",P.item.AddressInfo.ContactTelephone2),ot(2),er("ngModel",P.item.AddressInfo.AccessComments),ot(2),er("ngModel",P.item.AddressInfo.RelatedURL)}}function LS(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-button",2),In("click",function(){Yi(P);let O=Wt();return Ji(O.previous())}),At(1," Previous "),rn(2,"ion-icon",48),it()}}function kS(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-button",2),In("click",function(){Yi(P);let O=Wt();return Ji(O.next())}),At(1," Next "),rn(2,"ion-icon",49),it()}}function OS(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-button",50),In("click",function(){Yi(P);let O=Wt();return Ji(O.save())}),At(1," Submit "),rn(2,"ion-icon",51),it()}}var bw=(()=>{class oe{appManager;modalController;poiManager;mapping;loadingController;alertController;id;item;step;selectedTab;startPos;useFilteredConnectionTypes=!0;templateSites=[];nearbySites=[];selectedTemplatePOI=null;suggestedAddress=null;suggestedAddressAttribution=null;isNonDuplicateConfirmed=!1;skipPOICopy=!1;validationMsg=null;loading;editorMap;get countries(){return this.appManager.referenceDataManager.getCountries()}get usageTypes(){return this.appManager.referenceDataManager.getUsageTypes()}get statusTypes(){return this.appManager.referenceDataManager.getStatusTypes().filter(P=>P.IsUserSelectable==!0)}get isAddMode(){return this.item.ID<=0}constructor(P,Y,O,t,at,yi){this.appManager=P,this.modalController=Y,this.poiManager=O,this.mapping=t,this.loadingController=at,this.alertController=yi,this.initNewItem()}initNewItem(){this.item={ID:-1,DataProviderID:1,DataProvidersReference:null,OperatorsReference:null,OperatorID:1,UsageCost:null,UsageTypeID:4,NumberOfPoints:1,GeneralComments:null,DatePlanned:null,StatusTypeID:50,SubmissionStatusTypeID:null,Connections:[],MetadataValues:[],AddressInfo:{ID:-1,CountryID:18,Title:"",AddressLine1:"",Latitude:0,Longitude:0}},this.step="location",this.selectedTab="location"}get isReadyToSubmit(){return this.validate().isValid&&this.step=="info"}ngOnInit(){}presentLoadingUI(){return On(this,null,function*(){this.loading=yield this.loadingController.create({message:"Please Wait.."}),yield this.loading.present()})}dismissLoadingUI(){return On(this,null,function*(){this.loading&&(yield this.loading.dismiss())})}ionViewDidEnter(){if(this.id!=null)this.editExistingPOI(this.id);else{let P=localStorage.getItem("_editor-operatorid");P&&(this.item.OperatorID=parseInt(P,10)),this.startPos?(this.item.AddressInfo.Latitude=this.startPos.latitude,this.item.AddressInfo.Longitude=this.startPos.longitude):this.mapping&&this.mapping.getMapCenter().subscribe(Y=>{Y&&(this.item.AddressInfo.Latitude=Y.coords.latitude,this.item.AddressInfo.Longitude=Y.coords.longitude)})}this.refreshFilteredReferenceData()}previous(){return On(this,null,function*(){switch(this.step){case"info":this.step="edit-equipment";break;case"edit-equipment":this.step=this.isAddMode?"copy-equipment":"location";break;case"copy-equipment":this.step="location";break;case"poi-nearby":this.step="location";break}yield this.initCurrentStep(!1)})}next(){return On(this,null,function*(){if(this.step=="poi-nearby"&&this.nearbySites.length>0&&!this.isNonDuplicateConfirmed){(yield this.alertController.create({header:"Confirm",message:"Please confirm you are not adding a duplicate site.",buttons:[{text:"Cancel",role:"cancel",cssClass:"secondary",handler:O=>{}},{text:"Confirm",handler:()=>{this.isNonDuplicateConfirmed=!0,this.next()}}]})).present();return}let P=this.validate(this.step);if(P.isValid){switch(this.step){case"location":this.step=this.isAddMode?"poi-nearby":"edit-equipment";break;case"poi-nearby":this.step=this.isAddMode?"copy-equipment":"edit-equipment";break;case"copy-equipment":this.step="edit-equipment";break;case"edit-equipment":this.step="info";break}yield this.initCurrentStep(!0)}else(yield this.alertController.create({message:P.msg})).present()})}initCurrentStep(P){return On(this,null,function*(){this.step=="poi-nearby"?(this.selectedTab="location",(yield this.refreshNearbySites())==0&&(P?yield this.next():yield this.previous())):this.step=="location"?this.selectedTab="location":this.step=="copy-equipment"?(this.selectedTab="equipment",yield this.refreshTemplateSites()):this.step=="edit-equipment"?this.selectedTab="equipment":this.step=="info"&&(this.selectedTab="info")})}onCountryChange(){return On(this,null,function*(){this.refreshFilteredReferenceData()})}onOperatorChange(P=null){return On(this,null,function*(){P!=null&&this.item.OperatorID!=P.ID&&(this.item.OperatorID=P.ID,localStorage.setItem("_editor-operatorid",this.item.OperatorID.toString()),yield this.refreshTemplateSites())})}useSuggestedAddress(P=null){P&&(this.suggestedAddress=P.suggestedAddress,this.suggestedAddressAttribution=P.suggestedAddressAttribution),Object.assign(this.item.AddressInfo,this.suggestedAddress),this.suggestedAddressAttribution&&(this.item.MetadataValues.find(Y=>Y.MetadataFieldID==4)||this.item.MetadataValues.push({ID:-1,MetadataFieldID:4,ItemValue:this.suggestedAddressAttribution,MetadataFieldOptionID:null,MetadataFieldOption:null}))}editConnection(P){return On(this,null,function*(){let Y=this.item.Connections.find(at=>at.ID==P.ID),O=Object.assign({},Y),t=yield this.modalController.create({component:lv,componentProps:{conn:O}});return t.onWillDismiss().then(at=>{at&&at.data&&at.data.item&&this.updateConnection(at.data.item)}),yield t.present()})}deleteConnection(P){return On(this,null,function*(){let Y=this.item.Connections.find(t=>t.ID==P.ID);(yield this.alertController.create({header:"Confirm Delete",message:"Are you sure you want to delete this connection information?",buttons:[{text:"No",role:"cancel",cssClass:"secondary",handler:()=>{}},{text:"Yes",handler:()=>{this.item.Connections=this.item.Connections.filter(t=>t.ID!=Y.ID),this.appManager.referenceDataManager.hydrateCompactPOI(this.item,!0)}}]})).present()})}addConnection(){return On(this,null,function*(){let P={ID:-ol.getRandomInt(1e4),ConnectionTypeID:null,StatusTypeID:50,PowerKW:null,Quantity:1},Y=yield this.modalController.create({component:lv,componentProps:{conn:P}});return Y.onWillDismiss().then(O=>{O&&O.data&&O.data.item&&this.updateConnection(O.data.item)}),yield Y.present()})}refreshFilteredReferenceData(){this.appManager.referenceDataManager.refreshFilteredReferenceData(this.appManager.api,{CountryIds:[this.item.AddressInfo.CountryID]})}updateConnection(P){if(P){let Y=this.item.Connections.find(O=>O.ID==P.ID);Y?Object.assign(Y,P):this.item.Connections.push(P)}this.appManager.referenceDataManager.hydrateCompactPOI(this.item,!0)}validate(P="all"){let Y=null;return(P=="all"||P=="location")&&((!this.item.AddressInfo.Latitude||!this.item.AddressInfo.Longitude)&&(Y="Location is required"),this.item.AddressInfo.Title==""&&(Y="A location title is required"),!this.item.AddressInfo.AddressLine1&&!this.item.AddressInfo.AddressLine2&&(Y="An approximate address is required."),this.item.AddressInfo.CountryID||(Y="A country selection is required"),(!this.item.AddressInfo.Latitude||!this.item.AddressInfo.Longitude)&&(Y="A location latitude and longitude is required")),(P=="all"||P=="poi-nearby")&&this.nearbySites.length>0&&!this.isNonDuplicateConfirmed&&(Y="Please confirm that the site is not a duplicate"),(P=="all"||P=="equipment")&&(this.item.OperatorID||(Y="Please confirm the charging network or equipment operator."),this.item.Connections.length==0&&(Y="Equipment information is required")),Y?(this.validationMsg=Y,{isValid:!1,msg:Y}):(this.validationMsg=null,{isValid:!0,msg:null})}save(){return On(this,null,function*(){let P=this.validate();if(!P.isValid){alert(P.msg);return}yield this.presentLoadingUI();try{yield this.appManager.submitPOI(this.item),yield this.dismissLoadingUI(),this.appManager.showToastNotification("You submission will be reviewed (if required) and published shortly."),this.modalController.dismiss()}catch(Y){yield this.dismissLoadingUI(),Y.error&&alert("Sorry, your submission could not be completed at this time. Please try again later.")}})}cancel(){return On(this,null,function*(){this.modalController.dismiss()})}refreshTemplateSites(){return On(this,null,function*(){if(this.item.AddressInfo.CountryID&&this.item.OperatorID){yield this.presentLoadingUI(),this.templateSites=[];let P=new wm;P.countryIdList=[this.item.AddressInfo.CountryID],P.minPowerKW=1,P.operatorIdList=[this.item.OperatorID],P.maxResults=10;let Y=yield this.poiManager.fetchPOIList(P);Y.sort((O,t)=>new Date(O.DateCreated).getTime()-new Date(t.DateCreated).getTime()),this.templateSites=Y,this.dismissLoadingUI()}})}refreshNearbySites(){return On(this,null,function*(){if(this.item.AddressInfo.Latitude&&this.item.AddressInfo.Longitude){yield this.presentLoadingUI(),this.nearbySites=[];let P=new wm;P.latitude=this.item.AddressInfo.Latitude,P.longitude=this.item.AddressInfo.Longitude,P.distance=5,P.distanceUnit="km",P.maxResults=10;let Y=yield this.poiManager.fetchPOIList(P);return Y.sort((O,t)=>O.Distance-t.Distance),this.nearbySites=Y,this.dismissLoadingUI(),Y.length}else return 0})}confirmNonDuplicate(){this.isNonDuplicateConfirmed=!0,this.next()}changeTemplatePOI(){this.selectedTemplatePOI=null}editPOI(P){this.editExistingPOI(P.ID)}editExistingPOI(P){return On(this,null,function*(){this.skipPOICopy=!0,this.isNonDuplicateConfirmed=!0,yield this.presentLoadingUI(),this.poiManager.getPOIById(P,!0,!0).then(Y=>{this.item=Object.assign({},Y),this.item.OperatorID==null&&(this.item.OperatorID=hv.UnknownOperator),this.refreshFilteredReferenceData(),this.dismissLoadingUI()})})}useTemplatePOI(P){this.selectedTemplatePOI=P,Object.assign(this.item.Connections,P.Connections);for(let Y of this.item.Connections)Y.ID=-ol.getRandomInt(1e4),Y.Reference=null,Y.Comments=null,Y.StatusTypeID=cv.Operational;this.item.UsageCost=P.UsageCost,this.item.UsageTypeID=P.UsageTypeID,this.appManager.referenceDataManager.hydrateCompactPOI(this.item)}skipCopyingPOI(){this.skipPOICopy=!0}static \u0275fac=function(Y){return new(Y||oe)(Mn(ru),Mn(iu),Mn(ng),Mn(og),Mn(gm),Mn(N0))};static \u0275cmp=$s({type:oe,selectors:[["app-poi-editor"]],viewQuery:function(Y,O){if(Y&1&&Fb($0,5),Y&2){let t;Bb(t=Nb())&&(O.editorMap=t.first)}},standalone:!1,decls:33,vars:14,consts:[["editorMap",""],["slot","end"],[3,"click"],["name","close","slot","start"],[1,"ion-padding"],[3,"ngModel"],["value","location","layout","icon-start",3,"disabled"],["name","caret-forward",4,"ngIf"],["value","equipment","layout","icon-start",3,"disabled"],["value","info","layout","icon-start",3,"disabled"],[4,"ngIf"],["slot","start"],[3,"click",4,"ngIf"],["color","success",3,"click",4,"ngIf"],["name","caret-forward"],[3,"latitudeChange","longitudeChange","onUseSuggestedAddress","latitude","longitude"],["label","Location Name","label-placement","floating","type","text","autocapitalize","words","placeholder","A title for this location",3,"ngModelChange","ngModel"],["label","Address Line 1","label-placement","floating","type","text","autocapitalize","words","placeholder","The nearest street address",3,"ngModelChange","ngModel"],["label","Address Line 2","label-placement","floating","type","text","autocapitalize","words","placeholder","Optional",3,"ngModelChange","ngModel"],["label","Town","label-placement","floating","type","text","autocapitalize","words","placeholder","Town or City",3,"ngModelChange","ngModel"],["label","State or Province","label-placement","floating","type","text",3,"ngModelChange","ngModel"],["label","Postal Code","label-placement","floating","type","text","autocapitalize","words","placeholder","Optional Postal Code",3,"ngModelChange","ngModel"],["label","Country","label-placement","floating",3,"ngModelChange","ionChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],["label","Latitude","labelPlacement","floating","type","number","placeholder","Latitude (if entering manually)",3,"ngModelChange","ngModel"],["label","Longitude","labelPlacement","floating","type","number","placeholder","Longitude (if entering manually)",3,"ngModelChange","ngModel"],[3,"value"],[1,"instruction"],[3,"onEdit","poiList","enableEditOption"],[3,"operatorChanged","operatorId"],["slot","start","size","small",3,"click"],[3,"onCopy","enableCopyOption","poiList"],[3,"operatorChanged","operatorId","useFilteredOperators"],["label","Number of Stations or Parking Bays","labelPlacement","floating","min","1","type","number",3,"ngModelChange","ngModel"],["size","small",3,"click"],["name","add","slot","icon-only"],[3,"onEdit","onDelete","item","enableEdit"],["color","warning",4,"ngIf"],["label","Operational Status (All Equipment)","label-placement","floating",3,"ngModelChange","ngModel"],["label","Usage Type","label-placement","floating",3,"ngModelChange","ngModel"],["label","Usage Cost","label-placement","floating","type","text",3,"ngModelChange","ngModel"],["label","General Comments","label-placement","floating","type","text","autocapitalize","sentences",3,"ngModelChange","ngModel"],["label","Main Telephone Number","label-placement","floating","type","tel","placeholder","",3,"ngModelChange","ngModel"],["label","Other Telephone Number","label-placement","floating","type","tel","placeholder","",3,"ngModelChange","ngModel"],["label","Access Comments","label-placement","floating","type","text","autocapitalize","sentences","placeholder","Instructions for access or tips for finding charging location",3,"ngModelChange","ngModel"],["label","Related Website","label-placement","floating","type","url","placeholder","Website related to this site",3,"ngModelChange","ngModel"],["color","warning"],["color","danger"],["name","caret-back","slot","start"],["name","caret-forward","slot","end"],["color","success",3,"click"],["name","send","slot","end"]],template:function(Y,O){Y&1&&($e(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),At(3),it(),$e(4,"ion-buttons",1)(5,"ion-button",2),In("click",function(){return O.cancel()}),rn(6,"ion-icon",3),At(7," Cancel "),it()()()(),$e(8,"ion-content",4),Oo(9),$e(10,"ion-segment",5)(11,"ion-segment-button",6),_n(12,fS,1,0,"ion-icon",7),$e(13,"ion-label"),At(14,"Location"),it()(),$e(15,"ion-segment-button",8),_n(16,mS,1,0,"ion-icon",7),$e(17,"ion-label"),At(18,"Equipment"),it()(),$e(19,"ion-segment-button",9),_n(20,_S,1,0,"ion-icon",7),$e(21,"ion-label"),At(22,"Info"),it()()(),_n(23,vS,3,2,"ng-container",10)(24,PS,3,2,"ng-container",10)(25,zS,22,11,"ng-container",10),Fo(),it(),$e(26,"ion-footer")(27,"ion-toolbar")(28,"ion-buttons",11),_n(29,LS,3,0,"ion-button",12),it(),$e(30,"ion-buttons",1),_n(31,kS,3,0,"ion-button",12)(32,OS,3,0,"ion-button",13),it()()()),Y&2&&(ot(3),Qn(O.isAddMode?"Add Location":"Edit Location"),ot(7),ai("ngModel",O.selectedTab),ot(),ai("disabled",!0),ot(),ai("ngIf",O.selectedTab=="location"),ot(3),ai("disabled",!0),ot(),ai("ngIf",O.selectedTab=="equipment"),ot(3),ai("disabled",!0),ot(),ai("ngIf",O.selectedTab=="info"),ot(3),ai("ngIf",O.selectedTab=="location"),ot(),ai("ngIf",O.selectedTab=="equipment"),ot(),ai("ngIf",O.selectedTab=="info"),ot(4),ai("ngIf",O.step!="location"),ot(2),ai("ngIf",!O.isReadyToSubmit&&O.step!="info"),ot(),ai("ngIf",O.isReadyToSubmit))},dependencies:[Hl,Ga,Kl,Yl,ma,Vc,yd,xd,vd,_a,tu,Za,Jl,Uc,Y_,J_,of,sf,bd,jc,$_,eu,Nc,B0,yw,W0,$0,vw],styles:['ul.breadcrumb[_ngcontent-%COMP%]{display:inline-flex;margin:0;padding:0}ul.breadcrumb[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{display:inline-flex;margin-right:6px;color:var(--ion-color-light-shade);font-size:10px}ul.breadcrumb[_ngcontent-%COMP%]   li.active[_ngcontent-%COMP%]{color:var(--ion-color-dark-shade)}ul.breadcrumb[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]:before{content:">";padding-right:4px}']})}return oe})();var qc=Ab(Tw());var Sw=(()=>{class oe{events;logging;http;mapAPIType;mapReady;providerError;mapCanvasID;map;markerList;polylinePath;_isMapAnimating=!1;searchMarker;mapTileSet;constructor(P,Y,O){this.events=P,this.logging=Y,this.http=O,this.events=P,this.mapAPIType=Sd.MAPBOX,this.mapReady=!1,this.markerList=new Map}initAPI(){qc.default&&(qc.default.accessToken=Il.mapBoxToken)}disposeMap(){this.map&&(this.logging.log("Disposing map",ks.INFO),this.map.remove())}getCurrentMapTileSet(P){return P=="SATELLITE"?"mapbox://styles/mapbox/satellite-streets-v12?optimize=true":"mapbox://styles/mapbox/streets-v12?optimize=true"}flyAroundPoint(P){if(this._isMapAnimating){this.map.rotateTo(P/100%360,{duration:0});let Y=this;requestAnimationFrame(function(O){Y.flyAroundPoint(O)})}}initMap(P,Y,O){this.mapCanvasID=P;let t=!0;if(typeof qc.default>"u"?t=!1:t=!0,t){if(this.map==null){let _r=function(Dt){return Dt*(2-Dt)},at=document.getElementById(P);this.initAPI(),this.map=new qc.default.Map({container:P,zoom:15,attributionControl:!1}),this.map.addControl(new qc.default.AttributionControl({compact:!0,customAttribution:["Open Charge Map Contributors"]})),this.map.addControl(new qc.default.NavigationControl),this.mapReady=!0,this.map.getCanvas().focus();let yi=100,Cn=25;this.map.getCanvas().addEventListener("keydown",Dt=>{Dt.preventDefault(),Dt.which===38?this.map.panBy([0,-yi],{easing:_r}):Dt.which===40?this.map.panBy([0,yi],{easing:_r}):Dt.which===37?this.map.easeTo({bearing:this.map.getBearing()-Cn,easing:_r}):Dt.which===39?this.map.easeTo({bearing:this.map.getBearing()+Cn,easing:_r}):Dt.which===32&&(this._isMapAnimating?this._isMapAnimating=!1:(this._isMapAnimating=!0,this.flyAroundPoint(0)))},!0),this.map.on("load",()=>{this.events.publish("ocm:mapping:ready")});let an=ol.debounce(()=>{this.getMapCenter().subscribe(Dt=>{this.searchMarker.setLngLat(new qc.default.LngLat(Dt.coords.longitude,Dt.coords.latitude))})},500,!1);this.map.on("move",()=>{this.searchMarker&&an()}),this.map.on("moveend",()=>{this.events.publish("ocm:mapping:dragend"),Y.onMapMoveCompleted&&Y.onMapMoveCompleted()}),this.map.on("zoomend",()=>{this.events.publish("ocm:mapping:zoom")})}}else return this.logging.log("Call to initMap before API is ready:"+Sd[this.mapAPIType],ks.ERROR),this.mapReady=!1,!1}clearMarkers(){this.markerList!=null&&this.markerList.forEach((P,Y)=>{P.remove()}),this.markerList=new Map}showPOIListOnMap(P,Y,O=!0){let t=!1,at=this.map,yi=new qc.default.LngLatBounds,Cn=0,_r=this;t&&this.clearMarkers();let an=at.getZoom();if(P!=null){let Wi=P.length;for(let on=0;on<P.length;on++)if(P[on].AddressInfo!=null&&P[on].AddressInfo.Latitude!=null&&P[on].AddressInfo.Longitude!=null){let vn=P[on],gn=!0;if(!t&&this.markerList!=null&&this.markerList.has(vn.ID)){gn=!1;let vr=this.markerList.get(vn.ID);vr&&vr.poi&&vr.poi.DateLastStatusUpdate!=vn.DateLastStatusUpdate&&(vr.remove(),gn=!0)}if(gn){let vr=null,Bo=null;O?(vr=document.createElement("img"),vr.src=ol.getIconForPOI(vn),vr.width=34,vr.height=50):(vr=null,Bo=ol.getColorForPOI(vn));let qo={element:vr,color:Bo,anchor:"bottom"},to=(O?"OCM-":"EXT-")+vn.ID+": "+vn.AddressInfo.Title+":";vn.UsageType!=null&&(to+=" "+vn.UsageType.Title),vn.StatusType!=null&&(to+=" "+vn.StatusType.Title);let Br=new qc.default.Marker(qo).setLngLat([vn.AddressInfo.Longitude,vn.AddressInfo.Latitude]).addTo(at);Br.poi=vn;let os=Br.getElement();os.poi=vn,os.addEventListener("click",ga=>{let Aa=ga.currentTarget.poi;this.events.publish("ocm:poi:selected",{poiId:Aa.ID,poi:Aa})}),yi.extend(Br.getLngLat()),this.markerList.set(vn.ID,Br),Cn++}}this.logging.log(Cn+" new map markers added out of a total "+this.markerList.size)}let Dt=this;if(P!=null&&P.length>0)if(Y!=null&&!Y.appConfig.enableLiveMapQuerying){this.logging.log("Fitting to marker bounds:"+yi),at.setCenter(yi.getCenter()),this.logging.log("zoom before fit bounds:"+at.getZoom()),at.fitBounds(yi);let Wi=at.getZoom();at.setZoom(Wi<6?6:Wi)}else at.getCenter()==null&&at.setCenter(yi.getCenter())}refreshMapLayout(){this.map!=null&&setTimeout(()=>{this.logging.log("MapBoxGL: refreshMapLayout",ks.VERBOSE),this.map.resize()},200)}setMapCenter(P){this.mapReady&&(this.map.setCenter(new qc.default.LngLat(P.coords.longitude,P.coords.latitude)),this.searchMarker||(this.searchMarker=new qc.default.Marker({color:"#99ccff",anchor:"bottom"}).setLngLat(new qc.default.LngLat(P.coords.longitude,P.coords.latitude)).addTo(this.map),this.searchMarker.getElement().addEventListener("click",()=>{let Y=this.searchMarker.getLngLat();this.events.publish("ocm:mapping:addpoi",new Is(Y.lat,Y.lng))})))}getMapCenter(){return new fm(Y=>{if(this.map!=null){let O=this.map.getCenter();O!=null&&(Y.next(new wd(O.lat,O.lng)),Y.complete())}})}setMapZoom(P){this.map.setZoom(P)}getMapZoom(){return new fm(Y=>{let O=this.map.getZoom();Y.next(O),Y.complete()})}setMapType(P){this.map.setStyle(this.getCurrentMapTileSet(P))}getMapBounds(){return new fm(Y=>{let O=new Array,t=this.map.getBounds();O.push(new Is(t.getSouthWest().lat,t.getSouthWest().lng)),O.push(new Is(t.getNorthEast().lat,t.getNorthEast().lng)),Y.next(O),Y.complete()})}moveToMapBounds(P){this.map.fitBounds(new qc.default.LngLatBounds(new qc.default.LngLat(P.southWest.longitude,P.southWest.latitude),new qc.default.LngLat(P.northEast.longitude,P.northEast.latitude)))}renderMap(P,Y,O){return document.getElementById(this.mapCanvasID).style.height=Y+"px",this.mapReady&&this.showPOIListOnMap(P,O),!0}renderPolyline(P){this.clearPolyline()}clearPolyline(){this.polylinePath!=null&&this.polylinePath.setMap(null)}focusMap(){}unfocusMap(){}placeSearch(P,Y,O){return On(this,null,function*(){let t=`https://api.mapbox.com/geocoding/v5/mapbox.places/${P||O+","+Y}.json?access_token=${Il.mapBoxToken}`;return new Promise((at,yi)=>On(this,null,function*(){this.http.get(t).toPromise().then(Cn=>{let _r=[];_r=[],Cn.features&&Cn.features.map(an=>{let Dt=new Mp;Dt.Title=an.place_name,Dt.Address=an.place_name,Dt.Type="place",Dt.Location=new Is(an.center[1],an.center[0]),Dt.Attribution=Cn.attribution,_r.push(Dt)}),at(_r)})}))})}addPOILayer(P){this.logging.log("Add POI Layer not implemented in this provider."),this.showPOIListOnMap(P,null,!1)}static \u0275fac=function(Y){return new(Y||oe)(ur(Zc),ur(Yo),ur(Xl))};static \u0275prov=rs({token:oe,factory:oe.\u0275fac})}return oe})();function FS(oe,Ht){oe&1&&($e(0,"div"),rn(1,"ion-spinner"),it())}function BS(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-item",5),In("click",function(){let O=Yi(P).$implicit,t=Wt(2);return Ji(t.placeSelected(O))}),$e(1,"ion-avatar",6),rn(2,"ion-icon",7),it(),$e(3,"ion-label")(4,"p"),At(5),it()()()}if(oe&2){let P=Ht.$implicit;ot(5),Qn(P.Address)}}function NS(oe,Ht){if(oe&1&&($e(0,"div",1),_n(1,FS,2,0,"div",2),$e(2,"ion-list"),_n(3,BS,6,1,"ion-item",3),$e(4,"ion-item")(5,"p",4),At(6),it()()()()),oe&2){let P=Wt();ot(),ai("ngIf",P.searchInProgress),ot(2),ai("ngForOf",P.placeList),ot(3),qn(" ",P.placeAttribution," ")}}var Iw=(()=>{class oe{logging;changeDetector;platform;http;events;placeSearchType;placeList;searchInProgress=!1;searchKeyword;placeSearchFocused;placeSearchActive=!1;placeAttribution="";selectedPlace;placeChanged=new gc;mapService;constructor(P,Y,O,t,at){this.logging=P,this.changeDetector=Y,this.platform=O,this.http=t,this.events=at,this.searchKeyword="",this.searchInProgress=!1,this.mapService=new Sw(at,P,t)}ngOnInit(){return On(this,null,function*(){yield this.platform.ready(),this.mapService.initAPI()})}onSearchFocus(){this.placeSearchFocused=!0}onSearchBlur(){this.placeSearchFocused=!1}onSearchCancel(){}getPlacesAutoComplete(P,Y){return On(this,null,function*(){this.placeSearchType=Y;let O=P.target.value;if(O&&O.length>3){this.logging.log("Starting place lookup for:"+O),this.placeSearchActive=!0,this.searchInProgress=!0,this.searchInProgress=!1,this.placeSearchActive=!0;try{this.placeList=yield this.mapService.placeSearch(O),this.placeList&&this.placeList.length>0&&(this.placeAttribution=this.placeList[0].Attribution);let t=yield this.detectAlternativeSearchResultType(O);t&&this.placeList.unshift(t)}catch{}this.searchInProgress=!1,this.placeSearchActive=!0}else this.searchInProgress=!1,this.placeSearchActive=!1})}ConvertDMSToDD(P,Y,O,t){var at=Number(P)+Number(Y)/60+Number(O)/3600;return(t=="S"||t=="W")&&(at=at*-1),at}ParseDMS(P){try{var Y=P.split(/[^\d\w\.]+/),O=this.ConvertDMSToDD(Y[0],Y[1],Y[2],Y[3]),t=this.ConvertDMSToDD(Y[4],Y[5],Y[6],Y[7]);return new Is(O,t)}catch{return null}}detectAlternativeSearchResultType(P){return On(this,null,function*(){if(P=P.trim(),P.startsWith("OCM-")&&(P=P.replace("OCM-","")),Number.isInteger(Number(P))){let t=new Mp;return t.Title="Go to OCM ID",t.Address="OCM-"+P,t.ReferenceID="OCM-"+P,t}let Y=P.match(/^\s*((lat|latitude)(:)?)?\s*((\-)?[0-9]+\.[0-9]+)\s*(,?)\s*((lng|lon|longitude)(:)?)?\s*((\-)?[0-9]+\.[0-9]+)\s*$/gi);if(Y&&Y.length>0){let at=(""+P.match(/((\-)?[0-9]+\.[0-9]+)+/g)).split(","),yi=new Mp;return yi.Title="Go to Lat/Lng",yi.Address="Lat:"+at[0]+", Lng:"+at[1],yi.Location=new Is(parseFloat(at[0]),parseFloat(at[1])),yi}else{var O=this.ParseDMS(P);if(O&&!isNaN(O.latitude)&&!isNaN(O.longitude)){let t=new Mp;return t.Title="Go to Lat/Lng",t.Address="Lat:"+O.latitude+", Lng:"+O.longitude,t.Location=O,t}else return null}})}placeSelected(P){let Y=P.Title;this.logging.log("Looking up place details:"+Y+"::"+P.ReferenceID),this.selectedPlace=P,this.placeChanged.emit(P),this.placeSearchActive=!1}static \u0275fac=function(Y){return new(Y||oe)(Mn(Yo),Mn(mm),Mn(G_),Mn(Xl),Mn(Zc))};static \u0275cmp=$s({type:oe,selectors:[["place-search"]],inputs:{searchKeyword:"searchKeyword"},outputs:{selectedPlace:"selectedPlace",placeChanged:"placeChanged"},standalone:!1,decls:1,vars:1,consts:[["class","place-search",4,"ngIf"],[1,"place-search"],[4,"ngIf"],[3,"click",4,"ngFor","ngForOf"],[1,"place-attribution"],[3,"click"],["item-left",""],["name","locate"]],template:function(Y,O){Y&1&&_n(0,NS,7,3,"div",0),Y&2&&ai("ngIf",O.placeSearchActive)},dependencies:[Hl,Ga,_m,_a,Za,Jl,Uc,F0],styles:[".place-search[_ngcontent-%COMP%]{position:absolute;z-index:1000}.place-attribution[_ngcontent-%COMP%]{font-size:9px;color:#dcdcdc;max-width:100%}"]})}return oe})();function US(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-card")(1,"ion-toolbar")(2,"ion-title",14),At(3,"Preview"),it(),$e(4,"ion-buttons",15)(5,"ion-button",5),In("click",function(){Yi(P);let O=Wt();return Ji(O.rotateImage())}),rn(6,"ion-icon",16),$e(7,"ion-label"),At(8,"Rotate"),it()()()(),$e(9,"ion-card-content")(10,"ion-list")(11,"ion-item")(12,"ion-label",17),At(13,"Comment"),it(),$e(14,"ion-input",18),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.comment,O)||(t.comment=O),Ji(O)}),it()()(),rn(15,"img",19),it()()}if(oe&2){let P=Wt();ot(14),er("ngModel",P.comment)}}var Cw=(()=>{class oe{navParams;appManager;nav;modalController;logging;mode;processingQuality;imgData;targetWidth;targetHeight;comment;chargePointId;poi;constructor(P,Y,O,t,at){this.navParams=P,this.appManager=Y,this.nav=O,this.modalController=t,this.logging=at,this.processingQuality=.8,this.targetWidth=1024,this.targetHeight=800,this.mode=Y.platformMode,this.chargePointId=this.navParams.get("id"),this.poi=this.navParams.get("poi"),this.comment=""}processNativeImageSource(P){let Y=P,O=document.getElementById("img-upload-canvas"),t=O.getContext("2d"),at=new Image;at.onload=()=>{this.logging.log("img load:"+at.width),O.width=at.width,O.height=at.height,t.fillStyle="rgb(0,0,0)",t.fillRect(0,0,O.width,O.height),t.drawImage(at,0,0,O.width,O.height),this.imgData=O.toDataURL("image/png"),this.processImage()},at.src=Y}loadCameraOrLibraryImage(P=!1){this.logging.log("PWA mode: fetching image");let Y=new FileReader;Y.onload=()=>{this.imgData=Y.result,this.processImage()},Y.onerror=()=>{},Y.readAsDataURL(document.getElementById("img-upload-media").files[0])}isBrowserMode(){return this.appManager.isPlatform("desktop")||this.appManager.isPlatform("hybrid")}processImage(){let P=this;if(this.imgData!=null){let Y=document.getElementById("img-upload-canvas"),O=Y.getContext("2d"),t=new Image;t.onload=()=>{Y.width=t.width,Y.height=t.height,O.fillStyle="rgb(0,0,0)",O.fillRect(0,0,Y.width,Y.height),O.drawImage(t,0,0,Y.width,Y.height),this.refreshImageFromCanvas()},t.src=this.imgData}else this.logging.log("processImage: nothing to process.")}refreshImageFromCanvas(){let P=document.getElementById("img-upload-canvas");this.imgData=P.toDataURL("image/jpeg",.8),document.getElementById("preview").src=this.imgData}rotateImage(){let P=document.getElementById("img-upload-canvas"),Y=new Image;Y.src=P.toDataURL(),Y.onload=()=>{let O=P.height,t=P.width;P.width=O,P.height=t,O=P.height,t=P.width;let at=P.getContext("2d");at.save(),at.translate(t,O/t),at.rotate(Math.PI/2),at.drawImage(Y,0,0),at.restore(),Y=null,this.refreshImageFromCanvas()}}performUpload(){return On(this,null,function*(){if(!this.imgData){yield this.appManager.showToastNotification("Select an image to upload.");return}let P={chargePointID:this.chargePointId,comment:this.comment,imageDataBase64:this.imgData};yield this.appManager.showLoadingProgress("Uploading photo..");try{let Y=yield this.appManager.submitMediaItem(P);this.appManager.dismissLoadingProgress().then(()=>{this.appManager.showToastNotification("Upload completed"),this.modalController.dismiss()}),this.appManager.analytics.appEvent("MediaUpload","Completed")}catch{yield this.appManager.dismissLoadingProgress(),yield this.appManager.showToastNotification("Upload failed, please try again."),this.appManager.analytics.appEvent("MediaUpload","Failed")}})}cancel(){return On(this,null,function*(){yield this.modalController.dismiss()})}static \u0275fac=function(Y){return new(Y||oe)(Mn(q_),Mn(ru),Mn(Z_),Mn(iu),Mn(Yo))};static \u0275cmp=$s({type:oe,selectors:[["ng-component"]],standalone:!1,decls:32,vars:3,consts:[["inputFile",""],[1,"media-upload"],[1,"ion-padding"],[1,"banner"],[1,"upload"],[3,"click"],["name","camera","aria-label","camera","slot","start"],["type","file","required","","id","img-upload-media",3,"change"],["id","img-upload-canvas",2,"display","none","width","500","height","500","border","1px solid red"],[4,"ngIf"],["slot","secondary"],["name","close","slot","start"],["slot","primary"],["name","send","slot","end"],["slot","start"],["slot","end"],["name","refresh","slot","start"],["position","floating"],["type","text","placeholder","(optional comment)",3,"ngModelChange","ngModel"],["id","preview",2,"max-width","500px"]],template:function(Y,O){if(Y&1){let t=wr();$e(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),At(3," Share Photo "),it()()(),$e(4,"ion-content",1)(5,"div",2)(6,"div",3)(7,"h1"),At(8),it(),$e(9,"p"),At(10),it()(),$e(11,"p"),At(12,"You can upload a photo from your device or take a new photo: "),it(),$e(13,"div",4)(14,"ion-button",5),In("click",function(){Yi(t);let yi=i_(19);return Ji(yi.click())}),rn(15,"ion-icon",6),$e(16,"ion-label"),At(17,"Choose Photo.."),it()(),$e(18,"input",7,0),In("change",function(){return Yi(t),Ji(O.loadCameraOrLibraryImage())}),it()(),rn(20,"canvas",8),_n(21,US,16,1,"ion-card",9),it()(),$e(22,"ion-footer")(23,"ion-toolbar")(24,"ion-buttons",10)(25,"ion-button",5),In("click",function(){return Yi(t),Ji(O.cancel())}),rn(26,"ion-icon",11),At(27," Cancel "),it()(),$e(28,"ion-buttons",12)(29,"ion-button",5),In("click",function(){return Yi(t),Ji(O.performUpload())}),At(30," Upload "),rn(31,"ion-icon",13),it()()()()}Y&2&&(ot(8),Qn(O.poi.AddressInfo.Title),ot(2),Qn(O.poi.AddressInfo.AddressLine1),ot(11),ai("ngIf",O.imgData!=null))},dependencies:[Ga,Kl,Yl,ma,Vc,L0,k0,yd,xd,vd,_a,tu,Za,Jl,Uc,bd,jc,Nc],styles:[".upload[_ngcontent-%COMP%]   input[type=file][_ngcontent-%COMP%]{position:fixed;top:-1000px}"]})}return oe})();function jS(oe,Ht){if(oe&1&&($e(0,"ion-select-option",19),At(1),it()),oe&2){let P=Ht.$implicit;ai("value",P.ID),ot(),Qn(P.Title)}}function GS(oe,Ht){if(oe&1&&($e(0,"ion-select-option",19),At(1),it()),oe&2){let P=Ht.$implicit;ai("value",P.ID),ot(),Qn(P.Title)}}var Ew=(()=>{class oe{navParams;appManager;nav;zone;loadingController;modalController;logging;router;commentModel;poi;commentTypes;checkinTypes;constructor(P,Y,O,t,at,yi,Cn,_r){this.navParams=P,this.appManager=Y,this.nav=O,this.zone=t,this.loadingController=at,this.modalController=yi,this.logging=Cn,this.router=_r,this.commentModel={ChargePointID:this.navParams.get("id"),Comment:"",CheckinStatusTypeID:10,CommentTypeID:10,Rating:null},this.poi=this.navParams.get("poi"),this.commentTypes=Y.referenceDataManager.getCommentTypes(!0,!0),this.checkinTypes=Y.referenceDataManager.getCheckinStatusTypes(!0,!0)}onPageWillEnter(){}cancel(){this.modalController.dismiss()}add(){return On(this,null,function*(){let P=yield this.loadingController.create({message:"Sending .."});yield P.present(),(yield this.appManager.submitComment(this.commentModel).catch(O=>{this.appManager.showToastNotification("There was a problem submitting your comment."),this.loadingController.dismiss(),this.appManager.analytics.appEvent("Comment","Failed")}))&&(this.logging.log("Comment submitted"),yield P.dismiss(),yield this.modalController.dismiss(),this.appManager.analytics.appEvent("Comment","Submitted"))})}static \u0275fac=function(Y){return new(Y||oe)(Mn(q_),Mn(ru),Mn(Z_),Mn(Ob),Mn(gm),Mn(iu),Mn(Yo),Mn(j_))};static \u0275cmp=$s({type:oe,selectors:[["ng-component"]],standalone:!1,decls:53,vars:8,consts:[["color","primary"],[1,"comment-page","ion-padding"],[1,"banner"],[1,"ion-padding"],["position","stacked"],[3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],["type","text","placeholder","(optional comment)",3,"ngModelChange","ngModel"],["value","5"],["value","4"],["value","3"],["value","2"],["value","1"],["value",""],["slot","secondary"],[3,"click"],["name","close","slot","start"],["slot","primary"],["name","send","slot","end"],[3,"value"]],template:function(Y,O){Y&1&&($e(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-title"),At(3," Add Comment "),it()()(),$e(4,"ion-content",1)(5,"div",2)(6,"h1"),At(7),it(),$e(8,"p"),At(9),it()(),$e(10,"p",3),At(11,"Recent Check-ins are a big help to other drivers when planning their journey. Tell everyone what you thought about this charging location. "),it(),$e(12,"ion-list")(13,"ion-item")(14,"ion-label",4),At(15,"Comment Type"),it(),$e(16,"ion-select",5),tr("ngModelChange",function(at){return Yn(O.commentModel.CommentTypeID,at)||(O.commentModel.CommentTypeID=at),at}),_n(17,jS,2,2,"ion-select-option",6),it()(),$e(18,"ion-item")(19,"ion-label",4),At(20,"What Did You Think?"),it(),$e(21,"ion-input",7),tr("ngModelChange",function(at){return Yn(O.commentModel.Comment,at)||(O.commentModel.Comment=at),at}),it()(),$e(22,"ion-item")(23,"ion-label",4),At(24,"Did You Successfully Charge?"),it(),$e(25,"ion-select",5),tr("ngModelChange",function(at){return Yn(O.commentModel.CheckinStatusTypeID,at)||(O.commentModel.CheckinStatusTypeID=at),at}),_n(26,GS,2,2,"ion-select-option",6),it()(),$e(27,"ion-item")(28,"ion-label",4),At(29,"Your Rating"),it(),$e(30,"ion-select",5),tr("ngModelChange",function(at){return Yn(O.commentModel.Rating,at)||(O.commentModel.Rating=at),at}),$e(31,"ion-select-option",8),At(32,"5 - Excellent"),it(),$e(33,"ion-select-option",9),At(34,"4 - Good"),it(),$e(35,"ion-select-option",10),At(36,"3 - Average"),it(),$e(37,"ion-select-option",11),At(38,"2 - Not Good"),it(),$e(39,"ion-select-option",12),At(40,"1 - Bad"),it(),$e(41,"ion-select-option",13),At(42,"Not Rated"),it()()()()(),$e(43,"ion-footer")(44,"ion-toolbar")(45,"ion-buttons",14)(46,"ion-button",15),In("click",function(){return O.cancel()}),rn(47,"ion-icon",16),At(48," Cancel "),it()(),$e(49,"ion-buttons",17)(50,"ion-button",15),In("click",function(){return O.add()}),At(51," Submit "),rn(52,"ion-icon",18),it()()()()),Y&2&&(ot(7),Qn(O.poi.AddressInfo.Title),ot(2),Qn(O.poi.AddressInfo.AddressLine1),ot(7),er("ngModel",O.commentModel.CommentTypeID),ot(),ai("ngForOf",O.commentTypes),ot(4),er("ngModel",O.commentModel.Comment),ot(4),er("ngModel",O.commentModel.CheckinStatusTypeID),ot(),ai("ngForOf",O.checkinTypes),ot(4),er("ngModel",O.commentModel.Rating))},dependencies:[Hl,Kl,Yl,ma,Vc,yd,xd,vd,_a,tu,Za,Jl,Uc,of,sf,bd,jc,eu,Nc],encapsulation:2})}return oe})();var H0=class{baseURL;loginProviderRedirectBaseURL;loginProviderRedirectURL;enableLiveMapQuerying;googleMapsAPIKey;enableStaticMaps;constructor(){this.baseURL="https://map.openchargemap.io",this.loginProviderRedirectBaseURL="https://openchargemap.org/site/loginprovider/?_mode=silent&_forceLogin=true&_redirectURL=",this.loginProviderRedirectURL=this.loginProviderRedirectBaseURL+this.baseURL,this.enableLiveMapQuerying=!0,this.googleMapsAPIKey=Il.googleMapsKey,this.enableStaticMaps=Il.enableStaticMaps}};function ZS(oe,Ht){if(oe&1&&($e(0,"div")(1,"small"),At(2),it()()),oe&2){let P=Wt(2);ot(2),Qn(P.connectionSummary)}}function qS(oe,Ht){if(oe&1&&($e(0,"div")(1,"small"),At(2),it()()),oe&2){let P=Wt(2);ot(2),Qn(P.poi.OperatorInfo.Title)}}function $S(oe,Ht){oe&1&&($e(0,"div")(1,"small"),At(2,"[Submission Awaiting Review]"),it()())}function WS(oe,Ht){if(oe&1){let P=wr();Oo(0),$e(1,"ion-button",30),In("click",function(){Yi(P);let O=Wt(2);return Ji(O.addFavourite())}),rn(2,"ion-icon",31),$e(3,"ion-label"),At(4,"Favourite"),it()(),$e(5,"ion-button",32),In("click",function(){Yi(P);let O=Wt(2);return Ji(O.edit())}),rn(6,"ion-icon",33),$e(7,"ion-label"),At(8,"Edit"),it()(),Fo()}}function HS(oe,Ht){if(oe&1){let P=wr();Oo(0),$e(1,"ion-button",34),In("click",function(){Yi(P);let O=Wt(2);return Ji(O.launchNavigation())}),rn(2,"ion-icon",35),$e(3,"ion-label"),At(4,"Navigate"),it()(),Fo()}}function XS(oe,Ht){if(oe&1){let P=wr();Oo(0),$e(1,"ion-button",36),In("click",function(){Yi(P);let O=Wt(2);return Ji(O.addComment())}),rn(2,"ion-icon",37),$e(3,"ion-label"),At(4,"Add Comment"),it()(),Fo()}}function KS(oe,Ht){if(oe&1){let P=wr();Oo(0),$e(1,"ion-button",38),In("click",function(){Yi(P);let O=Wt(2);return Ji(O.addMedia())}),rn(2,"ion-icon",39),$e(3,"ion-label"),At(4," Add Photo"),it()(),Fo()}}function YS(oe,Ht){if(oe&1&&($e(0,"div"),At(1),it()),oe&2){let P=Wt(4);ot(),qn(" ",P.poi.AddressInfo.AddressLine1)}}function JS(oe,Ht){if(oe&1&&($e(0,"div"),At(1),it()),oe&2){let P=Wt(4);ot(),qn(" ",P.poi.AddressInfo.AddressLine2)}}function QS(oe,Ht){if(oe&1&&($e(0,"div"),At(1),it()),oe&2){let P=Wt(4);ot(),qn(" ",P.poi.AddressInfo.Town)}}function eI(oe,Ht){if(oe&1&&($e(0,"div"),At(1),it()),oe&2){let P=Wt(4);ot(),qn(" ",P.poi.AddressInfo.StateOrProvince)}}function tI(oe,Ht){if(oe&1&&($e(0,"div"),At(1),it()),oe&2){let P=Wt(4);ot(),qn(" ",P.poi.AddressInfo.Postcode)}}function iI(oe,Ht){if(oe&1&&($e(0,"div"),At(1),it()),oe&2){let P=Wt(4);ot(),qn(" ",P.poi.AddressInfo.Country.Title)}}function nI(oe,Ht){if(oe&1&&($e(0,"p"),At(1),it()),oe&2){let P=Wt(4);ot(),qn(" ",P.poi.AddressInfo.AccessComments," ")}}function rI(oe,Ht){if(oe&1&&($e(0,"p"),rn(1,"ion-icon",44),$e(2,"span",42),At(3),it()()),oe&2){let P=Wt(4);ot(3),Qn(P.poi.AddressInfo.ContactTelephone1)}}function oI(oe,Ht){if(oe&1&&($e(0,"p"),rn(1,"ion-icon",44),$e(2,"span",42),At(3),it()()),oe&2){let P=Wt(4);ot(3),Qn(P.poi.AddressInfo.ContactTelephone2)}}function sI(oe,Ht){if(oe&1&&($e(0,"p"),rn(1,"ion-icon",45),$e(2,"span",42),At(3),it()()),oe&2){let P=Wt(4);ot(3),Qn(P.poi.AddressInfo.ContactEmail)}}function aI(oe,Ht){if(oe&1&&($e(0,"p"),rn(1,"ion-icon",46),$e(2,"span",42)(3,"a",47),At(4),it()()()),oe&2){let P=Wt(4);ot(3),ai("href",n_(P.poi.AddressInfo.RelatedURL),t_),ot(),Qn(P.poi.AddressInfo.RelatedURL)}}function lI(oe,Ht){if(oe&1&&($e(0,"ion-card")(1,"ion-card-header")(2,"ion-card-subtitle"),At(3),na(4,"translate"),it()(),$e(5,"ion-card-content")(6,"ion-grid")(7,"ion-row")(8,"ion-col")(9,"ion-label"),At(10),na(11,"translate"),it(),$e(12,"div",42),_n(13,YS,2,1,"div",0)(14,JS,2,1,"div",0)(15,QS,2,1,"div",0)(16,eI,2,1,"div",0)(17,tI,2,1,"div",0)(18,iI,2,1,"div",0),it()(),$e(19,"ion-col"),_n(20,nI,2,1,"p",0)(21,rI,4,1,"p",0)(22,oI,4,1,"p",0)(23,sI,4,1,"p",0)(24,aI,5,3,"p",0),it()(),$e(25,"ion-row")(26,"ion-col")(27,"ion-label",43),At(28),na(29,"number"),na(30,"number"),it()()()()()()),oe&2){let P=Wt(3);ot(3),qn(" ",Sl(4,15,"ocm.details.location.sectionTitle")," "),ot(7),qn(" ",Sl(11,17,"ocm.details.location.address")),ot(3),ai("ngIf",P.poi.AddressInfo.AddressLine1),ot(),ai("ngIf",P.poi.AddressInfo.AddressLine2),ot(),ai("ngIf",P.poi.AddressInfo.Town),ot(),ai("ngIf",P.poi.AddressInfo.StateOrProvince),ot(),ai("ngIf",P.poi.AddressInfo.Postcode),ot(),ai("ngIf",P.poi.AddressInfo.Country),ot(2),ai("ngIf",P.poi.AddressInfo.AccessComments),ot(),ai("ngIf",P.poi.AddressInfo.ContactTelephone1),ot(),ai("ngIf",P.poi.AddressInfo.ContactTelephone2),ot(),ai("ngIf",P.poi.AddressInfo.ContactEmail),ot(),ai("ngIf",P.poi.AddressInfo.RelatedURL),ot(4),Vb(" Lat/Long: ",r_(29,19,P.poi.AddressInfo.Latitude,"1.1-6")," , ",r_(30,22,P.poi.AddressInfo.Longitude,"1.1-6")," ")}}function cI(oe,Ht){if(oe&1&&($e(0,"p")(1,"span",48),At(2),na(3,"translate"),it(),$e(4,"span",42),At(5),it()()),oe&2){let P=Wt(3);ot(2),qn("",Sl(3,2,"ocm.details.numberOfPoints"),":"),ot(3),Qn(P.poi.NumberOfPoints)}}function hI(oe,Ht){if(oe&1&&($e(0,"p")(1,"span",48),At(2),na(3,"translate"),it(),$e(4,"span",42),At(5),it()()),oe&2){let P=Wt(3);ot(2),qn("",Sl(3,2,"ocm.details.operationalStatus"),":"),ot(3),qn(" ",P.poi.StatusType.Title," ")}}function uI(oe,Ht){if(oe&1&&($e(0,"p")(1,"span",48),At(2),na(3,"translate"),it(),$e(4,"span",42),At(5),it()()),oe&2){let P=Wt(3);ot(2),qn("",Sl(3,2,"ocm.details.usageType"),":"),ot(3),Qn(P.poi.UsageType.Title)}}function dI(oe,Ht){if(oe&1&&($e(0,"p")(1,"span",48),At(2),na(3,"translate"),it(),$e(4,"span",42),At(5),it()()),oe&2){let P=Wt(3);ot(2),qn("",Sl(3,2,"ocm.details.usageCost"),":"),ot(3),qn(" ",P.poi.UsageCost)}}function pI(oe,Ht){if(oe&1&&($e(0,"p"),rn(1,"br"),At(2),na(3,"translate"),rn(4,"br"),$e(5,"span",42),At(6),it()()),oe&2){let P=Wt(3);ot(2),qn("",Sl(3,2,"ocm.details.generalComments"),": "),ot(4),Qn(P.poi.GeneralComments)}}function fI(oe,Ht){if(oe&1&&($e(0,"p"),rn(1,"ion-icon",50),At(2),it()),oe&2){let P=Wt(4);ot(2),qn(" ",P.poi.OperatorInfo.WebsiteURL," ")}}function mI(oe,Ht){if(oe&1&&($e(0,"p"),rn(1,"ion-icon",45),At(2),it()),oe&2){let P=Wt(4);ot(2),qn(" ",P.poi.OperatorInfo.ContactEmail," ")}}function _I(oe,Ht){if(oe&1&&($e(0,"p"),rn(1,"ion-icon",45),At(2),it()),oe&2){let P=Wt(4);ot(2),qn(" ",P.poi.OperatorInfo.FaultReportEmail," ")}}function gI(oe,Ht){if(oe&1&&($e(0,"ion-card")(1,"ion-card-header")(2,"ion-card-subtitle"),At(3),na(4,"translate"),it()(),$e(5,"ion-card-content")(6,"div",42)(7,"p",49),At(8),it(),_n(9,fI,3,1,"p",0)(10,mI,3,1,"p",0)(11,_I,3,1,"p",0),it()()()),oe&2){let P=Wt(3);ot(3),qn(" ",Sl(4,5,"ocm.details.operator.sectionTitle")," "),ot(5),qn(" ",P.poi.OperatorInfo.Title," "),ot(),ai("ngIf",P.poi.OperatorInfo.WebsiteURL),ot(),ai("ngIf",P.poi.OperatorInfo.ContactEmail!=null),ot(),ai("ngIf",P.poi.OperatorInfo.FaultReportEmail!=null&&P.poi.OperatorInfo.FaultReportEmail!=P.poi.OperatorInfo.ContactEmail)}}function yI(oe,Ht){if(oe&1){let P=wr();$e(0,"a",52),In("click",function(){Yi(P);let O=Wt(4);return Ji(O.launchURL(O.poi.DataProvider.WebsiteURL))}),At(1),it()}if(oe&2){let P=Wt(4);ot(),Qn(P.poi.DataProvider.WebsiteURL)}}function xI(oe,Ht){if(oe&1&&($e(0,"div",42)(1,"h3"),At(2),na(3,"translate"),it(),$e(4,"p"),At(5),it(),_n(6,yI,2,1,"a",51),$e(7,"p"),At(8),it()()),oe&2){let P=Wt(3);ot(2),qn(" ",Sl(3,4,"ocm.details.dataProvider.sectionTitle")," "),ot(3),Qn(P.poi.DataProvider==null?null:P.poi.DataProvider.Title),ot(),ai("ngIf",P.poi.DataProvider.WebsiteURL),ot(2),Qn(P.poi.DataProvider==null?null:P.poi.DataProvider.License)}}function vI(oe,Ht){if(oe&1&&($e(0,"div"),_n(1,lI,31,25,"ion-card",0),$e(2,"ion-card")(3,"ion-card-header")(4,"ion-card-subtitle"),At(5),na(6,"translate"),it()(),$e(7,"ion-card-content"),_n(8,cI,6,4,"p",0),rn(9,"app-equipment-details",40),it()(),$e(10,"ion-card")(11,"ion-card-header")(12,"ion-card-subtitle"),At(13,"Usage Restrictions"),it()(),$e(14,"ion-card-content"),_n(15,hI,6,4,"p",0)(16,uI,6,4,"p",0)(17,dI,6,4,"p",0)(18,pI,7,4,"p",0),it()(),_n(19,gI,12,7,"ion-card",0),$e(20,"ion-card")(21,"ion-card-header"),At(22),na(23,"translate"),it(),$e(24,"ion-card-content"),_n(25,xI,9,6,"div",41),it()()()),oe&2){let P=Wt(2);ot(),ai("ngIf",P.poi.AddressInfo),ot(4),qn(" ",Sl(6,11,"ocm.details.equipment.sectionTitle")," "),ot(3),ai("ngIf",P.poi.NumberOfPoints!=null),ot(),ai("item",P.poi),ot(6),ai("ngIf",P.poi.StatusType!=null),ot(),ai("ngIf",P.poi.UsageType!=null),ot(),ai("ngIf",P.poi.UsageCost!=null),ot(),ai("ngIf",P.poi.GeneralComments!=null),ot(),ai("ngIf",P.poi.OperatorInfo),ot(3),qn(" ",Sl(23,13,"ocm.details.advancedDetails")," "),ot(3),ai("ngIf",P.poi.DataProvider)}}function bI(oe,Ht){if(oe&1&&rn(0,"img",55),oe&2){let P=Wt().$implicit;ai("src",n_(P.User==null?null:P.User.ProfileImageURL),t_)}}function wI(oe,Ht){if(oe&1&&($e(0,"span"),At(1),it()),oe&2){let P=Wt().$implicit;ot(),Qn(P.User.Username)}}function TI(oe,Ht){if(oe&1&&($e(0,"span"),At(1),it()),oe&2){let P=Wt().$implicit;ot(),Qn(P.Username)}}function SI(oe,Ht){if(oe&1&&($e(0,"p",42),At(1),it()),oe&2){let P=Wt().$implicit;ot(),qn(" ",P.CommentType==null?null:P.CommentType.Title," ")}}function II(oe,Ht){if(oe&1&&($e(0,"p")(1,"span",48),At(2,"Rating:"),it(),$e(3,"span",42),At(4),it()()),oe&2){let P=Wt().$implicit;ot(4),qn("",P.Rating," out of 5")}}function CI(oe,Ht){oe&1&&(Oo(0),rn(1,"ion-icon",56),Fo())}function EI(oe,Ht){oe&1&&(Oo(0),rn(1,"ion-icon",57),Fo())}function MI(oe,Ht){if(oe&1&&($e(0,"p"),_n(1,CI,2,0,"ng-container",0)(2,EI,2,0,"ng-container",0),At(3),it()),oe&2){let P=Wt().$implicit;ot(),ai("ngIf",P.CheckinStatusType.IsPositive===!0),ot(),ai("ngIf",P.CheckinStatusType.IsPositive===!1),ot(),qn(" ",P.CheckinStatusType.Title," ")}}function PI(oe,Ht){if(oe&1&&($e(0,"ion-card")(1,"ion-item")(2,"ion-avatar",23),_n(3,bI,1,2,"img",54),it(),$e(4,"ion-label"),_n(5,wI,2,1,"span",0)(6,TI,2,1,"span",0),it(),$e(7,"ion-label",24),At(8),na(9,"date"),it()(),$e(10,"ion-card-content")(11,"p"),At(12),it(),_n(13,SI,2,1,"p",41)(14,II,5,1,"p",0)(15,MI,4,3,"p",0),it()()),oe&2){let P=Ht.$implicit;ot(3),ai("ngIf",P.User&&P.User.ProfileImageURL),ot(2),ai("ngIf",P.User),ot(),ai("ngIf",!P.User),ot(2),qn(" ",Sl(9,8,P.DateCreated)," "),ot(4),Qn(P.Comment),ot(),ai("ngIf",P.CommentTypeID!=10),ot(),ai("ngIf",P.Rating),ot(),ai("ngIf",P.CheckinStatusType)}}function AI(oe,Ht){if(oe&1&&(Oo(0),_n(1,PI,16,10,"ion-card",53),Fo()),oe&2){let P=Wt(3);ot(),ai("ngForOf",P.poi.UserComments)}}function DI(oe,Ht){oe&1&&(Oo(0),$e(1,"ion-card")(2,"ion-card-content")(3,"p"),At(4),na(5,"translate"),it()()(),Fo()),oe&2&&(ot(4),qn(" ",Sl(5,1,"ocm.details.commentsAndRatings.addPrompt")," "))}function RI(oe,Ht){if(oe&1&&($e(0,"div"),_n(1,AI,2,1,"ng-container",0)(2,DI,6,3,"ng-container",0),it()),oe&2){let P=Wt(2);ot(),ai("ngIf",P.poi._hasComments==!0),ot(),ai("ngIf",P.poi._hasComments==!1)}}function zI(oe,Ht){if(oe&1&&rn(0,"img",55),oe&2){let P=Wt().$implicit;ai("src",n_(P.User==null?null:P.User.ProfileImageURL),t_)}}function LI(oe,Ht){if(oe&1&&($e(0,"span"),At(1),it()),oe&2){let P=Wt().$implicit;ot(),Qn(P.User.Username)}}function kI(oe,Ht){if(oe&1&&($e(0,"span"),At(1),it()),oe&2){let P=Wt().$implicit;ot(),Qn(P.Username)}}function OI(oe,Ht){if(oe&1&&($e(0,"ion-card"),rn(1,"img",55),$e(2,"ion-item")(3,"ion-avatar",23),_n(4,zI,1,2,"img",54),it(),$e(5,"ion-label"),_n(6,LI,2,1,"span",0)(7,kI,2,1,"span",0),it(),$e(8,"ion-label",24),At(9),na(10,"date"),it()(),$e(11,"ion-card-content")(12,"p"),At(13),it()()()),oe&2){let P=Ht.$implicit;ot(),ai("src",n_(P.ItemMediumURL),t_),ot(3),ai("ngIf",P.User&&P.User.ProfileImageURL),ot(2),ai("ngIf",P.User),ot(),ai("ngIf",!P.User),ot(2),qn(" ",Sl(10,7,P.DateCreated)," "),ot(4),Qn(P.Comment)}}function FI(oe,Ht){if(oe&1&&($e(0,"div"),_n(1,OI,14,9,"ion-card",53),it()),oe&2){let P=Wt(3);ot(),ai("ngForOf",P.poi.MediaItems)}}function BI(oe,Ht){oe&1&&(Oo(0),$e(1,"ion-card")(2,"ion-card-content")(3,"p"),At(4),na(5,"translate"),it()()(),Fo()),oe&2&&(ot(4),qn(" ",Sl(5,1,"ocm.details.mediaItems.addPrompt")," "))}function NI(oe,Ht){if(oe&1&&($e(0,"div"),_n(1,FI,2,1,"div",0)(2,BI,6,3,"ng-container",0),it()),oe&2){let P=Wt(2);ot(),ai("ngIf",P.poi._hasPhotos),ot(),ai("ngIf",P.poi._hasPhotos==!1)}}function VI(oe,Ht){if(oe&1&&($e(0,"p",58),At(1),it()),oe&2){let P=Wt(2);ot(),qn(" ",P.json)}}function UI(oe,Ht){if(oe&1){let P=wr();$e(0,"div")(1,"div",1)(2,"div",2)(3,"h2"),At(4),it(),$e(5,"div")(6,"small"),At(7),it()(),_n(8,ZS,3,1,"div",0)(9,qS,3,1,"div",0)(10,$S,3,0,"div",0),$e(11,"ion-badge",3),At(12),na(13,"number"),it()(),$e(14,"ion-fab",4)(15,"ion-fab-button",5),In("click",function(){Yi(P);let O=Wt();return Ji(O.close())}),rn(16,"ion-icon",6),it()(),$e(17,"ion-fab",7)(18,"ion-fab-button",8),rn(19,"ion-icon",9),it(),$e(20,"ion-fab-list",10)(21,"ion-fab-button",11),In("click",function(){Yi(P);let O=Wt();return Ji(O.addComment())}),rn(22,"ion-icon",12),it(),$e(23,"ion-fab-button",13),In("click",function(){Yi(P);let O=Wt();return Ji(O.addMedia())}),rn(24,"ion-icon",14),it(),$e(25,"ion-fab-button",15),In("click",function(){Yi(P);let O=Wt();return Ji(O.addFavourite())}),rn(26,"ion-icon",16),it(),$e(27,"ion-fab-button",17),In("click",function(){Yi(P);let O=Wt();return Ji(O.edit())}),rn(28,"ion-icon",18),it(),$e(29,"ion-fab-button",19),In("click",function(){Yi(P);let O=Wt();return Ji(O.refresh())}),rn(30,"ion-icon",20),it()()()(),$e(31,"ion-refresher",21),In("ionRefresh",function(O){Yi(P);let t=Wt();return Ji(t.refresh(O))}),rn(32,"ion-refresher-content",22),it(),$e(33,"ion-toolbar")(34,"ion-buttons",23),_n(35,WS,9,0,"ng-container",0),it(),$e(36,"ion-buttons",24),_n(37,HS,5,0,"ng-container",0)(38,XS,5,0,"ng-container",0)(39,KS,5,0,"ng-container",0),it()(),$e(40,"ion-segment",25),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.selectedTab,O)||(t.selectedTab=O),Ji(O)}),$e(41,"ion-segment-button",26)(42,"ion-label"),At(43," Details "),it()(),$e(44,"ion-segment-button",27)(45,"ion-label"),At(46),it()(),$e(47,"ion-segment-button",28)(48,"ion-label"),At(49),it()()(),_n(50,vI,26,15,"div",0)(51,RI,3,2,"div",0)(52,NI,3,2,"div",0)(53,VI,2,1,"p",29),it()}if(oe&2){let P=Wt();ot(),R0("background-image",P.backdropImage?"url("+P.backdropImage+")":""),ot(3),qn(" ",P.poi.AddressInfo.Title," "),ot(3),qn("OCM-",P.poi.ID),ot(),ai("ngIf",P.connectionSummary),ot(),ai("ngIf",P.poi.OperatorInfo),ot(),ai("ngIf",P.poi.SubmissionStatusTypeID==1),ot(2),Qn(r_(13,19,P.avgRating,"1.1-1")),ot(23),ai("ngIf",P.selectedTab=="location"),ot(2),ai("ngIf",P.selectedTab=="location"),ot(),ai("ngIf",P.selectedTab=="comments"),ot(),ai("ngIf",P.selectedTab=="media"),ot(),er("ngModel",P.selectedTab),ot(6),qn("Comments (",P.poi.UserComments?P.poi.UserComments.length:0,")"),ot(3),qn(" Photos (",P.poi.MediaItems?P.poi.MediaItems.length:0,")"),ot(),ai("ngIf",P.selectedTab=="location"),ot(),ai("ngIf",P.selectedTab=="comments"),ot(),ai("ngIf",P.selectedTab=="media"),ot(),ai("ngIf",P.appManager.isDebugMode==!0)}}function jI(oe,Ht){oe&1&&($e(0,"div")(1,"h2"),At(2,"POI Not Found"),it(),$e(3,"p"),At(4,"The POI details could not be loaded."),it()())}var MD=(()=>{class oe{appManager;nav;translate;logging;modalController;actionSheetController;poiManager;router;poi;selectedTab;json;hasNavBar=!1;backdropImage;avgRating;connectionSummary;constructor(P,Y,O,t,at,yi,Cn,_r){this.appManager=P,this.nav=Y,this.translate=O,this.logging=t,this.modalController=at,this.actionSheetController=yi,this.poiManager=Cn,this.router=_r}ngOnChanges(P){if(this.logging.log("In ngOnChanges of POI Details"),!(this.poi==null||this.poi.AddressInfo==null)){if(this.selectedTab="location",this.poi.MediaItems!=null&&this.poi.MediaItems.length>0){this.poi._hasPhotos=!0;for(let Y of this.poi.MediaItems)Y.ItemMediumURL=Y.ItemThumbnailURL.replace(".thmb.",".medi.");this.backdropImage=this.poi.MediaItems[this.poi.MediaItems.length-1].ItemThumbnailURL.replace(".thmb.",".medi.")}else this.poi._hasPhotos=!1,this.backdropImage=null;if(this.poi.UserComments!=null&&this.poi.UserComments.length>0){this.poi._hasComments=!0;try{let Y=this.poi.UserComments.filter(O=>O.Rating>0);if(Y.length>0){let O=0;for(let t of Y)O+=t.Rating;this.avgRating=O/Y.length}else this.avgRating=null}catch{}}else this.poi._hasComments=!1;if(this.poi.Connections&&this.poi.Connections.length>0){let Y="";for(let O of this.poi.Connections)Y.indexOf(O.ConnectionType.Title)==-1&&(Y+=(Y!=""?", ":"")+O.ConnectionType.Title);this.connectionSummary=Y}}}ngOnInit(){this.logging.log("In ngInit of POI Details")}get staticMapURL(){return"https://maps.googleapis.com/maps/api/staticmap?key="+new H0().googleMapsAPIKey+"&center="+this.poi.AddressInfo.Latitude+","+this.poi.AddressInfo.Longitude+"&zoom=13&scale=2&size="+this.staticMapSize+"&maptype=roadmap&format=jpg&visual_refresh=true&markers=size:small%7Ccolor:0xff0000%7Clabel:%7C"+this.poi.AddressInfo.Latitude+","+this.poi.AddressInfo.Longitude}get staticMapSize(){return this.appManager.clientWidth===0?"240x100":this.appManager.clientWidth>=800?"640x100":this.appManager.clientWidth>=400?"400x100":"240x100"}continueAddComment(){return On(this,null,function*(){let P=yield this.modalController.create({component:Ew,componentProps:{id:this.poi.ID,poi:this.poi}});setTimeout(()=>{this.refresh()},1e3),yield P.present()})}addComment(){return On(this,null,function*(){if(this.appManager.isUserAuthenticated(!0))yield this.continueAddComment();else{let P=yield this.modalController.create({component:Z0});P.onDidDismiss().then(()=>On(this,null,function*(){this.appManager.isUserAuthenticated(!0)&&(yield this.continueAddComment())})),yield P.present()}})}continueAddMedia(){return On(this,null,function*(){let P=yield this.modalController.create({component:Cw,componentProps:{id:this.poi.ID,poi:this.poi}});P.onDidDismiss().then(()=>{setTimeout(()=>{this.refresh()},1e3)}),yield P.present()})}addMedia(){return On(this,null,function*(){if(this.appManager.isUserAuthenticated(!0))yield this.continueAddMedia();else{let P=yield this.modalController.create({component:Z0});P.onDidDismiss().then(()=>On(this,null,function*(){this.appManager.isUserAuthenticated(!0)&&(yield this.continueAddMedia())})),yield P.present()}})}addFavourite(){return On(this,null,function*(){yield(yield this.actionSheetController.create({header:"Add Favourite",buttons:[{text:"Add to Journey",handler:()=>{this.modalController.create({component:fw,componentProps:{poi:this.poi}}).then(Y=>Y.present())}},{text:"Cancel",role:"cancel",handler:()=>{}}]})).present()})}launchNavigation(){if(this.appManager.isPlatform("ios")){let P="https://maps.apple.com/?ll="+this.poi.AddressInfo.Latitude+","+this.poi.AddressInfo.Longitude;this.appManager.launchWebPage(P)}else{let P="https://maps.google.com/?q="+this.poi.AddressInfo.Latitude+","+this.poi.AddressInfo.Longitude;this.appManager.launchWebPage(P)}}launchURL(P){this.appManager.launchWebPage(P)}continueEdit(){return On(this,null,function*(){let P=yield this.modalController.create({component:bw,componentProps:{id:this.poi.ID}});return P.onDidDismiss().then(Y=>{this.refresh()}),yield P.present()})}edit(){return On(this,null,function*(){if(ol.isFeatureEnabled("EDIT_POI"))if(this.appManager.isUserAuthenticated(!0))yield this.continueEdit();else{let P=yield this.modalController.create({component:Z0});P.onDidDismiss().then(()=>On(this,null,function*(){this.appManager.isUserAuthenticated(!0)&&(yield this.continueEdit())})),yield P.present()}else this.appManager.launchOCMWebPage("/poi/edit/"+this.poi.ID)})}refresh(P=null){this.poi&&this.poiManager.getPOIById(this.poi.ID,!0,!0).then(Y=>{Y&&(this.poi=Y,this.ngOnChanges(null)),P&&P.target.complete()})}close(){this.modalController.dismiss()}static \u0275fac=function(Y){return new(Y||oe)(Mn(ru),Mn(Z_),Mn(ym),Mn(Yo),Mn(iu),Mn(aw),Mn(ng),Mn(j_))};static \u0275cmp=$s({type:oe,selectors:[["poi-details"]],inputs:{poi:"poi"},standalone:!1,features:[A0],decls:2,vars:2,consts:[[4,"ngIf"],[1,"banner"],[1,"banner-content"],["color","primary","title","Average User Rating"],["vertical","top","horizontal","start","slot","fixed"],["size","small","color","medium",3,"click"],["name","close"],["vertical","top","horizontal","end","slot","fixed"],["size","small","color","success"],["name","add"],["side","bottom"],["title","Add a comment or charging check-in",3,"click"],["name","chatbubbles"],["title","Add a Photo",3,"click"],["name","camera"],["title","Add to Favourites",3,"click"],["name","star"],["title","Submit an Edit",3,"click"],["name","create"],["title","Refresh",3,"click"],["name","refresh"],["slot","fixed",3,"ionRefresh"],["pullingIcon","caret-down","pullingText","Pull to refresh","refreshingSpinner","circles","refreshingText","Refreshing..."],["slot","start"],["slot","end"],[3,"ngModelChange","ngModel"],["value","location","selected",""],["value","comments"],["value","media"],["style","white-space: pre-wrap;",4,"ngIf"],["size","small","title","Add to Favourites",3,"click"],["name","star","slot","start"],["size","small","title","Submit an Edit",3,"click"],["name","create","slot","start"],["size","small","title","Navigate to this location",3,"click"],["name","navigate","slot","start"],["size","small","title","Add a comment or charging check-in",3,"click"],["name","chatbubbles","slot","start"],["size","small","title","Add a Photo",3,"click"],["name","camera","slot","start"],[3,"item"],["class","details",4,"ngIf"],[1,"details"],[1,"details-minor"],["name","call"],["name","mail"],["name","globe"],["target","_system",3,"href"],[1,"label"],[1,"ion-padding-left"],["name","link"],["href","javascript:void(0)",3,"click",4,"ngIf"],["href","javascript:void(0)",3,"click"],[4,"ngFor","ngForOf"],[3,"src",4,"ngIf"],[3,"src"],["name","checkmark-circle","color","success",2,"font-size","2em"],["name","close-circle","color","danger"],[2,"white-space","pre-wrap"]],template:function(Y,O){Y&1&&_n(0,UI,54,22,"div",0)(1,jI,5,0,"div",0),Y&2&&(ai("ngIf",O.poi!=null&&O.poi.AddressInfo!=null),ot(),ai("ngIf",O.poi==null||O.poi.AddressInfo==null))},dependencies:[Hl,Ga,_m,z0,ma,Vc,L0,k0,Xb,Kb,W_,Jb,Qb,ew,H_,_a,Za,Jl,nw,rw,K_,Y_,J_,jc,eu,Kl,Yl,W0,o_,Zb,Q_],styles:[".banner[_ngcontent-%COMP%]{background-color:#4f712f;color:#ffffffec;padding:1em 3em 1em 6em;text-shadow:#000 1px 1px 1px;min-height:180px;background-size:cover}.banner[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0}.banner[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%]{color:unset}.banner-content[_ngcontent-%COMP%]{padding-right:48px}p[_ngcontent-%COMP%]{display:block;padding:4px}"]})}return oe})();var Mw=(()=>{class oe{http;journeyManager;constructor(P,Y){this.http=P,this.journeyManager=Y}getDirections(P,Y){return new Promise((O,t)=>{new google.maps.DirectionsService().route({origin:P,destination:Y,travelMode:google.maps.TravelMode.DRIVING},(yi,Cn)=>{Cn===google.maps.DirectionsStatus.OK?O(yi):t(Cn)})})}analyseRoutes(P,Y){let O=new Array;return P.routes.forEach(t=>{let at=new uy;at.Title=""+O.length+1,at.JourneyRouteLegs=new Array,at.TotalDistanceKM=0,at.TotalDurationMinutes=0,at.TotalEnergykWh=0,t.legs.forEach(yi=>{let Cn=yi.duration.value,_r=yi.distance.value/1e3,an=this.journeyManager.calculateEnergyConsumptionkWh(_r,0,null,Y),Dt=new hy;Dt.DistanceKM=_r,Dt.DurationMinutes=Cn/60,Dt.EnergyConsumptionkWh=an,at.JourneyRouteLegs.push(Dt),at.TotalDistanceKM+=Dt.DistanceKM,at.TotalDurationMinutes+=Dt.DurationMinutes,at.TotalEnergykWh=Dt.EnergyConsumptionkWh}),O.push(at)}),O}static \u0275fac=function(Y){return new(Y||oe)(ur(Xl),ur(Sm))};static \u0275prov=rs({token:oe,factory:oe.\u0275fac,providedIn:"root"})}return oe})();function ZI(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-item"),rn(1,"ion-icon",12),$e(2,"ion-searchbar",13),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.routeStart,O)||(t.routeStart=O),Ji(O)}),In("ionInput",function(O){Yi(P),Wt();let t=i_(18);return Ji(t.getPlacesAutoComplete(O,"routeStart"))})("ionCancel",function(O){Yi(P);let t=Wt();return Ji(t.onPlaceSearchCancel(O))}),it()()}if(oe&2){let P=Wt();ot(2),er("ngModel",P.routeStart),ai("debounce",500)}}function qI(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-item",14),In("click",function(){Yi(P);let O=Wt();return Ji(O.clearRouteStart())}),rn(1,"ion-icon",12),$e(2,"h2"),At(3),it()()}if(oe&2){Wt();let P=i_(18);ot(3),Qn(P.selectedPlace==null?null:P.selectedPlace.name)}}function $I(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-item"),rn(1,"ion-icon",15),$e(2,"ion-searchbar",16),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.routeDestination,O)||(t.routeDestination=O),Ji(O)}),In("ionInput",function(O){Yi(P),Wt();let t=i_(20);return Ji(t.getPlacesAutoComplete(O,"routeDestination"))})("ionCancel",function(O){Yi(P);let t=Wt();return Ji(t.onPlaceSearchCancel(O))}),it()()}if(oe&2){let P=Wt();ot(2),er("ngModel",P.routeDestination),ai("debounce",500)}}function WI(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-item",14),In("click",function(){Yi(P);let O=Wt();return Ji(O.clearRouteDestination())}),rn(1,"ion-icon",15),$e(2,"h2"),At(3),it()()}if(oe&2){Wt();let P=i_(20);ot(3),Qn(P.selectedPlace==null?null:P.selectedPlace.name)}}function HI(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-button",14),In("click",function(){Yi(P);let O=Wt();return Ji(O.clearRoute())}),rn(1,"ion-icon",17),At(2," Clear Route "),it()}}function XI(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-button",14),In("click",function(){Yi(P);let O=Wt();return Ji(O.showSettings())}),At(1," Show Settings "),rn(2,"ion-icon",18),it()}}function KI(oe,Ht){if(oe&1){let P=wr();$e(0,"ion-button",14),In("click",function(){Yi(P);let O=Wt();return Ji(O.hideSettings())}),At(1," Hide Settings "),rn(2,"ion-icon",18),it()}}function YI(oe,Ht){oe&1&&($e(0,"p",19),rn(1,"ion-spinner",19),At(2," Calculating Route.. "),it())}function JI(oe,Ht){if(oe&1&&($e(0,"ion-list")(1,"ion-list-header"),At(2),na(3,"number"),na(4,"number"),it()()),oe&2){let P=Wt();ot(2),Ub(" Total Distance ",r_(3,3,P.selectedJourneyRoute.TotalDistanceKM,"1.0-2")," km, ",P.formatDuration(P.selectedJourneyRoute.TotalDurationMinutes),", ",r_(4,6,P.selectedJourneyRoute.TotalEnergykWh,"1.0-2")," kWh ")}}function QI(oe,Ht){if(oe&1){let P=wr();$e(0,"div")(1,"ion-list")(2,"ion-list-header"),rn(3,"ion-icon",20),At(4," Route Settings "),it(),$e(5,"ion-item")(6,"ion-label",21),At(7),it(),$e(8,"ion-range",22),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.routeSearchDistance,O)||(t.routeSearchDistance=O),Ji(O)}),rn(9,"ion-icon",23)(10,"ion-icon",24),it()(),$e(11,"ion-item")(12,"ion-label",21),At(13,"Energy Efficiency (kWh Per km)"),it(),$e(14,"ion-input",25),tr("ngModelChange",function(O){Yi(P);let t=Wt();return Yn(t.kWhPerKM,O)||(t.kWhPerKM=O),Ji(O)}),it()()()()}if(oe&2){let P=Wt();ot(7),qn("Search Distance (",P.routeSearchDistance,")"),ot(),er("ngModel",P.routeSearchDistance),ot(6),er("ngModel",P.kWhPerKM)}}var GD=(()=>{class oe{mapping;logging;directions;journeyManager;changeDetector;numberPipe;routeSearchDistance=5;journeyRoutes;selectedJourneyRoute;routePolyline;kWhPerKM;routeStartPlace;routeDestinationPlace;routeCalcInProgress=!1;advancedSettingsMode=!1;routeStart="";routeDestination="";constructor(P,Y,O,t,at,yi){this.mapping=P,this.logging=Y,this.directions=O,this.journeyManager=t,this.changeDetector=at,this.numberPipe=yi,this.kWhPerKM=.212}get isRouteSet(){return this.routeStartPlace!=null&&this.routeDestinationPlace!=null}showSettings(){this.advancedSettingsMode=!0}hideSettings(){this.advancedSettingsMode=!1}routeStartSelected(P){this.routeStartPlace=P,this.calculateRoute(),this.changeDetector.detectChanges()}routeDestinationSelected(P){this.routeDestinationPlace=P,this.calculateRoute(),this.changeDetector.detectChanges()}clearRouteStart(){this.routeStartPlace=null,this.changeDetector.detectChanges()}clearRouteDestination(){this.routeDestinationPlace=null,this.changeDetector.detectChanges()}clearRoute(){this.routeStartPlace=null,this.routeDestinationPlace=null,this.journeyManager.setRoutePolyline(null),this.mapping.clearPolyline()}formatDuration(P){if(P<=60)return this.numberPipe.transform(P,"1.0-2")+" mins";{let Y=Math.round(P/60),O=Math.floor(P-Y*60);return Y+" hours "+(O>0?O+" mins":"")}}calculateRoute(){this.routeStartPlace!=null&&this.routeDestinationPlace!=null&&(this.logging.log("Fetching route directions.."),this.routeCalcInProgress=!0,this.directions.getDirections(this.routeStartPlace.Location.latitude+","+this.routeStartPlace.Location.longitude,this.routeDestinationPlace.Location.latitude+","+this.routeDestinationPlace.Location.longitude).then(P=>{if(P.routes!=null&&P.routes.length>0){this.logging.log("Got route directions, analysing.."),this.routePolyline=P.routes[0].overview_polyline;let Y=P.routes[0].bounds.getSouthWest(),O=P.routes[0].bounds.getNorthEast(),t=new Is(O.lat(),O.lng()),at=new Is(Y.lat(),Y.lng()),yi=new dy(t,at);this.journeyRoutes=this.directions.analyseRoutes(P,this.kWhPerKM),this.journeyRoutes.length>0&&(this.selectedJourneyRoute=this.journeyRoutes[0]),this.journeyManager.setRoutePolyline(this.routePolyline),this.mapping.renderPolyline(this.routePolyline),this.mapping.moveToMapBounds(yi)}else this.logging.log("No route returned..");this.routeCalcInProgress=!1}))}static \u0275fac=function(Y){return new(Y||oe)(Mn(og),Mn(Yo),Mn(Mw),Mn(Sm),Mn(mm),Mn(o_))};static \u0275cmp=$s({type:oe,selectors:[["route-planner"]],standalone:!1,decls:24,vars:10,consts:[["placeSearchRouteStart",""],["placeSearchRouteDestination",""],[1,"route"],[1,"route-places"],["name","map","slot","start"],[4,"ngIf"],[3,"click",4,"ngIf"],["primary",""],["slot","secondary"],["slot","primary"],[3,"placeChanged"],["class","ion-padding",4,"ngIf"],["name","ionic","item-left",""],["placeholder","Starting Point",3,"ngModelChange","ionInput","ionCancel","ngModel","debounce"],[3,"click"],["name","pin","item-left",""],["placeholder","Destination",3,"ngModelChange","ionInput","ionCancel","ngModel","debounce"],["name","close","slot","start"],["name","cog","slot","end"],[1,"ion-padding"],["name","cog"],["position","stacked"],["min","1","max","200","step","5","snaps","true","pin","true","light","",3,"ngModelChange","ngModel"],["slot","start","small","","name","map"],["slot","end","large","","name","map"],["type","number","min","0.1","max","1",3,"ngModelChange","ngModel"]],template:function(Y,O){if(Y&1){let t=wr();$e(0,"div",2)(1,"div",3)(2,"ion-list")(3,"ion-list-header"),rn(4,"ion-icon",4),$e(5,"ion-label"),At(6,"Plan Your Journey"),it()(),_n(7,ZI,3,2,"ion-item",5)(8,qI,4,1,"ion-item",6)(9,$I,3,2,"ion-item",5)(10,WI,4,1,"ion-item",6),it(),$e(11,"ion-toolbar",7)(12,"ion-buttons",8),_n(13,HI,3,0,"ion-button",6),it(),$e(14,"ion-buttons",9),_n(15,XI,3,0,"ion-button",6)(16,KI,3,0,"ion-button",6),it()()(),$e(17,"place-search",10,0),In("placeChanged",function(yi){return Yi(t),Ji(O.routeStartSelected(yi))}),it(),$e(19,"place-search",10,1),In("placeChanged",function(yi){return Yi(t),Ji(O.routeDestinationSelected(yi))}),it(),_n(21,YI,3,0,"p",11)(22,JI,5,9,"ion-list",5)(23,QI,15,3,"div",5),it()}Y&2&&(ot(7),ai("ngIf",O.routeStartPlace==null),ot(),ai("ngIf",O.routeStartPlace!=null),ot(),ai("ngIf",O.routeDestinationPlace==null),ot(),ai("ngIf",O.routeDestinationPlace!=null),ot(3),ai("ngIf",O.isRouteSet),ot(2),ai("ngIf",!O.advancedSettingsMode),ot(),ai("ngIf",O.advancedSettingsMode),ot(5),ai("ngIf",O.routeCalcInProgress),ot(),ai("ngIf",O.selectedJourneyRoute!=null),ot(),ai("ngIf",O.advancedSettingsMode))},dependencies:[Ga,ma,Vc,_a,tu,Za,Jl,Uc,tw,iw,O0,F0,jc,$_,Nc,B0,sw,Kl,Yl,Iw,o_],encapsulation:2})}return oe})();var WD=(()=>{class oe extends Q_{constructor(P,Y){super(P,Y)}transform(P,...Y){let O=super.transform(P,...Y);return O==P?Y!=null&&Y[0].default?Y[0].default:Y[0].Title?Y[0].Title:O:O}static \u0275fac=function(Y){return new(Y||oe)(Mn(ym,16),Mn(mm,16))};static \u0275pipe=kb({name:"nullableTranslate",type:oe,pure:!0,standalone:!1});static \u0275prov=rs({token:oe,factory:oe.\u0275fac})}return oe})();var gR=(()=>{class oe{static \u0275fac=function(Y){return new(Y||oe)};static \u0275mod=D0({type:oe});static \u0275inj=P0({providers:[o_],imports:[qb,cw,Hb,hw]})}return oe})();export{ks as a,Yo as b,vm as c,Is as d,wd as e,wm as f,ig as g,Zc as h,U0 as i,ng as j,Sm as k,pE as l,ru as m,ol as n,Iw as o,H0 as p,Z0 as q,og as r,yw as s,vw as t,bw as u,MD as v,GD as w,WD as x,gR as y};
